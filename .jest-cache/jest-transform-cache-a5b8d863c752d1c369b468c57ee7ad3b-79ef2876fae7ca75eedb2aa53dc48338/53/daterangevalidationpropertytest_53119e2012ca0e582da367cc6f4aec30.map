{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\query\\__tests__\\date-range-validation.property.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\query\\__tests__\\date-range-validation.property.test.ts"],"sourcesContent":["/**\r\n * Date Range Validation Property Tests\r\n *\r\n * Property 8: 日付範囲の順序性\r\n * Validates: Requirements 5.2\r\n *\r\n * 開始日が終了日より後の場合はバリデーションエラーを返すことを検証\r\n *\r\n * Requirements: 要件14.2（プロパティテスト）\r\n */\r\n\r\nimport * as fc from 'fast-check';\r\nimport { Context, APIGatewayProxyEvent } from 'aws-lambda';\r\nimport { handler } from '../handler';\r\n\r\n// モック\r\njest.mock('../query-disclosures');\r\njest.mock('../format-csv');\r\njest.mock('../../../utils/logger');\r\njest.mock('../../../utils/cloudwatch-metrics');\r\n\r\ndescribe('Property 8: 日付範囲の順序性', () => {\r\n  let mockContext: Context;\r\n  let baseEvent: APIGatewayProxyEvent;\r\n\r\n  beforeEach(() => {\r\n    // モックコンテキスト\r\n    mockContext = {\r\n      awsRequestId: 'test-request-id',\r\n      functionName: 'tdnet-query',\r\n      functionVersion: '1',\r\n      invokedFunctionArn: 'arn:aws:lambda:ap-northeast-1:123456789012:function:tdnet-query',\r\n      memoryLimitInMB: '256',\r\n      logGroupName: '/aws/lambda/tdnet-query',\r\n      logStreamName: '2024/01/15/[$LATEST]abcdef',\r\n      getRemainingTimeInMillis: () => 30000,\r\n      callbackWaitsForEmptyEventLoop: true,\r\n      done: jest.fn(),\r\n      fail: jest.fn(),\r\n      succeed: jest.fn(),\r\n    };\r\n\r\n    // ベースイベント\r\n    baseEvent = {\r\n      body: null,\r\n      headers: {\r\n        'x-api-key': 'test-api-key',\r\n      },\r\n      multiValueHeaders: {},\r\n      httpMethod: 'GET',\r\n      isBase64Encoded: false,\r\n      path: '/disclosures',\r\n      pathParameters: null,\r\n      queryStringParameters: null,\r\n      multiValueQueryStringParameters: null,\r\n      stageVariables: null,\r\n      requestContext: {\r\n        accountId: '123456789012',\r\n        apiId: 'test-api-id',\r\n        protocol: 'HTTP/1.1',\r\n        httpMethod: 'GET',\r\n        path: '/disclosures',\r\n        stage: 'prod',\r\n        requestId: 'test-request-id',\r\n        requestTime: '15/Jan/2024:10:30:00 +0000',\r\n        requestTimeEpoch: 1705315800000,\r\n        identity: {\r\n          accessKey: null,\r\n          accountId: null,\r\n          apiKey: null,\r\n          apiKeyId: null,\r\n          caller: null,\r\n          clientCert: null,\r\n          cognitoAuthenticationProvider: null,\r\n          cognitoAuthenticationType: null,\r\n          cognitoIdentityId: null,\r\n          cognitoIdentityPoolId: null,\r\n          principalOrgId: null,\r\n          sourceIp: '192.168.1.1',\r\n          user: null,\r\n          userAgent: 'Mozilla/5.0',\r\n          userArn: null,\r\n        },\r\n        authorizer: null,\r\n        domainName: 'api.example.com',\r\n        domainPrefix: 'api',\r\n        resourceId: 'test-resource-id',\r\n        resourcePath: '/disclosures',\r\n      },\r\n      resource: '/disclosures',\r\n    };\r\n\r\n    // 環境変数設定\r\n    process.env.API_KEY = 'test-api-key';\r\n    process.env.DYNAMODB_TABLE_NAME = 'tdnet_disclosures';\r\n    process.env.S3_BUCKET_NAME = 'tdnet-pdfs';\r\n\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  /**\r\n   * 日付文字列生成（YYYY-MM-DD形式）\r\n   */\r\n  const dateArbitrary = fc.date({\r\n    min: new Date('2020-01-01'),\r\n    max: new Date('2025-12-31'),\r\n  }).map((date) => {\r\n    const year = date.getFullYear();\r\n    const month = String(date.getMonth() + 1).padStart(2, '0');\r\n    const day = String(date.getDate()).padStart(2, '0');\r\n    return `${year}-${month}-${day}`;\r\n  });\r\n\r\n  it('Property 8.1: 開始日が終了日より後の場合は必ずバリデーションエラー', async () => {\r\n    await fc.assert(\r\n      fc.asyncProperty(dateArbitrary, dateArbitrary, async (date1, date2) => {\r\n        // date1 > date2 となるペアのみテスト\r\n        if (date1 <= date2) {\r\n          return true; // スキップ\r\n        }\r\n\r\n        const event = {\r\n          ...baseEvent,\r\n          queryStringParameters: {\r\n            start_date: date1, // 後の日付\r\n            end_date: date2, // 前の日付\r\n          },\r\n        };\r\n\r\n        const result = await handler(event, mockContext);\r\n\r\n        // バリデーションエラー（400）が返されることを確認\r\n        expect(result.statusCode).toBe(400);\r\n\r\n        const body = JSON.parse(result.body);\r\n        expect(body.error_code).toBe('VALIDATION_ERROR');\r\n        expect(body.message).toContain('start_date');\r\n        expect(body.message).toContain('must be before or equal to');\r\n        expect(body.message).toContain('end_date');\r\n\r\n        return true;\r\n      }),\r\n      { numRuns: 100 } // 100回反復実行\r\n    );\r\n  });\r\n\r\n  it('Property 8.2: 開始日が終了日と同じ場合は成功', async () => {\r\n    await fc.assert(\r\n      fc.asyncProperty(dateArbitrary, async (date) => {\r\n        const event = {\r\n          ...baseEvent,\r\n          queryStringParameters: {\r\n            start_date: date,\r\n            end_date: date, // 同じ日付\r\n          },\r\n        };\r\n\r\n        const result = await handler(event, mockContext);\r\n\r\n        // バリデーションエラーではないことを確認（200または500）\r\n        expect(result.statusCode).not.toBe(400);\r\n\r\n        return true;\r\n      }),\r\n      { numRuns: 100 }\r\n    );\r\n  });\r\n\r\n  it('Property 8.3: 開始日が終了日より前の場合は成功', async () => {\r\n    await fc.assert(\r\n      fc.asyncProperty(dateArbitrary, dateArbitrary, async (date1, date2) => {\r\n        // date1 < date2 となるペアのみテスト\r\n        if (date1 >= date2) {\r\n          return true; // スキップ\r\n        }\r\n\r\n        const event = {\r\n          ...baseEvent,\r\n          queryStringParameters: {\r\n            start_date: date1, // 前の日付\r\n            end_date: date2, // 後の日付\r\n          },\r\n        };\r\n\r\n        const result = await handler(event, mockContext);\r\n\r\n        // バリデーションエラーではないことを確認\r\n        expect(result.statusCode).not.toBe(400);\r\n\r\n        return true;\r\n      }),\r\n      { numRuns: 100 }\r\n    );\r\n  });\r\n\r\n  describe('エッジケース', () => {\r\n    it('月またぎの日付範囲', async () => {\r\n      const event = {\r\n        ...baseEvent,\r\n        queryStringParameters: {\r\n          start_date: '2024-01-31',\r\n          end_date: '2024-02-01',\r\n        },\r\n      };\r\n\r\n      const result = await handler(event, mockContext);\r\n\r\n      // バリデーションエラーではないことを確認\r\n      expect(result.statusCode).not.toBe(400);\r\n    });\r\n\r\n    it('年またぎの日付範囲', async () => {\r\n      const event = {\r\n        ...baseEvent,\r\n        queryStringParameters: {\r\n          start_date: '2023-12-31',\r\n          end_date: '2024-01-01',\r\n        },\r\n      };\r\n\r\n      const result = await handler(event, mockContext);\r\n\r\n      // バリデーションエラーではないことを確認\r\n      expect(result.statusCode).not.toBe(400);\r\n    });\r\n\r\n    it('うるう年の2月29日', async () => {\r\n      const event = {\r\n        ...baseEvent,\r\n        queryStringParameters: {\r\n          start_date: '2024-02-29', // うるう年\r\n          end_date: '2024-03-01',\r\n        },\r\n      };\r\n\r\n      const result = await handler(event, mockContext);\r\n\r\n      // バリデーションエラーではないことを確認\r\n      expect(result.statusCode).not.toBe(400);\r\n    });\r\n\r\n    it('非うるう年の2月29日はバリデーションエラー', async () => {\r\n      const event = {\r\n        ...baseEvent,\r\n        queryStringParameters = {\r\n          start_date: '2023-02-29', // 非うるう年\r\n          end_date: '2023-03-01',\r\n        },\r\n      };\r\n\r\n      const result = await handler(event, mockContext);\r\n\r\n      // バリデーションエラー（存在しない日付）\r\n      expect(result.statusCode).toBe(400);\r\n      const body = JSON.parse(result.body);\r\n      expect(body.error_code).toBe('VALIDATION_ERROR');\r\n      expect(body.message).toContain('Date does not exist');\r\n    });\r\n  });\r\n});\r\n"],"version":3}