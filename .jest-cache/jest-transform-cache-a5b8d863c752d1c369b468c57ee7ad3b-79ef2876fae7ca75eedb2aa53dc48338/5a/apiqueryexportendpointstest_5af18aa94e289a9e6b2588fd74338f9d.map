{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\cdk\\__tests__\\api-query-export-endpoints.test.ts","mappings":";AAAA;;;;;;GAMG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEH,iDAAmC;AACnC,uDAAyD;AACzD,kFAA4E;AAE5E,QAAQ,CAAC,sCAAsC,EAAE,GAAG,EAAE;IACpD,IAAI,QAAkB,CAAC;IAEvB,SAAS,CAAC,GAAG,EAAE;QACb,MAAM,GAAG,GAAG,IAAI,GAAG,CAAC,GAAG,EAAE,CAAC;QAC1B,MAAM,KAAK,GAAG,IAAI,oDAAuB,CAAC,GAAG,EAAE,WAAW,CAAC,CAAC;QAC5D,QAAQ,GAAG,qBAAQ,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;IACvC,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,0BAA0B,EAAE,GAAG,EAAE;QACxC,EAAE,CAAC,qCAAqC,EAAE,GAAG,EAAE;YAC7C,iCAAiC;YACjC,QAAQ,CAAC,qBAAqB,CAAC,2BAA2B,EAAE;gBAC1D,QAAQ,EAAE,aAAa;aACxB,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,gDAAgD,EAAE,GAAG,EAAE;YACxD,mCAAmC;YACnC,QAAQ,CAAC,qBAAqB,CAAC,yBAAyB,EAAE;gBACxD,UAAU,EAAE,KAAK;gBACjB,cAAc,EAAE,IAAI;gBACpB,UAAU,EAAE,kBAAK,CAAC,UAAU,CAAC;oBAC3B,GAAG,EAAE,kBAAK,CAAC,gBAAgB,CAAC,iBAAiB,CAAC;iBAC/C,CAAC;aACH,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,mCAAmC,EAAE,GAAG,EAAE;YAC3C,wBAAwB;YACxB,QAAQ,CAAC,qBAAqB,CAAC,yBAAyB,EAAE;gBACxD,UAAU,EAAE,KAAK;gBACjB,iBAAiB,EAAE;oBACjB,yCAAyC,EAAE,KAAK;oBAChD,uCAAuC,EAAE,KAAK;oBAC9C,qCAAqC,EAAE,KAAK;oBAC5C,4CAA4C,EAAE,KAAK;oBACnD,mCAAmC,EAAE,KAAK;oBAC1C,kCAAkC,EAAE,KAAK;oBACzC,mCAAmC,EAAE,KAAK;iBAC3C;aACF,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,qCAAqC,EAAE,GAAG,EAAE;YAC7C,wBAAwB;YACxB,QAAQ,CAAC,qBAAqB,CAAC,yBAAyB,EAAE;gBACxD,UAAU,EAAE,KAAK;gBACjB,WAAW,EAAE;oBACX,IAAI,EAAE,WAAW;oBACjB,qBAAqB,EAAE,MAAM;oBAC7B,GAAG,EAAE,kBAAK,CAAC,UAAU,CAAC;wBACpB,UAAU,EAAE,kBAAK,CAAC,SAAS,CAAC;4BAC1B,kBAAK,CAAC,SAAS,CAAC;gCACd,kBAAK,CAAC,gBAAgB,CAAC,YAAY,CAAC;6BACrC,CAAC;yBACH,CAAC;qBACH,CAAC;iBACH;aACF,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,+BAA+B,EAAE,GAAG,EAAE;YACvC,wBAAwB;YACxB,QAAQ,CAAC,qBAAqB,CAAC,yBAAyB,EAAE;gBACxD,UAAU,EAAE,KAAK;gBACjB,eAAe,EAAE,kBAAK,CAAC,SAAS,CAAC;oBAC/B,kBAAK,CAAC,UAAU,CAAC;wBACf,UAAU,EAAE,KAAK;wBACjB,kBAAkB,EAAE;4BAClB,oDAAoD,EAAE,IAAI;4BAC1D,qCAAqC,EAAE,IAAI;yBAC5C;qBACF,CAAC;iBACH,CAAC;aACH,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,kDAAkD,EAAE,GAAG,EAAE;YAC1D,wBAAwB;YACxB,QAAQ,CAAC,qBAAqB,CAAC,yBAAyB,EAAE;gBACxD,UAAU,EAAE,KAAK;gBACjB,eAAe,EAAE,kBAAK,CAAC,SAAS,CAAC;oBAC/B,kBAAK,CAAC,UAAU,CAAC,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC;oBACvC,kBAAK,CAAC,UAAU,CAAC,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC;oBACvC,kBAAK,CAAC,UAAU,CAAC,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC;oBACvC,kBAAK,CAAC,UAAU,CAAC,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC;iBACxC,CAAC;aACH,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,mEAAmE,EAAE,GAAG,EAAE;YAC3E,+CAA+C;YAC/C,QAAQ,CAAC,qBAAqB,CAAC,yBAAyB,EAAE;gBACxD,MAAM,EAAE,uBAAuB;gBAC/B,SAAS,EAAE,0BAA0B;gBACrC,YAAY,EAAE,kBAAK,CAAC,UAAU,CAAC;oBAC7B,YAAY,EAAE,kBAAK,CAAC,SAAS,CAAC;wBAC5B,kBAAK,CAAC,gBAAgB,CAAC,iBAAiB,CAAC;wBACzC,KAAK;qBACN,CAAC;iBACH,CAAC;aACH,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,uBAAuB,EAAE,GAAG,EAAE;QACrC,EAAE,CAAC,iCAAiC,EAAE,GAAG,EAAE;YACzC,6BAA6B;YAC7B,QAAQ,CAAC,qBAAqB,CAAC,2BAA2B,EAAE;gBAC1D,QAAQ,EAAE,SAAS;aACpB,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,iDAAiD,EAAE,GAAG,EAAE;YACzD,oCAAoC;YACpC,QAAQ,CAAC,qBAAqB,CAAC,yBAAyB,EAAE;gBACxD,UAAU,EAAE,MAAM;gBAClB,cAAc,EAAE,IAAI;gBACpB,UAAU,EAAE,kBAAK,CAAC,UAAU,CAAC;oBAC3B,GAAG,EAAE,kBAAK,CAAC,gBAAgB,CAAC,aAAa,CAAC;iBAC3C,CAAC;aACH,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,qCAAqC,EAAE,GAAG,EAAE;YAC7C,wBAAwB;YACxB,QAAQ,CAAC,qBAAqB,CAAC,yBAAyB,EAAE;gBACxD,UAAU,EAAE,MAAM;gBAClB,WAAW,EAAE;oBACX,IAAI,EAAE,WAAW;oBACjB,qBAAqB,EAAE,MAAM;oBAC7B,GAAG,EAAE,kBAAK,CAAC,UAAU,CAAC;wBACpB,UAAU,EAAE,kBAAK,CAAC,SAAS,CAAC;4BAC1B,kBAAK,CAAC,SAAS,CAAC;gCACd,kBAAK,CAAC,gBAAgB,CAAC,YAAY,CAAC;6BACrC,CAAC;yBACH,CAAC;qBACH,CAAC;iBACH;aACF,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,+BAA+B,EAAE,GAAG,EAAE;YACvC,wBAAwB;YACxB,QAAQ,CAAC,qBAAqB,CAAC,yBAAyB,EAAE;gBACxD,UAAU,EAAE,MAAM;gBAClB,eAAe,EAAE,kBAAK,CAAC,SAAS,CAAC;oBAC/B,kBAAK,CAAC,UAAU,CAAC;wBACf,UAAU,EAAE,KAAK;wBACjB,kBAAkB,EAAE;4BAClB,oDAAoD,EAAE,IAAI;yBAC3D;qBACF,CAAC;iBACH,CAAC;aACH,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,kDAAkD,EAAE,GAAG,EAAE;YAC1D,qCAAqC;YACrC,QAAQ,CAAC,qBAAqB,CAAC,yBAAyB,EAAE;gBACxD,UAAU,EAAE,MAAM;gBAClB,eAAe,EAAE,kBAAK,CAAC,SAAS,CAAC;oBAC/B,kBAAK,CAAC,UAAU,CAAC,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC;iBACxC,CAAC;aACH,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,kDAAkD,EAAE,GAAG,EAAE;YAC1D,wBAAwB;YACxB,QAAQ,CAAC,qBAAqB,CAAC,yBAAyB,EAAE;gBACxD,UAAU,EAAE,MAAM;gBAClB,eAAe,EAAE,kBAAK,CAAC,SAAS,CAAC;oBAC/B,kBAAK,CAAC,UAAU,CAAC,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC;oBACvC,kBAAK,CAAC,UAAU,CAAC,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC;oBACvC,kBAAK,CAAC,UAAU,CAAC,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC;oBACvC,kBAAK,CAAC,UAAU,CAAC,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC;iBACxC,CAAC;aACH,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,oEAAoE,EAAE,GAAG,EAAE;YAC5E,gDAAgD;YAChD,QAAQ,CAAC,qBAAqB,CAAC,yBAAyB,EAAE;gBACxD,MAAM,EAAE,uBAAuB;gBAC/B,SAAS,EAAE,0BAA0B;gBACrC,YAAY,EAAE,kBAAK,CAAC,UAAU,CAAC;oBAC7B,YAAY,EAAE,kBAAK,CAAC,SAAS,CAAC;wBAC5B,kBAAK,CAAC,gBAAgB,CAAC,kBAAkB,CAAC;wBAC1C,KAAK;qBACN,CAAC;iBACH,CAAC;aACH,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,wBAAwB,EAAE,GAAG,EAAE;QACtC,EAAE,CAAC,wCAAwC,EAAE,GAAG,EAAE;YAChD,0CAA0C;YAC1C,QAAQ,CAAC,SAAS,CAAC,qBAAqB,EAAE;gBACxC,WAAW,EAAE,oCAAoC;gBACjD,MAAM,EAAE;oBACN,IAAI,EAAE,0BAA0B;iBACjC;aACF,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,oCAAoC,EAAE,GAAG,EAAE;YAC5C,sCAAsC;YACtC,QAAQ,CAAC,SAAS,CAAC,iBAAiB,EAAE;gBACpC,WAAW,EAAE,yBAAyB;gBACtC,MAAM,EAAE;oBACN,IAAI,EAAE,sBAAsB;iBAC7B;aACF,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,mBAAmB,EAAE,GAAG,EAAE;QACjC,EAAE,CAAC,kDAAkD,EAAE,GAAG,EAAE;YAC1D,6BAA6B;YAC7B,QAAQ,CAAC,qBAAqB,CAAC,0BAA0B,EAAE;gBACzD,IAAI,EAAE,0BAA0B;gBAChC,WAAW,EAAE,+BAA+B;aAC7C,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,yCAAyC,EAAE,GAAG,EAAE;YACjD,wBAAwB;YACxB,QAAQ,CAAC,qBAAqB,CAAC,wBAAwB,EAAE;gBACvD,SAAS,EAAE,MAAM;aAClB,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,qCAAqC,EAAE,GAAG,EAAE;YAC7C,gCAAgC;YAChC,QAAQ,CAAC,qBAAqB,CAAC,4BAA4B,EAAE;gBAC3D,aAAa,EAAE,kBAAkB;gBACjC,WAAW,EAAE,yCAAyC;aACvD,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,0CAA0C,EAAE,GAAG,EAAE;YAClD,kCAAkC;YAClC,QAAQ,CAAC,qBAAqB,CAAC,+BAA+B,EAAE;gBAC9D,OAAO,EAAE,SAAS;aACnB,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,aAAa,EAAE,GAAG,EAAE;QAC3B,EAAE,CAAC,mDAAmD,EAAE,GAAG,EAAE;YAC3D,4CAA4C;YAC5C,QAAQ,CAAC,qBAAqB,CAAC,kBAAkB,EAAE;gBACjD,cAAc,EAAE;oBACd,SAAS,EAAE,kBAAK,CAAC,SAAS,CAAC;wBACzB,kBAAK,CAAC,UAAU,CAAC;4BACf,MAAM,EAAE,kBAAK,CAAC,SAAS,CAAC;gCACtB,uBAAuB;gCACvB,gBAAgB;gCAChB,kBAAkB;gCAClB,eAAe;6BAChB,CAAC;4BACF,MAAM,EAAE,OAAO;yBAChB,CAAC;qBACH,CAAC;iBACH;gBACD,KAAK,EAAE,kBAAK,CAAC,SAAS,CAAC;oBACrB,kBAAK,CAAC,UAAU,CAAC;wBACf,GAAG,EAAE,kBAAK,CAAC,gBAAgB,CAAC,uBAAuB,CAAC;qBACrD,CAAC;iBACH,CAAC;aACH,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,oDAAoD,EAAE,GAAG,EAAE;YAC5D,6CAA6C;YAC7C,QAAQ,CAAC,qBAAqB,CAAC,kBAAkB,EAAE;gBACjD,cAAc,EAAE;oBACd,SAAS,EAAE,kBAAK,CAAC,SAAS,CAAC;wBACzB,kBAAK,CAAC,UAAU,CAAC;4BACf,MAAM,EAAE,kBAAK,CAAC,SAAS,CAAC;gCACtB,uBAAuB;gCACvB,gBAAgB;gCAChB,kBAAkB;gCAClB,eAAe;6BAChB,CAAC;4BACF,MAAM,EAAE,OAAO;yBAChB,CAAC;qBACH,CAAC;iBACH;gBACD,KAAK,EAAE,kBAAK,CAAC,SAAS,CAAC;oBACrB,kBAAK,CAAC,UAAU,CAAC;wBACf,GAAG,EAAE,kBAAK,CAAC,gBAAgB,CAAC,wBAAwB,CAAC;qBACtD,CAAC;iBACH,CAAC;aACH,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,8DAA8D,EAAE,GAAG,EAAE;YACtE,oDAAoD;YACpD,QAAQ,CAAC,qBAAqB,CAAC,kBAAkB,EAAE;gBACjD,cAAc,EAAE;oBACd,SAAS,EAAE,kBAAK,CAAC,SAAS,CAAC;wBACzB,kBAAK,CAAC,UAAU,CAAC;4BACf,MAAM,EAAE,kBAAK,CAAC,SAAS,CAAC;gCACtB,cAAc;gCACd,uBAAuB;gCACvB,uBAAuB;gCACvB,qBAAqB;gCACrB,4BAA4B;gCAC5B,WAAW;6BACZ,CAAC;4BACF,MAAM,EAAE,OAAO;yBAChB,CAAC;qBACH,CAAC;iBACH;gBACD,KAAK,EAAE,kBAAK,CAAC,SAAS,CAAC;oBACrB,kBAAK,CAAC,UAAU,CAAC;wBACf,GAAG,EAAE,kBAAK,CAAC,gBAAgB,CAAC,wBAAwB,CAAC;qBACtD,CAAC;iBACH,CAAC;aACH,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,yDAAyD,EAAE,GAAG,EAAE;YACjE,gDAAgD;YAChD,QAAQ,CAAC,qBAAqB,CAAC,kBAAkB,EAAE;gBACjD,cAAc,EAAE;oBACd,SAAS,EAAE,kBAAK,CAAC,SAAS,CAAC;wBACzB,kBAAK,CAAC,UAAU,CAAC;4BACf,MAAM,EAAE,kBAAK,CAAC,SAAS,CAAC;gCACtB,eAAe;gCACf,eAAe;gCACf,UAAU;6BACX,CAAC;4BACF,MAAM,EAAE,OAAO;yBAChB,CAAC;qBACH,CAAC;iBACH;gBACD,KAAK,EAAE,kBAAK,CAAC,SAAS,CAAC;oBACrB,kBAAK,CAAC,UAAU,CAAC;wBACf,GAAG,EAAE,kBAAK,CAAC,gBAAgB,CAAC,uBAAuB,CAAC;qBACrD,CAAC;iBACH,CAAC;aACH,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,OAAO,EAAE,GAAG,EAAE;QACrB,EAAE,CAAC,+CAA+C,EAAE,GAAG,EAAE;YACvD,yCAAyC;YACzC,QAAQ,CAAC,qBAAqB,CAAC,+BAA+B,EAAE;gBAC9D,WAAW,EAAE,kBAAK,CAAC,UAAU,CAAC;oBAC5B,UAAU,EAAE,kBAAK,CAAC,SAAS,CAAC;wBAC1B,EAAE;wBACF,kBAAK,CAAC,SAAS,CAAC;4BACd,kBAAK,CAAC,gBAAgB,CAAC,iBAAiB,CAAC;yBAC1C,CAAC;qBACH,CAAC;iBACH,CAAC;gBACF,SAAS,EAAE,kBAAK,CAAC,UAAU,CAAC;oBAC1B,YAAY,EAAE,kBAAK,CAAC,SAAS,CAAC;wBAC5B,kBAAK,CAAC,gBAAgB,CAAC,YAAY,CAAC;wBACpC,KAAK;qBACN,CAAC;iBACH,CAAC;aACH,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\cdk\\__tests__\\api-query-export-endpoints.test.ts"],"sourcesContent":["/**\r\n * API Gateway Query & Export Endpoints Tests\r\n *\r\n * GET /disclosures および POST /exports エンドポイントの統合テスト\r\n *\r\n * Requirements: タスク13.3, 13.4 - API Gateway エンドポイント実装\r\n */\r\n\r\nimport * as cdk from 'aws-cdk-lib';\r\nimport { Template, Match } from 'aws-cdk-lib/assertions';\r\nimport { TdnetDataCollectorStack } from '../lib/tdnet-data-collector-stack';\r\n\r\ndescribe('API Gateway Query & Export Endpoints', () => {\r\n  let template: Template;\r\n\r\n  beforeAll(() => {\r\n    const app = new cdk.App();\r\n    const stack = new TdnetDataCollectorStack(app, 'TestStack');\r\n    template = Template.fromStack(stack);\r\n  });\r\n\r\n  describe('GET /disclosures エンドポイント', () => {\r\n    it('should create /disclosures resource', () => {\r\n      // /disclosures リソースが作成されていることを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::Resource', {\r\n        PathPart: 'disclosures',\r\n      });\r\n    });\r\n\r\n    it('should create GET method with API key required', () => {\r\n      // GET メソッドが作成され、APIキー認証が必須であることを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::Method', {\r\n        HttpMethod: 'GET',\r\n        ApiKeyRequired: true,\r\n        ResourceId: Match.objectLike({\r\n          Ref: Match.stringLikeRegexp('.*disclosures.*'),\r\n        }),\r\n      });\r\n    });\r\n\r\n    it('should configure query parameters', () => {\r\n      // クエリパラメータが設定されていることを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::Method', {\r\n        HttpMethod: 'GET',\r\n        RequestParameters: {\r\n          'method.request.querystring.company_code': false,\r\n          'method.request.querystring.start_date': false,\r\n          'method.request.querystring.end_date': false,\r\n          'method.request.querystring.disclosure_type': false,\r\n          'method.request.querystring.format': false,\r\n          'method.request.querystring.limit': false,\r\n          'method.request.querystring.offset': false,\r\n        },\r\n      });\r\n    });\r\n\r\n    it('should configure Lambda integration', () => {\r\n      // Lambda統合が設定されていることを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::Method', {\r\n        HttpMethod: 'GET',\r\n        Integration: {\r\n          Type: 'AWS_PROXY',\r\n          IntegrationHttpMethod: 'POST',\r\n          Uri: Match.objectLike({\r\n            'Fn::Join': Match.arrayWith([\r\n              Match.arrayWith([\r\n                Match.stringLikeRegexp('.*lambda.*'),\r\n              ]),\r\n            ]),\r\n          }),\r\n        },\r\n      });\r\n    });\r\n\r\n    it('should configure CORS headers', () => {\r\n      // CORSヘッダーが設定されていることを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::Method', {\r\n        HttpMethod: 'GET',\r\n        MethodResponses: Match.arrayWith([\r\n          Match.objectLike({\r\n            StatusCode: '200',\r\n            ResponseParameters: {\r\n              'method.response.header.Access-Control-Allow-Origin': true,\r\n              'method.response.header.Content-Type': true,\r\n            },\r\n          }),\r\n        ]),\r\n      });\r\n    });\r\n\r\n    it('should configure error responses (400, 401, 500)', () => {\r\n      // エラーレスポンスが設定されていることを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::Method', {\r\n        HttpMethod: 'GET',\r\n        MethodResponses: Match.arrayWith([\r\n          Match.objectLike({ StatusCode: '200' }),\r\n          Match.objectLike({ StatusCode: '400' }),\r\n          Match.objectLike({ StatusCode: '401' }),\r\n          Match.objectLike({ StatusCode: '500' }),\r\n        ]),\r\n      });\r\n    });\r\n\r\n    it('should grant Query Lambda permission to be invoked by API Gateway', () => {\r\n      // API GatewayがQuery Lambdaを呼び出す権限が付与されていることを確認\r\n      template.hasResourceProperties('AWS::Lambda::Permission', {\r\n        Action: 'lambda:InvokeFunction',\r\n        Principal: 'apigateway.amazonaws.com',\r\n        FunctionName: Match.objectLike({\r\n          'Fn::GetAtt': Match.arrayWith([\r\n            Match.stringLikeRegexp('QueryFunction.*'),\r\n            'Arn',\r\n          ]),\r\n        }),\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('POST /exports エンドポイント', () => {\r\n    it('should create /exports resource', () => {\r\n      // /exports リソースが作成されていることを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::Resource', {\r\n        PathPart: 'exports',\r\n      });\r\n    });\r\n\r\n    it('should create POST method with API key required', () => {\r\n      // POST メソッドが作成され、APIキー認証が必須であることを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::Method', {\r\n        HttpMethod: 'POST',\r\n        ApiKeyRequired: true,\r\n        ResourceId: Match.objectLike({\r\n          Ref: Match.stringLikeRegexp('.*exports.*'),\r\n        }),\r\n      });\r\n    });\r\n\r\n    it('should configure Lambda integration', () => {\r\n      // Lambda統合が設定されていることを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::Method', {\r\n        HttpMethod: 'POST',\r\n        Integration: {\r\n          Type: 'AWS_PROXY',\r\n          IntegrationHttpMethod: 'POST',\r\n          Uri: Match.objectLike({\r\n            'Fn::Join': Match.arrayWith([\r\n              Match.arrayWith([\r\n                Match.stringLikeRegexp('.*lambda.*'),\r\n              ]),\r\n            ]),\r\n          }),\r\n        },\r\n      });\r\n    });\r\n\r\n    it('should configure CORS headers', () => {\r\n      // CORSヘッダーが設定されていることを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::Method', {\r\n        HttpMethod: 'POST',\r\n        MethodResponses: Match.arrayWith([\r\n          Match.objectLike({\r\n            StatusCode: '202',\r\n            ResponseParameters: {\r\n              'method.response.header.Access-Control-Allow-Origin': true,\r\n            },\r\n          }),\r\n        ]),\r\n      });\r\n    });\r\n\r\n    it('should configure success response (202 Accepted)', () => {\r\n      // 成功レスポンス（202 Accepted）が設定されていることを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::Method', {\r\n        HttpMethod: 'POST',\r\n        MethodResponses: Match.arrayWith([\r\n          Match.objectLike({ StatusCode: '202' }),\r\n        ]),\r\n      });\r\n    });\r\n\r\n    it('should configure error responses (400, 401, 500)', () => {\r\n      // エラーレスポンスが設定されていることを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::Method', {\r\n        HttpMethod: 'POST',\r\n        MethodResponses: Match.arrayWith([\r\n          Match.objectLike({ StatusCode: '202' }),\r\n          Match.objectLike({ StatusCode: '400' }),\r\n          Match.objectLike({ StatusCode: '401' }),\r\n          Match.objectLike({ StatusCode: '500' }),\r\n        ]),\r\n      });\r\n    });\r\n\r\n    it('should grant Export Lambda permission to be invoked by API Gateway', () => {\r\n      // API GatewayがExport Lambdaを呼び出す権限が付与されていることを確認\r\n      template.hasResourceProperties('AWS::Lambda::Permission', {\r\n        Action: 'lambda:InvokeFunction',\r\n        Principal: 'apigateway.amazonaws.com',\r\n        FunctionName: Match.objectLike({\r\n          'Fn::GetAtt': Match.arrayWith([\r\n            Match.stringLikeRegexp('ExportFunction.*'),\r\n            'Arn',\r\n          ]),\r\n        }),\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('CloudFormation Outputs', () => {\r\n    it('should export Disclosures endpoint URL', () => {\r\n      // Disclosures エンドポイントURLがエクスポートされていることを確認\r\n      template.hasOutput('DisclosuresEndpoint', {\r\n        Description: 'Disclosures query API endpoint URL',\r\n        Export: {\r\n          Name: 'TdnetDisclosuresEndpoint',\r\n        },\r\n      });\r\n    });\r\n\r\n    it('should export Exports endpoint URL', () => {\r\n      // Exports エンドポイントURLがエクスポートされていることを確認\r\n      template.hasOutput('ExportsEndpoint', {\r\n        Description: 'Export API endpoint URL',\r\n        Export: {\r\n          Name: 'TdnetExportsEndpoint',\r\n        },\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('API Gateway統合の整合性', () => {\r\n    it('should have consistent API Gateway configuration', () => {\r\n      // API Gatewayの基本設定が存在することを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::RestApi', {\r\n        Name: 'tdnet-data-collector-api',\r\n        Description: 'TDnet Data Collector REST API',\r\n      });\r\n    });\r\n\r\n    it('should have deployment stage configured', () => {\r\n      // デプロイステージが設定されていることを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::Stage', {\r\n        StageName: 'prod',\r\n      });\r\n    });\r\n\r\n    it('should have usage plan with API key', () => {\r\n      // Usage PlanとAPIキーが設定されていることを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::UsagePlan', {\r\n        UsagePlanName: 'tdnet-usage-plan',\r\n        Description: 'Usage plan for TDnet Data Collector API',\r\n      });\r\n    });\r\n\r\n    it('should associate API key with usage plan', () => {\r\n      // APIキーがUsage Planに関連付けられていることを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::UsagePlanKey', {\r\n        KeyType: 'API_KEY',\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('Lambda関数の権限', () => {\r\n    it('should grant Query Lambda read access to DynamoDB', () => {\r\n      // Query LambdaにDynamoDBの読み取り権限が付与されていることを確認\r\n      template.hasResourceProperties('AWS::IAM::Policy', {\r\n        PolicyDocument: {\r\n          Statement: Match.arrayWith([\r\n            Match.objectLike({\r\n              Action: Match.arrayWith([\r\n                'dynamodb:BatchGetItem',\r\n                'dynamodb:Query',\r\n                'dynamodb:GetItem',\r\n                'dynamodb:Scan',\r\n              ]),\r\n              Effect: 'Allow',\r\n            }),\r\n          ]),\r\n        },\r\n        Roles: Match.arrayWith([\r\n          Match.objectLike({\r\n            Ref: Match.stringLikeRegexp('QueryFunction.*Role.*'),\r\n          }),\r\n        ]),\r\n      });\r\n    });\r\n\r\n    it('should grant Export Lambda read access to DynamoDB', () => {\r\n      // Export LambdaにDynamoDBの読み取り権限が付与されていることを確認\r\n      template.hasResourceProperties('AWS::IAM::Policy', {\r\n        PolicyDocument: {\r\n          Statement: Match.arrayWith([\r\n            Match.objectLike({\r\n              Action: Match.arrayWith([\r\n                'dynamodb:BatchGetItem',\r\n                'dynamodb:Query',\r\n                'dynamodb:GetItem',\r\n                'dynamodb:Scan',\r\n              ]),\r\n              Effect: 'Allow',\r\n            }),\r\n          ]),\r\n        },\r\n        Roles: Match.arrayWith([\r\n          Match.objectLike({\r\n            Ref: Match.stringLikeRegexp('ExportFunction.*Role.*'),\r\n          }),\r\n        ]),\r\n      });\r\n    });\r\n\r\n    it('should grant Export Lambda write access to S3 exports bucket', () => {\r\n      // Export LambdaにS3 exportsバケットへの書き込み権限が付与されていることを確認\r\n      template.hasResourceProperties('AWS::IAM::Policy', {\r\n        PolicyDocument: {\r\n          Statement: Match.arrayWith([\r\n            Match.objectLike({\r\n              Action: Match.arrayWith([\r\n                's3:PutObject',\r\n                's3:PutObjectLegalHold',\r\n                's3:PutObjectRetention',\r\n                's3:PutObjectTagging',\r\n                's3:PutObjectVersionTagging',\r\n                's3:Abort*',\r\n              ]),\r\n              Effect: 'Allow',\r\n            }),\r\n          ]),\r\n        },\r\n        Roles: Match.arrayWith([\r\n          Match.objectLike({\r\n            Ref: Match.stringLikeRegexp('ExportFunction.*Role.*'),\r\n          }),\r\n        ]),\r\n      });\r\n    });\r\n\r\n    it('should grant Query Lambda read access to S3 PDFs bucket', () => {\r\n      // Query LambdaにS3 PDFsバケットへの読み取り権限が付与されていることを確認\r\n      template.hasResourceProperties('AWS::IAM::Policy', {\r\n        PolicyDocument: {\r\n          Statement: Match.arrayWith([\r\n            Match.objectLike({\r\n              Action: Match.arrayWith([\r\n                's3:GetObject*',\r\n                's3:GetBucket*',\r\n                's3:List*',\r\n              ]),\r\n              Effect: 'Allow',\r\n            }),\r\n          ]),\r\n        },\r\n        Roles: Match.arrayWith([\r\n          Match.objectLike({\r\n            Ref: Match.stringLikeRegexp('QueryFunction.*Role.*'),\r\n          }),\r\n        ]),\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('WAF統合', () => {\r\n    it('should associate WAF Web ACL with API Gateway', () => {\r\n      // WAF Web ACLがAPI Gatewayに関連付けられていることを確認\r\n      template.hasResourceProperties('AWS::WAFv2::WebACLAssociation', {\r\n        ResourceArn: Match.objectLike({\r\n          'Fn::Join': Match.arrayWith([\r\n            '',\r\n            Match.arrayWith([\r\n              Match.stringLikeRegexp('.*execute-api.*'),\r\n            ]),\r\n          ]),\r\n        }),\r\n        WebACLArn: Match.objectLike({\r\n          'Fn::GetAtt': Match.arrayWith([\r\n            Match.stringLikeRegexp('.*WebAcl.*'),\r\n            'Arn',\r\n          ]),\r\n        }),\r\n      });\r\n    });\r\n  });\r\n});\r\n"],"version":3}