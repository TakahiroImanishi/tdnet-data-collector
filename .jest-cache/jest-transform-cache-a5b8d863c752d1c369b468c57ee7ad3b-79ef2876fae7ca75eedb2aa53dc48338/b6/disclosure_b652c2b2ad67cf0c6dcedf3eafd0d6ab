6729cad17d552eea3c690b3696dc6a61
"use strict";
/**
 * Disclosureモデルと変換関数
 *
 * 開示情報のモデルとDynamoDBアイテムとの変換関数を提供します。
 *
 * Requirements: 要件2.1, 2.2, 2.3（メタデータ管理）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.validateDisclosure = validateDisclosure;
exports.toDynamoDBItem = toDynamoDBItem;
exports.fromDynamoDBItem = fromDynamoDBItem;
exports.createDisclosure = createDisclosure;
exports.generateDisclosureId = generateDisclosureId;
const errors_1 = require("../errors");
const date_partition_1 = require("../utils/date-partition");
/**
 * Disclosureの必須フィールドをバリデーション
 *
 * @param disclosure - バリデーション対象のDisclosure
 * @throws {ValidationError} 必須フィールドが欠落している場合
 */
function validateDisclosure(disclosure) {
    const requiredFields = [
        'disclosure_id',
        'company_code',
        'company_name',
        'disclosure_type',
        'title',
        'disclosed_at',
        'pdf_url',
        's3_key',
        'collected_at',
        'date_partition',
    ];
    const missingFields = requiredFields.filter((field) => !disclosure[field]);
    if (missingFields.length > 0) {
        throw new errors_1.ValidationError(`Missing required fields: ${missingFields.join(', ')}`, {
            missing_fields: missingFields,
            disclosure,
        });
    }
    // disclosed_atのフォーマット検証
    (0, date_partition_1.validateDisclosedAt)(disclosure.disclosed_at);
    // collected_atのフォーマット検証
    (0, date_partition_1.validateDisclosedAt)(disclosure.collected_at);
    // company_codeのフォーマット検証（4桁の数字）
    const companyCodeRegex = /^\d{4}$/;
    if (!companyCodeRegex.test(disclosure.company_code)) {
        throw new errors_1.ValidationError(`Invalid company_code format: ${disclosure.company_code}. Expected 4-digit number.`, { company_code: disclosure.company_code });
    }
    // date_partitionのフォーマット検証（YYYY-MM形式）
    const datePartitionRegex = /^\d{4}-\d{2}$/;
    if (!datePartitionRegex.test(disclosure.date_partition)) {
        throw new errors_1.ValidationError(`Invalid date_partition format: ${disclosure.date_partition}. Expected YYYY-MM format.`, { date_partition: disclosure.date_partition });
    }
}
/**
 * DisclosureをDynamoDBアイテムに変換
 *
 * Two-Phase Commit原則に従い、date_partitionは事前に生成されている必要があります。
 * この関数は変換のみを行い、date_partitionの生成は行いません。
 *
 * @param disclosure - 変換元のDisclosure
 * @returns DynamoDBアイテム
 * @throws {ValidationError} バリデーションエラーの場合
 */
function toDynamoDBItem(disclosure) {
    // バリデーション
    validateDisclosure(disclosure);
    // DynamoDBアイテムに変換
    return {
        disclosure_id: { S: disclosure.disclosure_id },
        company_code: { S: disclosure.company_code },
        company_name: { S: disclosure.company_name },
        disclosure_type: { S: disclosure.disclosure_type },
        title: { S: disclosure.title },
        disclosed_at: { S: disclosure.disclosed_at },
        pdf_url: { S: disclosure.pdf_url },
        s3_key: { S: disclosure.s3_key },
        collected_at: { S: disclosure.collected_at },
        date_partition: { S: disclosure.date_partition },
    };
}
/**
 * DynamoDBアイテムをDisclosureに変換
 *
 * @param item - 変換元のDynamoDBアイテム
 * @returns Disclosure
 * @throws {ValidationError} 必須フィールドが欠落している場合
 */
function fromDynamoDBItem(item) {
    // 必須フィールドの存在チェック
    const requiredFields = [
        'disclosure_id',
        'company_code',
        'company_name',
        'disclosure_type',
        'title',
        'disclosed_at',
        'pdf_url',
        's3_key',
        'collected_at',
        'date_partition',
    ];
    const missingFields = requiredFields.filter((field) => !item[field]);
    if (missingFields.length > 0) {
        throw new errors_1.ValidationError(`Missing required fields in DynamoDB item: ${missingFields.join(', ')}`, { missing_fields: missingFields, item });
    }
    // Disclosureに変換
    const disclosure = {
        disclosure_id: item.disclosure_id.S ?? '',
        company_code: item.company_code.S ?? '',
        company_name: item.company_name.S ?? '',
        disclosure_type: item.disclosure_type.S ?? '',
        title: item.title.S ?? '',
        disclosed_at: item.disclosed_at.S ?? '',
        pdf_url: item.pdf_url.S ?? '',
        s3_key: item.s3_key.S ?? '',
        collected_at: item.collected_at.S ?? '',
        date_partition: item.date_partition.S ?? '',
    };
    // バリデーション
    validateDisclosure(disclosure);
    return disclosure;
}
/**
 * Disclosureを作成する際のヘルパー関数
 *
 * date_partitionを自動生成し、collected_atを現在時刻に設定します。
 * Two-Phase Commit原則に従い、date_partitionは保存前に生成されます。
 *
 * @param params - Disclosure作成パラメータ（date_partition、collected_atは省略可能）
 * @returns 完全なDisclosure
 * @throws {ValidationError} バリデーションエラーの場合
 */
function createDisclosure(params) {
    // date_partitionが指定されていない場合は自動生成
    const date_partition = params.date_partition || (0, date_partition_1.generateDatePartition)(params.disclosed_at);
    // collected_atが指定されていない場合は現在時刻を使用
    const collected_at = params.collected_at || new Date().toISOString();
    const disclosure = {
        ...params,
        date_partition,
        collected_at,
    };
    // バリデーション
    validateDisclosure(disclosure);
    return disclosure;
}
/**
 * 開示IDを生成
 *
 * フォーマット: 日付_企業コード_連番
 * 例: 20240115_1234_001
 *
 * @param disclosedAt - 開示日時（ISO 8601形式）
 * @param companyCode - 企業コード（4桁）
 * @param sequence - 連番（同一日・同一企業の複数開示を区別）
 * @returns 開示ID
 * @throws {ValidationError} バリデーションエラーの場合
 */
function generateDisclosureId(disclosedAt, companyCode, sequence) {
    // disclosed_atのバリデーション
    (0, date_partition_1.validateDisclosedAt)(disclosedAt);
    // company_codeのバリデーション（4桁の数字）
    const companyCodeRegex = /^\d{4}$/;
    if (!companyCodeRegex.test(companyCode)) {
        throw new errors_1.ValidationError(`Invalid company_code format: ${companyCode}. Expected 4-digit number.`, { company_code: companyCode });
    }
    // sequenceのバリデーション（正の整数）
    if (!Number.isInteger(sequence) || sequence < 0) {
        throw new errors_1.ValidationError(`Invalid sequence: ${sequence}. Expected non-negative integer.`, {
            sequence,
        });
    }
    // JST基準で日付を取得
    const utcDate = new Date(disclosedAt);
    const jstDate = new Date(utcDate.getTime() + 9 * 60 * 60 * 1000);
    // YYYYMMDD形式
    const year = jstDate.getUTCFullYear();
    const month = String(jstDate.getUTCMonth() + 1).padStart(2, '0');
    const day = String(jstDate.getUTCDate()).padStart(2, '0');
    const dateStr = `${year}${month}${day}`;
    // 連番を3桁にゼロパディング
    const sequenceStr = String(sequence).padStart(3, '0');
    return `${dateStr}_${companyCode}_${sequenceStr}`;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxtb2RlbHNcXGRpc2Nsb3N1cmUudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7R0FNRzs7QUFZSCxnREE4Q0M7QUFZRCx3Q0FpQkM7QUFTRCw0Q0EwQ0M7QUFZRCw0Q0FzQkM7QUFjRCxvREFzQ0M7QUE3TkQsc0NBQTRDO0FBQzVDLDREQUFxRjtBQUVyRjs7Ozs7R0FLRztBQUNILFNBQWdCLGtCQUFrQixDQUFDLFVBQStCO0lBQ2hFLE1BQU0sY0FBYyxHQUE0QjtRQUM5QyxlQUFlO1FBQ2YsY0FBYztRQUNkLGNBQWM7UUFDZCxpQkFBaUI7UUFDakIsT0FBTztRQUNQLGNBQWM7UUFDZCxTQUFTO1FBQ1QsUUFBUTtRQUNSLGNBQWM7UUFDZCxnQkFBZ0I7S0FDakIsQ0FBQztJQUVGLE1BQU0sYUFBYSxHQUFHLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFFM0UsSUFBSSxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQzdCLE1BQU0sSUFBSSx3QkFBZSxDQUFDLDRCQUE0QixhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDaEYsY0FBYyxFQUFFLGFBQWE7WUFDN0IsVUFBVTtTQUNYLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCx3QkFBd0I7SUFDeEIsSUFBQSxvQ0FBbUIsRUFBQyxVQUFVLENBQUMsWUFBYSxDQUFDLENBQUM7SUFFOUMsd0JBQXdCO0lBQ3hCLElBQUEsb0NBQW1CLEVBQUMsVUFBVSxDQUFDLFlBQWEsQ0FBQyxDQUFDO0lBRTlDLCtCQUErQjtJQUMvQixNQUFNLGdCQUFnQixHQUFHLFNBQVMsQ0FBQztJQUNuQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFhLENBQUMsRUFBRSxDQUFDO1FBQ3JELE1B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O0FBQ3BELENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxtb2RlbHNcXGRpc2Nsb3N1cmUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBEaXNjbG9zdXJl44Oi44OH44Or44Go5aSJ5o+b6Zai5pWwXG4gKlxuICog6ZaL56S65oOF5aCx44Gu44Oi44OH44Or44GoRHluYW1vRELjgqLjgqTjg4bjg6Djgajjga7lpInmj5vplqLmlbDjgpLmj5DkvpvjgZfjgb7jgZnjgIJcbiAqXG4gKiBSZXF1aXJlbWVudHM6IOimgeS7tjIuMSwgMi4yLCAyLjPvvIjjg6Hjgr/jg4fjg7zjgr/nrqHnkIbvvIlcbiAqL1xuXG5pbXBvcnQgeyBEaXNjbG9zdXJlLCBEeW5hbW9EQkl0ZW0gfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBWYWxpZGF0aW9uRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMnO1xuaW1wb3J0IHsgZ2VuZXJhdGVEYXRlUGFydGl0aW9uLCB2YWxpZGF0ZURpc2Nsb3NlZEF0IH0gZnJvbSAnLi4vdXRpbHMvZGF0ZS1wYXJ0aXRpb24nO1xuXG4vKipcbiAqIERpc2Nsb3N1cmXjga7lv4XpoIjjg5XjgqPjg7zjg6vjg4njgpLjg5Djg6rjg4fjg7zjgrfjg6fjg7NcbiAqXG4gKiBAcGFyYW0gZGlzY2xvc3VyZSAtIOODkOODquODh+ODvOOCt+ODp+ODs+WvvuixoeOBrkRpc2Nsb3N1cmVcbiAqIEB0aHJvd3Mge1ZhbGlkYXRpb25FcnJvcn0g5b+F6aCI44OV44Kj44O844Or44OJ44GM5qyg6JC944GX44Gm44GE44KL5aC05ZCIXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZURpc2Nsb3N1cmUoZGlzY2xvc3VyZTogUGFydGlhbDxEaXNjbG9zdXJlPik6IHZvaWQge1xuICBjb25zdCByZXF1aXJlZEZpZWxkczogQXJyYXk8a2V5b2YgRGlzY2xvc3VyZT4gPSBbXG4gICAgJ2Rpc2Nsb3N1cmVfaWQnLFxuICAgICdjb21wYW55X2NvZGUnLFxuICAgICdjb21wYW55X25hbWUnLFxuICAgICdkaXNjbG9zdXJlX3R5cGUnLFxuICAgICd0aXRsZScsXG4gICAgJ2Rpc2Nsb3NlZF9hdCcsXG4gICAgJ3BkZl91cmwnLFxuICAgICdzM19rZXknLFxuICAgICdjb2xsZWN0ZWRfYXQnLFxuICAgICdkYXRlX3BhcnRpdGlvbicsXG4gIF07XG5cbiAgY29uc3QgbWlzc2luZ0ZpZWxkcyA9IHJlcXVpcmVkRmllbGRzLmZpbHRlcigoZmllbGQpID0+ICFkaXNjbG9zdXJlW2ZpZWxkXSk7XG5cbiAgaWYgKG1pc3NpbmdGaWVsZHMubGVuZ3RoID4gMCkge1xuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoYE1pc3NpbmcgcmVxdWlyZWQgZmllbGRzOiAke21pc3NpbmdGaWVsZHMuam9pbignLCAnKX1gLCB7XG4gICAgICBtaXNzaW5nX2ZpZWxkczogbWlzc2luZ0ZpZWxkcyxcbiAgICAgIGRpc2Nsb3N1cmUsXG4gICAgfSk7XG4gIH1cblxuICAvLyBkaXNjbG9zZWRfYXTjga7jg5Xjgqnjg7zjg57jg4Pjg4jmpJzoqLxcbiAgdmFsaWRhdGVEaXNjbG9zZWRBdChkaXNjbG9zdXJlLmRpc2Nsb3NlZF9hdCEpO1xuXG4gIC8vIGNvbGxlY3RlZF9hdOOBruODleOCqeODvOODnuODg+ODiOaknOiovFxuICB2YWxpZGF0ZURpc2Nsb3NlZEF0KGRpc2Nsb3N1cmUuY29sbGVjdGVkX2F0ISk7XG5cbiAgLy8gY29tcGFueV9jb2Rl44Gu44OV44Kp44O844Oe44OD44OI5qSc6Ki877yINOahgeOBruaVsOWtl++8iVxuICBjb25zdCBjb21wYW55Q29kZVJlZ2V4ID0gL15cXGR7NH0kLztcbiAgaWYgKCFjb21wYW55Q29kZVJlZ2V4LnRlc3QoZGlzY2xvc3VyZS5jb21wYW55X2NvZGUhKSkge1xuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXG4gICAgICBgSW52YWxpZCBjb21wYW55X2NvZGUgZm9ybWF0OiAke2Rpc2Nsb3N1cmUuY29tcGFueV9jb2RlfS4gRXhwZWN0ZWQgNC1kaWdpdCBudW1iZXIuYCxcbiAgICAgIHsgY29tcGFueV9jb2RlOiBkaXNjbG9zdXJlLmNvbXBhbnlfY29kZSB9XG4gICAgKTtcbiAgfVxuXG4gIC8vIGRhdGVfcGFydGl0aW9u44Gu44OV44Kp44O844Oe44OD44OI5qSc6Ki877yIWVlZWS1NTeW9ouW8j++8iVxuICBjb25zdCBkYXRlUGFydGl0aW9uUmVnZXggPSAvXlxcZHs0fS1cXGR7Mn0kLztcbiAgaWYgKCFkYXRlUGFydGl0aW9uUmVnZXgudGVzdChkaXNjbG9zdXJlLmRhdGVfcGFydGl0aW9uISkpIHtcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxuICAgICAgYEludmFsaWQgZGF0ZV9wYXJ0aXRpb24gZm9ybWF0OiAke2Rpc2Nsb3N1cmUuZGF0ZV9wYXJ0aXRpb259LiBFeHBlY3RlZCBZWVlZLU1NIGZvcm1hdC5gLFxuICAgICAgeyBkYXRlX3BhcnRpdGlvbjogZGlzY2xvc3VyZS5kYXRlX3BhcnRpdGlvbiB9XG4gICAgKTtcbiAgfVxufVxuXG4vKipcbiAqIERpc2Nsb3N1cmXjgpJEeW5hbW9EQuOCouOCpOODhuODoOOBq+WkieaPm1xuICpcbiAqIFR3by1QaGFzZSBDb21taXTljp/liYfjgavlvpPjgYTjgIFkYXRlX3BhcnRpdGlvbuOBr+S6i+WJjeOBq+eUn+aIkOOBleOCjOOBpuOBhOOCi+W/heimgeOBjOOBguOCiuOBvuOBmeOAglxuICog44GT44Gu6Zai5pWw44Gv5aSJ5o+b44Gu44G/44KS6KGM44GE44CBZGF0ZV9wYXJ0aXRpb27jga7nlJ/miJDjga/ooYzjgYTjgb7jgZvjgpPjgIJcbiAqXG4gKiBAcGFyYW0gZGlzY2xvc3VyZSAtIOWkieaPm+WFg+OBrkRpc2Nsb3N1cmVcbiAqIEByZXR1cm5zIER5bmFtb0RC44Ki44Kk44OG44OgXG4gKiBAdGhyb3dzIHtWYWxpZGF0aW9uRXJyb3J9IOODkOODquODh+ODvOOCt+ODp+ODs+OCqOODqeODvOOBruWgtOWQiFxuICovXG5leHBvcnQgZnVuY3Rpb24gdG9EeW5hbW9EQkl0ZW0oZGlzY2xvc3VyZTogRGlzY2xvc3VyZSk6IER5bmFtb0RCSXRlbSB7XG4gIC8vIOODkOODquODh+ODvOOCt+ODp+ODs1xuICB2YWxpZGF0ZURpc2Nsb3N1cmUoZGlzY2xvc3VyZSk7XG5cbiAgLy8gRHluYW1vRELjgqLjgqTjg4bjg6DjgavlpInmj5tcbiAgcmV0dXJuIHtcbiAgICBkaXNjbG9zdXJlX2lkOiB7IFM6IGRpc2Nsb3N1cmUuZGlzY2xvc3VyZV9pZCB9LFxuICAgIGNvbXBhbnlfY29kZTogeyBTOiBkaXNjbG9zdXJlLmNvbXBhbnlfY29kZSB9LFxuICAgIGNvbXBhbnlfbmFtZTogeyBTOiBkaXNjbG9zdXJlLmNvbXBhbnlfbmFtZSB9LFxuICAgIGRpc2Nsb3N1cmVfdHlwZTogeyBTOiBkaXNjbG9zdXJlLmRpc2Nsb3N1cmVfdHlwZSB9LFxuICAgIHRpdGxlOiB7IFM6IGRpc2Nsb3N1cmUudGl0bGUgfSxcbiAgICBkaXNjbG9zZWRfYXQ6IHsgUzogZGlzY2xvc3VyZS5kaXNjbG9zZWRfYXQgfSxcbiAgICBwZGZfdXJsOiB7IFM6IGRpc2Nsb3N1cmUucGRmX3VybCB9LFxuICAgIHMzX2tleTogeyBTOiBkaXNjbG9zdXJlLnMzX2tleSB9LFxuICAgIGNvbGxlY3RlZF9hdDogeyBTOiBkaXNjbG9zdXJlLmNvbGxlY3RlZF9hdCB9LFxuICAgIGRhdGVfcGFydGl0aW9uOiB7IFM6IGRpc2Nsb3N1cmUuZGF0ZV9wYXJ0aXRpb24gfSxcbiAgfTtcbn1cblxuLyoqXG4gKiBEeW5hbW9EQuOCouOCpOODhuODoOOCkkRpc2Nsb3N1cmXjgavlpInmj5tcbiAqXG4gKiBAcGFyYW0gaXRlbSAtIOWkieaPm+WFg+OBrkR5bmFtb0RC44Ki44Kk44OG44OgXG4gKiBAcmV0dXJucyBEaXNjbG9zdXJlXG4gKiBAdGhyb3dzIHtWYWxpZGF0aW9uRXJyb3J9IOW/hemgiOODleOCo+ODvOODq+ODieOBjOasoOiQveOBl+OBpuOBhOOCi+WgtOWQiFxuICovXG5leHBvcnQgZnVuY3Rpb24gZnJvbUR5bmFtb0RCSXRlbShpdGVtOiBEeW5hbW9EQkl0ZW0pOiBEaXNjbG9zdXJlIHtcbiAgLy8g5b+F6aCI44OV44Kj44O844Or44OJ44Gu5a2Y5Zyo44OB44Kn44OD44KvXG4gIGNvbnN0IHJlcXVpcmVkRmllbGRzID0gW1xuICAgICdkaXNjbG9zdXJlX2lkJyxcbiAgICAnY29tcGFueV9jb2RlJyxcbiAgICAnY29tcGFueV9uYW1lJyxcbiAgICAnZGlzY2xvc3VyZV90eXBlJyxcbiAgICAndGl0bGUnLFxuICAgICdkaXNjbG9zZWRfYXQnLFxuICAgICdwZGZfdXJsJyxcbiAgICAnczNfa2V5JyxcbiAgICAnY29sbGVjdGVkX2F0JyxcbiAgICAnZGF0ZV9wYXJ0aXRpb24nLFxuICBdO1xuXG4gIGNvbnN0IG1pc3NpbmdGaWVsZHMgPSByZXF1aXJlZEZpZWxkcy5maWx0ZXIoKGZpZWxkKSA9PiAhaXRlbVtmaWVsZF0pO1xuXG4gIGlmIChtaXNzaW5nRmllbGRzLmxlbmd0aCA+IDApIHtcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxuICAgICAgYE1pc3NpbmcgcmVxdWlyZWQgZmllbGRzIGluIER5bmFtb0RCIGl0ZW06ICR7bWlzc2luZ0ZpZWxkcy5qb2luKCcsICcpfWAsXG4gICAgICB7IG1pc3NpbmdfZmllbGRzOiBtaXNzaW5nRmllbGRzLCBpdGVtIH1cbiAgICApO1xuICB9XG5cbiAgLy8gRGlzY2xvc3VyZeOBq+WkieaPm1xuICBjb25zdCBkaXNjbG9zdXJlOiBEaXNjbG9zdXJlID0ge1xuICAgIGRpc2Nsb3N1cmVfaWQ6IGl0ZW0uZGlzY2xvc3VyZV9pZC5TID8/ICcnLFxuICAgIGNvbXBhbnlfY29kZTogaXRlbS5jb21wYW55X2NvZGUuUyA/PyAnJyxcbiAgICBjb21wYW55X25hbWU6IGl0ZW0uY29tcGFueV9uYW1lLlMgPz8gJycsXG4gICAgZGlzY2xvc3VyZV90eXBlOiBpdGVtLmRpc2Nsb3N1cmVfdHlwZS5TID8/ICcnLFxuICAgIHRpdGxlOiBpdGVtLnRpdGxlLlMgPz8gJycsXG4gICAgZGlzY2xvc2VkX2F0OiBpdGVtLmRpc2Nsb3NlZF9hdC5TID8/ICcnLFxuICAgIHBkZl91cmw6IGl0ZW0ucGRmX3VybC5TID8/ICcnLFxuICAgIHMzX2tleTogaXRlbS5zM19rZXkuUyA/PyAnJyxcbiAgICBjb2xsZWN0ZWRfYXQ6IGl0ZW0uY29sbGVjdGVkX2F0LlMgPz8gJycsXG4gICAgZGF0ZV9wYXJ0aXRpb246IGl0ZW0uZGF0ZV9wYXJ0aXRpb24uUyA/PyAnJyxcbiAgfTtcblxuICAvLyDjg5Djg6rjg4fjg7zjgrfjg6fjg7NcbiAgdmFsaWRhdGVEaXNjbG9zdXJlKGRpc2Nsb3N1cmUpO1xuXG4gIHJldHVybiBkaXNjbG9zdXJlO1xufVxuXG4vKipcbiAqIERpc2Nsb3N1cmXjgpLkvZzmiJDjgZnjgovpmpvjga7jg5jjg6vjg5Hjg7zplqLmlbBcbiAqXG4gKiBkYXRlX3BhcnRpdGlvbuOCkuiHquWLleeUn+aIkOOBl+OAgWNvbGxlY3RlZF9hdOOCkuePvuWcqOaZguWIu+OBq+ioreWumuOBl+OBvuOBmeOAglxuICogVHdvLVBoYXNlIENvbW1pdOWOn+WJh+OBq+W+k+OBhOOAgWRhdGVfcGFydGl0aW9u44Gv5L+d5a2Y5YmN44Gr55Sf5oiQ44GV44KM44G+44GZ44CCXG4gKlxuICogQHBhcmFtIHBhcmFtcyAtIERpc2Nsb3N1cmXkvZzmiJDjg5Hjg6njg6Hjg7zjgr/vvIhkYXRlX3BhcnRpdGlvbuOAgWNvbGxlY3RlZF9hdOOBr+ecgeeVpeWPr+iDve+8iVxuICogQHJldHVybnMg5a6M5YWo44GqRGlzY2xvc3VyZVxuICogQHRocm93cyB7VmFsaWRhdGlvbkVycm9yfSDjg5Djg6rjg4fjg7zjgrfjg6fjg7Pjgqjjg6njg7zjga7loLTlkIhcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZURpc2Nsb3N1cmUoXG4gIHBhcmFtczogT21pdDxEaXNjbG9zdXJlLCAnZGF0ZV9wYXJ0aXRpb24nIHwgJ2NvbGxlY3RlZF9hdCc+ICYge1xuICAgIGRhdGVfcGFydGl0aW9uPzogc3RyaW5nO1xuICAgIGNvbGxlY3RlZF9hdD86IHN0cmluZztcbiAgfVxuKTogRGlzY2xvc3VyZSB7XG4gIC8vIGRhdGVfcGFydGl0aW9u44GM5oyH5a6a44GV44KM44Gm44GE44Gq44GE5aC05ZCI44Gv6Ieq5YuV55Sf5oiQXG4gIGNvbnN0IGRhdGVfcGFydGl0aW9uID0gcGFyYW1zLmRhdGVfcGFydGl0aW9uIHx8IGdlbmVyYXRlRGF0ZVBhcnRpdGlvbihwYXJhbXMuZGlzY2xvc2VkX2F0KTtcblxuICAvLyBjb2xsZWN0ZWRfYXTjgYzmjIflrprjgZXjgozjgabjgYTjgarjgYTloLTlkIjjga/nj77lnKjmmYLliLvjgpLkvb/nlKhcbiAgY29uc3QgY29sbGVjdGVkX2F0ID0gcGFyYW1zLmNvbGxlY3RlZF9hdCB8fCBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG5cbiAgY29uc3QgZGlzY2xvc3VyZTogRGlzY2xvc3VyZSA9IHtcbiAgICAuLi5wYXJhbXMsXG4gICAgZGF0ZV9wYXJ0aXRpb24sXG4gICAgY29sbGVjdGVkX2F0LFxuICB9O1xuXG4gIC8vIOODkOODquODh+ODvOOCt+ODp+ODs1xuICB2YWxpZGF0ZURpc2Nsb3N1cmUoZGlzY2xvc3VyZSk7XG5cbiAgcmV0dXJuIGRpc2Nsb3N1cmU7XG59XG5cbi8qKlxuICog6ZaL56S6SUTjgpLnlJ/miJBcbiAqXG4gKiDjg5Xjgqnjg7zjg57jg4Pjg4g6IOaXpeS7mF/kvIHmpa3jgrPjg7zjg4lf6YCj55WqXG4gKiDkvos6IDIwMjQwMTE1XzEyMzRfMDAxXG4gKlxuICogQHBhcmFtIGRpc2Nsb3NlZEF0IC0g6ZaL56S65pel5pmC77yISVNPIDg2MDHlvaLlvI/vvIlcbiAqIEBwYXJhbSBjb21wYW55Q29kZSAtIOS8gealreOCs+ODvOODie+8iDTmoYHvvIlcbiAqIEBwYXJhbSBzZXF1ZW5jZSAtIOmAo+eVqu+8iOWQjOS4gOaXpeODu+WQjOS4gOS8gealreOBruikh+aVsOmWi+ekuuOCkuWMuuWIpe+8iVxuICogQHJldHVybnMg6ZaL56S6SURcbiAqIEB0aHJvd3Mge1ZhbGlkYXRpb25FcnJvcn0g44OQ44Oq44OH44O844K344On44Oz44Ko44Op44O844Gu5aC05ZCIXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZURpc2Nsb3N1cmVJZChcbiAgZGlzY2xvc2VkQXQ6IHN0cmluZyxcbiAgY29tcGFueUNvZGU6IHN0cmluZyxcbiAgc2VxdWVuY2U6IG51bWJlclxuKTogc3RyaW5nIHtcbiAgLy8gZGlzY2xvc2VkX2F044Gu44OQ44Oq44OH44O844K344On44OzXG4gIHZhbGlkYXRlRGlzY2xvc2VkQXQoZGlzY2xvc2VkQXQpO1xuXG4gIC8vIGNvbXBhbnlfY29kZeOBruODkOODquODh+ODvOOCt+ODp+ODs++8iDTmoYHjga7mlbDlrZfvvIlcbiAgY29uc3QgY29tcGFueUNvZGVSZWdleCA9IC9eXFxkezR9JC87XG4gIGlmICghY29tcGFueUNvZGVSZWdleC50ZXN0KGNvbXBhbnlDb2RlKSkge1xuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXG4gICAgICBgSW52YWxpZCBjb21wYW55X2NvZGUgZm9ybWF0OiAke2NvbXBhbnlDb2RlfS4gRXhwZWN0ZWQgNC1kaWdpdCBudW1iZXIuYCxcbiAgICAgIHsgY29tcGFueV9jb2RlOiBjb21wYW55Q29kZSB9XG4gICAgKTtcbiAgfVxuXG4gIC8vIHNlcXVlbmNl44Gu44OQ44Oq44OH44O844K344On44Oz77yI5q2j44Gu5pW05pWw77yJXG4gIGlmICghTnVtYmVyLmlzSW50ZWdlcihzZXF1ZW5jZSkgfHwgc2VxdWVuY2UgPCAwKSB7XG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihgSW52YWxpZCBzZXF1ZW5jZTogJHtzZXF1ZW5jZX0uIEV4cGVjdGVkIG5vbi1uZWdhdGl2ZSBpbnRlZ2VyLmAsIHtcbiAgICAgIHNlcXVlbmNlLFxuICAgIH0pO1xuICB9XG5cbiAgLy8gSlNU5Z+65rqW44Gn5pel5LuY44KS5Y+W5b6XXG4gIGNvbnN0IHV0Y0RhdGUgPSBuZXcgRGF0ZShkaXNjbG9zZWRBdCk7XG4gIGNvbnN0IGpzdERhdGUgPSBuZXcgRGF0ZSh1dGNEYXRlLmdldFRpbWUoKSArIDkgKiA2MCAqIDYwICogMTAwMCk7XG5cbiAgLy8gWVlZWU1NRETlvaLlvI9cbiAgY29uc3QgeWVhciA9IGpzdERhdGUuZ2V0VVRDRnVsbFllYXIoKTtcbiAgY29uc3QgbW9udGggPSBTdHJpbmcoanN0RGF0ZS5nZXRVVENNb250aCgpICsgMSkucGFkU3RhcnQoMiwgJzAnKTtcbiAgY29uc3QgZGF5ID0gU3RyaW5nKGpzdERhdGUuZ2V0VVRDRGF0ZSgpKS5wYWRTdGFydCgyLCAnMCcpO1xuICBjb25zdCBkYXRlU3RyID0gYCR7eWVhcn0ke21vbnRofSR7ZGF5fWA7XG5cbiAgLy8g6YCj55Wq44KSM+ahgeOBq+OCvOODreODkeODh+OCo+ODs+OCsFxuICBjb25zdCBzZXF1ZW5jZVN0ciA9IFN0cmluZyhzZXF1ZW5jZSkucGFkU3RhcnQoMywgJzAnKTtcblxuICByZXR1cm4gYCR7ZGF0ZVN0cn1fJHtjb21wYW55Q29kZX1fJHtzZXF1ZW5jZVN0cn1gO1xufVxuIl0sInZlcnNpb24iOjN9