{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\query\\__tests__\\handler.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\query\\__tests__\\handler.test.ts"],"sourcesContent":["/**\r\n * Lambda Query Handler Tests\r\n *\r\n * Requirements: 要件14.1（ユニットテスト）\r\n */\r\n\r\nimport { Context, APIGatewayProxyEvent } from 'aws-lambda';\r\nimport { handler } from '../handler';\r\nimport * as queryDisclosures from '../query-disclosures';\r\nimport * as formatCsv from '../format-csv';\r\nimport { Disclosure } from '../../../types';\r\n\r\n// モック\r\njest.mock('../query-disclosures');\r\njest.mock('../format-csv');\r\njest.mock('../../../utils/logger');\r\njest.mock('../../../utils/cloudwatch-metrics');\r\n\r\ndescribe('Lambda Query Handler', () => {\r\n  let mockContext: Context;\r\n  let mockEvent: APIGatewayProxyEvent;\r\n\r\n  beforeEach(() => {\r\n    // モックコンテキスト\r\n    mockContext = {\r\n      awsRequestId: 'test-request-id',\r\n      functionName: 'tdnet-query',\r\n      functionVersion: '1',\r\n      invokedFunctionArn: 'arn:aws:lambda:ap-northeast-1:123456789012:function:tdnet-query',\r\n      memoryLimitInMB: '256',\r\n      logGroupName: '/aws/lambda/tdnet-query',\r\n      logStreamName: '2024/01/15/[$LATEST]abcdef',\r\n      getRemainingTimeInMillis: () => 30000,\r\n      callbackWaitsForEmptyEventLoop: true,\r\n      done: jest.fn(),\r\n      fail: jest.fn(),\r\n      succeed: jest.fn(),\r\n    };\r\n\r\n    // モックイベント（基本）\r\n    mockEvent = {\r\n      body: null,\r\n      headers: {\r\n        'x-api-key': 'test-api-key',\r\n      },\r\n      multiValueHeaders: {},\r\n      httpMethod: 'GET',\r\n      isBase64Encoded: false,\r\n      path: '/disclosures',\r\n      pathParameters: null,\r\n      queryStringParameters: null,\r\n      multiValueQueryStringParameters: null,\r\n      stageVariables: null,\r\n      requestContext: {\r\n        accountId: '123456789012',\r\n        apiId: 'test-api-id',\r\n        protocol: 'HTTP/1.1',\r\n        httpMethod: 'GET',\r\n        path: '/disclosures',\r\n        stage: 'prod',\r\n        requestId: 'test-request-id',\r\n        requestTime: '15/Jan/2024:10:30:00 +0000',\r\n        requestTimeEpoch: 1705315800000,\r\n        identity: {\r\n          accessKey: null,\r\n          accountId: null,\r\n          apiKey: null,\r\n          apiKeyId: null,\r\n          caller: null,\r\n          clientCert: null,\r\n          cognitoAuthenticationProvider: null,\r\n          cognitoAuthenticationType: null,\r\n          cognitoIdentityId: null,\r\n          cognitoIdentityPoolId: null,\r\n          principalOrgId: null,\r\n          sourceIp: '192.168.1.1',\r\n          user: null,\r\n          userAgent: 'Mozilla/5.0',\r\n          userArn: null,\r\n        },\r\n        authorizer: null,\r\n        domainName: 'api.example.com',\r\n        domainPrefix: 'api',\r\n        resourceId: 'test-resource-id',\r\n        resourcePath: '/disclosures',\r\n      },\r\n      resource: '/disclosures',\r\n    };\r\n\r\n    // 環境変数設定\r\n    process.env.API_KEY = 'test-api-key';\r\n    process.env.DYNAMODB_TABLE_NAME = 'tdnet_disclosures';\r\n    process.env.S3_BUCKET_NAME = 'tdnet-pdfs';\r\n\r\n    // モックのリセット\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  describe('APIキー認証', () => {\r\n    it('有効なAPIキーで認証成功', async () => {\r\n      const mockDisclosures: Disclosure[] = [\r\n        {\r\n          disclosure_id: 'TD20240115001',\r\n          company_code: '7203',\r\n          company_name: 'トヨタ自動車',\r\n          disclosure_type: '決算短信',\r\n          title: '2024年3月期 第3四半期決算短信',\r\n          disclosed_at: '2024-01-15T10:30:00Z',\r\n          pdf_url: 'https://www.release.tdnet.info/...',\r\n          s3_key: '2024/01/15/TD20240115001_7203.pdf',\r\n          collected_at: '2024-01-15T10:35:00Z',\r\n          date_partition: '2024-01',\r\n        },\r\n      ];\r\n\r\n      (queryDisclosures.queryDisclosures as jest.Mock).mockResolvedValue({\r\n        disclosures: mockDisclosures,\r\n        total: 1,\r\n        count: 1,\r\n        offset: 0,\r\n        limit: 100,\r\n      });\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(200);\r\n      expect(JSON.parse(result.body)).toEqual({\r\n        disclosures: mockDisclosures,\r\n        total: 1,\r\n        count: 1,\r\n        offset: 0,\r\n        limit: 100,\r\n      });\r\n    });\r\n\r\n    it('APIキーが未設定の場合は401エラー', async () => {\r\n      mockEvent.headers = {};\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(401);\r\n      const body = JSON.parse(result.body);\r\n      expect(body.status).toBe('error');\r\n      expect(body.error.code).toBe('UNAUTHORIZED');\r\n      expect(body.error.message).toContain('API key is required');\r\n      expect(body.request_id).toBe('test-request-id');\r\n    });\r\n\r\n    it('無効なAPIキーの場合は401エラー', async () => {\r\n      mockEvent.headers = {\r\n        'x-api-key': 'invalid-api-key',\r\n      };\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(401);\r\n      const body = JSON.parse(result.body);\r\n      expect(body.status).toBe('error');\r\n      expect(body.error.code).toBe('UNAUTHORIZED');\r\n      expect(body.error.message).toContain('Invalid API key');\r\n      expect(body.request_id).toBe('test-request-id');\r\n    });\r\n  });\r\n\r\n  describe('クエリパラメータのバリデーション', () => {\r\n    it('企業コードでフィルタリング', async () => {\r\n      mockEvent.queryStringParameters = {\r\n        company_code: '7203',\r\n      };\r\n\r\n      (queryDisclosures.queryDisclosures as jest.Mock).mockResolvedValue({\r\n        disclosures: [],\r\n        total: 0,\r\n        count: 0,\r\n        offset: 0,\r\n        limit: 100,\r\n      });\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(200);\r\n      expect(queryDisclosures.queryDisclosures).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          company_code: '7203',\r\n        })\r\n      );\r\n    });\r\n\r\n    it('日付範囲でフィルタリング', async () => {\r\n      mockEvent.queryStringParameters = {\r\n        start_date: '2024-01-15',\r\n        end_date: '2024-01-20',\r\n      };\r\n\r\n      (queryDisclosures.queryDisclosures as jest.Mock).mockResolvedValue({\r\n        disclosures: [],\r\n        total: 0,\r\n        count: 0,\r\n        offset: 0,\r\n        limit: 100,\r\n      });\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(200);\r\n      expect(queryDisclosures.queryDisclosures).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          start_date: '2024-01-15',\r\n          end_date: '2024-01-20',\r\n        })\r\n      );\r\n    });\r\n\r\n    it('不正な企業コード形式でバリデーションエラー', async () => {\r\n      mockEvent.queryStringParameters = {\r\n        company_code: '123', // 4桁でない\r\n      };\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(400);\r\n      const body = JSON.parse(result.body);\r\n      expect(body.status).toBe('error');\r\n      expect(body.error.code).toBe('VALIDATION_ERROR');\r\n      expect(body.error.message).toContain('Invalid company_code');\r\n      expect(body.request_id).toBe('test-request-id');\r\n    });\r\n\r\n    it('不正な日付形式でバリデーションエラー', async () => {\r\n      mockEvent.queryStringParameters = {\r\n        start_date: '2024/01/15', // YYYY-MM-DD形式でない\r\n      };\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(400);\r\n      const body = JSON.parse(result.body);\r\n      expect(body.status).toBe('error');\r\n      expect(body.error.code).toBe('VALIDATION_ERROR');\r\n      expect(body.error.message).toContain('Invalid start_date format');\r\n      expect(body.request_id).toBe('test-request-id');\r\n    });\r\n\r\n    it('存在しない日付でバリデーションエラー', async () => {\r\n      mockEvent.queryStringParameters = {\r\n        start_date: '2024-02-30', // 存在しない日付\r\n      };\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(400);\r\n      const body = JSON.parse(result.body);\r\n      expect(body.status).toBe('error');\r\n      expect(body.error.code).toBe('VALIDATION_ERROR');\r\n      expect(body.error.message).toContain('Date does not exist');\r\n      expect(body.request_id).toBe('test-request-id');\r\n    });\r\n\r\n    it('開始日が終了日より後の場合はバリデーションエラー（Property 8）', async () => {\r\n      mockEvent.queryStringParameters = {\r\n        start_date: '2024-01-20',\r\n        end_date: '2024-01-15',\r\n      };\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(400);\r\n      const body = JSON.parse(result.body);\r\n      expect(body.status).toBe('error');\r\n      expect(body.error.code).toBe('VALIDATION_ERROR');\r\n      expect(body.error.message).toContain('start_date');\r\n      expect(body.error.message).toContain('must be before or equal to');\r\n      expect(body.error.message).toContain('end_date');\r\n      expect(body.request_id).toBe('test-request-id');\r\n    });\r\n\r\n    it('limitのバリデーション（範囲内）', async () => {\r\n      mockEvent.queryStringParameters = {\r\n        limit: '50',\r\n      };\r\n\r\n      (queryDisclosures.queryDisclosures as jest.Mock).mockResolvedValue({\r\n        disclosures: [],\r\n        total: 0,\r\n        count: 0,\r\n        offset: 0,\r\n        limit: 50,\r\n      });\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(200);\r\n      expect(queryDisclosures.queryDisclosures).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          limit: 50,\r\n        })\r\n      );\r\n    });\r\n\r\n    it('limitが範囲外の場合はバリデーションエラー', async () => {\r\n      mockEvent.queryStringParameters = {\r\n        limit: '2000', // 最大1000を超える\r\n      };\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(400);\r\n      const body = JSON.parse(result.body);\r\n      expect(body.status).toBe('error');\r\n      expect(body.error.code).toBe('VALIDATION_ERROR');\r\n      expect(body.error.message).toContain('Invalid limit');\r\n      expect(body.request_id).toBe('test-request-id');\r\n    });\r\n\r\n    it('offsetのバリデーション', async () => {\r\n      mockEvent.queryStringParameters = {\r\n        offset: '100',\r\n      };\r\n\r\n      (queryDisclosures.queryDisclosures as jest.Mock).mockResolvedValue({\r\n        disclosures: [],\r\n        total: 0,\r\n        count: 0,\r\n        offset: 100,\r\n        limit: 100,\r\n      });\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(200);\r\n      expect(queryDisclosures.queryDisclosures).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          offset: 100,\r\n        })\r\n      );\r\n    });\r\n\r\n    it('offsetが負の数の場合はバリデーションエラー', async () => {\r\n      mockEvent.queryStringParameters = {\r\n        offset: '-10',\r\n      };\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(400);\r\n      const body = JSON.parse(result.body);\r\n      expect(body.status).toBe('error');\r\n      expect(body.error.code).toBe('VALIDATION_ERROR');\r\n      expect(body.error.message).toContain('Invalid offset');\r\n      expect(body.request_id).toBe('test-request-id');\r\n    });\r\n  });\r\n\r\n  describe('レスポンス形式', () => {\r\n    it('JSON形式（デフォルト）', async () => {\r\n      const mockDisclosures: Disclosure[] = [\r\n        {\r\n          disclosure_id: 'TD20240115001',\r\n          company_code: '7203',\r\n          company_name: 'トヨタ自動車',\r\n          disclosure_type: '決算短信',\r\n          title: '2024年3月期 第3四半期決算短信',\r\n          disclosed_at: '2024-01-15T10:30:00Z',\r\n          pdf_url: 'https://www.release.tdnet.info/...',\r\n          s3_key: '2024/01/15/TD20240115001_7203.pdf',\r\n          collected_at: '2024-01-15T10:35:00Z',\r\n          date_partition: '2024-01',\r\n        },\r\n      ];\r\n\r\n      (queryDisclosures.queryDisclosures as jest.Mock).mockResolvedValue({\r\n        disclosures: mockDisclosures,\r\n        total: 1,\r\n        count: 1,\r\n        offset: 0,\r\n        limit: 100,\r\n      });\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(200);\r\n      expect(result.headers['Content-Type']).toBe('application/json');\r\n      expect(JSON.parse(result.body)).toEqual({\r\n        disclosures: mockDisclosures,\r\n        total: 1,\r\n        count: 1,\r\n        offset: 0,\r\n        limit: 100,\r\n      });\r\n    });\r\n\r\n    it('CSV形式', async () => {\r\n      mockEvent.queryStringParameters = {\r\n        format: 'csv',\r\n      };\r\n\r\n      const mockDisclosures: Disclosure[] = [\r\n        {\r\n          disclosure_id: 'TD20240115001',\r\n          company_code: '7203',\r\n          company_name: 'トヨタ自動車',\r\n          disclosure_type: '決算短信',\r\n          title: '2024年3月期 第3四半期決算短信',\r\n          disclosed_at: '2024-01-15T10:30:00Z',\r\n          pdf_url: 'https://www.release.tdnet.info/...',\r\n          s3_key: '2024/01/15/TD20240115001_7203.pdf',\r\n          collected_at: '2024-01-15T10:35:00Z',\r\n          date_partition: '2024-01',\r\n        },\r\n      ];\r\n\r\n      (queryDisclosures.queryDisclosures as jest.Mock).mockResolvedValue({\r\n        disclosures: mockDisclosures,\r\n        total: 1,\r\n        count: 1,\r\n        offset: 0,\r\n        limit: 100,\r\n      });\r\n\r\n      (formatCsv.formatAsCsv as jest.Mock).mockReturnValue(\r\n        'disclosure_id,company_code,company_name,...\\nTD20240115001,7203,トヨタ自動車,...'\r\n      );\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(200);\r\n      expect(result.headers['Content-Type']).toBe('text/csv');\r\n      expect(result.headers['Content-Disposition']).toContain('attachment');\r\n      expect(result.body).toContain('disclosure_id,company_code');\r\n    });\r\n\r\n    it('不正なフォーマット指定でバリデーションエラー', async () => {\r\n      mockEvent.queryStringParameters = {\r\n        format: 'xml', // サポートされていない形式\r\n      };\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(400);\r\n      const body = JSON.parse(result.body);\r\n      expect(body.status).toBe('error');\r\n      expect(body.error.code).toBe('VALIDATION_ERROR');\r\n      expect(body.error.message).toContain('Invalid format');\r\n      expect(body.request_id).toBe('test-request-id');\r\n    });\r\n  });\r\n\r\n  describe('CORS対応', () => {\r\n    it('すべてのレスポンスにCORSヘッダーが含まれる', async () => {\r\n      (queryDisclosures.queryDisclosures as jest.Mock).mockResolvedValue({\r\n        disclosures: [],\r\n        total: 0,\r\n        count: 0,\r\n        offset: 0,\r\n        limit: 100,\r\n      });\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.headers['Access-Control-Allow-Origin']).toBe('*');\r\n    });\r\n\r\n    it('エラーレスポンスにもCORSヘッダーが含まれる', async () => {\r\n      mockEvent.headers = {}; // APIキーなし\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(401);\r\n      expect(result.headers['Access-Control-Allow-Origin']).toBe('*');\r\n    });\r\n  });\r\n\r\n  describe('エラーハンドリング', () => {\r\n    it('内部エラーは500エラーとして返却', async () => {\r\n      (queryDisclosures.queryDisclosures as jest.Mock).mockRejectedValue(\r\n        new Error('Internal error')\r\n      );\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      expect(result.statusCode).toBe(500);\r\n      const body = JSON.parse(result.body);\r\n      expect(body.status).toBe('error');\r\n      expect(body.error.code).toBe('INTERNAL_ERROR');\r\n      expect(body.error.message).toBe('Internal error');\r\n      expect(body.request_id).toBe('test-request-id');\r\n    });\r\n\r\n    it('本番環境ではスタックトレースを含めない', async () => {\r\n      process.env.NODE_ENV = 'production';\r\n\r\n      (queryDisclosures.queryDisclosures as jest.Mock).mockRejectedValue(\r\n        new Error('Internal error')\r\n      );\r\n\r\n      const result = await handler(mockEvent, mockContext);\r\n\r\n      const body = JSON.parse(result.body);\r\n      expect(body.error.stack).toBeUndefined();\r\n\r\n      delete process.env.NODE_ENV;\r\n    });\r\n  });\r\n});\r\n"],"version":3}