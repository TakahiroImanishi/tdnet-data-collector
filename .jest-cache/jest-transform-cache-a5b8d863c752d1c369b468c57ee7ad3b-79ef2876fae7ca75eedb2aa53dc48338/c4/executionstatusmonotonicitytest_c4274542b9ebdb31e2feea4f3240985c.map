{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\__tests__\\execution-status.monotonicity.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\__tests__\\execution-status.monotonicity.test.ts"],"sourcesContent":["/**\r\n * 実行状態の進捗単調性テスト\r\n *\r\n * Property 11: 実行状態の進捗単調性\r\n * Validates: Requirements 5.4\r\n *\r\n * 進捗率が単調増加（0 → 100）し、減少しないことを検証します。\r\n */\r\n\r\nimport { DynamoDBClient, PutItemCommand } from '@aws-sdk/client-dynamodb';\r\nimport { mockClient } from 'aws-sdk-client-mock';\r\nimport * as fc from 'fast-check';\r\nimport { updateExecutionStatus } from '../update-execution-status';\r\n\r\nconst dynamoMock = mockClient(DynamoDBClient);\r\n\r\ndescribe('Property 11: 実行状態の進捗単調性', () => {\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n    dynamoMock.reset();\r\n    process.env.DYNAMODB_EXECUTIONS_TABLE = 'test-executions-table';\r\n  });\r\n\r\n  describe('ユニットテスト', () => {\r\n    it('進捗率が0から100まで単調増加する', async () => {\r\n      // Arrange\r\n      const execution_id = 'exec_test_001';\r\n      dynamoMock.on(PutItemCommand).resolves({});\r\n\r\n      // Act & Assert\r\n      await updateExecutionStatus(execution_id, 'pending', 0);\r\n      await updateExecutionStatus(execution_id, 'running', 25);\r\n      await updateExecutionStatus(execution_id, 'running', 50);\r\n      await updateExecutionStatus(execution_id, 'running', 75);\r\n      await updateExecutionStatus(execution_id, 'completed', 100);\r\n\r\n      // 5回の更新が行われた\r\n      expect(dynamoMock.calls()).toHaveLength(5);\r\n\r\n      // 各呼び出しで進捗率が増加していることを確認\r\n      const calls = dynamoMock.calls();\r\n      const progresses = calls.map(call => {\r\n        const input = call.args[0].input as any;\r\n        return parseInt(input.Item.progress.N);\r\n      });\r\n\r\n      // 進捗率が単調増加\r\n      for (let i = 1; i < progresses.length; i++) {\r\n        expect(progresses[i]).toBeGreaterThanOrEqual(progresses[i - 1]);\r\n      }\r\n    });\r\n\r\n    it('進捗率が100を超えない', async () => {\r\n      // Arrange\r\n      const execution_id = 'exec_test_002';\r\n      dynamoMock.on(PutItemCommand).resolves({});\r\n\r\n      // Act\r\n      await updateExecutionStatus(execution_id, 'completed', 150); // 100を超える値\r\n\r\n      // Assert\r\n      const call = dynamoMock.call(0);\r\n      const input = call.args[0].input as any;\r\n      expect(parseInt(input.Item.progress.N)).toBe(100); // 100に制限される\r\n    });\r\n\r\n    it('進捗率が0未満にならない', async () => {\r\n      // Arrange\r\n      const execution_id = 'exec_test_003';\r\n      dynamoMock.on(PutItemCommand).resolves({});\r\n\r\n      // Act\r\n      await updateExecutionStatus(execution_id, 'pending', -10); // 負の値\r\n\r\n      // Assert\r\n      const call = dynamoMock.call(0);\r\n      const input = call.args[0].input as any;\r\n      expect(parseInt(input.Item.progress.N)).toBe(0); // 0に制限される\r\n    });\r\n\r\n    it('ステータスがpending → running → completedの順に遷移する', async () => {\r\n      // Arrange\r\n      const execution_id = 'exec_test_004';\r\n      dynamoMock.on(PutItemCommand).resolves({});\r\n\r\n      // Act\r\n      await updateExecutionStatus(execution_id, 'pending', 0);\r\n      await updateExecutionStatus(execution_id, 'running', 50);\r\n      await updateExecutionStatus(execution_id, 'completed', 100);\r\n\r\n      // Assert\r\n      const calls = dynamoMock.calls();\r\n      const statuses = calls.map(call => {\r\n        const input = call.args[0].input as any;\r\n        return input.Item.status.S;\r\n      });\r\n\r\n      expect(statuses).toEqual(['pending', 'running', 'completed']);\r\n    });\r\n\r\n    it('失敗時にエラーメッセージが記録される', async () => {\r\n      // Arrange\r\n      const execution_id = 'exec_test_005';\r\n      const error_message = 'Network error occurred';\r\n      dynamoMock.on(PutItemCommand).resolves({});\r\n\r\n      // Act\r\n      await updateExecutionStatus(execution_id, 'failed', 50, 10, 5, error_message);\r\n\r\n      // Assert\r\n      const call = dynamoMock.call(0);\r\n      const input = call.args[0].input as any;\r\n      expect(input.Item.status.S).toBe('failed');\r\n      expect(input.Item.error_message.S).toBe(error_message);\r\n      expect(parseInt(input.Item.collected_count.N)).toBe(10);\r\n      expect(parseInt(input.Item.failed_count.N)).toBe(5);\r\n    });\r\n  });\r\n\r\n  describe('プロパティベーステスト', () => {\r\n    it('任意の進捗率シーケンスで単調性が保たれる', async () => {\r\n      await fc.assert(\r\n        fc.asyncProperty(\r\n          fc.array(fc.integer({ min: 0, max: 100 }), { minLength: 2, maxLength: 10 }),\r\n          async (progressValues) => {\r\n            // Arrange\r\n            dynamoMock.reset();\r\n            dynamoMock.on(PutItemCommand).resolves({});\r\n            const execution_id = `exec_test_${Math.random().toString(36).substring(7)}`;\r\n\r\n            // ソートして単調増加にする\r\n            const sortedProgress = [...progressValues].sort((a, b) => a - b);\r\n\r\n            // Act\r\n            for (const progress of sortedProgress) {\r\n              const status = progress === 0 ? 'pending' : progress === 100 ? 'completed' : 'running';\r\n              await updateExecutionStatus(execution_id, status, progress);\r\n            }\r\n\r\n            // Assert\r\n            const calls = dynamoMock.calls();\r\n            const progresses = calls.map(call => {\r\n              const input = call.args[0].input as any;\r\n              return parseInt(input.Item.progress.N);\r\n            });\r\n\r\n            // 進捗率が単調増加（または同じ値）\r\n            for (let i = 1; i < progresses.length; i++) {\r\n              expect(progresses[i]).toBeGreaterThanOrEqual(progresses[i - 1]);\r\n            }\r\n          }\r\n        ),\r\n        { numRuns: 100 } // 100回反復\r\n      );\r\n    });\r\n\r\n    it('任意の実行IDで進捗率が0-100の範囲内に収まる', async () => {\r\n      await fc.assert(\r\n        fc.asyncProperty(\r\n          fc.string({ minLength: 10, maxLength: 50 }),\r\n          fc.integer({ min: -1000, max: 1000 }), // 範囲外の値も含む\r\n          async (execution_id, progress) => {\r\n            // Arrange\r\n            dynamoMock.reset();\r\n            dynamoMock.on(PutItemCommand).resolves({});\r\n\r\n            // Act\r\n            await updateExecutionStatus(execution_id, 'running', progress);\r\n\r\n            // Assert\r\n            const call = dynamoMock.call(0);\r\n            const input = call.args[0].input as any;\r\n            const actualProgress = parseInt(input.Item.progress.N);\r\n\r\n            // 進捗率が0-100の範囲内\r\n            expect(actualProgress).toBeGreaterThanOrEqual(0);\r\n            expect(actualProgress).toBeLessThanOrEqual(100);\r\n          }\r\n        ),\r\n        { numRuns: 100 } // 100回反復\r\n      );\r\n    });\r\n  });\r\n});\r\n"],"version":3}