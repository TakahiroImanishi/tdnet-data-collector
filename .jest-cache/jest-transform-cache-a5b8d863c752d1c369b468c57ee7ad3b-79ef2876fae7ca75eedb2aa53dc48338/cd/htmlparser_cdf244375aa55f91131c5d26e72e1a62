78d3dfc3d7380f19ca651b51f08e094c
"use strict";
/**
 * TDnet HTMLパーサー
 *
 * TDnet開示情報リストページのHTMLをパースし、メタデータを抽出します。
 *
 * Requirements: 要件1.1, 1.2（データ収集、メタデータ抽出）
 *
 * @example
 * ```typescript
 * import { RateLimiter } from '../utils/rate-limiter';
 * import { parseDisclosureList } from './html-parser';
 * import axios from 'axios';
 *
 * // RateLimiterを使用してTDnetからHTMLを取得
 * const rateLimiter = new RateLimiter({ minDelayMs: 2000 });
 *
 * async function fetchAndParseDisclosures(date: string) {
 *   await rateLimiter.waitIfNeeded();
 *   const response = await axios.get(`https://www.release.tdnet.info/inbs/I_list_001_${date}.html`);
 *   return parseDisclosureList(response.data);
 * }
 * ```
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.parseDisclosureList = parseDisclosureList;
const cheerio = __importStar(require("cheerio"));
const logger_1 = require("../utils/logger");
const errors_1 = require("../errors");
/**
 * TDnet開示情報リストページのHTMLをパース
 *
 * @param html HTMLコンテンツ
 * @returns 開示情報メタデータの配列
 * @throws ValidationError HTMLが不正な場合
 */
function parseDisclosureList(html) {
    try {
        // HTMLの基本検証
        if (!html || html.trim().length === 0) {
            throw new errors_1.ValidationError('HTML content is empty');
        }
        // cheerioでHTMLをロード
        const $ = cheerio.load(html);
        const disclosures = [];
        // HTML構造の検証（テーブルが存在するか）
        const tables = $('table.disclosure-list');
        if (tables.length === 0) {
            logger_1.logger.warn('No disclosure table found in HTML', {
                html_length: html.length,
                html_preview: html.substring(0, 200),
            });
            // HTML構造が変更された可能性を検知
            detectHtmlStructureChange($);
            return [];
        }
        // TDnetのテーブル構造に基づいてパース
        // 注: 実際のTDnetのHTML構造に合わせて調整が必要
        $('table.disclosure-list tr').each((index, element) => {
            if (index === 0)
                return; // ヘッダー行をスキップ
            const $row = $(element);
            const cells = $row.find('td');
            if (cells.length < 6) {
                logger_1.logger.warn('Invalid row structure', { index, cellCount: cells.length });
                return;
            }
            try {
                const disclosure = {
                    company_code: $(cells[0]).text().trim(),
                    company_name: $(cells[1]).text().trim(),
                    disclosure_type: $(cells[2]).text().trim(),
                    title: $(cells[3]).text().trim(),
                    disclosed_at: parseDisclosedAt($(cells[4]).text().trim()),
                    pdf_url: $(cells[5]).find('a').attr('href') || '',
                };
                // バリデーション
                validateDisclosureMetadata(disclosure);
                disclosures.push(disclosure);
            }
            catch (error) {
                logger_1.logger.error('Failed to parse disclosure row', {
                    error_type: error instanceof Error ? error.constructor.name : 'Unknown',
                    error_message: error instanceof Error ? error.message : String(error),
                    row_index: index,
                });
            }
        });
        logger_1.logger.info('HTML parsing completed', {
            total_rows: $('table.disclosure-list tr').length - 1, // ヘッダー行を除く
            parsed_disclosures: disclosures.length,
        });
        return disclosures;
    }
    catch (error) {
        logger_1.logger.error('Failed to parse HTML', {
            error_type: error instanceof Error ? error.constructor.name : 'Unknown',
            error_message: error instanceof Error ? error.message : String(error),
            html_length: html?.length || 0,
        });
        throw error;
    }
}
/**
 * 開示日時をISO 8601形式（UTC）に変換
 *
 * @param dateStr 日時文字列（例: "2024/01/15 10:30"）
 * @returns ISO 8601形式の日時文字列
 */
function parseDisclosedAt(dateStr) {
    // TDnetの日時形式（JST）をUTCに変換
    // 例: "2024/01/15 10:30" → "2024-01-15T01:30:00Z"
    const match = dateStr.match(/(\d{4})\/(\d{2})\/(\d{2})\s+(\d{2}):(\d{2})/);
    if (!match) {
        throw new errors_1.ValidationError(`Invalid date format: ${dateStr}`);
    }
    const [, year, month, day, hour, minute] = match;
    const jstDate = new Date(`${year}-${month}-${day}T${hour}:${minute}:00+09:00`);
    return jstDate.toISOString();
}
/**
 * 開示情報メタデータのバリデーション
 *
 * @param disclosure 開示情報メタデータ
 * @throws ValidationError バリデーションエラー
 */
function validateDisclosureMetadata(disclosure) {
    if (!disclosure.company_code || !/^\d{4}$/.test(disclosure.company_code)) {
        throw new errors_1.ValidationError(`Invalid company_code: ${disclosure.company_code}`);
    }
    if (!disclosure.company_name) {
        throw new errors_1.ValidationError('company_name is required');
    }
    if (!disclosure.disclosure_type) {
        throw new errors_1.ValidationError('disclosure_type is required');
    }
    if (!disclosure.title) {
        throw new errors_1.ValidationError('title is required');
    }
    if (!disclosure.disclosed_at) {
        throw new errors_1.ValidationError('disclosed_at is required');
    }
    if (!disclosure.pdf_url || !disclosure.pdf_url.startsWith('http')) {
        throw new errors_1.ValidationError(`Invalid pdf_url: ${disclosure.pdf_url}`);
    }
}
/**
 * HTML構造の変更を検知
 *
 * TDnetのHTML構造が変更された場合を検知し、ログに記録する。
 * steeringファイル（development/tdnet-scraping-patterns.md）の要件に準拠。
 *
 * @param $ cheerioインスタンス
 * @returns HTML構造が変更されている場合はtrue
 */
function detectHtmlStructureChange($) {
    const expectedSelectors = [
        'table.disclosure-list',
        'table.disclosure-list tr',
        'table.disclosure-list td',
    ];
    let structureChanged = false;
    for (const selector of expectedSelectors) {
        if ($(selector).length === 0) {
            logger_1.logger.error('HTML structure changed: selector not found', {
                selector,
                error_type: 'HtmlStructureChangeDetected',
            });
            structureChanged = true;
        }
    }
    if (structureChanged) {
        logger_1.logger.error('TDnet HTML structure has changed', {
            error_type: 'HtmlStructureChangeDetected',
            message: 'Expected HTML selectors not found. TDnet may have updated their website structure.',
            action_required: 'Update html-parser.ts to match new HTML structure',
        });
    }
    return structureChanged;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxzY3JhcGVyXFxodG1sLXBhcnNlci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FzQkc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBeUJILGtEQXlFQztBQWhHRCxpREFBbUM7QUFDbkMsNENBQXlDO0FBQ3pDLHNDQUE0QztBQWM1Qzs7Ozs7O0dBTUc7QUFDSCxTQUFnQixtQkFBbUIsQ0FBQyxJQUFZO0lBQzlDLElBQUksQ0FBQztRQUNILFlBQVk7UUFDWixJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDdEMsTUFBTSxJQUFJLHdCQUFlLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUNyRCxDQUFDO1FBRUQsbUJBQW1CO1FBQ25CLE1BQU0sQ0FBQyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0IsTUFBTSxXQUFXLEdBQXlCLEVBQUUsQ0FBQztRQUU3Qyx3QkFBd0I7UUFDeEIsTUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDMUMsSUFBSSxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ3hCLGVBQU0sQ0FBQyxJQUFJLENBQUMsbUNBQW1DLEVBQUU7Z0JBQy9DLFdBQVcsRUFBRSxJQUFJLENBQUMsTUFBTTtnQkFDeEIsWUFBWSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQzthQUNyQyxDQUFDLENBQUM7WUFDSCxxQkFBcUI7WUFDckIseUJBQXlCLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDN0IsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDO1FBRUQsdUJBQXVCO1FBQ3ZCLCtCQUErQjtRQUMvQixDQUFDLENBQUMsMEJBQTBCLENBQUMsQ0FBQyxJ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QUFvRjtZQUM3RixlQUFlLEVBQUUsbURBQW1EO1NBQ3JFLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxPQUFPLGdCQUFnQixDQUFDO0FBQzFCLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxzY3JhcGVyXFxodG1sLXBhcnNlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogVERuZXQgSFRNTOODkeODvOOCteODvFxyXG4gKlxyXG4gKiBURG5ldOmWi+ekuuaDheWgseODquOCueODiOODmuODvOOCuOOBrkhUTUzjgpLjg5Hjg7zjgrnjgZfjgIHjg6Hjgr/jg4fjg7zjgr/jgpLmir3lh7rjgZfjgb7jgZnjgIJcclxuICpcclxuICogUmVxdWlyZW1lbnRzOiDopoHku7YxLjEsIDEuMu+8iOODh+ODvOOCv+WPjumbhuOAgeODoeOCv+ODh+ODvOOCv+aKveWHuu+8iVxyXG4gKiBcclxuICogQGV4YW1wbGVcclxuICogYGBgdHlwZXNjcmlwdFxyXG4gKiBpbXBvcnQgeyBSYXRlTGltaXRlciB9IGZyb20gJy4uL3V0aWxzL3JhdGUtbGltaXRlcic7XHJcbiAqIGltcG9ydCB7IHBhcnNlRGlzY2xvc3VyZUxpc3QgfSBmcm9tICcuL2h0bWwtcGFyc2VyJztcclxuICogaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcclxuICogXHJcbiAqIC8vIFJhdGVMaW1pdGVy44KS5L2/55So44GX44GmVERuZXTjgYvjgolIVE1M44KS5Y+W5b6XXHJcbiAqIGNvbnN0IHJhdGVMaW1pdGVyID0gbmV3IFJhdGVMaW1pdGVyKHsgbWluRGVsYXlNczogMjAwMCB9KTtcclxuICogXHJcbiAqIGFzeW5jIGZ1bmN0aW9uIGZldGNoQW5kUGFyc2VEaXNjbG9zdXJlcyhkYXRlOiBzdHJpbmcpIHtcclxuICogICBhd2FpdCByYXRlTGltaXRlci53YWl0SWZOZWVkZWQoKTtcclxuICogICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGF4aW9zLmdldChgaHR0cHM6Ly93d3cucmVsZWFzZS50ZG5ldC5pbmZvL2luYnMvSV9saXN0XzAwMV8ke2RhdGV9Lmh0bWxgKTtcclxuICogICByZXR1cm4gcGFyc2VEaXNjbG9zdXJlTGlzdChyZXNwb25zZS5kYXRhKTtcclxuICogfVxyXG4gKiBgYGBcclxuICovXHJcblxyXG5pbXBvcnQgKiBhcyBjaGVlcmlvIGZyb20gJ2NoZWVyaW8nO1xyXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xyXG5pbXBvcnQgeyBWYWxpZGF0aW9uRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMnO1xyXG5cclxuLyoqXHJcbiAqIOmWi+ekuuaDheWgseODoeOCv+ODh+ODvOOCv1xyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBEaXNjbG9zdXJlTWV0YWRhdGEge1xyXG4gIGNvbXBhbnlfY29kZTogc3RyaW5nO1xyXG4gIGNvbXBhbnlfbmFtZTogc3RyaW5nO1xyXG4gIGRpc2Nsb3N1cmVfdHlwZTogc3RyaW5nO1xyXG4gIHRpdGxlOiBzdHJpbmc7XHJcbiAgZGlzY2xvc2VkX2F0OiBzdHJpbmc7IC8vIElTTyA4NjAx5b2i5byP77yIVVRD77yJXHJcbiAgcGRmX3VybDogc3RyaW5nO1xyXG59XHJcblxyXG4vKipcclxuICogVERuZXTplovnpLrmg4XloLHjg6rjgrnjg4jjg5rjg7zjgrjjga5IVE1M44KS44OR44O844K5XHJcbiAqXHJcbiAqIEBwYXJhbSBodG1sIEhUTUzjgrPjg7Pjg4bjg7Pjg4RcclxuICogQHJldHVybnMg6ZaL56S65oOF5aCx44Oh44K/44OH44O844K/44Gu6YWN5YiXXHJcbiAqIEB0aHJvd3MgVmFsaWRhdGlvbkVycm9yIEhUTUzjgYzkuI3mraPjgarloLTlkIhcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBwYXJzZURpc2Nsb3N1cmVMaXN0KGh0bWw6IHN0cmluZyk6IERpc2Nsb3N1cmVNZXRhZGF0YVtdIHtcclxuICB0cnkge1xyXG4gICAgLy8gSFRNTOOBruWfuuacrOaknOiovFxyXG4gICAgaWYgKCFodG1sIHx8IGh0bWwudHJpbSgpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdIVE1MIGNvbnRlbnQgaXMgZW1wdHknKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBjaGVlcmlv44GnSFRNTOOCkuODreODvOODiVxyXG4gICAgY29uc3QgJCA9IGNoZWVyaW8ubG9hZChodG1sKTtcclxuICAgIGNvbnN0IGRpc2Nsb3N1cmVzOiBEaXNjbG9zdXJlTWV0YWRhdGFbXSA9IFtdO1xyXG5cclxuICAgIC8vIEhUTUzmp4vpgKDjga7mpJzoqLzvvIjjg4bjg7zjg5bjg6vjgYzlrZjlnKjjgZnjgovjgYvvvIlcclxuICAgIGNvbnN0IHRhYmxlcyA9ICQoJ3RhYmxlLmRpc2Nsb3N1cmUtbGlzdCcpO1xyXG4gICAgaWYgKHRhYmxlcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgbG9nZ2VyLndhcm4oJ05vIGRpc2Nsb3N1cmUgdGFibGUgZm91bmQgaW4gSFRNTCcsIHtcclxuICAgICAgICBodG1sX2xlbmd0aDogaHRtbC5sZW5ndGgsXHJcbiAgICAgICAgaHRtbF9wcmV2aWV3OiBodG1sLnN1YnN0cmluZygwLCAyMDApLFxyXG4gICAgICB9KTtcclxuICAgICAgLy8gSFRNTOani+mAoOOBjOWkieabtOOBleOCjOOBn+WPr+iDveaAp+OCkuaknOefpVxyXG4gICAgICBkZXRlY3RIdG1sU3RydWN0dXJlQ2hhbmdlKCQpO1xyXG4gICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVERuZXTjga7jg4bjg7zjg5bjg6vmp4vpgKDjgavln7rjgaXjgYTjgabjg5Hjg7zjgrlcclxuICAgIC8vIOazqDog5a6f6Zqb44GuVERuZXTjga5IVE1M5qeL6YCg44Gr5ZCI44KP44Gb44Gm6Kq/5pW044GM5b+F6KaBXHJcbiAgICAkKCd0YWJsZS5kaXNjbG9zdXJlLWxpc3QgdHInKS5lYWNoKChpbmRleCwgZWxlbWVudCkgPT4ge1xyXG4gICAgICBpZiAoaW5kZXggPT09IDApIHJldHVybjsgLy8g44OY44OD44OA44O86KGM44KS44K544Kt44OD44OXXHJcblxyXG4gICAgICBjb25zdCAkcm93ID0gJChlbGVtZW50KTtcclxuICAgICAgY29uc3QgY2VsbHMgPSAkcm93LmZpbmQoJ3RkJyk7XHJcblxyXG4gICAgICBpZiAoY2VsbHMubGVuZ3RoIDwgNikge1xyXG4gICAgICAgIGxvZ2dlci53YXJuKCdJbnZhbGlkIHJvdyBzdHJ1Y3R1cmUnLCB7IGluZGV4LCBjZWxsQ291bnQ6IGNlbGxzLmxlbmd0aCB9KTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgZGlzY2xvc3VyZTogRGlzY2xvc3VyZU1ldGFkYXRhID0ge1xyXG4gICAgICAgICAgY29tcGFueV9jb2RlOiAkKGNlbGxzWzBdKS50ZXh0KCkudHJpbSgpLFxyXG4gICAgICAgICAgY29tcGFueV9uYW1lOiAkKGNlbGxzWzFdKS50ZXh0KCkudHJpbSgpLFxyXG4gICAgICAgICAgZGlzY2xvc3VyZV90eXBlOiAkKGNlbGxzWzJdKS50ZXh0KCkudHJpbSgpLFxyXG4gICAgICAgICAgdGl0bGU6ICQoY2VsbHNbM10pLnRleHQoKS50cmltKCksXHJcbiAgICAgICAgICBkaXNjbG9zZWRfYXQ6IHBhcnNlRGlzY2xvc2VkQXQoJChjZWxsc1s0XSkudGV4dCgpLnRyaW0oKSksXHJcbiAgICAgICAgICBwZGZfdXJsOiAkKGNlbGxzWzVdKS5maW5kKCdhJykuYXR0cignaHJlZicpIHx8ICcnLFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vIOODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gICAgICAgIHZhbGlkYXRlRGlzY2xvc3VyZU1ldGFkYXRhKGRpc2Nsb3N1cmUpO1xyXG5cclxuICAgICAgICBkaXNjbG9zdXJlcy5wdXNoKGRpc2Nsb3N1cmUpO1xyXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIHBhcnNlIGRpc2Nsb3N1cmUgcm93Jywge1xyXG4gICAgICAgICAgZXJyb3JfdHlwZTogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLmNvbnN0cnVjdG9yLm5hbWUgOiAnVW5rbm93bicsXHJcbiAgICAgICAgICBlcnJvcl9tZXNzYWdlOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXHJcbiAgICAgICAgICByb3dfaW5kZXg6IGluZGV4LFxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBsb2dnZXIuaW5mbygnSFRNTCBwYXJzaW5nIGNvbXBsZXRlZCcsIHtcclxuICAgICAgdG90YWxfcm93czogJCgndGFibGUuZGlzY2xvc3VyZS1saXN0IHRyJykubGVuZ3RoIC0gMSwgLy8g44OY44OD44OA44O86KGM44KS6Zmk44GPXHJcbiAgICAgIHBhcnNlZF9kaXNjbG9zdXJlczogZGlzY2xvc3VyZXMubGVuZ3RoLFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGRpc2Nsb3N1cmVzO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBwYXJzZSBIVE1MJywge1xyXG4gICAgICBlcnJvcl90eXBlOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IuY29uc3RydWN0b3IubmFtZSA6ICdVbmtub3duJyxcclxuICAgICAgZXJyb3JfbWVzc2FnZTogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxyXG4gICAgICBodG1sX2xlbmd0aDogaHRtbD8ubGVuZ3RoIHx8IDAsXHJcbiAgICB9KTtcclxuICAgIHRocm93IGVycm9yO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOmWi+ekuuaXpeaZguOCkklTTyA4NjAx5b2i5byP77yIVVRD77yJ44Gr5aSJ5o+bXHJcbiAqXHJcbiAqIEBwYXJhbSBkYXRlU3RyIOaXpeaZguaWh+Wtl+WIl++8iOS+izogXCIyMDI0LzAxLzE1IDEwOjMwXCLvvIlcclxuICogQHJldHVybnMgSVNPIDg2MDHlvaLlvI/jga7ml6XmmYLmloflrZfliJdcclxuICovXHJcbmZ1bmN0aW9uIHBhcnNlRGlzY2xvc2VkQXQoZGF0ZVN0cjogc3RyaW5nKTogc3RyaW5nIHtcclxuICAvLyBURG5ldOOBruaXpeaZguW9ouW8j++8iEpTVO+8ieOCklVUQ+OBq+WkieaPm1xyXG4gIC8vIOS+izogXCIyMDI0LzAxLzE1IDEwOjMwXCIg4oaSIFwiMjAyNC0wMS0xNVQwMTozMDowMFpcIlxyXG4gIGNvbnN0IG1hdGNoID0gZGF0ZVN0ci5tYXRjaCgvKFxcZHs0fSlcXC8oXFxkezJ9KVxcLyhcXGR7Mn0pXFxzKyhcXGR7Mn0pOihcXGR7Mn0pLyk7XHJcbiAgaWYgKCFtYXRjaCkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihgSW52YWxpZCBkYXRlIGZvcm1hdDogJHtkYXRlU3RyfWApO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgWywgeWVhciwgbW9udGgsIGRheSwgaG91ciwgbWludXRlXSA9IG1hdGNoO1xyXG4gIGNvbnN0IGpzdERhdGUgPSBuZXcgRGF0ZShgJHt5ZWFyfS0ke21vbnRofS0ke2RheX1UJHtob3VyfToke21pbnV0ZX06MDArMDk6MDBgKTtcclxuICByZXR1cm4ganN0RGF0ZS50b0lTT1N0cmluZygpO1xyXG59XHJcblxyXG4vKipcclxuICog6ZaL56S65oOF5aCx44Oh44K/44OH44O844K/44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAqXHJcbiAqIEBwYXJhbSBkaXNjbG9zdXJlIOmWi+ekuuaDheWgseODoeOCv+ODh+ODvOOCv1xyXG4gKiBAdGhyb3dzIFZhbGlkYXRpb25FcnJvciDjg5Djg6rjg4fjg7zjgrfjg6fjg7Pjgqjjg6njg7xcclxuICovXHJcbmZ1bmN0aW9uIHZhbGlkYXRlRGlzY2xvc3VyZU1ldGFkYXRhKGRpc2Nsb3N1cmU6IERpc2Nsb3N1cmVNZXRhZGF0YSk6IHZvaWQge1xyXG4gIGlmICghZGlzY2xvc3VyZS5jb21wYW55X2NvZGUgfHwgIS9eXFxkezR9JC8udGVzdChkaXNjbG9zdXJlLmNvbXBhbnlfY29kZSkpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoYEludmFsaWQgY29tcGFueV9jb2RlOiAke2Rpc2Nsb3N1cmUuY29tcGFueV9jb2RlfWApO1xyXG4gIH1cclxuXHJcbiAgaWYgKCFkaXNjbG9zdXJlLmNvbXBhbnlfbmFtZSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignY29tcGFueV9uYW1lIGlzIHJlcXVpcmVkJyk7XHJcbiAgfVxyXG5cclxuICBpZiAoIWRpc2Nsb3N1cmUuZGlzY2xvc3VyZV90eXBlKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdkaXNjbG9zdXJlX3R5cGUgaXMgcmVxdWlyZWQnKTtcclxuICB9XHJcblxyXG4gIGlmICghZGlzY2xvc3VyZS50aXRsZSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcigndGl0bGUgaXMgcmVxdWlyZWQnKTtcclxuICB9XHJcblxyXG4gIGlmICghZGlzY2xvc3VyZS5kaXNjbG9zZWRfYXQpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ2Rpc2Nsb3NlZF9hdCBpcyByZXF1aXJlZCcpO1xyXG4gIH1cclxuXHJcbiAgaWYgKCFkaXNjbG9zdXJlLnBkZl91cmwgfHwgIWRpc2Nsb3N1cmUucGRmX3VybC5zdGFydHNXaXRoKCdodHRwJykpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoYEludmFsaWQgcGRmX3VybDogJHtkaXNjbG9zdXJlLnBkZl91cmx9YCk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogSFRNTOani+mAoOOBruWkieabtOOCkuaknOefpVxyXG4gKlxyXG4gKiBURG5ldOOBrkhUTUzmp4vpgKDjgYzlpInmm7TjgZXjgozjgZ/loLTlkIjjgpLmpJznn6XjgZfjgIHjg63jgrDjgavoqJjpjLLjgZnjgovjgIJcclxuICogc3RlZXJpbmfjg5XjgqHjgqTjg6vvvIhkZXZlbG9wbWVudC90ZG5ldC1zY3JhcGluZy1wYXR0ZXJucy5tZO+8ieOBruimgeS7tuOBq+a6luaLoOOAglxyXG4gKlxyXG4gKiBAcGFyYW0gJCBjaGVlcmlv44Kk44Oz44K544K/44Oz44K5XHJcbiAqIEByZXR1cm5zIEhUTUzmp4vpgKDjgYzlpInmm7TjgZXjgozjgabjgYTjgovloLTlkIjjga90cnVlXHJcbiAqL1xyXG5mdW5jdGlvbiBkZXRlY3RIdG1sU3RydWN0dXJlQ2hhbmdlKCQ6IGNoZWVyaW8uQ2hlZXJpb0FQSSk6IGJvb2xlYW4ge1xyXG4gIGNvbnN0IGV4cGVjdGVkU2VsZWN0b3JzID0gW1xyXG4gICAgJ3RhYmxlLmRpc2Nsb3N1cmUtbGlzdCcsXHJcbiAgICAndGFibGUuZGlzY2xvc3VyZS1saXN0IHRyJyxcclxuICAgICd0YWJsZS5kaXNjbG9zdXJlLWxpc3QgdGQnLFxyXG4gIF07XHJcblxyXG4gIGxldCBzdHJ1Y3R1cmVDaGFuZ2VkID0gZmFsc2U7XHJcblxyXG4gIGZvciAoY29uc3Qgc2VsZWN0b3Igb2YgZXhwZWN0ZWRTZWxlY3RvcnMpIHtcclxuICAgIGlmICgkKHNlbGVjdG9yKS5sZW5ndGggPT09IDApIHtcclxuICAgICAgbG9nZ2VyLmVycm9yKCdIVE1MIHN0cnVjdHVyZSBjaGFuZ2VkOiBzZWxlY3RvciBub3QgZm91bmQnLCB7XHJcbiAgICAgICAgc2VsZWN0b3IsXHJcbiAgICAgICAgZXJyb3JfdHlwZTogJ0h0bWxTdHJ1Y3R1cmVDaGFuZ2VEZXRlY3RlZCcsXHJcbiAgICAgIH0pO1xyXG4gICAgICBzdHJ1Y3R1cmVDaGFuZ2VkID0gdHJ1ZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGlmIChzdHJ1Y3R1cmVDaGFuZ2VkKSB7XHJcbiAgICBsb2dnZXIuZXJyb3IoJ1REbmV0IEhUTUwgc3RydWN0dXJlIGhhcyBjaGFuZ2VkJywge1xyXG4gICAgICBlcnJvcl90eXBlOiAnSHRtbFN0cnVjdHVyZUNoYW5nZURldGVjdGVkJyxcclxuICAgICAgbWVzc2FnZTogJ0V4cGVjdGVkIEhUTUwgc2VsZWN0b3JzIG5vdCBmb3VuZC4gVERuZXQgbWF5IGhhdmUgdXBkYXRlZCB0aGVpciB3ZWJzaXRlIHN0cnVjdHVyZS4nLFxyXG4gICAgICBhY3Rpb25fcmVxdWlyZWQ6ICdVcGRhdGUgaHRtbC1wYXJzZXIudHMgdG8gbWF0Y2ggbmV3IEhUTUwgc3RydWN0dXJlJyxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHN0cnVjdHVyZUNoYW5nZWQ7XHJcbn1cclxuIl0sInZlcnNpb24iOjN9