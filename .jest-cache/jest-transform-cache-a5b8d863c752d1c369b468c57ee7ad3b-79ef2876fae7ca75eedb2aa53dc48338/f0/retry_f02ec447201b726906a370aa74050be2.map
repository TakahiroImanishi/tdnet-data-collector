{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\utils\\retry.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\utils\\retry.ts"],"sourcesContent":["/**\r\n * 再試行ロジック（指数バックオフ）\r\n *\r\n * 一時的なエラーに対して、指数バックオフアルゴリズムを使用した再試行を実行します。\r\n * ジッター（ランダム遅延）を追加することで、複数のクライアントが同時に再試行する際の\r\n * サンダリングハード問題を回避します。\r\n *\r\n * Requirements: 要件6.2（再試行ロジック）\r\n */\r\n\r\nimport { RetryableError } from '../errors';\r\n\r\n/**\r\n * 再試行オプション\r\n */\r\nexport interface RetryOptions {\r\n  /**\r\n   * 最大再試行回数（デフォルト: 3）\r\n   */\r\n  maxRetries: number;\r\n\r\n  /**\r\n   * 初期遅延時間（ミリ秒、デフォルト: 2000）\r\n   */\r\n  initialDelay: number;\r\n\r\n  /**\r\n   * バックオフ倍率（デフォルト: 2）\r\n   */\r\n  backoffMultiplier: number;\r\n\r\n  /**\r\n   * ジッター（ランダム遅延）を追加するか（デフォルト: true）\r\n   */\r\n  jitter: boolean;\r\n\r\n  /**\r\n   * カスタム再試行判定関数（オプション）\r\n   * エラーが再試行可能かどうかを判定します。\r\n   * 指定しない場合は、RetryableErrorのみ再試行します。\r\n   */\r\n  shouldRetry?: (error: Error) => boolean;\r\n}\r\n\r\n/**\r\n * デフォルトの再試行オプション\r\n */\r\nconst DEFAULT_RETRY_OPTIONS: RetryOptions = {\r\n  maxRetries: 3,\r\n  initialDelay: 2000,\r\n  backoffMultiplier: 2,\r\n  jitter: true,\r\n};\r\n\r\n/**\r\n * デフォルトの再試行判定関数\r\n * RetryableErrorのみ再試行します。\r\n */\r\nfunction defaultShouldRetry(error: Error): boolean {\r\n  return error instanceof RetryableError;\r\n}\r\n\r\n/**\r\n * 指数バックオフを使用した再試行ロジック\r\n *\r\n * @param operation 実行する非同期処理\r\n * @param options 再試行オプション\r\n * @returns 処理の結果\r\n * @throws 最大再試行回数に達した場合、または再試行不可能なエラーの場合\r\n *\r\n * @example\r\n * ```typescript\r\n * // 基本的な使用例\r\n * const result = await retryWithBackoff(\r\n *   async () => await fetchData(),\r\n *   {\r\n *     maxRetries: 3,\r\n *     initialDelay: 2000,\r\n *     backoffMultiplier: 2,\r\n *     jitter: true,\r\n *   }\r\n * );\r\n *\r\n * // カスタム再試行判定\r\n * const result = await retryWithBackoff(\r\n *   async () => await fetchData(),\r\n *   {\r\n *     maxRetries: 3,\r\n *     initialDelay: 1000,\r\n *     backoffMultiplier: 2,\r\n *     jitter: true,\r\n *     shouldRetry: (error) => {\r\n *       // ネットワークエラーのみ再試行\r\n *       return error.message.includes('ECONNRESET');\r\n *     },\r\n *   }\r\n * );\r\n * ```\r\n */\r\nexport async function retryWithBackoff<T>(\r\n  operation: () => Promise<T>,\r\n  options: Partial<RetryOptions> = {}\r\n): Promise<T> {\r\n  const opts: RetryOptions = { ...DEFAULT_RETRY_OPTIONS, ...options };\r\n  const shouldRetry = opts.shouldRetry || defaultShouldRetry;\r\n\r\n  let lastError: Error | undefined;\r\n  let attempt = 0;\r\n\r\n  while (attempt <= opts.maxRetries) {\r\n    try {\r\n      return await operation();\r\n    } catch (error) {\r\n      lastError = error instanceof Error ? error : new Error(String(error));\r\n\r\n      // 最大再試行回数に達した場合は、エラーをスロー\r\n      if (attempt >= opts.maxRetries) {\r\n        throw lastError;\r\n      }\r\n\r\n      // 再試行不可能なエラーの場合は、即座にスロー\r\n      if (!shouldRetry(lastError)) {\r\n        throw lastError;\r\n      }\r\n\r\n      // 遅延時間を計算（指数バックオフ）\r\n      const delay = calculateDelay(attempt, opts);\r\n\r\n      // 遅延後に再試行\r\n      await sleep(delay);\r\n      attempt++;\r\n    }\r\n  }\r\n\r\n  // この行には到達しないはずだが、TypeScriptの型チェックのために必要\r\n  throw lastError || new Error('Unexpected error in retryWithBackoff');\r\n}\r\n\r\n/**\r\n * 遅延時間を計算（指数バックオフ + ジッター）\r\n *\r\n * @param attempt 現在の試行回数（0から始まる）\r\n * @param options 再試行オプション\r\n * @returns 遅延時間（ミリ秒）\r\n */\r\nfunction calculateDelay(attempt: number, options: RetryOptions): number {\r\n  // 指数バックオフ: initialDelay * (backoffMultiplier ^ attempt)\r\n  const exponentialDelay =\r\n    options.initialDelay * Math.pow(options.backoffMultiplier, attempt);\r\n\r\n  // ジッターを追加（0〜exponentialDelayのランダム値）\r\n  if (options.jitter) {\r\n    return Math.random() * exponentialDelay;\r\n  }\r\n\r\n  return exponentialDelay;\r\n}\r\n\r\n/**\r\n * 指定時間スリープ\r\n *\r\n * @param ms スリープ時間（ミリ秒）\r\n */\r\nfunction sleep(ms: number): Promise<void> {\r\n  return new Promise((resolve) => setTimeout(resolve, ms));\r\n}\r\n\r\n/**\r\n * 再試行可能なエラーかどうかを判定するヘルパー関数\r\n *\r\n * @param error エラーオブジェクト\r\n * @returns 再試行可能な場合はtrue\r\n *\r\n * @example\r\n * ```typescript\r\n * try {\r\n *   await operation();\r\n * } catch (error) {\r\n *   if (isRetryableError(error)) {\r\n *     // 再試行ロジック\r\n *   } else {\r\n *     // 即座に失敗\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport function isRetryableError(error: unknown): boolean {\r\n  if (!(error instanceof Error)) {\r\n    return false;\r\n  }\r\n\r\n  // RetryableErrorまたはそのサブクラス\r\n  if (error instanceof RetryableError) {\r\n    return true;\r\n  }\r\n\r\n  // ネットワークエラー\r\n  const networkErrors = ['ECONNRESET', 'ETIMEDOUT', 'ENOTFOUND', 'ECONNREFUSED'];\r\n  if (networkErrors.some((code) => error.message.includes(code))) {\r\n    return true;\r\n  }\r\n\r\n  // HTTPタイムアウト\r\n  if (error.message.includes('timeout')) {\r\n    return true;\r\n  }\r\n\r\n  // AWS一時的エラー\r\n  const awsErrors = ['ThrottlingException', 'ServiceUnavailable', 'RequestTimeout'];\r\n  if (awsErrors.some((code) => error.message.includes(code))) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n"],"version":3}