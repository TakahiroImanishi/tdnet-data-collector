cdf39ae00be1a0bdfcd8191b6bc44185
"use strict";
/**
 * 実行状態管理機能
 *
 * Lambda Collectorの実行状態をDynamoDBに保存・更新します。
 * 進捗率の単調性を保証し、TTLによる自動削除をサポートします。
 *
 * Requirements: 要件5.4（実行状態管理）
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.updateExecutionStatus = updateExecutionStatus;
exports.getExecutionStatus = getExecutionStatus;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const util_dynamodb_1 = require("@aws-sdk/util-dynamodb");
const logger_1 = require("../../utils/logger");
// DynamoDBクライアントはグローバルスコープで初期化（再利用される）
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
// 環境変数は関数内で取得（テスト時の柔軟性のため）
function getDynamoExecutionsTable() {
    return process.env.DYNAMODB_EXECUTIONS_TABLE || 'tdnet_executions';
}
/**
 * 実行状態を作成または更新
 *
 * 進捗率は0-100の範囲に自動制限されます。
 * completed/failedステータスの場合、completed_atとTTLが自動設定されます。
 *
 * @param execution_id - 実行ID
 * @param status - ステータス
 * @param progress - 進捗率（0-100）
 * @param collected_count - 収集成功件数（デフォルト: 0）
 * @param failed_count - 収集失敗件数（デフォルト: 0）
 * @param error_message - エラーメッセージ（failedの場合のみ）
 * @returns 更新後の実行状態
 *
 * @example
 * ```typescript
 * // 実行開始
 * await updateExecutionStatus('exec_001', 'pending', 0);
 *
 * // 進捗更新
 * await updateExecutionStatus('exec_001', 'running', 50, 25, 0);
 *
 * // 完了
 * await updateExecutionStatus('exec_001', 'completed', 100, 50, 0);
 *
 * // 失敗
 * await updateExecutionStatus('exec_001', 'failed', 50, 25, 5, 'Network error');
 * ```
 */
async function updateExecutionStatus(execution_id, status, progress, collected_count = 0, failed_count = 0, error_message) {
    try {
        // 進捗率を0-100の範囲に制限
        const clampedProgress = Math.max(0, Math.min(100, progress));
        const now = new Date().toISOString();
        const isCompleted = status === 'completed' || status === 'failed';
        // TTL: 30日後（Unix timestamp）
        const ttl = isCompleted ? Math.floor(Date.now() / 1000) + 30 * 24 * 60 * 60 : undefined;
        const item = {
            execution_id,
            status,
            progress: clampedProgress,
            collected_count,
            failed_count,
            started_at: now,
            updated_at: now,
            ...(isCompleted ? { completed_at: now } : {}),
            ...(error_message ? { error_message } : {}),
            ...(ttl ? { ttl } : {}),
        };
        logger_1.logger.info('Updating execution status', {
            execution_id,
            status,
            progress: clampedProgress,
            collected_count,
            failed_count,
        });
        // DynamoDBに保存
        await dynamoClient.send(new client_dynamodb_1.PutItemCommand({
            TableName: getDynamoExecutionsTable(),
            Item: (0, util_dynamodb_1.marshall)(item, {
                removeUndefinedValues: true,
            }),
        }));
        logger_1.logger.info('Execution status updated successfully', {
            execution_id,
            status,
            progress: clampedProgress,
        });
        return item;
    }
    catch (error) {
        logger_1.logger.error('Failed to update execution status', {
            execution_id,
            status,
            progress,
            error_type: error instanceof Error ? error.constructor.name : 'Unknown',
            error_message: error instanceof Error ? error.message : String(error),
        });
        throw error;
    }
}
/**
 * 実行状態を取得
 *
 * @param execution_id - 実行ID
 * @returns 実行状態（存在しない場合はnull）
 *
 * @example
 * ```typescript
 * const status = await getExecutionStatus('exec_001');
 * if (status) {
 *   console.log(`Progress: ${status.progress}%`);
 * }
 * ```
 */
async function getExecutionStatus(execution_id) {
    try {
        const { GetItemCommand } = await Promise.resolve().then(() => __importStar(require('@aws-sdk/client-dynamodb')));
        const { unmarshall } = await Promise.resolve().then(() => __importStar(require('@aws-sdk/util-dynamodb')));
        const result = await dynamoClient.send(new GetItemCommand({
            TableName: getDynamoExecutionsTable(),
            Key: (0, util_dynamodb_1.marshall)({ execution_id }),
        }));
        if (!result.Item) {
            return null;
        }
        return unmarshall(result.Item);
    }
    catch (error) {
        logger_1.logger.error('Failed to get execution status', {
            execution_id,
            error_type: error instanceof Error ? error.constructor.name : 'Unknown',
            error_message: error instanceof Error ? error.message : String(error),
        });
        throw error;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGNvbGxlY3RvclxcdXBkYXRlLWV4ZWN1dGlvbi1zdGF0dXMudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7O0dBT0c7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBOEVILHNEQWtFQztBQWdCRCxnREEyQkM7QUF6TEQsOERBQTBFO0FBQzFFLDBEQUFrRDtBQUNsRCwrQ0FBNEM7QUFFNUMsdUNBQXVDO0FBQ3ZDLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUU1QywyQkFBMkI7QUFDM0IsU0FBUyx3QkFBd0I7SUFDL0IsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixJQUFJLGtCQUFrQixDQUFDO0FBQ3JFLENBQUM7QUFxQ0Q7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0E0Qkc7QUFDSSxLQUFLLFVBQVUscUJBQXFCLENBQ3pDLFlBQW9CLEVBQ3BCLE1BQWlDLEVBQ2pDLFFBQWdCLEVBQ2hCLGtCQUEwQixDQUFDLEVBQzNCLGVBQXVCLENBQUMsRUFDeEIsYUFBc0I7SUFFdEIsSUFBSSxDQUFDO1FBQ0gsa0JBQWtCO1FBQ2xCLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFFN0QsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNyQyxNQUFNLFdBQVcsR0FBRyxNQUFNLEtBQUssV0FBVyxJQUFJLE1BQU0sS0FBSyxRQUFRLENBQUM7UUFFbEUsNEJBQTRCO1FBQzVCLE1BQU0sR0FBRyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcs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Q0FBQyxDQUFDLENBQUMsU0FBUztZQUN2RSxhQUFhLEVBQUUsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztTQUN0RSxDQUFDLENBQUM7UUFDSCxNQUFNLEtBQUssQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcdGkxOThcXGludmVzdG1lbnRfYW5hbHlzaXNfb3BvcG9cXHNyY1xcbGFtYmRhXFxjb2xsZWN0b3JcXHVwZGF0ZS1leGVjdXRpb24tc3RhdHVzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiDlrp/ooYznirbmhYvnrqHnkIbmqZ/og71cclxuICpcclxuICogTGFtYmRhIENvbGxlY3RvcuOBruWun+ihjOeKtuaFi+OCkkR5bmFtb0RC44Gr5L+d5a2Y44O75pu05paw44GX44G+44GZ44CCXHJcbiAqIOmAsuaNl+eOh+OBruWNmOiqv+aAp+OCkuS/neiovOOBl+OAgVRUTOOBq+OCiOOCi+iHquWLleWJiumZpOOCkuOCteODneODvOODiOOBl+OBvuOBmeOAglxyXG4gKlxyXG4gKiBSZXF1aXJlbWVudHM6IOimgeS7tjUuNO+8iOWun+ihjOeKtuaFi+euoeeQhu+8iVxyXG4gKi9cclxuXHJcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50LCBQdXRJdGVtQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XHJcbmltcG9ydCB7IG1hcnNoYWxsIH0gZnJvbSAnQGF3cy1zZGsvdXRpbC1keW5hbW9kYic7XHJcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uLy4uL3V0aWxzL2xvZ2dlcic7XHJcblxyXG4vLyBEeW5hbW9EQuOCr+ODqeOCpOOCouODs+ODiOOBr+OCsOODreODvOODkOODq+OCueOCs+ODvOODl+OBp+WIneacn+WMlu+8iOWGjeWIqeeUqOOBleOCjOOCi++8iVxyXG5jb25zdCBkeW5hbW9DbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xyXG5cclxuLy8g55Kw5aKD5aSJ5pWw44Gv6Zai5pWw5YaF44Gn5Y+W5b6X77yI44OG44K544OI5pmC44Gu5p+U6Luf5oCn44Gu44Gf44KB77yJXHJcbmZ1bmN0aW9uIGdldER5bmFtb0V4ZWN1dGlvbnNUYWJsZSgpOiBzdHJpbmcge1xyXG4gIHJldHVybiBwcm9jZXNzLmVudi5EWU5BTU9EQl9FWEVDVVRJT05TX1RBQkxFIHx8ICd0ZG5ldF9leGVjdXRpb25zJztcclxufVxyXG5cclxuLyoqXHJcbiAqIOWun+ihjOeKtuaFi1xyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBFeGVjdXRpb25TdGF0dXMge1xyXG4gIC8qKiDlrp/ooYxJRCAqL1xyXG4gIGV4ZWN1dGlvbl9pZDogc3RyaW5nO1xyXG5cclxuICAvKiog44K544OG44O844K/44K5ICovXHJcbiAgc3RhdHVzOiAncGVuZGluZycgfCAncnVubmluZycgfCAnY29tcGxldGVkJyB8ICdmYWlsZWQnO1xyXG5cclxuICAvKiog6YCy5o2X546H77yIMC0xMDDvvIkgKi9cclxuICBwcm9ncmVzczogbnVtYmVyO1xyXG5cclxuICAvKiog5Y+O6ZuG5oiQ5Yqf5Lu25pWwICovXHJcbiAgY29sbGVjdGVkX2NvdW50OiBudW1iZXI7XHJcblxyXG4gIC8qKiDlj47pm4blpLHmlZfku7bmlbAgKi9cclxuICBmYWlsZWRfY291bnQ6IG51bWJlcjtcclxuXHJcbiAgLyoqIOmWi+Wni+aXpeaZgu+8iElTTyA4NjAx5b2i5byP77yJICovXHJcbiAgc3RhcnRlZF9hdDogc3RyaW5nO1xyXG5cclxuICAvKiog5pu05paw5pel5pmC77yISVNPIDg2MDHlvaLlvI/vvIkgKi9cclxuICB1cGRhdGVkX2F0OiBzdHJpbmc7XHJcblxyXG4gIC8qKiDlrozkuobml6XmmYLvvIhJU08gODYwMeW9ouW8j+OAgWNvbXBsZXRlZC9mYWlsZWTjga7loLTlkIjjga7jgb/vvIkgKi9cclxuICBjb21wbGV0ZWRfYXQ/OiBzdHJpbmc7XHJcblxyXG4gIC8qKiDjgqjjg6njg7zjg6Hjg4Pjgrvjg7zjgrjvvIhmYWlsZWTjga7loLTlkIjjga7jgb/vvIkgKi9cclxuICBlcnJvcl9tZXNzYWdlPzogc3RyaW5nO1xyXG5cclxuICAvKiogVFRM77yIMzDml6Xlvozjgavoh6rli5XliYrpmaTvvIkgKi9cclxuICB0dGw/OiBudW1iZXI7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDlrp/ooYznirbmhYvjgpLkvZzmiJDjgb7jgZ/jga/mm7TmlrBcclxuICpcclxuICog6YCy5o2X546H44GvMC0xMDDjga7nr4Tlm7Ljgavoh6rli5XliLbpmZDjgZXjgozjgb7jgZnjgIJcclxuICogY29tcGxldGVkL2ZhaWxlZOOCueODhuODvOOCv+OCueOBruWgtOWQiOOAgWNvbXBsZXRlZF9hdOOBqFRUTOOBjOiHquWLleioreWumuOBleOCjOOBvuOBmeOAglxyXG4gKlxyXG4gKiBAcGFyYW0gZXhlY3V0aW9uX2lkIC0g5a6f6KGMSURcclxuICogQHBhcmFtIHN0YXR1cyAtIOOCueODhuODvOOCv+OCuVxyXG4gKiBAcGFyYW0gcHJvZ3Jlc3MgLSDpgLLmjZfnjofvvIgwLTEwMO+8iVxyXG4gKiBAcGFyYW0gY29sbGVjdGVkX2NvdW50IC0g5Y+O6ZuG5oiQ5Yqf5Lu25pWw77yI44OH44OV44Kp44Or44OIOiAw77yJXHJcbiAqIEBwYXJhbSBmYWlsZWRfY291bnQgLSDlj47pm4blpLHmlZfku7bmlbDvvIjjg4fjg5Xjgqnjg6vjg4g6IDDvvIlcclxuICogQHBhcmFtIGVycm9yX21lc3NhZ2UgLSDjgqjjg6njg7zjg6Hjg4Pjgrvjg7zjgrjvvIhmYWlsZWTjga7loLTlkIjjga7jgb/vvIlcclxuICogQHJldHVybnMg5pu05paw5b6M44Gu5a6f6KGM54q25oWLXHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYHR5cGVzY3JpcHRcclxuICogLy8g5a6f6KGM6ZaL5aeLXHJcbiAqIGF3YWl0IHVwZGF0ZUV4ZWN1dGlvblN0YXR1cygnZXhlY18wMDEnLCAncGVuZGluZycsIDApO1xyXG4gKlxyXG4gKiAvLyDpgLLmjZfmm7TmlrBcclxuICogYXdhaXQgdXBkYXRlRXhlY3V0aW9uU3RhdHVzKCdleGVjXzAwMScsICdydW5uaW5nJywgNTAsIDI1LCAwKTtcclxuICpcclxuICogLy8g5a6M5LqGXHJcbiAqIGF3YWl0IHVwZGF0ZUV4ZWN1dGlvblN0YXR1cygnZXhlY18wMDEnLCAnY29tcGxldGVkJywgMTAwLCA1MCwgMCk7XHJcbiAqXHJcbiAqIC8vIOWkseaVl1xyXG4gKiBhd2FpdCB1cGRhdGVFeGVjdXRpb25TdGF0dXMoJ2V4ZWNfMDAxJywgJ2ZhaWxlZCcsIDUwLCAyNSwgNSwgJ05ldHdvcmsgZXJyb3InKTtcclxuICogYGBgXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlRXhlY3V0aW9uU3RhdHVzKFxyXG4gIGV4ZWN1dGlvbl9pZDogc3RyaW5nLFxyXG4gIHN0YXR1czogRXhlY3V0aW9uU3RhdHVzWydzdGF0dXMnXSxcclxuICBwcm9ncmVzczogbnVtYmVyLFxyXG4gIGNvbGxlY3RlZF9jb3VudDogbnVtYmVyID0gMCxcclxuICBmYWlsZWRfY291bnQ6IG51bWJlciA9IDAsXHJcbiAgZXJyb3JfbWVzc2FnZT86IHN0cmluZ1xyXG4pOiBQcm9taXNlPEV4ZWN1dGlvblN0YXR1cz4ge1xyXG4gIHRyeSB7XHJcbiAgICAvLyDpgLLmjZfnjofjgpIwLTEwMOOBruevhOWbsuOBq+WItumZkFxyXG4gICAgY29uc3QgY2xhbXBlZFByb2dyZXNzID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCBwcm9ncmVzcykpO1xyXG5cclxuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcclxuICAgIGNvbnN0IGlzQ29tcGxldGVkID0gc3RhdHVzID09PSAnY29tcGxldGVkJyB8fCBzdGF0dXMgPT09ICdmYWlsZWQnO1xyXG5cclxuICAgIC8vIFRUTDogMzDml6XlvozvvIhVbml4IHRpbWVzdGFtcO+8iVxyXG4gICAgY29uc3QgdHRsID0gaXNDb21wbGV0ZWQgPyBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwKSArIDMwICogMjQgKiA2MCAqIDYwIDogdW5kZWZpbmVkO1xyXG5cclxuICAgIGNvbnN0IGl0ZW06IEV4ZWN1dGlvblN0YXR1cyA9IHtcclxuICAgICAgZXhlY3V0aW9uX2lkLFxyXG4gICAgICBzdGF0dXMsXHJcbiAgICAgIHByb2dyZXNzOiBjbGFtcGVkUHJvZ3Jlc3MsXHJcbiAgICAgIGNvbGxlY3RlZF9jb3VudCxcclxuICAgICAgZmFpbGVkX2NvdW50LFxyXG4gICAgICBzdGFydGVkX2F0OiBub3csXHJcbiAgICAgIHVwZGF0ZWRfYXQ6IG5vdyxcclxuICAgICAgLi4uKGlzQ29tcGxldGVkID8geyBjb21wbGV0ZWRfYXQ6IG5vdyB9IDoge30pLFxyXG4gICAgICAuLi4oZXJyb3JfbWVzc2FnZSA/IHsgZXJyb3JfbWVzc2FnZSB9IDoge30pLFxyXG4gICAgICAuLi4odHRsID8geyB0dGwgfSA6IHt9KSxcclxuICAgIH07XHJcblxyXG4gICAgbG9nZ2VyLmluZm8oJ1VwZGF0aW5nIGV4ZWN1dGlvbiBzdGF0dXMnLCB7XHJcbiAgICAgIGV4ZWN1dGlvbl9pZCxcclxuICAgICAgc3RhdHVzLFxyXG4gICAgICBwcm9ncmVzczogY2xhbXBlZFByb2dyZXNzLFxyXG4gICAgICBjb2xsZWN0ZWRfY291bnQsXHJcbiAgICAgIGZhaWxlZF9jb3VudCxcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIER5bmFtb0RC44Gr5L+d5a2YXHJcbiAgICBhd2FpdCBkeW5hbW9DbGllbnQuc2VuZChcclxuICAgICAgbmV3IFB1dEl0ZW1Db21tYW5kKHtcclxuICAgICAgICBUYWJsZU5hbWU6IGdldER5bmFtb0V4ZWN1dGlvbnNUYWJsZSgpLFxyXG4gICAgICAgIEl0ZW06IG1hcnNoYWxsKGl0ZW0sIHtcclxuICAgICAgICAgIHJlbW92ZVVuZGVmaW5lZFZhbHVlczogdHJ1ZSxcclxuICAgICAgICB9KSxcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gICAgbG9nZ2VyLmluZm8oJ0V4ZWN1dGlvbiBzdGF0dXMgdXBkYXRlZCBzdWNjZXNzZnVsbHknLCB7XHJcbiAgICAgIGV4ZWN1dGlvbl9pZCxcclxuICAgICAgc3RhdHVzLFxyXG4gICAgICBwcm9ncmVzczogY2xhbXBlZFByb2dyZXNzLFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGl0ZW07XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIHVwZGF0ZSBleGVjdXRpb24gc3RhdHVzJywge1xyXG4gICAgICBleGVjdXRpb25faWQsXHJcbiAgICAgIHN0YXR1cyxcclxuICAgICAgcHJvZ3Jlc3MsXHJcbiAgICAgIGVycm9yX3R5cGU6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5jb25zdHJ1Y3Rvci5uYW1lIDogJ1Vua25vd24nLFxyXG4gICAgICBlcnJvcl9tZXNzYWdlOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXHJcbiAgICB9KTtcclxuICAgIHRocm93IGVycm9yO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOWun+ihjOeKtuaFi+OCkuWPluW+l1xyXG4gKlxyXG4gKiBAcGFyYW0gZXhlY3V0aW9uX2lkIC0g5a6f6KGMSURcclxuICogQHJldHVybnMg5a6f6KGM54q25oWL77yI5a2Y5Zyo44GX44Gq44GE5aC05ZCI44GvbnVsbO+8iVxyXG4gKlxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGB0eXBlc2NyaXB0XHJcbiAqIGNvbnN0IHN0YXR1cyA9IGF3YWl0IGdldEV4ZWN1dGlvblN0YXR1cygnZXhlY18wMDEnKTtcclxuICogaWYgKHN0YXR1cykge1xyXG4gKiAgIGNvbnNvbGUubG9nKGBQcm9ncmVzczogJHtzdGF0dXMucHJvZ3Jlc3N9JWApO1xyXG4gKiB9XHJcbiAqIGBgYFxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEV4ZWN1dGlvblN0YXR1cyhcclxuICBleGVjdXRpb25faWQ6IHN0cmluZ1xyXG4pOiBQcm9taXNlPEV4ZWN1dGlvblN0YXR1cyB8IG51bGw+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgeyBHZXRJdGVtQ29tbWFuZCB9ID0gYXdhaXQgaW1wb3J0KCdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInKTtcclxuICAgIGNvbnN0IHsgdW5tYXJzaGFsbCB9ID0gYXdhaXQgaW1wb3J0KCdAYXdzLXNkay91dGlsLWR5bmFtb2RiJyk7XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZHluYW1vQ2xpZW50LnNlbmQoXHJcbiAgICAgIG5ldyBHZXRJdGVtQ29tbWFuZCh7XHJcbiAgICAgICAgVGFibGVOYW1lOiBnZXREeW5hbW9FeGVjdXRpb25zVGFibGUoKSxcclxuICAgICAgICBLZXk6IG1hcnNoYWxsKHsgZXhlY3V0aW9uX2lkIH0pLFxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICBpZiAoIXJlc3VsdC5JdGVtKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB1bm1hcnNoYWxsKHJlc3VsdC5JdGVtKSBhcyBFeGVjdXRpb25TdGF0dXM7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIGdldCBleGVjdXRpb24gc3RhdHVzJywge1xyXG4gICAgICBleGVjdXRpb25faWQsXHJcbiAgICAgIGVycm9yX3R5cGU6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5jb25zdHJ1Y3Rvci5uYW1lIDogJ1Vua25vd24nLFxyXG4gICAgICBlcnJvcl9tZXNzYWdlOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXHJcbiAgICB9KTtcclxuICAgIHRocm93IGVycm9yO1xyXG4gIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=