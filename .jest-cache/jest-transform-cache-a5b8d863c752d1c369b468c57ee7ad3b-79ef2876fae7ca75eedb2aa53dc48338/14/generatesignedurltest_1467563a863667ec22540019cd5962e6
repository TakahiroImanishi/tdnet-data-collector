5f6bb1d183a2b555a28f09f4692df9a6
"use strict";
/**
 * generate-signed-url.ts のユニットテスト
 *
 * ブランチカバレッジ目標: 80%以上
 * 現状: 40% (2/5ブランチ)
 * 目標: 80%+ (4/5ブランチ以上)
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
// モック
jest.mock('@aws-sdk/client-s3');
jest.mock('@aws-sdk/s3-request-presigner');
jest.mock('../../../utils/logger');
const generate_signed_url_1 = require("../generate-signed-url");
const client_s3_1 = require("@aws-sdk/client-s3");
const s3_request_presigner_1 = require("@aws-sdk/s3-request-presigner");
const logger_1 = require("../../../utils/logger");
describe('generateSignedUrl', () => {
    const mockGetSignedUrl = s3_request_presigner_1.getSignedUrl;
    const mockLogger = logger_1.logger;
    beforeEach(() => {
        jest.clearAllMocks();
        // デフォルトのモック設定
        mockGetSignedUrl.mockResolvedValue('https://s3.amazonaws.com/signed-url');
        mockLogger.info = jest.fn();
        mockLogger.error = jest.fn();
    });
    describe('正常系', () => {
        it('署名付きURLを生成できること', async () => {
            const s3Key = 'exports/test-export.json';
            const expectedUrl = 'https://s3.amazonaws.com/signed-url';
            mockGetSignedUrl.mockResolvedValue(expectedUrl);
            const result = await (0, generate_signed_url_1.generateSignedUrl)(s3Key);
            expect(result).toBe(expectedUrl);
            expect(mockLogger.info).toHaveBeenCalledWith('Generating signed URL', {
                s3_key: s3Key,
                expires_in: 7 * 24 * 60 * 60,
            });
            expect(mockLogger.info).toHaveBeenCalledWith('Signed URL generated successfully', {
                s3_key: s3Key,
                signed_url: expectedUrl,
            });
        });
        it('カスタム有効期限で署名付きURLを生成できること', async () => {
            const s3Key = 'exports/test-export.json';
            const customExpiry = 3600; // 1時間
            const expectedUrl = 'https://s3.amazonaws.com/signed-url-custom';
            mockGetSignedUrl.mockResolvedValue(expectedUrl);
            const result = await (0, generate_signed_url_1.generateSignedUrl)(s3Key, customExpiry);
            expect(result).toBe(expectedUrl);
            expect(mockLogger.info).toHaveBeenCalledWith('Generating signed URL', {
                s3_key: s3Key,
                expires_in: customExpiry,
            });
        });
        it('デフォルト有効期限（7日間）が適用されること', async () => {
            const s3Key = 'exports/test-export.json';
            await (0, generate_signed_url_1.generateSignedUrl)(s3Key);
            expect(mockGetSignedUrl).toHaveBeenCalledWith(expect.any(client_s3_1.S3Client), expect.any(client_s3_1.GetObjectCommand), { expiresIn: 7 * 24 * 60 * 60 });
        });
    });
    describe('環境変数', () => {
        const originalEnv = process.env;
        beforeEach(() => {
            jest.resetModules();
            process.env = { ...originalEnv };
        });
        afterEach(() => {
            process.env = originalEnv;
        });
        it('EXPORT_BUCKET_NAME環境変数が使用されること', async () => {
            process.env.EXPORT_BUCKET_NAME = 'custom-bucket';
            // モジュールを再読み込み
            jest.isolateModules(async () => {
                const { generateSignedUrl: reloadedFn } = await Promise.resolve().then(() => __importStar(require('../generate-signed-url')));
                await reloadedFn('test-key');
                // GetObjectCommandが正しいバケット名で呼ばれることを確認
                expect(client_s3_1.GetObjectCommand).toHaveBeenCalledWith({
                    Bucket: 'custom-bucket',
                    Key: 'test-key',
                });
            });
        });
        it('AWS_REGION環境変数が使用されること', async () => {
            process.env.AWS_REGION = 'us-west-2';
            // モジュールを再読み込み
            jest.isolateModules(async () => {
                await Promise.resolve().then(() => __importStar(require('../generate-signed-url')));
                // S3Clientが正しいリージョンで初期化されることを確認
                expect(client_s3_1.S3Client).toHaveBeenCalledWith({ region: 'us-west-2' });
            });
        });
    });
    describe('エラーハンドリング', () => {
        it('getSignedUrlがエラーをスローした場合、エラーが伝播すること', async () => {
            const s3Key = 'exports/test-export.json';
            const error = new Error('S3 access denied');
            mockGetSignedUrl.mockRejectedValue(error);
            await expect((0, generate_signed_url_1.generateSignedUrl)(s3Key)).rejects.toThrow('S3 access denied');
        });
        it('S3Clientエラー時にエラーが伝播すること', async () => {
            const s3Key = 'exports/test-export.json';
            const error = new Error('Network error');
            mockGetSignedUrl.mockRejectedValue(error);
            await expect((0, generate_signed_url_1.generateSignedUrl)(s3Key)).rejects.toThrow('Network error');
        });
        it('無効なS3キーでもエラーハンドリングされること', async () => {
            const invalidKey = '';
            const error = new Error('Invalid S3 key');
            mockGetSignedUrl.mockRejectedValue(error);
            await expect((0, generate_signed_url_1.generateSignedUrl)(invalidKey)).rejects.toThrow('Invalid S3 key');
        });
    });
    describe('境界値テスト', () => {
        it('有効期限が0秒の場合でも処理できること', async () => {
            const s3Key = 'exports/test-export.json';
            const zeroExpiry = 0;
            await (0, generate_signed_url_1.generateSignedUrl)(s3Key, zeroExpiry);
            expect(mockGetSignedUrl).toHaveBeenCalledWith(expect.any(client_s3_1.S3Client), expect.any(client_s3_1.GetObjectCommand), { expiresIn: zeroExpiry });
        });
        it('有効期限が最大値（7日間）の場合でも処理できること', async () => {
            const s3Key = 'exports/test-export.json';
            const maxExpiry = 7 * 24 * 60 * 60;
            await (0, generate_signed_url_1.generateSignedUrl)(s3Key, maxExpiry);
            expect(mockGetSignedUrl).toHaveBeenCalledWith(expect.any(client_s3_1.S3Client), expect.any(client_s3_1.GetObjectCommand), { expiresIn: maxExpiry });
        });
        it('長いS3キーでも処理できること', async () => {
            const longKey = 'exports/' + 'a'.repeat(1000) + '.json';
            await (0, generate_signed_url_1.generateSignedUrl)(longKey);
            expect(mockGetSignedUrl).toHaveBeenCalled();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGV4cG9ydFxcX190ZXN0c19fXFxnZW5lcmF0ZS1zaWduZWQtdXJsLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7R0FNRzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFPSCxNQUFNO0FBQ04sSUFBSSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBQ2hDLElBQUksQ0FBQyxJQUFJLENBQUMsK0JBQStCLENBQUMsQ0FBQztBQUMzQyxJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFSbkMsZ0VBQTJEO0FBQzNELGtEQUFnRTtBQUNoRSx3RUFBNkQ7QUFDN0Qsa0RBQStDO0FBTy9DLFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUU7SUFDakMsTUFBTSxnQkFBZ0IsR0FBRyxtQ0FBd0QsQ0FBQztJQUNsRixNQUFNLFVBQVUsR0FBRyxlQUFvQyxDQUFDO0lBRXhELFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFFckIsY0FBYztRQUNkLGdCQUFnQixDQUFDLGlCQUFpQixDQUFDLHFDQUFxQyxDQUFDLENBQUM7UUFDMUUsVUFBVSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDNUIsVUFBVSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDL0IsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRTtRQUNuQixFQUFFLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDL0IsTUFBTSxLQUFLLEdBQUcsMEJBQTBCLENBQUM7WUFDekMsTUFBTSxXQUFXLEdBQUcscUNBQXFDLENBQUM7WUFFMUQsZ0JBQWdCLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7WUFF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TUFBTSxTQUFTLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDO1lBRW5DLE1BQU0sSUFBQSx1Q0FBaUIsRUFBQyxLQUFLLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFFMUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUMsb0JBQW9CLENBQzNDLE1BQU0sQ0FBQyxHQUFHLENBQUMsb0JBQVEsQ0FBQyxFQUNwQixNQUFNLENBQUMsR0FBRyxDQUFDLDRCQUFnQixDQUFDLEVBQzVCLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxDQUN6QixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDL0IsTUFBTSxPQUFPLEdBQUcsVUFBVSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDO1lBRXhELE1BQU0sSUFBQSx1Q0FBaUIsRUFBQyxPQUFPLENBQUMsQ0FBQztZQUVqQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzlDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpMTk4XFxpbnZlc3RtZW50X2FuYWx5c2lzX29wb3BvXFxzcmNcXGxhbWJkYVxcZXhwb3J0XFxfX3Rlc3RzX19cXGdlbmVyYXRlLXNpZ25lZC11cmwudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogZ2VuZXJhdGUtc2lnbmVkLXVybC50cyDjga7jg6bjg4vjg4Pjg4jjg4bjgrnjg4hcclxuICpcclxuICog44OW44Op44Oz44OB44Kr44OQ44Os44OD44K455uu5qiZOiA4MCXku6XkuIpcclxuICog54++54q2OiA0MCUgKDIvNeODluODqeODs+ODgSlcclxuICog55uu5qiZOiA4MCUrICg0LzXjg5bjg6njg7Pjg4Hku6XkuIopXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgZ2VuZXJhdGVTaWduZWRVcmwgfSBmcm9tICcuLi9nZW5lcmF0ZS1zaWduZWQtdXJsJztcclxuaW1wb3J0IHsgUzNDbGllbnQsIEdldE9iamVjdENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xyXG5pbXBvcnQgeyBnZXRTaWduZWRVcmwgfSBmcm9tICdAYXdzLXNkay9zMy1yZXF1ZXN0LXByZXNpZ25lcic7XHJcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL2xvZ2dlcic7XHJcblxyXG4vLyDjg6Ljg4Pjgq9cclxuamVzdC5tb2NrKCdAYXdzLXNkay9jbGllbnQtczMnKTtcclxuamVzdC5tb2NrKCdAYXdzLXNkay9zMy1yZXF1ZXN0LXByZXNpZ25lcicpO1xyXG5qZXN0Lm1vY2soJy4uLy4uLy4uL3V0aWxzL2xvZ2dlcicpO1xyXG5cclxuZGVzY3JpYmUoJ2dlbmVyYXRlU2lnbmVkVXJsJywgKCkgPT4ge1xyXG4gIGNvbnN0IG1vY2tHZXRTaWduZWRVcmwgPSBnZXRTaWduZWRVcmwgYXMgamVzdC5Nb2NrZWRGdW5jdGlvbjx0eXBlb2YgZ2V0U2lnbmVkVXJsPjtcclxuICBjb25zdCBtb2NrTG9nZ2VyID0gbG9nZ2VyIGFzIGplc3QuTW9ja2VkPHR5cGVvZiBsb2dnZXI+O1xyXG5cclxuICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xyXG4gICAgXHJcbiAgICAvLyDjg4fjg5Xjgqnjg6vjg4jjga7jg6Ljg4Pjgq/oqK3lrppcclxuICAgIG1vY2tHZXRTaWduZWRVcmwubW9ja1Jlc29sdmVkVmFsdWUoJ2h0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9zaWduZWQtdXJsJyk7XHJcbiAgICBtb2NrTG9nZ2VyLmluZm8gPSBqZXN0LmZuKCk7XHJcbiAgICBtb2NrTG9nZ2VyLmVycm9yID0gamVzdC5mbigpO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgn5q2j5bi457O7JywgKCkgPT4ge1xyXG4gICAgaXQoJ+e9suWQjeS7mOOBjVVSTOOCkueUn+aIkOOBp+OBjeOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgczNLZXkgPSAnZXhwb3J0cy90ZXN0LWV4cG9ydC5qc29uJztcclxuICAgICAgY29uc3QgZXhwZWN0ZWRVcmwgPSAnaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL3NpZ25lZC11cmwnO1xyXG4gICAgICBcclxuICAgICAgbW9ja0dldFNpZ25lZFVybC5tb2NrUmVzb2x2ZWRWYWx1ZShleHBlY3RlZFVybCk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnZW5lcmF0ZVNpZ25lZFVybChzM0tleSk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKGV4cGVjdGVkVXJsKTtcclxuICAgICAgZXhwZWN0KG1vY2tMb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ0dlbmVyYXRpbmcgc2lnbmVkIFVSTCcsIHtcclxuICAgICAgICBzM19rZXk6IHMzS2V5LFxyXG4gICAgICAgIGV4cGlyZXNfaW46IDcgKiAyNCAqIDYwICogNjAsXHJcbiAgICAgIH0pO1xyXG4gICAgICBleHBlY3QobW9ja0xvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnU2lnbmVkIFVSTCBnZW5lcmF0ZWQgc3VjY2Vzc2Z1bGx5Jywge1xyXG4gICAgICAgIHMzX2tleTogczNLZXksXHJcbiAgICAgICAgc2lnbmVkX3VybDogZXhwZWN0ZWRVcmwsXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ+OCq+OCueOCv+ODoOacieWKueacn+mZkOOBp+e9suWQjeS7mOOBjVVSTOOCkueUn+aIkOOBp+OBjeOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgczNLZXkgPSAnZXhwb3J0cy90ZXN0LWV4cG9ydC5qc29uJztcclxuICAgICAgY29uc3QgY3VzdG9tRXhwaXJ5ID0gMzYwMDsgLy8gMeaZgumWk1xyXG4gICAgICBjb25zdCBleHBlY3RlZFVybCA9ICdodHRwczovL3MzLmFtYXpvbmF3cy5jb20vc2lnbmVkLXVybC1jdXN0b20nO1xyXG4gICAgICBcclxuICAgICAgbW9ja0dldFNpZ25lZFVybC5tb2NrUmVzb2x2ZWRWYWx1ZShleHBlY3RlZFVybCk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnZW5lcmF0ZVNpZ25lZFVybChzM0tleSwgY3VzdG9tRXhwaXJ5KTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoZXhwZWN0ZWRVcmwpO1xyXG4gICAgICBleHBlY3QobW9ja0xvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnR2VuZXJhdGluZyBzaWduZWQgVVJMJywge1xyXG4gICAgICAgIHMzX2tleTogczNLZXksXHJcbiAgICAgICAgZXhwaXJlc19pbjogY3VzdG9tRXhwaXJ5LFxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCfjg4fjg5Xjgqnjg6vjg4jmnInlirnmnJ/pmZDvvIg35pel6ZaT77yJ44GM6YGp55So44GV44KM44KL44GT44GoJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBzM0tleSA9ICdleHBvcnRzL3Rlc3QtZXhwb3J0Lmpzb24nO1xyXG4gICAgICBcclxuICAgICAgYXdhaXQgZ2VuZXJhdGVTaWduZWRVcmwoczNLZXkpO1xyXG5cclxuICAgICAgZXhwZWN0KG1vY2tHZXRTaWduZWRVcmwpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgIGV4cGVjdC5hbnkoUzNDbGllbnQpLFxyXG4gICAgICAgIGV4cGVjdC5hbnkoR2V0T2JqZWN0Q29tbWFuZCksXHJcbiAgICAgICAgeyBleHBpcmVzSW46IDcgKiAyNCAqIDYwICogNjAgfVxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCfnkrDlooPlpInmlbAnLCAoKSA9PiB7XHJcbiAgICBjb25zdCBvcmlnaW5hbEVudiA9IHByb2Nlc3MuZW52O1xyXG5cclxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICBqZXN0LnJlc2V0TW9kdWxlcygpO1xyXG4gICAgICBwcm9jZXNzLmVudiA9IHsgLi4ub3JpZ2luYWxFbnYgfTtcclxuICAgIH0pO1xyXG5cclxuICAgIGFmdGVyRWFjaCgoKSA9PiB7XHJcbiAgICAgIHByb2Nlc3MuZW52ID0gb3JpZ2luYWxFbnY7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnRVhQT1JUX0JVQ0tFVF9OQU1F55Kw5aKD5aSJ5pWw44GM5L2/55So44GV44KM44KL44GT44GoJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBwcm9jZXNzLmVudi5FWFBPUlRfQlVDS0VUX05BTUUgPSAnY3VzdG9tLWJ1Y2tldCc7XHJcbiAgICAgIFxyXG4gICAgICAvLyDjg6Ljgrjjg6Xjg7zjg6vjgpLlho3oqq3jgb/ovrzjgb9cclxuICAgICAgamVzdC5pc29sYXRlTW9kdWxlcyhhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgeyBnZW5lcmF0ZVNpZ25lZFVybDogcmVsb2FkZWRGbiB9ID0gYXdhaXQgaW1wb3J0KCcuLi9nZW5lcmF0ZS1zaWduZWQtdXJsJyk7XHJcbiAgICAgICAgYXdhaXQgcmVsb2FkZWRGbigndGVzdC1rZXknKTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBHZXRPYmplY3RDb21tYW5k44GM5q2j44GX44GE44OQ44Kx44OD44OI5ZCN44Gn5ZG844Gw44KM44KL44GT44Go44KS56K66KqNXHJcbiAgICAgICAgZXhwZWN0KEdldE9iamVjdENvbW1hbmQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcclxuICAgICAgICAgIEJ1Y2tldDogJ2N1c3RvbS1idWNrZXQnLFxyXG4gICAgICAgICAgS2V5OiAndGVzdC1rZXknLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdBV1NfUkVHSU9O55Kw5aKD5aSJ5pWw44GM5L2/55So44GV44KM44KL44GT44GoJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBwcm9jZXNzLmVudi5BV1NfUkVHSU9OID0gJ3VzLXdlc3QtMic7XHJcbiAgICAgIFxyXG4gICAgICAvLyDjg6Ljgrjjg6Xjg7zjg6vjgpLlho3oqq3jgb/ovrzjgb9cclxuICAgICAgamVzdC5pc29sYXRlTW9kdWxlcyhhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgYXdhaXQgaW1wb3J0KCcuLi9nZW5lcmF0ZS1zaWduZWQtdXJsJyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gUzNDbGllbnTjgYzmraPjgZfjgYTjg6rjg7zjgrjjg6fjg7PjgafliJ3mnJ/ljJbjgZXjgozjgovjgZPjgajjgpLnorroqo1cclxuICAgICAgICBleHBlY3QoUzNDbGllbnQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgcmVnaW9uOiAndXMtd2VzdC0yJyB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ+OCqOODqeODvOODj+ODs+ODieODquODs+OCsCcsICgpID0+IHtcclxuICAgIGl0KCdnZXRTaWduZWRVcmzjgYzjgqjjg6njg7zjgpLjgrnjg63jg7zjgZfjgZ/loLTlkIjjgIHjgqjjg6njg7zjgYzkvJ3mkq3jgZnjgovjgZPjgagnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHMzS2V5ID0gJ2V4cG9ydHMvdGVzdC1leHBvcnQuanNvbic7XHJcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCdTMyBhY2Nlc3MgZGVuaWVkJyk7XHJcbiAgICAgIFxyXG4gICAgICBtb2NrR2V0U2lnbmVkVXJsLm1vY2tSZWplY3RlZFZhbHVlKGVycm9yKTtcclxuXHJcbiAgICAgIGF3YWl0IGV4cGVjdChnZW5lcmF0ZVNpZ25lZFVybChzM0tleSkpLnJlamVjdHMudG9UaHJvdygnUzMgYWNjZXNzIGRlbmllZCcpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ1MzQ2xpZW5044Ko44Op44O85pmC44Gr44Ko44Op44O844GM5Lyd5pKt44GZ44KL44GT44GoJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBzM0tleSA9ICdleHBvcnRzL3Rlc3QtZXhwb3J0Lmpzb24nO1xyXG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignTmV0d29yayBlcnJvcicpO1xyXG4gICAgICBcclxuICAgICAgbW9ja0dldFNpZ25lZFVybC5tb2NrUmVqZWN0ZWRWYWx1ZShlcnJvcik7XHJcblxyXG4gICAgICBhd2FpdCBleHBlY3QoZ2VuZXJhdGVTaWduZWRVcmwoczNLZXkpKS5yZWplY3RzLnRvVGhyb3coJ05ldHdvcmsgZXJyb3InKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCfnhKHlirnjgapTM+OCreODvOOBp+OCguOCqOODqeODvOODj+ODs+ODieODquODs+OCsOOBleOCjOOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgaW52YWxpZEtleSA9ICcnO1xyXG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignSW52YWxpZCBTMyBrZXknKTtcclxuICAgICAgXHJcbiAgICAgIG1vY2tHZXRTaWduZWRVcmwubW9ja1JlamVjdGVkVmFsdWUoZXJyb3IpO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KGdlbmVyYXRlU2lnbmVkVXJsKGludmFsaWRLZXkpKS5yZWplY3RzLnRvVGhyb3coJ0ludmFsaWQgUzMga2V5Jyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ+Wig+eVjOWApOODhuOCueODiCcsICgpID0+IHtcclxuICAgIGl0KCfmnInlirnmnJ/pmZDjgYww56eS44Gu5aC05ZCI44Gn44KC5Yem55CG44Gn44GN44KL44GT44GoJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBzM0tleSA9ICdleHBvcnRzL3Rlc3QtZXhwb3J0Lmpzb24nO1xyXG4gICAgICBjb25zdCB6ZXJvRXhwaXJ5ID0gMDtcclxuICAgICAgXHJcbiAgICAgIGF3YWl0IGdlbmVyYXRlU2lnbmVkVXJsKHMzS2V5LCB6ZXJvRXhwaXJ5KTtcclxuXHJcbiAgICAgIGV4cGVjdChtb2NrR2V0U2lnbmVkVXJsKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICBleHBlY3QuYW55KFMzQ2xpZW50KSxcclxuICAgICAgICBleHBlY3QuYW55KEdldE9iamVjdENvbW1hbmQpLFxyXG4gICAgICAgIHsgZXhwaXJlc0luOiB6ZXJvRXhwaXJ5IH1cclxuICAgICAgKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCfmnInlirnmnJ/pmZDjgYzmnIDlpKflgKTvvIg35pel6ZaT77yJ44Gu5aC05ZCI44Gn44KC5Yem55CG44Gn44GN44KL44GT44GoJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBzM0tleSA9ICdleHBvcnRzL3Rlc3QtZXhwb3J0Lmpzb24nO1xyXG4gICAgICBjb25zdCBtYXhFeHBpcnkgPSA3ICogMjQgKiA2MCAqIDYwO1xyXG4gICAgICBcclxuICAgICAgYXdhaXQgZ2VuZXJhdGVTaWduZWRVcmwoczNLZXksIG1heEV4cGlyeSk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja0dldFNpZ25lZFVybCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgZXhwZWN0LmFueShTM0NsaWVudCksXHJcbiAgICAgICAgZXhwZWN0LmFueShHZXRPYmplY3RDb21tYW5kKSxcclxuICAgICAgICB7IGV4cGlyZXNJbjogbWF4RXhwaXJ5IH1cclxuICAgICAgKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCfplbfjgYRTM+OCreODvOOBp+OCguWHpueQhuOBp+OBjeOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbG9uZ0tleSA9ICdleHBvcnRzLycgKyAnYScucmVwZWF0KDEwMDApICsgJy5qc29uJztcclxuICAgICAgXHJcbiAgICAgIGF3YWl0IGdlbmVyYXRlU2lnbmVkVXJsKGxvbmdLZXkpO1xyXG5cclxuICAgICAgZXhwZWN0KG1vY2tHZXRTaWduZWRVcmwpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTtcclxuIl0sInZlcnNpb24iOjN9