{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\__tests__\\generate-signed-url.test.ts","mappings":";AAAA;;;;;;GAMG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAOH,MAAM;AACN,IAAI,CAAC,IAAI,CAAC,oBAAoB,CAAC,CAAC;AAChC,IAAI,CAAC,IAAI,CAAC,+BAA+B,CAAC,CAAC;AAC3C,IAAI,CAAC,IAAI,CAAC,uBAAuB,CAAC,CAAC;AARnC,gEAA2D;AAC3D,kDAAgE;AAChE,wEAA6D;AAC7D,kDAA+C;AAO/C,QAAQ,CAAC,mBAAmB,EAAE,GAAG,EAAE;IACjC,MAAM,gBAAgB,GAAG,mCAAwD,CAAC;IAClF,MAAM,UAAU,GAAG,eAAoC,CAAC;IAExD,UAAU,CAAC,GAAG,EAAE;QACd,IAAI,CAAC,aAAa,EAAE,CAAC;QAErB,cAAc;QACd,gBAAgB,CAAC,iBAAiB,CAAC,qCAAqC,CAAC,CAAC;QAC1E,UAAU,CAAC,IAAI,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC;QAC5B,UAAU,CAAC,KAAK,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC;IAC/B,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,KAAK,EAAE,GAAG,EAAE;QACnB,EAAE,CAAC,iBAAiB,EAAE,KAAK,IAAI,EAAE;YAC/B,MAAM,KAAK,GAAG,0BAA0B,CAAC;YACzC,MAAM,WAAW,GAAG,qCAAqC,CAAC;YAE1D,gBAAgB,CAAC,iBAAiB,CAAC,WAAW,CAAC,CAAC;YAEhD,MAAM,MAAM,GAAG,MAAM,IAAA,uCAAiB,EAAC,KAAK,CAAC,CAAC;YAE9C,MAAM,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;YACjC,MAAM,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,oBAAoB,CAAC,uBAAuB,EAAE;gBACpE,MAAM,EAAE,KAAK;gBACb,UAAU,EAAE,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE;aAC7B,CAAC,CAAC;YACH,MAAM,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,oBAAoB,CAAC,mCAAmC,EAAE;gBAChF,MAAM,EAAE,KAAK;gBACb,UAAU,EAAE,WAAW;aACxB,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,0BAA0B,EAAE,KAAK,IAAI,EAAE;YACxC,MAAM,KAAK,GAAG,0BAA0B,CAAC;YACzC,MAAM,YAAY,GAAG,IAAI,CAAC,CAAC,MAAM;YACjC,MAAM,WAAW,GAAG,4CAA4C,CAAC;YAEjE,gBAAgB,CAAC,iBAAiB,CAAC,WAAW,CAAC,CAAC;YAEhD,MAAM,MAAM,GAAG,MAAM,IAAA,uCAAiB,EAAC,KAAK,EAAE,YAAY,CAAC,CAAC;YAE5D,MAAM,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;YACjC,MAAM,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,oBAAoB,CAAC,uBAAuB,EAAE;gBACpE,MAAM,EAAE,KAAK;gBACb,UAAU,EAAE,YAAY;aACzB,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,wBAAwB,EAAE,KAAK,IAAI,EAAE;YACtC,MAAM,KAAK,GAAG,0BAA0B,CAAC;YAEzC,MAAM,IAAA,uCAAiB,EAAC,KAAK,CAAC,CAAC;YAE/B,MAAM,CAAC,gBAAgB,CAAC,CAAC,oBAAoB,CAC3C,MAAM,CAAC,GAAG,CAAC,oBAAQ,CAAC,EACpB,MAAM,CAAC,GAAG,CAAC,4BAAgB,CAAC,EAC5B,EAAE,SAAS,EAAE,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,EAAE,CAChC,CAAC;QACJ,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,MAAM,EAAE,GAAG,EAAE;QACpB,MAAM,WAAW,GAAG,OAAO,CAAC,GAAG,CAAC;QAEhC,UAAU,CAAC,GAAG,EAAE;YACd,IAAI,CAAC,YAAY,EAAE,CAAC;YACpB,OAAO,CAAC,GAAG,GAAG,EAAE,GAAG,WAAW,EAAE,CAAC;QACnC,CAAC,CAAC,CAAC;QAEH,SAAS,CAAC,GAAG,EAAE;YACb,OAAO,CAAC,GAAG,GAAG,WAAW,CAAC;QAC5B,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,gCAAgC,EAAE,KAAK,IAAI,EAAE;YAC9C,OAAO,CAAC,GAAG,CAAC,kBAAkB,GAAG,eAAe,CAAC;YAEjD,cAAc;YACd,IAAI,CAAC,cAAc,CAAC,KAAK,IAAI,EAAE;gBAC7B,MAAM,EAAE,iBAAiB,EAAE,UAAU,EAAE,GAAG,wDAAa,wBAAwB,GAAC,CAAC;gBACjF,MAAM,UAAU,CAAC,UAAU,CAAC,CAAC;gBAE7B,sCAAsC;gBACtC,MAAM,CAAC,4BAAgB,CAAC,CAAC,oBAAoB,CAAC;oBAC5C,MAAM,EAAE,eAAe;oBACvB,GAAG,EAAE,UAAU;iBAChB,CAAC,CAAC;YACL,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,wBAAwB,EAAE,KAAK,IAAI,EAAE;YACtC,OAAO,CAAC,GAAG,CAAC,UAAU,GAAG,WAAW,CAAC;YAErC,cAAc;YACd,IAAI,CAAC,cAAc,CAAC,KAAK,IAAI,EAAE;gBAC7B,wDAAa,wBAAwB,GAAC,CAAC;gBAEvC,gCAAgC;gBAChC,MAAM,CAAC,oBAAQ,CAAC,CAAC,oBAAoB,CAAC,EAAE,MAAM,EAAE,WAAW,EAAE,CAAC,CAAC;YACjE,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,WAAW,EAAE,GAAG,EAAE;QACzB,EAAE,CAAC,qCAAqC,EAAE,KAAK,IAAI,EAAE;YACnD,MAAM,KAAK,GAAG,0BAA0B,CAAC;YACzC,MAAM,KAAK,GAAG,IAAI,KAAK,CAAC,kBAAkB,CAAC,CAAC;YAE5C,gBAAgB,CAAC,iBAAiB,CAAC,KAAK,CAAC,CAAC;YAE1C,MAAM,MAAM,CAAC,IAAA,uCAAiB,EAAC,KAAK,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,kBAAkB,CAAC,CAAC;QAC7E,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,yBAAyB,EAAE,KAAK,IAAI,EAAE;YACvC,MAAM,KAAK,GAAG,0BAA0B,CAAC;YACzC,MAAM,KAAK,GAAG,IAAI,KAAK,CAAC,eAAe,CAAC,CAAC;YAEzC,gBAAgB,CAAC,iBAAiB,CAAC,KAAK,CAAC,CAAC;YAE1C,MAAM,MAAM,CAAC,IAAA,uCAAiB,EAAC,KAAK,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,eAAe,CAAC,CAAC;QAC1E,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,yBAAyB,EAAE,KAAK,IAAI,EAAE;YACvC,MAAM,UAAU,GAAG,EAAE,CAAC;YACtB,MAAM,KAAK,GAAG,IAAI,KAAK,CAAC,gBAAgB,CAAC,CAAC;YAE1C,gBAAgB,CAAC,iBAAiB,CAAC,KAAK,CAAC,CAAC;YAE1C,MAAM,MAAM,CAAC,IAAA,uCAAiB,EAAC,UAAU,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,gBAAgB,CAAC,CAAC;QAChF,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,QAAQ,EAAE,GAAG,EAAE;QACtB,EAAE,CAAC,qBAAqB,EAAE,KAAK,IAAI,EAAE;YACnC,MAAM,KAAK,GAAG,0BAA0B,CAAC;YACzC,MAAM,UAAU,GAAG,CAAC,CAAC;YAErB,MAAM,IAAA,uCAAiB,EAAC,KAAK,EAAE,UAAU,CAAC,CAAC;YAE3C,MAAM,CAAC,gBAAgB,CAAC,CAAC,oBAAoB,CAC3C,MAAM,CAAC,GAAG,CAAC,oBAAQ,CAAC,EACpB,MAAM,CAAC,GAAG,CAAC,4BAAgB,CAAC,EAC5B,EAAE,SAAS,EAAE,UAAU,EAAE,CAC1B,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,2BAA2B,EAAE,KAAK,IAAI,EAAE;YACzC,MAAM,KAAK,GAAG,0BAA0B,CAAC;YACzC,MAAM,SAAS,GAAG,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,CAAC;YAEnC,MAAM,IAAA,uCAAiB,EAAC,KAAK,EAAE,SAAS,CAAC,CAAC;YAE1C,MAAM,CAAC,gBAAgB,CAAC,CAAC,oBAAoB,CAC3C,MAAM,CAAC,GAAG,CAAC,oBAAQ,CAAC,EACpB,MAAM,CAAC,GAAG,CAAC,4BAAgB,CAAC,EAC5B,EAAE,SAAS,EAAE,SAAS,EAAE,CACzB,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,iBAAiB,EAAE,KAAK,IAAI,EAAE;YAC/B,MAAM,OAAO,GAAG,UAAU,GAAG,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,OAAO,CAAC;YAExD,MAAM,IAAA,uCAAiB,EAAC,OAAO,CAAC,CAAC;YAEjC,MAAM,CAAC,gBAAgB,CAAC,CAAC,gBAAgB,EAAE,CAAC;QAC9C,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\__tests__\\generate-signed-url.test.ts"],"sourcesContent":["/**\r\n * generate-signed-url.ts のユニットテスト\r\n *\r\n * ブランチカバレッジ目標: 80%以上\r\n * 現状: 40% (2/5ブランチ)\r\n * 目標: 80%+ (4/5ブランチ以上)\r\n */\r\n\r\nimport { generateSignedUrl } from '../generate-signed-url';\r\nimport { S3Client, GetObjectCommand } from '@aws-sdk/client-s3';\r\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\r\nimport { logger } from '../../../utils/logger';\r\n\r\n// モック\r\njest.mock('@aws-sdk/client-s3');\r\njest.mock('@aws-sdk/s3-request-presigner');\r\njest.mock('../../../utils/logger');\r\n\r\ndescribe('generateSignedUrl', () => {\r\n  const mockGetSignedUrl = getSignedUrl as jest.MockedFunction<typeof getSignedUrl>;\r\n  const mockLogger = logger as jest.Mocked<typeof logger>;\r\n\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n    \r\n    // デフォルトのモック設定\r\n    mockGetSignedUrl.mockResolvedValue('https://s3.amazonaws.com/signed-url');\r\n    mockLogger.info = jest.fn();\r\n    mockLogger.error = jest.fn();\r\n  });\r\n\r\n  describe('正常系', () => {\r\n    it('署名付きURLを生成できること', async () => {\r\n      const s3Key = 'exports/test-export.json';\r\n      const expectedUrl = 'https://s3.amazonaws.com/signed-url';\r\n      \r\n      mockGetSignedUrl.mockResolvedValue(expectedUrl);\r\n\r\n      const result = await generateSignedUrl(s3Key);\r\n\r\n      expect(result).toBe(expectedUrl);\r\n      expect(mockLogger.info).toHaveBeenCalledWith('Generating signed URL', {\r\n        s3_key: s3Key,\r\n        expires_in: 7 * 24 * 60 * 60,\r\n      });\r\n      expect(mockLogger.info).toHaveBeenCalledWith('Signed URL generated successfully', {\r\n        s3_key: s3Key,\r\n        signed_url: expectedUrl,\r\n      });\r\n    });\r\n\r\n    it('カスタム有効期限で署名付きURLを生成できること', async () => {\r\n      const s3Key = 'exports/test-export.json';\r\n      const customExpiry = 3600; // 1時間\r\n      const expectedUrl = 'https://s3.amazonaws.com/signed-url-custom';\r\n      \r\n      mockGetSignedUrl.mockResolvedValue(expectedUrl);\r\n\r\n      const result = await generateSignedUrl(s3Key, customExpiry);\r\n\r\n      expect(result).toBe(expectedUrl);\r\n      expect(mockLogger.info).toHaveBeenCalledWith('Generating signed URL', {\r\n        s3_key: s3Key,\r\n        expires_in: customExpiry,\r\n      });\r\n    });\r\n\r\n    it('デフォルト有効期限（7日間）が適用されること', async () => {\r\n      const s3Key = 'exports/test-export.json';\r\n      \r\n      await generateSignedUrl(s3Key);\r\n\r\n      expect(mockGetSignedUrl).toHaveBeenCalledWith(\r\n        expect.any(S3Client),\r\n        expect.any(GetObjectCommand),\r\n        { expiresIn: 7 * 24 * 60 * 60 }\r\n      );\r\n    });\r\n  });\r\n\r\n  describe('環境変数', () => {\r\n    const originalEnv = process.env;\r\n\r\n    beforeEach(() => {\r\n      jest.resetModules();\r\n      process.env = { ...originalEnv };\r\n    });\r\n\r\n    afterEach(() => {\r\n      process.env = originalEnv;\r\n    });\r\n\r\n    it('EXPORT_BUCKET_NAME環境変数が使用されること', async () => {\r\n      process.env.EXPORT_BUCKET_NAME = 'custom-bucket';\r\n      \r\n      // モジュールを再読み込み\r\n      jest.isolateModules(async () => {\r\n        const { generateSignedUrl: reloadedFn } = await import('../generate-signed-url');\r\n        await reloadedFn('test-key');\r\n        \r\n        // GetObjectCommandが正しいバケット名で呼ばれることを確認\r\n        expect(GetObjectCommand).toHaveBeenCalledWith({\r\n          Bucket: 'custom-bucket',\r\n          Key: 'test-key',\r\n        });\r\n      });\r\n    });\r\n\r\n    it('AWS_REGION環境変数が使用されること', async () => {\r\n      process.env.AWS_REGION = 'us-west-2';\r\n      \r\n      // モジュールを再読み込み\r\n      jest.isolateModules(async () => {\r\n        await import('../generate-signed-url');\r\n        \r\n        // S3Clientが正しいリージョンで初期化されることを確認\r\n        expect(S3Client).toHaveBeenCalledWith({ region: 'us-west-2' });\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('エラーハンドリング', () => {\r\n    it('getSignedUrlがエラーをスローした場合、エラーが伝播すること', async () => {\r\n      const s3Key = 'exports/test-export.json';\r\n      const error = new Error('S3 access denied');\r\n      \r\n      mockGetSignedUrl.mockRejectedValue(error);\r\n\r\n      await expect(generateSignedUrl(s3Key)).rejects.toThrow('S3 access denied');\r\n    });\r\n\r\n    it('S3Clientエラー時にエラーが伝播すること', async () => {\r\n      const s3Key = 'exports/test-export.json';\r\n      const error = new Error('Network error');\r\n      \r\n      mockGetSignedUrl.mockRejectedValue(error);\r\n\r\n      await expect(generateSignedUrl(s3Key)).rejects.toThrow('Network error');\r\n    });\r\n\r\n    it('無効なS3キーでもエラーハンドリングされること', async () => {\r\n      const invalidKey = '';\r\n      const error = new Error('Invalid S3 key');\r\n      \r\n      mockGetSignedUrl.mockRejectedValue(error);\r\n\r\n      await expect(generateSignedUrl(invalidKey)).rejects.toThrow('Invalid S3 key');\r\n    });\r\n  });\r\n\r\n  describe('境界値テスト', () => {\r\n    it('有効期限が0秒の場合でも処理できること', async () => {\r\n      const s3Key = 'exports/test-export.json';\r\n      const zeroExpiry = 0;\r\n      \r\n      await generateSignedUrl(s3Key, zeroExpiry);\r\n\r\n      expect(mockGetSignedUrl).toHaveBeenCalledWith(\r\n        expect.any(S3Client),\r\n        expect.any(GetObjectCommand),\r\n        { expiresIn: zeroExpiry }\r\n      );\r\n    });\r\n\r\n    it('有効期限が最大値（7日間）の場合でも処理できること', async () => {\r\n      const s3Key = 'exports/test-export.json';\r\n      const maxExpiry = 7 * 24 * 60 * 60;\r\n      \r\n      await generateSignedUrl(s3Key, maxExpiry);\r\n\r\n      expect(mockGetSignedUrl).toHaveBeenCalledWith(\r\n        expect.any(S3Client),\r\n        expect.any(GetObjectCommand),\r\n        { expiresIn: maxExpiry }\r\n      );\r\n    });\r\n\r\n    it('長いS3キーでも処理できること', async () => {\r\n      const longKey = 'exports/' + 'a'.repeat(1000) + '.json';\r\n      \r\n      await generateSignedUrl(longKey);\r\n\r\n      expect(mockGetSignedUrl).toHaveBeenCalled();\r\n    });\r\n  });\r\n});\r\n"],"version":3}