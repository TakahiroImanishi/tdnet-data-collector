{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\generate-signed-url.ts","mappings":";AAAA;;;;;;GAMG;;AAqBH,8CA6CC;AAhED,kDAAgE;AAChE,wEAA6D;AAC7D,+CAA4C;AAC5C,yCAA8C;AAE9C,0BAA0B;AAC1B,MAAM,QAAQ,GAAG,IAAI,oBAAQ,CAAC,EAAE,MAAM,EAAE,OAAO,CAAC,GAAG,CAAC,UAAU,IAAI,gBAAgB,EAAE,CAAC,CAAC;AAEtF,OAAO;AACP,MAAM,aAAa,GAAG,OAAO,CAAC,GAAG,CAAC,kBAAkB,IAAI,eAAe,CAAC;AAExE;;;;;;;GAOG;AACI,KAAK,UAAU,iBAAiB,CACrC,MAAc,EACd,YAAoB,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,CAAC,aAAa;;IAElD,IAAI,CAAC;QACH,eAAM,CAAC,IAAI,CAAC,uBAAuB,EAAE;YACnC,MAAM;YACN,UAAU,EAAE,SAAS;SACtB,CAAC,CAAC;QAEH,sBAAsB;QACtB,MAAM,OAAO,GAAG,IAAI,4BAAgB,CAAC;YACnC,MAAM,EAAE,aAAa;YACrB,GAAG,EAAE,MAAM;SACZ,CAAC,CAAC;QAEH,aAAa;QACb,MAAM,SAAS,GAAG,MAAM,IAAA,mCAAY,EAAC,QAAQ,EAAE,OAAO,EAAE,EAAE,SAAS,EAAE,CAAC,CAAC;QAEvE,eAAM,CAAC,IAAI,CAAC,mCAAmC,EAAE;YAC/C,MAAM;YACN,UAAU,EAAE,SAAS;SACtB,CAAC,CAAC;QAEH,OAAO,SAAS,CAAC;IACnB,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,wBAAwB;QACxB,MAAM,QAAQ,GAAG,KAAY,CAAC;QAC9B,MAAM,SAAS,GAAG,QAAQ,EAAE,IAAI,CAAC;QACjC,MAAM,YAAY,GAAG,QAAQ,EAAE,OAAO,CAAC;QACvC,MAAM,UAAU,GAAG,QAAQ,EAAE,KAAK,CAAC;QAEnC,eAAM,CAAC,KAAK,CAAC,+BAA+B,EAAE;YAC5C,UAAU,EAAE,SAAS;YACrB,aAAa,EAAE,YAAY;YAC3B,OAAO,EAAE,EAAE,MAAM,EAAE,UAAU,EAAE,SAAS,EAAE;YAC1C,WAAW,EAAE,UAAU;SACxB,CAAC,CAAC;QAEH,cAAc;QACd,MAAM,IAAI,uBAAc,CAAC,+BAA+B,EAAE;YACxD,KAAK,EAAE,KAAK;YACZ,OAAO,EAAE,EAAE,MAAM,EAAE,UAAU,EAAE,SAAS,EAAE;SAC3C,CAAC,CAAC;IACL,CAAC;AACH,CAAC","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\generate-signed-url.ts"],"sourcesContent":["/**\r\n * 署名付きURL生成\r\n *\r\n * S3オブジェクトの署名付きURLを生成します（有効期限7日）。\r\n *\r\n * Requirements: 要件5.1（エクスポート）\r\n */\r\n\r\nimport { S3Client, GetObjectCommand } from '@aws-sdk/client-s3';\r\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\r\nimport { logger } from '../../utils/logger';\r\nimport { RetryableError } from '../../errors';\r\n\r\n// S3クライアント（グローバルスコープで初期化）\r\nconst s3Client = new S3Client({ region: process.env.AWS_REGION || 'ap-northeast-1' });\r\n\r\n// 環境変数\r\nconst EXPORT_BUCKET = process.env.EXPORT_BUCKET_NAME || 'tdnet-exports';\r\n\r\n/**\r\n * 署名付きURLを生成\r\n *\r\n * @param s3_key S3キー\r\n * @param expiresIn 有効期限（秒）\r\n * @returns 署名付きURL\r\n * @throws {RetryableError} S3アクセスエラー時\r\n */\r\nexport async function generateSignedUrl(\r\n  s3_key: string,\r\n  expiresIn: number = 7 * 24 * 60 * 60 // デフォルト: 7日間\r\n): Promise<string> {\r\n  try {\r\n    logger.info('Generating signed URL', {\r\n      s3_key,\r\n      expires_in: expiresIn,\r\n    });\r\n\r\n    // GetObjectCommandを作成\r\n    const command = new GetObjectCommand({\r\n      Bucket: EXPORT_BUCKET,\r\n      Key: s3_key,\r\n    });\r\n\r\n    // 署名付きURLを生成\r\n    const signedUrl = await getSignedUrl(s3Client, command, { expiresIn });\r\n\r\n    logger.info('Signed URL generated successfully', {\r\n      s3_key,\r\n      signed_url: signedUrl,\r\n    });\r\n\r\n    return signedUrl;\r\n  } catch (error) {\r\n    // エラーオブジェクトのプロパティを安全に取得\r\n    const errorObj = error as any;\r\n    const errorType = errorObj?.name;\r\n    const errorMessage = errorObj?.message;\r\n    const stackTrace = errorObj?.stack;\r\n\r\n    logger.error('Failed to generate signed URL', {\r\n      error_type: errorType,\r\n      error_message: errorMessage,\r\n      context: { s3_key, expires_in: expiresIn },\r\n      stack_trace: stackTrace,\r\n    });\r\n\r\n    // S3エラーは再試行可能\r\n    throw new RetryableError('Failed to generate signed URL', {\r\n      cause: error,\r\n      context: { s3_key, expires_in: expiresIn },\r\n    });\r\n  }\r\n}\r\n"],"version":3}