{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\models\\disclosure.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\models\\disclosure.ts"],"sourcesContent":["/**\n * Disclosureモデルと変換関数\n *\n * 開示情報のモデルとDynamoDBアイテムとの変換関数を提供します。\n *\n * Requirements: 要件2.1, 2.2, 2.3（メタデータ管理）\n */\n\nimport { Disclosure, DynamoDBItem } from '../types';\nimport { ValidationError } from '../errors';\nimport { generateDatePartition, validateDisclosedAt } from '../utils/date-partition';\nimport { generateDisclosureId } from '../utils/disclosure-id';\n\n/**\n * Disclosureの必須フィールドをバリデーション\n *\n * @param disclosure - バリデーション対象のDisclosure\n * @throws {ValidationError} 必須フィールドが欠落している場合\n */\nexport function validateDisclosure(disclosure: Partial<Disclosure>): void {\n  const requiredFields: Array<keyof Disclosure> = [\n    'disclosure_id',\n    'company_code',\n    'company_name',\n    'disclosure_type',\n    'title',\n    'disclosed_at',\n    'pdf_url',\n    's3_key',\n    'collected_at',\n    'date_partition',\n  ];\n\n  const missingFields = requiredFields.filter((field) => !disclosure[field]);\n\n  if (missingFields.length > 0) {\n    throw new ValidationError(`Missing required fields: ${missingFields.join(', ')}`, {\n      missing_fields: missingFields,\n      disclosure,\n    });\n  }\n\n  // disclosed_atのフォーマット検証\n  validateDisclosedAt(disclosure.disclosed_at!);\n\n  // collected_atのフォーマット検証\n  validateDisclosedAt(disclosure.collected_at!);\n\n  // company_codeのフォーマット検証（4桁の数字）\n  const companyCodeRegex = /^\\d{4}$/;\n  if (!companyCodeRegex.test(disclosure.company_code!)) {\n    throw new ValidationError(\n      `Invalid company_code format: ${disclosure.company_code}. Expected 4-digit number.`,\n      { company_code: disclosure.company_code }\n    );\n  }\n\n  // date_partitionのフォーマット検証（YYYY-MM形式）\n  const datePartitionRegex = /^\\d{4}-\\d{2}$/;\n  if (!datePartitionRegex.test(disclosure.date_partition!)) {\n    throw new ValidationError(\n      `Invalid date_partition format: ${disclosure.date_partition}. Expected YYYY-MM format.`,\n      { date_partition: disclosure.date_partition }\n    );\n  }\n}\n\n/**\n * DisclosureをDynamoDBアイテムに変換\n *\n * Two-Phase Commit原則に従い、date_partitionは事前に生成されている必要があります。\n * この関数は変換のみを行い、date_partitionの生成は行いません。\n *\n * @param disclosure - 変換元のDisclosure\n * @returns DynamoDBアイテム\n * @throws {ValidationError} バリデーションエラーの場合\n */\nexport function toDynamoDBItem(disclosure: Disclosure): DynamoDBItem {\n  // バリデーション\n  validateDisclosure(disclosure);\n\n  // DynamoDBアイテムに変換\n  return {\n    disclosure_id: { S: disclosure.disclosure_id },\n    company_code: { S: disclosure.company_code },\n    company_name: { S: disclosure.company_name },\n    disclosure_type: { S: disclosure.disclosure_type },\n    title: { S: disclosure.title },\n    disclosed_at: { S: disclosure.disclosed_at },\n    pdf_url: { S: disclosure.pdf_url },\n    s3_key: { S: disclosure.s3_key },\n    collected_at: { S: disclosure.collected_at },\n    date_partition: { S: disclosure.date_partition },\n  };\n}\n\n/**\n * DynamoDBアイテムをDisclosureに変換\n *\n * @param item - 変換元のDynamoDBアイテム\n * @returns Disclosure\n * @throws {ValidationError} 必須フィールドが欠落している場合\n */\nexport function fromDynamoDBItem(item: DynamoDBItem): Disclosure {\n  // 必須フィールドの存在チェック\n  const requiredFields = [\n    'disclosure_id',\n    'company_code',\n    'company_name',\n    'disclosure_type',\n    'title',\n    'disclosed_at',\n    'pdf_url',\n    's3_key',\n    'collected_at',\n    'date_partition',\n  ];\n\n  const missingFields = requiredFields.filter((field) => !item[field]);\n\n  if (missingFields.length > 0) {\n    throw new ValidationError(\n      `Missing required fields in DynamoDB item: ${missingFields.join(', ')}`,\n      { missing_fields: missingFields, item }\n    );\n  }\n\n  // Disclosureに変換\n  const disclosure: Disclosure = {\n    disclosure_id: item.disclosure_id.S ?? '',\n    company_code: item.company_code.S ?? '',\n    company_name: item.company_name.S ?? '',\n    disclosure_type: item.disclosure_type.S ?? '',\n    title: item.title.S ?? '',\n    disclosed_at: item.disclosed_at.S ?? '',\n    pdf_url: item.pdf_url.S ?? '',\n    s3_key: item.s3_key.S ?? '',\n    collected_at: item.collected_at.S ?? '',\n    date_partition: item.date_partition.S ?? '',\n  };\n\n  // バリデーション\n  validateDisclosure(disclosure);\n\n  return disclosure;\n}\n\n/**\n * Disclosureを作成する際のヘルパー関数\n *\n * date_partitionを自動生成し、collected_atを現在時刻に設定します。\n * Two-Phase Commit原則に従い、date_partitionは保存前に生成されます。\n *\n * @param params - Disclosure作成パラメータ（date_partition、collected_atは省略可能）\n * @returns 完全なDisclosure\n * @throws {ValidationError} バリデーションエラーの場合\n */\nexport function createDisclosure(\n  params: Omit<Disclosure, 'date_partition' | 'collected_at'> & {\n    date_partition?: string;\n    collected_at?: string;\n  }\n): Disclosure {\n  // date_partitionが指定されていない場合は自動生成\n  const date_partition = params.date_partition || generateDatePartition(params.disclosed_at);\n\n  // collected_atが指定されていない場合は現在時刻を使用\n  const collected_at = params.collected_at || new Date().toISOString();\n\n  const disclosure: Disclosure = {\n    ...params,\n    date_partition,\n    collected_at,\n  };\n\n  // バリデーション\n  validateDisclosure(disclosure);\n\n  return disclosure;\n}\n"],"version":3}