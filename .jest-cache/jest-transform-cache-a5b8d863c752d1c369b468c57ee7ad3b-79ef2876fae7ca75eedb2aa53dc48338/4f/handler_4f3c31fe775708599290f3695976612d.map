{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collect-status\\handler.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collect-status\\handler.ts"],"sourcesContent":["/**\r\n * Lambda Collect Status Handler\r\n *\r\n * GET /collect/{execution_id} エンドポイントのハンドラー。\r\n * 実行状態をDynamoDBから取得して返却します。\r\n *\r\n * Requirements: タスク13.2\r\n */\r\n\r\nimport { APIGatewayProxyEvent, APIGatewayProxyResult, Context } from 'aws-lambda';\r\nimport { DynamoDBClient, GetItemCommand } from '@aws-sdk/client-dynamodb';\r\nimport { unmarshall } from '@aws-sdk/util-dynamodb';\r\nimport { logger, createErrorContext } from '../../utils/logger';\r\nimport { sendErrorMetric } from '../../utils/cloudwatch-metrics';\r\nimport { ValidationError, NotFoundError } from '../../errors';\r\n\r\n// DynamoDB クライアントはグローバルスコープで初期化（再利用される）\r\nconst dynamoClient = new DynamoDBClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });\r\n\r\n// 環境変数\r\nconst EXECUTIONS_TABLE_NAME = process.env.DYNAMODB_EXECUTIONS_TABLE || 'tdnet_executions';\r\n\r\n/**\r\n * 実行状態\r\n */\r\ninterface ExecutionStatus {\r\n  /** 実行ID */\r\n  execution_id: string;\r\n\r\n  /** ステータス */\r\n  status: 'pending' | 'running' | 'completed' | 'failed';\r\n\r\n  /** 進捗率（0-100） */\r\n  progress: number;\r\n\r\n  /** 収集成功件数 */\r\n  collected_count: number;\r\n\r\n  /** 収集失敗件数 */\r\n  failed_count: number;\r\n\r\n  /** 開始日時（ISO 8601形式） */\r\n  started_at: string;\r\n\r\n  /** 更新日時（ISO 8601形式） */\r\n  updated_at: string;\r\n\r\n  /** 完了日時（ISO 8601形式、completed/failedの場合のみ） */\r\n  completed_at?: string;\r\n\r\n  /** エラーメッセージ（failedの場合のみ） */\r\n  error_message?: string;\r\n}\r\n\r\n/**\r\n * GET /collect/{execution_id} レスポンス\r\n */\r\ninterface CollectStatusResponse {\r\n  /** ステータス */\r\n  status: 'success';\r\n\r\n  /** データ */\r\n  data: ExecutionStatus;\r\n}\r\n\r\n/**\r\n * Lambda Collect Status ハンドラー\r\n *\r\n * @param event API Gateway Proxy Event\r\n * @param context Lambda Context\r\n * @returns API Gateway Proxy Result\r\n */\r\nexport async function handler(\r\n  event: APIGatewayProxyEvent,\r\n  context: Context\r\n): Promise<APIGatewayProxyResult> {\r\n  try {\r\n    logger.info('GET /collect/{execution_id} invoked', {\r\n      requestId: context.requestId,\r\n      functionName: context.functionName,\r\n      pathParameters: event.pathParameters,\r\n    });\r\n\r\n    // パスパラメータの取得\r\n    const execution_id = event.pathParameters?.execution_id;\r\n\r\n    // バリデーション\r\n    if (!execution_id) {\r\n      throw new ValidationError('execution_id is required');\r\n    }\r\n\r\n    // 実行状態を取得\r\n    const executionStatus = await getExecutionStatus(execution_id);\r\n\r\n    // レスポンス\r\n    const response: CollectStatusResponse = {\r\n      status: 'success',\r\n      data: executionStatus,\r\n    };\r\n\r\n    logger.info('GET /collect/{execution_id} completed', {\r\n      requestId: context.requestId,\r\n      execution_id,\r\n      status: executionStatus.status,\r\n    });\r\n\r\n    return {\r\n      statusCode: 200,\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Access-Control-Allow-Origin': '*',\r\n      },\r\n      body: JSON.stringify(response),\r\n    };\r\n  } catch (error) {\r\n    logger.error(\r\n      'GET /collect/{execution_id} failed',\r\n      createErrorContext(error as Error, {\r\n        requestId: context.requestId,\r\n        event,\r\n      })\r\n    );\r\n\r\n    // エラーメトリクス送信\r\n    await sendErrorMetric(\r\n      error instanceof Error ? error.constructor.name : 'Unknown',\r\n      'CollectStatus',\r\n      {}\r\n    );\r\n\r\n    return toErrorResponse(error as Error, context.requestId);\r\n  }\r\n}\r\n\r\n/**\r\n * 実行状態を取得\r\n *\r\n * @param execution_id 実行ID\r\n * @returns 実行状態\r\n * @throws NotFoundError 実行状態が存在しない場合\r\n */\r\nasync function getExecutionStatus(execution_id: string): Promise<ExecutionStatus> {\r\n  try {\r\n    logger.info('Getting execution status from DynamoDB', {\r\n      execution_id,\r\n      tableName: EXECUTIONS_TABLE_NAME,\r\n    });\r\n\r\n    const command = new GetItemCommand({\r\n      TableName: EXECUTIONS_TABLE_NAME,\r\n      Key: {\r\n        execution_id: { S: execution_id },\r\n      },\r\n    });\r\n\r\n    const result = await dynamoClient.send(command);\r\n\r\n    if (!result.Item) {\r\n      throw new NotFoundError(`Execution not found: ${execution_id}`);\r\n    }\r\n\r\n    const item = unmarshall(result.Item) as ExecutionStatus;\r\n\r\n    logger.info('Execution status retrieved successfully', {\r\n      execution_id,\r\n      status: item.status,\r\n      progress: item.progress,\r\n    });\r\n\r\n    return item;\r\n  } catch (error) {\r\n    if (error instanceof NotFoundError) {\r\n      throw error;\r\n    }\r\n\r\n    logger.error(\r\n      'Failed to get execution status from DynamoDB',\r\n      createErrorContext(error as Error, {\r\n        execution_id,\r\n        tableName: EXECUTIONS_TABLE_NAME,\r\n      })\r\n    );\r\n\r\n    throw new Error('Failed to retrieve execution status');\r\n  }\r\n}\r\n\r\n/**\r\n * エラーレスポンスを生成\r\n *\r\n * @param error Error\r\n * @param requestId リクエストID\r\n * @returns API Gateway Proxy Result\r\n */\r\nfunction toErrorResponse(error: Error, requestId: string): APIGatewayProxyResult {\r\n  const errorCodeMap: Record<string, { statusCode: number; code: string }> = {\r\n    ValidationError: { statusCode: 400, code: 'VALIDATION_ERROR' },\r\n    UnauthorizedError: { statusCode: 401, code: 'UNAUTHORIZED' },\r\n    ForbiddenError: { statusCode: 403, code: 'FORBIDDEN' },\r\n    NotFoundError: { statusCode: 404, code: 'NOT_FOUND' },\r\n    ConflictError: { statusCode: 409, code: 'CONFLICT' },\r\n    RateLimitError: { statusCode: 429, code: 'RATE_LIMIT_EXCEEDED' },\r\n    InternalError: { statusCode: 500, code: 'INTERNAL_ERROR' },\r\n    ServiceUnavailableError: { statusCode: 503, code: 'SERVICE_UNAVAILABLE' },\r\n    GatewayTimeoutError: { statusCode: 504, code: 'GATEWAY_TIMEOUT' },\r\n  };\r\n\r\n  const mapping = errorCodeMap[error.name] || {\r\n    statusCode: 500,\r\n    code: 'INTERNAL_ERROR',\r\n  };\r\n\r\n  return {\r\n    statusCode: mapping.statusCode,\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n      'Access-Control-Allow-Origin': '*',\r\n    },\r\n    body: JSON.stringify({\r\n      status: 'error',\r\n      error: {\r\n        code: mapping.code,\r\n        message: error.message,\r\n        details: (error as any).details || {},\r\n      },\r\n      request_id: requestId,\r\n    }),\r\n  };\r\n}\r\n"],"version":3}