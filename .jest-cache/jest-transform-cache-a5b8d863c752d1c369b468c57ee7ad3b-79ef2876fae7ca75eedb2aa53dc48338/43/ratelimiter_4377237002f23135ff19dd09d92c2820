ba78e76e06760b8cb8f225ae25d7184a
"use strict";
/**
 * RateLimiter - リクエストレート制限クラス
 *
 * TDnetへのリクエストを適切に制限し、過度な負荷をかけないようにする。
 * 連続リクエスト間で最小遅延時間を確保する。
 *
 * Steering準拠:
 * - development/tdnet-scraping-patterns.md: レート制限実装パターン
 * - core/error-handling-patterns.md: 構造化ログの記録
 *
 * @example
 * ```typescript
 * const rateLimiter = new RateLimiter({ minDelayMs: 2000 });
 *
 * for (const url of urls) {
 *     await rateLimiter.waitIfNeeded();
 *     const data = await fetchData(url);
 * }
 * ```
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.RateLimiter = void 0;
const logger_1 = require("./logger");
/**
 * レート制限を管理するクラス
 *
 * 連続リクエスト間で最小遅延時間を確保し、
 * 外部サービスへの過度な負荷を防ぐ。
 */
class RateLimiter {
    lastRequestTime = null;
    minDelayMs;
    /**
     * RateLimiterを初期化
     *
     * @param options - レート制限のオプション
     */
    constructor(options = { minDelayMs: 2000 }) {
        this.minDelayMs = options.minDelayMs;
    }
    /**
     * リクエスト前に呼び出し、必要に応じて待機する
     *
     * 最後のリクエストから最小遅延時間が経過していない場合、
     * 残り時間だけ待機する。
     *
     * Steering準拠: 構造化ログを記録（development/tdnet-scraping-patterns.md）
     *
     * @returns Promise<void>
     *
     * @example
     * ```typescript
     * const rateLimiter = new RateLimiter({ minDelayMs: 2000 });
     *
     * await rateLimiter.waitIfNeeded(); // 最初のリクエスト（即座に実行）
     * await rateLimiter.waitIfNeeded(); // 2回目のリクエスト（2000ms待機）
     * ```
     */
    async waitIfNeeded() {
        if (this.lastRequestTime === null) {
            // 最初のリクエストは即座に実行
            this.lastRequestTime = Date.now();
            logger_1.logger.debug('Rate limiter: first request, no delay');
            return;
        }
        const elapsed = Date.now() - this.lastRequestTime;
        const delay = this.minDelayMs - elapsed;
        if (delay > 0) {
            // 最小遅延時間が経過していない場合、残り時間だけ待機
            logger_1.logger.debug('Rate limiting: waiting', {
                waitTime: delay,
                minDelayMs: this.minDelayMs,
                elapsed,
            });
            await new Promise(resolve => setTimeout(resolve, delay));
        }
        this.lastRequestTime = Date.now();
    }
    /**
     * 最後のリクエスト時刻をリセット
     *
     * リセット後の最初のリクエストは即座に実行される。
     *
     * @example
     * ```typescript
     * const rateLimiter = new RateLimiter({ minDelayMs: 2000 });
     *
     * await rateLimiter.waitIfNeeded(); // 最初のリクエスト
     * rateLimiter.reset(); // リセット
     * await rateLimiter.waitIfNeeded(); // リセット後の最初のリクエスト（即座に実行）
     * ```
     */
    reset() {
        this.lastRequestTime = null;
    }
    /**
     * 最小遅延時間を取得
     *
     * @returns 最小遅延時間（ミリ秒）
     */
    getMinDelayMs() {
        return this.minDelayMs;
    }
    /**
     * 最後のリクエスト時刻を取得
     *
     * @returns 最後のリクエスト時刻（Unix時刻）、またはnull（リクエスト未実行）
     */
    getLastRequestTime() {
        return this.lastRequestTime;
    }
}
exports.RateLimiter = RateLimiter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFx1dGlsc1xccmF0ZS1saW1pdGVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW1CRzs7O0FBRUgscUNBQWtDO0FBYWxDOzs7OztHQUtHO0FBQ0gsTUFBYSxXQUFXO0lBQ1osZUFBZSxHQUFrQixJQUFJLENBQUM7SUFDdEMsVUFBVSxDQUFTO0lBRTNCOzs7O09BSUc7SUFDSCxZQUFZLFVBQThCLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRTtRQUMxRCxJQUFJLENBQUMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUM7SUFDekMsQ0FBQztJQUVEOzs7Ozs7Ozs7Ozs7Ozs7OztPQWlCRztJQUNILEtBQUssQ0FBQyxZQUFZO1FBQ2QsSUFBSSxJQUFJLENBQUMsZUFBZSxLQUFLLElBQUksRUFBRSxDQUFDO1lBQ2hDLGlCQUFpQjtZQUNqQixJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNsQyxlQUFNLENBQUMsS0FBSyxDQUFDLHVDQUF1QyxDQUFDLENBQUM7WUFDdEQsT0FBTztRQUNYLENBQUM7UUFFRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQztRQUNsRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsVUFBVSxHQUFHLE9BQU8sQ0FBQztRQUV4QyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUNaLDRCQUE0QjtZQUM1QixlQUFNLENBQUMsS0FBSyxDQUFDLHdCQUF3QixFQUFFO2dCQUNuQyxRQUFRLEVBQUUsS0FBSztnQkFDZixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7Z0JBQzNCLE9BQU87YUFDVixDQUFDLENBQUM7WUFDSCxNQUFNLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQzdELENBQUM7UUFFRCxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUN0QyxDQUFDO0lBRUQ7Ozs7Ozs7Ozs7Ozs7T0FhRztJQUNILEtBQUs7UUFDRCxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQztJQUNoQyxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILGFBQWE7UUFDVCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDM0IsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxrQkFBa0I7UUFDZCxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUM7SUFDaEMsQ0FBQztDQUNKO0FBMUZELGtDQTBGQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpMTk4XFxpbnZlc3RtZW50X2FuYWx5c2lzX29wb3BvXFxzcmNcXHV0aWxzXFxyYXRlLWxpbWl0ZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIFJhdGVMaW1pdGVyIC0g44Oq44Kv44Ko44K544OI44Os44O844OI5Yi26ZmQ44Kv44Op44K5XHJcbiAqIFxyXG4gKiBURG5ldOOBuOOBruODquOCr+OCqOOCueODiOOCkumBqeWIh+OBq+WItumZkOOBl+OAgemBjuW6puOBquiyoOiNt+OCkuOBi+OBkeOBquOBhOOCiOOBhuOBq+OBmeOCi+OAglxyXG4gKiDpgKPntprjg6rjgq/jgqjjgrnjg4jplpPjgafmnIDlsI/pgYXlu7bmmYLplpPjgpLnorrkv53jgZnjgovjgIJcclxuICogXHJcbiAqIFN0ZWVyaW5n5rqW5ougOlxyXG4gKiAtIGRldmVsb3BtZW50L3RkbmV0LXNjcmFwaW5nLXBhdHRlcm5zLm1kOiDjg6zjg7zjg4jliLbpmZDlrp/oo4Xjg5Hjgr/jg7zjg7NcclxuICogLSBjb3JlL2Vycm9yLWhhbmRsaW5nLXBhdHRlcm5zLm1kOiDmp4vpgKDljJbjg63jgrDjga7oqJjpjLJcclxuICogXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYHR5cGVzY3JpcHRcclxuICogY29uc3QgcmF0ZUxpbWl0ZXIgPSBuZXcgUmF0ZUxpbWl0ZXIoeyBtaW5EZWxheU1zOiAyMDAwIH0pO1xyXG4gKiBcclxuICogZm9yIChjb25zdCB1cmwgb2YgdXJscykge1xyXG4gKiAgICAgYXdhaXQgcmF0ZUxpbWl0ZXIud2FpdElmTmVlZGVkKCk7XHJcbiAqICAgICBjb25zdCBkYXRhID0gYXdhaXQgZmV0Y2hEYXRhKHVybCk7XHJcbiAqIH1cclxuICogYGBgXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi9sb2dnZXInO1xyXG5cclxuLyoqXHJcbiAqIFJhdGVMaW1pdGVy44Gu44Kq44OX44K344On44OzXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIFJhdGVMaW1pdGVyT3B0aW9ucyB7XHJcbiAgICAvKipcclxuICAgICAqIOacgOWwj+mBheW7tuaZgumWk++8iOODn+ODquenku+8iVxyXG4gICAgICogQGRlZmF1bHQgMjAwMFxyXG4gICAgICovXHJcbiAgICBtaW5EZWxheU1zOiBudW1iZXI7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjg6zjg7zjg4jliLbpmZDjgpLnrqHnkIbjgZnjgovjgq/jg6njgrlcclxuICogXHJcbiAqIOmAo+e2muODquOCr+OCqOOCueODiOmWk+OBp+acgOWwj+mBheW7tuaZgumWk+OCkueiuuS/neOBl+OAgVxyXG4gKiDlpJbpg6jjgrXjg7zjg5Pjgrnjgbjjga7pgY7luqbjgarosqDojbfjgpLpmLLjgZDjgIJcclxuICovXHJcbmV4cG9ydCBjbGFzcyBSYXRlTGltaXRlciB7XHJcbiAgICBwcml2YXRlIGxhc3RSZXF1ZXN0VGltZTogbnVtYmVyIHwgbnVsbCA9IG51bGw7XHJcbiAgICBwcml2YXRlIG1pbkRlbGF5TXM6IG51bWJlcjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIFJhdGVMaW1pdGVy44KS5Yid5pyf5YyWXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSBvcHRpb25zIC0g44Os44O844OI5Yi26ZmQ44Gu44Kq44OX44K344On44OzXHJcbiAgICAgKi9cclxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IFJhdGVMaW1pdGVyT3B0aW9ucyA9IHsgbWluRGVsYXlNczogMjAwMCB9KSB7XHJcbiAgICAgICAgdGhpcy5taW5EZWxheU1zID0gb3B0aW9ucy5taW5EZWxheU1zO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog44Oq44Kv44Ko44K544OI5YmN44Gr5ZG844Gz5Ye644GX44CB5b+F6KaB44Gr5b+c44GY44Gm5b6F5qmf44GZ44KLXHJcbiAgICAgKiBcclxuICAgICAqIOacgOW+jOOBruODquOCr+OCqOOCueODiOOBi+OCieacgOWwj+mBheW7tuaZgumWk+OBjOe1jOmBjuOBl+OBpuOBhOOBquOBhOWgtOWQiOOAgVxyXG4gICAgICog5q6L44KK5pmC6ZaT44Gg44GR5b6F5qmf44GZ44KL44CCXHJcbiAgICAgKiBcclxuICAgICAqIFN0ZWVyaW5n5rqW5ougOiDmp4vpgKDljJbjg63jgrDjgpLoqJjpjLLvvIhkZXZlbG9wbWVudC90ZG5ldC1zY3JhcGluZy1wYXR0ZXJucy5tZO+8iVxyXG4gICAgICogXHJcbiAgICAgKiBAcmV0dXJucyBQcm9taXNlPHZvaWQ+XHJcbiAgICAgKiBcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGB0eXBlc2NyaXB0XHJcbiAgICAgKiBjb25zdCByYXRlTGltaXRlciA9IG5ldyBSYXRlTGltaXRlcih7IG1pbkRlbGF5TXM6IDIwMDAgfSk7XHJcbiAgICAgKiBcclxuICAgICAqIGF3YWl0IHJhdGVMaW1pdGVyLndhaXRJZk5lZWRlZCgpOyAvLyDmnIDliJ3jga7jg6rjgq/jgqjjgrnjg4jvvIjljbPluqfjgavlrp/ooYzvvIlcclxuICAgICAqIGF3YWl0IHJhdGVMaW1pdGVyLndhaXRJZk5lZWRlZCgpOyAvLyAy5Zue55uu44Gu44Oq44Kv44Ko44K544OI77yIMjAwMG1z5b6F5qmf77yJXHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgYXN5bmMgd2FpdElmTmVlZGVkKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGlmICh0aGlzLmxhc3RSZXF1ZXN0VGltZSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAvLyDmnIDliJ3jga7jg6rjgq/jgqjjgrnjg4jjga/ljbPluqfjgavlrp/ooYxcclxuICAgICAgICAgICAgdGhpcy5sYXN0UmVxdWVzdFRpbWUgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgICAgICBsb2dnZXIuZGVidWcoJ1JhdGUgbGltaXRlcjogZmlyc3QgcmVxdWVzdCwgbm8gZGVsYXknKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgZWxhcHNlZCA9IERhdGUubm93KCkgLSB0aGlzLmxhc3RSZXF1ZXN0VGltZTtcclxuICAgICAgICBjb25zdCBkZWxheSA9IHRoaXMubWluRGVsYXlNcyAtIGVsYXBzZWQ7XHJcblxyXG4gICAgICAgIGlmIChkZWxheSA+IDApIHtcclxuICAgICAgICAgICAgLy8g5pyA5bCP6YGF5bu25pmC6ZaT44GM57WM6YGO44GX44Gm44GE44Gq44GE5aC05ZCI44CB5q6L44KK5pmC6ZaT44Gg44GR5b6F5qmfXHJcbiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnUmF0ZSBsaW1pdGluZzogd2FpdGluZycsIHtcclxuICAgICAgICAgICAgICAgIHdhaXRUaW1lOiBkZWxheSxcclxuICAgICAgICAgICAgICAgIG1pbkRlbGF5TXM6IHRoaXMubWluRGVsYXlNcyxcclxuICAgICAgICAgICAgICAgIGVsYXBzZWQsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgZGVsYXkpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMubGFzdFJlcXVlc3RUaW1lID0gRGF0ZS5ub3coKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOacgOW+jOOBruODquOCr+OCqOOCueODiOaZguWIu+OCkuODquOCu+ODg+ODiFxyXG4gICAgICogXHJcbiAgICAgKiDjg6rjgrvjg4Pjg4jlvozjga7mnIDliJ3jga7jg6rjgq/jgqjjgrnjg4jjga/ljbPluqfjgavlrp/ooYzjgZXjgozjgovjgIJcclxuICAgICAqIFxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYHR5cGVzY3JpcHRcclxuICAgICAqIGNvbnN0IHJhdGVMaW1pdGVyID0gbmV3IFJhdGVMaW1pdGVyKHsgbWluRGVsYXlNczogMjAwMCB9KTtcclxuICAgICAqIFxyXG4gICAgICogYXdhaXQgcmF0ZUxpbWl0ZXIud2FpdElmTmVlZGVkKCk7IC8vIOacgOWIneOBruODquOCr+OCqOOCueODiFxyXG4gICAgICogcmF0ZUxpbWl0ZXIucmVzZXQoKTsgLy8g44Oq44K744OD44OIXHJcbiAgICAgKiBhd2FpdCByYXRlTGltaXRlci53YWl0SWZOZWVkZWQoKTsgLy8g44Oq44K744OD44OI5b6M44Gu5pyA5Yid44Gu44Oq44Kv44Ko44K544OI77yI5Y2z5bqn44Gr5a6f6KGM77yJXHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgcmVzZXQoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5sYXN0UmVxdWVzdFRpbWUgPSBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5pyA5bCP6YGF5bu25pmC6ZaT44KS5Y+W5b6XXHJcbiAgICAgKiBcclxuICAgICAqIEByZXR1cm5zIOacgOWwj+mBheW7tuaZgumWk++8iOODn+ODquenku+8iVxyXG4gICAgICovXHJcbiAgICBnZXRNaW5EZWxheU1zKCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubWluRGVsYXlNcztcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOacgOW+jOOBruODquOCr+OCqOOCueODiOaZguWIu+OCkuWPluW+l1xyXG4gICAgICogXHJcbiAgICAgKiBAcmV0dXJucyDmnIDlvozjga7jg6rjgq/jgqjjgrnjg4jmmYLliLvvvIhVbml45pmC5Yi777yJ44CB44G+44Gf44GvbnVsbO+8iOODquOCr+OCqOOCueODiOacquWun+ihjO+8iVxyXG4gICAgICovXHJcbiAgICBnZXRMYXN0UmVxdWVzdFRpbWUoKTogbnVtYmVyIHwgbnVsbCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubGFzdFJlcXVlc3RUaW1lO1xyXG4gICAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==