{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\__tests__\\export-file-expiration.property.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\__tests__\\export-file-expiration.property.test.ts"],"sourcesContent":["/**\r\n * Property 10: エクスポートファイルの有効期限\r\n *\r\n * Validates: Requirements 7.2, 12.4\r\n * エクスポートファイルに7日後の自動削除ライフサイクルポリシーが適用されることを確認\r\n *\r\n * Requirements: 要件14.2（プロパティテスト）\r\n */\r\n\r\nimport * as fc from 'fast-check';\r\nimport { exportToS3 } from '../export-to-s3';\r\nimport { Disclosure } from '../../../types';\r\nimport { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';\r\nimport { mockClient } from 'aws-sdk-client-mock';\r\n\r\n// モック\r\njest.mock('../../../utils/logger');\r\njest.mock('../../../utils/retry', () => ({\r\n  retryWithBackoff: jest.fn((fn) => fn()),\r\n}));\r\n\r\ndescribe('Property 10: エクスポートファイルの有効期限', () => {\r\n  const s3Mock = mockClient(S3Client);\r\n\r\n  beforeEach(() => {\r\n    s3Mock.reset();\r\n    process.env.EXPORT_BUCKET_NAME = 'test-exports-bucket';\r\n    process.env.AWS_REGION = 'ap-northeast-1';\r\n\r\n    // S3Client.send のモック - PutObjectCommandを正しくキャプチャ\r\n    s3Mock.on(PutObjectCommand).resolves({});\r\n  });\r\n\r\n  /**\r\n   * Property: すべてのエクスポートファイルに auto-delete タグが設定される\r\n   *\r\n   * このプロパティは、エクスポートファイルがS3にアップロードされる際に、\r\n   * 必ず auto-delete=true タグが設定されることを検証します。\r\n   * このタグは、S3ライフサイクルポリシーによって7日後に自動削除されるために使用されます。\r\n   */\r\n  it('Property: すべてのエクスポートファイルに auto-delete タグが設定される', async () => {\r\n    await fc.assert(\r\n      fc.asyncProperty(\r\n        // Arbitrary: エクスポートID\r\n        fc.string({ minLength: 10, maxLength: 50 }),\r\n        // Arbitrary: フォーマット（json または csv）\r\n        fc.constantFrom('json' as const, 'csv' as const),\r\n        // Arbitrary: 開示情報のリスト（0〜100件）\r\n        fc.array(\r\n          fc.record({\r\n            disclosure_id: fc.string({ minLength: 10, maxLength: 20 }),\r\n            company_code: fc.stringOf(fc.integer({ min: 0, max: 9 }), { minLength: 4, maxLength: 4 }),\r\n            company_name: fc.string({ minLength: 1, maxLength: 100 }),\r\n            disclosure_type: fc.constantFrom('決算短信', '有価証券報告書', '適時開示'),\r\n            title: fc.string({ minLength: 1, maxLength: 200 }),\r\n            disclosed_at: fc\r\n              .date({ min: new Date('2020-01-01'), max: new Date('2025-12-31') })\r\n              .map((d) => d.toISOString()),\r\n            pdf_url: fc.webUrl(),\r\n            s3_key: fc.string({ minLength: 10, maxLength: 100 }),\r\n            collected_at: fc\r\n              .date({ min: new Date('2020-01-01'), max: new Date('2025-12-31') })\r\n              .map((d) => d.toISOString()),\r\n            date_partition: fc\r\n              .date({ min: new Date('2020-01-01'), max: new Date('2025-12-31') })\r\n              .map((d) => {\r\n                const year = d.getFullYear();\r\n                const month = String(d.getMonth() + 1).padStart(2, '0');\r\n                return `${year}-${month}`;\r\n              }),\r\n          }),\r\n          { minLength: 0, maxLength: 100 }\r\n        ),\r\n        async (export_id, format, disclosures) => {\r\n          // Arrange\r\n          s3Mock.reset();\r\n          s3Mock.on(PutObjectCommand).resolves({});\r\n\r\n          // Act\r\n          await exportToS3(export_id, disclosures as Disclosure[], format);\r\n\r\n          // Assert\r\n          expect(s3Mock.calls()).toHaveLength(1);\r\n          const call = s3Mock.call(0);\r\n          \r\n          // PutObjectCommandのinputプロパティにアクセス\r\n          expect(call.args[0].input).toBeDefined();\r\n          expect(call.args[0].input.Tagging).toBe('auto-delete=true');\r\n        }\r\n      ),\r\n      {\r\n        numRuns: 100, // 100回のランダムテストを実行\r\n        verbose: true,\r\n      }\r\n    );\r\n  });\r\n\r\n  /**\r\n   * Property: S3キーが正しいフォーマットで生成される\r\n   *\r\n   * このプロパティは、エクスポートファイルのS3キーが常に正しいフォーマット\r\n   * （exports/YYYY/MM/DD/export_id.format）で生成されることを検証します。\r\n   */\r\n  it('Property: S3キーが正しいフォーマットで生成される', async () => {\r\n    await fc.assert(\r\n      fc.asyncProperty(\r\n        // Arbitrary: エクスポートID（英数字とハイフンのみ、スラッシュや特殊文字を除外）\r\n        fc.stringMatching(/^[a-zA-Z0-9_-]{10,50}$/),\r\n        // Arbitrary: フォーマット（json または csv）\r\n        fc.constantFrom('json' as const, 'csv' as const),\r\n        // Arbitrary: 開示情報のリスト（0〜10件、パフォーマンスのため少なめ）\r\n        fc.array(\r\n          fc.record({\r\n            disclosure_id: fc.string({ minLength: 10, maxLength: 20 }),\r\n            company_code: fc.stringOf(fc.integer({ min: 0, max: 9 }), { minLength: 4, maxLength: 4 }),\r\n            company_name: fc.string({ minLength: 1, maxLength: 100 }),\r\n            disclosure_type: fc.constantFrom('決算短信', '有価証券報告書', '適時開示'),\r\n            title: fc.string({ minLength: 1, maxLength: 200 }),\r\n            disclosed_at: fc\r\n              .date({ min: new Date('2020-01-01'), max: new Date('2025-12-31') })\r\n              .map((d) => d.toISOString()),\r\n            pdf_url: fc.webUrl(),\r\n            s3_key: fc.string({ minLength: 10, maxLength: 100 }),\r\n            collected_at: fc\r\n              .date({ min: new Date('2020-01-01'), max: new Date('2025-12-31') })\r\n              .map((d) => d.toISOString()),\r\n            date_partition: fc\r\n              .date({ min: new Date('2020-01-01'), max: new Date('2025-12-31') })\r\n              .map((d) => {\r\n                const year = d.getFullYear();\r\n                const month = String(d.getMonth() + 1).padStart(2, '0');\r\n                return `${year}-${month}`;\r\n              }),\r\n          }),\r\n          { minLength: 0, maxLength: 10 }\r\n        ),\r\n        async (export_id, format, disclosures) => {\r\n          // Act\r\n          const s3_key = await exportToS3(export_id, disclosures as Disclosure[], format);\r\n\r\n          // Assert\r\n          // Property: S3キーが正しいフォーマット（exports/YYYY/MM/DD/export_id.format）\r\n          const s3KeyRegex = new RegExp(\r\n            `^exports/\\\\d{4}/\\\\d{2}/\\\\d{2}/[^/]+\\\\.${format}$`\r\n          );\r\n          expect(s3_key).toMatch(s3KeyRegex);\r\n        }\r\n      ),\r\n      {\r\n        numRuns: 100,\r\n        verbose: true,\r\n      }\r\n    );\r\n  });\r\n\r\n  /**\r\n   * Property: ContentTypeが正しく設定される\r\n   *\r\n   * このプロパティは、エクスポートファイルのContentTypeが\r\n   * フォーマットに応じて正しく設定されることを検証します。\r\n   * - JSON: application/json\r\n   * - CSV: text/csv\r\n   */\r\n  it('Property: ContentTypeが正しく設定される', async () => {\r\n    await fc.assert(\r\n      fc.asyncProperty(\r\n        // Arbitrary: エクスポートID\r\n        fc.string({ minLength: 10, maxLength: 50 }),\r\n        // Arbitrary: フォーマット（json または csv）\r\n        fc.constantFrom('json' as const, 'csv' as const),\r\n        // Arbitrary: 開示情報のリスト（0〜10件）\r\n        fc.array(\r\n          fc.record({\r\n            disclosure_id: fc.string({ minLength: 10, maxLength: 20 }),\r\n            company_code: fc.stringOf(fc.integer({ min: 0, max: 9 }), { minLength: 4, maxLength: 4 }),\r\n            company_name: fc.string({ minLength: 1, maxLength: 100 }),\r\n            disclosure_type: fc.constantFrom('決算短信', '有価証券報告書', '適時開示'),\r\n            title: fc.string({ minLength: 1, maxLength: 200 }),\r\n            disclosed_at: fc\r\n              .date({ min: new Date('2020-01-01'), max: new Date('2025-12-31') })\r\n              .map((d) => d.toISOString()),\r\n            pdf_url: fc.webUrl(),\r\n            s3_key: fc.string({ minLength: 10, maxLength: 100 }),\r\n            collected_at: fc\r\n              .date({ min: new Date('2020-01-01'), max: new Date('2025-12-31') })\r\n              .map((d) => d.toISOString()),\r\n            date_partition: fc\r\n              .date({ min: new Date('2020-01-01'), max: new Date('2025-12-31') })\r\n              .map((d) => {\r\n                const year = d.getFullYear();\r\n                const month = String(d.getMonth() + 1).padStart(2, '0');\r\n                return `${year}-${month}`;\r\n              }),\r\n          }),\r\n          { minLength: 0, maxLength: 10 }\r\n        ),\r\n        async (export_id, format, disclosures) => {\r\n          // Arrange\r\n          s3Mock.reset();\r\n          s3Mock.on(PutObjectCommand).resolves({});\r\n\r\n          // Act\r\n          await exportToS3(export_id, disclosures as Disclosure[], format);\r\n\r\n          // Assert\r\n          expect(s3Mock.calls()).toHaveLength(1);\r\n          const call = s3Mock.call(0);\r\n          \r\n          // PutObjectCommandのinputプロパティにアクセス\r\n          expect(call.args[0].input).toBeDefined();\r\n          const contentType = call.args[0].input.ContentType;\r\n\r\n          // Property: ContentTypeが正しく設定されている\r\n          const expectedContentType = format === 'json' ? 'application/json' : 'text/csv';\r\n          expect(contentType).toBe(expectedContentType);\r\n        }\r\n      ),\r\n      {\r\n        numRuns: 100,\r\n        verbose: true,\r\n      }\r\n    );\r\n  });\r\n\r\n  /**\r\n   * Property: CSV形式の場合、カンマを含む値が正しくエスケープされる\r\n   *\r\n   * このプロパティは、CSV形式でエクスポートする際に、\r\n   * カンマを含む値が正しくダブルクォートで囲まれることを検証します。\r\n   */\r\n  it('Property: CSV形式の場合、カンマを含む値が正しくエスケープされる', async () => {\r\n    await fc.assert(\r\n      fc.asyncProperty(\r\n        // Arbitrary: エクスポートID（英数字とハイフンのみ）\r\n        fc.stringMatching(/^[a-zA-Z0-9_-]{10,50}$/),\r\n        // Arbitrary: カンマを含むタイトル（ダブルクォートを除外）\r\n        fc.string({ minLength: 1, maxLength: 50 }).filter(s => !s.includes('\"')).map((s) => `${s}, カンマ含む`),\r\n        async (export_id, titleWithComma) => {\r\n          // Arrange\r\n          const disclosures: Disclosure[] = [\r\n            {\r\n              disclosure_id: '20240115_1234_001',\r\n              company_code: '1234',\r\n              company_name: 'テスト株式会社',\r\n              disclosure_type: '決算短信',\r\n              title: titleWithComma,\r\n              disclosed_at: '2024-01-15T10:30:00Z',\r\n              pdf_url: 'https://example.com/pdf/20240115_1234_001.pdf',\r\n              s3_key: 'pdfs/2024/01/15/20240115_1234_001.pdf',\r\n              collected_at: '2024-01-15T10:35:00Z',\r\n              date_partition: '2024-01',\r\n            },\r\n          ];\r\n\r\n          // Arrange\r\n          s3Mock.reset();\r\n          s3Mock.on(PutObjectCommand).resolves({});\r\n\r\n          // Act\r\n          await exportToS3(export_id, disclosures, 'csv');\r\n\r\n          // Assert\r\n          expect(s3Mock.calls()).toHaveLength(1);\r\n          const call = s3Mock.call(0);\r\n          \r\n          // PutObjectCommandのinputプロパティにアクセス\r\n          expect(call.args[0].input).toBeDefined();\r\n          const body = call.args[0].input.Body;\r\n          const lines = body.split('\\n');\r\n\r\n          // Property: カンマを含む値がダブルクォートで囲まれている\r\n          expect(lines[1]).toContain(`\"${titleWithComma}\"`);\r\n        }\r\n      ),\r\n      {\r\n        numRuns: 50,\r\n        verbose: true,\r\n      }\r\n    );\r\n  });\r\n});\r\n"],"version":3}