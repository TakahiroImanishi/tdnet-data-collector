{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\query\\generate-presigned-url.ts","mappings":";AAAA;;;;;;;GAOG;;AA2BH,oDAkCC;AASD,sDAsBC;AA1FD,kDAAgE;AAChE,wEAA6D;AAC7D,+CAA4C;AAE5C,0BAA0B;AAC1B,MAAM,QAAQ,GAAG,IAAI,oBAAQ,CAAC;IAC5B,MAAM,EAAE,OAAO,CAAC,GAAG,CAAC,UAAU,IAAI,gBAAgB;CACnD,CAAC,CAAC;AAEH,MAAM,WAAW,GAAG,OAAO,CAAC,GAAG,CAAC,cAAc,IAAI,2BAA2B,CAAC;AAC9E,MAAM,sBAAsB,GAAG,IAAI,CAAC,CAAC,MAAM;AAE3C;;;;;;;;;;;;GAYG;AACI,KAAK,UAAU,oBAAoB,CACxC,KAAa,EACb,YAAoB,sBAAsB;IAE1C,IAAI,CAAC;QACH,eAAM,CAAC,IAAI,CAAC,0BAA0B,EAAE;YACtC,MAAM,EAAE,KAAK;YACb,MAAM,EAAE,WAAW;YACnB,UAAU,EAAE,SAAS;SACtB,CAAC,CAAC;QAEH,MAAM,OAAO,GAAG,IAAI,4BAAgB,CAAC;YACnC,MAAM,EAAE,WAAW;YACnB,GAAG,EAAE,KAAK;SACX,CAAC,CAAC;QAEH,MAAM,GAAG,GAAG,MAAM,IAAA,mCAAY,EAAC,QAAQ,EAAE,OAAO,EAAE;YAChD,SAAS;SACV,CAAC,CAAC;QAEH,eAAM,CAAC,IAAI,CAAC,sCAAsC,EAAE;YAClD,MAAM,EAAE,KAAK;YACb,UAAU,EAAE,GAAG,CAAC,MAAM;SACvB,CAAC,CAAC;QAEH,OAAO,GAAG,CAAC;IACb,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,eAAM,CAAC,KAAK,CAAC,kCAAkC,EAAE;YAC/C,MAAM,EAAE,KAAK;YACb,MAAM,EAAE,WAAW;YACnB,KAAK,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC;SAC9D,CAAC,CAAC;QACH,MAAM,KAAK,CAAC;IACd,CAAC;AACH,CAAC;AAED;;;;;;GAMG;AACI,KAAK,UAAU,qBAAqB,CACzC,MAAgB,EAChB,YAAoB,sBAAsB;IAE1C,MAAM,MAAM,GAAG,IAAI,GAAG,EAAkB,CAAC;IAEzC,MAAM,OAAO,CAAC,GAAG,CACf,MAAM,CAAC,GAAG,CAAC,KAAK,EAAE,KAAK,EAAE,EAAE;QACzB,IAAI,CAAC;YACH,MAAM,GAAG,GAAG,MAAM,oBAAoB,CAAC,KAAK,EAAE,SAAS,CAAC,CAAC;YACzD,MAAM,CAAC,GAAG,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;QACzB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,eAAM,CAAC,KAAK,CAAC,0CAA0C,EAAE;gBACvD,MAAM,EAAE,KAAK;gBACb,KAAK,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC;aAC9D,CAAC,CAAC;YACH,oBAAoB;QACtB,CAAC;IACH,CAAC,CAAC,CACH,CAAC;IAEF,OAAO,MAAM,CAAC;AAChB,CAAC","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\query\\generate-presigned-url.ts"],"sourcesContent":["/**\r\n * Generate Presigned URL\r\n *\r\n * S3署名付きURLを生成します。\r\n * PDFファイルのダウンロード用に使用されます。\r\n *\r\n * Requirements: 要件4.4（PDFダウンロード）\r\n */\r\n\r\nimport { S3Client, GetObjectCommand } from '@aws-sdk/client-s3';\r\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\r\nimport { logger } from '../../utils/logger';\r\n\r\n// S3クライアント（グローバルスコープで初期化）\r\nconst s3Client = new S3Client({\r\n  region: process.env.AWS_REGION || 'ap-northeast-1',\r\n});\r\n\r\nconst BUCKET_NAME = process.env.S3_BUCKET_NAME || 'tdnet-data-collector-pdfs';\r\nconst URL_EXPIRATION_SECONDS = 3600; // 1時間\r\n\r\n/**\r\n * S3署名付きURLを生成\r\n *\r\n * @param s3Key S3キー（PDFファイルのパス）\r\n * @param expiresIn 有効期限（秒）デフォルト: 3600秒（1時間）\r\n * @returns 署名付きURL\r\n *\r\n * @example\r\n * ```typescript\r\n * const url = await generatePresignedUrl('2024/01/15/TD20240115001_7203.pdf');\r\n * // => \"https://tdnet-pdfs.s3.amazonaws.com/2024/01/15/TD20240115001_7203.pdf?X-Amz-...\"\r\n * ```\r\n */\r\nexport async function generatePresignedUrl(\r\n  s3Key: string,\r\n  expiresIn: number = URL_EXPIRATION_SECONDS\r\n): Promise<string> {\r\n  try {\r\n    logger.info('Generating presigned URL', {\r\n      s3_key: s3Key,\r\n      bucket: BUCKET_NAME,\r\n      expires_in: expiresIn,\r\n    });\r\n\r\n    const command = new GetObjectCommand({\r\n      Bucket: BUCKET_NAME,\r\n      Key: s3Key,\r\n    });\r\n\r\n    const url = await getSignedUrl(s3Client, command, {\r\n      expiresIn,\r\n    });\r\n\r\n    logger.info('Presigned URL generated successfully', {\r\n      s3_key: s3Key,\r\n      url_length: url.length,\r\n    });\r\n\r\n    return url;\r\n  } catch (error) {\r\n    logger.error('Failed to generate presigned URL', {\r\n      s3_key: s3Key,\r\n      bucket: BUCKET_NAME,\r\n      error: error instanceof Error ? error.message : String(error),\r\n    });\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * 複数のS3署名付きURLを一括生成\r\n *\r\n * @param s3Keys S3キーのリスト\r\n * @param expiresIn 有効期限（秒）デフォルト: 3600秒（1時間）\r\n * @returns 署名付きURLのマップ（キー: S3キー、値: 署名付きURL）\r\n */\r\nexport async function generatePresignedUrls(\r\n  s3Keys: string[],\r\n  expiresIn: number = URL_EXPIRATION_SECONDS\r\n): Promise<Map<string, string>> {\r\n  const urlMap = new Map<string, string>();\r\n\r\n  await Promise.all(\r\n    s3Keys.map(async (s3Key) => {\r\n      try {\r\n        const url = await generatePresignedUrl(s3Key, expiresIn);\r\n        urlMap.set(s3Key, url);\r\n      } catch (error) {\r\n        logger.error('Failed to generate presigned URL for key', {\r\n          s3_key: s3Key,\r\n          error: error instanceof Error ? error.message : String(error),\r\n        });\r\n        // エラーが発生してもスキップして継続\r\n      }\r\n    })\r\n  );\r\n\r\n  return urlMap;\r\n}\r\n"],"version":3}