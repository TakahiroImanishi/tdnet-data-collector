{"version":3,"names":["cov_25a83aii25","path","hash","global","Function","gcv","coverageData","statementMap","start","line","column","end","fnMap","name","decl","loc","branchMap","type","locations","s","f","b","inputSourceMap","file","mappings","names","sources","sourcesContent","version","_coverageSchema","coverage","actualCoverage","exports","generatePresignedUrl","generatePresignedUrls","client_s3_1","require","s3_request_presigner_1","logger_1","s3Client","S3Client","region","process","env","AWS_REGION","BUCKET_NAME","S3_BUCKET_NAME","URL_EXPIRATION_SECONDS","s3Key","expiresIn","logger","info","s3_key","bucket","expires_in","command","GetObjectCommand","Bucket","Key","url","getSignedUrl","url_length","length","error","Error","message","String","s3Keys","urlMap","Map","Promise","all","map","set"],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\query\\generate-presigned-url.ts"],"sourcesContent":["/**\r\n * Generate Presigned URL\r\n *\r\n * S3署名付きURLを生成します。\r\n * PDFファイルのダウンロード用に使用されます。\r\n *\r\n * Requirements: 要件4.4（PDFダウンロード）\r\n */\r\n\r\nimport { S3Client, GetObjectCommand } from '@aws-sdk/client-s3';\r\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\r\nimport { logger } from '../../utils/logger';\r\n\r\n// S3クライアント（グローバルスコープで初期化）\r\nconst s3Client = new S3Client({\r\n  region: process.env.AWS_REGION || 'ap-northeast-1',\r\n});\r\n\r\nconst BUCKET_NAME = process.env.S3_BUCKET_NAME || 'tdnet-data-collector-pdfs';\r\nconst URL_EXPIRATION_SECONDS = 3600; // 1時間\r\n\r\n/**\r\n * S3署名付きURLを生成\r\n *\r\n * @param s3Key S3キー（PDFファイルのパス）\r\n * @param expiresIn 有効期限（秒）デフォルト: 3600秒（1時間）\r\n * @returns 署名付きURL\r\n *\r\n * @example\r\n * ```typescript\r\n * const url = await generatePresignedUrl('2024/01/15/TD20240115001_7203.pdf');\r\n * // => \"https://tdnet-pdfs.s3.amazonaws.com/2024/01/15/TD20240115001_7203.pdf?X-Amz-...\"\r\n * ```\r\n */\r\nexport async function generatePresignedUrl(\r\n  s3Key: string,\r\n  expiresIn: number = URL_EXPIRATION_SECONDS\r\n): Promise<string> {\r\n  try {\r\n    logger.info('Generating presigned URL', {\r\n      s3_key: s3Key,\r\n      bucket: BUCKET_NAME,\r\n      expires_in: expiresIn,\r\n    });\r\n\r\n    const command = new GetObjectCommand({\r\n      Bucket: BUCKET_NAME,\r\n      Key: s3Key,\r\n    });\r\n\r\n    const url = await getSignedUrl(s3Client, command, {\r\n      expiresIn,\r\n    });\r\n\r\n    logger.info('Presigned URL generated successfully', {\r\n      s3_key: s3Key,\r\n      url_length: url.length,\r\n    });\r\n\r\n    return url;\r\n  } catch (error) {\r\n    logger.error('Failed to generate presigned URL', {\r\n      s3_key: s3Key,\r\n      bucket: BUCKET_NAME,\r\n      error: error instanceof Error ? error.message : String(error),\r\n    });\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * 複数のS3署名付きURLを一括生成\r\n *\r\n * @param s3Keys S3キーのリスト\r\n * @param expiresIn 有効期限（秒）デフォルト: 3600秒（1時間）\r\n * @returns 署名付きURLのマップ（キー: S3キー、値: 署名付きURL）\r\n */\r\nexport async function generatePresignedUrls(\r\n  s3Keys: string[],\r\n  expiresIn: number = URL_EXPIRATION_SECONDS\r\n): Promise<Map<string, string>> {\r\n  const urlMap = new Map<string, string>();\r\n\r\n  await Promise.all(\r\n    s3Keys.map(async (s3Key) => {\r\n      try {\r\n        const url = await generatePresignedUrl(s3Key, expiresIn);\r\n        urlMap.set(s3Key, url);\r\n      } catch (error) {\r\n        logger.error('Failed to generate presigned URL for key', {\r\n          s3_key: s3Key,\r\n          error: error instanceof Error ? error.message : String(error),\r\n        });\r\n        // エラーが発生してもスキップして継続\r\n      }\r\n    })\r\n  );\r\n\r\n  return urlMap;\r\n}\r\n"],"mappings":";;AAAA;;;;;;;;AAAA;AAAA,SAAAA,eAAA;EAAA,IAAAC,IAAA;EAAA,IAAAC,IAAA;EAAA,IAAAC,MAAA,OAAAC,QAAA;EAAA,IAAAC,GAAA;EAAA,IAAAC,YAAA;IAAAL,IAAA;IAAAM,YAAA;MAAA;QAAAC,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;IAAA;IAAAE,KAAA;MAAA;QAAAC,IAAA;QAAAC,IAAA;UAAAN,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAK,GAAA;UAAAP,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAD,IAAA;MAAA;MAAA;QAAAI,IAAA;QAAAC,IAAA;UAAAN,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAK,GAAA;UAAAP,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAD,IAAA;MAAA;MAAA;QAAAI,IAAA;QAAAC,IAAA;UAAAN,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAK,GAAA;UAAAP,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAD,IAAA;MAAA;IAAA;IAAAO,SAAA;MAAA;QAAAD,GAAA;UAAAP,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAO,IAAA;QAAAC,SAAA;UAAAV,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;UAAAF,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAD,IAAA;MAAA;MAAA;QAAAM,GAAA;UAAAP,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAO,IAAA;QAAAC,SAAA;UAAAV,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;UAAAF,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAD,IAAA;MAAA;MAAA;QAAAM,GAAA;UAAAP,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAO,IAAA;QAAAC,SAAA;UAAAV,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAD,IAAA;MAAA;MAAA;QAAAM,GAAA;UAAAP,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAO,IAAA;QAAAC,SAAA;UAAAV,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;UAAAF,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAD,IAAA;MAAA;MAAA;QAAAM,GAAA;UAAAP,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAO,IAAA;QAAAC,SAAA;UAAAV,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAD,IAAA;MAAA;MAAA;QAAAM,GAAA;UAAAP,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAO,IAAA;QAAAC,SAAA;UAAAV,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;UAAAF,KAAA;YAAAC,IAAA;YAAAC,MAAA;UAAA;UAAAC,GAAA;YAAAF,IAAA;YAAAC,MAAA;UAAA;QAAA;QAAAD,IAAA;MAAA;IAAA;IAAAU,CAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;IAAA;IAAAC,CAAA;MAAA;MAAA;MAAA;IAAA;IAAAC,CAAA;MAAA;MAAA;MAAA;MAAA;MAAA;MAAA;IAAA;IAAAC,cAAA;MAAAC,IAAA;MAAAC,QAAA;MAAAC,KAAA;MAAAC,OAAA;MAAAC,cAAA;MAAAC,OAAA;IAAA;IAAAC,eAAA;IAAA3B,IAAA;EAAA;EAAA,IAAA4B,QAAA,GAAA3B,MAAA,CAAAE,GAAA,MAAAF,MAAA,CAAAE,GAAA;EAAA,KAAAyB,QAAA,CAAA7B,IAAA,KAAA6B,QAAA,CAAA7B,IAAA,EAAAC,IAAA,KAAAA,IAAA;IAAA4B,QAAA,CAAA7B,IAAA,IAAAK,YAAA;EAAA;EAAA,IAAAyB,cAAA,GAAAD,QAAA,CAAA7B,IAAA;EAAA;IAaA;IAAAD,cAAA,YAAAA,CAAA;MAAA,OAAA+B,cAAA;IAAA;EAAA;EAAA,OAAAA,cAAA;AAAA;AAAA/B,cAAA;AAAAA,cAAA,GAAAmB,CAAA;;;;;;AAqBAa,OAAA,CAAAC,oBAAA,GAAAA,oBAAA;AAkCC;AAAAjC,cAAA,GAAAmB,CAAA;AASDa,OAAA,CAAAE,qBAAA,GAAAA,qBAAA;AApEA,MAAAC,WAAA;AAAA;AAAA,CAAAnC,cAAA,GAAAmB,CAAA,OAAAiB,OAAA;AACA,MAAAC,sBAAA;AAAA;AAAA,CAAArC,cAAA,GAAAmB,CAAA,OAAAiB,OAAA;AACA,MAAAE,QAAA;AAAA;AAAA,CAAAtC,cAAA,GAAAmB,CAAA,OAAAiB,OAAA;AAEA;AACA,MAAMG,QAAQ;AAAA;AAAA,CAAAvC,cAAA,GAAAmB,CAAA,OAAG,IAAIgB,WAAA,CAAAK,QAAQ,CAAC;EAC5BC,MAAM;EAAE;EAAA,CAAAzC,cAAA,GAAAqB,CAAA,UAAAqB,OAAO,CAACC,GAAG,CAACC,UAAU;EAAA;EAAA,CAAA5C,cAAA,GAAAqB,CAAA,UAAI,gBAAgB;CACnD,CAAC;AAEF,MAAMwB,WAAW;AAAA;AAAA,CAAA7C,cAAA,GAAAmB,CAAA;AAAG;AAAA,CAAAnB,cAAA,GAAAqB,CAAA,UAAAqB,OAAO,CAACC,GAAG,CAACG,cAAc;AAAA;AAAA,CAAA9C,cAAA,GAAAqB,CAAA,UAAI,2BAA2B;AAC7E,MAAM0B,sBAAsB;AAAA;AAAA,CAAA/C,cAAA,GAAAmB,CAAA,OAAG,IAAI,EAAC,CAAC;AAErC;;;;;;;;;;;;;AAaO,eAAec,oBAAoBA,CACxCe,KAAa,EACbC,SAAA;AAAA;AAAA,CAAAjD,cAAA,GAAAqB,CAAA,UAAoB0B,sBAAsB;EAAA;EAAA/C,cAAA,GAAAoB,CAAA;EAAApB,cAAA,GAAAmB,CAAA;EAE1C,IAAI;IAAA;IAAAnB,cAAA,GAAAmB,CAAA;IACFmB,QAAA,CAAAY,MAAM,CAACC,IAAI,CAAC,0BAA0B,EAAE;MACtCC,MAAM,EAAEJ,KAAK;MACbK,MAAM,EAAER,WAAW;MACnBS,UAAU,EAAEL;KACb,CAAC;IAEF,MAAMM,OAAO;IAAA;IAAA,CAAAvD,cAAA,GAAAmB,CAAA,QAAG,IAAIgB,WAAA,CAAAqB,gBAAgB,CAAC;MACnCC,MAAM,EAAEZ,WAAW;MACnBa,GAAG,EAAEV;KACN,CAAC;IAEF,MAAMW,GAAG;IAAA;IAAA,CAAA3D,cAAA,GAAAmB,CAAA,QAAG,MAAM,IAAAkB,sBAAA,CAAAuB,YAAY,EAACrB,QAAQ,EAAEgB,OAAO,EAAE;MAChDN;KACD,CAAC;IAAC;IAAAjD,cAAA,GAAAmB,CAAA;IAEHmB,QAAA,CAAAY,MAAM,CAACC,IAAI,CAAC,sCAAsC,EAAE;MAClDC,MAAM,EAAEJ,KAAK;MACba,UAAU,EAAEF,GAAG,CAACG;KACjB,CAAC;IAAC;IAAA9D,cAAA,GAAAmB,CAAA;IAEH,OAAOwC,GAAG;EACZ,CAAC,CAAC,OAAOI,KAAK,EAAE;IAAA;IAAA/D,cAAA,GAAAmB,CAAA;IACdmB,QAAA,CAAAY,MAAM,CAACa,KAAK,CAAC,kCAAkC,EAAE;MAC/CX,MAAM,EAAEJ,KAAK;MACbK,MAAM,EAAER,WAAW;MACnBkB,KAAK,EAAEA,KAAK,YAAYC,KAAK;MAAA;MAAA,CAAAhE,cAAA,GAAAqB,CAAA,UAAG0C,KAAK,CAACE,OAAO;MAAA;MAAA,CAAAjE,cAAA,GAAAqB,CAAA,UAAG6C,MAAM,CAACH,KAAK,CAAC;KAC9D,CAAC;IAAC;IAAA/D,cAAA,GAAAmB,CAAA;IACH,MAAM4C,KAAK;EACb;AACF;AAEA;;;;;;;AAOO,eAAe7B,qBAAqBA,CACzCiC,MAAgB,EAChBlB,SAAA;AAAA;AAAA,CAAAjD,cAAA,GAAAqB,CAAA,UAAoB0B,sBAAsB;EAAA;EAAA/C,cAAA,GAAAoB,CAAA;EAE1C,MAAMgD,MAAM;EAAA;EAAA,CAAApE,cAAA,GAAAmB,CAAA,QAAG,IAAIkD,GAAG,EAAkB;EAAC;EAAArE,cAAA,GAAAmB,CAAA;EAEzC,MAAMmD,OAAO,CAACC,GAAG,CACfJ,MAAM,CAACK,GAAG,CAAC,MAAOxB,KAAK,IAAI;IAAA;IAAAhD,cAAA,GAAAoB,CAAA;IAAApB,cAAA,GAAAmB,CAAA;IACzB,IAAI;MACF,MAAMwC,GAAG;MAAA;MAAA,CAAA3D,cAAA,GAAAmB,CAAA,QAAG,MAAMc,oBAAoB,CAACe,KAAK,EAAEC,SAAS,CAAC;MAAC;MAAAjD,cAAA,GAAAmB,CAAA;MACzDiD,MAAM,CAACK,GAAG,CAACzB,KAAK,EAAEW,GAAG,CAAC;IACxB,CAAC,CAAC,OAAOI,KAAK,EAAE;MAAA;MAAA/D,cAAA,GAAAmB,CAAA;MACdmB,QAAA,CAAAY,MAAM,CAACa,KAAK,CAAC,0CAA0C,EAAE;QACvDX,MAAM,EAAEJ,KAAK;QACbe,KAAK,EAAEA,KAAK,YAAYC,KAAK;QAAA;QAAA,CAAAhE,cAAA,GAAAqB,CAAA,UAAG0C,KAAK,CAACE,OAAO;QAAA;QAAA,CAAAjE,cAAA,GAAAqB,CAAA,UAAG6C,MAAM,CAACH,KAAK,CAAC;OAC9D,CAAC;MACF;IACF;EACF,CAAC,CAAC,CACH;EAAC;EAAA/D,cAAA,GAAAmB,CAAA;EAEF,OAAOiD,MAAM;AACf","ignoreList":[]}