{"version":3,"names":["cov_2jghjlsqoq","path","hash","global","Function","gcv","coverageData","statementMap","start","line","column","end","fnMap","name","decl","loc","branchMap","type","locations","s","f","b","inputSourceMap","file","mappings","names","sources","sourcesContent","version","_coverageSchema","coverage","actualCoverage","exports","processExport","logger_1","require","query_disclosures_1","export_to_s3_1","update_export_status_1","generate_signed_url_1","export_id","requestBody","logger","info","format","filter","updateExportStatus","disclosures","queryDisclosures","count","length","s3_key","exportToS3","download_url","generateSignedUrl","error","createErrorContext","undefined","Error","message","String"],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\process-export.ts"],"sourcesContent":["/**\r\n * エクスポート処理\r\n *\r\n * データ取得、進捗更新、S3へのエクスポート、署名付きURL生成を実行します。\r\n *\r\n * Requirements: 要件5.1, 5.4（エクスポート、進捗）\r\n */\r\n\r\nimport { logger, createErrorContext } from '../../utils/logger';\r\nimport { ExportRequestBody } from './types';\r\nimport { queryDisclosures } from './query-disclosures';\r\nimport { exportToS3 } from './export-to-s3';\r\nimport { updateExportStatus } from './update-export-status';\r\nimport { generateSignedUrl } from './generate-signed-url';\r\n\r\n/**\r\n * エクスポート処理を実行\r\n *\r\n * 1. データ取得（queryDisclosures使用）\r\n * 2. 進捗更新（10%、50%、90%、100%）\r\n * 3. S3へのエクスポート\r\n * 4. 署名付きURL生成（有効期限7日）\r\n *\r\n * @param export_id エクスポートID\r\n * @param requestBody エクスポートリクエストボディ\r\n */\r\nexport async function processExport(\r\n  export_id: string,\r\n  requestBody: ExportRequestBody\r\n): Promise<void> {\r\n  try {\r\n    logger.info('Starting export processing', {\r\n      export_id,\r\n      format: requestBody.format,\r\n      filter: requestBody.filter,\r\n    });\r\n\r\n    // ステータスを processing に更新（進捗10%）\r\n    await updateExportStatus(export_id, 'processing', 10);\r\n\r\n    // データ取得\r\n    logger.info('Querying disclosures', {\r\n      export_id,\r\n      filter: requestBody.filter,\r\n    });\r\n\r\n    const disclosures = await queryDisclosures(requestBody.filter);\r\n\r\n    logger.info('Disclosures queried successfully', {\r\n      export_id,\r\n      count: disclosures.length,\r\n    });\r\n\r\n    // 進捗更新（50%）\r\n    await updateExportStatus(export_id, 'processing', 50);\r\n\r\n    // S3へのエクスポート\r\n    logger.info('Exporting to S3', {\r\n      export_id,\r\n      format: requestBody.format,\r\n      count: disclosures.length,\r\n    });\r\n\r\n    const s3_key = await exportToS3(export_id, disclosures, requestBody.format);\r\n\r\n    logger.info('Exported to S3 successfully', {\r\n      export_id,\r\n      s3_key,\r\n    });\r\n\r\n    // 進捗更新（90%）\r\n    await updateExportStatus(export_id, 'processing', 90);\r\n\r\n    // 署名付きURL生成（有効期限7日）\r\n    logger.info('Generating signed URL', {\r\n      export_id,\r\n      s3_key,\r\n    });\r\n\r\n    const download_url = await generateSignedUrl(s3_key, 7 * 24 * 60 * 60); // 7日間\r\n\r\n    logger.info('Signed URL generated successfully', {\r\n      export_id,\r\n      download_url,\r\n    });\r\n\r\n    // ステータスを completed に更新（進捗100%）\r\n    await updateExportStatus(export_id, 'completed', 100, s3_key, download_url);\r\n\r\n    logger.info('Export processing completed successfully', {\r\n      export_id,\r\n      s3_key,\r\n      download_url,\r\n    });\r\n  } catch (error) {\r\n    logger.error(\r\n      'Export processing failed',\r\n      createErrorContext(error as Error, {\r\n        export_id,\r\n      })\r\n    );\r\n\r\n    // ステータスを failed に更新\r\n    await updateExportStatus(\r\n      export_id,\r\n      'failed',\r\n      0,\r\n      undefined,\r\n      undefined,\r\n      error instanceof Error ? error.message : String(error)\r\n    );\r\n\r\n    throw error;\r\n  }\r\n}\r\n"],"mappings":"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","ignoreList":[]}