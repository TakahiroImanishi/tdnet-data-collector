{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\__tests__\\save-metadata.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\__tests__\\save-metadata.test.ts"],"sourcesContent":["/**\r\n * saveMetadata関数のユニットテスト\r\n *\r\n * Requirements: 要件1.4, 2.4（メタデータ保存、重複チェック）\r\n */\r\n\r\nimport { DynamoDBClient, PutItemCommand } from '@aws-sdk/client-dynamodb';\r\nimport { mockClient } from 'aws-sdk-client-mock';\r\nimport { saveMetadata } from '../save-metadata';\r\nimport { Disclosure } from '../../../types';\r\nimport { ValidationError } from '../../../errors';\r\n\r\nconst dynamoMock = mockClient(DynamoDBClient);\r\n\r\ndescribe('saveMetadata', () => {\r\n  const originalEnv = process.env.DYNAMODB_TABLE;\r\n\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n    dynamoMock.reset();\r\n    process.env.DYNAMODB_TABLE = 'test-table';\r\n  });\r\n\r\n  afterEach(() => {\r\n    process.env.DYNAMODB_TABLE = originalEnv;\r\n  });\r\n\r\n  describe('正常系', () => {\r\n    it('メタデータをDynamoDBに保存できる', async () => {\r\n      // Arrange\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20240115001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2024-01-15T10:30:00Z',\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120240115001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/01/15/TD20240115001.pdf';\r\n\r\n      dynamoMock.on(PutItemCommand).resolves({});\r\n\r\n      // Act\r\n      await saveMetadata(disclosure, s3_key);\r\n\r\n      // Assert\r\n      expect(dynamoMock.calls()).toHaveLength(1);\r\n      const call = dynamoMock.call(0);\r\n      expect(call.args[0].input).toMatchObject({\r\n        TableName: 'test-table',\r\n        ConditionExpression: 'attribute_not_exists(disclosure_id)',\r\n      });\r\n\r\n      // date_partitionが正しく生成されているか確認\r\n      const input = call.args[0].input as any;\r\n      const item = input.Item;\r\n      expect(item?.date_partition?.S).toBe('2024-01');\r\n      expect(item?.disclosure_id?.S).toBe('TD20240115001');\r\n      expect(item?.s3_key?.S).toBe(s3_key);\r\n    });\r\n\r\n    it('date_partitionを事前生成してから保存する（Two-Phase Commit）', async () => {\r\n      // Arrange\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20240115001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2024-01-15T10:30:00Z',\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120240115001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/01/15/TD20240115001.pdf';\r\n\r\n      dynamoMock.on(PutItemCommand).resolves({});\r\n\r\n      // Act\r\n      await saveMetadata(disclosure, s3_key);\r\n\r\n      // Assert\r\n      const call = dynamoMock.call(0);\r\n      const input = call.args[0].input as any;\r\n      const item = input.Item;\r\n\r\n      // date_partitionが保存前に生成されている\r\n      expect(item?.date_partition?.S).toBeDefined();\r\n      expect(item?.date_partition?.S).toBe('2024-01');\r\n    });\r\n\r\n    it('月またぎ（UTC→JST）のdate_partitionを正しく生成できる', async () => {\r\n      // Arrange: UTC 2024-01-31 15:30 → JST 2024-02-01 00:30\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20240131001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2024-01-31T15:30:00Z',\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120240131001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/02/01/TD20240131001.pdf';\r\n\r\n      dynamoMock.on(PutItemCommand).resolves({});\r\n\r\n      // Act\r\n      await saveMetadata(disclosure, s3_key);\r\n\r\n      // Assert\r\n      const call = dynamoMock.call(0);\r\n      const input = call.args[0].input as any;\r\n      const item = input.Item;\r\n      expect(item?.date_partition?.S).toBe('2024-02');\r\n    });\r\n\r\n    it('年またぎ（UTC→JST）のdate_partitionを正しく生成できる', async () => {\r\n      // Arrange: UTC 2023-12-31 15:30 → JST 2024-01-01 00:30\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20231231001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2023-12-31T15:30:00Z',\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120231231001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/01/01/TD20231231001.pdf';\r\n\r\n      dynamoMock.on(PutItemCommand).resolves({});\r\n\r\n      // Act\r\n      await saveMetadata(disclosure, s3_key);\r\n\r\n      // Assert\r\n      const call = dynamoMock.call(0);\r\n      const input = call.args[0].input as any;\r\n      const item = input.Item;\r\n      expect(item?.date_partition?.S).toBe('2024-01');\r\n    });\r\n\r\n    it('collected_atに現在時刻を設定する', async () => {\r\n      // Arrange\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20240115001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2024-01-15T10:30:00Z',\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120240115001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/01/15/TD20240115001.pdf';\r\n\r\n      dynamoMock.on(PutItemCommand).resolves({});\r\n\r\n      const beforeTime = new Date().toISOString();\r\n\r\n      // Act\r\n      await saveMetadata(disclosure, s3_key);\r\n\r\n      const afterTime = new Date().toISOString();\r\n\r\n      // Assert\r\n      const call = dynamoMock.call(0);\r\n      const input = call.args[0].input as any;\r\n      const item = input.Item;\r\n      const collectedAt = item?.collected_at?.S;\r\n\r\n      expect(collectedAt).toBeDefined();\r\n      expect(collectedAt).toMatch(/^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{3}Z$/);\r\n      expect(collectedAt! >= beforeTime).toBe(true);\r\n      expect(collectedAt! <= afterTime).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe('異常系', () => {\r\n    it('重複する開示IDの場合、警告レベルで記録して正常終了する', async () => {\r\n      // Arrange\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20240115001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2024-01-15T10:30:00Z',\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120240115001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/01/15/TD20240115001.pdf';\r\n\r\n      const conditionalCheckError = new Error('ConditionalCheckFailedException');\r\n      conditionalCheckError.name = 'ConditionalCheckFailedException';\r\n      dynamoMock.on(PutItemCommand).rejects(conditionalCheckError);\r\n\r\n      // Act & Assert\r\n      await expect(saveMetadata(disclosure, s3_key)).resolves.toBeUndefined();\r\n      expect(dynamoMock.calls()).toHaveLength(1);\r\n    });\r\n\r\n    it('不正なdisclosed_atフォーマットでValidationErrorをスローする', async () => {\r\n      // Arrange\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20240115001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2024-01-15 10:30:00', // 不正なフォーマット\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120240115001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/01/15/TD20240115001.pdf';\r\n\r\n      // Act & Assert\r\n      await expect(saveMetadata(disclosure, s3_key)).rejects.toThrow(ValidationError);\r\n      expect(dynamoMock.calls()).toHaveLength(0); // DynamoDBは呼ばれない\r\n    });\r\n\r\n    it('存在しない日付でValidationErrorをスローする', async () => {\r\n      // Arrange\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20240230001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2024-02-30T10:30:00Z', // 存在しない日付\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120240230001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/02/30/TD20240230001.pdf';\r\n\r\n      // Act & Assert\r\n      await expect(saveMetadata(disclosure, s3_key)).rejects.toThrow(ValidationError);\r\n      expect(dynamoMock.calls()).toHaveLength(0); // DynamoDBは呼ばれない\r\n    });\r\n\r\n    it('DynamoDBエラーで失敗する', async () => {\r\n      // Arrange\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20240115001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2024-01-15T10:30:00Z',\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120240115001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/01/15/TD20240115001.pdf';\r\n\r\n      dynamoMock.on(PutItemCommand).rejects(new Error('DynamoDB error'));\r\n\r\n      // Act & Assert\r\n      await expect(saveMetadata(disclosure, s3_key)).rejects.toThrow('DynamoDB error');\r\n    });\r\n  });\r\n\r\n  describe('エッジケース', () => {\r\n    it('うるう年2月末（UTC→JST）のdate_partitionを正しく生成できる', async () => {\r\n      // Arrange: UTC 2024-02-29 15:00 → JST 2024-03-01 00:00\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20240229001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2024-02-29T15:00:00Z',\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120240229001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/03/01/TD20240229001.pdf';\r\n\r\n      dynamoMock.on(PutItemCommand).resolves({});\r\n\r\n      // Act\r\n      await saveMetadata(disclosure, s3_key);\r\n\r\n      // Assert\r\n      const call = dynamoMock.call(0);\r\n      const input = call.args[0].input as any;\r\n      const item = input.Item;\r\n      expect(item?.date_partition?.S).toBe('2024-03');\r\n    });\r\n\r\n    it('環境変数DYNAMODB_TABLEが未設定の場合、デフォルト値を使用する', async () => {\r\n      // Arrange\r\n      delete process.env.DYNAMODB_TABLE;\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20240115001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2024-01-15T10:30:00Z',\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120240115001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/01/15/TD20240115001.pdf';\r\n\r\n      dynamoMock.on(PutItemCommand).resolves({});\r\n\r\n      // Act\r\n      await saveMetadata(disclosure, s3_key);\r\n\r\n      // Assert\r\n      const input = dynamoMock.call(0).args[0].input as any;\r\n      expect(input.TableName).toBe('tdnet_disclosures');\r\n    });\r\n\r\n    it('すべてのメタデータフィールドが正しく保存される', async () => {\r\n      // Arrange\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20240115001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2024-01-15T10:30:00Z',\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120240115001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/01/15/TD20240115001.pdf';\r\n\r\n      dynamoMock.on(PutItemCommand).resolves({});\r\n\r\n      // Act\r\n      await saveMetadata(disclosure, s3_key);\r\n\r\n      // Assert\r\n      const call = dynamoMock.call(0);\r\n      const input = call.args[0].input as any;\r\n      const item = input.Item;\r\n\r\n      expect(item?.disclosure_id?.S).toBe('TD20240115001');\r\n      expect(item?.company_code?.S).toBe('1234');\r\n      expect(item?.company_name?.S).toBe('株式会社サンプル');\r\n      expect(item?.disclosure_type?.S).toBe('決算短信');\r\n      expect(item?.title?.S).toBe('2024年3月期 第3四半期決算短信');\r\n      expect(item?.disclosed_at?.S).toBe('2024-01-15T10:30:00Z');\r\n      expect(item?.date_partition?.S).toBe('2024-01');\r\n      expect(item?.pdf_url?.S).toBe('https://www.release.tdnet.info/inbs/140120240115001.pdf');\r\n      expect(item?.s3_key?.S).toBe(s3_key);\r\n      expect(item?.collected_at?.S).toBeDefined();\r\n    });\r\n  });\r\n});\r\n\r\n  describe('再試行ロジック', () => {\r\n    beforeEach(() => {\r\n      dynamoMock.reset();\r\n    });\r\n\r\n    it('ProvisionedThroughputExceededExceptionで再試行する', async () => {\r\n      // Arrange\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20240115001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2024-01-15T10:30:00Z',\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120240115001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/01/15/TD20240115001.pdf';\r\n\r\n      const throughputError = new Error('ProvisionedThroughputExceededException');\r\n      throughputError.name = 'ProvisionedThroughputExceededException';\r\n\r\n      // 最初の2回は失敗、3回目は成功\r\n      dynamoMock\r\n        .on(PutItemCommand)\r\n        .rejectsOnce(throughputError)\r\n        .rejectsOnce(throughputError)\r\n        .resolvesOnce({});\r\n\r\n      // Act\r\n      await saveMetadata(disclosure, s3_key);\r\n\r\n      // Assert\r\n      expect(dynamoMock.calls()).toHaveLength(3); // 初回 + 2回再試行\r\n    });\r\n\r\n    it('ProvisionedThroughputExceededExceptionで最大再試行回数後に失敗する', async () => {\r\n      // Arrange\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20240115001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2024-01-15T10:30:00Z',\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120240115001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/01/15/TD20240115001.pdf';\r\n\r\n      const throughputError = new Error('ProvisionedThroughputExceededException');\r\n      throughputError.name = 'ProvisionedThroughputExceededException';\r\n\r\n      dynamoMock.on(PutItemCommand).rejects(throughputError);\r\n\r\n      // Act & Assert\r\n      await expect(saveMetadata(disclosure, s3_key)).rejects.toThrow(\r\n        'ProvisionedThroughputExceededException'\r\n      );\r\n      expect(dynamoMock.calls()).toHaveLength(4); // 初回 + 3回再試行\r\n    });\r\n\r\n    it('ConditionalCheckFailedExceptionは再試行しない', async () => {\r\n      // Arrange\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20240115001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2024-01-15T10:30:00Z',\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120240115001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/01/15/TD20240115001.pdf';\r\n\r\n      const conditionalCheckError = new Error('ConditionalCheckFailedException');\r\n      conditionalCheckError.name = 'ConditionalCheckFailedException';\r\n      dynamoMock.on(PutItemCommand).rejects(conditionalCheckError);\r\n\r\n      // Act\r\n      await saveMetadata(disclosure, s3_key);\r\n\r\n      // Assert\r\n      expect(dynamoMock.calls()).toHaveLength(1); // 再試行しない\r\n    });\r\n\r\n    it('その他のDynamoDBエラーは再試行しない', async () => {\r\n      // Arrange\r\n      const disclosure: Disclosure = {\r\n        disclosure_id: 'TD20240115001',\r\n        company_code: '1234',\r\n        company_name: '株式会社サンプル',\r\n        disclosure_type: '決算短信',\r\n        title: '2024年3月期 第3四半期決算短信',\r\n        disclosed_at: '2024-01-15T10:30:00Z',\r\n        pdf_url: 'https://www.release.tdnet.info/inbs/140120240115001.pdf',\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      };\r\n      const s3_key = '2024/01/15/TD20240115001.pdf';\r\n\r\n      const validationError = new Error('ValidationException');\r\n      validationError.name = 'ValidationException';\r\n      dynamoMock.on(PutItemCommand).rejects(validationError);\r\n\r\n      // Act & Assert\r\n      await expect(saveMetadata(disclosure, s3_key)).rejects.toThrow('ValidationException');\r\n      expect(dynamoMock.calls()).toHaveLength(1); // 再試行しない\r\n    });\r\n  });\r\n"],"version":3}