{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\handler.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\handler.ts"],"sourcesContent":["/**\r\n * Lambda Export Handler\r\n *\r\n * TDnet開示情報をJSON/CSV形式でエクスポートするLambda関数のメインハンドラー。\r\n * APIキー認証を実装し、非同期でエクスポート処理を実行します。\r\n *\r\n * Requirements: 要件5.1, 5.2, 5.4, 11.1（エクスポート、認証）\r\n */\r\n\r\nimport { APIGatewayProxyResult, Context } from 'aws-lambda';\r\nimport { SecretsManagerClient, GetSecretValueCommand } from '@aws-sdk/client-secrets-manager';\r\nimport { logger, createErrorContext } from '../../utils/logger';\r\nimport { sendErrorMetric, sendMetrics } from '../../utils/cloudwatch-metrics';\r\nimport { ValidationError, AuthenticationError } from '../../errors';\r\nimport { ExportEvent, ExportRequestBody, ExportResponse } from './types';\r\nimport { createExportJob } from './create-export-job';\r\nimport { processExport } from './process-export';\r\n\r\n// Secrets Managerクライアント（グローバルスコープで初期化）\r\nconst secretsClient = new SecretsManagerClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });\r\n\r\n// APIキーキャッシュ（5分TTL）\r\nlet cachedApiKey: string | null = null;\r\nlet cacheExpiry: number = 0;\r\n\r\n/**\r\n * Secrets ManagerからAPIキーを取得\r\n *\r\n * テスト環境（TEST_ENV=e2e）では、API_KEY環境変数から直接取得します。\r\n * 本番環境では、Secrets Managerから取得します。\r\n *\r\n * @returns APIキー\r\n * @throws Error Secrets Managerからの取得に失敗した場合\r\n */\r\nasync function getApiKey(): Promise<string> {\r\n  // キャッシュチェック\r\n  if (cachedApiKey && Date.now() < cacheExpiry) {\r\n    return cachedApiKey;\r\n  }\r\n\r\n  // テスト環境: API_KEY環境変数から直接取得\r\n  if (process.env.TEST_ENV === 'e2e' && process.env.API_KEY) {\r\n    cachedApiKey = process.env.API_KEY;\r\n    cacheExpiry = Date.now() + 5 * 60 * 1000;\r\n    return cachedApiKey;\r\n  }\r\n\r\n  // 本番環境: Secrets Managerから取得\r\n  const secretArn = process.env.API_KEY_SECRET_ARN;\r\n  if (!secretArn) {\r\n    throw new Error('API_KEY_SECRET_ARN environment variable is not set');\r\n  }\r\n\r\n  try {\r\n    const command = new GetSecretValueCommand({ SecretId: secretArn });\r\n    const response = await secretsClient.send(command);\r\n\r\n    if (!response.SecretString) {\r\n      throw new Error('Secret value is empty');\r\n    }\r\n\r\n    // APIキーをキャッシュ（5分TTL）\r\n    cachedApiKey = response.SecretString;\r\n    cacheExpiry = Date.now() + 5 * 60 * 1000;\r\n\r\n    return cachedApiKey;\r\n  } catch (error) {\r\n    logger.error('Failed to retrieve API key from Secrets Manager', {\r\n      error: error instanceof Error ? error.message : String(error),\r\n      secret_arn: secretArn,\r\n    });\r\n    throw new Error('Failed to retrieve API key');\r\n  }\r\n}\r\n\r\n/**\r\n * Lambda Exportハンドラー\r\n *\r\n * @param event ExportEvent（API Gateway経由）\r\n * @param context Lambda Context\r\n * @returns APIGatewayProxyResult\r\n *\r\n * @example\r\n * ```typescript\r\n * // JSON形式でエクスポート\r\n * const response = await handler({\r\n *   headers: { 'x-api-key': 'your-api-key' },\r\n *   body: JSON.stringify({\r\n *     format: 'json',\r\n *     filter: {\r\n *       start_date: '2024-01-15',\r\n *       end_date: '2024-01-20',\r\n *     },\r\n *   }),\r\n * }, context);\r\n *\r\n * // CSV形式でエクスポート\r\n * const response = await handler({\r\n *   headers: { 'x-api-key': 'your-api-key' },\r\n *   body: JSON.stringify({\r\n *     format: 'csv',\r\n *     filter: {\r\n *       company_code: '1234',\r\n *       start_date: '2024-01-01',\r\n *       end_date: '2024-01-31',\r\n *     },\r\n *   }),\r\n * }, context);\r\n * ```\r\n */\r\nexport async function handler(\r\n  event: ExportEvent,\r\n  context: Context\r\n): Promise<APIGatewayProxyResult> {\r\n  const startTime = Date.now();\r\n\r\n  try {\r\n    logger.info('Lambda Export started', {\r\n      request_id: context.awsRequestId,\r\n      function_name: context.functionName,\r\n    });\r\n\r\n    // APIキー認証\r\n    await validateApiKey(event);\r\n\r\n    // リクエストボディのパース\r\n    const requestBody = parseRequestBody(event.body);\r\n\r\n    // バリデーション\r\n    validateRequestBody(requestBody);\r\n\r\n    // エクスポートジョブを作成\r\n    const exportJob = await createExportJob(requestBody, context.awsRequestId);\r\n\r\n    // 非同期でエクスポート処理を開始（await しない）\r\n    processExport(exportJob.export_id, requestBody)\r\n      .catch((error) => {\r\n        logger.error(\r\n          'Export processing failed',\r\n          createErrorContext(error as Error, {\r\n            export_id: exportJob.export_id,\r\n          })\r\n        );\r\n      });\r\n\r\n    const duration = Date.now() - startTime;\r\n\r\n    logger.info('Lambda Export completed', {\r\n      export_id: exportJob.export_id,\r\n      status: exportJob.status,\r\n      duration_ms: duration,\r\n    });\r\n\r\n    // 成功メトリクス送信\r\n    await sendMetrics([\r\n      {\r\n        name: 'LambdaExecutionTime',\r\n        value: duration,\r\n        unit: 'Milliseconds',\r\n        dimensions: { FunctionName: 'Export' },\r\n      },\r\n      {\r\n        name: 'ExportJobsCreated',\r\n        value: 1,\r\n        unit: 'Count',\r\n        dimensions: { Format: requestBody.format },\r\n      },\r\n    ]);\r\n\r\n    // レスポンス\r\n    const response: ExportResponse = {\r\n      export_id: exportJob.export_id,\r\n      status: exportJob.status,\r\n      message: 'Export job created successfully',\r\n      progress: exportJob.progress,\r\n    };\r\n\r\n    return {\r\n      statusCode: 202, // Accepted\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Headers': 'Content-Type,X-Api-Key',\r\n      },\r\n      body: JSON.stringify(response),\r\n    };\r\n  } catch (error) {\r\n    const duration = Date.now() - startTime;\r\n\r\n    logger.error(\r\n      'Lambda Export failed',\r\n      createErrorContext(error as Error, {\r\n        request_id: context.awsRequestId,\r\n        duration_ms: duration,\r\n      })\r\n    );\r\n\r\n    // エラーメトリクス送信\r\n    await sendErrorMetric(\r\n      error instanceof Error ? error.constructor.name : 'Unknown',\r\n      'Export'\r\n    );\r\n\r\n    // エラーレスポンス\r\n    return handleError(error as Error, context.awsRequestId);\r\n  }\r\n}\r\n\r\n/**\r\n * APIキー認証\r\n *\r\n * @param event ExportEvent\r\n * @throws AuthenticationError APIキーが無効な場合\r\n */\r\nasync function validateApiKey(event: ExportEvent): Promise<void> {\r\n  const apiKey = event.headers?.['x-api-key'] || event.headers?.['X-Api-Key'];\r\n\r\n  if (!apiKey) {\r\n    throw new AuthenticationError('API key is required');\r\n  }\r\n\r\n  // Secrets ManagerからAPIキーを取得\r\n  const validApiKey = await getApiKey();\r\n\r\n  if (apiKey !== validApiKey) {\r\n    throw new AuthenticationError('Invalid API key');\r\n  }\r\n}\r\n\r\n/**\r\n * リクエストボディのパース\r\n *\r\n * @param body リクエストボディ（JSON文字列）\r\n * @returns ExportRequestBody\r\n * @throws ValidationError パースエラーの場合\r\n */\r\nfunction parseRequestBody(body: string): ExportRequestBody {\r\n  if (!body) {\r\n    throw new ValidationError('Request body is required');\r\n  }\r\n\r\n  try {\r\n    return JSON.parse(body) as ExportRequestBody;\r\n  } catch (error) {\r\n    throw new ValidationError('Invalid JSON format in request body', {\r\n      body,\r\n      error: error instanceof Error ? error.message : String(error),\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * リクエストボディのバリデーション\r\n *\r\n * @param requestBody ExportRequestBody\r\n * @throws ValidationError バリデーションエラーの場合\r\n */\r\nfunction validateRequestBody(requestBody: ExportRequestBody): void {\r\n  // フォーマットのバリデーション\r\n  if (!requestBody.format || !['json', 'csv'].includes(requestBody.format)) {\r\n    throw new ValidationError(\r\n      `Invalid format: ${requestBody.format}. Expected 'json' or 'csv'.`\r\n    );\r\n  }\r\n\r\n  // フィルターのバリデーション\r\n  if (!requestBody.filter) {\r\n    throw new ValidationError('Filter is required');\r\n  }\r\n\r\n  const { filter } = requestBody;\r\n\r\n  // 日付フォーマットのバリデーション（YYYY-MM-DD）\r\n  const dateRegex = /^\\d{4}-\\d{2}-\\d{2}$/;\r\n\r\n  if (filter.start_date && !dateRegex.test(filter.start_date)) {\r\n    throw new ValidationError(\r\n      `Invalid start_date format: ${filter.start_date}. Expected YYYY-MM-DD format.`\r\n    );\r\n  }\r\n\r\n  if (filter.end_date && !dateRegex.test(filter.end_date)) {\r\n    throw new ValidationError(\r\n      `Invalid end_date format: ${filter.end_date}. Expected YYYY-MM-DD format.`\r\n    );\r\n  }\r\n\r\n  // 日付の有効性チェック\r\n  if (filter.start_date) {\r\n    const startDate = new Date(filter.start_date);\r\n    if (isNaN(startDate.getTime())) {\r\n      throw new ValidationError(\r\n        `Invalid start_date: ${filter.start_date}. Date does not exist.`\r\n      );\r\n    }\r\n  }\r\n\r\n  if (filter.end_date) {\r\n    const endDate = new Date(filter.end_date);\r\n    if (isNaN(endDate.getTime())) {\r\n      throw new ValidationError(\r\n        `Invalid end_date: ${filter.end_date}. Date does not exist.`\r\n      );\r\n    }\r\n  }\r\n\r\n  // 日付順序チェック\r\n  if (filter.start_date && filter.end_date) {\r\n    const startDate = new Date(filter.start_date);\r\n    const endDate = new Date(filter.end_date);\r\n\r\n    if (startDate > endDate) {\r\n      throw new ValidationError(\r\n        `start_date (${filter.start_date}) must be before or equal to end_date (${filter.end_date})`\r\n      );\r\n    }\r\n  }\r\n\r\n  // 企業コードのバリデーション（4桁の数字）\r\n  if (filter.company_code && !/^\\d{4}$/.test(filter.company_code)) {\r\n    throw new ValidationError(\r\n      `Invalid company_code format: ${filter.company_code}. Expected 4-digit number.`\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * エラーハンドリング\r\n *\r\n * @param error エラーオブジェクト\r\n * @param requestId リクエストID\r\n * @returns APIGatewayProxyResult\r\n */\r\nfunction handleError(error: Error, requestId: string): APIGatewayProxyResult {\r\n  // エラー種別に応じたステータスコードとエラーコード\r\n  let statusCode = 500;\r\n  let errorCode = 'INTERNAL_ERROR';\r\n\r\n  if (error instanceof ValidationError) {\r\n    statusCode = 400;\r\n    errorCode = 'VALIDATION_ERROR';\r\n  } else if (error instanceof AuthenticationError) {\r\n    statusCode = 401;\r\n    errorCode = 'UNAUTHORIZED';\r\n  }\r\n\r\n  return {\r\n    statusCode,\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n      'Access-Control-Allow-Origin': '*',\r\n      'Access-Control-Allow-Headers': 'Content-Type,X-Api-Key',\r\n    },\r\n    body: JSON.stringify({\r\n      status: 'error',\r\n      error: {\r\n        code: errorCode,\r\n        message: error.message,\r\n        details: (error as any).details || {},\r\n      },\r\n      request_id: requestId,\r\n    }),\r\n  };\r\n}\r\n"],"version":3}