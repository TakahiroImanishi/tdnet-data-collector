fdf5011b8c4b530cf66dcc9a49e2640e
"use strict";
/**
 * Lambda Collector Handler - Improved Unit Tests
 *
 * このファイルは、DI パターンと aws-sdk-client-mock を使用した改善版テストの例です。
 * 既存の handler.test.ts を置き換える際の参考にしてください。
 *
 * Requirements: テスト環境の整備（Task 9.4）
 */
Object.defineProperty(exports, "__esModule", { value: true });
// Mock dependencies
jest.mock('../scrape-tdnet-list');
const handler_1 = require("../handler");
const scrape_tdnet_list_1 = require("../scrape-tdnet-list");
const test_helpers_1 = require("./test-helpers");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_s3_1 = require("@aws-sdk/client-s3");
const mockScrapeTdnetList = scrape_tdnet_list_1.scrapeTdnetList;
describe('Lambda Collector Handler - Improved Tests', () => {
    let mockContext;
    beforeEach(() => {
        jest.clearAllMocks();
        // テスト用依存関係をセットアップ（DI + aws-sdk-client-mock）
        (0, test_helpers_1.setupTestDependencies)();
        // Mock Lambda Context
        mockContext = {
            awsRequestId: 'test-request-id-12345',
            functionName: 'test-collector-function',
            functionVersion: '1',
            invokedFunctionArn: 'arn:aws:lambda:us-east-1:123456789012:function:test',
            memoryLimitInMB: '512',
            logGroupName: '/aws/lambda/test',
            logStreamName: '2024/01/15/[$LATEST]test',
            getRemainingTimeInMillis: () => 30000,
            done: jest.fn(),
            fail: jest.fn(),
            succeed: jest.fn(),
            callbackWaitsForEmptyEventLoop: true,
        };
        // 環境変数を設定
        process.env.DYNAMODB_TABLE = 'test-disclosures-table';
        process.env.DYNAMODB_EXECUTIONS_TABLE = 'test-executions-table';
        process.env.S3_BUCKET = 'test-pdfs-bucket';
        process.env.LOG_LEVEL = 'error'; // テスト時はエラーログのみ
    });
    afterEach(() => {
        // テスト用依存関係をクリーンアップ
        (0, test_helpers_1.cleanupTestDependencies)();
    });
    describe('Batch Mode', () => {
        it('should collect yesterday\'s data in batch mode', async () => {
            const event = {
                mode: 'batch',
            };
            // スクレイピング結果をモック
            mockScrapeTdnetList.mockResolvedValue([
                {
                    company_code: '1234',
                    company_name: 'Test Company',
                    disclosure_type: '決算短信',
                    title: 'Test Disclosure',
                    disclosed_at: '2024-01-15T01:30:00Z',
                    pdf_url: 'https://example.com/test.pdf',
                },
            ]);
            // DynamoDB/S3の成功をモック
            (0, test_helpers_1.mockUpdateExecutionStatus)(true);
            (0, test_helpers_1.mockPutDisclosure)(true);
            (0, test_helpers_1.mockPutPdf)(true);
            const response = await (0, handler_1.handler)(event, mockContext);
            // レスポンス検証
            expect(response.status).toBe('success');
            expect(response.collected_count).toBeGreaterThan(0);
            expect(response.failed_count).toBe(0);
            expect(response.execution_id).toMatch(/^exec_\d+_[a-z0-9]+_test-req/);
            // スクレイピングが呼ばれたことを確認
            expect(mockScrapeTdnetList).toHaveBeenCalled();
            // DynamoDB/S3が呼ばれたことを確認
            expect(test_helpers_1.dynamoMock.commandCalls(lib_dynamodb_1.PutCommand).length).toBeGreaterThan(0);
            expect(test_helpers_1.dynamoMock.commandCalls(lib_dynamodb_1.UpdateCommand).length).toBeGreaterThan(0);
            expect(test_helpers_1.s3Mock.commandCalls(client_s3_1.PutObjectCommand).length).toBeGreaterThan(0);
        });
        it('should handle scraping errors gracefully in batch mode', async () => {
            const event = {
                mode: 'batch',
            };
            // スクレイピングエラーをモック
            mockScrapeTdnetList.mockRejectedValue(new Error('Network error'));
            // 実行状態更新は成功
            (0, test_helpers_1.mockUpdateExecutionStatus)(true);
            const response = await (0, handler_1.handler)(event, mockContext);
            // エラーハンドリングの検証
            expect(response.status).toBe('failed');
            expect(response.collected_count).toBe(0);
            expect(response.failed_count).toBeGreaterThan(0);
            // 実行状態が更新されたことを確認
            expect(test_helpers_1.dynamoMock.commandCalls(lib_dynamodb_1.UpdateCommand).length).toBeGreaterThan(0);
        });
    });
    describe('On-Demand Mode', () => {
        it('should collect data for specified date range', async () => {
            // Use recent dates (within 1 year)
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const threeDaysAgo = new Date();
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
            const event = {
                mode: 'on-demand',
                start_date: threeDaysAgo.toISOString().substring(0, 10),
                end_date: yesterday.toISOString().substring(0, 10),
            };
            // スクレイピング結果をモック
            mockScrapeTdnetList.mockResolvedValue([
                {
                    company_code: '1234',
                    company_name: 'Test Company',
                    disclosure_type: '決算短信',
                    title: 'Test Disclosure',
                    disclosed_at: '2024-01-15T01:30:00Z',
                    pdf_url: 'https://example.com/test.pdf',
                },
            ]);
            // DynamoDB/S3の成功をモック
            (0, test_helpers_1.mockUpdateExecutionStatus)(true);
            (0, test_helpers_1.mockPutDisclosure)(true);
            (0, test_helpers_1.mockPutPdf)(true);
            const response = await (0, handler_1.handler)(event, mockContext);
            // レスポンス検証
            expect(response.status).toBe('success');
            expect(response.collected_count).toBeGreaterThan(0);
            // 3日分のスクレイピングが実行されたことを確認
            expect(mockScrapeTdnetList).toHaveBeenCalledTimes(3);
        });
        it('should handle partial failures in on-demand mode', async () => {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const threeDaysAgo = new Date();
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
            const event = {
                mode: 'on-demand',
                start_date: threeDaysAgo.toISOString().substring(0, 10),
                end_date: yesterday.toISOString().substring(0, 10),
            };
            // 部分的失敗をモック（1日目成功、2日目失敗、3日目成功）
            mockScrapeTdnetList
                .mockResolvedValueOnce([
                {
                    company_code: '1234',
                    company_name: 'Test Company',
                    disclosure_type: '決算短信',
                    title: 'Test Disclosure',
                    disclosed_at: '2024-01-15T01:30:00Z',
                    pdf_url: 'https://example.com/test.pdf',
                },
            ])
                .mockRejectedValueOnce(new Error('Network error'))
                .mockResolvedValueOnce([
                {
                    company_code: '5678',
                    company_name: 'Another Company',
                    disclosure_type: '有価証券報告書',
                    title: 'Another Disclosure',
                    disclosed_at: '2024-01-17T02:00:00Z',
                    pdf_url: 'https://example.com/test2.pdf',
                },
            ]);
            // DynamoDB/S3の成功をモック
            (0, test_helpers_1.mockUpdateExecutionStatus)(true);
            (0, test_helpers_1.mockPutDisclosure)(true);
            (0, test_helpers_1.mockPutPdf)(true);
            const response = await (0, handler_1.handler)(event, mockContext);
            // 部分的成功の検証
            expect(response.status).toBe('partial_success');
            expect(response.collected_count).toBeGreaterThan(0);
            expect(response.failed_count).toBe(1);
        });
    });
    describe('Validation', () => {
        it('should reject invalid mode', async () => {
            const event = {
                mode: 'invalid',
            };
            const response = await (0, handler_1.handler)(event, mockContext);
            expect(response.status).toBe('failed');
            expect(response.message).toContain('Invalid mode');
        });
        it('should reject on-demand mode without start_date', async () => {
            const event = {
                mode: 'on-demand',
                end_date: '2024-01-15',
            };
            const response = await (0, handler_1.handler)(event, mockContext);
            expect(response.status).toBe('failed');
            expect(response.message).toContain('start_date and end_date are required');
        });
        it('should reject invalid date format', async () => {
            const event = {
                mode: 'on-demand',
                start_date: '2024/01/15',
                end_date: '2024-01-20',
            };
            const response = await (0, handler_1.handler)(event, mockContext);
            expect(response.status).toBe('failed');
            expect(response.message).toContain('Invalid start_date format');
        });
    });
    describe('AWS SDK Mock Verification', () => {
        it('should verify DynamoDB calls with aws-sdk-client-mock', async () => {
            const event = {
                mode: 'batch',
            };
            mockScrapeTdnetList.mockResolvedValue([
                {
                    company_code: '1234',
                    company_name: 'Test Company',
                    disclosure_type: '決算短信',
                    title: 'Test Disclosure',
                    disclosed_at: '2024-01-15T01:30:00Z',
                    pdf_url: 'https://example.com/test.pdf',
                },
            ]);
            (0, test_helpers_1.mockUpdateExecutionStatus)(true);
            (0, test_helpers_1.mockPutDisclosure)(true);
            (0, test_helpers_1.mockPutPdf)(true);
            await (0, handler_1.handler)(event, mockContext);
            // aws-sdk-client-mockの検証機能を使用
            const putCalls = test_helpers_1.dynamoMock.commandCalls(lib_dynamodb_1.PutCommand);
            const updateCalls = test_helpers_1.dynamoMock.commandCalls(lib_dynamodb_1.UpdateCommand);
            expect(putCalls.length).toBeGreaterThan(0);
            expect(updateCalls.length).toBeGreaterThan(0);
            // 呼び出しパラメータの検証
            const firstPutCall = putCalls[0];
            expect(firstPutCall.args[0].input.TableName).toBe('test-disclosures-table');
        });
        it('should verify S3 calls with aws-sdk-client-mock', async () => {
            const event = {
                mode: 'batch',
            };
            mockScrapeTdnetList.mockResolvedValue([
                {
                    company_code: '1234',
                    company_name: 'Test Company',
                    disclosure_type: '決算短信',
                    title: 'Test Disclosure',
                    disclosed_at: '2024-01-15T01:30:00Z',
                    pdf_url: 'https://example.com/test.pdf',
                },
            ]);
            (0, test_helpers_1.mockUpdateExecutionStatus)(true);
            (0, test_helpers_1.mockPutDisclosure)(true);
            (0, test_helpers_1.mockPutPdf)(true);
            await (0, handler_1.handler)(event, mockContext);
            // S3呼び出しの検証
            const s3Calls = test_helpers_1.s3Mock.commandCalls(client_s3_1.PutObjectCommand);
            expect(s3Calls.length).toBeGreaterThan(0);
            // 呼び出しパラメータの検証
            const firstS3Call = s3Calls[0];
            expect(firstS3Call.args[0].input.Bucket).toBe('test-pdfs-bucket');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGNvbGxlY3RvclxcX190ZXN0c19fXFxoYW5kbGVyLnRlc3QuaW1wcm92ZWQudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7O0dBT0c7O0FBa0JILG9CQUFvQjtBQUNwQixJQUFJLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFoQmxDLHdDQUFxRDtBQUNyRCw0REFBdUQ7QUFDdkQsaURBU3dCO0FBQ3hCLHdEQUFrRTtBQUNsRSxrREFBc0Q7QUFJdEQsTUFBTSxtQkFBbUIsR0FBRyxtQ0FBOEQsQ0FBQztBQUUzRixRQUFRLENBQUMsMkNBQTJDLEVBQUUsR0FBRyxFQUFFO0lBQ3pELElBQUksV0FBb0IsQ0FBQztJQUV6QixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRXJCLDRDQUE0QztRQUM1QyxJQUFBLG9DQUFxQixHQUFFLENBQUM7UUFFeEIsc0JBQXNCO1FBQ3RCLFdBQVcsR0FBRztZQUNaLFlBQVksRUFBRSx1QkFBdUI7WUFDckMsWUFBWSxFQUFFLHlCQUF5QjtZQUN2QyxlQUFlLEVBQUUsR0FBRztZQUNwQixrQkFBa0IsRUFBRSxxREFBcUQ7WUFDekUsZUFBZSxFQUFFLEtBQUs7WUFDdEIsWUFBWSxFQUFFLGtCQUFrQjtZQUNoQyxhQUFhLEVBQUUsMEJBQTBCO1lBQ3pDLHdCQUF3QixFQUFFLEdBQUcsRUFBRSxDQUFDLEtBQUs7WUFDckMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDZixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNmLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2xCLDhCQUE4QixFQUFFLElBQUk7U0FDckMsQ0FBQztRQUVGLFVBQVU7UUFDVixPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsR0FBRyx3QkFBd0IsQ0FBQztRQUN0RCxPQUFPLENBQUMsR0FB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O1lBQy9CLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUNwRSxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGNvbGxlY3RvclxcX190ZXN0c19fXFxoYW5kbGVyLnRlc3QuaW1wcm92ZWQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIExhbWJkYSBDb2xsZWN0b3IgSGFuZGxlciAtIEltcHJvdmVkIFVuaXQgVGVzdHNcclxuICpcclxuICog44GT44Gu44OV44Kh44Kk44Or44Gv44CBREkg44OR44K/44O844Oz44GoIGF3cy1zZGstY2xpZW50LW1vY2sg44KS5L2/55So44GX44Gf5pS55ZaE54mI44OG44K544OI44Gu5L6L44Gn44GZ44CCXHJcbiAqIOaXouWtmOOBriBoYW5kbGVyLnRlc3QudHMg44KS572u44GN5o+b44GI44KL6Zqb44Gu5Y+C6ICD44Gr44GX44Gm44GP44Gg44GV44GE44CCXHJcbiAqXHJcbiAqIFJlcXVpcmVtZW50czog44OG44K544OI55Kw5aKD44Gu5pW05YKZ77yIVGFzayA5LjTvvIlcclxuICovXHJcblxyXG5pbXBvcnQgeyBDb250ZXh0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XHJcbmltcG9ydCB7IGhhbmRsZXIsIENvbGxlY3RvckV2ZW50IH0gZnJvbSAnLi4vaGFuZGxlcic7XHJcbmltcG9ydCB7IHNjcmFwZVRkbmV0TGlzdCB9IGZyb20gJy4uL3NjcmFwZS10ZG5ldC1saXN0JztcclxuaW1wb3J0IHtcclxuICBzZXR1cFRlc3REZXBlbmRlbmNpZXMsXHJcbiAgY2xlYW51cFRlc3REZXBlbmRlbmNpZXMsXHJcbiAgZHluYW1vTW9jayxcclxuICBzM01vY2ssXHJcbiAgY2xvdWRXYXRjaE1vY2ssXHJcbiAgbW9ja1B1dERpc2Nsb3N1cmUsXHJcbiAgbW9ja1VwZGF0ZUV4ZWN1dGlvblN0YXR1cyxcclxuICBtb2NrUHV0UGRmLFxyXG59IGZyb20gJy4vdGVzdC1oZWxwZXJzJztcclxuaW1wb3J0IHsgUHV0Q29tbWFuZCwgVXBkYXRlQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XHJcbmltcG9ydCB7IFB1dE9iamVjdENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xyXG5cclxuLy8gTW9jayBkZXBlbmRlbmNpZXNcclxuamVzdC5tb2NrKCcuLi9zY3JhcGUtdGRuZXQtbGlzdCcpO1xyXG5jb25zdCBtb2NrU2NyYXBlVGRuZXRMaXN0ID0gc2NyYXBlVGRuZXRMaXN0IGFzIGplc3QuTW9ja2VkRnVuY3Rpb248dHlwZW9mIHNjcmFwZVRkbmV0TGlzdD47XHJcblxyXG5kZXNjcmliZSgnTGFtYmRhIENvbGxlY3RvciBIYW5kbGVyIC0gSW1wcm92ZWQgVGVzdHMnLCAoKSA9PiB7XHJcbiAgbGV0IG1vY2tDb250ZXh0OiBDb250ZXh0O1xyXG5cclxuICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xyXG5cclxuICAgIC8vIOODhuOCueODiOeUqOS+neWtmOmWouS/guOCkuOCu+ODg+ODiOOCouODg+ODl++8iERJICsgYXdzLXNkay1jbGllbnQtbW9ja++8iVxyXG4gICAgc2V0dXBUZXN0RGVwZW5kZW5jaWVzKCk7XHJcblxyXG4gICAgLy8gTW9jayBMYW1iZGEgQ29udGV4dFxyXG4gICAgbW9ja0NvbnRleHQgPSB7XHJcbiAgICAgIGF3c1JlcXVlc3RJZDogJ3Rlc3QtcmVxdWVzdC1pZC0xMjM0NScsXHJcbiAgICAgIGZ1bmN0aW9uTmFtZTogJ3Rlc3QtY29sbGVjdG9yLWZ1bmN0aW9uJyxcclxuICAgICAgZnVuY3Rpb25WZXJzaW9uOiAnMScsXHJcbiAgICAgIGludm9rZWRGdW5jdGlvbkFybjogJ2Fybjphd3M6bGFtYmRhOnVzLWVhc3QtMToxMjM0NTY3ODkwMTI6ZnVuY3Rpb246dGVzdCcsXHJcbiAgICAgIG1lbW9yeUxpbWl0SW5NQjogJzUxMicsXHJcbiAgICAgIGxvZ0dyb3VwTmFtZTogJy9hd3MvbGFtYmRhL3Rlc3QnLFxyXG4gICAgICBsb2dTdHJlYW1OYW1lOiAnMjAyNC8wMS8xNS9bJExBVEVTVF10ZXN0JyxcclxuICAgICAgZ2V0UmVtYWluaW5nVGltZUluTWlsbGlzOiAoKSA9PiAzMDAwMCxcclxuICAgICAgZG9uZTogamVzdC5mbigpLFxyXG4gICAgICBmYWlsOiBqZXN0LmZuKCksXHJcbiAgICAgIHN1Y2NlZWQ6IGplc3QuZm4oKSxcclxuICAgICAgY2FsbGJhY2tXYWl0c0ZvckVtcHR5RXZlbnRMb29wOiB0cnVlLFxyXG4gICAgfTtcclxuXHJcbiAgICAvLyDnkrDlooPlpInmlbDjgpLoqK3lrppcclxuICAgIHByb2Nlc3MuZW52LkRZTkFNT0RCX1RBQkxFID0gJ3Rlc3QtZGlzY2xvc3VyZXMtdGFibGUnO1xyXG4gICAgcHJvY2Vzcy5lbnYuRFlOQU1PREJfRVhFQ1VUSU9OU19UQUJMRSA9ICd0ZXN0LWV4ZWN1dGlvbnMtdGFibGUnO1xyXG4gICAgcHJvY2Vzcy5lbnYuUzNfQlVDS0VUID0gJ3Rlc3QtcGRmcy1idWNrZXQnO1xyXG4gICAgcHJvY2Vzcy5lbnYuTE9HX0xFVkVMID0gJ2Vycm9yJzsgLy8g44OG44K544OI5pmC44Gv44Ko44Op44O844Ot44Kw44Gu44G/XHJcbiAgfSk7XHJcblxyXG4gIGFmdGVyRWFjaCgoKSA9PiB7XHJcbiAgICAvLyDjg4bjgrnjg4jnlKjkvp3lrZjplqLkv4LjgpLjgq/jg6rjg7zjg7PjgqLjg4Pjg5dcclxuICAgIGNsZWFudXBUZXN0RGVwZW5kZW5jaWVzKCk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdCYXRjaCBNb2RlJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBjb2xsZWN0IHllc3RlcmRheVxcJ3MgZGF0YSBpbiBiYXRjaCBtb2RlJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBldmVudDogQ29sbGVjdG9yRXZlbnQgPSB7XHJcbiAgICAgICAgbW9kZTogJ2JhdGNoJyxcclxuICAgICAgfTtcclxuXHJcbiAgICAgIC8vIOOCueOCr+ODrOOCpOODlOODs+OCsOe1kOaenOOCkuODouODg+OCr1xyXG4gICAgICBtb2NrU2NyYXBlVGRuZXRMaXN0Lm1vY2tSZXNvbHZlZFZhbHVlKFtcclxuICAgICAgICB7XHJcbiAgICAgICAgICBjb21wYW55X2NvZGU6ICcxMjM0JyxcclxuICAgICAgICAgIGNvbXBhbnlfbmFtZTogJ1Rlc3QgQ29tcGFueScsXHJcbiAgICAgICAgICBkaXNjbG9zdXJlX3R5cGU6ICfmsbrnrpfnn63kv6EnLFxyXG4gICAgICAgICAgdGl0bGU6ICdUZXN0IERpc2Nsb3N1cmUnLFxyXG4gICAgICAgICAgZGlzY2xvc2VkX2F0OiAnMjAyNC0wMS0xNVQwMTozMDowMFonLFxyXG4gICAgICAgICAgcGRmX3VybDogJ2h0dHBzOi8vZXhhbXBsZS5jb20vdGVzdC5wZGYnLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF0pO1xyXG5cclxuICAgICAgLy8gRHluYW1vREIvUzPjga7miJDlip/jgpLjg6Ljg4Pjgq9cclxuICAgICAgbW9ja1VwZGF0ZUV4ZWN1dGlvblN0YXR1cyh0cnVlKTtcclxuICAgICAgbW9ja1B1dERpc2Nsb3N1cmUodHJ1ZSk7XHJcbiAgICAgIG1vY2tQdXRQZGYodHJ1ZSk7XHJcblxyXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGhhbmRsZXIoZXZlbnQsIG1vY2tDb250ZXh0KTtcclxuXHJcbiAgICAgIC8vIOODrOOCueODneODs+OCueaknOiovFxyXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKCdzdWNjZXNzJyk7XHJcbiAgICAgIGV4cGVjdChyZXNwb25zZS5jb2xsZWN0ZWRfY291bnQpLnRvQmVHcmVhdGVyVGhhbigwKTtcclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmZhaWxlZF9jb3VudCkudG9CZSgwKTtcclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmV4ZWN1dGlvbl9pZCkudG9NYXRjaCgvXmV4ZWNfXFxkK19bYS16MC05XStfdGVzdC1yZXEvKTtcclxuXHJcbiAgICAgIC8vIOOCueOCr+ODrOOCpOODlOODs+OCsOOBjOWRvOOBsOOCjOOBn+OBk+OBqOOCkueiuuiqjVxyXG4gICAgICBleHBlY3QobW9ja1NjcmFwZVRkbmV0TGlzdCkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG5cclxuICAgICAgLy8gRHluYW1vREIvUzPjgYzlkbzjgbDjgozjgZ/jgZPjgajjgpLnorroqo1cclxuICAgICAgZXhwZWN0KGR5bmFtb01vY2suY29tbWFuZENhbGxzKFB1dENvbW1hbmQpLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gICAgICBleHBlY3QoZHluYW1vTW9jay5jb21tYW5kQ2FsbHMoVXBkYXRlQ29tbWFuZCkubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XHJcbiAgICAgIGV4cGVjdChzM01vY2suY29tbWFuZENhbGxzKFB1dE9iamVjdENvbW1hbmQpLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgc2NyYXBpbmcgZXJyb3JzIGdyYWNlZnVsbHkgaW4gYmF0Y2ggbW9kZScsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgZXZlbnQ6IENvbGxlY3RvckV2ZW50ID0ge1xyXG4gICAgICAgIG1vZGU6ICdiYXRjaCcsXHJcbiAgICAgIH07XHJcblxyXG4gICAgICAvLyDjgrnjgq/jg6zjgqTjg5Tjg7PjgrDjgqjjg6njg7zjgpLjg6Ljg4Pjgq9cclxuICAgICAgbW9ja1NjcmFwZVRkbmV0TGlzdC5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ05ldHdvcmsgZXJyb3InKSk7XHJcblxyXG4gICAgICAvLyDlrp/ooYznirbmhYvmm7TmlrDjga/miJDlip9cclxuICAgICAgbW9ja1VwZGF0ZUV4ZWN1dGlvblN0YXR1cyh0cnVlKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgaGFuZGxlcihldmVudCwgbW9ja0NvbnRleHQpO1xyXG5cclxuICAgICAgLy8g44Ko44Op44O844OP44Oz44OJ44Oq44Oz44Kw44Gu5qSc6Ki8XHJcbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoJ2ZhaWxlZCcpO1xyXG4gICAgICBleHBlY3QocmVzcG9uc2UuY29sbGVjdGVkX2NvdW50KS50b0JlKDApO1xyXG4gICAgICBleHBlY3QocmVzcG9uc2UuZmFpbGVkX2NvdW50KS50b0JlR3JlYXRlclRoYW4oMCk7XHJcblxyXG4gICAgICAvLyDlrp/ooYznirbmhYvjgYzmm7TmlrDjgZXjgozjgZ/jgZPjgajjgpLnorroqo1cclxuICAgICAgZXhwZWN0KGR5bmFtb01vY2suY29tbWFuZENhbGxzKFVwZGF0ZUNvbW1hbmQpLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdPbi1EZW1hbmQgTW9kZScsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgY29sbGVjdCBkYXRhIGZvciBzcGVjaWZpZWQgZGF0ZSByYW5nZScsIGFzeW5jICgpID0+IHtcclxuICAgICAgLy8gVXNlIHJlY2VudCBkYXRlcyAod2l0aGluIDEgeWVhcilcclxuICAgICAgY29uc3QgeWVzdGVyZGF5ID0gbmV3IERhdGUoKTtcclxuICAgICAgeWVzdGVyZGF5LnNldERhdGUoeWVzdGVyZGF5LmdldERhdGUoKSAtIDEpO1xyXG4gICAgICBjb25zdCB0aHJlZURheXNBZ28gPSBuZXcgRGF0ZSgpO1xyXG4gICAgICB0aHJlZURheXNBZ28uc2V0RGF0ZSh0aHJlZURheXNBZ28uZ2V0RGF0ZSgpIC0gMyk7XHJcblxyXG4gICAgICBjb25zdCBldmVudDogQ29sbGVjdG9yRXZlbnQgPSB7XHJcbiAgICAgICAgbW9kZTogJ29uLWRlbWFuZCcsXHJcbiAgICAgICAgc3RhcnRfZGF0ZTogdGhyZWVEYXlzQWdvLnRvSVNPU3RyaW5nKCkuc3Vic3RyaW5nKDAsIDEwKSxcclxuICAgICAgICBlbmRfZGF0ZTogeWVzdGVyZGF5LnRvSVNPU3RyaW5nKCkuc3Vic3RyaW5nKDAsIDEwKSxcclxuICAgICAgfTtcclxuXHJcbiAgICAgIC8vIOOCueOCr+ODrOOCpOODlOODs+OCsOe1kOaenOOCkuODouODg+OCr1xyXG4gICAgICBtb2NrU2NyYXBlVGRuZXRMaXN0Lm1vY2tSZXNvbHZlZFZhbHVlKFtcclxuICAgICAgICB7XHJcbiAgICAgICAgICBjb21wYW55X2NvZGU6ICcxMjM0JyxcclxuICAgICAgICAgIGNvbXBhbnlfbmFtZTogJ1Rlc3QgQ29tcGFueScsXHJcbiAgICAgICAgICBkaXNjbG9zdXJlX3R5cGU6ICfmsbrnrpfnn63kv6EnLFxyXG4gICAgICAgICAgdGl0bGU6ICdUZXN0IERpc2Nsb3N1cmUnLFxyXG4gICAgICAgICAgZGlzY2xvc2VkX2F0OiAnMjAyNC0wMS0xNVQwMTozMDowMFonLFxyXG4gICAgICAgICAgcGRmX3VybDogJ2h0dHBzOi8vZXhhbXBsZS5jb20vdGVzdC5wZGYnLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF0pO1xyXG5cclxuICAgICAgLy8gRHluYW1vREIvUzPjga7miJDlip/jgpLjg6Ljg4Pjgq9cclxuICAgICAgbW9ja1VwZGF0ZUV4ZWN1dGlvblN0YXR1cyh0cnVlKTtcclxuICAgICAgbW9ja1B1dERpc2Nsb3N1cmUodHJ1ZSk7XHJcbiAgICAgIG1vY2tQdXRQZGYodHJ1ZSk7XHJcblxyXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGhhbmRsZXIoZXZlbnQsIG1vY2tDb250ZXh0KTtcclxuXHJcbiAgICAgIC8vIOODrOOCueODneODs+OCueaknOiovFxyXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKCdzdWNjZXNzJyk7XHJcbiAgICAgIGV4cGVjdChyZXNwb25zZS5jb2xsZWN0ZWRfY291bnQpLnRvQmVHcmVhdGVyVGhhbigwKTtcclxuXHJcbiAgICAgIC8vIDPml6XliIbjga7jgrnjgq/jg6zjgqTjg5Tjg7PjgrDjgYzlrp/ooYzjgZXjgozjgZ/jgZPjgajjgpLnorroqo1cclxuICAgICAgZXhwZWN0KG1vY2tTY3JhcGVUZG5ldExpc3QpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygzKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgaGFuZGxlIHBhcnRpYWwgZmFpbHVyZXMgaW4gb24tZGVtYW5kIG1vZGUnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHllc3RlcmRheSA9IG5ldyBEYXRlKCk7XHJcbiAgICAgIHllc3RlcmRheS5zZXREYXRlKHllc3RlcmRheS5nZXREYXRlKCkgLSAxKTtcclxuICAgICAgY29uc3QgdGhyZWVEYXlzQWdvID0gbmV3IERhdGUoKTtcclxuICAgICAgdGhyZWVEYXlzQWdvLnNldERhdGUodGhyZWVEYXlzQWdvLmdldERhdGUoKSAtIDMpO1xyXG5cclxuICAgICAgY29uc3QgZXZlbnQ6IENvbGxlY3RvckV2ZW50ID0ge1xyXG4gICAgICAgIG1vZGU6ICdvbi1kZW1hbmQnLFxyXG4gICAgICAgIHN0YXJ0X2RhdGU6IHRocmVlRGF5c0Fnby50b0lTT1N0cmluZygpLnN1YnN0cmluZygwLCAxMCksXHJcbiAgICAgICAgZW5kX2RhdGU6IHllc3RlcmRheS50b0lTT1N0cmluZygpLnN1YnN0cmluZygwLCAxMCksXHJcbiAgICAgIH07XHJcblxyXG4gICAgICAvLyDpg6jliIbnmoTlpLHmlZfjgpLjg6Ljg4Pjgq/vvIgx5pel55uu5oiQ5Yqf44CBMuaXpeebruWkseaVl+OAgTPml6Xnm67miJDlip/vvIlcclxuICAgICAgbW9ja1NjcmFwZVRkbmV0TGlzdFxyXG4gICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoW1xyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICBjb21wYW55X2NvZGU6ICcxMjM0JyxcclxuICAgICAgICAgICAgY29tcGFueV9uYW1lOiAnVGVzdCBDb21wYW55JyxcclxuICAgICAgICAgICAgZGlzY2xvc3VyZV90eXBlOiAn5rG6566X55+t5L+hJyxcclxuICAgICAgICAgICAgdGl0bGU6ICdUZXN0IERpc2Nsb3N1cmUnLFxyXG4gICAgICAgICAgICBkaXNjbG9zZWRfYXQ6ICcyMDI0LTAxLTE1VDAxOjMwOjAwWicsXHJcbiAgICAgICAgICAgIHBkZl91cmw6ICdodHRwczovL2V4YW1wbGUuY29tL3Rlc3QucGRmJyxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgXSlcclxuICAgICAgICAubW9ja1JlamVjdGVkVmFsdWVPbmNlKG5ldyBFcnJvcignTmV0d29yayBlcnJvcicpKVxyXG4gICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoW1xyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICBjb21wYW55X2NvZGU6ICc1Njc4JyxcclxuICAgICAgICAgICAgY29tcGFueV9uYW1lOiAnQW5vdGhlciBDb21wYW55JyxcclxuICAgICAgICAgICAgZGlzY2xvc3VyZV90eXBlOiAn5pyJ5L6h6Ki85Yi45aCx5ZGK5pu4JyxcclxuICAgICAgICAgICAgdGl0bGU6ICdBbm90aGVyIERpc2Nsb3N1cmUnLFxyXG4gICAgICAgICAgICBkaXNjbG9zZWRfYXQ6ICcyMDI0LTAxLTE3VDAyOjAwOjAwWicsXHJcbiAgICAgICAgICAgIHBkZl91cmw6ICdodHRwczovL2V4YW1wbGUuY29tL3Rlc3QyLnBkZicsXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIF0pO1xyXG5cclxuICAgICAgLy8gRHluYW1vREIvUzPjga7miJDlip/jgpLjg6Ljg4Pjgq9cclxuICAgICAgbW9ja1VwZGF0ZUV4ZWN1dGlvblN0YXR1cyh0cnVlKTtcclxuICAgICAgbW9ja1B1dERpc2Nsb3N1cmUodHJ1ZSk7XHJcbiAgICAgIG1vY2tQdXRQZGYodHJ1ZSk7XHJcblxyXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGhhbmRsZXIoZXZlbnQsIG1vY2tDb250ZXh0KTtcclxuXHJcbiAgICAgIC8vIOmDqOWIhueahOaIkOWKn+OBruaknOiovFxyXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKCdwYXJ0aWFsX3N1Y2Nlc3MnKTtcclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmNvbGxlY3RlZF9jb3VudCkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gICAgICBleHBlY3QocmVzcG9uc2UuZmFpbGVkX2NvdW50KS50b0JlKDEpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdWYWxpZGF0aW9uJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgaW52YWxpZCBtb2RlJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBldmVudCA9IHtcclxuICAgICAgICBtb2RlOiAnaW52YWxpZCcsXHJcbiAgICAgIH0gYXMgYW55O1xyXG5cclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBoYW5kbGVyKGV2ZW50LCBtb2NrQ29udGV4dCk7XHJcblxyXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKCdmYWlsZWQnKTtcclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLm1lc3NhZ2UpLnRvQ29udGFpbignSW52YWxpZCBtb2RlJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHJlamVjdCBvbi1kZW1hbmQgbW9kZSB3aXRob3V0IHN0YXJ0X2RhdGUnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGV2ZW50OiBDb2xsZWN0b3JFdmVudCA9IHtcclxuICAgICAgICBtb2RlOiAnb24tZGVtYW5kJyxcclxuICAgICAgICBlbmRfZGF0ZTogJzIwMjQtMDEtMTUnLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBoYW5kbGVyKGV2ZW50LCBtb2NrQ29udGV4dCk7XHJcblxyXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKCdmYWlsZWQnKTtcclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLm1lc3NhZ2UpLnRvQ29udGFpbignc3RhcnRfZGF0ZSBhbmQgZW5kX2RhdGUgYXJlIHJlcXVpcmVkJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHJlamVjdCBpbnZhbGlkIGRhdGUgZm9ybWF0JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBldmVudDogQ29sbGVjdG9yRXZlbnQgPSB7XHJcbiAgICAgICAgbW9kZTogJ29uLWRlbWFuZCcsXHJcbiAgICAgICAgc3RhcnRfZGF0ZTogJzIwMjQvMDEvMTUnLFxyXG4gICAgICAgIGVuZF9kYXRlOiAnMjAyNC0wMS0yMCcsXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGhhbmRsZXIoZXZlbnQsIG1vY2tDb250ZXh0KTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoJ2ZhaWxlZCcpO1xyXG4gICAgICBleHBlY3QocmVzcG9uc2UubWVzc2FnZSkudG9Db250YWluKCdJbnZhbGlkIHN0YXJ0X2RhdGUgZm9ybWF0Jyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0FXUyBTREsgTW9jayBWZXJpZmljYXRpb24nLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHZlcmlmeSBEeW5hbW9EQiBjYWxscyB3aXRoIGF3cy1zZGstY2xpZW50LW1vY2snLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGV2ZW50OiBDb2xsZWN0b3JFdmVudCA9IHtcclxuICAgICAgICBtb2RlOiAnYmF0Y2gnLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgbW9ja1NjcmFwZVRkbmV0TGlzdC5tb2NrUmVzb2x2ZWRWYWx1ZShbXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgY29tcGFueV9jb2RlOiAnMTIzNCcsXHJcbiAgICAgICAgICBjb21wYW55X25hbWU6ICdUZXN0IENvbXBhbnknLFxyXG4gICAgICAgICAgZGlzY2xvc3VyZV90eXBlOiAn5rG6566X55+t5L+hJyxcclxuICAgICAgICAgIHRpdGxlOiAnVGVzdCBEaXNjbG9zdXJlJyxcclxuICAgICAgICAgIGRpc2Nsb3NlZF9hdDogJzIwMjQtMDEtMTVUMDE6MzA6MDBaJyxcclxuICAgICAgICAgIHBkZl91cmw6ICdodHRwczovL2V4YW1wbGUuY29tL3Rlc3QucGRmJyxcclxuICAgICAgICB9LFxyXG4gICAgICBdKTtcclxuXHJcbiAgICAgIG1vY2tVcGRhdGVFeGVjdXRpb25TdGF0dXModHJ1ZSk7XHJcbiAgICAgIG1vY2tQdXREaXNjbG9zdXJlKHRydWUpO1xyXG4gICAgICBtb2NrUHV0UGRmKHRydWUpO1xyXG5cclxuICAgICAgYXdhaXQgaGFuZGxlcihldmVudCwgbW9ja0NvbnRleHQpO1xyXG5cclxuICAgICAgLy8gYXdzLXNkay1jbGllbnQtbW9ja+OBruaknOiovOapn+iDveOCkuS9v+eUqFxyXG4gICAgICBjb25zdCBwdXRDYWxscyA9IGR5bmFtb01vY2suY29tbWFuZENhbGxzKFB1dENvbW1hbmQpO1xyXG4gICAgICBjb25zdCB1cGRhdGVDYWxscyA9IGR5bmFtb01vY2suY29tbWFuZENhbGxzKFVwZGF0ZUNvbW1hbmQpO1xyXG5cclxuICAgICAgZXhwZWN0KHB1dENhbGxzLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gICAgICBleHBlY3QodXBkYXRlQ2FsbHMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XHJcblxyXG4gICAgICAvLyDlkbzjgbPlh7rjgZfjg5Hjg6njg6Hjg7zjgr/jga7mpJzoqLxcclxuICAgICAgY29uc3QgZmlyc3RQdXRDYWxsID0gcHV0Q2FsbHNbMF07XHJcbiAgICAgIGV4cGVjdChmaXJzdFB1dENhbGwuYXJnc1swXS5pbnB1dC5UYWJsZU5hbWUpLnRvQmUoJ3Rlc3QtZGlzY2xvc3VyZXMtdGFibGUnKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgdmVyaWZ5IFMzIGNhbGxzIHdpdGggYXdzLXNkay1jbGllbnQtbW9jaycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgZXZlbnQ6IENvbGxlY3RvckV2ZW50ID0ge1xyXG4gICAgICAgIG1vZGU6ICdiYXRjaCcsXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBtb2NrU2NyYXBlVGRuZXRMaXN0Lm1vY2tSZXNvbHZlZFZhbHVlKFtcclxuICAgICAgICB7XHJcbiAgICAgICAgICBjb21wYW55X2NvZGU6ICcxMjM0JyxcclxuICAgICAgICAgIGNvbXBhbnlfbmFtZTogJ1Rlc3QgQ29tcGFueScsXHJcbiAgICAgICAgICBkaXNjbG9zdXJlX3R5cGU6ICfmsbrnrpfnn63kv6EnLFxyXG4gICAgICAgICAgdGl0bGU6ICdUZXN0IERpc2Nsb3N1cmUnLFxyXG4gICAgICAgICAgZGlzY2xvc2VkX2F0OiAnMjAyNC0wMS0xNVQwMTozMDowMFonLFxyXG4gICAgICAgICAgcGRmX3VybDogJ2h0dHBzOi8vZXhhbXBsZS5jb20vdGVzdC5wZGYnLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF0pO1xyXG5cclxuICAgICAgbW9ja1VwZGF0ZUV4ZWN1dGlvblN0YXR1cyh0cnVlKTtcclxuICAgICAgbW9ja1B1dERpc2Nsb3N1cmUodHJ1ZSk7XHJcbiAgICAgIG1vY2tQdXRQZGYodHJ1ZSk7XHJcblxyXG4gICAgICBhd2FpdCBoYW5kbGVyKGV2ZW50LCBtb2NrQ29udGV4dCk7XHJcblxyXG4gICAgICAvLyBTM+WRvOOBs+WHuuOBl+OBruaknOiovFxyXG4gICAgICBjb25zdCBzM0NhbGxzID0gczNNb2NrLmNvbW1hbmRDYWxscyhQdXRPYmplY3RDb21tYW5kKTtcclxuICAgICAgZXhwZWN0KHMzQ2FsbHMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XHJcblxyXG4gICAgICAvLyDlkbzjgbPlh7rjgZfjg5Hjg6njg6Hjg7zjgr/jga7mpJzoqLxcclxuICAgICAgY29uc3QgZmlyc3RTM0NhbGwgPSBzM0NhbGxzWzBdO1xyXG4gICAgICBleHBlY3QoZmlyc3RTM0NhbGwuYXJnc1swXS5pbnB1dC5CdWNrZXQpLnRvQmUoJ3Rlc3QtcGRmcy1idWNrZXQnKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTtcclxuIl0sInZlcnNpb24iOjN9