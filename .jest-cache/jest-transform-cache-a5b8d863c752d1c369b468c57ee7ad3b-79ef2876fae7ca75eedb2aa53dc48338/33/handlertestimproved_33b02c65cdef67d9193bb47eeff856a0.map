{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\__tests__\\handler.test.improved.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\__tests__\\handler.test.improved.ts"],"sourcesContent":["/**\r\n * Lambda Collector Handler - Improved Unit Tests\r\n *\r\n * このファイルは、DI パターンと aws-sdk-client-mock を使用した改善版テストの例です。\r\n * 既存の handler.test.ts を置き換える際の参考にしてください。\r\n *\r\n * Requirements: テスト環境の整備（Task 9.4）\r\n */\r\n\r\nimport { Context } from 'aws-lambda';\r\nimport { handler, CollectorEvent } from '../handler';\r\nimport { scrapeTdnetList } from '../scrape-tdnet-list';\r\nimport {\r\n  setupTestDependencies,\r\n  cleanupTestDependencies,\r\n  dynamoMock,\r\n  s3Mock,\r\n  cloudWatchMock,\r\n  mockPutDisclosure,\r\n  mockUpdateExecutionStatus,\r\n  mockPutPdf,\r\n} from './test-helpers';\r\nimport { PutCommand, UpdateCommand } from '@aws-sdk/lib-dynamodb';\r\nimport { PutObjectCommand } from '@aws-sdk/client-s3';\r\n\r\n// Mock dependencies\r\njest.mock('../scrape-tdnet-list');\r\nconst mockScrapeTdnetList = scrapeTdnetList as jest.MockedFunction<typeof scrapeTdnetList>;\r\n\r\ndescribe('Lambda Collector Handler - Improved Tests', () => {\r\n  let mockContext: Context;\r\n\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n\r\n    // テスト用依存関係をセットアップ（DI + aws-sdk-client-mock）\r\n    setupTestDependencies();\r\n\r\n    // Mock Lambda Context\r\n    mockContext = {\r\n      awsRequestId: 'test-request-id-12345',\r\n      functionName: 'test-collector-function',\r\n      functionVersion: '1',\r\n      invokedFunctionArn: 'arn:aws:lambda:us-east-1:123456789012:function:test',\r\n      memoryLimitInMB: '512',\r\n      logGroupName: '/aws/lambda/test',\r\n      logStreamName: '2024/01/15/[$LATEST]test',\r\n      getRemainingTimeInMillis: () => 30000,\r\n      done: jest.fn(),\r\n      fail: jest.fn(),\r\n      succeed: jest.fn(),\r\n      callbackWaitsForEmptyEventLoop: true,\r\n    };\r\n\r\n    // 環境変数を設定\r\n    process.env.DYNAMODB_TABLE = 'test-disclosures-table';\r\n    process.env.DYNAMODB_EXECUTIONS_TABLE = 'test-executions-table';\r\n    process.env.S3_BUCKET = 'test-pdfs-bucket';\r\n    process.env.LOG_LEVEL = 'error'; // テスト時はエラーログのみ\r\n  });\r\n\r\n  afterEach(() => {\r\n    // テスト用依存関係をクリーンアップ\r\n    cleanupTestDependencies();\r\n  });\r\n\r\n  describe('Batch Mode', () => {\r\n    it('should collect yesterday\\'s data in batch mode', async () => {\r\n      const event: CollectorEvent = {\r\n        mode: 'batch',\r\n      };\r\n\r\n      // スクレイピング結果をモック\r\n      mockScrapeTdnetList.mockResolvedValue([\r\n        {\r\n          company_code: '1234',\r\n          company_name: 'Test Company',\r\n          disclosure_type: '決算短信',\r\n          title: 'Test Disclosure',\r\n          disclosed_at: '2024-01-15T01:30:00Z',\r\n          pdf_url: 'https://example.com/test.pdf',\r\n        },\r\n      ]);\r\n\r\n      // DynamoDB/S3の成功をモック\r\n      mockUpdateExecutionStatus(true);\r\n      mockPutDisclosure(true);\r\n      mockPutPdf(true);\r\n\r\n      const response = await handler(event, mockContext);\r\n\r\n      // レスポンス検証\r\n      expect(response.status).toBe('success');\r\n      expect(response.collected_count).toBeGreaterThan(0);\r\n      expect(response.failed_count).toBe(0);\r\n      expect(response.execution_id).toMatch(/^exec_\\d+_[a-z0-9]+_test-req/);\r\n\r\n      // スクレイピングが呼ばれたことを確認\r\n      expect(mockScrapeTdnetList).toHaveBeenCalled();\r\n\r\n      // DynamoDB/S3が呼ばれたことを確認\r\n      expect(dynamoMock.commandCalls(PutCommand).length).toBeGreaterThan(0);\r\n      expect(dynamoMock.commandCalls(UpdateCommand).length).toBeGreaterThan(0);\r\n      expect(s3Mock.commandCalls(PutObjectCommand).length).toBeGreaterThan(0);\r\n    });\r\n\r\n    it('should handle scraping errors gracefully in batch mode', async () => {\r\n      const event: CollectorEvent = {\r\n        mode: 'batch',\r\n      };\r\n\r\n      // スクレイピングエラーをモック\r\n      mockScrapeTdnetList.mockRejectedValue(new Error('Network error'));\r\n\r\n      // 実行状態更新は成功\r\n      mockUpdateExecutionStatus(true);\r\n\r\n      const response = await handler(event, mockContext);\r\n\r\n      // エラーハンドリングの検証\r\n      expect(response.status).toBe('failed');\r\n      expect(response.collected_count).toBe(0);\r\n      expect(response.failed_count).toBeGreaterThan(0);\r\n\r\n      // 実行状態が更新されたことを確認\r\n      expect(dynamoMock.commandCalls(UpdateCommand).length).toBeGreaterThan(0);\r\n    });\r\n  });\r\n\r\n  describe('On-Demand Mode', () => {\r\n    it('should collect data for specified date range', async () => {\r\n      // Use recent dates (within 1 year)\r\n      const yesterday = new Date();\r\n      yesterday.setDate(yesterday.getDate() - 1);\r\n      const threeDaysAgo = new Date();\r\n      threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);\r\n\r\n      const event: CollectorEvent = {\r\n        mode: 'on-demand',\r\n        start_date: threeDaysAgo.toISOString().substring(0, 10),\r\n        end_date: yesterday.toISOString().substring(0, 10),\r\n      };\r\n\r\n      // スクレイピング結果をモック\r\n      mockScrapeTdnetList.mockResolvedValue([\r\n        {\r\n          company_code: '1234',\r\n          company_name: 'Test Company',\r\n          disclosure_type: '決算短信',\r\n          title: 'Test Disclosure',\r\n          disclosed_at: '2024-01-15T01:30:00Z',\r\n          pdf_url: 'https://example.com/test.pdf',\r\n        },\r\n      ]);\r\n\r\n      // DynamoDB/S3の成功をモック\r\n      mockUpdateExecutionStatus(true);\r\n      mockPutDisclosure(true);\r\n      mockPutPdf(true);\r\n\r\n      const response = await handler(event, mockContext);\r\n\r\n      // レスポンス検証\r\n      expect(response.status).toBe('success');\r\n      expect(response.collected_count).toBeGreaterThan(0);\r\n\r\n      // 3日分のスクレイピングが実行されたことを確認\r\n      expect(mockScrapeTdnetList).toHaveBeenCalledTimes(3);\r\n    });\r\n\r\n    it('should handle partial failures in on-demand mode', async () => {\r\n      const yesterday = new Date();\r\n      yesterday.setDate(yesterday.getDate() - 1);\r\n      const threeDaysAgo = new Date();\r\n      threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);\r\n\r\n      const event: CollectorEvent = {\r\n        mode: 'on-demand',\r\n        start_date: threeDaysAgo.toISOString().substring(0, 10),\r\n        end_date: yesterday.toISOString().substring(0, 10),\r\n      };\r\n\r\n      // 部分的失敗をモック（1日目成功、2日目失敗、3日目成功）\r\n      mockScrapeTdnetList\r\n        .mockResolvedValueOnce([\r\n          {\r\n            company_code: '1234',\r\n            company_name: 'Test Company',\r\n            disclosure_type: '決算短信',\r\n            title: 'Test Disclosure',\r\n            disclosed_at: '2024-01-15T01:30:00Z',\r\n            pdf_url: 'https://example.com/test.pdf',\r\n          },\r\n        ])\r\n        .mockRejectedValueOnce(new Error('Network error'))\r\n        .mockResolvedValueOnce([\r\n          {\r\n            company_code: '5678',\r\n            company_name: 'Another Company',\r\n            disclosure_type: '有価証券報告書',\r\n            title: 'Another Disclosure',\r\n            disclosed_at: '2024-01-17T02:00:00Z',\r\n            pdf_url: 'https://example.com/test2.pdf',\r\n          },\r\n        ]);\r\n\r\n      // DynamoDB/S3の成功をモック\r\n      mockUpdateExecutionStatus(true);\r\n      mockPutDisclosure(true);\r\n      mockPutPdf(true);\r\n\r\n      const response = await handler(event, mockContext);\r\n\r\n      // 部分的成功の検証\r\n      expect(response.status).toBe('partial_success');\r\n      expect(response.collected_count).toBeGreaterThan(0);\r\n      expect(response.failed_count).toBe(1);\r\n    });\r\n  });\r\n\r\n  describe('Validation', () => {\r\n    it('should reject invalid mode', async () => {\r\n      const event = {\r\n        mode: 'invalid',\r\n      } as any;\r\n\r\n      const response = await handler(event, mockContext);\r\n\r\n      expect(response.status).toBe('failed');\r\n      expect(response.message).toContain('Invalid mode');\r\n    });\r\n\r\n    it('should reject on-demand mode without start_date', async () => {\r\n      const event: CollectorEvent = {\r\n        mode: 'on-demand',\r\n        end_date: '2024-01-15',\r\n      };\r\n\r\n      const response = await handler(event, mockContext);\r\n\r\n      expect(response.status).toBe('failed');\r\n      expect(response.message).toContain('start_date and end_date are required');\r\n    });\r\n\r\n    it('should reject invalid date format', async () => {\r\n      const event: CollectorEvent = {\r\n        mode: 'on-demand',\r\n        start_date: '2024/01/15',\r\n        end_date: '2024-01-20',\r\n      };\r\n\r\n      const response = await handler(event, mockContext);\r\n\r\n      expect(response.status).toBe('failed');\r\n      expect(response.message).toContain('Invalid start_date format');\r\n    });\r\n  });\r\n\r\n  describe('AWS SDK Mock Verification', () => {\r\n    it('should verify DynamoDB calls with aws-sdk-client-mock', async () => {\r\n      const event: CollectorEvent = {\r\n        mode: 'batch',\r\n      };\r\n\r\n      mockScrapeTdnetList.mockResolvedValue([\r\n        {\r\n          company_code: '1234',\r\n          company_name: 'Test Company',\r\n          disclosure_type: '決算短信',\r\n          title: 'Test Disclosure',\r\n          disclosed_at: '2024-01-15T01:30:00Z',\r\n          pdf_url: 'https://example.com/test.pdf',\r\n        },\r\n      ]);\r\n\r\n      mockUpdateExecutionStatus(true);\r\n      mockPutDisclosure(true);\r\n      mockPutPdf(true);\r\n\r\n      await handler(event, mockContext);\r\n\r\n      // aws-sdk-client-mockの検証機能を使用\r\n      const putCalls = dynamoMock.commandCalls(PutCommand);\r\n      const updateCalls = dynamoMock.commandCalls(UpdateCommand);\r\n\r\n      expect(putCalls.length).toBeGreaterThan(0);\r\n      expect(updateCalls.length).toBeGreaterThan(0);\r\n\r\n      // 呼び出しパラメータの検証\r\n      const firstPutCall = putCalls[0];\r\n      expect(firstPutCall.args[0].input.TableName).toBe('test-disclosures-table');\r\n    });\r\n\r\n    it('should verify S3 calls with aws-sdk-client-mock', async () => {\r\n      const event: CollectorEvent = {\r\n        mode: 'batch',\r\n      };\r\n\r\n      mockScrapeTdnetList.mockResolvedValue([\r\n        {\r\n          company_code: '1234',\r\n          company_name: 'Test Company',\r\n          disclosure_type: '決算短信',\r\n          title: 'Test Disclosure',\r\n          disclosed_at: '2024-01-15T01:30:00Z',\r\n          pdf_url: 'https://example.com/test.pdf',\r\n        },\r\n      ]);\r\n\r\n      mockUpdateExecutionStatus(true);\r\n      mockPutDisclosure(true);\r\n      mockPutPdf(true);\r\n\r\n      await handler(event, mockContext);\r\n\r\n      // S3呼び出しの検証\r\n      const s3Calls = s3Mock.commandCalls(PutObjectCommand);\r\n      expect(s3Calls.length).toBeGreaterThan(0);\r\n\r\n      // 呼び出しパラメータの検証\r\n      const firstS3Call = s3Calls[0];\r\n      expect(firstS3Call.args[0].input.Bucket).toBe('test-pdfs-bucket');\r\n    });\r\n  });\r\n});\r\n"],"version":3}