df8204cabf6c34b48ce9e67dac930070
"use strict";
/**
 * Lambda Collect Handler
 *
 * POST /collect エンドポイントのハンドラー。
 * Lambda Collectorを非同期で呼び出し、実行IDを返却します。
 *
 * Requirements: タスク13.1
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const client_lambda_1 = require("@aws-sdk/client-lambda");
const logger_1 = require("../../utils/logger");
const cloudwatch_metrics_1 = require("../../utils/cloudwatch-metrics");
const errors_1 = require("../../errors");
// Lambda クライアントはグローバルスコープで初期化（再利用される）
const lambdaClient = new client_lambda_1.LambdaClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });
// 環境変数
const COLLECTOR_FUNCTION_NAME = process.env.COLLECTOR_FUNCTION_NAME || 'tdnet-collector';
/**
 * Lambda Collect ハンドラー
 *
 * @param event API Gateway Proxy Event
 * @param context Lambda Context
 * @returns API Gateway Proxy Result
 */
async function handler(event, context) {
    try {
        logger_1.logger.info('POST /collect invoked', {
            requestId: context.requestId,
            functionName: context.functionName,
        });
        // リクエストボディのパース
        if (!event.body) {
            throw new errors_1.ValidationError('Request body is required');
        }
        const request = JSON.parse(event.body);
        // バリデーション
        validateRequest(request);
        // Lambda Collectorを非同期で呼び出し
        const execution_id = await invokeCollector(request, context);
        // レスポンス
        const response = {
            status: 'success',
            data: {
                execution_id,
                status: 'pending',
                message: 'Data collection started successfully',
                started_at: new Date().toISOString(),
            },
        };
        logger_1.logger.info('POST /collect completed', {
            requestId: context.requestId,
            execution_id,
        });
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify(response),
        };
    }
    catch (error) {
        logger_1.logger.error('POST /collect failed', (0, logger_1.createErrorContext)(error, {
            requestId: context.requestId,
            event,
        }));
        // エラーメトリクス送信
        await (0, cloudwatch_metrics_1.sendErrorMetric)(error instanceof Error ? error.constructor.name : 'Unknown', 'Collect', {});
        return toErrorResponse(error, context.requestId);
    }
}
/**
 * リクエストのバリデーション
 *
 * @param request CollectRequest
 * @throws ValidationError バリデーションエラー
 */
function validateRequest(request) {
    // start_date のバリデーション
    if (!request.start_date) {
        throw new errors_1.ValidationError('start_date is required');
    }
    // end_date のバリデーション
    if (!request.end_date) {
        throw new errors_1.ValidationError('end_date is required');
    }
    // 日付フォーマットのバリデーション（YYYY-MM-DD）
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateRegex.test(request.start_date)) {
        throw new errors_1.ValidationError(`Invalid start_date format: ${request.start_date}. Expected YYYY-MM-DD format.`);
    }
    if (!dateRegex.test(request.end_date)) {
        throw new errors_1.ValidationError(`Invalid end_date format: ${request.end_date}. Expected YYYY-MM-DD format.`);
    }
    // 日付の有効性チェック
    const startDate = new Date(request.start_date);
    const endDate = new Date(request.end_date);
    if (isNaN(startDate.getTime())) {
        throw new errors_1.ValidationError(`Invalid start_date: ${request.start_date}. Date does not exist.`);
    }
    if (isNaN(endDate.getTime())) {
        throw new errors_1.ValidationError(`Invalid end_date: ${request.end_date}. Date does not exist.`);
    }
    // 日付順序チェック
    if (startDate > endDate) {
        throw new errors_1.ValidationError(`start_date (${request.start_date}) must be before or equal to end_date (${request.end_date})`);
    }
    // 範囲チェック（過去1年以内）
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
    if (startDate < oneYearAgo) {
        throw new errors_1.ValidationError(`start_date (${request.start_date}) is too old. Maximum range is 1 year.`);
    }
    // 未来日チェック
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    if (endDate > tomorrow) {
        throw new errors_1.ValidationError(`end_date (${request.end_date}) cannot be in the future.`);
    }
}
/**
 * Lambda Collectorを非同期で呼び出し
 *
 * @param request CollectRequest
 * @param context Lambda Context
 * @returns 実行ID
 */
async function invokeCollector(request, context) {
    // Lambda Collectorのイベント
    const collectorEvent = {
        mode: 'on-demand',
        start_date: request.start_date,
        end_date: request.end_date,
    };
    logger_1.logger.info('Invoking Lambda Collector', {
        requestId: context.requestId,
        functionName: COLLECTOR_FUNCTION_NAME,
        event: collectorEvent,
    });
    try {
        // Lambda Collectorを非同期で呼び出し（InvocationType: Event）
        const command = new client_lambda_1.InvokeCommand({
            FunctionName: COLLECTOR_FUNCTION_NAME,
            InvocationType: 'Event', // 非同期呼び出し
            Payload: Buffer.from(JSON.stringify(collectorEvent)),
        });
        const response = await lambdaClient.send(command);
        logger_1.logger.info('Lambda Collector invoked successfully', {
            requestId: context.requestId,
            statusCode: response.StatusCode,
        });
        // 実行IDを生成（Lambda Collectorが生成するexecution_idとは異なる）
        // Lambda Collectorのレスポンスは非同期呼び出しでは取得できないため、
        // ここで一時的な実行IDを生成し、後でLambda Collectorが生成した
        // execution_idに置き換える必要があります。
        //
        // 改善案: Lambda Collectorの実行IDをDynamoDBに保存し、
        // GET /collect/{execution_id} で取得できるようにする。
        const execution_id = generateExecutionId(context);
        return execution_id;
    }
    catch (error) {
        logger_1.logger.error('Failed to invoke Lambda Collector', (0, logger_1.createErrorContext)(error, {
            requestId: context.requestId,
            functionName: COLLECTOR_FUNCTION_NAME,
        }));
        throw new Error('Failed to start data collection');
    }
}
/**
 * 実行IDを生成
 *
 * @param context Lambda Context
 * @returns 実行ID
 */
function generateExecutionId(context) {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 8);
    return `exec_${timestamp}_${random}_${context.awsRequestId.substring(0, 8)}`;
}
/**
 * エラーレスポンスを生成
 *
 * @param error Error
 * @param requestId リクエストID
 * @returns API Gateway Proxy Result
 */
function toErrorResponse(error, requestId) {
    const errorCodeMap = {
        ValidationError: { statusCode: 400, code: 'VALIDATION_ERROR' },
        UnauthorizedError: { statusCode: 401, code: 'UNAUTHORIZED' },
        ForbiddenError: { statusCode: 403, code: 'FORBIDDEN' },
        NotFoundError: { statusCode: 404, code: 'NOT_FOUND' },
        ConflictError: { statusCode: 409, code: 'CONFLICT' },
        RateLimitError: { statusCode: 429, code: 'RATE_LIMIT_EXCEEDED' },
        InternalError: { statusCode: 500, code: 'INTERNAL_ERROR' },
        ServiceUnavailableError: { statusCode: 503, code: 'SERVICE_UNAVAILABLE' },
        GatewayTimeoutError: { statusCode: 504, code: 'GATEWAY_TIMEOUT' },
    };
    const mapping = errorCodeMap[error.name] || {
        statusCode: 500,
        code: 'INTERNAL_ERROR',
    };
    return {
        statusCode: mapping.statusCode,
        headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
        },
        body: JSON.stringify({
            status: 'error',
            error: {
                code: mapping.code,
                message: error.message,
                details: error.details || {},
            },
            request_id: requestId,
        }),
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGNvbGxlY3RcXGhhbmRsZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7O0dBT0c7O0FBdURILDBCQWlFQztBQXJIRCwwREFBcUU7QUFDckUsK0NBQWdFO0FBQ2hFLHVFQUFpRTtBQUNqRSx5Q0FBK0M7QUFFL0Msc0NBQXNDO0FBQ3RDLE1BQU0sWUFBWSxHQUFHLElBQUksNEJBQVksQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7QUFFOUYsT0FBTztBQUNQLE1BQU0sdUJBQXVCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsSUFBSSxpQkFBaUIsQ0FBQztBQW9DekY7Ozs7OztHQU1HO0FBQ0ksS0FBSyxVQUFVLE9BQU8sQ0FDM0IsS0FBMkIsRUFDM0IsT0FBZ0I7SUFFaEIsSUFBSSxDQUFDO1FBQ0gsZUFBTSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRTtZQUNuQyxTQUFTLEVBQUUsT0FBTyxDQUFDLFNBQVM7WUFDNUIsWUFBWSxFQUFFLE9BQU8sQ0FBQyxZQUFZO1NBQ25DLENBQUMsQ0FBQztRQUVILGVBQWU7UUFDZixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2hCLE1BQU0sSUFBSSx3QkFBZSxDQUFDLDBCQUEwQixDQUFDLENBQUM7UUFDeEQsQ0FBQztRQUVELE1BQU0sT0FBTyxHQUFtQixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV2RCxVQUFVO1FBQ1YsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXpCLDRCQUE0QjtRQUM1QixNQUFNLFlBQVksR0FBRyxNQUFNLGVBQWUsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFN0QsUUFBUTtRQUNSLE1BQU0sUUFBUSxHQUFvQjtZQUNoQyxNQUFNLEVB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LGdCQUFnQjtLQUN2QixDQUFDO0lBRUYsT0FBTztRQUNMLFVBQVUsRUFBRSxPQUFPLENBQUMsVUFBVTtRQUM5QixPQUFPLEVBQUU7WUFDUCxjQUFjLEVBQUUsa0JBQWtCO1lBQ2xDLDZCQUE2QixFQUFFLEdBQUc7U0FDbkM7UUFDRCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUNuQixNQUFNLEVBQUUsT0FBTztZQUNmLEtBQUssRUFBRTtnQkFDTCxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUk7Z0JBQ2xCLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTztnQkFDdEIsT0FBTyxFQUFHLEtBQWEsQ0FBQyxPQUFPLElBQUksRUFBRTthQUN0QztZQUNELFVBQVUsRUFBRSxTQUFTO1NBQ3RCLENBQUM7S0FDSCxDQUFDO0FBQ0osQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpMTk4XFxpbnZlc3RtZW50X2FuYWx5c2lzX29wb3BvXFxzcmNcXGxhbWJkYVxcY29sbGVjdFxcaGFuZGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogTGFtYmRhIENvbGxlY3QgSGFuZGxlclxyXG4gKlxyXG4gKiBQT1NUIC9jb2xsZWN0IOOCqOODs+ODieODneOCpOODs+ODiOOBruODj+ODs+ODieODqeODvOOAglxyXG4gKiBMYW1iZGEgQ29sbGVjdG9y44KS6Z2e5ZCM5pyf44Gn5ZG844Gz5Ye644GX44CB5a6f6KGMSUTjgpLov5TljbTjgZfjgb7jgZnjgIJcclxuICpcclxuICogUmVxdWlyZW1lbnRzOiDjgr/jgrnjgq8xMy4xXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCwgQ29udGV4dCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xyXG5pbXBvcnQgeyBMYW1iZGFDbGllbnQsIEludm9rZUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtbGFtYmRhJztcclxuaW1wb3J0IHsgbG9nZ2VyLCBjcmVhdGVFcnJvckNvbnRleHQgfSBmcm9tICcuLi8uLi91dGlscy9sb2dnZXInO1xyXG5pbXBvcnQgeyBzZW5kRXJyb3JNZXRyaWMgfSBmcm9tICcuLi8uLi91dGlscy9jbG91ZHdhdGNoLW1ldHJpY3MnO1xyXG5pbXBvcnQgeyBWYWxpZGF0aW9uRXJyb3IgfSBmcm9tICcuLi8uLi9lcnJvcnMnO1xyXG5cclxuLy8gTGFtYmRhIOOCr+ODqeOCpOOCouODs+ODiOOBr+OCsOODreODvOODkOODq+OCueOCs+ODvOODl+OBp+WIneacn+WMlu+8iOWGjeWIqeeUqOOBleOCjOOCi++8iVxyXG5jb25zdCBsYW1iZGFDbGllbnQgPSBuZXcgTGFtYmRhQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICdhcC1ub3J0aGVhc3QtMScgfSk7XHJcblxyXG4vLyDnkrDlooPlpInmlbBcclxuY29uc3QgQ09MTEVDVE9SX0ZVTkNUSU9OX05BTUUgPSBwcm9jZXNzLmVudi5DT0xMRUNUT1JfRlVOQ1RJT05fTkFNRSB8fCAndGRuZXQtY29sbGVjdG9yJztcclxuXHJcbi8qKlxyXG4gKiBQT1NUIC9jb2xsZWN0IOODquOCr+OCqOOCueODiOODnOODh+OCo1xyXG4gKi9cclxuaW50ZXJmYWNlIENvbGxlY3RSZXF1ZXN0IHtcclxuICAvKiog6ZaL5aeL5pel77yIWVlZWS1NTS1EROW9ouW8j++8iSAqL1xyXG4gIHN0YXJ0X2RhdGU6IHN0cmluZztcclxuXHJcbiAgLyoqIOe1guS6huaXpe+8iFlZWVktTU0tRETlvaLlvI/vvIkgKi9cclxuICBlbmRfZGF0ZTogc3RyaW5nO1xyXG59XHJcblxyXG4vKipcclxuICogUE9TVCAvY29sbGVjdCDjg6zjgrnjg53jg7PjgrlcclxuICovXHJcbmludGVyZmFjZSBDb2xsZWN0UmVzcG9uc2Uge1xyXG4gIC8qKiDjgrnjg4bjg7zjgr/jgrkgKi9cclxuICBzdGF0dXM6ICdzdWNjZXNzJztcclxuXHJcbiAgLyoqIOODh+ODvOOCvyAqL1xyXG4gIGRhdGE6IHtcclxuICAgIC8qKiDlrp/ooYxJRCAqL1xyXG4gICAgZXhlY3V0aW9uX2lkOiBzdHJpbmc7XHJcblxyXG4gICAgLyoqIOeKtuaFiyAqL1xyXG4gICAgc3RhdHVzOiAncGVuZGluZyc7XHJcblxyXG4gICAgLyoqIOODoeODg+OCu+ODvOOCuCAqL1xyXG4gICAgbWVzc2FnZTogc3RyaW5nO1xyXG5cclxuICAgIC8qKiDplovlp4vml6XmmYIgKi9cclxuICAgIHN0YXJ0ZWRfYXQ6IHN0cmluZztcclxuICB9O1xyXG59XHJcblxyXG4vKipcclxuICogTGFtYmRhIENvbGxlY3Qg44OP44Oz44OJ44Op44O8XHJcbiAqXHJcbiAqIEBwYXJhbSBldmVudCBBUEkgR2F0ZXdheSBQcm94eSBFdmVudFxyXG4gKiBAcGFyYW0gY29udGV4dCBMYW1iZGEgQ29udGV4dFxyXG4gKiBAcmV0dXJucyBBUEkgR2F0ZXdheSBQcm94eSBSZXN1bHRcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVyKFxyXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCxcclxuICBjb250ZXh0OiBDb250ZXh0XHJcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XHJcbiAgdHJ5IHtcclxuICAgIGxvZ2dlci5pbmZvKCdQT1NUIC9jb2xsZWN0IGludm9rZWQnLCB7XHJcbiAgICAgIHJlcXVlc3RJZDogY29udGV4dC5yZXF1ZXN0SWQsXHJcbiAgICAgIGZ1bmN0aW9uTmFtZTogY29udGV4dC5mdW5jdGlvbk5hbWUsXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyDjg6rjgq/jgqjjgrnjg4jjg5zjg4fjgqPjga7jg5Hjg7zjgrlcclxuICAgIGlmICghZXZlbnQuYm9keSkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdSZXF1ZXN0IGJvZHkgaXMgcmVxdWlyZWQnKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCByZXF1ZXN0OiBDb2xsZWN0UmVxdWVzdCA9IEpTT04ucGFyc2UoZXZlbnQuYm9keSk7XHJcblxyXG4gICAgLy8g44OQ44Oq44OH44O844K344On44OzXHJcbiAgICB2YWxpZGF0ZVJlcXVlc3QocmVxdWVzdCk7XHJcblxyXG4gICAgLy8gTGFtYmRhIENvbGxlY3RvcuOCkumdnuWQjOacn+OBp+WRvOOBs+WHuuOBl1xyXG4gICAgY29uc3QgZXhlY3V0aW9uX2lkID0gYXdhaXQgaW52b2tlQ29sbGVjdG9yKHJlcXVlc3QsIGNvbnRleHQpO1xyXG5cclxuICAgIC8vIOODrOOCueODneODs+OCuVxyXG4gICAgY29uc3QgcmVzcG9uc2U6IENvbGxlY3RSZXNwb25zZSA9IHtcclxuICAgICAgc3RhdHVzOiAnc3VjY2VzcycsXHJcbiAgICAgIGRhdGE6IHtcclxuICAgICAgICBleGVjdXRpb25faWQsXHJcbiAgICAgICAgc3RhdHVzOiAncGVuZGluZycsXHJcbiAgICAgICAgbWVzc2FnZTogJ0RhdGEgY29sbGVjdGlvbiBzdGFydGVkIHN1Y2Nlc3NmdWxseScsXHJcbiAgICAgICAgc3RhcnRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgICB9LFxyXG4gICAgfTtcclxuXHJcbiAgICBsb2dnZXIuaW5mbygnUE9TVCAvY29sbGVjdCBjb21wbGV0ZWQnLCB7XHJcbiAgICAgIHJlcXVlc3RJZDogY29udGV4dC5yZXF1ZXN0SWQsXHJcbiAgICAgIGV4ZWN1dGlvbl9pZCxcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcclxuICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgICAgfSxcclxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpLFxyXG4gICAgfTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgbG9nZ2VyLmVycm9yKFxyXG4gICAgICAnUE9TVCAvY29sbGVjdCBmYWlsZWQnLFxyXG4gICAgICBjcmVhdGVFcnJvckNvbnRleHQoZXJyb3IgYXMgRXJyb3IsIHtcclxuICAgICAgICByZXF1ZXN0SWQ6IGNvbnRleHQucmVxdWVzdElkLFxyXG4gICAgICAgIGV2ZW50LFxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICAvLyDjgqjjg6njg7zjg6Hjg4jjg6rjgq/jgrnpgIHkv6FcclxuICAgIGF3YWl0IHNlbmRFcnJvck1ldHJpYyhcclxuICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLmNvbnN0cnVjdG9yLm5hbWUgOiAnVW5rbm93bicsXHJcbiAgICAgICdDb2xsZWN0JyxcclxuICAgICAge31cclxuICAgICk7XHJcblxyXG4gICAgcmV0dXJuIHRvRXJyb3JSZXNwb25zZShlcnJvciBhcyBFcnJvciwgY29udGV4dC5yZXF1ZXN0SWQpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOODquOCr+OCqOOCueODiOOBruODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gKlxyXG4gKiBAcGFyYW0gcmVxdWVzdCBDb2xsZWN0UmVxdWVzdFxyXG4gKiBAdGhyb3dzIFZhbGlkYXRpb25FcnJvciDjg5Djg6rjg4fjg7zjgrfjg6fjg7Pjgqjjg6njg7xcclxuICovXHJcbmZ1bmN0aW9uIHZhbGlkYXRlUmVxdWVzdChyZXF1ZXN0OiBDb2xsZWN0UmVxdWVzdCk6IHZvaWQge1xyXG4gIC8vIHN0YXJ0X2RhdGUg44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAgaWYgKCFyZXF1ZXN0LnN0YXJ0X2RhdGUpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ3N0YXJ0X2RhdGUgaXMgcmVxdWlyZWQnKTtcclxuICB9XHJcblxyXG4gIC8vIGVuZF9kYXRlIOOBruODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gIGlmICghcmVxdWVzdC5lbmRfZGF0ZSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignZW5kX2RhdGUgaXMgcmVxdWlyZWQnKTtcclxuICB9XHJcblxyXG4gIC8vIOaXpeS7mOODleOCqeODvOODnuODg+ODiOOBruODkOODquODh+ODvOOCt+ODp+ODs++8iFlZWVktTU0tRETvvIlcclxuICBjb25zdCBkYXRlUmVnZXggPSAvXlxcZHs0fS1cXGR7Mn0tXFxkezJ9JC87XHJcbiAgaWYgKCFkYXRlUmVnZXgudGVzdChyZXF1ZXN0LnN0YXJ0X2RhdGUpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCBzdGFydF9kYXRlIGZvcm1hdDogJHtyZXF1ZXN0LnN0YXJ0X2RhdGV9LiBFeHBlY3RlZCBZWVlZLU1NLUREIGZvcm1hdC5gXHJcbiAgICApO1xyXG4gIH1cclxuICBpZiAoIWRhdGVSZWdleC50ZXN0KHJlcXVlc3QuZW5kX2RhdGUpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCBlbmRfZGF0ZSBmb3JtYXQ6ICR7cmVxdWVzdC5lbmRfZGF0ZX0uIEV4cGVjdGVkIFlZWVktTU0tREQgZm9ybWF0LmBcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvLyDml6Xku5jjga7mnInlirnmgKfjg4Hjgqfjg4Pjgq9cclxuICBjb25zdCBzdGFydERhdGUgPSBuZXcgRGF0ZShyZXF1ZXN0LnN0YXJ0X2RhdGUpO1xyXG4gIGNvbnN0IGVuZERhdGUgPSBuZXcgRGF0ZShyZXF1ZXN0LmVuZF9kYXRlKTtcclxuXHJcbiAgaWYgKGlzTmFOKHN0YXJ0RGF0ZS5nZXRUaW1lKCkpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCBzdGFydF9kYXRlOiAke3JlcXVlc3Quc3RhcnRfZGF0ZX0uIERhdGUgZG9lcyBub3QgZXhpc3QuYFxyXG4gICAgKTtcclxuICB9XHJcbiAgaWYgKGlzTmFOKGVuZERhdGUuZ2V0VGltZSgpKSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEludmFsaWQgZW5kX2RhdGU6ICR7cmVxdWVzdC5lbmRfZGF0ZX0uIERhdGUgZG9lcyBub3QgZXhpc3QuYFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIOaXpeS7mOmghuW6j+ODgeOCp+ODg+OCr1xyXG4gIGlmIChzdGFydERhdGUgPiBlbmREYXRlKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgc3RhcnRfZGF0ZSAoJHtyZXF1ZXN0LnN0YXJ0X2RhdGV9KSBtdXN0IGJlIGJlZm9yZSBvciBlcXVhbCB0byBlbmRfZGF0ZSAoJHtyZXF1ZXN0LmVuZF9kYXRlfSlgXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8g56+E5Zuy44OB44Kn44OD44Kv77yI6YGO5Y67MeW5tOS7peWGhe+8iVxyXG4gIGNvbnN0IG9uZVllYXJBZ28gPSBuZXcgRGF0ZSgpO1xyXG4gIG9uZVllYXJBZ28uc2V0RnVsbFllYXIob25lWWVhckFnby5nZXRGdWxsWWVhcigpIC0gMSk7XHJcbiAgaWYgKHN0YXJ0RGF0ZSA8IG9uZVllYXJBZ28pIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgIGBzdGFydF9kYXRlICgke3JlcXVlc3Quc3RhcnRfZGF0ZX0pIGlzIHRvbyBvbGQuIE1heGltdW0gcmFuZ2UgaXMgMSB5ZWFyLmBcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvLyDmnKrmnaXml6Xjg4Hjgqfjg4Pjgq9cclxuICBjb25zdCB0b21vcnJvdyA9IG5ldyBEYXRlKCk7XHJcbiAgdG9tb3Jyb3cuc2V0RGF0ZSh0b21vcnJvdy5nZXREYXRlKCkgKyAxKTtcclxuICBpZiAoZW5kRGF0ZSA+IHRvbW9ycm93KSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgZW5kX2RhdGUgKCR7cmVxdWVzdC5lbmRfZGF0ZX0pIGNhbm5vdCBiZSBpbiB0aGUgZnV0dXJlLmBcclxuICAgICk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogTGFtYmRhIENvbGxlY3RvcuOCkumdnuWQjOacn+OBp+WRvOOBs+WHuuOBl1xyXG4gKlxyXG4gKiBAcGFyYW0gcmVxdWVzdCBDb2xsZWN0UmVxdWVzdFxyXG4gKiBAcGFyYW0gY29udGV4dCBMYW1iZGEgQ29udGV4dFxyXG4gKiBAcmV0dXJucyDlrp/ooYxJRFxyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gaW52b2tlQ29sbGVjdG9yKFxyXG4gIHJlcXVlc3Q6IENvbGxlY3RSZXF1ZXN0LFxyXG4gIGNvbnRleHQ6IENvbnRleHRcclxuKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAvLyBMYW1iZGEgQ29sbGVjdG9y44Gu44Kk44OZ44Oz44OIXHJcbiAgY29uc3QgY29sbGVjdG9yRXZlbnQgPSB7XHJcbiAgICBtb2RlOiAnb24tZGVtYW5kJyxcclxuICAgIHN0YXJ0X2RhdGU6IHJlcXVlc3Quc3RhcnRfZGF0ZSxcclxuICAgIGVuZF9kYXRlOiByZXF1ZXN0LmVuZF9kYXRlLFxyXG4gIH07XHJcblxyXG4gIGxvZ2dlci5pbmZvKCdJbnZva2luZyBMYW1iZGEgQ29sbGVjdG9yJywge1xyXG4gICAgcmVxdWVzdElkOiBjb250ZXh0LnJlcXVlc3RJZCxcclxuICAgIGZ1bmN0aW9uTmFtZTogQ09MTEVDVE9SX0ZVTkNUSU9OX05BTUUsXHJcbiAgICBldmVudDogY29sbGVjdG9yRXZlbnQsXHJcbiAgfSk7XHJcblxyXG4gIHRyeSB7XHJcbiAgICAvLyBMYW1iZGEgQ29sbGVjdG9y44KS6Z2e5ZCM5pyf44Gn5ZG844Gz5Ye644GX77yISW52b2NhdGlvblR5cGU6IEV2ZW5077yJXHJcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEludm9rZUNvbW1hbmQoe1xyXG4gICAgICBGdW5jdGlvbk5hbWU6IENPTExFQ1RPUl9GVU5DVElPTl9OQU1FLFxyXG4gICAgICBJbnZvY2F0aW9uVHlwZTogJ0V2ZW50JywgLy8g6Z2e5ZCM5pyf5ZG844Gz5Ye644GXXHJcbiAgICAgIFBheWxvYWQ6IEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KGNvbGxlY3RvckV2ZW50KSksXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGxhbWJkYUNsaWVudC5zZW5kKGNvbW1hbmQpO1xyXG5cclxuICAgIGxvZ2dlci5pbmZvKCdMYW1iZGEgQ29sbGVjdG9yIGludm9rZWQgc3VjY2Vzc2Z1bGx5Jywge1xyXG4gICAgICByZXF1ZXN0SWQ6IGNvbnRleHQucmVxdWVzdElkLFxyXG4gICAgICBzdGF0dXNDb2RlOiByZXNwb25zZS5TdGF0dXNDb2RlLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g5a6f6KGMSUTjgpLnlJ/miJDvvIhMYW1iZGEgQ29sbGVjdG9y44GM55Sf5oiQ44GZ44KLZXhlY3V0aW9uX2lk44Go44Gv55Ww44Gq44KL77yJXHJcbiAgICAvLyBMYW1iZGEgQ29sbGVjdG9y44Gu44Os44K544Od44Oz44K544Gv6Z2e5ZCM5pyf5ZG844Gz5Ye644GX44Gn44Gv5Y+W5b6X44Gn44GN44Gq44GE44Gf44KB44CBXHJcbiAgICAvLyDjgZPjgZPjgafkuIDmmYLnmoTjgarlrp/ooYxJROOCkueUn+aIkOOBl+OAgeW+jOOBp0xhbWJkYSBDb2xsZWN0b3LjgYznlJ/miJDjgZfjgZ9cclxuICAgIC8vIGV4ZWN1dGlvbl9pZOOBq+e9ruOBjeaPm+OBiOOCi+W/heimgeOBjOOBguOCiuOBvuOBmeOAglxyXG4gICAgLy9cclxuICAgIC8vIOaUueWWhOahiDogTGFtYmRhIENvbGxlY3RvcuOBruWun+ihjElE44KSRHluYW1vRELjgavkv53lrZjjgZfjgIFcclxuICAgIC8vIEdFVCAvY29sbGVjdC97ZXhlY3V0aW9uX2lkfSDjgaflj5blvpfjgafjgY3jgovjgojjgYbjgavjgZnjgovjgIJcclxuICAgIGNvbnN0IGV4ZWN1dGlvbl9pZCA9IGdlbmVyYXRlRXhlY3V0aW9uSWQoY29udGV4dCk7XHJcblxyXG4gICAgcmV0dXJuIGV4ZWN1dGlvbl9pZDtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgbG9nZ2VyLmVycm9yKFxyXG4gICAgICAnRmFpbGVkIHRvIGludm9rZSBMYW1iZGEgQ29sbGVjdG9yJyxcclxuICAgICAgY3JlYXRlRXJyb3JDb250ZXh0KGVycm9yIGFzIEVycm9yLCB7XHJcbiAgICAgICAgcmVxdWVzdElkOiBjb250ZXh0LnJlcXVlc3RJZCxcclxuICAgICAgICBmdW5jdGlvbk5hbWU6IENPTExFQ1RPUl9GVU5DVElPTl9OQU1FLFxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHN0YXJ0IGRhdGEgY29sbGVjdGlvbicpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOWun+ihjElE44KS55Sf5oiQXHJcbiAqXHJcbiAqIEBwYXJhbSBjb250ZXh0IExhbWJkYSBDb250ZXh0XHJcbiAqIEByZXR1cm5zIOWun+ihjElEXHJcbiAqL1xyXG5mdW5jdGlvbiBnZW5lcmF0ZUV4ZWN1dGlvbklkKGNvbnRleHQ6IENvbnRleHQpOiBzdHJpbmcge1xyXG4gIGNvbnN0IHRpbWVzdGFtcCA9IERhdGUubm93KCk7XHJcbiAgY29uc3QgcmFuZG9tID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDIsIDgpO1xyXG4gIHJldHVybiBgZXhlY18ke3RpbWVzdGFtcH1fJHtyYW5kb219XyR7Y29udGV4dC5hd3NSZXF1ZXN0SWQuc3Vic3RyaW5nKDAsIDgpfWA7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgqjjg6njg7zjg6zjgrnjg53jg7PjgrnjgpLnlJ/miJBcclxuICpcclxuICogQHBhcmFtIGVycm9yIEVycm9yXHJcbiAqIEBwYXJhbSByZXF1ZXN0SWQg44Oq44Kv44Ko44K544OISURcclxuICogQHJldHVybnMgQVBJIEdhdGV3YXkgUHJveHkgUmVzdWx0XHJcbiAqL1xyXG5mdW5jdGlvbiB0b0Vycm9yUmVzcG9uc2UoZXJyb3I6IEVycm9yLCByZXF1ZXN0SWQ6IHN0cmluZyk6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCB7XHJcbiAgY29uc3QgZXJyb3JDb2RlTWFwOiBSZWNvcmQ8c3RyaW5nLCB7IHN0YXR1c0NvZGU6IG51bWJlcjsgY29kZTogc3RyaW5nIH0+ID0ge1xyXG4gICAgVmFsaWRhdGlvbkVycm9yOiB7IHN0YXR1c0NvZGU6IDQwMCwgY29kZTogJ1ZBTElEQVRJT05fRVJST1InIH0sXHJcbiAgICBVbmF1dGhvcml6ZWRFcnJvcjogeyBzdGF0dXNDb2RlOiA0MDEsIGNvZGU6ICdVTkFVVEhPUklaRUQnIH0sXHJcbiAgICBGb3JiaWRkZW5FcnJvcjogeyBzdGF0dXNDb2RlOiA0MDMsIGNvZGU6ICdGT1JCSURERU4nIH0sXHJcbiAgICBOb3RGb3VuZEVycm9yOiB7IHN0YXR1c0NvZGU6IDQwNCwgY29kZTogJ05PVF9GT1VORCcgfSxcclxuICAgIENvbmZsaWN0RXJyb3I6IHsgc3RhdHVzQ29kZTogNDA5LCBjb2RlOiAnQ09ORkxJQ1QnIH0sXHJcbiAgICBSYXRlTGltaXRFcnJvcjogeyBzdGF0dXNDb2RlOiA0MjksIGNvZGU6ICdSQVRFX0xJTUlUX0VYQ0VFREVEJyB9LFxyXG4gICAgSW50ZXJuYWxFcnJvcjogeyBzdGF0dXNDb2RlOiA1MDAsIGNvZGU6ICdJTlRFUk5BTF9FUlJPUicgfSxcclxuICAgIFNlcnZpY2VVbmF2YWlsYWJsZUVycm9yOiB7IHN0YXR1c0NvZGU6IDUwMywgY29kZTogJ1NFUlZJQ0VfVU5BVkFJTEFCTEUnIH0sXHJcbiAgICBHYXRld2F5VGltZW91dEVycm9yOiB7IHN0YXR1c0NvZGU6IDUwNCwgY29kZTogJ0dBVEVXQVlfVElNRU9VVCcgfSxcclxuICB9O1xyXG5cclxuICBjb25zdCBtYXBwaW5nID0gZXJyb3JDb2RlTWFwW2Vycm9yLm5hbWVdIHx8IHtcclxuICAgIHN0YXR1c0NvZGU6IDUwMCxcclxuICAgIGNvZGU6ICdJTlRFUk5BTF9FUlJPUicsXHJcbiAgfTtcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIHN0YXR1c0NvZGU6IG1hcHBpbmcuc3RhdHVzQ29kZSxcclxuICAgIGhlYWRlcnM6IHtcclxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgIH0sXHJcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgIHN0YXR1czogJ2Vycm9yJyxcclxuICAgICAgZXJyb3I6IHtcclxuICAgICAgICBjb2RlOiBtYXBwaW5nLmNvZGUsXHJcbiAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcclxuICAgICAgICBkZXRhaWxzOiAoZXJyb3IgYXMgYW55KS5kZXRhaWxzIHx8IHt9LFxyXG4gICAgICB9LFxyXG4gICAgICByZXF1ZXN0X2lkOiByZXF1ZXN0SWQsXHJcbiAgICB9KSxcclxuICB9O1xyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==