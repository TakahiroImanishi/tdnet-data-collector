{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\cdk\\__tests__\\cloudwatch-alarms.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\cdk\\__tests__\\cloudwatch-alarms.test.ts"],"sourcesContent":["import * as cdk from 'aws-cdk-lib';\r\nimport * as lambda from 'aws-cdk-lib/aws-lambda';\r\nimport { Template, Match } from 'aws-cdk-lib/assertions';\r\nimport { CloudWatchAlarms } from '../lib/constructs/cloudwatch-alarms';\r\n\r\ndescribe('CloudWatchAlarms Construct', () => {\r\n  let stack: cdk.Stack;\r\n  let testLambdaFunction: lambda.Function;\r\n\r\n  beforeEach(() => {\r\n    const app = new cdk.App();\r\n    stack = new cdk.Stack(app, 'TestStack');\r\n\r\n    // テスト用のLambda関数を作成\r\n    testLambdaFunction = new lambda.Function(stack, 'TestFunction', {\r\n      runtime: lambda.Runtime.NODEJS_20_X,\r\n      handler: 'index.handler',\r\n      code: lambda.Code.fromInline('exports.handler = async () => ({ statusCode: 200 });'),\r\n      functionName: 'test-function',\r\n    });\r\n  });\r\n\r\n  test('SNS Topicが作成されること', () => {\r\n    // Arrange & Act\r\n    new CloudWatchAlarms(stack, 'TestAlarms', {\r\n      lambdaFunctions: [testLambdaFunction],\r\n      environment: 'test',\r\n    });\r\n\r\n    // Assert\r\n    const template = Template.fromStack(stack);\r\n    template.resourceCountIs('AWS::SNS::Topic', 1);\r\n\r\n    template.hasResourceProperties('AWS::SNS::Topic', {\r\n      DisplayName: 'TDnet Data Collector Alerts (test)',\r\n      TopicName: 'tdnet-alerts-test',\r\n    });\r\n  });\r\n\r\n  test('メール通知が設定されること', () => {\r\n    // Arrange & Act\r\n    new CloudWatchAlarms(stack, 'TestAlarms', {\r\n      lambdaFunctions: [testLambdaFunction],\r\n      environment: 'test',\r\n      alertEmail: 'test@example.com',\r\n    });\r\n\r\n    // Assert\r\n    const template = Template.fromStack(stack);\r\n    template.resourceCountIs('AWS::SNS::Subscription', 1);\r\n\r\n    template.hasResourceProperties('AWS::SNS::Subscription', {\r\n      Protocol: 'email',\r\n      Endpoint: 'test@example.com',\r\n    });\r\n  });\r\n\r\n  test('Lambda Error Rateアラームが作成されること', () => {\r\n    // Arrange & Act\r\n    new CloudWatchAlarms(stack, 'TestAlarms', {\r\n      lambdaFunctions: [testLambdaFunction],\r\n      environment: 'test',\r\n      errorRateThreshold: 10,\r\n    });\r\n\r\n    // Assert\r\n    const template = Template.fromStack(stack);\r\n\r\n    // Error Rateアラームが存在することを確認（AlarmNameとAlarmDescriptionはトークンなのでMatch.anyValue()を使用）\r\n    template.hasResourceProperties('AWS::CloudWatch::Alarm', {\r\n      AlarmName: Match.anyValue(), // トークンを含むため\r\n      AlarmDescription: Match.anyValue(), // トークンを含むため\r\n      ComparisonOperator: 'GreaterThanThreshold',\r\n      Threshold: 10,\r\n      EvaluationPeriods: 1,\r\n      TreatMissingData: 'notBreaching',\r\n    });\r\n  });\r\n\r\n  test('Lambda Durationアラームが作成されること', () => {\r\n    // Arrange & Act\r\n    new CloudWatchAlarms(stack, 'TestAlarms', {\r\n      lambdaFunctions: [testLambdaFunction],\r\n      environment: 'test',\r\n      durationThreshold: 840, // 14分 = 840秒\r\n    });\r\n\r\n    // Assert\r\n    const template = Template.fromStack(stack);\r\n\r\n    // Durationアラームが存在することを確認（AlarmNameとAlarmDescriptionはトークンなのでMatch.anyValue()を使用）\r\n    template.hasResourceProperties('AWS::CloudWatch::Alarm', {\r\n      AlarmName: Match.anyValue(), // トークンを含むため\r\n      AlarmDescription: Match.anyValue(), // トークンを含むため\r\n      ComparisonOperator: 'GreaterThanThreshold',\r\n      Threshold: 840000, // ミリ秒\r\n      EvaluationPeriods: 2,\r\n      TreatMissingData: 'notBreaching',\r\n    });\r\n  });\r\n\r\n  test('Lambda Throttlesアラームが作成されること', () => {\r\n    // Arrange & Act\r\n    new CloudWatchAlarms(stack, 'TestAlarms', {\r\n      lambdaFunctions: [testLambdaFunction],\r\n      environment: 'test',\r\n    });\r\n\r\n    // Assert\r\n    const template = Template.fromStack(stack);\r\n\r\n    // Throttlesアラームが存在することを確認（AlarmNameとAlarmDescriptionはトークンなのでMatch.anyValue()を使用）\r\n    template.hasResourceProperties('AWS::CloudWatch::Alarm', {\r\n      AlarmName: Match.anyValue(), // トークンを含むため\r\n      AlarmDescription: Match.anyValue(), // トークンを含むため\r\n      ComparisonOperator: 'GreaterThanOrEqualToThreshold',\r\n      Threshold: 1,\r\n      EvaluationPeriods: 1,\r\n      TreatMissingData: 'notBreaching',\r\n    });\r\n  });\r\n\r\n  test('CollectionSuccessRateアラームが作成されること', () => {\r\n    // Arrange & Act\r\n    new CloudWatchAlarms(stack, 'TestAlarms', {\r\n      lambdaFunctions: [testLambdaFunction],\r\n      environment: 'test',\r\n      collectionSuccessRateThreshold: 95,\r\n    });\r\n\r\n    // Assert\r\n    const template = Template.fromStack(stack);\r\n\r\n    // CollectionSuccessRateアラームが存在することを確認\r\n    template.hasResourceProperties('AWS::CloudWatch::Alarm', {\r\n      AlarmName: 'tdnet-collection-success-rate-test',\r\n      AlarmDescription: '収集成功率が 95% を下回りました',\r\n      ComparisonOperator: 'LessThanThreshold',\r\n      Threshold: 95,\r\n      EvaluationPeriods: 1,\r\n      TreatMissingData: 'notBreaching',\r\n    });\r\n  });\r\n\r\n  test('NoDataCollectedアラームが作成されること', () => {\r\n    // Arrange & Act\r\n    new CloudWatchAlarms(stack, 'TestAlarms', {\r\n      lambdaFunctions: [testLambdaFunction],\r\n      environment: 'test',\r\n    });\r\n\r\n    // Assert\r\n    const template = Template.fromStack(stack);\r\n\r\n    // NoDataCollectedアラームが存在することを確認\r\n    template.hasResourceProperties('AWS::CloudWatch::Alarm', {\r\n      AlarmName: 'tdnet-no-data-collected-test',\r\n      AlarmDescription: '24時間データ収集がありません',\r\n      ComparisonOperator: 'LessThanThreshold',\r\n      Threshold: 1,\r\n      EvaluationPeriods: 1,\r\n      TreatMissingData: 'breaching',\r\n    });\r\n  });\r\n\r\n  test('CollectionFailureアラームが作成されること', () => {\r\n    // Arrange & Act\r\n    new CloudWatchAlarms(stack, 'TestAlarms', {\r\n      lambdaFunctions: [testLambdaFunction],\r\n      environment: 'test',\r\n    });\r\n\r\n    // Assert\r\n    const template = Template.fromStack(stack);\r\n\r\n    // CollectionFailureアラームが存在することを確認\r\n    template.hasResourceProperties('AWS::CloudWatch::Alarm', {\r\n      AlarmName: 'tdnet-collection-failures-test',\r\n      AlarmDescription: '24時間で10件以上の収集失敗が発生しました',\r\n      ComparisonOperator: 'GreaterThanThreshold',\r\n      Threshold: 10,\r\n      EvaluationPeriods: 1,\r\n      TreatMissingData: 'notBreaching',\r\n    });\r\n  });\r\n\r\n  test('複数のLambda関数に対してアラームが作成されること', () => {\r\n    // Arrange\r\n    const testLambdaFunction2 = new lambda.Function(stack, 'TestFunction2', {\r\n      runtime: lambda.Runtime.NODEJS_20_X,\r\n      handler: 'index.handler',\r\n      code: lambda.Code.fromInline('exports.handler = async () => ({ statusCode: 200 });'),\r\n      functionName: 'test-function-2',\r\n    });\r\n\r\n    // Act\r\n    new CloudWatchAlarms(stack, 'TestAlarms', {\r\n      lambdaFunctions: [testLambdaFunction, testLambdaFunction2],\r\n      environment: 'test',\r\n    });\r\n\r\n    // Assert\r\n    const template = Template.fromStack(stack);\r\n\r\n    // 各Lambda関数に対して3つのアラーム（Error Rate, Duration, Throttles）が作成される\r\n    // + カスタムメトリクスアラーム3つ（CollectionSuccessRate, NoData, CollectionFailure）\r\n    // = 2 * 3 + 3 = 9個のアラーム\r\n    template.resourceCountIs('AWS::CloudWatch::Alarm', 9);\r\n  });\r\n\r\n  test('すべてのアラームにSNSアクションが設定されること', () => {\r\n    // Arrange & Act\r\n    new CloudWatchAlarms(stack, 'TestAlarms', {\r\n      lambdaFunctions: [testLambdaFunction],\r\n      environment: 'test',\r\n    });\r\n\r\n    // Assert\r\n    const template = Template.fromStack(stack);\r\n\r\n    // すべてのアラームにAlarmActionsが設定されていることを確認\r\n    const alarms = template.findResources('AWS::CloudWatch::Alarm');\r\n    const alarmKeys = Object.keys(alarms);\r\n\r\n    expect(alarmKeys.length).toBeGreaterThan(0);\r\n\r\n    alarmKeys.forEach((key) => {\r\n      const alarm = alarms[key];\r\n      expect(alarm.Properties.AlarmActions).toBeDefined();\r\n      expect(alarm.Properties.AlarmActions.length).toBeGreaterThan(0);\r\n    });\r\n  });\r\n\r\n  test('デフォルト閾値が正しく設定されること', () => {\r\n    // Arrange & Act\r\n    new CloudWatchAlarms(stack, 'TestAlarms', {\r\n      lambdaFunctions: [testLambdaFunction],\r\n      environment: 'test',\r\n      // 閾値を指定しない（デフォルト値を使用）\r\n    });\r\n\r\n    // Assert\r\n    const template = Template.fromStack(stack);\r\n\r\n    // Error Rate: 10% (AlarmNameはトークンなのでMatch.anyValue()を使用)\r\n    template.hasResourceProperties('AWS::CloudWatch::Alarm', {\r\n      AlarmName: Match.anyValue(),\r\n      Threshold: 10,\r\n      ComparisonOperator: 'GreaterThanThreshold',\r\n      EvaluationPeriods: 1,\r\n    });\r\n\r\n    // Duration: 840秒 = 840000ミリ秒 (AlarmNameはトークンなのでMatch.anyValue()を使用)\r\n    template.hasResourceProperties('AWS::CloudWatch::Alarm', {\r\n      AlarmName: Match.anyValue(),\r\n      Threshold: 840000,\r\n      ComparisonOperator: 'GreaterThanThreshold',\r\n      EvaluationPeriods: 2,\r\n    });\r\n\r\n    // CollectionSuccessRate: 95%\r\n    template.hasResourceProperties('AWS::CloudWatch::Alarm', {\r\n      AlarmName: 'tdnet-collection-success-rate-test',\r\n      Threshold: 95,\r\n    });\r\n  });\r\n\r\n  test('カスタム閾値が正しく設定されること', () => {\r\n    // Arrange & Act\r\n    new CloudWatchAlarms(stack, 'TestAlarms', {\r\n      lambdaFunctions: [testLambdaFunction],\r\n      environment: 'test',\r\n      errorRateThreshold: 5, // カスタム: 5%\r\n      durationThreshold: 600, // カスタム: 10分 = 600秒\r\n      collectionSuccessRateThreshold: 90, // カスタム: 90%\r\n    });\r\n\r\n    // Assert\r\n    const template = Template.fromStack(stack);\r\n\r\n    // Error Rate: 5% (AlarmNameはトークンなのでMatch.anyValue()を使用)\r\n    template.hasResourceProperties('AWS::CloudWatch::Alarm', {\r\n      AlarmName: Match.anyValue(),\r\n      Threshold: 5,\r\n      ComparisonOperator: 'GreaterThanThreshold',\r\n      EvaluationPeriods: 1,\r\n    });\r\n\r\n    // Duration: 600秒 = 600000ミリ秒 (AlarmNameはトークンなのでMatch.anyValue()を使用)\r\n    template.hasResourceProperties('AWS::CloudWatch::Alarm', {\r\n      AlarmName: Match.anyValue(),\r\n      Threshold: 600000,\r\n      ComparisonOperator: 'GreaterThanThreshold',\r\n      EvaluationPeriods: 2,\r\n    });\r\n\r\n    // CollectionSuccessRate: 90%\r\n    template.hasResourceProperties('AWS::CloudWatch::Alarm', {\r\n      AlarmName: 'tdnet-collection-success-rate-test',\r\n      Threshold: 90,\r\n    });\r\n  });\r\n});\r\n"],"version":3}