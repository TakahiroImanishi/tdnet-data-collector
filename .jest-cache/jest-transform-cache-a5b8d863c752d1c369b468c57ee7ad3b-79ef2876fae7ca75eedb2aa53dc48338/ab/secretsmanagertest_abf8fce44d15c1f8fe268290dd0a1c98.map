{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\cdk\\__tests__\\secrets-manager.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\cdk\\__tests__\\secrets-manager.test.ts"],"sourcesContent":["import * as cdk from 'aws-cdk-lib';\r\nimport { Template, Match } from 'aws-cdk-lib/assertions';\r\nimport * as lambda from 'aws-cdk-lib/aws-lambda';\r\nimport { SecretsManagerConstruct } from '../lib/constructs/secrets-manager';\r\n\r\ndescribe('SecretsManagerConstruct', () => {\r\n  let app: cdk.App;\r\n  let stack: cdk.Stack;\r\n  let template: Template;\r\n\r\n  beforeEach(() => {\r\n    app = new cdk.App();\r\n    stack = new cdk.Stack(app, 'TestStack');\r\n  });\r\n\r\n  describe('シークレット作成', () => {\r\n    it('シークレット名が /tdnet/api-key であること', () => {\r\n      // Arrange & Act\r\n      new SecretsManagerConstruct(stack, 'SecretsManager');\r\n      template = Template.fromStack(stack);\r\n\r\n      // Assert\r\n      template.hasResourceProperties('AWS::SecretsManager::Secret', {\r\n        Name: '/tdnet/api-key',\r\n      });\r\n    });\r\n\r\n    it('シークレットの説明が設定されていること', () => {\r\n      // Arrange & Act\r\n      new SecretsManagerConstruct(stack, 'SecretsManager');\r\n      template = Template.fromStack(stack);\r\n\r\n      // Assert\r\n      template.hasResourceProperties('AWS::SecretsManager::Secret', {\r\n        Description: 'TDnet API Key for authentication',\r\n      });\r\n    });\r\n\r\n    it('シークレットが自動生成設定を持つこと', () => {\r\n      // Arrange & Act\r\n      new SecretsManagerConstruct(stack, 'SecretsManager');\r\n      template = Template.fromStack(stack);\r\n\r\n      // Assert\r\n      template.hasResourceProperties('AWS::SecretsManager::Secret', {\r\n        GenerateSecretString: {\r\n          SecretStringTemplate: '{\"apiKey\":\"\"}',\r\n          GenerateStringKey: 'apiKey',\r\n          ExcludePunctuation: true,\r\n          PasswordLength: 32,\r\n        },\r\n      });\r\n    });\r\n\r\n    it('シークレットが暗号化されていること（デフォルトのAWS管理キー）', () => {\r\n      // Arrange & Act\r\n      new SecretsManagerConstruct(stack, 'SecretsManager');\r\n      template = Template.fromStack(stack);\r\n\r\n      // Assert\r\n      // KmsKeyIdが指定されていない場合、デフォルトのAWS管理キーが使用される\r\n      template.hasResourceProperties('AWS::SecretsManager::Secret', {\r\n        KmsKeyId: Match.absent(),\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('Lambda関数へのアクセス権限', () => {\r\n    it('Lambda関数にシークレット読み取り権限が付与されること', () => {\r\n      // Arrange\r\n      const secretsManager = new SecretsManagerConstruct(stack, 'SecretsManager');\r\n      const testFunction = new lambda.Function(stack, 'TestFunction', {\r\n        runtime: lambda.Runtime.NODEJS_20_X,\r\n        handler: 'index.handler',\r\n        code: lambda.Code.fromInline('exports.handler = async () => {}'),\r\n      });\r\n\r\n      // Act\r\n      secretsManager.grantRead(testFunction);\r\n      template = Template.fromStack(stack);\r\n\r\n      // Assert\r\n      // Lambda関数のロールにシークレット読み取りポリシーが追加されていることを確認\r\n      template.hasResourceProperties('AWS::IAM::Policy', {\r\n        PolicyDocument: {\r\n          Statement: Match.arrayWith([\r\n            Match.objectLike({\r\n              Action: ['secretsmanager:GetSecretValue', 'secretsmanager:DescribeSecret'],\r\n              Effect: 'Allow',\r\n              Resource: {\r\n                Ref: Match.stringLikeRegexp('SecretsManagerApiKeySecret'),\r\n              },\r\n            }),\r\n          ]),\r\n        },\r\n      });\r\n    });\r\n\r\n    it('複数のLambda関数にシークレット読み取り権限が付与されること', () => {\r\n      // Arrange\r\n      const secretsManager = new SecretsManagerConstruct(stack, 'SecretsManager');\r\n      const queryFunction = new lambda.Function(stack, 'QueryFunction', {\r\n        runtime: lambda.Runtime.NODEJS_20_X,\r\n        handler: 'index.handler',\r\n        code: lambda.Code.fromInline('exports.handler = async () => {}'),\r\n      });\r\n      const exportFunction = new lambda.Function(stack, 'ExportFunction', {\r\n        runtime: lambda.Runtime.NODEJS_20_X,\r\n        handler: 'index.handler',\r\n        code: lambda.Code.fromInline('exports.handler = async () => {}'),\r\n      });\r\n\r\n      // Act\r\n      secretsManager.grantRead(queryFunction);\r\n      secretsManager.grantRead(exportFunction);\r\n      template = Template.fromStack(stack);\r\n\r\n      // Assert\r\n      // 2つのIAMポリシーが作成されていることを確認\r\n      const policies = template.findResources('AWS::IAM::Policy', {\r\n        PolicyDocument: {\r\n          Statement: Match.arrayWith([\r\n            Match.objectLike({\r\n              Action: ['secretsmanager:GetSecretValue', 'secretsmanager:DescribeSecret'],\r\n              Effect: 'Allow',\r\n            }),\r\n          ]),\r\n        },\r\n      });\r\n\r\n      // 少なくとも2つのポリシーが存在することを確認\r\n      expect(Object.keys(policies).length).toBeGreaterThanOrEqual(2);\r\n    });\r\n  });\r\n\r\n  describe('ヘルパーメソッド', () => {\r\n    it('getSecretArn() がシークレットARNを返すこと', () => {\r\n      // Arrange\r\n      const secretsManager = new SecretsManagerConstruct(stack, 'SecretsManager');\r\n\r\n      // Act\r\n      const secretArn = secretsManager.getSecretArn();\r\n\r\n      // Assert\r\n      expect(secretArn).toBeDefined();\r\n      expect(typeof secretArn).toBe('string');\r\n    });\r\n\r\n    it('getSecretValue() がSecretValue型を返すこと', () => {\r\n      // Arrange\r\n      const secretsManager = new SecretsManagerConstruct(stack, 'SecretsManager');\r\n\r\n      // Act\r\n      const secretValue = secretsManager.getSecretValue();\r\n\r\n      // Assert\r\n      expect(secretValue).toBeDefined();\r\n      // SecretValue型は unsafeUnwrap() メソッドを持つ\r\n      expect(typeof secretValue.unsafeUnwrap).toBe('function');\r\n    });\r\n  });\r\n\r\n  describe('削除保護', () => {\r\n    it('シークレットが削除保護されていること（RETAIN）', () => {\r\n      // Arrange & Act\r\n      new SecretsManagerConstruct(stack, 'SecretsManager');\r\n      template = Template.fromStack(stack);\r\n\r\n      // Assert\r\n      // DeletionPolicyがRetainであることを確認\r\n      const secrets = template.findResources('AWS::SecretsManager::Secret');\r\n      const secretKeys = Object.keys(secrets);\r\n      expect(secretKeys.length).toBe(1);\r\n\r\n      const secretResource = secrets[secretKeys[0]];\r\n      expect(secretResource.DeletionPolicy).toBe('Retain');\r\n    });\r\n  });\r\n\r\n  describe('統合テスト', () => {\r\n    it('SecretsManagerConstructが正しくスタックに統合されること', () => {\r\n      // Arrange & Act\r\n      const secretsManager = new SecretsManagerConstruct(stack, 'SecretsManager');\r\n      const testFunction = new lambda.Function(stack, 'TestFunction', {\r\n        runtime: lambda.Runtime.NODEJS_20_X,\r\n        handler: 'index.handler',\r\n        code: lambda.Code.fromInline('exports.handler = async () => {}'),\r\n        environment: {\r\n          API_KEY_SECRET_ARN: secretsManager.getSecretArn(),\r\n        },\r\n      });\r\n      secretsManager.grantRead(testFunction);\r\n      template = Template.fromStack(stack);\r\n\r\n      // Assert\r\n      // 1. シークレットが作成されていること\r\n      template.resourceCountIs('AWS::SecretsManager::Secret', 1);\r\n\r\n      // 2. Lambda関数が作成されていること\r\n      template.resourceCountIs('AWS::Lambda::Function', 1);\r\n\r\n      // 3. Lambda関数の環境変数にシークレットARNが設定されていること\r\n      template.hasResourceProperties('AWS::Lambda::Function', {\r\n        Environment: {\r\n          Variables: {\r\n            API_KEY_SECRET_ARN: {\r\n              Ref: Match.stringLikeRegexp('SecretsManagerApiKeySecret'),\r\n            },\r\n          },\r\n        },\r\n      });\r\n\r\n      // 4. IAMポリシーが作成されていること\r\n      template.resourceCountIs('AWS::IAM::Policy', 1);\r\n    });\r\n  });\r\n});\r\n"],"version":3}