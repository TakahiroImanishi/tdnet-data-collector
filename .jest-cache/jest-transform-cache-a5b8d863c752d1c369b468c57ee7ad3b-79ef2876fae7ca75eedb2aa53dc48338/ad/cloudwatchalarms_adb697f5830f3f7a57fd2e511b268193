28731059bcd26dd58690f860c2548704
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.CloudWatchAlarms = void 0;
const cdk = __importStar(require("aws-cdk-lib"));
const cloudwatch = __importStar(require("aws-cdk-lib/aws-cloudwatch"));
const cloudwatch_actions = __importStar(require("aws-cdk-lib/aws-cloudwatch-actions"));
const sns = __importStar(require("aws-cdk-lib/aws-sns"));
const subscriptions = __importStar(require("aws-cdk-lib/aws-sns-subscriptions"));
const constructs_1 = require("constructs");
/**
 * CloudWatch Alarms Construct
 *
 * Lambda関数とシステム全体の監視アラームを設定します。
 *
 * 設定されるアラーム:
 * - Lambda Error Rate > 10% → Critical
 * - Lambda Duration > 14分 → Warning
 * - CollectionSuccessRate < 95% → Warning
 * - SNS Topicへの通知設定
 */
class CloudWatchAlarms extends constructs_1.Construct {
    /**
     * SNS Topic（アラート通知用）
     */
    alertTopic;
    /**
     * 作成されたアラームのリスト
     */
    alarms = [];
    constructor(scope, id, props) {
        super(scope, id);
        // デフォルト値の設定
        const errorRateThreshold = props.errorRateThreshold ?? 10; // 10%
        const durationThreshold = props.durationThreshold ?? 840; // 14分 = 840秒
        const collectionSuccessRateThreshold = props.collectionSuccessRateThreshold ?? 95; // 95%
        // ========================================
        // SNS Topic作成（アラート通知用）
        // ========================================
        this.alertTopic = new sns.Topic(this, 'AlertTopic', {
            topicName: `tdnet-alerts-${props.environment}`,
            displayName: `TDnet Data Collector Alerts (${props.environment})`,
        });
        // メール通知の追加（オプション）
        if (props.alertEmail) {
            this.alertTopic.addSubscription(new subscriptions.EmailSubscription(props.alertEmail));
        }
        // ========================================
        // Lambda関数ごとのアラーム設定
        // ========================================
        props.lambdaFunctions.forEach((lambdaFunction, index) => {
            const functionName = lambdaFunction.functionName;
            // CDK IDには静的な値を使用（トークンを含めない）
            const alarmIdPrefix = `LambdaFunction${index}`;
            // 1. Lambda Error Rate アラーム（Critical）
            const errorRateAlarm = new cloudwatch.Alarm(this, `${alarmIdPrefix}ErrorRateAlarm`, {
                alarmName: `${functionName}-error-rate-${props.environment}`,
                alarmDescription: `Lambda関数 ${functionName} のエラー率が ${errorRateThreshold}% を超えました`,
                metric: this.createErrorRateMetric(lambdaFunction),
                threshold: errorRateThreshold,
                evaluationPeriods: 1,
                comparisonOperator: cloudwatch.ComparisonOperator.GREATER_THAN_THRESHOLD,
                treatMissingData: cloudwatch.TreatMissingData.NOT_BREACHING,
            });
            errorRateAlarm.addAlarmAction(new cloudwatch_actions.SnsAction(this.alertTopic));
            this.alarms.push(errorRateAlarm);
            // 2. Lambda Duration アラーム（Warning）
            const durationAlarm = new cloudwatch.Alarm(this, `${alarmIdPrefix}DurationAlarm`, {
                alarmName: `${functionName}-duration-${props.environment}`,
                alarmDescription: `Lambda関数 ${functionName} の実行時間が ${durationThreshold} 秒を超えました`,
                metric: lambdaFunction.metricDuration({
                    statistic: 'Average',
                    period: cdk.Duration.minutes(5),
                }),
                threshold: durationThreshold * 1000, // ミリ秒に変換
                evaluationPeriods: 2,
                comparisonOperator: cloudwatch.ComparisonOperator.GREATER_THAN_THRESHOLD,
                treatMissingData: cloudwatch.TreatMissingData.NOT_BREACHING,
            });
            durationAlarm.addAlarmAction(new cloudwatch_actions.SnsAction(this.alertTopic));
            this.alarms.push(durationAlarm);
            // 3. Lambda Throttles アラーム（Critical）
            const throttleAlarm = new cloudwatch.Alarm(this, `${alarmIdPrefix}ThrottleAlarm`, {
                alarmName: `${functionName}-throttles-${props.environment}`,
                alarmDescription: `Lambda関数 ${functionName} でスロットリングが発生しました`,
                metric: lambdaFunction.metricThrottles({
                    statistic: 'Sum',
                    period: cdk.Duration.minutes(5),
                }),
                threshold: 1,
                evaluationPeriods: 1,
                comparisonOperator: cloudwatch.ComparisonOperator.GREATER_THAN_OR_EQUAL_TO_THRESHOLD,
                treatMissingData: cloudwatch.TreatMissingData.NOT_BREACHING,
            });
            throttleAlarm.addAlarmAction(new cloudwatch_actions.SnsAction(this.alertTopic));
            this.alarms.push(throttleAlarm);
        });
        // ========================================
        // カスタムメトリクスのアラーム
        // ========================================
        // 4. CollectionSuccessRate アラーム（Warning）
        const collectionSuccessRateAlarm = new cloudwatch.Alarm(this, 'CollectionSuccessRateAlarm', {
            alarmName: `tdnet-collection-success-rate-${props.environment}`,
            alarmDescription: `収集成功率が ${collectionSuccessRateThreshold}% を下回りました`,
            metric: this.createCollectionSuccessRateMetric(props.environment),
            threshold: collectionSuccessRateThreshold,
            evaluationPeriods: 1,
            comparisonOperator: cloudwatch.ComparisonOperator.LESS_THAN_THRESHOLD,
            treatMissingData: cloudwatch.TreatMissingData.NOT_BREACHING,
        });
        collectionSuccessRateAlarm.addAlarmAction(new cloudwatch_actions.SnsAction(this.alertTopic));
        this.alarms.push(collectionSuccessRateAlarm);
        // 5. データ収集停止アラーム（Critical）
        const noDataAlarm = new cloudwatch.Alarm(this, 'NoDataCollectedAlarm', {
            alarmName: `tdnet-no-data-collected-${props.environment}`,
            alarmDescription: '24時間データ収集がありません',
            metric: new cloudwatch.Metric({
                namespace: 'TDnet/Collector',
                metricName: 'DisclosuresCollected',
                statistic: 'Sum',
                period: cdk.Duration.hours(24),
                dimensionsMap: {
                    Environment: props.environment,
                },
            }),
            threshold: 1,
            evaluationPeriods: 1,
            comparisonOperator: cloudwatch.ComparisonOperator.LESS_THAN_THRESHOLD,
            treatMissingData: cloudwatch.TreatMissingData.BREACHING,
        });
        noDataAlarm.addAlarmAction(new cloudwatch_actions.SnsAction(this.alertTopic));
        this.alarms.push(noDataAlarm);
        // 6. 収集失敗アラーム（Warning）
        const collectionFailureAlarm = new cloudwatch.Alarm(this, 'CollectionFailureAlarm', {
            alarmName: `tdnet-collection-failures-${props.environment}`,
            alarmDescription: '24時間で10件以上の収集失敗が発生しました',
            metric: new cloudwatch.Metric({
                namespace: 'TDnet/Collector',
                metricName: 'DisclosuresFailed',
                statistic: 'Sum',
                period: cdk.Duration.hours(24),
                dimensionsMap: {
                    Environment: props.environment,
                },
            }),
            threshold: 10,
            evaluationPeriods: 1,
            comparisonOperator: cloudwatch.ComparisonOperator.GREATER_THAN_THRESHOLD,
            treatMissingData: cloudwatch.TreatMissingData.NOT_BREACHING,
        });
        collectionFailureAlarm.addAlarmAction(new cloudwatch_actions.SnsAction(this.alertTopic));
        this.alarms.push(collectionFailureAlarm);
        // ========================================
        // CloudFormation Outputs
        // ========================================
        new cdk.CfnOutput(this, 'AlertTopicArn', {
            value: this.alertTopic.topicArn,
            description: 'SNS Topic ARN for alerts',
            exportName: `TdnetAlertTopicArn-${props.environment}`,
        });
        new cdk.CfnOutput(this, 'AlarmCount', {
            value: this.alarms.length.toString(),
            description: 'Number of CloudWatch Alarms created',
        });
    }
    /**
     * Lambda Error Rateメトリクスを作成
     *
     * Error Rate = (Errors / Invocations) * 100
     */
    createErrorRateMetric(lambdaFunction) {
        const errors = lambdaFunction.metricErrors({
            statistic: 'Sum',
            period: cdk.Duration.minutes(5),
        });
        const invocations = lambdaFunction.metricInvocations({
            statistic: 'Sum',
            period: cdk.Duration.minutes(5),
        });
        // Error Rate = (Errors / Invocations) * 100
        return new cloudwatch.MathExpression({
            expression: '(errors / invocations) * 100',
            usingMetrics: {
                errors,
                invocations,
            },
            label: 'Error Rate (%)',
            period: cdk.Duration.minutes(5),
        });
    }
    /**
     * CollectionSuccessRateメトリクスを作成
     *
     * Success Rate = (DisclosuresCollected / (DisclosuresCollected + DisclosuresFailed)) * 100
     */
    createCollectionSuccessRateMetric(environment) {
        const collected = new cloudwatch.Metric({
            namespace: 'TDnet/Collector',
            metricName: 'DisclosuresCollected',
            statistic: 'Sum',
            period: cdk.Duration.hours(1),
            dimensionsMap: {
                Environment: environment,
            },
        });
        const failed = new cloudwatch.Metric({
            namespace: 'TDnet/Collector',
            metricName: 'DisclosuresFailed',
            statistic: 'Sum',
            period: cdk.Duration.hours(1),
            dimensionsMap: {
                Environment: environment,
            },
        });
        // Success Rate = (Collected / (Collected + Failed)) * 100
        return new cloudwatch.MathExpression({
            expression: '(collected / (collected + failed)) * 100',
            usingMetrics: {
                collected,
                failed,
            },
            label: 'Collection Success Rate (%)',
            period: cdk.Duration.hours(1),
        });
    }
}
exports.CloudWatchAlarms = CloudWatchAlarms;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcY2RrXFxsaWJcXGNvbnN0cnVjdHNcXGNsb3Vkd2F0Y2gtYWxhcm1zLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGlEQUFtQztBQUNuQyx1RUFBeUQ7QUFDekQsdUZBQXlFO0FBQ3pFLHlEQUEyQztBQUMzQyxpRkFBbUU7QUFFbkUsMkNBQXVDO0FBcUN2Qzs7Ozs7Ozs7OztHQVVHO0FBQ0gsTUFBYSxnQkFBaUIsU0FBUSxzQkFBUztJQUM3Qzs7T0FFRztJQUNhLFVBQVUsQ0FBWTtJQUV0Qzs7T0FFRztJQUNhLE1BQU0sR0FBdUIsRUFBRSxDQUFDO0lBRWhELFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBNEI7UUFDcEUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixZQUFZO1FBQ1osTUFBTSxrQkFBa0IsR0FBRyxLQUFLLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTTtRQUNqRSxNQUFNLGlCQUFpQixHQUFHLEtBQUssQ0FBQyxpQkFBaUIsSUFBSSxHQUFHLENBQUMsQ0FBQyxhQUFhO1FBQ3ZFLE1BQU0sOEJBQThCLEdBQUcsS0FBSyxDQUFDLDhCQUE4QixJQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU07UUFFekYsMkNBQTJDO1FBQzNDLHVCQUF1QjtRQUN2QiwyQ0FBMkM7UUFDM0MsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFlBQVksRUFBRTtZQUNsRCxTQUFTLEVBQUUsZ0JBQWdCLEtBQUssQ0FBQyxXQUFXLEVBQUU7WUFDOUMsV0FBVyxFQUFFLGdDQUFnQyxLQUFLLENBQUMsV0FBVyxHQUFHO1NBQ2xFLENBQUMsQ0FBQztRQUVILGtCQUFrQjtRQUNsQixJQUFJLEtBQUssQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNyQixJQUFJLENBQUMsVUFB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WSxFQUFFO2dCQUNaLFNBQVM7Z0JBQ1QsTUFBTTthQUNQO1lBQ0QsS0FBSyxFQUFFLDZCQUE2QjtZQUNwQyxNQUFNLEVBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1NBQzlCLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQS9PRCw0Q0ErT0MiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcY2RrXFxsaWJcXGNvbnN0cnVjdHNcXGNsb3Vkd2F0Y2gtYWxhcm1zLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNkayBmcm9tICdhd3MtY2RrLWxpYic7XHJcbmltcG9ydCAqIGFzIGNsb3Vkd2F0Y2ggZnJvbSAnYXdzLWNkay1saWIvYXdzLWNsb3Vkd2F0Y2gnO1xyXG5pbXBvcnQgKiBhcyBjbG91ZHdhdGNoX2FjdGlvbnMgZnJvbSAnYXdzLWNkay1saWIvYXdzLWNsb3Vkd2F0Y2gtYWN0aW9ucyc7XHJcbmltcG9ydCAqIGFzIHNucyBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtc25zJztcclxuaW1wb3J0ICogYXMgc3Vic2NyaXB0aW9ucyBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtc25zLXN1YnNjcmlwdGlvbnMnO1xyXG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XHJcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xyXG5cclxuLyoqXHJcbiAqIENsb3VkV2F0Y2ggQWxhcm1zIENvbnN0cnVjdCBQcm9wZXJ0aWVzXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIENsb3VkV2F0Y2hBbGFybXNQcm9wcyB7XHJcbiAgLyoqXHJcbiAgICogTGFtYmRh6Zai5pWw44Gu44Oq44K544OI77yI55uj6KaW5a++6LGh77yJXHJcbiAgICovXHJcbiAgbGFtYmRhRnVuY3Rpb25zOiBsYW1iZGEuSUZ1bmN0aW9uW107XHJcblxyXG4gIC8qKlxyXG4gICAqIOeSsOWig+WQje+8iGRldiwgc3RhZ2luZywgcHJvZO+8iVxyXG4gICAqL1xyXG4gIGVudmlyb25tZW50OiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIOOCouODqeODvOODiOmAmuefpeWFiOODoeODvOODq+OCouODieODrOOCue+8iOOCquODl+OCt+ODp+ODs++8iVxyXG4gICAqL1xyXG4gIGFsZXJ0RW1haWw/OiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIExhbWJkYSBFcnJvciBSYXRl6Za+5YCk77yI44OH44OV44Kp44Or44OIOiAxMCXvvIlcclxuICAgKi9cclxuICBlcnJvclJhdGVUaHJlc2hvbGQ/OiBudW1iZXI7XHJcblxyXG4gIC8qKlxyXG4gICAqIExhbWJkYSBEdXJhdGlvbumWvuWApO+8iOenkuOAgeODh+ODleOCqeODq+ODiDogODQw56eSID0gMTTliIbvvIlcclxuICAgKi9cclxuICBkdXJhdGlvblRocmVzaG9sZD86IG51bWJlcjtcclxuXHJcbiAgLyoqXHJcbiAgICogQ29sbGVjdGlvblN1Y2Nlc3NSYXRl6Za+5YCk77yI44OH44OV44Kp44Or44OIOiA5NSXvvIlcclxuICAgKi9cclxuICBjb2xsZWN0aW9uU3VjY2Vzc1JhdGVUaHJlc2hvbGQ/OiBudW1iZXI7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDbG91ZFdhdGNoIEFsYXJtcyBDb25zdHJ1Y3RcclxuICogXHJcbiAqIExhbWJkYemWouaVsOOBqOOCt+OCueODhuODoOWFqOS9k+OBruebo+imluOCouODqeODvOODoOOCkuioreWumuOBl+OBvuOBmeOAglxyXG4gKiBcclxuICog6Kit5a6a44GV44KM44KL44Ki44Op44O844OgOlxyXG4gKiAtIExhbWJkYSBFcnJvciBSYXRlID4gMTAlIOKGkiBDcml0aWNhbFxyXG4gKiAtIExhbWJkYSBEdXJhdGlvbiA+IDE05YiGIOKGkiBXYXJuaW5nXHJcbiAqIC0gQ29sbGVjdGlvblN1Y2Nlc3NSYXRlIDwgOTUlIOKGkiBXYXJuaW5nXHJcbiAqIC0gU05TIFRvcGlj44G444Gu6YCa55+l6Kit5a6aXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgQ2xvdWRXYXRjaEFsYXJtcyBleHRlbmRzIENvbnN0cnVjdCB7XHJcbiAgLyoqXHJcbiAgICogU05TIFRvcGlj77yI44Ki44Op44O844OI6YCa55+l55So77yJXHJcbiAgICovXHJcbiAgcHVibGljIHJlYWRvbmx5IGFsZXJ0VG9waWM6IHNucy5Ub3BpYztcclxuXHJcbiAgLyoqXHJcbiAgICog5L2c5oiQ44GV44KM44Gf44Ki44Op44O844Og44Gu44Oq44K544OIXHJcbiAgICovXHJcbiAgcHVibGljIHJlYWRvbmx5IGFsYXJtczogY2xvdWR3YXRjaC5BbGFybVtdID0gW107XHJcblxyXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBDbG91ZFdhdGNoQWxhcm1zUHJvcHMpIHtcclxuICAgIHN1cGVyKHNjb3BlLCBpZCk7XHJcblxyXG4gICAgLy8g44OH44OV44Kp44Or44OI5YCk44Gu6Kit5a6aXHJcbiAgICBjb25zdCBlcnJvclJhdGVUaHJlc2hvbGQgPSBwcm9wcy5lcnJvclJhdGVUaHJlc2hvbGQgPz8gMTA7IC8vIDEwJVxyXG4gICAgY29uc3QgZHVyYXRpb25UaHJlc2hvbGQgPSBwcm9wcy5kdXJhdGlvblRocmVzaG9sZCA/PyA4NDA7IC8vIDE05YiGID0gODQw56eSXHJcbiAgICBjb25zdCBjb2xsZWN0aW9uU3VjY2Vzc1JhdGVUaHJlc2hvbGQgPSBwcm9wcy5jb2xsZWN0aW9uU3VjY2Vzc1JhdGVUaHJlc2hvbGQgPz8gOTU7IC8vIDk1JVxyXG5cclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIC8vIFNOUyBUb3BpY+S9nOaIkO+8iOOCouODqeODvOODiOmAmuefpeeUqO+8iVxyXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gICAgdGhpcy5hbGVydFRvcGljID0gbmV3IHNucy5Ub3BpYyh0aGlzLCAnQWxlcnRUb3BpYycsIHtcclxuICAgICAgdG9waWNOYW1lOiBgdGRuZXQtYWxlcnRzLSR7cHJvcHMuZW52aXJvbm1lbnR9YCxcclxuICAgICAgZGlzcGxheU5hbWU6IGBURG5ldCBEYXRhIENvbGxlY3RvciBBbGVydHMgKCR7cHJvcHMuZW52aXJvbm1lbnR9KWAsXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyDjg6Hjg7zjg6vpgJrnn6Xjga7ov73liqDvvIjjgqrjg5fjgrfjg6fjg7PvvIlcclxuICAgIGlmIChwcm9wcy5hbGVydEVtYWlsKSB7XHJcbiAgICAgIHRoaXMuYWxlcnRUb3BpYy5hZGRTdWJzY3JpcHRpb24oXHJcbiAgICAgICAgbmV3IHN1YnNjcmlwdGlvbnMuRW1haWxTdWJzY3JpcHRpb24ocHJvcHMuYWxlcnRFbWFpbClcclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XHJcbiAgICAvLyBMYW1iZGHplqLmlbDjgZTjgajjga7jgqLjg6njg7zjg6DoqK3lrppcclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIHByb3BzLmxhbWJkYUZ1bmN0aW9ucy5mb3JFYWNoKChsYW1iZGFGdW5jdGlvbiwgaW5kZXgpID0+IHtcclxuICAgICAgY29uc3QgZnVuY3Rpb25OYW1lID0gbGFtYmRhRnVuY3Rpb24uZnVuY3Rpb25OYW1lO1xyXG4gICAgICAvLyBDREsgSUTjgavjga/pnZnnmoTjgarlgKTjgpLkvb/nlKjvvIjjg4jjg7zjgq/jg7PjgpLlkKvjgoHjgarjgYTvvIlcclxuICAgICAgY29uc3QgYWxhcm1JZFByZWZpeCA9IGBMYW1iZGFGdW5jdGlvbiR7aW5kZXh9YDtcclxuXHJcbiAgICAgIC8vIDEuIExhbWJkYSBFcnJvciBSYXRlIOOCouODqeODvOODoO+8iENyaXRpY2Fs77yJXHJcbiAgICAgIGNvbnN0IGVycm9yUmF0ZUFsYXJtID0gbmV3IGNsb3Vkd2F0Y2guQWxhcm0odGhpcywgYCR7YWxhcm1JZFByZWZpeH1FcnJvclJhdGVBbGFybWAsIHtcclxuICAgICAgICBhbGFybU5hbWU6IGAke2Z1bmN0aW9uTmFtZX0tZXJyb3ItcmF0ZS0ke3Byb3BzLmVudmlyb25tZW50fWAsXHJcbiAgICAgICAgYWxhcm1EZXNjcmlwdGlvbjogYExhbWJkYemWouaVsCAke2Z1bmN0aW9uTmFtZX0g44Gu44Ko44Op44O8546H44GMICR7ZXJyb3JSYXRlVGhyZXNob2xkfSUg44KS6LaF44GI44G+44GX44GfYCxcclxuICAgICAgICBtZXRyaWM6IHRoaXMuY3JlYXRlRXJyb3JSYXRlTWV0cmljKGxhbWJkYUZ1bmN0aW9uKSxcclxuICAgICAgICB0aHJlc2hvbGQ6IGVycm9yUmF0ZVRocmVzaG9sZCxcclxuICAgICAgICBldmFsdWF0aW9uUGVyaW9kczogMSxcclxuICAgICAgICBjb21wYXJpc29uT3BlcmF0b3I6IGNsb3Vkd2F0Y2guQ29tcGFyaXNvbk9wZXJhdG9yLkdSRUFURVJfVEhBTl9USFJFU0hPTEQsXHJcbiAgICAgICAgdHJlYXRNaXNzaW5nRGF0YTogY2xvdWR3YXRjaC5UcmVhdE1pc3NpbmdEYXRhLk5PVF9CUkVBQ0hJTkcsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgZXJyb3JSYXRlQWxhcm0uYWRkQWxhcm1BY3Rpb24obmV3IGNsb3Vkd2F0Y2hfYWN0aW9ucy5TbnNBY3Rpb24odGhpcy5hbGVydFRvcGljKSk7XHJcbiAgICAgIHRoaXMuYWxhcm1zLnB1c2goZXJyb3JSYXRlQWxhcm0pO1xyXG5cclxuICAgICAgLy8gMi4gTGFtYmRhIER1cmF0aW9uIOOCouODqeODvOODoO+8iFdhcm5pbmfvvIlcclxuICAgICAgY29uc3QgZHVyYXRpb25BbGFybSA9IG5ldyBjbG91ZHdhdGNoLkFsYXJtKHRoaXMsIGAke2FsYXJtSWRQcmVmaXh9RHVyYXRpb25BbGFybWAsIHtcclxuICAgICAgICBhbGFybU5hbWU6IGAke2Z1bmN0aW9uTmFtZX0tZHVyYXRpb24tJHtwcm9wcy5lbnZpcm9ubWVudH1gLFxyXG4gICAgICAgIGFsYXJtRGVzY3JpcHRpb246IGBMYW1iZGHplqLmlbAgJHtmdW5jdGlvbk5hbWV9IOOBruWun+ihjOaZgumWk+OBjCAke2R1cmF0aW9uVGhyZXNob2xkfSDnp5LjgpLotoXjgYjjgb7jgZfjgZ9gLFxyXG4gICAgICAgIG1ldHJpYzogbGFtYmRhRnVuY3Rpb24ubWV0cmljRHVyYXRpb24oe1xyXG4gICAgICAgICAgc3RhdGlzdGljOiAnQXZlcmFnZScsXHJcbiAgICAgICAgICBwZXJpb2Q6IGNkay5EdXJhdGlvbi5taW51dGVzKDUpLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIHRocmVzaG9sZDogZHVyYXRpb25UaHJlc2hvbGQgKiAxMDAwLCAvLyDjg5/jg6rnp5LjgavlpInmj5tcclxuICAgICAgICBldmFsdWF0aW9uUGVyaW9kczogMixcclxuICAgICAgICBjb21wYXJpc29uT3BlcmF0b3I6IGNsb3Vkd2F0Y2guQ29tcGFyaXNvbk9wZXJhdG9yLkdSRUFURVJfVEhBTl9USFJFU0hPTEQsXHJcbiAgICAgICAgdHJlYXRNaXNzaW5nRGF0YTogY2xvdWR3YXRjaC5UcmVhdE1pc3NpbmdEYXRhLk5PVF9CUkVBQ0hJTkcsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgZHVyYXRpb25BbGFybS5hZGRBbGFybUFjdGlvbihuZXcgY2xvdWR3YXRjaF9hY3Rpb25zLlNuc0FjdGlvbih0aGlzLmFsZXJ0VG9waWMpKTtcclxuICAgICAgdGhpcy5hbGFybXMucHVzaChkdXJhdGlvbkFsYXJtKTtcclxuXHJcbiAgICAgIC8vIDMuIExhbWJkYSBUaHJvdHRsZXMg44Ki44Op44O844Og77yIQ3JpdGljYWzvvIlcclxuICAgICAgY29uc3QgdGhyb3R0bGVBbGFybSA9IG5ldyBjbG91ZHdhdGNoLkFsYXJtKHRoaXMsIGAke2FsYXJtSWRQcmVmaXh9VGhyb3R0bGVBbGFybWAsIHtcclxuICAgICAgICBhbGFybU5hbWU6IGAke2Z1bmN0aW9uTmFtZX0tdGhyb3R0bGVzLSR7cHJvcHMuZW52aXJvbm1lbnR9YCxcclxuICAgICAgICBhbGFybURlc2NyaXB0aW9uOiBgTGFtYmRh6Zai5pWwICR7ZnVuY3Rpb25OYW1lfSDjgafjgrnjg63jg4Pjg4jjg6rjg7PjgrDjgYznmbrnlJ/jgZfjgb7jgZfjgZ9gLFxyXG4gICAgICAgIG1ldHJpYzogbGFtYmRhRnVuY3Rpb24ubWV0cmljVGhyb3R0bGVzKHtcclxuICAgICAgICAgIHN0YXRpc3RpYzogJ1N1bScsXHJcbiAgICAgICAgICBwZXJpb2Q6IGNkay5EdXJhdGlvbi5taW51dGVzKDUpLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIHRocmVzaG9sZDogMSxcclxuICAgICAgICBldmFsdWF0aW9uUGVyaW9kczogMSxcclxuICAgICAgICBjb21wYXJpc29uT3BlcmF0b3I6IGNsb3Vkd2F0Y2guQ29tcGFyaXNvbk9wZXJhdG9yLkdSRUFURVJfVEhBTl9PUl9FUVVBTF9UT19USFJFU0hPTEQsXHJcbiAgICAgICAgdHJlYXRNaXNzaW5nRGF0YTogY2xvdWR3YXRjaC5UcmVhdE1pc3NpbmdEYXRhLk5PVF9CUkVBQ0hJTkcsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgdGhyb3R0bGVBbGFybS5hZGRBbGFybUFjdGlvbihuZXcgY2xvdWR3YXRjaF9hY3Rpb25zLlNuc0FjdGlvbih0aGlzLmFsZXJ0VG9waWMpKTtcclxuICAgICAgdGhpcy5hbGFybXMucHVzaCh0aHJvdHRsZUFsYXJtKTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIC8vIOOCq+OCueOCv+ODoOODoeODiOODquOCr+OCueOBruOCouODqeODvOODoFxyXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG5cclxuICAgIC8vIDQuIENvbGxlY3Rpb25TdWNjZXNzUmF0ZSDjgqLjg6njg7zjg6DvvIhXYXJuaW5n77yJXHJcbiAgICBjb25zdCBjb2xsZWN0aW9uU3VjY2Vzc1JhdGVBbGFybSA9IG5ldyBjbG91ZHdhdGNoLkFsYXJtKFxyXG4gICAgICB0aGlzLFxyXG4gICAgICAnQ29sbGVjdGlvblN1Y2Nlc3NSYXRlQWxhcm0nLFxyXG4gICAgICB7XHJcbiAgICAgICAgYWxhcm1OYW1lOiBgdGRuZXQtY29sbGVjdGlvbi1zdWNjZXNzLXJhdGUtJHtwcm9wcy5lbnZpcm9ubWVudH1gLFxyXG4gICAgICAgIGFsYXJtRGVzY3JpcHRpb246IGDlj47pm4bmiJDlip/njofjgYwgJHtjb2xsZWN0aW9uU3VjY2Vzc1JhdGVUaHJlc2hvbGR9JSDjgpLkuIvlm57jgorjgb7jgZfjgZ9gLFxyXG4gICAgICAgIG1ldHJpYzogdGhpcy5jcmVhdGVDb2xsZWN0aW9uU3VjY2Vzc1JhdGVNZXRyaWMocHJvcHMuZW52aXJvbm1lbnQpLFxyXG4gICAgICAgIHRocmVzaG9sZDogY29sbGVjdGlvblN1Y2Nlc3NSYXRlVGhyZXNob2xkLFxyXG4gICAgICAgIGV2YWx1YXRpb25QZXJpb2RzOiAxLFxyXG4gICAgICAgIGNvbXBhcmlzb25PcGVyYXRvcjogY2xvdWR3YXRjaC5Db21wYXJpc29uT3BlcmF0b3IuTEVTU19USEFOX1RIUkVTSE9MRCxcclxuICAgICAgICB0cmVhdE1pc3NpbmdEYXRhOiBjbG91ZHdhdGNoLlRyZWF0TWlzc2luZ0RhdGEuTk9UX0JSRUFDSElORyxcclxuICAgICAgfVxyXG4gICAgKTtcclxuXHJcbiAgICBjb2xsZWN0aW9uU3VjY2Vzc1JhdGVBbGFybS5hZGRBbGFybUFjdGlvbihcclxuICAgICAgbmV3IGNsb3Vkd2F0Y2hfYWN0aW9ucy5TbnNBY3Rpb24odGhpcy5hbGVydFRvcGljKVxyXG4gICAgKTtcclxuICAgIHRoaXMuYWxhcm1zLnB1c2goY29sbGVjdGlvblN1Y2Nlc3NSYXRlQWxhcm0pO1xyXG5cclxuICAgIC8vIDUuIOODh+ODvOOCv+WPjumbhuWBnOatouOCouODqeODvOODoO+8iENyaXRpY2Fs77yJXHJcbiAgICBjb25zdCBub0RhdGFBbGFybSA9IG5ldyBjbG91ZHdhdGNoLkFsYXJtKHRoaXMsICdOb0RhdGFDb2xsZWN0ZWRBbGFybScsIHtcclxuICAgICAgYWxhcm1OYW1lOiBgdGRuZXQtbm8tZGF0YS1jb2xsZWN0ZWQtJHtwcm9wcy5lbnZpcm9ubWVudH1gLFxyXG4gICAgICBhbGFybURlc2NyaXB0aW9uOiAnMjTmmYLplpPjg4fjg7zjgr/lj47pm4bjgYzjgYLjgorjgb7jgZvjgpMnLFxyXG4gICAgICBtZXRyaWM6IG5ldyBjbG91ZHdhdGNoLk1ldHJpYyh7XHJcbiAgICAgICAgbmFtZXNwYWNlOiAnVERuZXQvQ29sbGVjdG9yJyxcclxuICAgICAgICBtZXRyaWNOYW1lOiAnRGlzY2xvc3VyZXNDb2xsZWN0ZWQnLFxyXG4gICAgICAgIHN0YXRpc3RpYzogJ1N1bScsXHJcbiAgICAgICAgcGVyaW9kOiBjZGsuRHVyYXRpb24uaG91cnMoMjQpLFxyXG4gICAgICAgIGRpbWVuc2lvbnNNYXA6IHtcclxuICAgICAgICAgIEVudmlyb25tZW50OiBwcm9wcy5lbnZpcm9ubWVudCxcclxuICAgICAgICB9LFxyXG4gICAgICB9KSxcclxuICAgICAgdGhyZXNob2xkOiAxLFxyXG4gICAgICBldmFsdWF0aW9uUGVyaW9kczogMSxcclxuICAgICAgY29tcGFyaXNvbk9wZXJhdG9yOiBjbG91ZHdhdGNoLkNvbXBhcmlzb25PcGVyYXRvci5MRVNTX1RIQU5fVEhSRVNIT0xELFxyXG4gICAgICB0cmVhdE1pc3NpbmdEYXRhOiBjbG91ZHdhdGNoLlRyZWF0TWlzc2luZ0RhdGEuQlJFQUNISU5HLFxyXG4gICAgfSk7XHJcblxyXG4gICAgbm9EYXRhQWxhcm0uYWRkQWxhcm1BY3Rpb24obmV3IGNsb3Vkd2F0Y2hfYWN0aW9ucy5TbnNBY3Rpb24odGhpcy5hbGVydFRvcGljKSk7XHJcbiAgICB0aGlzLmFsYXJtcy5wdXNoKG5vRGF0YUFsYXJtKTtcclxuXHJcbiAgICAvLyA2LiDlj47pm4blpLHmlZfjgqLjg6njg7zjg6DvvIhXYXJuaW5n77yJXHJcbiAgICBjb25zdCBjb2xsZWN0aW9uRmFpbHVyZUFsYXJtID0gbmV3IGNsb3Vkd2F0Y2guQWxhcm0odGhpcywgJ0NvbGxlY3Rpb25GYWlsdXJlQWxhcm0nLCB7XHJcbiAgICAgIGFsYXJtTmFtZTogYHRkbmV0LWNvbGxlY3Rpb24tZmFpbHVyZXMtJHtwcm9wcy5lbnZpcm9ubWVudH1gLFxyXG4gICAgICBhbGFybURlc2NyaXB0aW9uOiAnMjTmmYLplpPjgacxMOS7tuS7peS4iuOBruWPjumbhuWkseaVl+OBjOeZuueUn+OBl+OBvuOBl+OBnycsXHJcbiAgICAgIG1ldHJpYzogbmV3IGNsb3Vkd2F0Y2guTWV0cmljKHtcclxuICAgICAgICBuYW1lc3BhY2U6ICdURG5ldC9Db2xsZWN0b3InLFxyXG4gICAgICAgIG1ldHJpY05hbWU6ICdEaXNjbG9zdXJlc0ZhaWxlZCcsXHJcbiAgICAgICAgc3RhdGlzdGljOiAnU3VtJyxcclxuICAgICAgICBwZXJpb2Q6IGNkay5EdXJhdGlvbi5ob3VycygyNCksXHJcbiAgICAgICAgZGltZW5zaW9uc01hcDoge1xyXG4gICAgICAgICAgRW52aXJvbm1lbnQ6IHByb3BzLmVudmlyb25tZW50LFxyXG4gICAgICAgIH0sXHJcbiAgICAgIH0pLFxyXG4gICAgICB0aHJlc2hvbGQ6IDEwLFxyXG4gICAgICBldmFsdWF0aW9uUGVyaW9kczogMSxcclxuICAgICAgY29tcGFyaXNvbk9wZXJhdG9yOiBjbG91ZHdhdGNoLkNvbXBhcmlzb25PcGVyYXRvci5HUkVBVEVSX1RIQU5fVEhSRVNIT0xELFxyXG4gICAgICB0cmVhdE1pc3NpbmdEYXRhOiBjbG91ZHdhdGNoLlRyZWF0TWlzc2luZ0RhdGEuTk9UX0JSRUFDSElORyxcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbGxlY3Rpb25GYWlsdXJlQWxhcm0uYWRkQWxhcm1BY3Rpb24obmV3IGNsb3Vkd2F0Y2hfYWN0aW9ucy5TbnNBY3Rpb24odGhpcy5hbGVydFRvcGljKSk7XHJcbiAgICB0aGlzLmFsYXJtcy5wdXNoKGNvbGxlY3Rpb25GYWlsdXJlQWxhcm0pO1xyXG5cclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIC8vIENsb3VkRm9ybWF0aW9uIE91dHB1dHNcclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsICdBbGVydFRvcGljQXJuJywge1xyXG4gICAgICB2YWx1ZTogdGhpcy5hbGVydFRvcGljLnRvcGljQXJuLFxyXG4gICAgICBkZXNjcmlwdGlvbjogJ1NOUyBUb3BpYyBBUk4gZm9yIGFsZXJ0cycsXHJcbiAgICAgIGV4cG9ydE5hbWU6IGBUZG5ldEFsZXJ0VG9waWNBcm4tJHtwcm9wcy5lbnZpcm9ubWVudH1gLFxyXG4gICAgfSk7XHJcblxyXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgJ0FsYXJtQ291bnQnLCB7XHJcbiAgICAgIHZhbHVlOiB0aGlzLmFsYXJtcy5sZW5ndGgudG9TdHJpbmcoKSxcclxuICAgICAgZGVzY3JpcHRpb246ICdOdW1iZXIgb2YgQ2xvdWRXYXRjaCBBbGFybXMgY3JlYXRlZCcsXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIExhbWJkYSBFcnJvciBSYXRl44Oh44OI44Oq44Kv44K544KS5L2c5oiQXHJcbiAgICogXHJcbiAgICogRXJyb3IgUmF0ZSA9IChFcnJvcnMgLyBJbnZvY2F0aW9ucykgKiAxMDBcclxuICAgKi9cclxuICBwcml2YXRlIGNyZWF0ZUVycm9yUmF0ZU1ldHJpYyhsYW1iZGFGdW5jdGlvbjogbGFtYmRhLklGdW5jdGlvbik6IGNsb3Vkd2F0Y2guSU1ldHJpYyB7XHJcbiAgICBjb25zdCBlcnJvcnMgPSBsYW1iZGFGdW5jdGlvbi5tZXRyaWNFcnJvcnMoe1xyXG4gICAgICBzdGF0aXN0aWM6ICdTdW0nLFxyXG4gICAgICBwZXJpb2Q6IGNkay5EdXJhdGlvbi5taW51dGVzKDUpLFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgaW52b2NhdGlvbnMgPSBsYW1iZGFGdW5jdGlvbi5tZXRyaWNJbnZvY2F0aW9ucyh7XHJcbiAgICAgIHN0YXRpc3RpYzogJ1N1bScsXHJcbiAgICAgIHBlcmlvZDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoNSksXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBFcnJvciBSYXRlID0gKEVycm9ycyAvIEludm9jYXRpb25zKSAqIDEwMFxyXG4gICAgcmV0dXJuIG5ldyBjbG91ZHdhdGNoLk1hdGhFeHByZXNzaW9uKHtcclxuICAgICAgZXhwcmVzc2lvbjogJyhlcnJvcnMgLyBpbnZvY2F0aW9ucykgKiAxMDAnLFxyXG4gICAgICB1c2luZ01ldHJpY3M6IHtcclxuICAgICAgICBlcnJvcnMsXHJcbiAgICAgICAgaW52b2NhdGlvbnMsXHJcbiAgICAgIH0sXHJcbiAgICAgIGxhYmVsOiAnRXJyb3IgUmF0ZSAoJSknLFxyXG4gICAgICBwZXJpb2Q6IGNkay5EdXJhdGlvbi5taW51dGVzKDUpLFxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDb2xsZWN0aW9uU3VjY2Vzc1JhdGXjg6Hjg4jjg6rjgq/jgrnjgpLkvZzmiJBcclxuICAgKiBcclxuICAgKiBTdWNjZXNzIFJhdGUgPSAoRGlzY2xvc3VyZXNDb2xsZWN0ZWQgLyAoRGlzY2xvc3VyZXNDb2xsZWN0ZWQgKyBEaXNjbG9zdXJlc0ZhaWxlZCkpICogMTAwXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjcmVhdGVDb2xsZWN0aW9uU3VjY2Vzc1JhdGVNZXRyaWMoZW52aXJvbm1lbnQ6IHN0cmluZyk6IGNsb3Vkd2F0Y2guSU1ldHJpYyB7XHJcbiAgICBjb25zdCBjb2xsZWN0ZWQgPSBuZXcgY2xvdWR3YXRjaC5NZXRyaWMoe1xyXG4gICAgICBuYW1lc3BhY2U6ICdURG5ldC9Db2xsZWN0b3InLFxyXG4gICAgICBtZXRyaWNOYW1lOiAnRGlzY2xvc3VyZXNDb2xsZWN0ZWQnLFxyXG4gICAgICBzdGF0aXN0aWM6ICdTdW0nLFxyXG4gICAgICBwZXJpb2Q6IGNkay5EdXJhdGlvbi5ob3VycygxKSxcclxuICAgICAgZGltZW5zaW9uc01hcDoge1xyXG4gICAgICAgIEVudmlyb25tZW50OiBlbnZpcm9ubWVudCxcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IGZhaWxlZCA9IG5ldyBjbG91ZHdhdGNoLk1ldHJpYyh7XHJcbiAgICAgIG5hbWVzcGFjZTogJ1REbmV0L0NvbGxlY3RvcicsXHJcbiAgICAgIG1ldHJpY05hbWU6ICdEaXNjbG9zdXJlc0ZhaWxlZCcsXHJcbiAgICAgIHN0YXRpc3RpYzogJ1N1bScsXHJcbiAgICAgIHBlcmlvZDogY2RrLkR1cmF0aW9uLmhvdXJzKDEpLFxyXG4gICAgICBkaW1lbnNpb25zTWFwOiB7XHJcbiAgICAgICAgRW52aXJvbm1lbnQ6IGVudmlyb25tZW50LFxyXG4gICAgICB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gU3VjY2VzcyBSYXRlID0gKENvbGxlY3RlZCAvIChDb2xsZWN0ZWQgKyBGYWlsZWQpKSAqIDEwMFxyXG4gICAgcmV0dXJuIG5ldyBjbG91ZHdhdGNoLk1hdGhFeHByZXNzaW9uKHtcclxuICAgICAgZXhwcmVzc2lvbjogJyhjb2xsZWN0ZWQgLyAoY29sbGVjdGVkICsgZmFpbGVkKSkgKiAxMDAnLFxyXG4gICAgICB1c2luZ01ldHJpY3M6IHtcclxuICAgICAgICBjb2xsZWN0ZWQsXHJcbiAgICAgICAgZmFpbGVkLFxyXG4gICAgICB9LFxyXG4gICAgICBsYWJlbDogJ0NvbGxlY3Rpb24gU3VjY2VzcyBSYXRlICglKScsXHJcbiAgICAgIHBlcmlvZDogY2RrLkR1cmF0aW9uLmhvdXJzKDEpLFxyXG4gICAgfSk7XHJcbiAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==