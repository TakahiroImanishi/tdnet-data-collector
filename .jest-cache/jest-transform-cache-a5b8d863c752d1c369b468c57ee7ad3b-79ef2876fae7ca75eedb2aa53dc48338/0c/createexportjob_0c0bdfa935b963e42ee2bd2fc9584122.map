{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\create-export-job.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\create-export-job.ts"],"sourcesContent":["/**\r\n * エクスポートジョブ作成\r\n *\r\n * エクスポートIDを生成し、実行状態をDynamoDBに保存します。\r\n *\r\n * Requirements: 要件5.1（エクスポート）\r\n */\r\n\r\nimport { DynamoDBClient, PutItemCommand } from '@aws-sdk/client-dynamodb';\r\nimport { logger } from '../../utils/logger';\r\nimport { retryWithBackoff } from '../../utils/retry';\r\nimport { ExportRequestBody, ExportStatusItem } from './types';\r\n\r\n// DynamoDBクライアント（グローバルスコープで初期化）\r\nconst dynamoClient = new DynamoDBClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });\r\n\r\n// 環境変数\r\nconst EXPORT_STATUS_TABLE = process.env.EXPORT_STATUS_TABLE_NAME || 'tdnet-export-status';\r\n\r\n/**\r\n * エクスポートジョブを作成\r\n *\r\n * @param requestBody エクスポートリクエストボディ\r\n * @param requestId リクエストID\r\n * @returns エクスポートステータス\r\n */\r\nexport async function createExportJob(\r\n  requestBody: ExportRequestBody,\r\n  requestId: string\r\n): Promise<ExportStatusItem> {\r\n  // エクスポートIDを生成\r\n  const export_id = generateExportId(requestId);\r\n\r\n  // 現在時刻（ISO 8601形式、UTC）\r\n  const requested_at = new Date().toISOString();\r\n\r\n  // TTL（30日後に自動削除）\r\n  const ttl = Math.floor(Date.now() / 1000) + 30 * 24 * 60 * 60;\r\n\r\n  // エクスポートステータスアイテム\r\n  const exportStatus: ExportStatusItem = {\r\n    export_id,\r\n    status: 'pending',\r\n    requested_at,\r\n    progress: 0,\r\n    ttl,\r\n    format: requestBody.format,\r\n    filter: JSON.stringify(requestBody.filter),\r\n  };\r\n\r\n  logger.info('Creating export job', {\r\n    export_id,\r\n    format: requestBody.format,\r\n    filter: requestBody.filter,\r\n  });\r\n\r\n  // DynamoDBに保存\r\n  await retryWithBackoff(\r\n    async () => {\r\n      await dynamoClient.send(\r\n        new PutItemCommand({\r\n          TableName: EXPORT_STATUS_TABLE,\r\n          Item: {\r\n            export_id: { S: exportStatus.export_id },\r\n            status: { S: exportStatus.status },\r\n            requested_at: { S: exportStatus.requested_at },\r\n            progress: { N: String(exportStatus.progress) },\r\n            ttl: { N: String(exportStatus.ttl) },\r\n            format: { S: exportStatus.format },\r\n            filter: { S: exportStatus.filter },\r\n          },\r\n          ConditionExpression: 'attribute_not_exists(export_id)',\r\n        })\r\n      );\r\n    },\r\n    {\r\n      maxRetries: 3,\r\n      initialDelay: 1000,\r\n      backoffMultiplier: 2,\r\n      jitter: true,\r\n      shouldRetry: (error) => {\r\n        return error.name === 'ProvisionedThroughputExceededException';\r\n      },\r\n    }\r\n  );\r\n\r\n  logger.info('Export job created successfully', {\r\n    export_id,\r\n    status: exportStatus.status,\r\n  });\r\n\r\n  return exportStatus;\r\n}\r\n\r\n/**\r\n * エクスポートIDを生成\r\n *\r\n * フォーマット: export_タイムスタンプ_ランダム文字列_リクエストID先頭8文字\r\n * 例: export_1705305600000_abc123_12345678\r\n *\r\n * @param requestId リクエストID\r\n * @returns エクスポートID\r\n */\r\nfunction generateExportId(requestId: string): string {\r\n  const timestamp = Date.now();\r\n  const random = Math.random().toString(36).substring(2, 8);\r\n  const requestIdPrefix = requestId.substring(0, 8);\r\n  return `export_${timestamp}_${random}_${requestIdPrefix}`;\r\n}\r\n"],"version":3}