{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\__tests__\\test-helpers.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\__tests__\\test-helpers.ts"],"sourcesContent":["/**\r\n * Test Helpers for Lambda Collector\r\n *\r\n * テスト環境でのモック設定を簡素化するヘルパー関数。\r\n *\r\n * Requirements: テスト環境の整備（Task 9.4）\r\n */\r\n\r\nimport { mockClient } from 'aws-sdk-client-mock';\r\nimport { DynamoDBDocumentClient, PutCommand, GetCommand, UpdateCommand, QueryCommand } from '@aws-sdk/lib-dynamodb';\r\nimport { S3Client, PutObjectCommand, GetObjectCommand } from '@aws-sdk/client-s3';\r\nimport { CloudWatchClient, PutMetricDataCommand } from '@aws-sdk/client-cloudwatch';\r\nimport { RateLimiter } from '../../../utils/rate-limiter';\r\nimport { CollectorDependencies, setDependencies, resetDependencies } from '../dependencies';\r\n\r\n/**\r\n * AWS SDKモッククライアント\r\n */\r\nexport const dynamoMock = mockClient(DynamoDBDocumentClient);\r\nexport const s3Mock = mockClient(S3Client);\r\nexport const cloudWatchMock = mockClient(CloudWatchClient);\r\n\r\n/**\r\n * RateLimiterモック\r\n */\r\nexport class MockRateLimiter extends RateLimiter {\r\n  constructor() {\r\n    super(0); // 遅延なし\r\n  }\r\n\r\n  async waitIfNeeded(): Promise<void> {\r\n    // テスト環境では遅延なし\r\n    return Promise.resolve();\r\n  }\r\n}\r\n\r\n/**\r\n * テスト用の依存関係をセットアップ\r\n *\r\n * beforeEach()で呼び出して、モックを注入する。\r\n *\r\n * @returns CollectorDependencies\r\n */\r\nexport function setupTestDependencies(): CollectorDependencies {\r\n  // モックをリセット\r\n  dynamoMock.reset();\r\n  s3Mock.reset();\r\n  cloudWatchMock.reset();\r\n\r\n  // デフォルトのモック動作を設定\r\n  dynamoMock.on(PutCommand).resolves({});\r\n  dynamoMock.on(GetCommand).resolves({ Item: undefined });\r\n  dynamoMock.on(UpdateCommand).resolves({});\r\n  dynamoMock.on(QueryCommand).resolves({ Items: [] });\r\n\r\n  s3Mock.on(PutObjectCommand).resolves({});\r\n  s3Mock.on(GetObjectCommand).resolves({\r\n    Body: Buffer.from('mock pdf content'),\r\n  } as any);\r\n\r\n  cloudWatchMock.on(PutMetricDataCommand).resolves({});\r\n\r\n  // モック依存関係を作成\r\n  const deps: CollectorDependencies = {\r\n    dynamoClient: dynamoMock as any,\r\n    s3Client: s3Mock as any,\r\n    cloudWatchClient: cloudWatchMock as any,\r\n    rateLimiter: new MockRateLimiter(),\r\n  };\r\n\r\n  // 依存関係を注入\r\n  setDependencies(deps);\r\n\r\n  return deps;\r\n}\r\n\r\n/**\r\n * テスト用の依存関係をクリーンアップ\r\n *\r\n * afterEach()で呼び出して、モックをリセットする。\r\n */\r\nexport function cleanupTestDependencies(): void {\r\n  dynamoMock.reset();\r\n  s3Mock.reset();\r\n  cloudWatchMock.reset();\r\n  resetDependencies();\r\n}\r\n\r\n/**\r\n * DynamoDBモックの設定: 開示情報の取得\r\n *\r\n * @param disclosureId 開示ID\r\n * @param item 返却するアイテム\r\n */\r\nexport function mockGetDisclosure(disclosureId: string, item: any): void {\r\n  dynamoMock.on(GetCommand, {\r\n    TableName: process.env.DYNAMODB_TABLE,\r\n    Key: { disclosure_id: disclosureId },\r\n  }).resolves({ Item: item });\r\n}\r\n\r\n/**\r\n * DynamoDBモックの設定: 開示情報の保存\r\n *\r\n * @param success 成功するかどうか\r\n */\r\nexport function mockPutDisclosure(success: boolean = true): void {\r\n  if (success) {\r\n    dynamoMock.on(PutCommand).resolves({});\r\n  } else {\r\n    dynamoMock.on(PutCommand).rejects(new Error('DynamoDB PutItem failed'));\r\n  }\r\n}\r\n\r\n/**\r\n * DynamoDBモックの設定: 実行状態の更新\r\n *\r\n * @param success 成功するかどうか\r\n */\r\nexport function mockUpdateExecutionStatus(success: boolean = true): void {\r\n  if (success) {\r\n    dynamoMock.on(UpdateCommand).resolves({});\r\n  } else {\r\n    dynamoMock.on(UpdateCommand).rejects(new Error('DynamoDB UpdateItem failed'));\r\n  }\r\n}\r\n\r\n/**\r\n * S3モックの設定: PDFアップロード\r\n *\r\n * @param success 成功するかどうか\r\n */\r\nexport function mockPutPdf(success: boolean = true): void {\r\n  if (success) {\r\n    s3Mock.on(PutObjectCommand).resolves({});\r\n  } else {\r\n    s3Mock.on(PutObjectCommand).rejects(new Error('S3 PutObject failed'));\r\n  }\r\n}\r\n\r\n/**\r\n * S3モックの設定: PDFダウンロード\r\n *\r\n * @param content PDFコンテンツ\r\n */\r\nexport function mockGetPdf(content: Buffer = Buffer.from('mock pdf content')): void {\r\n  s3Mock.on(GetObjectCommand).resolves({\r\n    Body: content,\r\n  } as any);\r\n}\r\n\r\n/**\r\n * CloudWatchモックの設定: メトリクス送信\r\n *\r\n * @param success 成功するかどうか\r\n */\r\nexport function mockPutMetrics(success: boolean = true): void {\r\n  if (success) {\r\n    cloudWatchMock.on(PutMetricDataCommand).resolves({});\r\n  } else {\r\n    cloudWatchMock.on(PutMetricDataCommand).rejects(new Error('CloudWatch PutMetricData failed'));\r\n  }\r\n}\r\n"],"version":3}