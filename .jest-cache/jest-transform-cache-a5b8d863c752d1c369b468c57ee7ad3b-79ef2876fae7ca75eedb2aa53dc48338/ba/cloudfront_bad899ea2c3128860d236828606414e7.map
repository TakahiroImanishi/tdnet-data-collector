{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\cdk\\lib\\constructs\\cloudfront.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\cdk\\lib\\constructs\\cloudfront.ts"],"sourcesContent":["import * as cdk from 'aws-cdk-lib';\r\nimport * as cloudfront from 'aws-cdk-lib/aws-cloudfront';\r\nimport * as origins from 'aws-cdk-lib/aws-cloudfront-origins';\r\nimport * as s3 from 'aws-cdk-lib/aws-s3';\r\nimport * as iam from 'aws-cdk-lib/aws-iam';\r\nimport { Construct } from 'constructs';\r\n\r\n/**\r\n * CloudFront Distribution Constructのプロパティ\r\n */\r\nexport interface DashboardCloudFrontProps {\r\n  /**\r\n   * ダッシュボードのS3バケット\r\n   */\r\n  readonly dashboardBucket: s3.IBucket;\r\n\r\n  /**\r\n   * 環境名（dev, prod等）\r\n   */\r\n  readonly environment: string;\r\n}\r\n\r\n/**\r\n * TDnet Dashboard用CloudFront Distribution Construct\r\n * \r\n * 機能:\r\n * - S3バケットへのOAI（Origin Access Identity）アクセス\r\n * - HTTPS強制\r\n * - キャッシュ最適化（index.html: 1分、その他: 1日）\r\n * - エラーページ設定（404 → index.html for SPA routing）\r\n */\r\nexport class DashboardCloudFront extends Construct {\r\n  public readonly distribution: cloudfront.Distribution;\r\n  public readonly originAccessIdentity: cloudfront.OriginAccessIdentity;\r\n\r\n  constructor(scope: Construct, id: string, props: DashboardCloudFrontProps) {\r\n    super(scope, id);\r\n\r\n    // Origin Access Identity (OAI) を作成\r\n    // S3バケットへの直接アクセスを防ぎ、CloudFront経由のみ許可\r\n    this.originAccessIdentity = new cloudfront.OriginAccessIdentity(this, 'OAI', {\r\n      comment: `OAI for TDnet Dashboard (${props.environment})`,\r\n    });\r\n\r\n    // S3バケットポリシーにOAIからの読み取りを許可\r\n    props.dashboardBucket.addToResourcePolicy(\r\n      new iam.PolicyStatement({\r\n        actions: ['s3:GetObject'],\r\n        resources: [props.dashboardBucket.arnForObjects('*')],\r\n        principals: [\r\n          new iam.CanonicalUserPrincipal(\r\n            this.originAccessIdentity.cloudFrontOriginAccessIdentityS3CanonicalUserId\r\n          ),\r\n        ],\r\n      })\r\n    );\r\n\r\n    // index.html用のキャッシュポリシー（短いTTL: 1分）\r\n    const indexCachePolicy = new cloudfront.CachePolicy(this, 'IndexCachePolicy', {\r\n      cachePolicyName: `tdnet-dashboard-index-${props.environment}`,\r\n      comment: 'Cache policy for index.html with short TTL',\r\n      defaultTtl: cdk.Duration.seconds(60),\r\n      minTtl: cdk.Duration.seconds(0),\r\n      maxTtl: cdk.Duration.seconds(60),\r\n      cookieBehavior: cloudfront.CacheCookieBehavior.none(),\r\n      headerBehavior: cloudfront.CacheHeaderBehavior.none(),\r\n      queryStringBehavior: cloudfront.CacheQueryStringBehavior.none(),\r\n      enableAcceptEncodingGzip: true,\r\n      enableAcceptEncodingBrotli: true,\r\n    });\r\n\r\n    // 静的アセット用のキャッシュポリシー（長いTTL: 1日）\r\n    const assetsCachePolicy = new cloudfront.CachePolicy(this, 'AssetsCachePolicy', {\r\n      cachePolicyName: `tdnet-dashboard-assets-${props.environment}`,\r\n      comment: 'Cache policy for static assets with long TTL',\r\n      defaultTtl: cdk.Duration.days(1),\r\n      minTtl: cdk.Duration.seconds(0),\r\n      maxTtl: cdk.Duration.days(365),\r\n      cookieBehavior: cloudfront.CacheCookieBehavior.none(),\r\n      headerBehavior: cloudfront.CacheHeaderBehavior.none(),\r\n      queryStringBehavior: cloudfront.CacheQueryStringBehavior.none(),\r\n      enableAcceptEncodingGzip: true,\r\n      enableAcceptEncodingBrotli: true,\r\n    });\r\n\r\n    // CloudFront Distribution作成\r\n    this.distribution = new cloudfront.Distribution(this, 'Distribution', {\r\n      comment: `TDnet Dashboard Distribution (${props.environment})`,\r\n      defaultRootObject: 'index.html',\r\n      \r\n      // S3オリジン設定\r\n      defaultBehavior: {\r\n        origin: new origins.S3Origin(props.dashboardBucket, {\r\n          originAccessIdentity: this.originAccessIdentity,\r\n        }),\r\n        viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,\r\n        cachePolicy: indexCachePolicy,\r\n        compress: true,\r\n      },\r\n\r\n      // 静的アセット用の追加ビヘイビア\r\n      additionalBehaviors: {\r\n        '/static/*': {\r\n          origin: new origins.S3Origin(props.dashboardBucket, {\r\n            originAccessIdentity: this.originAccessIdentity,\r\n          }),\r\n          viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,\r\n          cachePolicy: assetsCachePolicy,\r\n          compress: true,\r\n        },\r\n        '*.js': {\r\n          origin: new origins.S3Origin(props.dashboardBucket, {\r\n            originAccessIdentity: this.originAccessIdentity,\r\n          }),\r\n          viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,\r\n          cachePolicy: assetsCachePolicy,\r\n          compress: true,\r\n        },\r\n        '*.css': {\r\n          origin: new origins.S3Origin(props.dashboardBucket, {\r\n            originAccessIdentity: this.originAccessIdentity,\r\n          }),\r\n          viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,\r\n          cachePolicy: assetsCachePolicy,\r\n          compress: true,\r\n        },\r\n      },\r\n\r\n      // SPA用エラーページ設定（404 → index.html）\r\n      errorResponses: [\r\n        {\r\n          httpStatus: 404,\r\n          responseHttpStatus: 200,\r\n          responsePagePath: '/index.html',\r\n          ttl: cdk.Duration.seconds(60),\r\n        },\r\n        {\r\n          httpStatus: 403,\r\n          responseHttpStatus: 200,\r\n          responsePagePath: '/index.html',\r\n          ttl: cdk.Duration.seconds(60),\r\n        },\r\n      ],\r\n\r\n      // 価格クラス（コスト最適化: 北米・欧州のみ）\r\n      priceClass: cloudfront.PriceClass.PRICE_CLASS_100,\r\n\r\n      // HTTPバージョン\r\n      httpVersion: cloudfront.HttpVersion.HTTP2_AND_3,\r\n\r\n      // 最小TLSバージョン\r\n      minimumProtocolVersion: cloudfront.SecurityPolicyProtocol.TLS_V1_2_2021,\r\n    });\r\n\r\n    // CloudFront Distribution URLを出力\r\n    new cdk.CfnOutput(this, 'DistributionDomainName', {\r\n      value: this.distribution.distributionDomainName,\r\n      description: 'CloudFront Distribution Domain Name',\r\n      exportName: `tdnet-dashboard-domain-${props.environment}`,\r\n    });\r\n\r\n    new cdk.CfnOutput(this, 'DistributionId', {\r\n      value: this.distribution.distributionId,\r\n      description: 'CloudFront Distribution ID',\r\n      exportName: `tdnet-dashboard-distribution-id-${props.environment}`,\r\n    });\r\n\r\n    // CloudFront Distribution URLをHTTPS形式で出力\r\n    new cdk.CfnOutput(this, 'DashboardUrl', {\r\n      value: `https://${this.distribution.distributionDomainName}`,\r\n      description: 'TDnet Dashboard URL',\r\n      exportName: `tdnet-dashboard-url-${props.environment}`,\r\n    });\r\n  }\r\n}\r\n"],"version":3}