{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\download-pdf.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\download-pdf.ts"],"sourcesContent":["/**\r\n * PDFダウンロード機能\r\n *\r\n * TDnetからPDFファイルをダウンロードし、S3に保存します。\r\n * ファイル整合性検証と再試行ロジックを含みます。\r\n *\r\n * Requirements: 要件1.3, 3.3, 6.1（PDFダウンロード、S3保存、エラーハンドリング）\r\n */\r\n\r\nimport axios from 'axios';\r\nimport { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';\r\nimport { validatePdfFile } from '../../scraper/pdf-downloader';\r\nimport { RateLimiter } from '../../utils/rate-limiter';\r\nimport { retryWithBackoff } from '../../utils/retry';\r\nimport { logger } from '../../utils/logger';\r\nimport { sendErrorMetric, sendSuccessMetric } from '../../utils/cloudwatch-metrics';\r\nimport { RetryableError } from '../../errors';\r\n\r\n// S3クライアントはグローバルスコープで初期化（再利用される）\r\nconst s3Client = new S3Client({});\r\n\r\n// レート制限設定（PDFダウンロードも2秒間隔）\r\nconst rateLimiter = new RateLimiter({ minDelayMs: 2000 });\r\n\r\n// 環境変数は関数内で取得（テスト時の柔軟性のため）\r\nfunction getS3Bucket(): string {\r\n  return process.env.S3_BUCKET || 'tdnet-data-collector-pdfs';\r\n}\r\n\r\n/**\r\n * PDFファイルをダウンロードしてS3に保存\r\n *\r\n * @param disclosure_id - 開示ID\r\n * @param pdf_url - PDF URL\r\n * @param disclosed_at - 開示日時（ISO 8601形式）\r\n * @returns S3キー（保存先パス）\r\n * @throws RetryableError ネットワークエラー、サーバーエラー\r\n * @throws ValidationError PDFファイルが不正な場合\r\n *\r\n * @example\r\n * ```typescript\r\n * const s3Key = await downloadPdf(\r\n *   'TD20240115001',\r\n *   'https://www.release.tdnet.info/inbs/140120240115001.pdf',\r\n *   '2024-01-15T10:30:00Z'\r\n * );\r\n * console.log(`PDF saved to: ${s3Key}`);\r\n * // Output: PDF saved to: 2024/01/15/TD20240115001.pdf\r\n * ```\r\n */\r\nexport async function downloadPdf(\r\n  disclosure_id: string,\r\n  pdf_url: string,\r\n  disclosed_at: string\r\n): Promise<string> {\r\n  try {\r\n    logger.info('Downloading PDF', { disclosure_id, pdf_url });\r\n\r\n    // レート制限を適用\r\n    await rateLimiter.waitIfNeeded();\r\n\r\n    // PDFをダウンロード（再試行あり）\r\n    const pdfBuffer = await retryWithBackoff(\r\n      async () => {\r\n        try {\r\n          const response = await axios.get(pdf_url, {\r\n            responseType: 'arraybuffer',\r\n            timeout: 60000, // 60秒タイムアウト\r\n            headers: {\r\n              'User-Agent': 'TDnet-Data-Collector/1.0',\r\n            },\r\n          });\r\n          return Buffer.from(response.data);\r\n        } catch (error) {\r\n          if (axios.isAxiosError(error)) {\r\n            // タイムアウトエラー\r\n            if (error.code === 'ECONNABORTED' || error.code === 'ETIMEDOUT') {\r\n              throw new RetryableError(`Timeout downloading PDF: ${pdf_url}`, error);\r\n            }\r\n            // 5xxエラー\r\n            if (error.response && error.response.status >= 500) {\r\n              throw new RetryableError(\r\n                `Server error (${error.response.status}): ${pdf_url}`,\r\n                error\r\n              );\r\n            }\r\n            // 429 Too Many Requests\r\n            if (error.response && error.response.status === 429) {\r\n              throw new RetryableError(`Rate limit exceeded: ${pdf_url}`, error);\r\n            }\r\n          }\r\n          throw error;\r\n        }\r\n      },\r\n      {\r\n        maxRetries: 3,\r\n        initialDelay: 2000,\r\n        backoffMultiplier: 2,\r\n        jitter: true,\r\n      }\r\n    );\r\n\r\n    // PDFファイル整合性検証\r\n    validatePdfFile(pdfBuffer);\r\n\r\n    // S3パス生成（YYYY/MM/DD/disclosure_id.pdf）\r\n    const s3Key = generateS3Key(disclosure_id, disclosed_at);\r\n\r\n    // S3にアップロード\r\n    await s3Client.send(\r\n      new PutObjectCommand({\r\n        Bucket: getS3Bucket(),\r\n        Key: s3Key,\r\n        Body: pdfBuffer,\r\n        ContentType: 'application/pdf',\r\n        Metadata: {\r\n          disclosure_id,\r\n          disclosed_at,\r\n          uploaded_at: new Date().toISOString(),\r\n        },\r\n      })\r\n    );\r\n\r\n    logger.info('PDF uploaded to S3', {\r\n      disclosure_id,\r\n      s3_key: s3Key,\r\n      size: pdfBuffer.length,\r\n    });\r\n\r\n    // 成功メトリクス送信\r\n    await sendSuccessMetric(1, 'DownloadPdf', {\r\n      DisclosureId: disclosure_id,\r\n    });\r\n\r\n    return s3Key;\r\n  } catch (error) {\r\n    logger.error('Failed to download PDF', {\r\n      disclosure_id,\r\n      pdf_url,\r\n      error_type: error instanceof Error ? error.constructor.name : 'Unknown',\r\n      error_message: error instanceof Error ? error.message : String(error),\r\n    });\r\n\r\n    // エラーメトリクス送信\r\n    await sendErrorMetric(\r\n      error instanceof Error ? error.constructor.name : 'Unknown',\r\n      'DownloadPdf',\r\n      { DisclosureId: disclosure_id }\r\n    );\r\n\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * S3キーを生成（YYYY/MM/DD/disclosure_id.pdf形式）\r\n *\r\n * JSTに変換してYYYY/MM/DD形式を生成します。\r\n * TDnetは日本の開示情報サービスであり、開示時刻は日本時間（JST, UTC+9）で管理されます。\r\n *\r\n * @param disclosure_id - 開示ID\r\n * @param disclosed_at - 開示日時（ISO 8601形式）\r\n * @returns S3キー\r\n *\r\n * @example\r\n * ```typescript\r\n * // UTC: 2024-01-31T15:30:00Z → JST: 2024-02-01T00:30:00\r\n * const key = generateS3Key('TD20240131001', '2024-01-31T15:30:00Z');\r\n * console.log(key); // Output: 2024/02/01/TD20240131001.pdf\r\n * ```\r\n */\r\nfunction generateS3Key(disclosure_id: string, disclosed_at: string): string {\r\n  // UTCからJSTに変換（UTC+9時間）\r\n  const date = new Date(disclosed_at);\r\n  const jstDate = new Date(date.getTime() + 9 * 60 * 60 * 1000);\r\n\r\n  const year = jstDate.getUTCFullYear();\r\n  const month = String(jstDate.getUTCMonth() + 1).padStart(2, '0');\r\n  const day = String(jstDate.getUTCDate()).padStart(2, '0');\r\n\r\n  return `${year}/${month}/${day}/${disclosure_id}.pdf`;\r\n}\r\n"],"version":3}