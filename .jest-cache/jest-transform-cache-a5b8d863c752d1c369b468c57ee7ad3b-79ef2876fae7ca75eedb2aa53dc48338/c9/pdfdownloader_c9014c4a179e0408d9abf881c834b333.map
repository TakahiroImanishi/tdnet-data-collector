{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\scraper\\pdf-downloader.ts","mappings":";AAAA;;;;;;GAMG;;;;;AAeH,kCA0CC;AAQD,0CAkBC;AAjFD,kDAA0B;AAC1B,4CAAyC;AACzC,sCAA4D;AAC5D,0CAAkD;AAElD;;;;;;;GAOG;AACI,KAAK,UAAU,WAAW,CAAC,GAAW;IAC3C,OAAO,MAAM,IAAA,wBAAgB,EAC3B,KAAK,IAAI,EAAE;QACT,IAAI,CAAC;YACH,MAAM,QAAQ,GAAG,MAAM,eAAK,CAAC,GAAG,CAAC,GAAG,EAAE;gBACpC,YAAY,EAAE,aAAa;gBAC3B,OAAO,EAAE,KAAK,EAAE,YAAY;gBAC5B,OAAO,EAAE;oBACP,YAAY,EAAE,0BAA0B;iBACzC;aACF,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;YAE1C,kBAAkB;YAClB,eAAe,CAAC,MAAM,CAAC,CAAC;YAExB,eAAM,CAAC,IAAI,CAAC,6BAA6B,EAAE;gBACzC,GAAG;gBACH,IAAI,EAAE,MAAM,CAAC,MAAM;aACpB,CAAC,CAAC;YAEH,OAAO,MAAM,CAAC;QAChB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,eAAK,CAAC,YAAY,CAAC,KAAK,CAAC,EAAE,CAAC;gBAC9B,IAAI,KAAK,CAAC,IAAI,KAAK,cAAc,IAAI,KAAK,CAAC,IAAI,KAAK,WAAW,EAAE,CAAC;oBAChE,MAAM,IAAI,uBAAc,CAAC,4BAA4B,GAAG,EAAE,CAAC,CAAC;gBAC9D,CAAC;gBACD,IAAI,KAAK,CAAC,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,IAAI,GAAG,EAAE,CAAC;oBACnD,MAAM,IAAI,uBAAc,CAAC,iBAAiB,KAAK,CAAC,QAAQ,CAAC,MAAM,MAAM,GAAG,EAAE,CAAC,CAAC;gBAC9E,CAAC;YACH,CAAC;YACD,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC,EACD;QACE,UAAU,EAAE,CAAC;QACb,YAAY,EAAE,IAAI;QAClB,iBAAiB,EAAE,CAAC;QACpB,MAAM,EAAE,IAAI;KACb,CACF,CAAC;AACJ,CAAC;AAED;;;;;GAKG;AACH,SAAgB,eAAe,CAAC,MAAc;IAC5C,yBAAyB;IACzB,MAAM,OAAO,GAAG,EAAE,GAAG,IAAI,CAAC,CAAC,OAAO;IAClC,MAAM,OAAO,GAAG,EAAE,GAAG,IAAI,GAAG,IAAI,CAAC,CAAC,OAAO;IAEzC,IAAI,MAAM,CAAC,MAAM,GAAG,OAAO,EAAE,CAAC;QAC5B,MAAM,IAAI,wBAAe,CAAC,uBAAuB,MAAM,CAAC,MAAM,gBAAgB,OAAO,GAAG,CAAC,CAAC;IAC5F,CAAC;IAED,IAAI,MAAM,CAAC,MAAM,GAAG,OAAO,EAAE,CAAC;QAC5B,MAAM,IAAI,wBAAe,CAAC,uBAAuB,MAAM,CAAC,MAAM,gBAAgB,OAAO,GAAG,CAAC,CAAC;IAC5F,CAAC;IAED,wBAAwB;IACxB,MAAM,MAAM,GAAG,MAAM,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;IACpD,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,OAAO,CAAC,EAAE,CAAC;QAChC,MAAM,IAAI,wBAAe,CAAC,uBAAuB,MAAM,EAAE,CAAC,CAAC;IAC7D,CAAC;AACH,CAAC","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\scraper\\pdf-downloader.ts"],"sourcesContent":["/**\r\n * PDFダウンローダー\r\n *\r\n * TDnetからPDFファイルをダウンロードし、バリデーションを行います。\r\n *\r\n * Requirements: 要件1.3, 2.3（PDFダウンロード、整合性検証）\r\n */\r\n\r\nimport axios from 'axios';\r\nimport { logger } from '../utils/logger';\r\nimport { RetryableError, ValidationError } from '../errors';\r\nimport { retryWithBackoff } from '../utils/retry';\r\n\r\n/**\r\n * PDFファイルをダウンロード\r\n *\r\n * @param url PDF URL\r\n * @returns PDFファイルのバイナリデータ\r\n * @throws RetryableError ネットワークエラー\r\n * @throws ValidationError PDFファイルが不正な場合\r\n */\r\nexport async function downloadPdf(url: string): Promise<Buffer> {\r\n  return await retryWithBackoff(\r\n    async () => {\r\n      try {\r\n        const response = await axios.get(url, {\r\n          responseType: 'arraybuffer',\r\n          timeout: 30000, // 30秒タイムアウト\r\n          headers: {\r\n            'User-Agent': 'TDnet-Data-Collector/1.0',\r\n          },\r\n        });\r\n\r\n        const buffer = Buffer.from(response.data);\r\n\r\n        // PDFファイルのバリデーション\r\n        validatePdfFile(buffer);\r\n\r\n        logger.info('PDF downloaded successfully', {\r\n          url,\r\n          size: buffer.length,\r\n        });\r\n\r\n        return buffer;\r\n      } catch (error) {\r\n        if (axios.isAxiosError(error)) {\r\n          if (error.code === 'ECONNABORTED' || error.code === 'ETIMEDOUT') {\r\n            throw new RetryableError(`Timeout downloading PDF: ${url}`);\r\n          }\r\n          if (error.response && error.response.status >= 500) {\r\n            throw new RetryableError(`Server error (${error.response.status}): ${url}`);\r\n          }\r\n        }\r\n        throw error;\r\n      }\r\n    },\r\n    {\r\n      maxRetries: 3,\r\n      initialDelay: 2000,\r\n      backoffMultiplier: 2,\r\n      jitter: true,\r\n    }\r\n  );\r\n}\r\n\r\n/**\r\n * PDFファイルのバリデーション\r\n *\r\n * @param buffer PDFファイルのバイナリデータ\r\n * @throws ValidationError PDFファイルが不正な場合\r\n */\r\nexport function validatePdfFile(buffer: Buffer): void {\r\n  // ファイルサイズチェック（10KB〜50MB）\r\n  const minSize = 10 * 1024; // 10KB\r\n  const maxSize = 50 * 1024 * 1024; // 50MB\r\n\r\n  if (buffer.length < minSize) {\r\n    throw new ValidationError(`PDF file too small: ${buffer.length} bytes (min: ${minSize})`);\r\n  }\r\n\r\n  if (buffer.length > maxSize) {\r\n    throw new ValidationError(`PDF file too large: ${buffer.length} bytes (max: ${maxSize})`);\r\n  }\r\n\r\n  // PDFヘッダーチェック（%PDF-で開始）\r\n  const header = buffer.slice(0, 5).toString('utf-8');\r\n  if (!header.startsWith('%PDF-')) {\r\n    throw new ValidationError(`Invalid PDF header: ${header}`);\r\n  }\r\n}\r\n"],"version":3}