{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\save-metadata.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\save-metadata.ts"],"sourcesContent":["/**\r\n * メタデータ保存機能\r\n *\r\n * 開示情報のメタデータをDynamoDBに保存します。\r\n * 重複チェックとdate_partitionの自動生成を含みます。\r\n *\r\n * Requirements: 要件1.4, 2.4（メタデータ保存、重複チェック）\r\n */\r\n\r\nimport { DynamoDBClient, PutItemCommand } from '@aws-sdk/client-dynamodb';\r\nimport { marshall } from '@aws-sdk/util-dynamodb';\r\nimport { generateDatePartition } from '../../utils/date-partition';\r\nimport { retryWithBackoff } from '../../utils/retry';\r\nimport { logger } from '../../utils/logger';\r\nimport { sendErrorMetric, sendSuccessMetric } from '../../utils/cloudwatch-metrics';\r\nimport { RetryableError } from '../../errors';\r\nimport { Disclosure } from '../../types';\r\n\r\n// DynamoDBクライアントはグローバルスコープで初期化（再利用される）\r\nconst dynamoClient = new DynamoDBClient({});\r\n\r\n// 環境変数は関数内で取得（テスト時の柔軟性のため）\r\nfunction getDynamoTable(): string {\r\n  return process.env.DYNAMODB_TABLE || 'tdnet_disclosures';\r\n}\r\n\r\n/**\r\n * メタデータをDynamoDBに保存\r\n *\r\n * Two-Phase Commit原則に従い、date_partitionを事前生成してから保存します。\r\n * 重複チェック（ConditionExpression）により、同じdisclosure_idの重複保存を防ぎます。\r\n *\r\n * @param disclosure - 開示情報\r\n * @param s3_key - S3キー（PDFファイルの保存先）\r\n * @throws ConditionalCheckFailedException 重複する開示IDの場合（警告レベル）\r\n * @throws ValidationError date_partitionの生成に失敗した場合\r\n *\r\n * @example\r\n * ```typescript\r\n * const disclosure: Disclosure = {\r\n *   disclosure_id: 'TD20240115001',\r\n *   company_code: '1234',\r\n *   company_name: '株式会社サンプル',\r\n *   disclosure_type: '決算短信',\r\n *   title: '2024年3月期 第3四半期決算短信',\r\n *   disclosed_at: '2024-01-15T10:30:00Z',\r\n *   pdf_url: 'https://www.release.tdnet.info/inbs/140120240115001.pdf',\r\n *   s3_key: '',\r\n *   collected_at: '',\r\n *   date_partition: '',\r\n * };\r\n *\r\n * await saveMetadata(disclosure, '2024/01/15/TD20240115001.pdf');\r\n * ```\r\n */\r\nexport async function saveMetadata(disclosure: Disclosure, s3_key: string): Promise<void> {\r\n  try {\r\n    // date_partitionを事前生成（Two-Phase Commit原則）\r\n    const date_partition = generateDatePartition(disclosure.disclosed_at);\r\n\r\n    const item = {\r\n      disclosure_id: disclosure.disclosure_id,\r\n      company_code: disclosure.company_code,\r\n      company_name: disclosure.company_name,\r\n      disclosure_type: disclosure.disclosure_type,\r\n      title: disclosure.title,\r\n      disclosed_at: disclosure.disclosed_at,\r\n      date_partition,\r\n      pdf_url: disclosure.pdf_url,\r\n      s3_key,\r\n      collected_at: new Date().toISOString(),\r\n    };\r\n\r\n    logger.info('Saving metadata to DynamoDB', {\r\n      disclosure_id: disclosure.disclosure_id,\r\n      date_partition,\r\n    });\r\n\r\n    // DynamoDBに保存（重複チェック付き、再試行あり）\r\n    await retryWithBackoff(\r\n      async () => {\r\n        try {\r\n          await dynamoClient.send(\r\n            new PutItemCommand({\r\n              TableName: getDynamoTable(),\r\n              Item: marshall(item),\r\n              ConditionExpression: 'attribute_not_exists(disclosure_id)',\r\n            })\r\n          );\r\n        } catch (error: any) {\r\n          // ProvisionedThroughputExceededExceptionは再試行可能\r\n          if (error.name === 'ProvisionedThroughputExceededException') {\r\n            throw new RetryableError(\r\n              `DynamoDB throughput exceeded: ${error.message}`,\r\n              error\r\n            );\r\n          }\r\n          // ConditionalCheckFailedExceptionは再試行不可（重複）\r\n          if (error.name === 'ConditionalCheckFailedException') {\r\n            throw error; // そのままスロー（外側のcatchで処理）\r\n          }\r\n          // その他のエラーもそのままスロー\r\n          throw error;\r\n        }\r\n      },\r\n      {\r\n        maxRetries: 3,\r\n        initialDelay: 1000,\r\n        backoffMultiplier: 2,\r\n        jitter: true,\r\n        shouldRetry: (error) => error instanceof RetryableError,\r\n      }\r\n    );\r\n\r\n    logger.info('Metadata saved successfully', {\r\n      disclosure_id: disclosure.disclosure_id,\r\n      date_partition,\r\n      s3_key,\r\n    });\r\n\r\n    // 成功メトリクス送信\r\n    await sendSuccessMetric(1, 'SaveMetadata', {\r\n      DatePartition: date_partition,\r\n    });\r\n  } catch (error: any) {\r\n    if (error.name === 'ConditionalCheckFailedException') {\r\n      // 重複は警告レベルで記録（エラーではない）\r\n      logger.warn('Duplicate disclosure detected', {\r\n        disclosure_id: disclosure.disclosure_id,\r\n        s3_key,\r\n      });\r\n      return; // 重複は無視\r\n    }\r\n\r\n    logger.error('Failed to save metadata', {\r\n      disclosure_id: disclosure.disclosure_id,\r\n      error_type: error.constructor?.name || 'Unknown',\r\n      error_message: error.message || String(error),\r\n    });\r\n\r\n    // エラーメトリクス送信\r\n    await sendErrorMetric(\r\n      error.constructor?.name || 'Unknown',\r\n      'SaveMetadata',\r\n      { DisclosureId: disclosure.disclosure_id }\r\n    );\r\n\r\n    throw error;\r\n  }\r\n}\r\n"],"version":3}