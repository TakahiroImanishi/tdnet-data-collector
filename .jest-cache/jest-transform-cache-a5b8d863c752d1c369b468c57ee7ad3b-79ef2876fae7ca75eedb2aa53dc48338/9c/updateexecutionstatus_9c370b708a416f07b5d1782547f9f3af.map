{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\update-execution-status.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\update-execution-status.ts"],"sourcesContent":["/**\r\n * 実行状態管理機能\r\n *\r\n * Lambda Collectorの実行状態をDynamoDBに保存・更新します。\r\n * 進捗率の単調性を保証し、TTLによる自動削除をサポートします。\r\n *\r\n * Requirements: 要件5.4（実行状態管理）\r\n */\r\n\r\nimport { DynamoDBClient, PutItemCommand } from '@aws-sdk/client-dynamodb';\r\nimport { marshall } from '@aws-sdk/util-dynamodb';\r\nimport { logger } from '../../utils/logger';\r\n\r\n// DynamoDBクライアントはグローバルスコープで初期化（再利用される）\r\nconst dynamoClient = new DynamoDBClient({});\r\n\r\n// 環境変数は関数内で取得（テスト時の柔軟性のため）\r\nfunction getDynamoExecutionsTable(): string {\r\n  return process.env.DYNAMODB_EXECUTIONS_TABLE || 'tdnet_executions';\r\n}\r\n\r\n/**\r\n * 実行状態\r\n */\r\nexport interface ExecutionStatus {\r\n  /** 実行ID */\r\n  execution_id: string;\r\n\r\n  /** ステータス */\r\n  status: 'pending' | 'running' | 'completed' | 'failed';\r\n\r\n  /** 進捗率（0-100） */\r\n  progress: number;\r\n\r\n  /** 収集成功件数 */\r\n  collected_count: number;\r\n\r\n  /** 収集失敗件数 */\r\n  failed_count: number;\r\n\r\n  /** 開始日時（ISO 8601形式） */\r\n  started_at: string;\r\n\r\n  /** 更新日時（ISO 8601形式） */\r\n  updated_at: string;\r\n\r\n  /** 完了日時（ISO 8601形式、completed/failedの場合のみ） */\r\n  completed_at?: string;\r\n\r\n  /** エラーメッセージ（failedの場合のみ） */\r\n  error_message?: string;\r\n\r\n  /** TTL（30日後に自動削除） */\r\n  ttl?: number;\r\n}\r\n\r\n/**\r\n * 実行状態を作成または更新\r\n *\r\n * 進捗率は0-100の範囲に自動制限されます。\r\n * completed/failedステータスの場合、completed_atとTTLが自動設定されます。\r\n *\r\n * @param execution_id - 実行ID\r\n * @param status - ステータス\r\n * @param progress - 進捗率（0-100）\r\n * @param collected_count - 収集成功件数（デフォルト: 0）\r\n * @param failed_count - 収集失敗件数（デフォルト: 0）\r\n * @param error_message - エラーメッセージ（failedの場合のみ）\r\n * @returns 更新後の実行状態\r\n *\r\n * @example\r\n * ```typescript\r\n * // 実行開始\r\n * await updateExecutionStatus('exec_001', 'pending', 0);\r\n *\r\n * // 進捗更新\r\n * await updateExecutionStatus('exec_001', 'running', 50, 25, 0);\r\n *\r\n * // 完了\r\n * await updateExecutionStatus('exec_001', 'completed', 100, 50, 0);\r\n *\r\n * // 失敗\r\n * await updateExecutionStatus('exec_001', 'failed', 50, 25, 5, 'Network error');\r\n * ```\r\n */\r\nexport async function updateExecutionStatus(\r\n  execution_id: string,\r\n  status: ExecutionStatus['status'],\r\n  progress: number,\r\n  collected_count: number = 0,\r\n  failed_count: number = 0,\r\n  error_message?: string\r\n): Promise<ExecutionStatus> {\r\n  try {\r\n    // 進捗率を0-100の範囲に制限\r\n    const clampedProgress = Math.max(0, Math.min(100, progress));\r\n\r\n    const now = new Date().toISOString();\r\n    const isCompleted = status === 'completed' || status === 'failed';\r\n\r\n    // TTL: 30日後（Unix timestamp）\r\n    const ttl = isCompleted ? Math.floor(Date.now() / 1000) + 30 * 24 * 60 * 60 : undefined;\r\n\r\n    const item: ExecutionStatus = {\r\n      execution_id,\r\n      status,\r\n      progress: clampedProgress,\r\n      collected_count,\r\n      failed_count,\r\n      started_at: now,\r\n      updated_at: now,\r\n      ...(isCompleted ? { completed_at: now } : {}),\r\n      ...(error_message ? { error_message } : {}),\r\n      ...(ttl ? { ttl } : {}),\r\n    };\r\n\r\n    logger.info('Updating execution status', {\r\n      execution_id,\r\n      status,\r\n      progress: clampedProgress,\r\n      collected_count,\r\n      failed_count,\r\n    });\r\n\r\n    // DynamoDBに保存\r\n    await dynamoClient.send(\r\n      new PutItemCommand({\r\n        TableName: getDynamoExecutionsTable(),\r\n        Item: marshall(item, {\r\n          removeUndefinedValues: true,\r\n        }),\r\n      })\r\n    );\r\n\r\n    logger.info('Execution status updated successfully', {\r\n      execution_id,\r\n      status,\r\n      progress: clampedProgress,\r\n    });\r\n\r\n    return item;\r\n  } catch (error) {\r\n    logger.error('Failed to update execution status', {\r\n      execution_id,\r\n      status,\r\n      progress,\r\n      error_type: error instanceof Error ? error.constructor.name : 'Unknown',\r\n      error_message: error instanceof Error ? error.message : String(error),\r\n    });\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * 実行状態を取得\r\n *\r\n * @param execution_id - 実行ID\r\n * @returns 実行状態（存在しない場合はnull）\r\n *\r\n * @example\r\n * ```typescript\r\n * const status = await getExecutionStatus('exec_001');\r\n * if (status) {\r\n *   console.log(`Progress: ${status.progress}%`);\r\n * }\r\n * ```\r\n */\r\nexport async function getExecutionStatus(\r\n  execution_id: string\r\n): Promise<ExecutionStatus | null> {\r\n  try {\r\n    const { GetItemCommand } = await import('@aws-sdk/client-dynamodb');\r\n    const { unmarshall } = await import('@aws-sdk/util-dynamodb');\r\n\r\n    const result = await dynamoClient.send(\r\n      new GetItemCommand({\r\n        TableName: getDynamoExecutionsTable(),\r\n        Key: marshall({ execution_id }),\r\n      })\r\n    );\r\n\r\n    if (!result.Item) {\r\n      return null;\r\n    }\r\n\r\n    return unmarshall(result.Item) as ExecutionStatus;\r\n  } catch (error) {\r\n    logger.error('Failed to get execution status', {\r\n      execution_id,\r\n      error_type: error instanceof Error ? error.constructor.name : 'Unknown',\r\n      error_message: error instanceof Error ? error.message : String(error),\r\n    });\r\n    throw error;\r\n  }\r\n}\r\n"],"version":3}