{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\process-export.ts","mappings":";AAAA;;;;;;GAMG;;AAoBH,sCAwFC;AA1GD,+CAAgE;AAEhE,2DAAuD;AACvD,iDAA4C;AAC5C,iEAA4D;AAC5D,+DAA0D;AAE1D;;;;;;;;;;GAUG;AACI,KAAK,UAAU,aAAa,CACjC,SAAiB,EACjB,WAA8B;IAE9B,IAAI,CAAC;QACH,eAAM,CAAC,IAAI,CAAC,4BAA4B,EAAE;YACxC,SAAS;YACT,MAAM,EAAE,WAAW,CAAC,MAAM;YAC1B,MAAM,EAAE,WAAW,CAAC,MAAM;SAC3B,CAAC,CAAC;QAEH,+BAA+B;QAC/B,MAAM,IAAA,yCAAkB,EAAC,SAAS,EAAE,YAAY,EAAE,EAAE,CAAC,CAAC;QAEtD,QAAQ;QACR,eAAM,CAAC,IAAI,CAAC,sBAAsB,EAAE;YAClC,SAAS;YACT,MAAM,EAAE,WAAW,CAAC,MAAM;SAC3B,CAAC,CAAC;QAEH,MAAM,WAAW,GAAG,MAAM,IAAA,oCAAgB,EAAC,WAAW,CAAC,MAAM,CAAC,CAAC;QAE/D,eAAM,CAAC,IAAI,CAAC,kCAAkC,EAAE;YAC9C,SAAS;YACT,KAAK,EAAE,WAAW,CAAC,MAAM;SAC1B,CAAC,CAAC;QAEH,YAAY;QACZ,MAAM,IAAA,yCAAkB,EAAC,SAAS,EAAE,YAAY,EAAE,EAAE,CAAC,CAAC;QAEtD,aAAa;QACb,eAAM,CAAC,IAAI,CAAC,iBAAiB,EAAE;YAC7B,SAAS;YACT,MAAM,EAAE,WAAW,CAAC,MAAM;YAC1B,KAAK,EAAE,WAAW,CAAC,MAAM;SAC1B,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,MAAM,IAAA,yBAAU,EAAC,SAAS,EAAE,WAAW,EAAE,WAAW,CAAC,MAAM,CAAC,CAAC;QAE5E,eAAM,CAAC,IAAI,CAAC,6BAA6B,EAAE;YACzC,SAAS;YACT,MAAM;SACP,CAAC,CAAC;QAEH,YAAY;QACZ,MAAM,IAAA,yCAAkB,EAAC,SAAS,EAAE,YAAY,EAAE,EAAE,CAAC,CAAC;QAEtD,oBAAoB;QACpB,eAAM,CAAC,IAAI,CAAC,uBAAuB,EAAE;YACnC,SAAS;YACT,MAAM;SACP,CAAC,CAAC;QAEH,MAAM,YAAY,GAAG,MAAM,IAAA,uCAAiB,EAAC,MAAM,EAAE,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,CAAC,CAAC,CAAC,MAAM;QAE9E,eAAM,CAAC,IAAI,CAAC,mCAAmC,EAAE;YAC/C,SAAS;YACT,YAAY;SACb,CAAC,CAAC;QAEH,+BAA+B;QAC/B,MAAM,IAAA,yCAAkB,EAAC,SAAS,EAAE,WAAW,EAAE,GAAG,EAAE,MAAM,EAAE,YAAY,CAAC,CAAC;QAE5E,eAAM,CAAC,IAAI,CAAC,0CAA0C,EAAE;YACtD,SAAS;YACT,MAAM;YACN,YAAY;SACb,CAAC,CAAC;IACL,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,eAAM,CAAC,KAAK,CACV,0BAA0B,EAC1B,IAAA,2BAAkB,EAAC,KAAc,EAAE;YACjC,SAAS;SACV,CAAC,CACH,CAAC;QAEF,oBAAoB;QACpB,MAAM,IAAA,yCAAkB,EACtB,SAAS,EACT,QAAQ,EACR,CAAC,EACD,SAAS,EACT,SAAS,EACT,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CACvD,CAAC;QAEF,MAAM,KAAK,CAAC;IACd,CAAC;AACH,CAAC","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\process-export.ts"],"sourcesContent":["/**\r\n * エクスポート処理\r\n *\r\n * データ取得、進捗更新、S3へのエクスポート、署名付きURL生成を実行します。\r\n *\r\n * Requirements: 要件5.1, 5.4（エクスポート、進捗）\r\n */\r\n\r\nimport { logger, createErrorContext } from '../../utils/logger';\r\nimport { ExportRequestBody } from './types';\r\nimport { queryDisclosures } from './query-disclosures';\r\nimport { exportToS3 } from './export-to-s3';\r\nimport { updateExportStatus } from './update-export-status';\r\nimport { generateSignedUrl } from './generate-signed-url';\r\n\r\n/**\r\n * エクスポート処理を実行\r\n *\r\n * 1. データ取得（queryDisclosures使用）\r\n * 2. 進捗更新（10%、50%、90%、100%）\r\n * 3. S3へのエクスポート\r\n * 4. 署名付きURL生成（有効期限7日）\r\n *\r\n * @param export_id エクスポートID\r\n * @param requestBody エクスポートリクエストボディ\r\n */\r\nexport async function processExport(\r\n  export_id: string,\r\n  requestBody: ExportRequestBody\r\n): Promise<void> {\r\n  try {\r\n    logger.info('Starting export processing', {\r\n      export_id,\r\n      format: requestBody.format,\r\n      filter: requestBody.filter,\r\n    });\r\n\r\n    // ステータスを processing に更新（進捗10%）\r\n    await updateExportStatus(export_id, 'processing', 10);\r\n\r\n    // データ取得\r\n    logger.info('Querying disclosures', {\r\n      export_id,\r\n      filter: requestBody.filter,\r\n    });\r\n\r\n    const disclosures = await queryDisclosures(requestBody.filter);\r\n\r\n    logger.info('Disclosures queried successfully', {\r\n      export_id,\r\n      count: disclosures.length,\r\n    });\r\n\r\n    // 進捗更新（50%）\r\n    await updateExportStatus(export_id, 'processing', 50);\r\n\r\n    // S3へのエクスポート\r\n    logger.info('Exporting to S3', {\r\n      export_id,\r\n      format: requestBody.format,\r\n      count: disclosures.length,\r\n    });\r\n\r\n    const s3_key = await exportToS3(export_id, disclosures, requestBody.format);\r\n\r\n    logger.info('Exported to S3 successfully', {\r\n      export_id,\r\n      s3_key,\r\n    });\r\n\r\n    // 進捗更新（90%）\r\n    await updateExportStatus(export_id, 'processing', 90);\r\n\r\n    // 署名付きURL生成（有効期限7日）\r\n    logger.info('Generating signed URL', {\r\n      export_id,\r\n      s3_key,\r\n    });\r\n\r\n    const download_url = await generateSignedUrl(s3_key, 7 * 24 * 60 * 60); // 7日間\r\n\r\n    logger.info('Signed URL generated successfully', {\r\n      export_id,\r\n      download_url,\r\n    });\r\n\r\n    // ステータスを completed に更新（進捗100%）\r\n    await updateExportStatus(export_id, 'completed', 100, s3_key, download_url);\r\n\r\n    logger.info('Export processing completed successfully', {\r\n      export_id,\r\n      s3_key,\r\n      download_url,\r\n    });\r\n  } catch (error) {\r\n    logger.error(\r\n      'Export processing failed',\r\n      createErrorContext(error as Error, {\r\n        export_id,\r\n      })\r\n    );\r\n\r\n    // ステータスを failed に更新\r\n    await updateExportStatus(\r\n      export_id,\r\n      'failed',\r\n      0,\r\n      undefined,\r\n      undefined,\r\n      error instanceof Error ? error.message : String(error)\r\n    );\r\n\r\n    throw error;\r\n  }\r\n}\r\n"],"version":3}