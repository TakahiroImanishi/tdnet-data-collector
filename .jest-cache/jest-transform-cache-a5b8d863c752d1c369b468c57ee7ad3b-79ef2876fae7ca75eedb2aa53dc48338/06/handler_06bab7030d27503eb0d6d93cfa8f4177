23f0ca2db82e37a53db6e72031fde802
"use strict";
/**
 * Lambda Query Handler
 *
 * TDnet開示情報を検索するLambda関数のメインハンドラー。
 * API Gateway統合により、RESTful APIとして公開されます。
 *
 * Requirements: 要件4.1, 4.3, 4.4, 5.2, 11.1（検索API、認証、PDFダウンロード、CSV形式）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const logger_1 = require("../../utils/logger");
const cloudwatch_metrics_1 = require("../../utils/cloudwatch-metrics");
const errors_1 = require("../../errors");
const query_disclosures_1 = require("./query-disclosures");
const format_csv_1 = require("./format-csv");
/**
 * Lambda Queryハンドラー
 *
 * @param event API Gateway Proxy Event
 * @param context Lambda Context
 * @returns API Gateway Proxy Result
 *
 * @example
 * ```typescript
 * // 企業コードで検索
 * GET /disclosures?company_code=7203
 *
 * // 日付範囲で検索
 * GET /disclosures?start_date=2024-01-15&end_date=2024-01-20
 *
 * // CSV形式で取得
 * GET /disclosures?format=csv&start_date=2024-01-15&end_date=2024-01-20
 * ```
 */
async function handler(event, context) {
    const startTime = Date.now();
    try {
        logger_1.logger.info('Lambda Query started', {
            queryStringParameters: event.queryStringParameters,
            request_id: context.awsRequestId,
            function_name: context.functionName,
        });
        // APIキー認証の検証
        validateApiKey(event);
        // クエリパラメータのパース
        const params = parseQueryParameters(event);
        // 開示情報を検索
        const result = await (0, query_disclosures_1.queryDisclosures)(params);
        const duration = Date.now() - startTime;
        logger_1.logger.info('Lambda Query completed', {
            request_id: context.awsRequestId,
            count: result.count,
            duration_ms: duration,
        });
        // 成功メトリクス送信
        await (0, cloudwatch_metrics_1.sendMetrics)([
            {
                name: 'LambdaExecutionTime',
                value: duration,
                unit: 'Milliseconds',
                dimensions: { FunctionName: 'Query' },
            },
            {
                name: 'QueryResultCount',
                value: result.count,
                unit: 'Count',
                dimensions: { Format: params.format },
            },
        ]);
        // フォーマット別レスポンス
        if (params.format === 'csv') {
            const csv = (0, format_csv_1.formatAsCsv)(result.disclosures);
            return {
                statusCode: 200,
                headers: {
                    'Content-Type': 'text/csv',
                    'Content-Disposition': `attachment; filename="disclosures-${Date.now()}.csv"`,
                    'Access-Control-Allow-Origin': '*',
                },
                body: csv,
            };
        }
        // JSON形式（デフォルト）
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify(result),
        };
    }
    catch (error) {
        const duration = Date.now() - startTime;
        logger_1.logger.error('Lambda Query failed', (0, logger_1.createErrorContext)(error, {
            request_id: context.awsRequestId,
            duration_ms: duration,
        }));
        // エラーメトリクス送信
        await (0, cloudwatch_metrics_1.sendErrorMetric)(error instanceof Error ? error.constructor.name : 'Unknown', 'Query');
        return handleError(error, context.awsRequestId);
    }
}
/**
 * 認証エラークラス
 */
class UnauthorizedError extends Error {
    constructor(message) {
        super(message);
        this.name = 'UnauthorizedError';
    }
}
/**
 * APIキー認証の検証
 *
 * @param event API Gateway Proxy Event
 * @throws UnauthorizedError APIキーが無効な場合
 */
function validateApiKey(event) {
    const apiKey = event.headers['x-api-key'] || event.headers['X-Api-Key'];
    if (!apiKey) {
        throw new UnauthorizedError('API key is required. Please provide x-api-key header.');
    }
    // APIキーの検証（実際の実装ではSecrets Managerから取得した値と比較）
    // ここでは環境変数から取得した値と比較
    const validApiKey = process.env.API_KEY;
    if (!validApiKey) {
        logger_1.logger.error('API_KEY environment variable is not set');
        throw new Error('API key validation is not configured');
    }
    if (apiKey !== validApiKey) {
        throw new UnauthorizedError('Invalid API key');
    }
}
/**
 * クエリパラメータのパース
 *
 * @param event API Gateway Proxy Event
 * @returns パース済みクエリパラメータ
 * @throws ValidationError バリデーションエラー
 */
function parseQueryParameters(event) {
    const params = event.queryStringParameters || {};
    // フォーマットのバリデーション
    const format = (params.format || 'json');
    if (!['json', 'csv'].includes(format)) {
        throw new errors_1.ValidationError(`Invalid format: ${format}. Expected 'json' or 'csv'.`);
    }
    // リミットのバリデーション（デフォルト: 100、最大: 1000）
    let limit = 100;
    if (params.limit) {
        limit = parseInt(params.limit, 10);
        if (isNaN(limit) || limit < 1 || limit > 1000) {
            throw new errors_1.ValidationError(`Invalid limit: ${params.limit}. Expected a number between 1 and 1000.`);
        }
    }
    // オフセットのバリデーション（デフォルト: 0）
    let offset = 0;
    if (params.offset) {
        offset = parseInt(params.offset, 10);
        if (isNaN(offset) || offset < 0) {
            throw new errors_1.ValidationError(`Invalid offset: ${params.offset}. Expected a non-negative number.`);
        }
    }
    // 日付フォーマットのバリデーション
    if (params.start_date) {
        validateDateFormat(params.start_date, 'start_date');
    }
    if (params.end_date) {
        validateDateFormat(params.end_date, 'end_date');
    }
    // 日付範囲の順序性チェック（Property 8）
    if (params.start_date && params.end_date) {
        const startDate = new Date(params.start_date);
        const endDate = new Date(params.end_date);
        if (startDate > endDate) {
            throw new errors_1.ValidationError(`start_date (${params.start_date}) must be before or equal to end_date (${params.end_date})`);
        }
    }
    // 企業コードのバリデーション（4桁の数字）
    if (params.company_code) {
        const companyCodeRegex = /^\d{4}$/;
        if (!companyCodeRegex.test(params.company_code)) {
            throw new errors_1.ValidationError(`Invalid company_code: ${params.company_code}. Expected 4-digit number.`);
        }
    }
    return {
        company_code: params.company_code,
        start_date: params.start_date,
        end_date: params.end_date,
        disclosure_type: params.disclosure_type,
        format,
        limit,
        offset,
    };
}
/**
 * 日付フォーマットのバリデーション
 *
 * @param date 日付文字列（YYYY-MM-DD）
 * @param fieldName フィールド名
 * @throws ValidationError バリデーションエラー
 */
function validateDateFormat(date, fieldName) {
    // YYYY-MM-DD形式のチェック
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateRegex.test(date)) {
        throw new errors_1.ValidationError(`Invalid ${fieldName} format: ${date}. Expected YYYY-MM-DD format.`);
    }
    // 有効な日付かチェック
    const parsedDate = new Date(date);
    if (isNaN(parsedDate.getTime())) {
        throw new errors_1.ValidationError(`Invalid ${fieldName}: ${date}. Date does not exist.`);
    }
}
/**
 * エラーハンドリング
 *
 * カスタムエラーを適切なHTTPステータスコードとエラーコードに変換します。
 *
 * @param error エラーオブジェクト
 * @param requestId リクエストID
 * @returns API Gateway Proxy Result
 */
function handleError(error, requestId) {
    // エラー種別に応じたステータスコードとエラーコード
    let statusCode = 500;
    let errorCode = 'INTERNAL_ERROR';
    if (error instanceof errors_1.ValidationError) {
        statusCode = 400;
        errorCode = 'VALIDATION_ERROR';
    }
    else if (error instanceof errors_1.NotFoundError) {
        statusCode = 404;
        errorCode = 'NOT_FOUND';
    }
    else if (error instanceof UnauthorizedError) {
        statusCode = 401;
        errorCode = 'UNAUTHORIZED';
    }
    else if (error.message.includes('API key')) {
        statusCode = 401;
        errorCode = 'UNAUTHORIZED';
    }
    // センシティブ情報を除外したエラーレスポンス
    const errorResponse = {
        error_code: errorCode,
        message: error.message,
        request_id: requestId,
    };
    // 本番環境ではスタックトレースを含めない
    if (process.env.NODE_ENV !== 'production') {
        errorResponse.stack = error.stack;
    }
    return {
        statusCode,
        headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
        },
        body: JSON.stringify(errorResponse),
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXHF1ZXJ5XFxoYW5kbGVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7OztHQU9HOztBQWdFSCwwQkF3RkM7QUFySkQsK0NBQWdFO0FBQ2hFLHVFQUE4RTtBQUM5RSx5Q0FBOEQ7QUFDOUQsMkRBQXVEO0FBQ3ZELDZDQUEyQztBQXNDM0M7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWtCRztBQUNJLEtBQUssVUFBVSxPQUFPLENBQzNCLEtBQWlCLEVBQ2pCLE9BQWdCO0lBRWhCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUU3QixJQUFJLENBQUM7UUFDSCxlQUFNLENBQUMsSUFBSSxDQUFDLHNCQUFzQixFQUFFO1lBQ2xDLHFCQUFxQixFQUFFLEtBQUssQ0FBQyxxQkFBcUI7WUFDbEQsVUFBVSxFQUFFLE9BQU8sQ0FBQyxZQUFZO1lBQ2hDLGFBQWEsRUFBRSxPQUFPLENBQUMsWUFBWTtTQUNwQyxDQUFDLENBQUM7UUFFSCxhQUFhO1FBQ2IsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXRCLGVBQWU7UUFDZixNQUFNLE1BQU0sR0FBRyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUUzQyxVQUFVO1FBQ1YsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFBLG9DQUFnQixFQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTlDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxTQUFTLENBQUM7UUFFeEMsZUFBTSxDQUFDLElBQUksQ0FBQyx3QkFBd0IsRUFBRTtZQUNwQyxVQUFVLEVBQUUsT0FBTyxDQUFDLFlBQVk7WUFDaEMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLO1lBQ25CLFdBQVcsRUFBRSxRQUFRO1NBQ3RCLENBQUMsQ0FBQztRQUVILFlBQVk7UUFDWixNQUFNLElBQUEsZ0NBQVcsRUFBQztZQUNoQjtnQkFDRSxJQUFJLEVBQUUscUJB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UUFDOUMsVUFBVSxHQUFHLEdBQUcsQ0FBQztRQUNqQixTQUFTLEdBQUcsY0FBYyxDQUFDO0lBQzdCLENBQUM7U0FBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7UUFDN0MsVUFBVSxHQUFHLEdBQUcsQ0FBQztRQUNqQixTQUFTLEdBQUcsY0FBYyxDQUFDO0lBQzdCLENBQUM7SUFFRCx3QkFBd0I7SUFDeEIsTUFBTSxhQUFhLEdBQUc7UUFDcEIsVUFBVSxFQUFFLFNBQVM7UUFDckIsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO1FBQ3RCLFVBQVUsRUFBRSxTQUFTO0tBQ3RCLENBQUM7SUFFRixzQkFBc0I7SUFDdEIsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxZQUFZLEVBQUUsQ0FBQztRQUN6QyxhQUFxQixDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDO0lBQzdDLENBQUM7SUFFRCxPQUFPO1FBQ0wsVUFBVTtRQUNWLE9BQU8sRUFBRTtZQUNQLGNBQWMsRUFBRSxrQkFBa0I7WUFDbEMsNkJBQTZCLEVBQUUsR0FBRztTQUNuQztRQUNELElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQztLQUNwQyxDQUFDO0FBQ0osQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpMTk4XFxpbnZlc3RtZW50X2FuYWx5c2lzX29wb3BvXFxzcmNcXGxhbWJkYVxccXVlcnlcXGhhbmRsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIExhbWJkYSBRdWVyeSBIYW5kbGVyXHJcbiAqXHJcbiAqIFREbmV06ZaL56S65oOF5aCx44KS5qSc57Si44GZ44KLTGFtYmRh6Zai5pWw44Gu44Oh44Kk44Oz44OP44Oz44OJ44Op44O844CCXHJcbiAqIEFQSSBHYXRld2F557Wx5ZCI44Gr44KI44KK44CBUkVTVGZ1bCBBUEnjgajjgZfjgablhazplovjgZXjgozjgb7jgZnjgIJcclxuICpcclxuICogUmVxdWlyZW1lbnRzOiDopoHku7Y0LjEsIDQuMywgNC40LCA1LjIsIDExLjHvvIjmpJzntKJBUEnjgIHoqo3oqLzjgIFQREbjg4Djgqbjg7Pjg63jg7zjg4njgIFDU1blvaLlvI/vvIlcclxuICovXHJcblxyXG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0LCBDb250ZXh0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XHJcbmltcG9ydCB7IGxvZ2dlciwgY3JlYXRlRXJyb3JDb250ZXh0IH0gZnJvbSAnLi4vLi4vdXRpbHMvbG9nZ2VyJztcclxuaW1wb3J0IHsgc2VuZEVycm9yTWV0cmljLCBzZW5kTWV0cmljcyB9IGZyb20gJy4uLy4uL3V0aWxzL2Nsb3Vkd2F0Y2gtbWV0cmljcyc7XHJcbmltcG9ydCB7IFZhbGlkYXRpb25FcnJvciwgTm90Rm91bmRFcnJvciB9IGZyb20gJy4uLy4uL2Vycm9ycyc7XHJcbmltcG9ydCB7IHF1ZXJ5RGlzY2xvc3VyZXMgfSBmcm9tICcuL3F1ZXJ5LWRpc2Nsb3N1cmVzJztcclxuaW1wb3J0IHsgZm9ybWF0QXNDc3YgfSBmcm9tICcuL2Zvcm1hdC1jc3YnO1xyXG5pbXBvcnQgeyBEaXNjbG9zdXJlIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xyXG5cclxuLyoqXHJcbiAqIExhbWJkYSBRdWVyeeOCpOODmeODs+ODiO+8iEFQSSBHYXRld2F557Wx5ZCI77yJXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIFF1ZXJ5RXZlbnQgZXh0ZW5kcyBBUElHYXRld2F5UHJveHlFdmVudCB7XHJcbiAgcXVlcnlTdHJpbmdQYXJhbWV0ZXJzOiB7XHJcbiAgICBjb21wYW55X2NvZGU/OiBzdHJpbmc7XHJcbiAgICBzdGFydF9kYXRlPzogc3RyaW5nO1xyXG4gICAgZW5kX2RhdGU/OiBzdHJpbmc7XHJcbiAgICBkaXNjbG9zdXJlX3R5cGU/OiBzdHJpbmc7XHJcbiAgICBmb3JtYXQ/OiAnanNvbicgfCAnY3N2JztcclxuICAgIGxpbWl0Pzogc3RyaW5nO1xyXG4gICAgb2Zmc2V0Pzogc3RyaW5nO1xyXG4gIH0gfCBudWxsO1xyXG59XHJcblxyXG4vKipcclxuICog44Kv44Ko44Oq44Os44K544Od44Oz44K5XHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIFF1ZXJ5UmVzcG9uc2Uge1xyXG4gIC8qKiDmpJzntKLntZDmnpwgKi9cclxuICBkaXNjbG9zdXJlczogRGlzY2xvc3VyZVtdO1xyXG5cclxuICAvKiog57eP5Lu25pWwICovXHJcbiAgdG90YWw6IG51bWJlcjtcclxuXHJcbiAgLyoqIOWPluW+l+S7tuaVsCAqL1xyXG4gIGNvdW50OiBudW1iZXI7XHJcblxyXG4gIC8qKiDjgqrjg5Xjgrvjg4Pjg4ggKi9cclxuICBvZmZzZXQ6IG51bWJlcjtcclxuXHJcbiAgLyoqIOODquODn+ODg+ODiCAqL1xyXG4gIGxpbWl0OiBudW1iZXI7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBMYW1iZGEgUXVlcnnjg4/jg7Pjg4njg6njg7xcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEFQSSBHYXRld2F5IFByb3h5IEV2ZW50XHJcbiAqIEBwYXJhbSBjb250ZXh0IExhbWJkYSBDb250ZXh0XHJcbiAqIEByZXR1cm5zIEFQSSBHYXRld2F5IFByb3h5IFJlc3VsdFxyXG4gKlxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGB0eXBlc2NyaXB0XHJcbiAqIC8vIOS8gealreOCs+ODvOODieOBp+aknOe0olxyXG4gKiBHRVQgL2Rpc2Nsb3N1cmVzP2NvbXBhbnlfY29kZT03MjAzXHJcbiAqXHJcbiAqIC8vIOaXpeS7mOevhOWbsuOBp+aknOe0olxyXG4gKiBHRVQgL2Rpc2Nsb3N1cmVzP3N0YXJ0X2RhdGU9MjAyNC0wMS0xNSZlbmRfZGF0ZT0yMDI0LTAxLTIwXHJcbiAqXHJcbiAqIC8vIENTVuW9ouW8j+OBp+WPluW+l1xyXG4gKiBHRVQgL2Rpc2Nsb3N1cmVzP2Zvcm1hdD1jc3Ymc3RhcnRfZGF0ZT0yMDI0LTAxLTE1JmVuZF9kYXRlPTIwMjQtMDEtMjBcclxuICogYGBgXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaGFuZGxlcihcclxuICBldmVudDogUXVlcnlFdmVudCxcclxuICBjb250ZXh0OiBDb250ZXh0XHJcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XHJcbiAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcclxuXHJcbiAgdHJ5IHtcclxuICAgIGxvZ2dlci5pbmZvKCdMYW1iZGEgUXVlcnkgc3RhcnRlZCcsIHtcclxuICAgICAgcXVlcnlTdHJpbmdQYXJhbWV0ZXJzOiBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMsXHJcbiAgICAgIHJlcXVlc3RfaWQ6IGNvbnRleHQuYXdzUmVxdWVzdElkLFxyXG4gICAgICBmdW5jdGlvbl9uYW1lOiBjb250ZXh0LmZ1bmN0aW9uTmFtZSxcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIEFQSeOCreODvOiqjeiovOOBruaknOiovFxyXG4gICAgdmFsaWRhdGVBcGlLZXkoZXZlbnQpO1xyXG5cclxuICAgIC8vIOOCr+OCqOODquODkeODqeODoeODvOOCv+OBruODkeODvOOCuVxyXG4gICAgY29uc3QgcGFyYW1zID0gcGFyc2VRdWVyeVBhcmFtZXRlcnMoZXZlbnQpO1xyXG5cclxuICAgIC8vIOmWi+ekuuaDheWgseOCkuaknOe0olxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcXVlcnlEaXNjbG9zdXJlcyhwYXJhbXMpO1xyXG5cclxuICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcclxuXHJcbiAgICBsb2dnZXIuaW5mbygnTGFtYmRhIFF1ZXJ5IGNvbXBsZXRlZCcsIHtcclxuICAgICAgcmVxdWVzdF9pZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXHJcbiAgICAgIGNvdW50OiByZXN1bHQuY291bnQsXHJcbiAgICAgIGR1cmF0aW9uX21zOiBkdXJhdGlvbixcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOaIkOWKn+ODoeODiOODquOCr+OCuemAgeS/oVxyXG4gICAgYXdhaXQgc2VuZE1ldHJpY3MoW1xyXG4gICAgICB7XHJcbiAgICAgICAgbmFtZTogJ0xhbWJkYUV4ZWN1dGlvblRpbWUnLFxyXG4gICAgICAgIHZhbHVlOiBkdXJhdGlvbixcclxuICAgICAgICB1bml0OiAnTWlsbGlzZWNvbmRzJyxcclxuICAgICAgICBkaW1lbnNpb25zOiB7IEZ1bmN0aW9uTmFtZTogJ1F1ZXJ5JyB9LFxyXG4gICAgICB9LFxyXG4gICAgICB7XHJcbiAgICAgICAgbmFtZTogJ1F1ZXJ5UmVzdWx0Q291bnQnLFxyXG4gICAgICAgIHZhbHVlOiByZXN1bHQuY291bnQsXHJcbiAgICAgICAgdW5pdDogJ0NvdW50JyxcclxuICAgICAgICBkaW1lbnNpb25zOiB7IEZvcm1hdDogcGFyYW1zLmZvcm1hdCB9LFxyXG4gICAgICB9LFxyXG4gICAgXSk7XHJcblxyXG4gICAgLy8g44OV44Kp44O844Oe44OD44OI5Yil44Os44K544Od44Oz44K5XHJcbiAgICBpZiAocGFyYW1zLmZvcm1hdCA9PT0gJ2NzdicpIHtcclxuICAgICAgY29uc3QgY3N2ID0gZm9ybWF0QXNDc3YocmVzdWx0LmRpc2Nsb3N1cmVzKTtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdGF0dXNDb2RlOiAyMDAsXHJcbiAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICd0ZXh0L2NzdicsXHJcbiAgICAgICAgICAnQ29udGVudC1EaXNwb3NpdGlvbic6IGBhdHRhY2htZW50OyBmaWxlbmFtZT1cImRpc2Nsb3N1cmVzLSR7RGF0ZS5ub3coKX0uY3N2XCJgLFxyXG4gICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGJvZHk6IGNzdixcclxuICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBKU09O5b2i5byP77yI44OH44OV44Kp44Or44OI77yJXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXHJcbiAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXHJcbiAgICAgIH0sXHJcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHJlc3VsdCksXHJcbiAgICB9O1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XHJcblxyXG4gICAgbG9nZ2VyLmVycm9yKFxyXG4gICAgICAnTGFtYmRhIFF1ZXJ5IGZhaWxlZCcsXHJcbiAgICAgIGNyZWF0ZUVycm9yQ29udGV4dChlcnJvciBhcyBFcnJvciwge1xyXG4gICAgICAgIHJlcXVlc3RfaWQ6IGNvbnRleHQuYXdzUmVxdWVzdElkLFxyXG4gICAgICAgIGR1cmF0aW9uX21zOiBkdXJhdGlvbixcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gICAgLy8g44Ko44Op44O844Oh44OI44Oq44Kv44K56YCB5L+hXHJcbiAgICBhd2FpdCBzZW5kRXJyb3JNZXRyaWMoXHJcbiAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5jb25zdHJ1Y3Rvci5uYW1lIDogJ1Vua25vd24nLFxyXG4gICAgICAnUXVlcnknXHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiBoYW5kbGVFcnJvcihlcnJvciBhcyBFcnJvciwgY29udGV4dC5hd3NSZXF1ZXN0SWQpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOiqjeiovOOCqOODqeODvOOCr+ODqeOCuVxyXG4gKi9cclxuY2xhc3MgVW5hdXRob3JpemVkRXJyb3IgZXh0ZW5kcyBFcnJvciB7XHJcbiAgY29uc3RydWN0b3IobWVzc2FnZTogc3RyaW5nKSB7XHJcbiAgICBzdXBlcihtZXNzYWdlKTtcclxuICAgIHRoaXMubmFtZSA9ICdVbmF1dGhvcml6ZWRFcnJvcic7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogQVBJ44Kt44O86KqN6Ki844Gu5qSc6Ki8XHJcbiAqXHJcbiAqIEBwYXJhbSBldmVudCBBUEkgR2F0ZXdheSBQcm94eSBFdmVudFxyXG4gKiBAdGhyb3dzIFVuYXV0aG9yaXplZEVycm9yIEFQSeOCreODvOOBjOeEoeWKueOBquWgtOWQiFxyXG4gKi9cclxuZnVuY3Rpb24gdmFsaWRhdGVBcGlLZXkoZXZlbnQ6IFF1ZXJ5RXZlbnQpOiB2b2lkIHtcclxuICBjb25zdCBhcGlLZXkgPSBldmVudC5oZWFkZXJzWyd4LWFwaS1rZXknXSB8fCBldmVudC5oZWFkZXJzWydYLUFwaS1LZXknXTtcclxuXHJcbiAgaWYgKCFhcGlLZXkpIHtcclxuICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFcnJvcignQVBJIGtleSBpcyByZXF1aXJlZC4gUGxlYXNlIHByb3ZpZGUgeC1hcGkta2V5IGhlYWRlci4nKTtcclxuICB9XHJcblxyXG4gIC8vIEFQSeOCreODvOOBruaknOiovO+8iOWun+mam+OBruWun+ijheOBp+OBr1NlY3JldHMgTWFuYWdlcuOBi+OCieWPluW+l+OBl+OBn+WApOOBqOavlOi8g++8iVxyXG4gIC8vIOOBk+OBk+OBp+OBr+eSsOWig+WkieaVsOOBi+OCieWPluW+l+OBl+OBn+WApOOBqOavlOi8g1xyXG4gIGNvbnN0IHZhbGlkQXBpS2V5ID0gcHJvY2Vzcy5lbnYuQVBJX0tFWTtcclxuXHJcbiAgaWYgKCF2YWxpZEFwaUtleSkge1xyXG4gICAgbG9nZ2VyLmVycm9yKCdBUElfS0VZIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIG5vdCBzZXQnKTtcclxuICAgIHRocm93IG5ldyBFcnJvcignQVBJIGtleSB2YWxpZGF0aW9uIGlzIG5vdCBjb25maWd1cmVkJyk7XHJcbiAgfVxyXG5cclxuICBpZiAoYXBpS2V5ICE9PSB2YWxpZEFwaUtleSkge1xyXG4gICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEVycm9yKCdJbnZhbGlkIEFQSSBrZXknKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgq/jgqjjg6rjg5Hjg6njg6Hjg7zjgr/jga7jg5Hjg7zjgrlcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEFQSSBHYXRld2F5IFByb3h5IEV2ZW50XHJcbiAqIEByZXR1cm5zIOODkeODvOOCuea4iOOBv+OCr+OCqOODquODkeODqeODoeODvOOCv1xyXG4gKiBAdGhyb3dzIFZhbGlkYXRpb25FcnJvciDjg5Djg6rjg4fjg7zjgrfjg6fjg7Pjgqjjg6njg7xcclxuICovXHJcbmZ1bmN0aW9uIHBhcnNlUXVlcnlQYXJhbWV0ZXJzKGV2ZW50OiBRdWVyeUV2ZW50KToge1xyXG4gIGNvbXBhbnlfY29kZT86IHN0cmluZztcclxuICBzdGFydF9kYXRlPzogc3RyaW5nO1xyXG4gIGVuZF9kYXRlPzogc3RyaW5nO1xyXG4gIGRpc2Nsb3N1cmVfdHlwZT86IHN0cmluZztcclxuICBmb3JtYXQ6ICdqc29uJyB8ICdjc3YnO1xyXG4gIGxpbWl0OiBudW1iZXI7XHJcbiAgb2Zmc2V0OiBudW1iZXI7XHJcbn0ge1xyXG4gIGNvbnN0IHBhcmFtcyA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyB8fCB7fTtcclxuXHJcbiAgLy8g44OV44Kp44O844Oe44OD44OI44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAgY29uc3QgZm9ybWF0ID0gKHBhcmFtcy5mb3JtYXQgfHwgJ2pzb24nKSBhcyAnanNvbicgfCAnY3N2JztcclxuICBpZiAoIVsnanNvbicsICdjc3YnXS5pbmNsdWRlcyhmb3JtYXQpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCBmb3JtYXQ6ICR7Zm9ybWF0fS4gRXhwZWN0ZWQgJ2pzb24nIG9yICdjc3YnLmBcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvLyDjg6rjg5/jg4Pjg4jjga7jg5Djg6rjg4fjg7zjgrfjg6fjg7PvvIjjg4fjg5Xjgqnjg6vjg4g6IDEwMOOAgeacgOWkpzogMTAwMO+8iVxyXG4gIGxldCBsaW1pdCA9IDEwMDtcclxuICBpZiAocGFyYW1zLmxpbWl0KSB7XHJcbiAgICBsaW1pdCA9IHBhcnNlSW50KHBhcmFtcy5saW1pdCwgMTApO1xyXG4gICAgaWYgKGlzTmFOKGxpbWl0KSB8fCBsaW1pdCA8IDEgfHwgbGltaXQgPiAxMDAwKSB7XHJcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgICAgYEludmFsaWQgbGltaXQ6ICR7cGFyYW1zLmxpbWl0fS4gRXhwZWN0ZWQgYSBudW1iZXIgYmV0d2VlbiAxIGFuZCAxMDAwLmBcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOOCquODleOCu+ODg+ODiOOBruODkOODquODh+ODvOOCt+ODp+ODs++8iOODh+ODleOCqeODq+ODiDogMO+8iVxyXG4gIGxldCBvZmZzZXQgPSAwO1xyXG4gIGlmIChwYXJhbXMub2Zmc2V0KSB7XHJcbiAgICBvZmZzZXQgPSBwYXJzZUludChwYXJhbXMub2Zmc2V0LCAxMCk7XHJcbiAgICBpZiAoaXNOYU4ob2Zmc2V0KSB8fCBvZmZzZXQgPCAwKSB7XHJcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgICAgYEludmFsaWQgb2Zmc2V0OiAke3BhcmFtcy5vZmZzZXR9LiBFeHBlY3RlZCBhIG5vbi1uZWdhdGl2ZSBudW1iZXIuYFxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8g5pel5LuY44OV44Kp44O844Oe44OD44OI44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAgaWYgKHBhcmFtcy5zdGFydF9kYXRlKSB7XHJcbiAgICB2YWxpZGF0ZURhdGVGb3JtYXQocGFyYW1zLnN0YXJ0X2RhdGUsICdzdGFydF9kYXRlJyk7XHJcbiAgfVxyXG4gIGlmIChwYXJhbXMuZW5kX2RhdGUpIHtcclxuICAgIHZhbGlkYXRlRGF0ZUZvcm1hdChwYXJhbXMuZW5kX2RhdGUsICdlbmRfZGF0ZScpO1xyXG4gIH1cclxuXHJcbiAgLy8g5pel5LuY56+E5Zuy44Gu6aCG5bqP5oCn44OB44Kn44OD44Kv77yIUHJvcGVydHkgOO+8iVxyXG4gIGlmIChwYXJhbXMuc3RhcnRfZGF0ZSAmJiBwYXJhbXMuZW5kX2RhdGUpIHtcclxuICAgIGNvbnN0IHN0YXJ0RGF0ZSA9IG5ldyBEYXRlKHBhcmFtcy5zdGFydF9kYXRlKTtcclxuICAgIGNvbnN0IGVuZERhdGUgPSBuZXcgRGF0ZShwYXJhbXMuZW5kX2RhdGUpO1xyXG5cclxuICAgIGlmIChzdGFydERhdGUgPiBlbmREYXRlKSB7XHJcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgICAgYHN0YXJ0X2RhdGUgKCR7cGFyYW1zLnN0YXJ0X2RhdGV9KSBtdXN0IGJlIGJlZm9yZSBvciBlcXVhbCB0byBlbmRfZGF0ZSAoJHtwYXJhbXMuZW5kX2RhdGV9KWBcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOS8gealreOCs+ODvOODieOBruODkOODquODh+ODvOOCt+ODp+ODs++8iDTmoYHjga7mlbDlrZfvvIlcclxuICBpZiAocGFyYW1zLmNvbXBhbnlfY29kZSkge1xyXG4gICAgY29uc3QgY29tcGFueUNvZGVSZWdleCA9IC9eXFxkezR9JC87XHJcbiAgICBpZiAoIWNvbXBhbnlDb2RlUmVnZXgudGVzdChwYXJhbXMuY29tcGFueV9jb2RlKSkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICAgIGBJbnZhbGlkIGNvbXBhbnlfY29kZTogJHtwYXJhbXMuY29tcGFueV9jb2RlfS4gRXhwZWN0ZWQgNC1kaWdpdCBudW1iZXIuYFxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIGNvbXBhbnlfY29kZTogcGFyYW1zLmNvbXBhbnlfY29kZSxcclxuICAgIHN0YXJ0X2RhdGU6IHBhcmFtcy5zdGFydF9kYXRlLFxyXG4gICAgZW5kX2RhdGU6IHBhcmFtcy5lbmRfZGF0ZSxcclxuICAgIGRpc2Nsb3N1cmVfdHlwZTogcGFyYW1zLmRpc2Nsb3N1cmVfdHlwZSxcclxuICAgIGZvcm1hdCxcclxuICAgIGxpbWl0LFxyXG4gICAgb2Zmc2V0LFxyXG4gIH07XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDml6Xku5jjg5Xjgqnjg7zjg57jg4Pjg4jjga7jg5Djg6rjg4fjg7zjgrfjg6fjg7NcclxuICpcclxuICogQHBhcmFtIGRhdGUg5pel5LuY5paH5a2X5YiX77yIWVlZWS1NTS1ERO+8iVxyXG4gKiBAcGFyYW0gZmllbGROYW1lIOODleOCo+ODvOODq+ODieWQjVxyXG4gKiBAdGhyb3dzIFZhbGlkYXRpb25FcnJvciDjg5Djg6rjg4fjg7zjgrfjg6fjg7Pjgqjjg6njg7xcclxuICovXHJcbmZ1bmN0aW9uIHZhbGlkYXRlRGF0ZUZvcm1hdChkYXRlOiBzdHJpbmcsIGZpZWxkTmFtZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgLy8gWVlZWS1NTS1EROW9ouW8j+OBruODgeOCp+ODg+OCr1xyXG4gIGNvbnN0IGRhdGVSZWdleCA9IC9eXFxkezR9LVxcZHsyfS1cXGR7Mn0kLztcclxuICBpZiAoIWRhdGVSZWdleC50ZXN0KGRhdGUpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCAke2ZpZWxkTmFtZX0gZm9ybWF0OiAke2RhdGV9LiBFeHBlY3RlZCBZWVlZLU1NLUREIGZvcm1hdC5gXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8g5pyJ5Yq544Gq5pel5LuY44GL44OB44Kn44OD44KvXHJcbiAgY29uc3QgcGFyc2VkRGF0ZSA9IG5ldyBEYXRlKGRhdGUpO1xyXG4gIGlmIChpc05hTihwYXJzZWREYXRlLmdldFRpbWUoKSkpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgIGBJbnZhbGlkICR7ZmllbGROYW1lfTogJHtkYXRlfS4gRGF0ZSBkb2VzIG5vdCBleGlzdC5gXHJcbiAgICApO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOOCqOODqeODvOODj+ODs+ODieODquODs+OCsFxyXG4gKlxyXG4gKiDjgqvjgrnjgr/jg6Djgqjjg6njg7zjgpLpganliIfjgapIVFRQ44K544OG44O844K/44K544Kz44O844OJ44Go44Ko44Op44O844Kz44O844OJ44Gr5aSJ5o+b44GX44G+44GZ44CCXHJcbiAqXHJcbiAqIEBwYXJhbSBlcnJvciDjgqjjg6njg7zjgqrjg5bjgrjjgqfjgq/jg4hcclxuICogQHBhcmFtIHJlcXVlc3RJZCDjg6rjgq/jgqjjgrnjg4hJRFxyXG4gKiBAcmV0dXJucyBBUEkgR2F0ZXdheSBQcm94eSBSZXN1bHRcclxuICovXHJcbmZ1bmN0aW9uIGhhbmRsZUVycm9yKGVycm9yOiBFcnJvciwgcmVxdWVzdElkOiBzdHJpbmcpOiBBUElHYXRld2F5UHJveHlSZXN1bHQge1xyXG4gIC8vIOOCqOODqeODvOeoruWIpeOBq+W/nOOBmOOBn+OCueODhuODvOOCv+OCueOCs+ODvOODieOBqOOCqOODqeODvOOCs+ODvOODiVxyXG4gIGxldCBzdGF0dXNDb2RlID0gNTAwO1xyXG4gIGxldCBlcnJvckNvZGUgPSAnSU5URVJOQUxfRVJST1InO1xyXG5cclxuICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBWYWxpZGF0aW9uRXJyb3IpIHtcclxuICAgIHN0YXR1c0NvZGUgPSA0MDA7XHJcbiAgICBlcnJvckNvZGUgPSAnVkFMSURBVElPTl9FUlJPUic7XHJcbiAgfSBlbHNlIGlmIChlcnJvciBpbnN0YW5jZW9mIE5vdEZvdW5kRXJyb3IpIHtcclxuICAgIHN0YXR1c0NvZGUgPSA0MDQ7XHJcbiAgICBlcnJvckNvZGUgPSAnTk9UX0ZPVU5EJztcclxuICB9IGVsc2UgaWYgKGVycm9yIGluc3RhbmNlb2YgVW5hdXRob3JpemVkRXJyb3IpIHtcclxuICAgIHN0YXR1c0NvZGUgPSA0MDE7XHJcbiAgICBlcnJvckNvZGUgPSAnVU5BVVRIT1JJWkVEJztcclxuICB9IGVsc2UgaWYgKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ0FQSSBrZXknKSkge1xyXG4gICAgc3RhdHVzQ29kZSA9IDQwMTtcclxuICAgIGVycm9yQ29kZSA9ICdVTkFVVEhPUklaRUQnO1xyXG4gIH1cclxuXHJcbiAgLy8g44K744Oz44K344OG44Kj44OW5oOF5aCx44KS6Zmk5aSW44GX44Gf44Ko44Op44O844Os44K544Od44Oz44K5XHJcbiAgY29uc3QgZXJyb3JSZXNwb25zZSA9IHtcclxuICAgIGVycm9yX2NvZGU6IGVycm9yQ29kZSxcclxuICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXHJcbiAgICByZXF1ZXN0X2lkOiByZXF1ZXN0SWQsXHJcbiAgfTtcclxuXHJcbiAgLy8g5pys55Wq55Kw5aKD44Gn44Gv44K544K/44OD44Kv44OI44Os44O844K544KS5ZCr44KB44Gq44GEXHJcbiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHtcclxuICAgIChlcnJvclJlc3BvbnNlIGFzIGFueSkuc3RhY2sgPSBlcnJvci5zdGFjaztcclxuICB9XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBzdGF0dXNDb2RlLFxyXG4gICAgaGVhZGVyczoge1xyXG4gICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxyXG4gICAgfSxcclxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KGVycm9yUmVzcG9uc2UpLFxyXG4gIH07XHJcbn1cclxuIl0sInZlcnNpb24iOjN9