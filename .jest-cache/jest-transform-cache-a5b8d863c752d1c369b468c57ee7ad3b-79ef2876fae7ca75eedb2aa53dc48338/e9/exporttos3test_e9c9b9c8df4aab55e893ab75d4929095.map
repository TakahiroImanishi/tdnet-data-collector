{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\__tests__\\export-to-s3.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\__tests__\\export-to-s3.test.ts"],"sourcesContent":["/**\r\n * Export to S3 Unit Tests\r\n *\r\n * Requirements: 要件14.1（ユニットテスト）\r\n */\r\n\r\nimport { exportToS3 } from '../export-to-s3';\r\nimport { Disclosure } from '../../../types';\r\nimport { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';\r\n\r\n// モック\r\njest.mock('../../../utils/logger');\r\njest.mock('../../../utils/retry', () => ({\r\n  retryWithBackoff: jest.fn((fn) => fn()), // retryをバイパス\r\n}));\r\n\r\n// S3Clientのモック\r\nconst mockSend = jest.fn();\r\njest.mock('@aws-sdk/client-s3', () => {\r\n  const actualModule = jest.requireActual('@aws-sdk/client-s3');\r\n  return {\r\n    ...actualModule,\r\n    S3Client: jest.fn().mockImplementation(() => ({\r\n      send: mockSend,\r\n    })),\r\n  };\r\n});\r\n\r\ndescribe('exportToS3', () => {\r\n  const mockDisclosures: Disclosure[] = [\r\n    {\r\n      disclosure_id: '20240115_1234_001',\r\n      company_code: '1234',\r\n      company_name: 'テスト株式会社',\r\n      disclosure_type: '決算短信',\r\n      title: '2024年3月期 第3四半期決算短信',\r\n      disclosed_at: '2024-01-15T10:30:00Z',\r\n      pdf_url: 'https://example.com/pdf/20240115_1234_001.pdf',\r\n      s3_key: 'pdfs/2024/01/15/20240115_1234_001.pdf',\r\n      collected_at: '2024-01-15T10:35:00Z',\r\n      date_partition: '2024-01',\r\n    },\r\n    {\r\n      disclosure_id: '20240115_5678_001',\r\n      company_code: '5678',\r\n      company_name: 'サンプル株式会社',\r\n      disclosure_type: '有価証券報告書',\r\n      title: '第50期有価証券報告書',\r\n      disclosed_at: '2024-01-15T11:00:00Z',\r\n      pdf_url: 'https://example.com/pdf/20240115_5678_001.pdf',\r\n      s3_key: 'pdfs/2024/01/15/20240115_5678_001.pdf',\r\n      collected_at: '2024-01-15T11:05:00Z',\r\n      date_partition: '2024-01',\r\n    },\r\n  ];\r\n\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n    mockSend.mockClear();\r\n    mockSend.mockResolvedValue({\r\n      $metadata: { httpStatusCode: 200 },\r\n      ETag: '\"mock-etag\"',\r\n    });\r\n    \r\n    process.env.EXPORT_BUCKET_NAME = 'test-exports-bucket';\r\n    process.env.AWS_REGION = 'ap-northeast-1';\r\n  });\r\n\r\n  describe('JSON形式のエクスポート', () => {\r\n    it('JSON形式でS3にエクスポートできる', async () => {\r\n      // Arrange\r\n      const export_id = 'export_1705305600000_abc123_12345678';\r\n      const format = 'json';\r\n\r\n      // Act\r\n      const s3_key = await exportToS3(export_id, mockDisclosures, format);\r\n\r\n      // Assert\r\n      expect(s3_key).toMatch(/^exports\\/\\d{4}\\/\\d{2}\\/\\d{2}\\/export_\\d+_[a-z0-9]+_[a-z0-9]+\\.json$/);\r\n      \r\n      expect(mockSend).toHaveBeenCalledTimes(1);\r\n      \r\n      const command = mockSend.mock.calls[0][0] as PutObjectCommand;\r\n      expect(command.input.Bucket).toBe('test-exports-bucket');\r\n      expect(command.input.Key).toBe(s3_key);\r\n      expect(command.input.ContentType).toBe('application/json');\r\n      expect(command.input.Tagging).toBe('auto-delete=true');\r\n    });\r\n\r\n    it('JSONに件数とデータが含まれる', async () => {\r\n      // Arrange\r\n      const export_id = 'export_1705305600000_abc123_12345678';\r\n      const format = 'json';\r\n\r\n      // Act\r\n      await exportToS3(export_id, mockDisclosures, format);\r\n\r\n      // Assert\r\n      const command = mockSend.mock.calls[0][0] as PutObjectCommand;\r\n      const body = command.input.Body as string;\r\n      const parsed = JSON.parse(body);\r\n\r\n      expect(parsed).toHaveProperty('count', 2);\r\n      expect(parsed).toHaveProperty('disclosures');\r\n      expect(parsed.disclosures).toHaveLength(2);\r\n      expect(parsed.disclosures[0]).toEqual(mockDisclosures[0]);\r\n    });\r\n  });\r\n\r\n  describe('CSV形式のエクスポート', () => {\r\n    it('CSV形式でS3にエクスポートできる', async () => {\r\n      // Arrange\r\n      const export_id = 'export_1705305600000_def456_87654321';\r\n      const format = 'csv';\r\n\r\n      // Act\r\n      const s3_key = await exportToS3(export_id, mockDisclosures, format);\r\n\r\n      // Assert\r\n      expect(s3_key).toMatch(/^exports\\/\\d{4}\\/\\d{2}\\/\\d{2}\\/export_\\d+_[a-z0-9]+_[a-z0-9]+\\.csv$/);\r\n      \r\n      const command = mockSend.mock.calls[0][0] as PutObjectCommand;\r\n      expect(command.input.Bucket).toBe('test-exports-bucket');\r\n      expect(command.input.Key).toBe(s3_key);\r\n      expect(command.input.ContentType).toBe('text/csv');\r\n      expect(command.input.Tagging).toBe('auto-delete=true');\r\n    });\r\n\r\n    it('CSVヘッダーが正しく出力される', async () => {\r\n      // Arrange\r\n      const export_id = 'export_1705305600000_def456_87654321';\r\n      const format = 'csv';\r\n\r\n      // Act\r\n      await exportToS3(export_id, mockDisclosures, format);\r\n\r\n      // Assert\r\n      const command = mockSend.mock.calls[0][0] as PutObjectCommand;\r\n      const body = command.input.Body as string;\r\n      const lines = body.split('\\n');\r\n\r\n      expect(lines[0]).toBe(\r\n        'disclosure_id,company_code,company_name,disclosure_type,title,disclosed_at,pdf_url,s3_key,collected_at,date_partition'\r\n      );\r\n    });\r\n\r\n    it('CSVデータ行が正しく出力される', async () => {\r\n      // Arrange\r\n      const export_id = 'export_1705305600000_def456_87654321';\r\n      const format = 'csv';\r\n\r\n      // Act\r\n      await exportToS3(export_id, mockDisclosures, format);\r\n\r\n      // Assert\r\n      const command = mockSend.mock.calls[0][0] as PutObjectCommand;\r\n      const body = command.input.Body as string;\r\n      const lines = body.split('\\n');\r\n\r\n      expect(lines[1]).toBe(\r\n        '20240115_1234_001,1234,テスト株式会社,決算短信,2024年3月期 第3四半期決算短信,2024-01-15T10:30:00Z,https://example.com/pdf/20240115_1234_001.pdf,pdfs/2024/01/15/20240115_1234_001.pdf,2024-01-15T10:35:00Z,2024-01'\r\n      );\r\n      expect(lines[2]).toBe(\r\n        '20240115_5678_001,5678,サンプル株式会社,有価証券報告書,第50期有価証券報告書,2024-01-15T11:00:00Z,https://example.com/pdf/20240115_5678_001.pdf,pdfs/2024/01/15/20240115_5678_001.pdf,2024-01-15T11:05:00Z,2024-01'\r\n      );\r\n    });\r\n\r\n    it('カンマを含む値が正しくエスケープされる', async () => {\r\n      // Arrange\r\n      const disclosuresWithComma: Disclosure[] = [\r\n        {\r\n          ...mockDisclosures[0],\r\n          title: 'タイトル, カンマ含む',\r\n        },\r\n      ];\r\n      const export_id = 'export_1705305600000_ghi789_11111111';\r\n      const format = 'csv';\r\n\r\n      // Act\r\n      await exportToS3(export_id, disclosuresWithComma, format);\r\n\r\n      // Assert\r\n      const command = mockSend.mock.calls[0][0] as PutObjectCommand;\r\n      const body = command.input.Body as string;\r\n      const lines = body.split('\\n');\r\n\r\n      expect(lines[1]).toContain('\"タイトル, カンマ含む\"');\r\n    });\r\n\r\n    it('ダブルクォートを含む値が正しくエスケープされる', async () => {\r\n      // Arrange\r\n      const disclosuresWithQuote: Disclosure[] = [\r\n        {\r\n          ...mockDisclosures[0],\r\n          title: 'タイトル\"引用符\"含む',\r\n        },\r\n      ];\r\n      const export_id = 'export_1705305600000_jkl012_22222222';\r\n      const format = 'csv';\r\n\r\n      // Act\r\n      await exportToS3(export_id, disclosuresWithQuote, format);\r\n\r\n      // Assert\r\n      const command = mockSend.mock.calls[0][0] as PutObjectCommand;\r\n      const body = command.input.Body as string;\r\n      const lines = body.split('\\n');\r\n\r\n      expect(lines[1]).toContain('\"タイトル\"\"引用符\"\"含む\"');\r\n    });\r\n\r\n    it('改行を含む値が正しくエスケープされる', async () => {\r\n      // Arrange\r\n      const disclosuresWithNewline: Disclosure[] = [\r\n        {\r\n          ...mockDisclosures[0],\r\n          title: 'タイトル\\n改行含む',\r\n        },\r\n      ];\r\n      const export_id = 'export_1705305600000_mno345_33333333';\r\n      const format = 'csv';\r\n\r\n      // Act\r\n      await exportToS3(export_id, disclosuresWithNewline, format);\r\n\r\n      // Assert\r\n      const command = mockSend.mock.calls[0][0] as PutObjectCommand;\r\n      const body = command.input.Body as string;\r\n      const lines = body.split('\\n');\r\n\r\n      // 改行を含む値はダブルクォートで囲まれる\r\n      expect(lines[1]).toContain('\"タイトル\\n改行含む\"');\r\n    });\r\n  });\r\n\r\n  describe('S3キー生成', () => {\r\n    it('S3キーが正しいフォーマットで生成される', async () => {\r\n      // Arrange\r\n      const export_id = 'export_1705305600000_abc123_12345678';\r\n      const format = 'json';\r\n\r\n      // Act\r\n      const s3_key = await exportToS3(export_id, mockDisclosures, format);\r\n\r\n      // Assert\r\n      // フォーマット: exports/YYYY/MM/DD/export_id.format\r\n      expect(s3_key).toMatch(/^exports\\/\\d{4}\\/\\d{2}\\/\\d{2}\\/export_\\d+_[a-z0-9]+_[a-z0-9]+\\.json$/);\r\n    });\r\n  });\r\n\r\n  describe('ライフサイクルポリシー', () => {\r\n    it('auto-deleteタグが設定される', async () => {\r\n      // Arrange\r\n      const export_id = 'export_1705305600000_abc123_12345678';\r\n      const format = 'json';\r\n\r\n      // Act\r\n      await exportToS3(export_id, mockDisclosures, format);\r\n\r\n      // Assert\r\n      const command = mockSend.mock.calls[0][0] as PutObjectCommand;\r\n      expect(command.input.Tagging).toBe('auto-delete=true');\r\n    });\r\n  });\r\n});\r\n"],"version":3}