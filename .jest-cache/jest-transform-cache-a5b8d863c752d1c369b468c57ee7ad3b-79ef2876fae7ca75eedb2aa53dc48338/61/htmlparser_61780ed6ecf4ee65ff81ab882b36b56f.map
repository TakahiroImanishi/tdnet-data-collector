{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\scraper\\html-parser.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\scraper\\html-parser.ts"],"sourcesContent":["/**\r\n * TDnet HTMLパーサー\r\n *\r\n * TDnet開示情報リストページのHTMLをパースし、メタデータを抽出します。\r\n *\r\n * Requirements: 要件1.1, 1.2（データ収集、メタデータ抽出）\r\n * \r\n * @example\r\n * ```typescript\r\n * import { RateLimiter } from '../utils/rate-limiter';\r\n * import { parseDisclosureList } from './html-parser';\r\n * import axios from 'axios';\r\n * \r\n * // RateLimiterを使用してTDnetからHTMLを取得\r\n * const rateLimiter = new RateLimiter({ minDelayMs: 2000 });\r\n * \r\n * async function fetchAndParseDisclosures(date: string) {\r\n *   await rateLimiter.waitIfNeeded();\r\n *   const response = await axios.get(`https://www.release.tdnet.info/inbs/I_list_001_${date}.html`);\r\n *   return parseDisclosureList(response.data);\r\n * }\r\n * ```\r\n */\r\n\r\nimport * as cheerio from 'cheerio';\r\nimport { logger } from '../utils/logger';\r\nimport { ValidationError } from '../errors';\r\n\r\n/**\r\n * 開示情報メタデータ\r\n */\r\nexport interface DisclosureMetadata {\r\n  company_code: string;\r\n  company_name: string;\r\n  disclosure_type: string;\r\n  title: string;\r\n  disclosed_at: string; // ISO 8601形式（UTC）\r\n  pdf_url: string;\r\n}\r\n\r\n/**\r\n * TDnet開示情報リストページのHTMLをパース\r\n *\r\n * @param html HTMLコンテンツ\r\n * @returns 開示情報メタデータの配列\r\n * @throws ValidationError HTMLが不正な場合\r\n */\r\nexport function parseDisclosureList(html: string): DisclosureMetadata[] {\r\n  try {\r\n    // HTMLの基本検証\r\n    if (!html || html.trim().length === 0) {\r\n      throw new ValidationError('HTML content is empty');\r\n    }\r\n\r\n    // cheerioでHTMLをロード\r\n    const $ = cheerio.load(html);\r\n    const disclosures: DisclosureMetadata[] = [];\r\n\r\n    // HTML構造の検証（テーブルが存在するか）\r\n    const tables = $('table.disclosure-list');\r\n    if (tables.length === 0) {\r\n      logger.warn('No disclosure table found in HTML', {\r\n        html_length: html.length,\r\n        html_preview: html.substring(0, 200),\r\n      });\r\n      // HTML構造が変更された可能性を検知\r\n      detectHtmlStructureChange($);\r\n      return [];\r\n    }\r\n\r\n    // TDnetのテーブル構造に基づいてパース\r\n    // 注: 実際のTDnetのHTML構造に合わせて調整が必要\r\n    $('table.disclosure-list tr').each((index, element) => {\r\n      if (index === 0) return; // ヘッダー行をスキップ\r\n\r\n      const $row = $(element);\r\n      const cells = $row.find('td');\r\n\r\n      if (cells.length < 6) {\r\n        logger.warn('Invalid row structure', { index, cellCount: cells.length });\r\n        return;\r\n      }\r\n\r\n      try {\r\n        const disclosure: DisclosureMetadata = {\r\n          company_code: $(cells[0]).text().trim(),\r\n          company_name: $(cells[1]).text().trim(),\r\n          disclosure_type: $(cells[2]).text().trim(),\r\n          title: $(cells[3]).text().trim(),\r\n          disclosed_at: parseDisclosedAt($(cells[4]).text().trim()),\r\n          pdf_url: $(cells[5]).find('a').attr('href') || '',\r\n        };\r\n\r\n        // バリデーション\r\n        validateDisclosureMetadata(disclosure);\r\n\r\n        disclosures.push(disclosure);\r\n      } catch (error) {\r\n        logger.error('Failed to parse disclosure row', {\r\n          error_type: error instanceof Error ? error.constructor.name : 'Unknown',\r\n          error_message: error instanceof Error ? error.message : String(error),\r\n          row_index: index,\r\n        });\r\n      }\r\n    });\r\n\r\n    logger.info('HTML parsing completed', {\r\n      total_rows: $('table.disclosure-list tr').length - 1, // ヘッダー行を除く\r\n      parsed_disclosures: disclosures.length,\r\n    });\r\n\r\n    return disclosures;\r\n  } catch (error) {\r\n    logger.error('Failed to parse HTML', {\r\n      error_type: error instanceof Error ? error.constructor.name : 'Unknown',\r\n      error_message: error instanceof Error ? error.message : String(error),\r\n      html_length: html?.length || 0,\r\n    });\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * 開示日時をISO 8601形式（UTC）に変換\r\n *\r\n * @param dateStr 日時文字列（例: \"2024/01/15 10:30\"）\r\n * @returns ISO 8601形式の日時文字列\r\n */\r\nfunction parseDisclosedAt(dateStr: string): string {\r\n  // TDnetの日時形式（JST）をUTCに変換\r\n  // 例: \"2024/01/15 10:30\" → \"2024-01-15T01:30:00Z\"\r\n  const match = dateStr.match(/(\\d{4})\\/(\\d{2})\\/(\\d{2})\\s+(\\d{2}):(\\d{2})/);\r\n  if (!match) {\r\n    throw new ValidationError(`Invalid date format: ${dateStr}`);\r\n  }\r\n\r\n  const [, year, month, day, hour, minute] = match;\r\n  const jstDate = new Date(`${year}-${month}-${day}T${hour}:${minute}:00+09:00`);\r\n  return jstDate.toISOString();\r\n}\r\n\r\n/**\r\n * 開示情報メタデータのバリデーション\r\n *\r\n * @param disclosure 開示情報メタデータ\r\n * @throws ValidationError バリデーションエラー\r\n */\r\nfunction validateDisclosureMetadata(disclosure: DisclosureMetadata): void {\r\n  if (!disclosure.company_code || !/^\\d{4}$/.test(disclosure.company_code)) {\r\n    throw new ValidationError(`Invalid company_code: ${disclosure.company_code}`);\r\n  }\r\n\r\n  if (!disclosure.company_name) {\r\n    throw new ValidationError('company_name is required');\r\n  }\r\n\r\n  if (!disclosure.disclosure_type) {\r\n    throw new ValidationError('disclosure_type is required');\r\n  }\r\n\r\n  if (!disclosure.title) {\r\n    throw new ValidationError('title is required');\r\n  }\r\n\r\n  if (!disclosure.disclosed_at) {\r\n    throw new ValidationError('disclosed_at is required');\r\n  }\r\n\r\n  if (!disclosure.pdf_url || !disclosure.pdf_url.startsWith('http')) {\r\n    throw new ValidationError(`Invalid pdf_url: ${disclosure.pdf_url}`);\r\n  }\r\n}\r\n\r\n/**\r\n * HTML構造の変更を検知\r\n *\r\n * TDnetのHTML構造が変更された場合を検知し、ログに記録する。\r\n * steeringファイル（development/tdnet-scraping-patterns.md）の要件に準拠。\r\n *\r\n * @param $ cheerioインスタンス\r\n * @returns HTML構造が変更されている場合はtrue\r\n */\r\nfunction detectHtmlStructureChange($: cheerio.CheerioAPI): boolean {\r\n  const expectedSelectors = [\r\n    'table.disclosure-list',\r\n    'table.disclosure-list tr',\r\n    'table.disclosure-list td',\r\n  ];\r\n\r\n  let structureChanged = false;\r\n\r\n  for (const selector of expectedSelectors) {\r\n    if ($(selector).length === 0) {\r\n      logger.error('HTML structure changed: selector not found', {\r\n        selector,\r\n        error_type: 'HtmlStructureChangeDetected',\r\n      });\r\n      structureChanged = true;\r\n    }\r\n  }\r\n\r\n  if (structureChanged) {\r\n    logger.error('TDnet HTML structure has changed', {\r\n      error_type: 'HtmlStructureChangeDetected',\r\n      message: 'Expected HTML selectors not found. TDnet may have updated their website structure.',\r\n      action_required: 'Update html-parser.ts to match new HTML structure',\r\n    });\r\n  }\r\n\r\n  return structureChanged;\r\n}\r\n"],"version":3}