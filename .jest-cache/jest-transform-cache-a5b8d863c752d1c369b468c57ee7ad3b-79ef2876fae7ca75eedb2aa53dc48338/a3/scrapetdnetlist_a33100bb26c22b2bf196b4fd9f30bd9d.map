{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\scrape-tdnet-list.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\scrape-tdnet-list.ts"],"sourcesContent":["/**\r\n * TDnet List Scraper\r\n *\r\n * 指定日のTDnet開示情報リストを取得し、メタデータを抽出します。\r\n * レート制限と再試行ロジックを適用して、TDnetサーバーへの負荷を最小化します。\r\n *\r\n * Requirements: 要件1.1, 9.1\r\n */\r\n\r\nimport axios, { AxiosError } from 'axios';\r\nimport { parseDisclosureList, DisclosureMetadata } from '../../scraper/html-parser';\r\nimport { RateLimiter } from '../../utils/rate-limiter';\r\nimport { retryWithBackoff } from '../../utils/retry';\r\nimport { logger, createErrorContext } from '../../utils/logger';\r\nimport { sendErrorMetric, sendSuccessMetric } from '../../utils/cloudwatch-metrics';\r\nimport { RetryableError, ValidationError } from '../../errors';\r\n\r\n/**\r\n * レート制限設定（2秒間隔）\r\n * TDnetサーバーへの過度な負荷を防ぐため\r\n */\r\nconst rateLimiter = new RateLimiter({ minDelayMs: 2000 });\r\n\r\n/**\r\n * HTTPタイムアウト設定（30秒）\r\n */\r\nconst HTTP_TIMEOUT_MS = 30000;\r\n\r\n/**\r\n * User-Agent設定\r\n */\r\nconst USER_AGENT = 'TDnet-Data-Collector/1.0 (https://github.com/your-org/tdnet-data-collector)';\r\n\r\n/**\r\n * 指定日のTDnet開示情報リストを取得\r\n *\r\n * @param date 日付（YYYY-MM-DD形式）\r\n * @returns 開示情報メタデータの配列\r\n * @throws ValidationError 日付フォーマットが不正な場合\r\n * @throws RetryableError ネットワークエラーまたはHTTPエラー\r\n *\r\n * @example\r\n * ```typescript\r\n * const disclosures = await scrapeTdnetList('2024-01-15');\r\n * console.log(`Found ${disclosures.length} disclosures`);\r\n * ```\r\n */\r\nexport async function scrapeTdnetList(date: string): Promise<DisclosureMetadata[]> {\r\n  // 日付フォーマットのバリデーション\r\n  validateDateFormat(date);\r\n\r\n  try {\r\n    logger.info('Scraping TDnet list', { date });\r\n\r\n    // レート制限を適用\r\n    await rateLimiter.waitIfNeeded();\r\n\r\n    // TDnetからHTMLを取得（再試行あり）\r\n    const html = await fetchTdnetHtml(date);\r\n\r\n    // HTMLをパース\r\n    const disclosures = parseDisclosureList(html);\r\n\r\n    logger.info('TDnet list scraped successfully', {\r\n      date,\r\n      count: disclosures.length,\r\n    });\r\n\r\n    // 成功メトリクス送信\r\n    await sendSuccessMetric(disclosures.length, 'ScrapeTdnetList', {\r\n      Date: date,\r\n    });\r\n\r\n    return disclosures;\r\n  } catch (error) {\r\n    logger.error(\r\n      'Failed to scrape TDnet list',\r\n      createErrorContext(error as Error, { date })\r\n    );\r\n\r\n    // エラーメトリクス送信\r\n    await sendErrorMetric(\r\n      error instanceof Error ? error.constructor.name : 'Unknown',\r\n      'ScrapeTdnetList',\r\n      { Date: date }\r\n    );\r\n\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * 日付フォーマットのバリデーション\r\n *\r\n * @param date 日付（YYYY-MM-DD形式）\r\n * @throws ValidationError 日付フォーマットが不正な場合\r\n *\r\n * @remarks\r\n * 以下のバリデーションを実施：\r\n * 1. フォーマット検証（YYYY-MM-DD形式）\r\n * 2. 存在する日付の検証（2024-02-30などを拒否）\r\n * 3. 範囲検証（1970-01-01以降、現在+1日以内）\r\n */\r\nfunction validateDateFormat(date: string): void {\r\n  // 1. フォーマット検証\r\n  const dateRegex = /^\\d{4}-\\d{2}-\\d{2}$/;\r\n  if (!dateRegex.test(date)) {\r\n    throw new ValidationError(\r\n      `Invalid date format: ${date}. Expected YYYY-MM-DD format.`\r\n    );\r\n  }\r\n\r\n  // 2. 存在する日付の検証\r\n  const dateObj = new Date(date);\r\n  if (isNaN(dateObj.getTime())) {\r\n    throw new ValidationError(\r\n      `Invalid date: ${date}. Date does not exist.`\r\n    );\r\n  }\r\n\r\n  // 日付の各部分を抽出して検証\r\n  const [year, month, day] = date.split('-').map(Number);\r\n  const reconstructedDate = new Date(year, month - 1, day);\r\n  \r\n  // 日付が正規化されていないか確認（例: 2024-02-30 → 2024-03-02）\r\n  if (\r\n    reconstructedDate.getFullYear() !== year ||\r\n    reconstructedDate.getMonth() !== month - 1 ||\r\n    reconstructedDate.getDate() !== day\r\n  ) {\r\n    throw new ValidationError(\r\n      `Invalid date: ${date}. Date does not exist (e.g., February 30th).`\r\n    );\r\n  }\r\n\r\n  // 3. 範囲検証（1970-01-01以降、現在+1日以内）\r\n  const minDate = new Date('1970-01-01T00:00:00Z');\r\n  const maxDate = new Date(Date.now() + 24 * 60 * 60 * 1000); // 現在時刻+1日\r\n  \r\n  if (dateObj < minDate) {\r\n    throw new ValidationError(\r\n      `Date out of range: ${date}. Must be on or after 1970-01-01.`\r\n    );\r\n  }\r\n  \r\n  if (dateObj > maxDate) {\r\n    throw new ValidationError(\r\n      `Date out of range: ${date}. Must be within 1 day of current date.`\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * TDnetからHTMLを取得（再試行あり）\r\n *\r\n * @param date 日付（YYYY-MM-DD形式）\r\n * @returns HTMLコンテンツ\r\n * @throws RetryableError ネットワークエラーまたはHTTPエラー\r\n */\r\nasync function fetchTdnetHtml(date: string): Promise<string> {\r\n  const url = buildTdnetUrl(date);\r\n\r\n  return await retryWithBackoff(\r\n    async () => {\r\n      try {\r\n        logger.debug('Fetching TDnet HTML', { url, date });\r\n\r\n        const response = await axios.get(url, {\r\n          timeout: HTTP_TIMEOUT_MS,\r\n          headers: {\r\n            'User-Agent': USER_AGENT,\r\n            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',\r\n            'Accept-Language': 'ja,en-US;q=0.9,en;q=0.8',\r\n            'Accept-Encoding': 'gzip, deflate',\r\n            'Connection': 'keep-alive',\r\n          },\r\n          validateStatus: (status) => status >= 200 && status < 300,\r\n        });\r\n\r\n        logger.debug('TDnet HTML fetched successfully', {\r\n          url,\r\n          date,\r\n          status: response.status,\r\n          content_length: response.data.length,\r\n        });\r\n\r\n        return response.data;\r\n      } catch (error) {\r\n        // AxiosErrorを適切なエラーに変換\r\n        throw convertAxiosError(error as AxiosError, url);\r\n      }\r\n    },\r\n    {\r\n      maxRetries: 3,\r\n      initialDelay: 2000,\r\n      backoffMultiplier: 2,\r\n      jitter: true,\r\n      shouldRetry: (error) => {\r\n        // RetryableErrorのみ再試行\r\n        return error instanceof RetryableError;\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n/**\r\n * TDnet URLを構築\r\n *\r\n * @param date 日付（YYYY-MM-DD形式）\r\n * @returns TDnet URL\r\n *\r\n * @remarks\r\n * 実際のTDnet URLに置き換える必要があります。\r\n * 例: https://www.release.tdnet.info/inbs/I_list_001_YYYY-MM-DD.html\r\n */\r\nfunction buildTdnetUrl(date: string): string {\r\n  // TODO: 実際のTDnet URLに置き換える\r\n  // 現在はプレースホルダーURL\r\n  const baseUrl = process.env.TDNET_BASE_URL || 'https://www.release.tdnet.info/inbs';\r\n  return `${baseUrl}/I_list_001_${date}.html`;\r\n}\r\n\r\n/**\r\n * AxiosErrorを適切なエラーに変換\r\n *\r\n * @param error AxiosError\r\n * @param url リクエストURL\r\n * @returns 変換されたエラー\r\n */\r\nfunction convertAxiosError(error: AxiosError, url: string): Error {\r\n  // ネットワークエラー\r\n  if (error.code === 'ECONNRESET' || error.code === 'ETIMEDOUT' || error.code === 'ENOTFOUND') {\r\n    return new RetryableError(\r\n      `Network error: ${error.code} - ${error.message}`,\r\n      error\r\n    );\r\n  }\r\n\r\n  // タイムアウトエラー\r\n  if (error.code === 'ECONNABORTED' || error.message?.includes('timeout')) {\r\n    return new RetryableError(\r\n      `Request timeout: ${error.message}`,\r\n      error\r\n    );\r\n  }\r\n\r\n  // HTTPエラー\r\n  if (error.response) {\r\n    const status = error.response.status;\r\n\r\n    // 5xxエラー（サーバーエラー）- 再試行可能\r\n    if (status >= 500) {\r\n      return new RetryableError(\r\n        `Server error: ${status} ${error.response.statusText}`,\r\n        error\r\n      );\r\n    }\r\n\r\n    // 429エラー（レート制限）- 再試行可能\r\n    if (status === 429) {\r\n      return new RetryableError(\r\n        `Rate limit exceeded: ${status} ${error.response.statusText}`,\r\n        error\r\n      );\r\n    }\r\n\r\n    // 404エラー（ページが存在しない）- 再試行不可\r\n    if (status === 404) {\r\n      return new ValidationError(\r\n        `TDnet page not found: ${url}. The specified date may not have any disclosures.`\r\n      );\r\n    }\r\n\r\n    // その他のHTTPエラー - 再試行不可\r\n    return new Error(\r\n      `HTTP error: ${status} ${error.response.statusText}`\r\n    );\r\n  }\r\n\r\n  // その他のエラー\r\n  return new Error(\r\n    `Failed to fetch TDnet HTML: ${error.message}`\r\n  );\r\n}\r\n"],"version":3}