e7985af3dce2242b27b37cc4f5dc7d4c
"use strict";
/**
 * PDFダウンローダー
 *
 * TDnetからPDFファイルをダウンロードし、バリデーションを行います。
 *
 * Requirements: 要件1.3, 2.3（PDFダウンロード、整合性検証）
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.downloadPdf = downloadPdf;
exports.validatePdfFile = validatePdfFile;
const axios_1 = __importDefault(require("axios"));
const logger_1 = require("../utils/logger");
const errors_1 = require("../errors");
const retry_1 = require("../utils/retry");
/**
 * PDFファイルをダウンロード
 *
 * @param url PDF URL
 * @returns PDFファイルのバイナリデータ
 * @throws RetryableError ネットワークエラー
 * @throws ValidationError PDFファイルが不正な場合
 */
async function downloadPdf(url) {
    return await (0, retry_1.retryWithBackoff)(async () => {
        try {
            const response = await axios_1.default.get(url, {
                responseType: 'arraybuffer',
                timeout: 30000, // 30秒タイムアウト
                headers: {
                    'User-Agent': 'TDnet-Data-Collector/1.0',
                },
            });
            const buffer = Buffer.from(response.data);
            // PDFファイルのバリデーション
            validatePdfFile(buffer);
            logger_1.logger.info('PDF downloaded successfully', {
                url,
                size: buffer.length,
            });
            return buffer;
        }
        catch (error) {
            if (axios_1.default.isAxiosError(error)) {
                if (error.code === 'ECONNABORTED' || error.code === 'ETIMEDOUT') {
                    throw new errors_1.RetryableError(`Timeout downloading PDF: ${url}`);
                }
                if (error.response && error.response.status >= 500) {
                    throw new errors_1.RetryableError(`Server error (${error.response.status}): ${url}`);
                }
            }
            throw error;
        }
    }, {
        maxRetries: 3,
        initialDelay: 2000,
        backoffMultiplier: 2,
        jitter: true,
    });
}
/**
 * PDFファイルのバリデーション
 *
 * @param buffer PDFファイルのバイナリデータ
 * @throws ValidationError PDFファイルが不正な場合
 */
function validatePdfFile(buffer) {
    // ファイルサイズチェック（10KB〜50MB）
    const minSize = 10 * 1024; // 10KB
    const maxSize = 50 * 1024 * 1024; // 50MB
    if (buffer.length < minSize) {
        throw new errors_1.ValidationError(`PDF file too small: ${buffer.length} bytes (min: ${minSize})`);
    }
    if (buffer.length > maxSize) {
        throw new errors_1.ValidationError(`PDF file too large: ${buffer.length} bytes (max: ${maxSize})`);
    }
    // PDFヘッダーチェック（%PDF-で開始）
    const header = buffer.slice(0, 5).toString('utf-8');
    if (!header.startsWith('%PDF-')) {
        throw new errors_1.ValidationError(`Invalid PDF header: ${header}`);
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxzY3JhcGVyXFxwZGYtZG93bmxvYWRlci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7OztHQU1HOzs7OztBQWVILGtDQTBDQztBQVFELDBDQWtCQztBQWpGRCxrREFBMEI7QUFDMUIsNENBQXlDO0FBQ3pDLHNDQUE0RDtBQUM1RCwwQ0FBa0Q7QUFFbEQ7Ozs7Ozs7R0FPRztBQUNJLEtBQUssVUFBVSxXQUFXLENBQUMsR0FBVztJQUMzQyxPQUFPLE1BQU0sSUFBQSx3QkFBZ0IsRUFDM0IsS0FBSyxJQUFJLEVBQUU7UUFDVCxJQUFJLENBQUM7WUFDSCxNQUFNLFFBQVEsR0FBRyxNQUFNLGVBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFO2dCQUNwQyxZQUFZLEVBQUUsYUFBYTtnQkFDM0IsT0FBTyxFQUFFLEtBQUssRUFBRSxZQUFZO2dCQUM1QixPQUFPLEVBQUU7b0JBQ1AsWUFBWSxFQUFFLDBCQUEwQjtpQkFDekM7YUFDRixDQUFDLENBQUM7WUFFSCxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUUxQyxrQkFBa0I7WUFDbEIsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRXhCLGVBQU0sQ0FBQyxJQUFJLENBQUMsNkJBQTZCLEVBQUU7Z0JBQ3pDLEdBQUc7Z0JBQ0gsSUFBSSxFQUFFLE1BQU0sQ0FBQyxNQUFNO2FBQ3BCLENBQUMsQ0FBQztZQUVILE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxlQUFLLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQzlCLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxjQUFjLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxXQUFXLEVBQUUsQ0FBQztvQkFDaEUsTUFBTSxJQUFJLHVCQUFjLENBQUMsNEJBQTRCLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQzlELENBQUM7Z0JBQ0QsSUFBSSxLQUFLLENBQUMsUUFBUSxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDO29CQUNuRCxNQUFNLElBQUksdUJBQWMsQ0FBQyxpQkFBaUIsS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDOUUsQ0FBQztZQUNILENBQUM7WUFDRCxNQUFNLEtBQUssQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDLEVBQ0Q7UUFDRSxVQUFVLEVBQUUsQ0FBQztRQUNiLFlBQVksRUFBRSxJQUFJO1FBQ2xCLGlCQUFpQixFQUFFLENBQUM7UUFDcEIsTUFBTSxFQUFFLElBQUk7S0FDYixDQUNGLENBQUM7QUFDSixDQUFDO0FBRUQ7Ozs7O0dBS0c7QUFDSCxTQUFnQixlQUFlLENBQUMsTUFBYztJQUM1Qyx5QkFBeUI7SUFDekIsTUFBTSxPQUFPLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLE9BQU87SUFDbEMsTUFBTSxPQUFPLEdBQUcsRUFBRSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxPQUFPO0lBRXpDLElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxPQUFPLEVBQUUsQ0FBQztRQUM1QixNQUFNLElBQUksd0JBQWUsQ0FBQyx1QkFBdUIsTUFBTSxDQUFDLE1BQU0sZ0JBQWdCLE9BQU8sR0FBRyxDQUFDLENBQUM7SUFDNUYsQ0FBQztJQUVELElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxPQUFPLEVBQUUsQ0FBQztRQUM1QixNQUFNLElBQUksd0JBQWUsQ0FBQyx1QkFBdUIsTUFBTSxDQUFDLE1BQU0sZ0JBQWdCLE9BQU8sR0FBRyxDQUFDLENBQUM7SUFDNUYsQ0FBQztJQUVELHdCQUF3QjtJQUN4QixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDcEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztRQUNoQyxNQUFNLElBQUksd0JBQWUsQ0FBQyx1QkFBdUIsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUM3RCxDQUFDO0FBQ0gsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpMTk4XFxpbnZlc3RtZW50X2FuYWx5c2lzX29wb3BvXFxzcmNcXHNjcmFwZXJcXHBkZi1kb3dubG9hZGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBQREbjg4Djgqbjg7Pjg63jg7zjg4Djg7xcclxuICpcclxuICogVERuZXTjgYvjgolQREbjg5XjgqHjgqTjg6vjgpLjg4Djgqbjg7Pjg63jg7zjg4njgZfjgIHjg5Djg6rjg4fjg7zjgrfjg6fjg7PjgpLooYzjgYTjgb7jgZnjgIJcclxuICpcclxuICogUmVxdWlyZW1lbnRzOiDopoHku7YxLjMsIDIuM++8iFBERuODgOOCpuODs+ODreODvOODieOAgeaVtOWQiOaAp+aknOiovO+8iVxyXG4gKi9cclxuXHJcbmltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7XHJcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XHJcbmltcG9ydCB7IFJldHJ5YWJsZUVycm9yLCBWYWxpZGF0aW9uRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMnO1xyXG5pbXBvcnQgeyByZXRyeVdpdGhCYWNrb2ZmIH0gZnJvbSAnLi4vdXRpbHMvcmV0cnknO1xyXG5cclxuLyoqXHJcbiAqIFBERuODleOCoeOCpOODq+OCkuODgOOCpuODs+ODreODvOODiVxyXG4gKlxyXG4gKiBAcGFyYW0gdXJsIFBERiBVUkxcclxuICogQHJldHVybnMgUERG44OV44Kh44Kk44Or44Gu44OQ44Kk44OK44Oq44OH44O844K/XHJcbiAqIEB0aHJvd3MgUmV0cnlhYmxlRXJyb3Ig44ON44OD44OI44Ov44O844Kv44Ko44Op44O8XHJcbiAqIEB0aHJvd3MgVmFsaWRhdGlvbkVycm9yIFBERuODleOCoeOCpOODq+OBjOS4jeato+OBquWgtOWQiFxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRvd25sb2FkUGRmKHVybDogc3RyaW5nKTogUHJvbWlzZTxCdWZmZXI+IHtcclxuICByZXR1cm4gYXdhaXQgcmV0cnlXaXRoQmFja29mZihcclxuICAgIGFzeW5jICgpID0+IHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGF4aW9zLmdldCh1cmwsIHtcclxuICAgICAgICAgIHJlc3BvbnNlVHlwZTogJ2FycmF5YnVmZmVyJyxcclxuICAgICAgICAgIHRpbWVvdXQ6IDMwMDAwLCAvLyAzMOenkuOCv+OCpOODoOOCouOCpuODiFxyXG4gICAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgICAnVXNlci1BZ2VudCc6ICdURG5ldC1EYXRhLUNvbGxlY3Rvci8xLjAnLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmZyb20ocmVzcG9uc2UuZGF0YSk7XHJcblxyXG4gICAgICAgIC8vIFBERuODleOCoeOCpOODq+OBruODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gICAgICAgIHZhbGlkYXRlUGRmRmlsZShidWZmZXIpO1xyXG5cclxuICAgICAgICBsb2dnZXIuaW5mbygnUERGIGRvd25sb2FkZWQgc3VjY2Vzc2Z1bGx5Jywge1xyXG4gICAgICAgICAgdXJsLFxyXG4gICAgICAgICAgc2l6ZTogYnVmZmVyLmxlbmd0aCxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGJ1ZmZlcjtcclxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICBpZiAoYXhpb3MuaXNBeGlvc0Vycm9yKGVycm9yKSkge1xyXG4gICAgICAgICAgaWYgKGVycm9yLmNvZGUgPT09ICdFQ09OTkFCT1JURUQnIHx8IGVycm9yLmNvZGUgPT09ICdFVElNRURPVVQnKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBSZXRyeWFibGVFcnJvcihgVGltZW91dCBkb3dubG9hZGluZyBQREY6ICR7dXJsfWApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYgKGVycm9yLnJlc3BvbnNlICYmIGVycm9yLnJlc3BvbnNlLnN0YXR1cyA+PSA1MDApIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFJldHJ5YWJsZUVycm9yKGBTZXJ2ZXIgZXJyb3IgKCR7ZXJyb3IucmVzcG9uc2Uuc3RhdHVzfSk6ICR7dXJsfWApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB0aHJvdyBlcnJvcjtcclxuICAgICAgfVxyXG4gICAgfSxcclxuICAgIHtcclxuICAgICAgbWF4UmV0cmllczogMyxcclxuICAgICAgaW5pdGlhbERlbGF5OiAyMDAwLFxyXG4gICAgICBiYWNrb2ZmTXVsdGlwbGllcjogMixcclxuICAgICAgaml0dGVyOiB0cnVlLFxyXG4gICAgfVxyXG4gICk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBQREbjg5XjgqHjgqTjg6vjga7jg5Djg6rjg4fjg7zjgrfjg6fjg7NcclxuICpcclxuICogQHBhcmFtIGJ1ZmZlciBQREbjg5XjgqHjgqTjg6vjga7jg5DjgqTjg4rjg6rjg4fjg7zjgr9cclxuICogQHRocm93cyBWYWxpZGF0aW9uRXJyb3IgUERG44OV44Kh44Kk44Or44GM5LiN5q2j44Gq5aC05ZCIXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVQZGZGaWxlKGJ1ZmZlcjogQnVmZmVyKTogdm9pZCB7XHJcbiAgLy8g44OV44Kh44Kk44Or44K144Kk44K644OB44Kn44OD44Kv77yIMTBLQuOAnDUwTULvvIlcclxuICBjb25zdCBtaW5TaXplID0gMTAgKiAxMDI0OyAvLyAxMEtCXHJcbiAgY29uc3QgbWF4U2l6ZSA9IDUwICogMTAyNCAqIDEwMjQ7IC8vIDUwTUJcclxuXHJcbiAgaWYgKGJ1ZmZlci5sZW5ndGggPCBtaW5TaXplKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKGBQREYgZmlsZSB0b28gc21hbGw6ICR7YnVmZmVyLmxlbmd0aH0gYnl0ZXMgKG1pbjogJHttaW5TaXplfSlgKTtcclxuICB9XHJcblxyXG4gIGlmIChidWZmZXIubGVuZ3RoID4gbWF4U2l6ZSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihgUERGIGZpbGUgdG9vIGxhcmdlOiAke2J1ZmZlci5sZW5ndGh9IGJ5dGVzIChtYXg6ICR7bWF4U2l6ZX0pYCk7XHJcbiAgfVxyXG5cclxuICAvLyBQREbjg5jjg4Pjg4Djg7zjg4Hjgqfjg4Pjgq/vvIglUERGLeOBp+mWi+Wni++8iVxyXG4gIGNvbnN0IGhlYWRlciA9IGJ1ZmZlci5zbGljZSgwLCA1KS50b1N0cmluZygndXRmLTgnKTtcclxuICBpZiAoIWhlYWRlci5zdGFydHNXaXRoKCclUERGLScpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKGBJbnZhbGlkIFBERiBoZWFkZXI6ICR7aGVhZGVyfWApO1xyXG4gIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=