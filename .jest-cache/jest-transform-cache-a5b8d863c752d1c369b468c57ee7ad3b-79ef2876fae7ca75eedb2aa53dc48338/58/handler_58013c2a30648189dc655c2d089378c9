29f979661ef38e82d774dc6fa5b935b6
"use strict";
/**
 * Lambda Collect Handler
 *
 * POST /collect エンドポイントのハンドラー。
 * Lambda Collectorを非同期で呼び出し、実行IDを返却します。
 *
 * Requirements: タスク13.1
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const client_lambda_1 = require("@aws-sdk/client-lambda");
const logger_1 = require("../../utils/logger");
const cloudwatch_metrics_1 = require("../../utils/cloudwatch-metrics");
const errors_1 = require("../../errors");
// Lambda クライアントはグローバルスコープで初期化（再利用される）
const lambdaClient = new client_lambda_1.LambdaClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });
// 環境変数
const COLLECTOR_FUNCTION_NAME = process.env.COLLECTOR_FUNCTION_NAME || 'tdnet-collector';
/**
 * Lambda Collect ハンドラー
 *
 * @param event API Gateway Proxy Event
 * @param context Lambda Context
 * @returns API Gateway Proxy Result
 */
async function handler(event, context) {
    try {
        logger_1.logger.info('POST /collect invoked', {
            requestId: context.requestId,
            functionName: context.functionName,
        });
        // リクエストボディのパース
        if (!event.body) {
            throw new errors_1.ValidationError('Request body is required');
        }
        const request = JSON.parse(event.body);
        // バリデーション
        validateRequest(request);
        // Lambda Collectorを非同期で呼び出し
        const execution_id = await invokeCollector(request, context);
        // レスポンス
        const response = {
            status: 'success',
            data: {
                execution_id,
                status: 'pending',
                message: 'Data collection started successfully',
                started_at: new Date().toISOString(),
            },
        };
        logger_1.logger.info('POST /collect completed', {
            requestId: context.requestId,
            execution_id,
        });
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify(response),
        };
    }
    catch (error) {
        logger_1.logger.error('POST /collect failed', (0, logger_1.createErrorContext)(error, {
            requestId: context.requestId,
            event,
        }));
        // エラーメトリクス送信
        await (0, cloudwatch_metrics_1.sendErrorMetric)(error instanceof Error ? error.constructor.name : 'Unknown', 'Collect', {});
        return toErrorResponse(error, context.requestId);
    }
}
/**
 * リクエストのバリデーション
 *
 * @param request CollectRequest
 * @throws ValidationError バリデーションエラー
 */
function validateRequest(request) {
    // start_date のバリデーション
    if (!request.start_date) {
        throw new errors_1.ValidationError('start_date is required');
    }
    // end_date のバリデーション
    if (!request.end_date) {
        throw new errors_1.ValidationError('end_date is required');
    }
    // 日付フォーマットのバリデーション（YYYY-MM-DD）
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateRegex.test(request.start_date)) {
        throw new errors_1.ValidationError(`Invalid start_date format: ${request.start_date}. Expected YYYY-MM-DD format.`);
    }
    if (!dateRegex.test(request.end_date)) {
        throw new errors_1.ValidationError(`Invalid end_date format: ${request.end_date}. Expected YYYY-MM-DD format.`);
    }
    // 日付の有効性チェック
    const startDate = new Date(request.start_date);
    const endDate = new Date(request.end_date);
    if (isNaN(startDate.getTime())) {
        throw new errors_1.ValidationError(`Invalid start_date: ${request.start_date}. Date does not exist.`);
    }
    if (isNaN(endDate.getTime())) {
        throw new errors_1.ValidationError(`Invalid end_date: ${request.end_date}. Date does not exist.`);
    }
    // 日付順序チェック
    if (startDate > endDate) {
        throw new errors_1.ValidationError(`start_date (${request.start_date}) must be before or equal to end_date (${request.end_date})`);
    }
    // 範囲チェック（過去1年以内）
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
    if (startDate < oneYearAgo) {
        throw new errors_1.ValidationError(`start_date (${request.start_date}) is too old. Maximum range is 1 year.`);
    }
    // 未来日チェック
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    if (endDate > tomorrow) {
        throw new errors_1.ValidationError(`end_date (${request.end_date}) cannot be in the future.`);
    }
}
/**
 * Lambda Collectorを非同期で呼び出し
 *
 * @param request CollectRequest
 * @param context Lambda Context
 * @returns 実行ID
 */
async function invokeCollector(request, context) {
    // Lambda Collectorのイベント
    const collectorEvent = {
        mode: 'on-demand',
        start_date: request.start_date,
        end_date: request.end_date,
    };
    logger_1.logger.info('Invoking Lambda Collector', {
        requestId: context.requestId,
        functionName: COLLECTOR_FUNCTION_NAME,
        event: collectorEvent,
    });
    try {
        // Lambda Collectorを同期で呼び出し（InvocationType: RequestResponse）
        // これにより、Collectorが生成した実際のexecution_idを取得できます
        const command = new client_lambda_1.InvokeCommand({
            FunctionName: COLLECTOR_FUNCTION_NAME,
            InvocationType: 'RequestResponse', // 同期呼び出し
            Payload: Buffer.from(JSON.stringify(collectorEvent)),
        });
        const response = await lambdaClient.send(command);
        logger_1.logger.info('Lambda Collector invoked successfully', {
            requestId: context.requestId,
            statusCode: response.StatusCode,
        });
        // Lambda Collectorのレスポンスをパース
        if (!response.Payload) {
            throw new Error('Lambda Collector returned empty response');
        }
        const payloadString = Buffer.from(response.Payload).toString('utf-8');
        const collectorResponse = JSON.parse(payloadString);
        // Lambda Collectorが生成した実際のexecution_idを使用
        const execution_id = collectorResponse.execution_id;
        if (!execution_id) {
            throw new Error('Lambda Collector did not return execution_id');
        }
        logger_1.logger.info('Received execution_id from Lambda Collector', {
            requestId: context.requestId,
            execution_id,
            status: collectorResponse.status,
        });
        return execution_id;
    }
    catch (error) {
        logger_1.logger.error('Failed to invoke Lambda Collector', (0, logger_1.createErrorContext)(error, {
            requestId: context.requestId,
            functionName: COLLECTOR_FUNCTION_NAME,
        }));
        throw new Error('Failed to start data collection');
    }
}
/**
 * エラーレスポンスを生成
 *
 * @param error Error
 * @param requestId リクエストID
 * @returns API Gateway Proxy Result
 */
function toErrorResponse(error, requestId) {
    const errorCodeMap = {
        ValidationError: { statusCode: 400, code: 'VALIDATION_ERROR' },
        UnauthorizedError: { statusCode: 401, code: 'UNAUTHORIZED' },
        ForbiddenError: { statusCode: 403, code: 'FORBIDDEN' },
        NotFoundError: { statusCode: 404, code: 'NOT_FOUND' },
        ConflictError: { statusCode: 409, code: 'CONFLICT' },
        RateLimitError: { statusCode: 429, code: 'RATE_LIMIT_EXCEEDED' },
        InternalError: { statusCode: 500, code: 'INTERNAL_ERROR' },
        ServiceUnavailableError: { statusCode: 503, code: 'SERVICE_UNAVAILABLE' },
        GatewayTimeoutError: { statusCode: 504, code: 'GATEWAY_TIMEOUT' },
    };
    const mapping = errorCodeMap[error.name] || {
        statusCode: 500,
        code: 'INTERNAL_ERROR',
    };
    return {
        statusCode: mapping.statusCode,
        headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
        },
        body: JSON.stringify({
            status: 'error',
            error: {
                code: mapping.code,
                message: error.message,
                details: error.details || {},
            },
            request_id: requestId,
        }),
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGNvbGxlY3RcXGhhbmRsZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7O0dBT0c7O0FBdURILDBCQWlFQztBQXJIRCwwREFBcUU7QUFDckUsK0NBQWdFO0FBQ2hFLHVFQUFpRTtBQUNqRSx5Q0FBK0M7QUFFL0Msc0NBQXNDO0FBQ3RDLE1BQU0sWUFBWSxHQUFHLElBQUksNEJBQVksQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7QUFFOUYsT0FBTztBQUNQLE1BQU0sdUJBQXVCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsSUFBSSxpQkFBaUIsQ0FBQztBQW9DekY7Ozs7OztHQU1HO0FBQ0ksS0FBSyxVQUFVLE9BQU8sQ0FDM0IsS0FBMkIsRUFDM0IsT0FBZ0I7SUFFaEIsSUFBSSxDQUFDO1FBQ0gsZUFBTSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRTtZQUNuQyxTQUFTLEVBQUUsT0FBTyxDQUFDLFNBQVM7WUFDNUIsWUFBWSxFQUFFLE9BQU8sQ0FBQyxZQUFZO1NBQ25DLENBQUMsQ0FBQztRQUVILGVBQWU7UUFDZixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2hCLE1BQU0sSUFBSSx3QkFBZSxDQUFDLDBCQUEwQixDQUFDLENBQUM7UUFDeEQsQ0FBQztRQUVELE1BQU0sT0FBTyxHQUFtQixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV2RCxVQUFVO1FBQ1YsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXpCLDRCQUE0QjtRQUM1QixNQUFNLFlBQVksR0FBRyxNQUFNLGVBQWUsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFN0QsUUFBUTtRQUNSLE1BQU0sUUFBUSxHQUFvQjtZQUNoQyxNQUFNLEVB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S0FDbEUsQ0FBQztJQUVGLE1BQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUk7UUFDMUMsVUFBVSxFQUFFLEdBQUc7UUFDZixJQUFJLEVBQUUsZ0JBQWdCO0tBQ3ZCLENBQUM7SUFFRixPQUFPO1FBQ0wsVUFBVSxFQUFFLE9BQU8sQ0FBQyxVQUFVO1FBQzlCLE9BQU8sRUFBRTtZQUNQLGNBQWMsRUFBRSxrQkFBa0I7WUFDbEMsNkJBQTZCLEVBQUUsR0FBRztTQUNuQztRQUNELElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQ25CLE1BQU0sRUFBRSxPQUFPO1lBQ2YsS0FBSyxFQUFFO2dCQUNMLElBQUksRUFBRSxPQUFPLENBQUMsSUFBSTtnQkFDbEIsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO2dCQUN0QixPQUFPLEVBQUcsS0FBYSxDQUFDLE9BQU8sSUFBSSxFQUFFO2FBQ3RDO1lBQ0QsVUFBVSxFQUFFLFNBQVM7U0FDdEIsQ0FBQztLQUNILENBQUM7QUFDSixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcdGkxOThcXGludmVzdG1lbnRfYW5hbHlzaXNfb3BvcG9cXHNyY1xcbGFtYmRhXFxjb2xsZWN0XFxoYW5kbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBMYW1iZGEgQ29sbGVjdCBIYW5kbGVyXHJcbiAqXHJcbiAqIFBPU1QgL2NvbGxlY3Qg44Ko44Oz44OJ44Od44Kk44Oz44OI44Gu44OP44Oz44OJ44Op44O844CCXHJcbiAqIExhbWJkYSBDb2xsZWN0b3LjgpLpnZ7lkIzmnJ/jgaflkbzjgbPlh7rjgZfjgIHlrp/ooYxJROOCkui/lOWNtOOBl+OBvuOBmeOAglxyXG4gKlxyXG4gKiBSZXF1aXJlbWVudHM6IOOCv+OCueOCrzEzLjFcclxuICovXHJcblxyXG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0LCBDb250ZXh0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XHJcbmltcG9ydCB7IExhbWJkYUNsaWVudCwgSW52b2tlQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1sYW1iZGEnO1xyXG5pbXBvcnQgeyBsb2dnZXIsIGNyZWF0ZUVycm9yQ29udGV4dCB9IGZyb20gJy4uLy4uL3V0aWxzL2xvZ2dlcic7XHJcbmltcG9ydCB7IHNlbmRFcnJvck1ldHJpYyB9IGZyb20gJy4uLy4uL3V0aWxzL2Nsb3Vkd2F0Y2gtbWV0cmljcyc7XHJcbmltcG9ydCB7IFZhbGlkYXRpb25FcnJvciB9IGZyb20gJy4uLy4uL2Vycm9ycyc7XHJcblxyXG4vLyBMYW1iZGEg44Kv44Op44Kk44Ki44Oz44OI44Gv44Kw44Ot44O844OQ44Or44K544Kz44O844OX44Gn5Yid5pyf5YyW77yI5YaN5Yip55So44GV44KM44KL77yJXHJcbmNvbnN0IGxhbWJkYUNsaWVudCA9IG5ldyBMYW1iZGFDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ2FwLW5vcnRoZWFzdC0xJyB9KTtcclxuXHJcbi8vIOeSsOWig+WkieaVsFxyXG5jb25zdCBDT0xMRUNUT1JfRlVOQ1RJT05fTkFNRSA9IHByb2Nlc3MuZW52LkNPTExFQ1RPUl9GVU5DVElPTl9OQU1FIHx8ICd0ZG5ldC1jb2xsZWN0b3InO1xyXG5cclxuLyoqXHJcbiAqIFBPU1QgL2NvbGxlY3Qg44Oq44Kv44Ko44K544OI44Oc44OH44KjXHJcbiAqL1xyXG5pbnRlcmZhY2UgQ29sbGVjdFJlcXVlc3Qge1xyXG4gIC8qKiDplovlp4vml6XvvIhZWVlZLU1NLURE5b2i5byP77yJICovXHJcbiAgc3RhcnRfZGF0ZTogc3RyaW5nO1xyXG5cclxuICAvKiog57WC5LqG5pel77yIWVlZWS1NTS1EROW9ouW8j++8iSAqL1xyXG4gIGVuZF9kYXRlOiBzdHJpbmc7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBQT1NUIC9jb2xsZWN0IOODrOOCueODneODs+OCuVxyXG4gKi9cclxuaW50ZXJmYWNlIENvbGxlY3RSZXNwb25zZSB7XHJcbiAgLyoqIOOCueODhuODvOOCv+OCuSAqL1xyXG4gIHN0YXR1czogJ3N1Y2Nlc3MnO1xyXG5cclxuICAvKiog44OH44O844K/ICovXHJcbiAgZGF0YToge1xyXG4gICAgLyoqIOWun+ihjElEICovXHJcbiAgICBleGVjdXRpb25faWQ6IHN0cmluZztcclxuXHJcbiAgICAvKiog54q25oWLICovXHJcbiAgICBzdGF0dXM6ICdwZW5kaW5nJztcclxuXHJcbiAgICAvKiog44Oh44OD44K744O844K4ICovXHJcbiAgICBtZXNzYWdlOiBzdHJpbmc7XHJcblxyXG4gICAgLyoqIOmWi+Wni+aXpeaZgiAqL1xyXG4gICAgc3RhcnRlZF9hdDogc3RyaW5nO1xyXG4gIH07XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBMYW1iZGEgQ29sbGVjdCDjg4/jg7Pjg4njg6njg7xcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEFQSSBHYXRld2F5IFByb3h5IEV2ZW50XHJcbiAqIEBwYXJhbSBjb250ZXh0IExhbWJkYSBDb250ZXh0XHJcbiAqIEByZXR1cm5zIEFQSSBHYXRld2F5IFByb3h5IFJlc3VsdFxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhhbmRsZXIoXHJcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50LFxyXG4gIGNvbnRleHQ6IENvbnRleHRcclxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcclxuICB0cnkge1xyXG4gICAgbG9nZ2VyLmluZm8oJ1BPU1QgL2NvbGxlY3QgaW52b2tlZCcsIHtcclxuICAgICAgcmVxdWVzdElkOiBjb250ZXh0LnJlcXVlc3RJZCxcclxuICAgICAgZnVuY3Rpb25OYW1lOiBjb250ZXh0LmZ1bmN0aW9uTmFtZSxcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOODquOCr+OCqOOCueODiOODnOODh+OCo+OBruODkeODvOOCuVxyXG4gICAgaWYgKCFldmVudC5ib2R5KSB7XHJcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ1JlcXVlc3QgYm9keSBpcyByZXF1aXJlZCcpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHJlcXVlc3Q6IENvbGxlY3RSZXF1ZXN0ID0gSlNPTi5wYXJzZShldmVudC5ib2R5KTtcclxuXHJcbiAgICAvLyDjg5Djg6rjg4fjg7zjgrfjg6fjg7NcclxuICAgIHZhbGlkYXRlUmVxdWVzdChyZXF1ZXN0KTtcclxuXHJcbiAgICAvLyBMYW1iZGEgQ29sbGVjdG9y44KS6Z2e5ZCM5pyf44Gn5ZG844Gz5Ye644GXXHJcbiAgICBjb25zdCBleGVjdXRpb25faWQgPSBhd2FpdCBpbnZva2VDb2xsZWN0b3IocmVxdWVzdCwgY29udGV4dCk7XHJcblxyXG4gICAgLy8g44Os44K544Od44Oz44K5XHJcbiAgICBjb25zdCByZXNwb25zZTogQ29sbGVjdFJlc3BvbnNlID0ge1xyXG4gICAgICBzdGF0dXM6ICdzdWNjZXNzJyxcclxuICAgICAgZGF0YToge1xyXG4gICAgICAgIGV4ZWN1dGlvbl9pZCxcclxuICAgICAgICBzdGF0dXM6ICdwZW5kaW5nJyxcclxuICAgICAgICBtZXNzYWdlOiAnRGF0YSBjb2xsZWN0aW9uIHN0YXJ0ZWQgc3VjY2Vzc2Z1bGx5JyxcclxuICAgICAgICBzdGFydGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgIH0sXHJcbiAgICB9O1xyXG5cclxuICAgIGxvZ2dlci5pbmZvKCdQT1NUIC9jb2xsZWN0IGNvbXBsZXRlZCcsIHtcclxuICAgICAgcmVxdWVzdElkOiBjb250ZXh0LnJlcXVlc3RJZCxcclxuICAgICAgZXhlY3V0aW9uX2lkLFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc3RhdHVzQ29kZTogMjAwLFxyXG4gICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxyXG4gICAgICB9LFxyXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShyZXNwb25zZSksXHJcbiAgICB9O1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBsb2dnZXIuZXJyb3IoXHJcbiAgICAgICdQT1NUIC9jb2xsZWN0IGZhaWxlZCcsXHJcbiAgICAgIGNyZWF0ZUVycm9yQ29udGV4dChlcnJvciBhcyBFcnJvciwge1xyXG4gICAgICAgIHJlcXVlc3RJZDogY29udGV4dC5yZXF1ZXN0SWQsXHJcbiAgICAgICAgZXZlbnQsXHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIC8vIOOCqOODqeODvOODoeODiOODquOCr+OCuemAgeS/oVxyXG4gICAgYXdhaXQgc2VuZEVycm9yTWV0cmljKFxyXG4gICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IuY29uc3RydWN0b3IubmFtZSA6ICdVbmtub3duJyxcclxuICAgICAgJ0NvbGxlY3QnLFxyXG4gICAgICB7fVxyXG4gICAgKTtcclxuXHJcbiAgICByZXR1cm4gdG9FcnJvclJlc3BvbnNlKGVycm9yIGFzIEVycm9yLCBjb250ZXh0LnJlcXVlc3RJZCk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog44Oq44Kv44Ko44K544OI44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAqXHJcbiAqIEBwYXJhbSByZXF1ZXN0IENvbGxlY3RSZXF1ZXN0XHJcbiAqIEB0aHJvd3MgVmFsaWRhdGlvbkVycm9yIOODkOODquODh+ODvOOCt+ODp+ODs+OCqOODqeODvFxyXG4gKi9cclxuZnVuY3Rpb24gdmFsaWRhdGVSZXF1ZXN0KHJlcXVlc3Q6IENvbGxlY3RSZXF1ZXN0KTogdm9pZCB7XHJcbiAgLy8gc3RhcnRfZGF0ZSDjga7jg5Djg6rjg4fjg7zjgrfjg6fjg7NcclxuICBpZiAoIXJlcXVlc3Quc3RhcnRfZGF0ZSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignc3RhcnRfZGF0ZSBpcyByZXF1aXJlZCcpO1xyXG4gIH1cclxuXHJcbiAgLy8gZW5kX2RhdGUg44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAgaWYgKCFyZXF1ZXN0LmVuZF9kYXRlKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdlbmRfZGF0ZSBpcyByZXF1aXJlZCcpO1xyXG4gIH1cclxuXHJcbiAgLy8g5pel5LuY44OV44Kp44O844Oe44OD44OI44Gu44OQ44Oq44OH44O844K344On44Oz77yIWVlZWS1NTS1ERO+8iVxyXG4gIGNvbnN0IGRhdGVSZWdleCA9IC9eXFxkezR9LVxcZHsyfS1cXGR7Mn0kLztcclxuICBpZiAoIWRhdGVSZWdleC50ZXN0KHJlcXVlc3Quc3RhcnRfZGF0ZSkpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgIGBJbnZhbGlkIHN0YXJ0X2RhdGUgZm9ybWF0OiAke3JlcXVlc3Quc3RhcnRfZGF0ZX0uIEV4cGVjdGVkIFlZWVktTU0tREQgZm9ybWF0LmBcclxuICAgICk7XHJcbiAgfVxyXG4gIGlmICghZGF0ZVJlZ2V4LnRlc3QocmVxdWVzdC5lbmRfZGF0ZSkpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgIGBJbnZhbGlkIGVuZF9kYXRlIGZvcm1hdDogJHtyZXF1ZXN0LmVuZF9kYXRlfS4gRXhwZWN0ZWQgWVlZWS1NTS1ERCBmb3JtYXQuYFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIOaXpeS7mOOBruacieWKueaAp+ODgeOCp+ODg+OCr1xyXG4gIGNvbnN0IHN0YXJ0RGF0ZSA9IG5ldyBEYXRlKHJlcXVlc3Quc3RhcnRfZGF0ZSk7XHJcbiAgY29uc3QgZW5kRGF0ZSA9IG5ldyBEYXRlKHJlcXVlc3QuZW5kX2RhdGUpO1xyXG5cclxuICBpZiAoaXNOYU4oc3RhcnREYXRlLmdldFRpbWUoKSkpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgIGBJbnZhbGlkIHN0YXJ0X2RhdGU6ICR7cmVxdWVzdC5zdGFydF9kYXRlfS4gRGF0ZSBkb2VzIG5vdCBleGlzdC5gXHJcbiAgICApO1xyXG4gIH1cclxuICBpZiAoaXNOYU4oZW5kRGF0ZS5nZXRUaW1lKCkpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCBlbmRfZGF0ZTogJHtyZXF1ZXN0LmVuZF9kYXRlfS4gRGF0ZSBkb2VzIG5vdCBleGlzdC5gXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8g5pel5LuY6aCG5bqP44OB44Kn44OD44KvXHJcbiAgaWYgKHN0YXJ0RGF0ZSA+IGVuZERhdGUpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgIGBzdGFydF9kYXRlICgke3JlcXVlc3Quc3RhcnRfZGF0ZX0pIG11c3QgYmUgYmVmb3JlIG9yIGVxdWFsIHRvIGVuZF9kYXRlICgke3JlcXVlc3QuZW5kX2RhdGV9KWBcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvLyDnr4Tlm7Ljg4Hjgqfjg4Pjgq/vvIjpgY7ljrsx5bm05Lul5YaF77yJXHJcbiAgY29uc3Qgb25lWWVhckFnbyA9IG5ldyBEYXRlKCk7XHJcbiAgb25lWWVhckFnby5zZXRGdWxsWWVhcihvbmVZZWFyQWdvLmdldEZ1bGxZZWFyKCkgLSAxKTtcclxuICBpZiAoc3RhcnREYXRlIDwgb25lWWVhckFnbykge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYHN0YXJ0X2RhdGUgKCR7cmVxdWVzdC5zdGFydF9kYXRlfSkgaXMgdG9vIG9sZC4gTWF4aW11bSByYW5nZSBpcyAxIHllYXIuYFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIOacquadpeaXpeODgeOCp+ODg+OCr1xyXG4gIGNvbnN0IHRvbW9ycm93ID0gbmV3IERhdGUoKTtcclxuICB0b21vcnJvdy5zZXREYXRlKHRvbW9ycm93LmdldERhdGUoKSArIDEpO1xyXG4gIGlmIChlbmREYXRlID4gdG9tb3Jyb3cpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgIGBlbmRfZGF0ZSAoJHtyZXF1ZXN0LmVuZF9kYXRlfSkgY2Fubm90IGJlIGluIHRoZSBmdXR1cmUuYFxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBMYW1iZGEgQ29sbGVjdG9y44KS6Z2e5ZCM5pyf44Gn5ZG844Gz5Ye644GXXHJcbiAqXHJcbiAqIEBwYXJhbSByZXF1ZXN0IENvbGxlY3RSZXF1ZXN0XHJcbiAqIEBwYXJhbSBjb250ZXh0IExhbWJkYSBDb250ZXh0XHJcbiAqIEByZXR1cm5zIOWun+ihjElEXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBpbnZva2VDb2xsZWN0b3IoXHJcbiAgcmVxdWVzdDogQ29sbGVjdFJlcXVlc3QsXHJcbiAgY29udGV4dDogQ29udGV4dFxyXG4pOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gIC8vIExhbWJkYSBDb2xsZWN0b3Ljga7jgqTjg5njg7Pjg4hcclxuICBjb25zdCBjb2xsZWN0b3JFdmVudCA9IHtcclxuICAgIG1vZGU6ICdvbi1kZW1hbmQnLFxyXG4gICAgc3RhcnRfZGF0ZTogcmVxdWVzdC5zdGFydF9kYXRlLFxyXG4gICAgZW5kX2RhdGU6IHJlcXVlc3QuZW5kX2RhdGUsXHJcbiAgfTtcclxuXHJcbiAgbG9nZ2VyLmluZm8oJ0ludm9raW5nIExhbWJkYSBDb2xsZWN0b3InLCB7XHJcbiAgICByZXF1ZXN0SWQ6IGNvbnRleHQucmVxdWVzdElkLFxyXG4gICAgZnVuY3Rpb25OYW1lOiBDT0xMRUNUT1JfRlVOQ1RJT05fTkFNRSxcclxuICAgIGV2ZW50OiBjb2xsZWN0b3JFdmVudCxcclxuICB9KTtcclxuXHJcbiAgdHJ5IHtcclxuICAgIC8vIExhbWJkYSBDb2xsZWN0b3LjgpLlkIzmnJ/jgaflkbzjgbPlh7rjgZfvvIhJbnZvY2F0aW9uVHlwZTogUmVxdWVzdFJlc3BvbnNl77yJXHJcbiAgICAvLyDjgZPjgozjgavjgojjgorjgIFDb2xsZWN0b3LjgYznlJ/miJDjgZfjgZ/lrp/pmpvjga5leGVjdXRpb25faWTjgpLlj5blvpfjgafjgY3jgb7jgZlcclxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgSW52b2tlQ29tbWFuZCh7XHJcbiAgICAgIEZ1bmN0aW9uTmFtZTogQ09MTEVDVE9SX0ZVTkNUSU9OX05BTUUsXHJcbiAgICAgIEludm9jYXRpb25UeXBlOiAnUmVxdWVzdFJlc3BvbnNlJywgLy8g5ZCM5pyf5ZG844Gz5Ye644GXXHJcbiAgICAgIFBheWxvYWQ6IEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KGNvbGxlY3RvckV2ZW50KSksXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGxhbWJkYUNsaWVudC5zZW5kKGNvbW1hbmQpO1xyXG5cclxuICAgIGxvZ2dlci5pbmZvKCdMYW1iZGEgQ29sbGVjdG9yIGludm9rZWQgc3VjY2Vzc2Z1bGx5Jywge1xyXG4gICAgICByZXF1ZXN0SWQ6IGNvbnRleHQucmVxdWVzdElkLFxyXG4gICAgICBzdGF0dXNDb2RlOiByZXNwb25zZS5TdGF0dXNDb2RlLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gTGFtYmRhIENvbGxlY3RvcuOBruODrOOCueODneODs+OCueOCkuODkeODvOOCuVxyXG4gICAgaWYgKCFyZXNwb25zZS5QYXlsb2FkKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignTGFtYmRhIENvbGxlY3RvciByZXR1cm5lZCBlbXB0eSByZXNwb25zZScpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHBheWxvYWRTdHJpbmcgPSBCdWZmZXIuZnJvbShyZXNwb25zZS5QYXlsb2FkKS50b1N0cmluZygndXRmLTgnKTtcclxuICAgIGNvbnN0IGNvbGxlY3RvclJlc3BvbnNlID0gSlNPTi5wYXJzZShwYXlsb2FkU3RyaW5nKTtcclxuXHJcbiAgICAvLyBMYW1iZGEgQ29sbGVjdG9y44GM55Sf5oiQ44GX44Gf5a6f6Zqb44GuZXhlY3V0aW9uX2lk44KS5L2/55SoXHJcbiAgICBjb25zdCBleGVjdXRpb25faWQgPSBjb2xsZWN0b3JSZXNwb25zZS5leGVjdXRpb25faWQ7XHJcblxyXG4gICAgaWYgKCFleGVjdXRpb25faWQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdMYW1iZGEgQ29sbGVjdG9yIGRpZCBub3QgcmV0dXJuIGV4ZWN1dGlvbl9pZCcpO1xyXG4gICAgfVxyXG5cclxuICAgIGxvZ2dlci5pbmZvKCdSZWNlaXZlZCBleGVjdXRpb25faWQgZnJvbSBMYW1iZGEgQ29sbGVjdG9yJywge1xyXG4gICAgICByZXF1ZXN0SWQ6IGNvbnRleHQucmVxdWVzdElkLFxyXG4gICAgICBleGVjdXRpb25faWQsXHJcbiAgICAgIHN0YXR1czogY29sbGVjdG9yUmVzcG9uc2Uuc3RhdHVzLFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGV4ZWN1dGlvbl9pZDtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgbG9nZ2VyLmVycm9yKFxyXG4gICAgICAnRmFpbGVkIHRvIGludm9rZSBMYW1iZGEgQ29sbGVjdG9yJyxcclxuICAgICAgY3JlYXRlRXJyb3JDb250ZXh0KGVycm9yIGFzIEVycm9yLCB7XHJcbiAgICAgICAgcmVxdWVzdElkOiBjb250ZXh0LnJlcXVlc3RJZCxcclxuICAgICAgICBmdW5jdGlvbk5hbWU6IENPTExFQ1RPUl9GVU5DVElPTl9OQU1FLFxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHN0YXJ0IGRhdGEgY29sbGVjdGlvbicpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOOCqOODqeODvOODrOOCueODneODs+OCueOCkueUn+aIkFxyXG4gKlxyXG4gKiBAcGFyYW0gZXJyb3IgRXJyb3JcclxuICogQHBhcmFtIHJlcXVlc3RJZCDjg6rjgq/jgqjjgrnjg4hJRFxyXG4gKiBAcmV0dXJucyBBUEkgR2F0ZXdheSBQcm94eSBSZXN1bHRcclxuICovXHJcbmZ1bmN0aW9uIHRvRXJyb3JSZXNwb25zZShlcnJvcjogRXJyb3IsIHJlcXVlc3RJZDogc3RyaW5nKTogQVBJR2F0ZXdheVByb3h5UmVzdWx0IHtcclxuICBjb25zdCBlcnJvckNvZGVNYXA6IFJlY29yZDxzdHJpbmcsIHsgc3RhdHVzQ29kZTogbnVtYmVyOyBjb2RlOiBzdHJpbmcgfT4gPSB7XHJcbiAgICBWYWxpZGF0aW9uRXJyb3I6IHsgc3RhdHVzQ29kZTogNDAwLCBjb2RlOiAnVkFMSURBVElPTl9FUlJPUicgfSxcclxuICAgIFVuYXV0aG9yaXplZEVycm9yOiB7IHN0YXR1c0NvZGU6IDQwMSwgY29kZTogJ1VOQVVUSE9SSVpFRCcgfSxcclxuICAgIEZvcmJpZGRlbkVycm9yOiB7IHN0YXR1c0NvZGU6IDQwMywgY29kZTogJ0ZPUkJJRERFTicgfSxcclxuICAgIE5vdEZvdW5kRXJyb3I6IHsgc3RhdHVzQ29kZTogNDA0LCBjb2RlOiAnTk9UX0ZPVU5EJyB9LFxyXG4gICAgQ29uZmxpY3RFcnJvcjogeyBzdGF0dXNDb2RlOiA0MDksIGNvZGU6ICdDT05GTElDVCcgfSxcclxuICAgIFJhdGVMaW1pdEVycm9yOiB7IHN0YXR1c0NvZGU6IDQyOSwgY29kZTogJ1JBVEVfTElNSVRfRVhDRUVERUQnIH0sXHJcbiAgICBJbnRlcm5hbEVycm9yOiB7IHN0YXR1c0NvZGU6IDUwMCwgY29kZTogJ0lOVEVSTkFMX0VSUk9SJyB9LFxyXG4gICAgU2VydmljZVVuYXZhaWxhYmxlRXJyb3I6IHsgc3RhdHVzQ29kZTogNTAzLCBjb2RlOiAnU0VSVklDRV9VTkFWQUlMQUJMRScgfSxcclxuICAgIEdhdGV3YXlUaW1lb3V0RXJyb3I6IHsgc3RhdHVzQ29kZTogNTA0LCBjb2RlOiAnR0FURVdBWV9USU1FT1VUJyB9LFxyXG4gIH07XHJcblxyXG4gIGNvbnN0IG1hcHBpbmcgPSBlcnJvckNvZGVNYXBbZXJyb3IubmFtZV0gfHwge1xyXG4gICAgc3RhdHVzQ29kZTogNTAwLFxyXG4gICAgY29kZTogJ0lOVEVSTkFMX0VSUk9SJyxcclxuICB9O1xyXG5cclxuICByZXR1cm4ge1xyXG4gICAgc3RhdHVzQ29kZTogbWFwcGluZy5zdGF0dXNDb2RlLFxyXG4gICAgaGVhZGVyczoge1xyXG4gICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxyXG4gICAgfSxcclxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgc3RhdHVzOiAnZXJyb3InLFxyXG4gICAgICBlcnJvcjoge1xyXG4gICAgICAgIGNvZGU6IG1hcHBpbmcuY29kZSxcclxuICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxyXG4gICAgICAgIGRldGFpbHM6IChlcnJvciBhcyBhbnkpLmRldGFpbHMgfHwge30sXHJcbiAgICAgIH0sXHJcbiAgICAgIHJlcXVlc3RfaWQ6IHJlcXVlc3RJZCxcclxuICAgIH0pLFxyXG4gIH07XHJcbn1cclxuIl0sInZlcnNpb24iOjN9