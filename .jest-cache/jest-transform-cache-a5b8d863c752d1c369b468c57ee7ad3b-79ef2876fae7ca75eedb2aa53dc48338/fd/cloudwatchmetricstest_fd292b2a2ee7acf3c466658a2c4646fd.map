{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\utils\\__tests__\\cloudwatch-metrics.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\utils\\__tests__\\cloudwatch-metrics.test.ts"],"sourcesContent":["/**\r\n * CloudWatch Metrics送信ユーティリティのテスト\r\n */\r\n\r\nimport { CloudWatchClient, PutMetricDataCommand } from '@aws-sdk/client-cloudwatch';\r\nimport { mockClient } from 'aws-sdk-client-mock';\r\nimport {\r\n  sendMetric,\r\n  sendMetrics,\r\n  sendErrorMetric,\r\n  sendSuccessMetric,\r\n} from '../cloudwatch-metrics';\r\n\r\nconst cloudwatchMock = mockClient(CloudWatchClient);\r\n\r\ndescribe('CloudWatch Metrics', () => {\r\n  beforeEach(() => {\r\n    cloudwatchMock.reset();\r\n  });\r\n\r\n  describe('sendMetric', () => {\r\n    it('should send a single metric to CloudWatch', async () => {\r\n      cloudwatchMock.on(PutMetricDataCommand).resolves({});\r\n\r\n      await sendMetric('TestMetric', 100, 'Count', {\r\n        TestDimension: 'TestValue',\r\n      });\r\n\r\n      expect(cloudwatchMock.calls()).toHaveLength(1);\r\n      const call = cloudwatchMock.call(0);\r\n      expect(call.args[0].input).toMatchObject({\r\n        Namespace: 'TDnetDataCollector',\r\n        MetricData: [\r\n          {\r\n            MetricName: 'TestMetric',\r\n            Value: 100,\r\n            Unit: 'Count',\r\n            Dimensions: [\r\n              {\r\n                Name: 'TestDimension',\r\n                Value: 'TestValue',\r\n              },\r\n            ],\r\n          },\r\n        ],\r\n      });\r\n    });\r\n\r\n    it('should send metric without dimensions', async () => {\r\n      cloudwatchMock.on(PutMetricDataCommand).resolves({});\r\n\r\n      await sendMetric('TestMetric', 50, 'Milliseconds');\r\n\r\n      expect(cloudwatchMock.calls()).toHaveLength(1);\r\n      const call = cloudwatchMock.call(0);\r\n      expect(call.args[0].input).toMatchObject({\r\n        Namespace: 'TDnetDataCollector',\r\n        MetricData: [\r\n          {\r\n            MetricName: 'TestMetric',\r\n            Value: 50,\r\n            Unit: 'Milliseconds',\r\n            Dimensions: undefined,\r\n          },\r\n        ],\r\n      });\r\n    });\r\n\r\n    it('should not throw error if CloudWatch API fails', async () => {\r\n      cloudwatchMock.on(PutMetricDataCommand).rejects(new Error('CloudWatch error'));\r\n\r\n      // メトリクス送信失敗でもエラーをスローしない\r\n      await expect(\r\n        sendMetric('TestMetric', 100, 'Count')\r\n      ).resolves.not.toThrow();\r\n    });\r\n  });\r\n\r\n  describe('sendMetrics', () => {\r\n    it('should send multiple metrics to CloudWatch', async () => {\r\n      cloudwatchMock.on(PutMetricDataCommand).resolves({});\r\n\r\n      await sendMetrics([\r\n        { name: 'Metric1', value: 10, unit: 'Count' },\r\n        { name: 'Metric2', value: 20, unit: 'Milliseconds' },\r\n        { name: 'Metric3', value: 30 },\r\n      ]);\r\n\r\n      expect(cloudwatchMock.calls()).toHaveLength(1);\r\n      const call = cloudwatchMock.call(0);\r\n      const input = call.args[0].input as any;\r\n      expect(input.MetricData).toHaveLength(3);\r\n      expect(input.MetricData[0]).toMatchObject({\r\n        MetricName: 'Metric1',\r\n        Value: 10,\r\n        Unit: 'Count',\r\n      });\r\n      expect(input.MetricData[1]).toMatchObject({\r\n        MetricName: 'Metric2',\r\n        Value: 20,\r\n        Unit: 'Milliseconds',\r\n      });\r\n      expect(input.MetricData[2]).toMatchObject({\r\n        MetricName: 'Metric3',\r\n        Value: 30,\r\n        Unit: 'Count',\r\n      });\r\n    });\r\n\r\n    it('should send metrics with dimensions', async () => {\r\n      cloudwatchMock.on(PutMetricDataCommand).resolves({});\r\n\r\n      await sendMetrics([\r\n        {\r\n          name: 'Metric1',\r\n          value: 10,\r\n          dimensions: { Dimension1: 'Value1' },\r\n        },\r\n        {\r\n          name: 'Metric2',\r\n          value: 20,\r\n          dimensions: { Dimension2: 'Value2' },\r\n        },\r\n      ]);\r\n\r\n      expect(cloudwatchMock.calls()).toHaveLength(1);\r\n      const call = cloudwatchMock.call(0);\r\n      const input = call.args[0].input as any;\r\n      expect(input.MetricData[0].Dimensions).toEqual([\r\n        { Name: 'Dimension1', Value: 'Value1' },\r\n      ]);\r\n      expect(input.MetricData[1].Dimensions).toEqual([\r\n        { Name: 'Dimension2', Value: 'Value2' },\r\n      ]);\r\n    });\r\n  });\r\n\r\n  describe('sendErrorMetric', () => {\r\n    it('should send error metric with correct dimensions', async () => {\r\n      cloudwatchMock.on(PutMetricDataCommand).resolves({});\r\n\r\n      await sendErrorMetric('NetworkError', 'Collector', {\r\n        Date: '2024-01-15',\r\n      });\r\n\r\n      expect(cloudwatchMock.calls()).toHaveLength(1);\r\n      const call = cloudwatchMock.call(0);\r\n      expect(call.args[0].input).toMatchObject({\r\n        Namespace: 'TDnetDataCollector',\r\n        MetricData: [\r\n          {\r\n            MetricName: 'LambdaError',\r\n            Value: 1,\r\n            Unit: 'Count',\r\n            Dimensions: [\r\n              { Name: 'ErrorType', Value: 'NetworkError' },\r\n              { Name: 'FunctionName', Value: 'Collector' },\r\n              { Name: 'Date', Value: '2024-01-15' },\r\n            ],\r\n          },\r\n        ],\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('sendSuccessMetric', () => {\r\n    it('should send success metric with correct dimensions', async () => {\r\n      cloudwatchMock.on(PutMetricDataCommand).resolves({});\r\n\r\n      await sendSuccessMetric(10, 'Collector', {\r\n        Date: '2024-01-15',\r\n      });\r\n\r\n      expect(cloudwatchMock.calls()).toHaveLength(1);\r\n      const call = cloudwatchMock.call(0);\r\n      expect(call.args[0].input).toMatchObject({\r\n        Namespace: 'TDnetDataCollector',\r\n        MetricData: [\r\n          {\r\n            MetricName: 'OperationSuccess',\r\n            Value: 10,\r\n            Unit: 'Count',\r\n            Dimensions: [\r\n              { Name: 'FunctionName', Value: 'Collector' },\r\n              { Name: 'Date', Value: '2024-01-15' },\r\n            ],\r\n          },\r\n        ],\r\n      });\r\n    });\r\n  });\r\n});\r\n"],"version":3}