3b6c91edcb80ecd81740c628985db556
"use strict";
/**
 * CloudWatch Metrics送信ユーティリティのテスト
 */
Object.defineProperty(exports, "__esModule", { value: true });
const client_cloudwatch_1 = require("@aws-sdk/client-cloudwatch");
const aws_sdk_client_mock_1 = require("aws-sdk-client-mock");
const cloudwatch_metrics_1 = require("../cloudwatch-metrics");
const cloudwatchMock = (0, aws_sdk_client_mock_1.mockClient)(client_cloudwatch_1.CloudWatchClient);
describe('CloudWatch Metrics', () => {
    beforeEach(() => {
        cloudwatchMock.reset();
    });
    describe('sendMetric', () => {
        it('should send a single metric to CloudWatch', async () => {
            cloudwatchMock.on(client_cloudwatch_1.PutMetricDataCommand).resolves({});
            await (0, cloudwatch_metrics_1.sendMetric)('TestMetric', 100, 'Count', {
                TestDimension: 'TestValue',
            });
            expect(cloudwatchMock.calls()).toHaveLength(1);
            const call = cloudwatchMock.call(0);
            expect(call.args[0].input).toMatchObject({
                Namespace: 'TDnetDataCollector',
                MetricData: [
                    {
                        MetricName: 'TestMetric',
                        Value: 100,
                        Unit: 'Count',
                        Dimensions: [
                            {
                                Name: 'TestDimension',
                                Value: 'TestValue',
                            },
                        ],
                    },
                ],
            });
        });
        it('should send metric without dimensions', async () => {
            cloudwatchMock.on(client_cloudwatch_1.PutMetricDataCommand).resolves({});
            await (0, cloudwatch_metrics_1.sendMetric)('TestMetric', 50, 'Milliseconds');
            expect(cloudwatchMock.calls()).toHaveLength(1);
            const call = cloudwatchMock.call(0);
            expect(call.args[0].input).toMatchObject({
                Namespace: 'TDnetDataCollector',
                MetricData: [
                    {
                        MetricName: 'TestMetric',
                        Value: 50,
                        Unit: 'Milliseconds',
                        Dimensions: undefined,
                    },
                ],
            });
        });
        it('should not throw error if CloudWatch API fails', async () => {
            cloudwatchMock.on(client_cloudwatch_1.PutMetricDataCommand).rejects(new Error('CloudWatch error'));
            // メトリクス送信失敗でもエラーをスローしない
            await expect((0, cloudwatch_metrics_1.sendMetric)('TestMetric', 100, 'Count')).resolves.not.toThrow();
        });
    });
    describe('sendMetrics', () => {
        it('should send multiple metrics to CloudWatch', async () => {
            cloudwatchMock.on(client_cloudwatch_1.PutMetricDataCommand).resolves({});
            await (0, cloudwatch_metrics_1.sendMetrics)([
                { name: 'Metric1', value: 10, unit: 'Count' },
                { name: 'Metric2', value: 20, unit: 'Milliseconds' },
                { name: 'Metric3', value: 30 },
            ]);
            expect(cloudwatchMock.calls()).toHaveLength(1);
            const call = cloudwatchMock.call(0);
            const input = call.args[0].input;
            expect(input.MetricData).toHaveLength(3);
            expect(input.MetricData[0]).toMatchObject({
                MetricName: 'Metric1',
                Value: 10,
                Unit: 'Count',
            });
            expect(input.MetricData[1]).toMatchObject({
                MetricName: 'Metric2',
                Value: 20,
                Unit: 'Milliseconds',
            });
            expect(input.MetricData[2]).toMatchObject({
                MetricName: 'Metric3',
                Value: 30,
                Unit: 'Count',
            });
        });
        it('should send metrics with dimensions', async () => {
            cloudwatchMock.on(client_cloudwatch_1.PutMetricDataCommand).resolves({});
            await (0, cloudwatch_metrics_1.sendMetrics)([
                {
                    name: 'Metric1',
                    value: 10,
                    dimensions: { Dimension1: 'Value1' },
                },
                {
                    name: 'Metric2',
                    value: 20,
                    dimensions: { Dimension2: 'Value2' },
                },
            ]);
            expect(cloudwatchMock.calls()).toHaveLength(1);
            const call = cloudwatchMock.call(0);
            const input = call.args[0].input;
            expect(input.MetricData[0].Dimensions).toEqual([
                { Name: 'Dimension1', Value: 'Value1' },
            ]);
            expect(input.MetricData[1].Dimensions).toEqual([
                { Name: 'Dimension2', Value: 'Value2' },
            ]);
        });
    });
    describe('sendErrorMetric', () => {
        it('should send error metric with correct dimensions', async () => {
            cloudwatchMock.on(client_cloudwatch_1.PutMetricDataCommand).resolves({});
            await (0, cloudwatch_metrics_1.sendErrorMetric)('NetworkError', 'Collector', {
                Date: '2024-01-15',
            });
            expect(cloudwatchMock.calls()).toHaveLength(1);
            const call = cloudwatchMock.call(0);
            expect(call.args[0].input).toMatchObject({
                Namespace: 'TDnetDataCollector',
                MetricData: [
                    {
                        MetricName: 'LambdaError',
                        Value: 1,
                        Unit: 'Count',
                        Dimensions: [
                            { Name: 'ErrorType', Value: 'NetworkError' },
                            { Name: 'FunctionName', Value: 'Collector' },
                            { Name: 'Date', Value: '2024-01-15' },
                        ],
                    },
                ],
            });
        });
    });
    describe('sendSuccessMetric', () => {
        it('should send success metric with correct dimensions', async () => {
            cloudwatchMock.on(client_cloudwatch_1.PutMetricDataCommand).resolves({});
            await (0, cloudwatch_metrics_1.sendSuccessMetric)(10, 'Collector', {
                Date: '2024-01-15',
            });
            expect(cloudwatchMock.calls()).toHaveLength(1);
            const call = cloudwatchMock.call(0);
            expect(call.args[0].input).toMatchObject({
                Namespace: 'TDnetDataCollector',
                MetricData: [
                    {
                        MetricName: 'OperationSuccess',
                        Value: 10,
                        Unit: 'Count',
                        Dimensions: [
                            { Name: 'FunctionName', Value: 'Collector' },
                            { Name: 'Date', Value: '2024-01-15' },
                        ],
                    },
                ],
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFx1dGlsc1xcX190ZXN0c19fXFxjbG91ZHdhdGNoLW1ldHJpY3MudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsa0VBQW9GO0FBQ3BGLDZEQUFpRDtBQUNqRCw4REFLK0I7QUFFL0IsTUFBTSxjQUFjLEdBQUcsSUFBQSxnQ0FBVSxFQUFDLG9DQUFnQixDQUFDLENBQUM7QUFFcEQsUUFBUSxDQUFDLG9CQUFvQixFQUFFLEdBQUcsRUFBRTtJQUNsQyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsY0FBYyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3pCLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUU7UUFDMUIsRUFBRSxDQUFDLDJDQUEyQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3pELGNBQWMsQ0FBQyxFQUFFLENBQUMsd0NBQW9CLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7WUFFckQsTUFBTSxJQUFBLCtCQUFVLEVBQUMsWUFBWSxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUU7Z0JBQzNDLGFBQWEsRUFBRSxXQUFXO2FBQzNCLENBQUMsQ0FBQztZQUVILE1BQU0sQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDL0MsTUFBTSxJQUFJLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxhQUFhLENBQUM7Z0JBQ3ZDLFNBQVMsRUFBRSxvQkFBb0I7Z0JBQy9CLFVBQVUsRUFBRTtvQkFDVjt3QkFDRSxVQUFVLEVBQUUsWUFBWTt3QkFDeEIsS0FBSyxFQUFFLEdBQUc7d0JBQ1YsSUFBSSxFQUFFLE9BQU87d0JBQ2IsVUFBVSxFQUFFOzRCQUNWO2dDQUNFLElBQUksRUFBRSxlQUFlO2dDQUNyQixLQUFLLEVBQUUsV0FBVzs2QkFDbkI7eUJBQ0Y7cUJBQ0Y7aUJBQ0Y7YUFDRixDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyx1Q0FBdUMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNyRCxjQUFjLENBQUMsRUFBRSxDQUFDLHdDQUFvQixDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRXJELE1BQU0sSUFBQSwrQkFBVSxFQUFDLFlBQVksRUFBRSxFQUFFLEVBQUUsY0FBYyxDQUFDLENBQUM7WUFFbkQsTUFBTSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQyxNQUFNLElBQUksR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLGFBQWEsQ0FBQztnQkFDdkMsU0FBUyxFQUFFLG9CQUFvQjtnQkFDL0IsVUFBVSxFQUFFO29CQUNWO3dCQUNFLFVBQVUsRUFBRSxZQUFZO3dCQUN4QixLQUFLLEVBQUUsRUFBRTt3QkFDVCxJQUFJLEVBQUUsY0FBYzt3QkFDcEIsVUFBVSxFQUFFLFNBQVM7cUJBQ3RCO2lCQUNGO2FBQ0YsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsZ0RBQWdELEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDOUQsY0FBYyxDQUFDLEVBQUUsQ0FBQyx3Q0FBb0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7WUFFL0Usd0JBQXdCO1lBQ3hCLE1BQU0sTUFBTSxDQUNWLElBQUEsK0JBQVUsRUFBQyxZQUFZLEVBQUUsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUN2QyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO1FBQzNCLEVBQUUsQ0FBQyw0Q0FBNEMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUMxRCxjQUFjLENBQUMsRUFBRSxDQUFDLHdDQUFvQixDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRXJELE1BQU0sSUFBQSxnQ0FBVyxFQUFDO2dCQUNoQixFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFO2dCQUM3QyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFO2dCQUNwRCxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRTthQUMvQixDQUFDLENBQUM7WUFFSCxNQUFNLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sSUFBSSxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFZLENBQUM7WUFDeEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDekMsTUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUM7Z0JBQ3hDLFVBQVUsRUFBRSxTQUFTO2dCQUNyQixLQUFLLEVBQUUsRUFBRTtnQkFDVCxJQUFJLEVBQUUsT0FBTzthQUNkLENBQUMsQ0FBQztZQUNILE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDO2dCQUN4QyxVQUFVLEVBQUUsU0FBUztnQkFDckIsS0FBSyxFQUFFLEVBQUU7Z0JBQ1QsSUFBSSxFQUFFLGNBQWM7YUFDckIsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUM7Z0JBQ3hDLFVBQVUsRUFBRSxTQUFTO2dCQUNyQixLQUFLLEVBQUUsRUFBRTtnQkFDVCxJQUFJLEVBQUUsT0FBTzthQUNkLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHFDQUFxQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ25ELGNBQWMsQ0FBQyxFQUFFLENBQUMsd0NBQW9CLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7WUFFckQsTUFBTSxJQUFBLGdDQUFXLEVBQUM7Z0JBQ2hCO29CQUNFLElBQUksRUFBRSxTQUFTO29CQUNmLEtBQUssRUFBRSxFQUFFO29CQUNULFVBQVUsRUFBRSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUU7aUJBQ3JDO2dCQUNEO29CQUNFLElBQUksRUFBRSxTQUFTO29CQUNmLEtBQUssRUFBRSxFQUFFO29CQUNULFVBQVUsRUFBRSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUU7aUJBQ3JDO2FBQ0YsQ0FBQyxDQUFDO1lBRUgsTUFBTSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQyxNQUFNLElBQUksR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBWSxDQUFDO1lBQ3hDLE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLE9BQU8sQ0FBQztnQkFDN0MsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUU7YUFDeEMsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsT0FBTyxDQUFDO2dCQUM3QyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRTthQUN4QyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsRUFBRTtRQUMvQixFQUFFLENBQUMsa0RBQWtELEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDaEUsY0FBYyxDQUFDLEVBQUUsQ0FBQyx3Q0FBb0IsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUVyRCxNQUFNLElBQUEsb0NBQWUsRUFBQyxjQUFjLEVBQUUsV0FBVyxFQUFFO2dCQUNqRCxJQUFJLEVBQUUsWUFBWTthQUNuQixDQUFDLENBQUM7WUFFSCxNQUFNLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sSUFBSSxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsYUFBYSxDQUFDO2dCQUN2QyxTQUFTLEVBQUUsb0JBQW9CO2dCQUMvQixVQUFVLEVBQUU7b0JBQ1Y7d0JBQ0UsVUFBVSxFQUFFLGFBQWE7d0JBQ3pCLEtBQUssRUFBRSxDQUFDO3dCQUNSLElBQUksRUFBRSxPQUFPO3dCQUNiLFVBQVUsRUFBRTs0QkFDVixFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLGNBQWMsRUFBRTs0QkFDNUMsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUU7NEJBQzVDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFO3lCQUN0QztxQkFDRjtpQkFDRjthQUNGLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO1FBQ2pDLEVBQUUsQ0FBQyxvREFBb0QsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNsRSxjQUFjLENBQUMsRUFBRSxDQUFDLHdDQUFvQixDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRXJELE1BQU0sSUFBQSxzQ0FBaUIsRUFBQyxFQUFFLEVBQUUsV0FBVyxFQUFFO2dCQUN2QyxJQUFJLEVBQUUsWUFBWTthQUNuQixDQUFDLENBQUM7WUFFSCxNQUFNLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sSUFBSSxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsYUFBYSxDQUFDO2dCQUN2QyxTQUFTLEVBQUUsb0JBQW9CO2dCQUMvQixVQUFVLEVBQUU7b0JBQ1Y7d0JBQ0UsVUFBVSxFQUFFLGtCQUFrQjt3QkFDOUIsS0FBSyxFQUFFLEVBQUU7d0JBQ1QsSUFBSSxFQUFFLE9BQU87d0JBQ2IsVUFBVSxFQUFFOzRCQUNWLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFOzRCQUM1QyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRTt5QkFDdEM7cUJBQ0Y7aUJBQ0Y7YUFDRixDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFx1dGlsc1xcX190ZXN0c19fXFxjbG91ZHdhdGNoLW1ldHJpY3MudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ2xvdWRXYXRjaCBNZXRyaWNz6YCB5L+h44Om44O844OG44Kj44Oq44OG44Kj44Gu44OG44K544OIXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgQ2xvdWRXYXRjaENsaWVudCwgUHV0TWV0cmljRGF0YUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtY2xvdWR3YXRjaCc7XHJcbmltcG9ydCB7IG1vY2tDbGllbnQgfSBmcm9tICdhd3Mtc2RrLWNsaWVudC1tb2NrJztcclxuaW1wb3J0IHtcclxuICBzZW5kTWV0cmljLFxyXG4gIHNlbmRNZXRyaWNzLFxyXG4gIHNlbmRFcnJvck1ldHJpYyxcclxuICBzZW5kU3VjY2Vzc01ldHJpYyxcclxufSBmcm9tICcuLi9jbG91ZHdhdGNoLW1ldHJpY3MnO1xyXG5cclxuY29uc3QgY2xvdWR3YXRjaE1vY2sgPSBtb2NrQ2xpZW50KENsb3VkV2F0Y2hDbGllbnQpO1xyXG5cclxuZGVzY3JpYmUoJ0Nsb3VkV2F0Y2ggTWV0cmljcycsICgpID0+IHtcclxuICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgIGNsb3Vkd2F0Y2hNb2NrLnJlc2V0KCk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdzZW5kTWV0cmljJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBzZW5kIGEgc2luZ2xlIG1ldHJpYyB0byBDbG91ZFdhdGNoJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjbG91ZHdhdGNoTW9jay5vbihQdXRNZXRyaWNEYXRhQ29tbWFuZCkucmVzb2x2ZXMoe30pO1xyXG5cclxuICAgICAgYXdhaXQgc2VuZE1ldHJpYygnVGVzdE1ldHJpYycsIDEwMCwgJ0NvdW50Jywge1xyXG4gICAgICAgIFRlc3REaW1lbnNpb246ICdUZXN0VmFsdWUnLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGV4cGVjdChjbG91ZHdhdGNoTW9jay5jYWxscygpKS50b0hhdmVMZW5ndGgoMSk7XHJcbiAgICAgIGNvbnN0IGNhbGwgPSBjbG91ZHdhdGNoTW9jay5jYWxsKDApO1xyXG4gICAgICBleHBlY3QoY2FsbC5hcmdzWzBdLmlucHV0KS50b01hdGNoT2JqZWN0KHtcclxuICAgICAgICBOYW1lc3BhY2U6ICdURG5ldERhdGFDb2xsZWN0b3InLFxyXG4gICAgICAgIE1ldHJpY0RhdGE6IFtcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgTWV0cmljTmFtZTogJ1Rlc3RNZXRyaWMnLFxyXG4gICAgICAgICAgICBWYWx1ZTogMTAwLFxyXG4gICAgICAgICAgICBVbml0OiAnQ291bnQnLFxyXG4gICAgICAgICAgICBEaW1lbnNpb25zOiBbXHJcbiAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgTmFtZTogJ1Rlc3REaW1lbnNpb24nLFxyXG4gICAgICAgICAgICAgICAgVmFsdWU6ICdUZXN0VmFsdWUnLFxyXG4gICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIF0sXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBzZW5kIG1ldHJpYyB3aXRob3V0IGRpbWVuc2lvbnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNsb3Vkd2F0Y2hNb2NrLm9uKFB1dE1ldHJpY0RhdGFDb21tYW5kKS5yZXNvbHZlcyh7fSk7XHJcblxyXG4gICAgICBhd2FpdCBzZW5kTWV0cmljKCdUZXN0TWV0cmljJywgNTAsICdNaWxsaXNlY29uZHMnKTtcclxuXHJcbiAgICAgIGV4cGVjdChjbG91ZHdhdGNoTW9jay5jYWxscygpKS50b0hhdmVMZW5ndGgoMSk7XHJcbiAgICAgIGNvbnN0IGNhbGwgPSBjbG91ZHdhdGNoTW9jay5jYWxsKDApO1xyXG4gICAgICBleHBlY3QoY2FsbC5hcmdzWzBdLmlucHV0KS50b01hdGNoT2JqZWN0KHtcclxuICAgICAgICBOYW1lc3BhY2U6ICdURG5ldERhdGFDb2xsZWN0b3InLFxyXG4gICAgICAgIE1ldHJpY0RhdGE6IFtcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgTWV0cmljTmFtZTogJ1Rlc3RNZXRyaWMnLFxyXG4gICAgICAgICAgICBWYWx1ZTogNTAsXHJcbiAgICAgICAgICAgIFVuaXQ6ICdNaWxsaXNlY29uZHMnLFxyXG4gICAgICAgICAgICBEaW1lbnNpb25zOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIF0sXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBub3QgdGhyb3cgZXJyb3IgaWYgQ2xvdWRXYXRjaCBBUEkgZmFpbHMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNsb3Vkd2F0Y2hNb2NrLm9uKFB1dE1ldHJpY0RhdGFDb21tYW5kKS5yZWplY3RzKG5ldyBFcnJvcignQ2xvdWRXYXRjaCBlcnJvcicpKTtcclxuXHJcbiAgICAgIC8vIOODoeODiOODquOCr+OCuemAgeS/oeWkseaVl+OBp+OCguOCqOODqeODvOOCkuOCueODreODvOOBl+OBquOBhFxyXG4gICAgICBhd2FpdCBleHBlY3QoXHJcbiAgICAgICAgc2VuZE1ldHJpYygnVGVzdE1ldHJpYycsIDEwMCwgJ0NvdW50JylcclxuICAgICAgKS5yZXNvbHZlcy5ub3QudG9UaHJvdygpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdzZW5kTWV0cmljcycsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgc2VuZCBtdWx0aXBsZSBtZXRyaWNzIHRvIENsb3VkV2F0Y2gnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNsb3Vkd2F0Y2hNb2NrLm9uKFB1dE1ldHJpY0RhdGFDb21tYW5kKS5yZXNvbHZlcyh7fSk7XHJcblxyXG4gICAgICBhd2FpdCBzZW5kTWV0cmljcyhbXHJcbiAgICAgICAgeyBuYW1lOiAnTWV0cmljMScsIHZhbHVlOiAxMCwgdW5pdDogJ0NvdW50JyB9LFxyXG4gICAgICAgIHsgbmFtZTogJ01ldHJpYzInLCB2YWx1ZTogMjAsIHVuaXQ6ICdNaWxsaXNlY29uZHMnIH0sXHJcbiAgICAgICAgeyBuYW1lOiAnTWV0cmljMycsIHZhbHVlOiAzMCB9LFxyXG4gICAgICBdKTtcclxuXHJcbiAgICAgIGV4cGVjdChjbG91ZHdhdGNoTW9jay5jYWxscygpKS50b0hhdmVMZW5ndGgoMSk7XHJcbiAgICAgIGNvbnN0IGNhbGwgPSBjbG91ZHdhdGNoTW9jay5jYWxsKDApO1xyXG4gICAgICBjb25zdCBpbnB1dCA9IGNhbGwuYXJnc1swXS5pbnB1dCBhcyBhbnk7XHJcbiAgICAgIGV4cGVjdChpbnB1dC5NZXRyaWNEYXRhKS50b0hhdmVMZW5ndGgoMyk7XHJcbiAgICAgIGV4cGVjdChpbnB1dC5NZXRyaWNEYXRhWzBdKS50b01hdGNoT2JqZWN0KHtcclxuICAgICAgICBNZXRyaWNOYW1lOiAnTWV0cmljMScsXHJcbiAgICAgICAgVmFsdWU6IDEwLFxyXG4gICAgICAgIFVuaXQ6ICdDb3VudCcsXHJcbiAgICAgIH0pO1xyXG4gICAgICBleHBlY3QoaW5wdXQuTWV0cmljRGF0YVsxXSkudG9NYXRjaE9iamVjdCh7XHJcbiAgICAgICAgTWV0cmljTmFtZTogJ01ldHJpYzInLFxyXG4gICAgICAgIFZhbHVlOiAyMCxcclxuICAgICAgICBVbml0OiAnTWlsbGlzZWNvbmRzJyxcclxuICAgICAgfSk7XHJcbiAgICAgIGV4cGVjdChpbnB1dC5NZXRyaWNEYXRhWzJdKS50b01hdGNoT2JqZWN0KHtcclxuICAgICAgICBNZXRyaWNOYW1lOiAnTWV0cmljMycsXHJcbiAgICAgICAgVmFsdWU6IDMwLFxyXG4gICAgICAgIFVuaXQ6ICdDb3VudCcsXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBzZW5kIG1ldHJpY3Mgd2l0aCBkaW1lbnNpb25zJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjbG91ZHdhdGNoTW9jay5vbihQdXRNZXRyaWNEYXRhQ29tbWFuZCkucmVzb2x2ZXMoe30pO1xyXG5cclxuICAgICAgYXdhaXQgc2VuZE1ldHJpY3MoW1xyXG4gICAgICAgIHtcclxuICAgICAgICAgIG5hbWU6ICdNZXRyaWMxJyxcclxuICAgICAgICAgIHZhbHVlOiAxMCxcclxuICAgICAgICAgIGRpbWVuc2lvbnM6IHsgRGltZW5zaW9uMTogJ1ZhbHVlMScgfSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIG5hbWU6ICdNZXRyaWMyJyxcclxuICAgICAgICAgIHZhbHVlOiAyMCxcclxuICAgICAgICAgIGRpbWVuc2lvbnM6IHsgRGltZW5zaW9uMjogJ1ZhbHVlMicgfSxcclxuICAgICAgICB9LFxyXG4gICAgICBdKTtcclxuXHJcbiAgICAgIGV4cGVjdChjbG91ZHdhdGNoTW9jay5jYWxscygpKS50b0hhdmVMZW5ndGgoMSk7XHJcbiAgICAgIGNvbnN0IGNhbGwgPSBjbG91ZHdhdGNoTW9jay5jYWxsKDApO1xyXG4gICAgICBjb25zdCBpbnB1dCA9IGNhbGwuYXJnc1swXS5pbnB1dCBhcyBhbnk7XHJcbiAgICAgIGV4cGVjdChpbnB1dC5NZXRyaWNEYXRhWzBdLkRpbWVuc2lvbnMpLnRvRXF1YWwoW1xyXG4gICAgICAgIHsgTmFtZTogJ0RpbWVuc2lvbjEnLCBWYWx1ZTogJ1ZhbHVlMScgfSxcclxuICAgICAgXSk7XHJcbiAgICAgIGV4cGVjdChpbnB1dC5NZXRyaWNEYXRhWzFdLkRpbWVuc2lvbnMpLnRvRXF1YWwoW1xyXG4gICAgICAgIHsgTmFtZTogJ0RpbWVuc2lvbjInLCBWYWx1ZTogJ1ZhbHVlMicgfSxcclxuICAgICAgXSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ3NlbmRFcnJvck1ldHJpYycsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgc2VuZCBlcnJvciBtZXRyaWMgd2l0aCBjb3JyZWN0IGRpbWVuc2lvbnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNsb3Vkd2F0Y2hNb2NrLm9uKFB1dE1ldHJpY0RhdGFDb21tYW5kKS5yZXNvbHZlcyh7fSk7XHJcblxyXG4gICAgICBhd2FpdCBzZW5kRXJyb3JNZXRyaWMoJ05ldHdvcmtFcnJvcicsICdDb2xsZWN0b3InLCB7XHJcbiAgICAgICAgRGF0ZTogJzIwMjQtMDEtMTUnLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGV4cGVjdChjbG91ZHdhdGNoTW9jay5jYWxscygpKS50b0hhdmVMZW5ndGgoMSk7XHJcbiAgICAgIGNvbnN0IGNhbGwgPSBjbG91ZHdhdGNoTW9jay5jYWxsKDApO1xyXG4gICAgICBleHBlY3QoY2FsbC5hcmdzWzBdLmlucHV0KS50b01hdGNoT2JqZWN0KHtcclxuICAgICAgICBOYW1lc3BhY2U6ICdURG5ldERhdGFDb2xsZWN0b3InLFxyXG4gICAgICAgIE1ldHJpY0RhdGE6IFtcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgTWV0cmljTmFtZTogJ0xhbWJkYUVycm9yJyxcclxuICAgICAgICAgICAgVmFsdWU6IDEsXHJcbiAgICAgICAgICAgIFVuaXQ6ICdDb3VudCcsXHJcbiAgICAgICAgICAgIERpbWVuc2lvbnM6IFtcclxuICAgICAgICAgICAgICB7IE5hbWU6ICdFcnJvclR5cGUnLCBWYWx1ZTogJ05ldHdvcmtFcnJvcicgfSxcclxuICAgICAgICAgICAgICB7IE5hbWU6ICdGdW5jdGlvbk5hbWUnLCBWYWx1ZTogJ0NvbGxlY3RvcicgfSxcclxuICAgICAgICAgICAgICB7IE5hbWU6ICdEYXRlJywgVmFsdWU6ICcyMDI0LTAxLTE1JyB9LFxyXG4gICAgICAgICAgICBdLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICBdLFxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnc2VuZFN1Y2Nlc3NNZXRyaWMnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHNlbmQgc3VjY2VzcyBtZXRyaWMgd2l0aCBjb3JyZWN0IGRpbWVuc2lvbnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNsb3Vkd2F0Y2hNb2NrLm9uKFB1dE1ldHJpY0RhdGFDb21tYW5kKS5yZXNvbHZlcyh7fSk7XHJcblxyXG4gICAgICBhd2FpdCBzZW5kU3VjY2Vzc01ldHJpYygxMCwgJ0NvbGxlY3RvcicsIHtcclxuICAgICAgICBEYXRlOiAnMjAyNC0wMS0xNScsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgZXhwZWN0KGNsb3Vkd2F0Y2hNb2NrLmNhbGxzKCkpLnRvSGF2ZUxlbmd0aCgxKTtcclxuICAgICAgY29uc3QgY2FsbCA9IGNsb3Vkd2F0Y2hNb2NrLmNhbGwoMCk7XHJcbiAgICAgIGV4cGVjdChjYWxsLmFyZ3NbMF0uaW5wdXQpLnRvTWF0Y2hPYmplY3Qoe1xyXG4gICAgICAgIE5hbWVzcGFjZTogJ1REbmV0RGF0YUNvbGxlY3RvcicsXHJcbiAgICAgICAgTWV0cmljRGF0YTogW1xyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICBNZXRyaWNOYW1lOiAnT3BlcmF0aW9uU3VjY2VzcycsXHJcbiAgICAgICAgICAgIFZhbHVlOiAxMCxcclxuICAgICAgICAgICAgVW5pdDogJ0NvdW50JyxcclxuICAgICAgICAgICAgRGltZW5zaW9uczogW1xyXG4gICAgICAgICAgICAgIHsgTmFtZTogJ0Z1bmN0aW9uTmFtZScsIFZhbHVlOiAnQ29sbGVjdG9yJyB9LFxyXG4gICAgICAgICAgICAgIHsgTmFtZTogJ0RhdGUnLCBWYWx1ZTogJzIwMjQtMDEtMTUnIH0sXHJcbiAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIF0sXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcbn0pO1xyXG4iXSwidmVyc2lvbiI6M30=