{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\handler.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\handler.ts"],"sourcesContent":["/**\r\n * Lambda Collector Handler\r\n *\r\n * TDnet開示情報を収集するLambda関数のメインハンドラー。\r\n * バッチモード（日次自動実行）とオンデマンドモード（手動実行）をサポート。\r\n *\r\n * Requirements: 要件1.1, 1.2, 5.1, 5.2\r\n */\r\n\r\nimport { Context } from 'aws-lambda';\r\nimport { logger, createErrorContext } from '../../utils/logger';\r\nimport { sendErrorMetric, sendMetrics } from '../../utils/cloudwatch-metrics';\r\nimport {\r\n  sendDisclosuresCollectedMetric,\r\n  sendDisclosuresFailedMetric,\r\n  sendCollectionSuccessRateMetric,\r\n} from '../../utils/metrics';\r\nimport { ValidationError } from '../../errors';\r\nimport { scrapeTdnetList } from './scrape-tdnet-list';\r\nimport { downloadPdf } from './download-pdf';\r\nimport { saveMetadata } from './save-metadata';\r\nimport { updateExecutionStatus } from './update-execution-status';\r\nimport { generateDisclosureId } from '../../utils/disclosure-id';\r\nimport { Disclosure } from '../../types';\r\nimport { DisclosureMetadata } from '../../scraper/html-parser';\r\n\r\n/**\r\n * Lambda Collectorイベント\r\n */\r\nexport interface CollectorEvent {\r\n  /** モード（batch: 日次バッチ、on-demand: オンデマンド） */\r\n  mode: 'batch' | 'on-demand';\r\n\r\n  /** 開始日（ISO 8601形式、YYYY-MM-DD）- on-demandモードで必須 */\r\n  start_date?: string;\r\n\r\n  /** 終了日（ISO 8601形式、YYYY-MM-DD）- on-demandモードで必須 */\r\n  end_date?: string;\r\n}\r\n\r\n/**\r\n * Lambda Collectorレスポンス\r\n */\r\nexport interface CollectorResponse {\r\n  /** 実行ID */\r\n  execution_id: string;\r\n\r\n  /** 状態 */\r\n  status: 'success' | 'partial_success' | 'failed';\r\n\r\n  /** メッセージ */\r\n  message: string;\r\n\r\n  /** 収集成功件数 */\r\n  collected_count: number;\r\n\r\n  /** 収集失敗件数 */\r\n  failed_count: number;\r\n}\r\n\r\n/**\r\n * Lambda Collectorハンドラー\r\n *\r\n * @param event CollectorEvent\r\n * @param context Lambda Context\r\n * @returns CollectorResponse\r\n *\r\n * @example\r\n * ```typescript\r\n * // バッチモード（前日のデータを収集）\r\n * const response = await handler({ mode: 'batch' }, context);\r\n *\r\n * // オンデマンドモード（指定期間のデータを収集）\r\n * const response = await handler({\r\n *   mode: 'on-demand',\r\n *   start_date: '2024-01-15',\r\n *   end_date: '2024-01-20',\r\n * }, context);\r\n * ```\r\n */\r\nexport async function handler(\r\n  event: CollectorEvent,\r\n  context: Context\r\n): Promise<CollectorResponse> {\r\n  const execution_id = generateExecutionId(context);\r\n  const startTime = Date.now();\r\n\r\n  try {\r\n    logger.info('Lambda Collector started', {\r\n      event,\r\n      execution_id,\r\n      request_id: context.awsRequestId,\r\n      function_name: context.functionName,\r\n    });\r\n\r\n    // イベントのバリデーション\r\n    validateEvent(event);\r\n\r\n    // モード別処理\r\n    let response: CollectorResponse;\r\n    if (event.mode === 'batch') {\r\n      response = await handleBatchMode(execution_id);\r\n    } else {\r\n      response = await handleOnDemandMode(\r\n        execution_id,\r\n        event.start_date!,\r\n        event.end_date!\r\n      );\r\n    }\r\n\r\n    const duration = Date.now() - startTime;\r\n\r\n    logger.info('Lambda Collector completed', {\r\n      execution_id,\r\n      status: response.status,\r\n      collected_count: response.collected_count,\r\n      failed_count: response.failed_count,\r\n      duration_ms: duration,\r\n    });\r\n\r\n    // カスタムメトリクス送信（タスク16.2）\r\n    const totalCount = response.collected_count + response.failed_count;\r\n    const successRate = totalCount > 0 \r\n      ? (response.collected_count / totalCount) * 100 \r\n      : 0;\r\n\r\n    await Promise.all([\r\n      // 収集成功件数\r\n      sendDisclosuresCollectedMetric(response.collected_count, context.functionName),\r\n      // 収集失敗件数\r\n      sendDisclosuresFailedMetric(response.failed_count, context.functionName),\r\n      // 収集成功率\r\n      sendCollectionSuccessRateMetric(successRate, context.functionName),\r\n      // 実行時間メトリクス（既存）\r\n      sendMetrics([\r\n        {\r\n          name: 'LambdaExecutionTime',\r\n          value: duration,\r\n          unit: 'Milliseconds',\r\n          dimensions: { FunctionName: 'Collector', Mode: event.mode },\r\n        },\r\n      ]),\r\n    ]);\r\n\r\n    return response;\r\n  } catch (error) {\r\n    const duration = Date.now() - startTime;\r\n\r\n    logger.error(\r\n      'Lambda Collector failed',\r\n      createErrorContext(error as Error, {\r\n        execution_id,\r\n        request_id: context.awsRequestId,\r\n        duration_ms: duration,\r\n      })\r\n    );\r\n\r\n    // エラーメトリクス送信\r\n    await sendErrorMetric(\r\n      error instanceof Error ? error.constructor.name : 'Unknown',\r\n      'Collector',\r\n      { Mode: event.mode }\r\n    );\r\n\r\n    return {\r\n      execution_id,\r\n      status: 'failed',\r\n      message: error instanceof Error ? error.message : String(error),\r\n      collected_count: 0,\r\n      failed_count: 0,\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * イベントのバリデーション\r\n *\r\n * @param event CollectorEvent\r\n * @throws ValidationError バリデーションエラー\r\n */\r\nfunction validateEvent(event: CollectorEvent): void {\r\n  // モードのバリデーション\r\n  if (!event.mode || !['batch', 'on-demand'].includes(event.mode)) {\r\n    throw new ValidationError(\r\n      `Invalid mode: ${event.mode}. Expected 'batch' or 'on-demand'.`\r\n    );\r\n  }\r\n\r\n  // on-demandモードの場合、日付範囲が必須\r\n  if (event.mode === 'on-demand') {\r\n    if (!event.start_date || !event.end_date) {\r\n      throw new ValidationError(\r\n        'start_date and end_date are required for on-demand mode'\r\n      );\r\n    }\r\n\r\n    // 日付フォーマットのバリデーション（YYYY-MM-DD）\r\n    const dateRegex = /^\\d{4}-\\d{2}-\\d{2}$/;\r\n    if (!dateRegex.test(event.start_date)) {\r\n      throw new ValidationError(\r\n        `Invalid start_date format: ${event.start_date}. Expected YYYY-MM-DD format.`\r\n      );\r\n    }\r\n    if (!dateRegex.test(event.end_date)) {\r\n      throw new ValidationError(\r\n        `Invalid end_date format: ${event.end_date}. Expected YYYY-MM-DD format.`\r\n      );\r\n    }\r\n\r\n    // 日付の有効性チェック\r\n    const startDate = new Date(event.start_date);\r\n    const endDate = new Date(event.end_date);\r\n\r\n    if (isNaN(startDate.getTime())) {\r\n      throw new ValidationError(\r\n        `Invalid start_date: ${event.start_date}. Date does not exist.`\r\n      );\r\n    }\r\n    if (isNaN(endDate.getTime())) {\r\n      throw new ValidationError(\r\n        `Invalid end_date: ${event.end_date}. Date does not exist.`\r\n      );\r\n    }\r\n\r\n    // 日付順序チェック\r\n    if (startDate > endDate) {\r\n      throw new ValidationError(\r\n        `start_date (${event.start_date}) must be before or equal to end_date (${event.end_date})`\r\n      );\r\n    }\r\n\r\n    // 範囲チェック（過去1年以内）\r\n    const oneYearAgo = new Date();\r\n    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);\r\n    if (startDate < oneYearAgo) {\r\n      throw new ValidationError(\r\n        `start_date (${event.start_date}) is too old. Maximum range is 1 year.`\r\n      );\r\n    }\r\n\r\n    // 未来日チェック\r\n    const tomorrow = new Date();\r\n    tomorrow.setDate(tomorrow.getDate() + 1);\r\n    if (endDate > tomorrow) {\r\n      throw new ValidationError(\r\n        `end_date (${event.end_date}) cannot be in the future.`\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * バッチモードの処理\r\n * 前日のデータを収集\r\n *\r\n * @param execution_id 実行ID\r\n * @returns CollectorResponse\r\n */\r\nasync function handleBatchMode(\r\n  execution_id: string\r\n): Promise<CollectorResponse> {\r\n  logger.info('Batch mode: collecting yesterday\\'s data', { execution_id });\r\n\r\n  // 前日の日付を取得（JST基準）\r\n  const yesterday = getYesterday();\r\n  const dateStr = formatDate(yesterday);\r\n\r\n  logger.info('Target date for batch mode', {\r\n    execution_id,\r\n    date: dateStr,\r\n  });\r\n\r\n  // 前日のデータを収集\r\n  return await collectDisclosuresForDateRange(\r\n    execution_id,\r\n    dateStr,\r\n    dateStr\r\n  );\r\n}\r\n\r\n/**\r\n * オンデマンドモードの処理\r\n * 指定期間のデータを収集\r\n *\r\n * @param execution_id 実行ID\r\n * @param start_date 開始日（YYYY-MM-DD）\r\n * @param end_date 終了日（YYYY-MM-DD）\r\n * @returns CollectorResponse\r\n */\r\nasync function handleOnDemandMode(\r\n  execution_id: string,\r\n  start_date: string,\r\n  end_date: string\r\n): Promise<CollectorResponse> {\r\n  logger.info('On-demand mode: collecting data for specified range', {\r\n    execution_id,\r\n    start_date,\r\n    end_date,\r\n  });\r\n\r\n  return await collectDisclosuresForDateRange(\r\n    execution_id,\r\n    start_date,\r\n    end_date\r\n  );\r\n}\r\n\r\n/**\r\n * 指定期間のデータを収集\r\n *\r\n * @param execution_id 実行ID\r\n * @param start_date 開始日（YYYY-MM-DD）\r\n * @param end_date 終了日（YYYY-MM-DD）\r\n * @returns CollectorResponse\r\n */\r\nasync function collectDisclosuresForDateRange(\r\n  execution_id: string,\r\n  start_date: string,\r\n  end_date: string\r\n): Promise<CollectorResponse> {\r\n  const dates = generateDateRange(start_date, end_date);\r\n  let collected_count = 0;\r\n  let failed_count = 0;\r\n\r\n  logger.info('Collecting disclosures for date range', {\r\n    execution_id,\r\n    start_date,\r\n    end_date,\r\n    total_days: dates.length,\r\n  });\r\n\r\n  // 実行状態を初期化（pending）\r\n  await updateExecutionStatus(execution_id, 'pending', 0);\r\n\r\n  // 実行状態を更新（running）\r\n  await updateExecutionStatus(execution_id, 'running', 0);\r\n\r\n  // 各日付のデータを順次収集\r\n  for (let i = 0; i < dates.length; i++) {\r\n    const date = dates[i];\r\n    try {\r\n      logger.info('Scraping TDnet list for date', {\r\n        execution_id,\r\n        date,\r\n        progress: `${i + 1}/${dates.length}`,\r\n      });\r\n\r\n      const disclosureMetadata = await scrapeTdnetList(date);\r\n\r\n      logger.info('TDnet list scraped successfully', {\r\n        execution_id,\r\n        date,\r\n        count: disclosureMetadata.length,\r\n      });\r\n\r\n      // 並列処理（並列度5）\r\n      const results = await processDisclosuresInParallel(\r\n        disclosureMetadata,\r\n        execution_id,\r\n        5\r\n      );\r\n\r\n      collected_count += results.success;\r\n      failed_count += results.failed;\r\n\r\n      // 進捗率を更新（日付単位）\r\n      const progress = Math.floor(((i + 1) / dates.length) * 100);\r\n      await updateExecutionStatus(\r\n        execution_id,\r\n        'running',\r\n        progress,\r\n        collected_count,\r\n        failed_count\r\n      );\r\n    } catch (error) {\r\n      logger.error(\r\n        'Failed to collect disclosures for date',\r\n        createErrorContext(error as Error, {\r\n          execution_id,\r\n          date,\r\n        })\r\n      );\r\n      failed_count++;\r\n    }\r\n  }\r\n\r\n  // ステータスの決定\r\n  let status: 'success' | 'partial_success' | 'failed';\r\n  if (failed_count === 0) {\r\n    status = 'success';\r\n  } else if (collected_count > 0) {\r\n    status = 'partial_success';\r\n  } else {\r\n    status = 'failed';\r\n  }\r\n\r\n  // 実行状態を更新（completed/failed）\r\n  await updateExecutionStatus(\r\n    execution_id,\r\n    status === 'failed' ? 'failed' : 'completed',\r\n    100,\r\n    collected_count,\r\n    failed_count,\r\n    status === 'failed' ? 'Collection failed' : undefined\r\n  );\r\n\r\n  return {\r\n    execution_id,\r\n    status,\r\n    message: `Collected ${collected_count} disclosures, ${failed_count} failed`,\r\n    collected_count,\r\n    failed_count,\r\n  };\r\n}\r\n\r\n/**\r\n * 実行IDを生成\r\n *\r\n * @param context Lambda Context\r\n * @returns 実行ID\r\n */\r\nfunction generateExecutionId(context: Context): string {\r\n  const timestamp = Date.now();\r\n  const random = Math.random().toString(36).substring(2, 8);\r\n  return `exec_${timestamp}_${random}_${context.awsRequestId.substring(0, 8)}`;\r\n}\r\n\r\n/**\r\n * 前日の日付を取得（JST基準）\r\n *\r\n * JST（日本標準時、UTC+9）基準で前日の日付を計算します。\r\n * 例: 現在時刻が 2024-01-15 00:30 JST の場合、2024-01-14 を返します。\r\n *\r\n * @returns 前日の日付文字列（YYYY-MM-DD形式）\r\n */\r\nfunction getYesterday(): Date {\r\n  const now = new Date();\r\n  // JSTに変換（UTC+9時間）\r\n  const jstNow = new Date(now.getTime() + 9 * 60 * 60 * 1000);\r\n  \r\n  // JST基準で前日を計算\r\n  const jstYesterday = new Date(jstNow);\r\n  jstYesterday.setUTCDate(jstYesterday.getUTCDate() - 1);\r\n  \r\n  return jstYesterday;\r\n}\r\n\r\n/**\r\n * DateオブジェクトをYYYY-MM-DD形式にフォーマット\r\n *\r\n * JST変換済みのDateオブジェクトをYYYY-MM-DD形式の文字列に変換します。\r\n * getUTCFullYear(), getUTCMonth(), getUTCDate()を使用することで、\r\n * JST変換後の日付を正しく抽出します。\r\n *\r\n * @param date JST変換済みのDateオブジェクト\r\n * @returns YYYY-MM-DD形式の文字列\r\n */\r\nfunction formatDate(date: Date): string {\r\n  const year = date.getUTCFullYear();\r\n  const month = String(date.getUTCMonth() + 1).padStart(2, '0');\r\n  const day = String(date.getUTCDate()).padStart(2, '0');\r\n  return `${year}-${month}-${day}`;\r\n}\r\n\r\n/**\r\n * 日付範囲を生成\r\n *\r\n * YYYY-MM-DD形式の開始日と終了日から、その間のすべての日付を生成します。\r\n * 日付の比較と増分はUTC基準で行われます。\r\n *\r\n * @param start_date 開始日（YYYY-MM-DD）\r\n * @param end_date 終了日（YYYY-MM-DD）\r\n * @returns 日付の配列（YYYY-MM-DD形式）\r\n *\r\n * @example\r\n * generateDateRange('2024-01-15', '2024-01-17')\r\n * // => ['2024-01-15', '2024-01-16', '2024-01-17']\r\n */\r\nfunction generateDateRange(start_date: string, end_date: string): string[] {\r\n  const dates: string[] = [];\r\n  const current = new Date(start_date + 'T00:00:00Z'); // UTC midnight\r\n  const end = new Date(end_date + 'T00:00:00Z'); // UTC midnight\r\n\r\n  while (current <= end) {\r\n    // YYYY-MM-DD形式で日付を抽出\r\n    const year = current.getUTCFullYear();\r\n    const month = String(current.getUTCMonth() + 1).padStart(2, '0');\r\n    const day = String(current.getUTCDate()).padStart(2, '0');\r\n    dates.push(`${year}-${month}-${day}`);\r\n    \r\n    // 次の日に進む（UTC基準）\r\n    current.setUTCDate(current.getUTCDate() + 1);\r\n  }\r\n\r\n  return dates;\r\n}\r\n\r\n/**\r\n * 開示情報を並列処理\r\n *\r\n * Promise.allSettledを使用して、一部が失敗しても他の処理を継続します。\r\n *\r\n * @param disclosureMetadata 開示情報メタデータリスト\r\n * @param execution_id 実行ID\r\n * @param concurrency 並列度（デフォルト: 5）\r\n * @returns 処理結果（成功件数、失敗件数）\r\n */\r\nasync function processDisclosuresInParallel(\r\n  disclosureMetadata: DisclosureMetadata[],\r\n  execution_id: string,\r\n  concurrency: number = 5\r\n): Promise<{ success: number; failed: number }> {\r\n  const results = { success: 0, failed: 0 };\r\n\r\n  // 並列度を制限して処理\r\n  for (let i = 0; i < disclosureMetadata.length; i += concurrency) {\r\n    const batch = disclosureMetadata.slice(i, i + concurrency);\r\n    const promises = batch.map((metadata, index) =>\r\n      processDisclosure(metadata, execution_id, i + index + 1)\r\n    );\r\n\r\n    const settled = await Promise.allSettled(promises);\r\n\r\n    for (const result of settled) {\r\n      if (result.status === 'fulfilled') {\r\n        results.success++;\r\n      } else {\r\n        results.failed++;\r\n        logger.error('Failed to process disclosure', {\r\n          execution_id,\r\n          error: result.reason,\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  return results;\r\n}\r\n\r\n/**\r\n * 単一の開示情報を処理\r\n *\r\n * 1. 開示IDを生成\r\n * 2. PDFをダウンロードしてS3に保存\r\n * 3. メタデータをDynamoDBに保存\r\n *\r\n * @param metadata 開示情報メタデータ\r\n * @param execution_id 実行ID\r\n * @param sequence 連番（同一日・同一企業の複数開示を区別）\r\n */\r\nasync function processDisclosure(\r\n  metadata: DisclosureMetadata,\r\n  execution_id: string,\r\n  sequence: number\r\n): Promise<void> {\r\n  try {\r\n    // 開示IDを生成\r\n    const disclosure_id = generateDisclosureId(\r\n      metadata.disclosed_at,\r\n      metadata.company_code,\r\n      sequence\r\n    );\r\n\r\n    logger.info('Processing disclosure', {\r\n      execution_id,\r\n      disclosure_id,\r\n      company_code: metadata.company_code,\r\n      title: metadata.title,\r\n    });\r\n\r\n    // PDFをダウンロードしてS3に保存\r\n    const s3_key = await downloadPdf(\r\n      disclosure_id,\r\n      metadata.pdf_url,\r\n      metadata.disclosed_at\r\n    );\r\n\r\n    // DisclosureMetadataからDisclosureに変換\r\n    const disclosure: Disclosure = {\r\n      disclosure_id,\r\n      company_code: metadata.company_code,\r\n      company_name: metadata.company_name,\r\n      disclosure_type: metadata.disclosure_type,\r\n      title: metadata.title,\r\n      disclosed_at: metadata.disclosed_at,\r\n      pdf_url: metadata.pdf_url,\r\n      s3_key,\r\n      collected_at: new Date().toISOString(),\r\n      date_partition: '', // saveMetadata内で自動生成\r\n    };\r\n\r\n    // メタデータをDynamoDBに保存\r\n    await saveMetadata(disclosure, s3_key);\r\n\r\n    logger.info('Successfully processed disclosure', {\r\n      execution_id,\r\n      disclosure_id,\r\n      s3_key,\r\n    });\r\n  } catch (error) {\r\n    logger.error(\r\n      'Failed to process disclosure',\r\n      createErrorContext(error as Error, {\r\n        execution_id,\r\n        company_code: metadata.company_code,\r\n        title: metadata.title,\r\n      })\r\n    );\r\n    throw error;\r\n  }\r\n}\r\n\r\n"],"version":3}