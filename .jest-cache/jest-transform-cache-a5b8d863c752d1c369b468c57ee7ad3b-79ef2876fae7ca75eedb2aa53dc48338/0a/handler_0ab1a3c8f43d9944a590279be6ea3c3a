d41114399d580498123d8a8634330827
"use strict";
/**
 * Lambda PDF Download Handler
 *
 * GET /disclosures/{disclosure_id}/pdf エンドポイント
 * PDFファイルの署名付きURLを生成して返却します。
 *
 * Requirements: タスク13.6
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const client_s3_1 = require("@aws-sdk/client-s3");
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const s3_request_presigner_1 = require("@aws-sdk/s3-request-presigner");
const logger_1 = require("../../../utils/logger");
const cloudwatch_metrics_1 = require("../../../utils/cloudwatch-metrics");
const errors_1 = require("../../../errors");
const retry_1 = require("../../../utils/retry");
// クライアント（グローバルスコープで初期化）
const dynamoClient = new client_dynamodb_1.DynamoDBClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });
const s3Client = new client_s3_1.S3Client({ region: process.env.AWS_REGION || 'ap-northeast-1' });
const secretsClient = new client_secrets_manager_1.SecretsManagerClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });
// 環境変数
const DISCLOSURES_TABLE = process.env.DYNAMODB_TABLE_NAME || 'tdnet_disclosures';
const PDF_BUCKET = process.env.S3_BUCKET_NAME || 'tdnet-data-collector-pdfs';
const DEFAULT_EXPIRATION = 3600; // 1時間（秒）
const MAX_EXPIRATION = 86400; // 24時間（秒）
const MIN_EXPIRATION = 60; // 1分（秒）
// APIキーキャッシュ（5分TTL）
let cachedApiKey = null;
let cacheExpiry = 0;
/**
 * Secrets ManagerからAPIキーを取得
 *
 * テスト環境（TEST_ENV=e2e）では、API_KEY環境変数から直接取得します。
 * 本番環境では、Secrets Managerから取得します。
 *
 * @returns APIキー
 * @throws Error Secrets Managerからの取得に失敗した場合
 */
async function getApiKey() {
    // キャッシュチェック
    if (cachedApiKey && Date.now() < cacheExpiry) {
        return cachedApiKey;
    }
    // テスト環境: API_KEY環境変数から直接取得
    if (process.env.TEST_ENV === 'e2e' && process.env.API_KEY) {
        cachedApiKey = process.env.API_KEY;
        cacheExpiry = Date.now() + 5 * 60 * 1000;
        return cachedApiKey;
    }
    // 本番環境: Secrets Managerから取得
    const secretArn = process.env.API_KEY_SECRET_ARN;
    if (!secretArn) {
        throw new Error('API_KEY_SECRET_ARN environment variable is not set');
    }
    try {
        const command = new client_secrets_manager_1.GetSecretValueCommand({ SecretId: secretArn });
        const response = await secretsClient.send(command);
        if (!response.SecretString) {
            throw new Error('Secret value is empty');
        }
        // APIキーをキャッシュ（5分TTL）
        cachedApiKey = response.SecretString;
        cacheExpiry = Date.now() + 5 * 60 * 1000;
        return cachedApiKey;
    }
    catch (error) {
        logger_1.logger.error('Failed to retrieve API key from Secrets Manager', {
            error: error instanceof Error ? error.message : String(error),
            secret_arn: secretArn,
        });
        throw new Error('Failed to retrieve API key');
    }
}
/**
 * Lambda PDF Download Handler
 *
 * @param event APIGatewayProxyEvent
 * @param context Lambda Context
 * @returns APIGatewayProxyResult
 *
 * @example
 * ```typescript
 * // GET /disclosures/20240115_7203_001/pdf
 * const response = await handler({
 *   pathParameters: { disclosure_id: '20240115_7203_001' },
 *   queryStringParameters: { expiration: '3600' },
 *   headers: { 'x-api-key': 'your-api-key' },
 * }, context);
 * ```
 */
async function handler(event, context) {
    const startTime = Date.now();
    try {
        logger_1.logger.info('Lambda PDF Download started', {
            request_id: context.awsRequestId,
            function_name: context.functionName,
            disclosure_id: event.pathParameters?.disclosure_id,
        });
        // APIキー認証
        await validateApiKey(event);
        // disclosure_idの取得とバリデーション
        const disclosureId = validateDisclosureId(event);
        // expirationパラメータの取得とバリデーション
        const expiration = validateExpiration(event);
        // DynamoDBから開示情報を取得
        const disclosure = await getDisclosure(disclosureId);
        // S3キーの検証
        if (!disclosure.pdf_s3_key) {
            throw new errors_1.NotFoundError(`PDF file not found for disclosure: ${disclosureId}`);
        }
        // S3オブジェクトの存在確認
        await verifyS3ObjectExists(disclosure.pdf_s3_key);
        // 署名付きURLを生成
        const signedUrl = await generateSignedUrl(disclosure.pdf_s3_key, expiration);
        // 有効期限を計算
        const expiresAt = new Date(Date.now() + expiration * 1000).toISOString();
        const duration = Date.now() - startTime;
        logger_1.logger.info('Lambda PDF Download completed', {
            disclosure_id: disclosureId,
            s3_key: disclosure.pdf_s3_key,
            expiration,
            duration_ms: duration,
        });
        // 成功メトリクス送信
        await (0, cloudwatch_metrics_1.sendMetrics)([
            {
                name: 'LambdaExecutionTime',
                value: duration,
                unit: 'Milliseconds',
                dimensions: { FunctionName: 'PDFDownload' },
            },
            {
                name: 'PDFDownloadRequests',
                value: 1,
                unit: 'Count',
                dimensions: { Status: 'Success' },
            },
        ]);
        // レスポンス
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Headers': 'Content-Type,X-Api-Key',
            },
            body: JSON.stringify({
                status: 'success',
                data: {
                    download_url: signedUrl,
                    expires_at: expiresAt,
                },
            }),
        };
    }
    catch (error) {
        const duration = Date.now() - startTime;
        logger_1.logger.error('Lambda PDF Download failed', (0, logger_1.createErrorContext)(error, {
            request_id: context.awsRequestId,
            disclosure_id: event.pathParameters?.disclosure_id,
            duration_ms: duration,
        }));
        // エラーメトリクス送信
        await (0, cloudwatch_metrics_1.sendErrorMetric)(error instanceof Error ? error.constructor.name : 'Unknown', 'PDFDownload');
        // エラーレスポンス
        return handleError(error, context.awsRequestId);
    }
}
/**
 * APIキー認証
 *
 * @param event APIGatewayProxyEvent
 * @throws AuthenticationError APIキーが無効な場合
 */
async function validateApiKey(event) {
    const apiKey = event.headers?.['x-api-key'] || event.headers?.['X-Api-Key'];
    if (!apiKey) {
        throw new errors_1.AuthenticationError('API key is required');
    }
    // Secrets ManagerからAPIキーを取得
    const validApiKey = await getApiKey();
    if (apiKey !== validApiKey) {
        throw new errors_1.AuthenticationError('Invalid API key');
    }
}
/**
 * disclosure_idのバリデーション
 *
 * @param event APIGatewayProxyEvent
 * @returns disclosure_id
 * @throws ValidationError disclosure_idが無効な場合
 */
function validateDisclosureId(event) {
    const disclosureId = event.pathParameters?.disclosure_id;
    if (!disclosureId) {
        throw new errors_1.ValidationError('disclosure_id is required');
    }
    // disclosure_idのフォーマット検証（例: 20240115_7203_001）
    if (!/^\d{8}_\d{4}_\d{3}$/.test(disclosureId)) {
        throw new errors_1.ValidationError(`Invalid disclosure_id format: ${disclosureId}. Expected format: YYYYMMDD_CCCC_NNN`);
    }
    return disclosureId;
}
/**
 * expirationパラメータのバリデーション
 *
 * @param event APIGatewayProxyEvent
 * @returns expiration（秒）
 * @throws ValidationError expirationが無効な場合
 */
function validateExpiration(event) {
    const expirationParam = event.queryStringParameters?.expiration;
    if (!expirationParam) {
        return DEFAULT_EXPIRATION;
    }
    const expiration = parseInt(expirationParam, 10);
    if (isNaN(expiration)) {
        throw new errors_1.ValidationError(`Invalid expiration format: ${expirationParam}. Expected integer.`);
    }
    if (expiration < MIN_EXPIRATION || expiration > MAX_EXPIRATION) {
        throw new errors_1.ValidationError(`Expiration out of range: ${expiration}. Must be between ${MIN_EXPIRATION} and ${MAX_EXPIRATION} seconds.`);
    }
    return expiration;
}
/**
 * DynamoDBから開示情報を取得
 *
 * @param disclosureId 開示ID
 * @returns 開示情報
 * @throws NotFoundError 開示情報が見つからない場合
 */
async function getDisclosure(disclosureId) {
    logger_1.logger.info('Fetching disclosure from DynamoDB', {
        disclosure_id: disclosureId,
        table: DISCLOSURES_TABLE,
    });
    const result = await (0, retry_1.retryWithBackoff)(async () => {
        return await dynamoClient.send(new client_dynamodb_1.GetItemCommand({
            TableName: DISCLOSURES_TABLE,
            Key: {
                disclosure_id: { S: disclosureId },
            },
        }));
    }, {
        maxRetries: 3,
        initialDelay: 1000,
        backoffMultiplier: 2,
        jitter: true,
        shouldRetry: (error) => {
            return error.name === 'ProvisionedThroughputExceededException';
        },
    });
    if (!result.Item) {
        throw new errors_1.NotFoundError(`Disclosure not found: ${disclosureId}`);
    }
    // DynamoDBアイテムをDisclosureに変換
    const item = result.Item;
    const disclosure = {
        disclosure_id: item.disclosure_id.S,
        company_code: item.company_code.S,
        company_name: item.company_name.S,
        pdf_s3_key: item.pdf_s3_key?.S || null,
    };
    logger_1.logger.info('Disclosure fetched successfully', {
        disclosure_id: disclosureId,
        pdf_s3_key: disclosure.pdf_s3_key,
    });
    return disclosure;
}
/**
 * S3オブジェクトの存在確認
 *
 * @param s3Key S3キー
 * @throws NotFoundError S3オブジェクトが存在しない場合
 */
async function verifyS3ObjectExists(s3Key) {
    logger_1.logger.info('Verifying S3 object exists', {
        s3_key: s3Key,
        bucket: PDF_BUCKET,
    });
    try {
        await (0, retry_1.retryWithBackoff)(async () => {
            await s3Client.send(new client_s3_1.HeadObjectCommand({
                Bucket: PDF_BUCKET,
                Key: s3Key,
            }));
        }, {
            maxRetries: 3,
            initialDelay: 1000,
            backoffMultiplier: 2,
            jitter: true,
            shouldRetry: (error) => {
                // 404エラーは再試行しない
                if (error.name === 'NotFound' || error.$metadata?.httpStatusCode === 404) {
                    return false;
                }
                // その他のエラーは再試行
                return true;
            },
        });
        logger_1.logger.info('S3 object exists', { s3_key: s3Key });
    }
    catch (error) {
        if (error.name === 'NotFound' || error.$metadata?.httpStatusCode === 404) {
            throw new errors_1.NotFoundError(`PDF file not found in S3: ${s3Key}`);
        }
        throw error;
    }
}
/**
 * 署名付きURLを生成
 *
 * @param s3Key S3キー
 * @param expiresIn 有効期限（秒）
 * @returns 署名付きURL
 */
async function generateSignedUrl(s3Key, expiresIn) {
    logger_1.logger.info('Generating signed URL', {
        s3_key: s3Key,
        bucket: PDF_BUCKET,
        expires_in: expiresIn,
    });
    const command = new client_s3_1.GetObjectCommand({
        Bucket: PDF_BUCKET,
        Key: s3Key,
    });
    const signedUrl = await (0, s3_request_presigner_1.getSignedUrl)(s3Client, command, { expiresIn });
    logger_1.logger.info('Signed URL generated successfully', {
        s3_key: s3Key,
        url_length: signedUrl.length,
    });
    return signedUrl;
}
/**
 * エラーハンドリング
 *
 * @param error エラーオブジェクト
 * @param requestId リクエストID
 * @returns APIGatewayProxyResult
 */
function handleError(error, requestId) {
    // エラー種別に応じたステータスコードとエラーコード
    let statusCode = 500;
    let errorCode = 'INTERNAL_ERROR';
    if (error instanceof errors_1.ValidationError) {
        statusCode = 400;
        errorCode = 'VALIDATION_ERROR';
    }
    else if (error instanceof errors_1.AuthenticationError) {
        statusCode = 401;
        errorCode = 'UNAUTHORIZED';
    }
    else if (error instanceof errors_1.NotFoundError) {
        statusCode = 404;
        errorCode = 'NOT_FOUND';
    }
    return {
        statusCode,
        headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Headers': 'Content-Type,X-Api-Key',
        },
        body: JSON.stringify({
            status: 'error',
            error: {
                code: errorCode,
                message: error.message,
                details: error.details || {},
            },
            request_id: requestId,
        }),
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGFwaVxccGRmLWRvd25sb2FkXFxoYW5kbGVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7OztHQU9HOztBQStGSCwwQkFxR0M7QUFqTUQsOERBQTBFO0FBQzFFLGtEQUFtRjtBQUNuRiw0RUFBOEY7QUFDOUYsd0VBQTZEO0FBQzdELGtEQUFtRTtBQUNuRSwwRUFBaUY7QUFDakYsNENBQXNGO0FBQ3RGLGdEQUF3RDtBQUV4RCx3QkFBd0I7QUFDeEIsTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLGdCQUFnQixFQUFFLENBQUMsQ0FBQztBQUNoRyxNQUFNLFFBQVEsR0FBRyxJQUFJLG9CQUFRLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO0FBQ3RGLE1BQU0sYUFBYSxHQUFHLElBQUksNkNBQW9CLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO0FBRXZHLE9BQU87QUFDUCxNQUFNLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLElBQUksbUJBQW1CLENBQUM7QUFDakYsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLElBQUksMkJBQTJCLENBQUM7QUFDN0UsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLENBQUMsQ0FBQyxTQUFTO0FBQzFDLE1BQU0sY0FBYyxHQUFHLEtBQUssQ0FBQyxDQUFDLFVBQVU7QUFDeEMsTUFBTSxjQUFjLEdBQUcsRUFBRSxDQUFDLENBQUMsUUFBUTtBQUVuQyxvQkFBb0I7QUFDcEIsSUFBSSxZQUFZLEdBQWtCLElBQUksQ0FBQztBQUN2QyxJQUFJLFdBQVcsR0FB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S0FBSyxZQUFZLHdCQUFlLEVBQUUsQ0FBQztRQUNyQyxVQUFVLEdBQUcsR0FBRyxDQUFDO1FBQ2pCLFNBQVMsR0FBRyxrQkFBa0IsQ0FBQztJQUNqQyxDQUFDO1NBQU0sSUFBSSxLQUFLLFlBQVksNEJBQW1CLEVBQUUsQ0FBQztRQUNoRCxVQUFVLEdBQUcsR0FBRyxDQUFDO1FBQ2pCLFNBQVMsR0FBRyxjQUFjLENBQUM7SUFDN0IsQ0FBQztTQUFNLElBQUksS0FBSyxZQUFZLHNCQUFhLEVBQUUsQ0FBQztRQUMxQyxVQUFVLEdBQUcsR0FBRyxDQUFDO1FBQ2pCLFNBQVMsR0FBRyxXQUFXLENBQUM7SUFDMUIsQ0FBQztJQUVELE9BQU87UUFDTCxVQUFVO1FBQ1YsT0FBTyxFQUFFO1lBQ1AsY0FBYyxFQUFFLGtCQUFrQjtZQUNsQyw2QkFBNkIsRUFBRSxHQUFHO1lBQ2xDLDhCQUE4QixFQUFFLHdCQUF3QjtTQUN6RDtRQUNELElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQ25CLE1BQU0sRUFBRSxPQUFPO1lBQ2YsS0FBSyxFQUFFO2dCQUNMLElBQUksRUFBRSxTQUFTO2dCQUNmLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTztnQkFDdEIsT0FBTyxFQUFHLEtBQWEsQ0FBQyxPQUFPLElBQUksRUFBRTthQUN0QztZQUNELFVBQVUsRUFBRSxTQUFTO1NBQ3RCLENBQUM7S0FDSCxDQUFDO0FBQ0osQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpMTk4XFxpbnZlc3RtZW50X2FuYWx5c2lzX29wb3BvXFxzcmNcXGxhbWJkYVxcYXBpXFxwZGYtZG93bmxvYWRcXGhhbmRsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIExhbWJkYSBQREYgRG93bmxvYWQgSGFuZGxlclxyXG4gKlxyXG4gKiBHRVQgL2Rpc2Nsb3N1cmVzL3tkaXNjbG9zdXJlX2lkfS9wZGYg44Ko44Oz44OJ44Od44Kk44Oz44OIXHJcbiAqIFBERuODleOCoeOCpOODq+OBrue9suWQjeS7mOOBjVVSTOOCkueUn+aIkOOBl+OBpui/lOWNtOOBl+OBvuOBmeOAglxyXG4gKlxyXG4gKiBSZXF1aXJlbWVudHM6IOOCv+OCueOCrzEzLjZcclxuICovXHJcblxyXG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0LCBDb250ZXh0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XHJcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50LCBHZXRJdGVtQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XHJcbmltcG9ydCB7IFMzQ2xpZW50LCBHZXRPYmplY3RDb21tYW5kLCBIZWFkT2JqZWN0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XHJcbmltcG9ydCB7IFNlY3JldHNNYW5hZ2VyQ2xpZW50LCBHZXRTZWNyZXRWYWx1ZUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtc2VjcmV0cy1tYW5hZ2VyJztcclxuaW1wb3J0IHsgZ2V0U2lnbmVkVXJsIH0gZnJvbSAnQGF3cy1zZGsvczMtcmVxdWVzdC1wcmVzaWduZXInO1xyXG5pbXBvcnQgeyBsb2dnZXIsIGNyZWF0ZUVycm9yQ29udGV4dCB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL2xvZ2dlcic7XHJcbmltcG9ydCB7IHNlbmRFcnJvck1ldHJpYywgc2VuZE1ldHJpY3MgfSBmcm9tICcuLi8uLi8uLi91dGlscy9jbG91ZHdhdGNoLW1ldHJpY3MnO1xyXG5pbXBvcnQgeyBWYWxpZGF0aW9uRXJyb3IsIE5vdEZvdW5kRXJyb3IsIEF1dGhlbnRpY2F0aW9uRXJyb3IgfSBmcm9tICcuLi8uLi8uLi9lcnJvcnMnO1xyXG5pbXBvcnQgeyByZXRyeVdpdGhCYWNrb2ZmIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvcmV0cnknO1xyXG5cclxuLy8g44Kv44Op44Kk44Ki44Oz44OI77yI44Kw44Ot44O844OQ44Or44K544Kz44O844OX44Gn5Yid5pyf5YyW77yJXHJcbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7IHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB8fCAnYXAtbm9ydGhlYXN0LTEnIH0pO1xyXG5jb25zdCBzM0NsaWVudCA9IG5ldyBTM0NsaWVudCh7IHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB8fCAnYXAtbm9ydGhlYXN0LTEnIH0pO1xyXG5jb25zdCBzZWNyZXRzQ2xpZW50ID0gbmV3IFNlY3JldHNNYW5hZ2VyQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICdhcC1ub3J0aGVhc3QtMScgfSk7XHJcblxyXG4vLyDnkrDlooPlpInmlbBcclxuY29uc3QgRElTQ0xPU1VSRVNfVEFCTEUgPSBwcm9jZXNzLmVudi5EWU5BTU9EQl9UQUJMRV9OQU1FIHx8ICd0ZG5ldF9kaXNjbG9zdXJlcyc7XHJcbmNvbnN0IFBERl9CVUNLRVQgPSBwcm9jZXNzLmVudi5TM19CVUNLRVRfTkFNRSB8fCAndGRuZXQtZGF0YS1jb2xsZWN0b3ItcGRmcyc7XHJcbmNvbnN0IERFRkFVTFRfRVhQSVJBVElPTiA9IDM2MDA7IC8vIDHmmYLplpPvvIjnp5LvvIlcclxuY29uc3QgTUFYX0VYUElSQVRJT04gPSA4NjQwMDsgLy8gMjTmmYLplpPvvIjnp5LvvIlcclxuY29uc3QgTUlOX0VYUElSQVRJT04gPSA2MDsgLy8gMeWIhu+8iOenku+8iVxyXG5cclxuLy8gQVBJ44Kt44O844Kt44Oj44OD44K344Ol77yINeWIhlRUTO+8iVxyXG5sZXQgY2FjaGVkQXBpS2V5OiBzdHJpbmcgfCBudWxsID0gbnVsbDtcclxubGV0IGNhY2hlRXhwaXJ5OiBudW1iZXIgPSAwO1xyXG5cclxuLyoqXHJcbiAqIFNlY3JldHMgTWFuYWdlcuOBi+OCiUFQSeOCreODvOOCkuWPluW+l1xyXG4gKlxyXG4gKiDjg4bjgrnjg4jnkrDlooPvvIhURVNUX0VOVj1lMmXvvInjgafjga/jgIFBUElfS0VZ55Kw5aKD5aSJ5pWw44GL44KJ55u05o6l5Y+W5b6X44GX44G+44GZ44CCXHJcbiAqIOacrOeVqueSsOWig+OBp+OBr+OAgVNlY3JldHMgTWFuYWdlcuOBi+OCieWPluW+l+OBl+OBvuOBmeOAglxyXG4gKlxyXG4gKiBAcmV0dXJucyBBUEnjgq3jg7xcclxuICogQHRocm93cyBFcnJvciBTZWNyZXRzIE1hbmFnZXLjgYvjgonjga7lj5blvpfjgavlpLHmlZfjgZfjgZ/loLTlkIhcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIGdldEFwaUtleSgpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gIC8vIOOCreODo+ODg+OCt+ODpeODgeOCp+ODg+OCr1xyXG4gIGlmIChjYWNoZWRBcGlLZXkgJiYgRGF0ZS5ub3coKSA8IGNhY2hlRXhwaXJ5KSB7XHJcbiAgICByZXR1cm4gY2FjaGVkQXBpS2V5O1xyXG4gIH1cclxuXHJcbiAgLy8g44OG44K544OI55Kw5aKDOiBBUElfS0VZ55Kw5aKD5aSJ5pWw44GL44KJ55u05o6l5Y+W5b6XXHJcbiAgaWYgKHByb2Nlc3MuZW52LlRFU1RfRU5WID09PSAnZTJlJyAmJiBwcm9jZXNzLmVudi5BUElfS0VZKSB7XHJcbiAgICBjYWNoZWRBcGlLZXkgPSBwcm9jZXNzLmVudi5BUElfS0VZO1xyXG4gICAgY2FjaGVFeHBpcnkgPSBEYXRlLm5vdygpICsgNSAqIDYwICogMTAwMDtcclxuICAgIHJldHVybiBjYWNoZWRBcGlLZXk7XHJcbiAgfVxyXG5cclxuICAvLyDmnKznlarnkrDlooM6IFNlY3JldHMgTWFuYWdlcuOBi+OCieWPluW+l1xyXG4gIGNvbnN0IHNlY3JldEFybiA9IHByb2Nlc3MuZW52LkFQSV9LRVlfU0VDUkVUX0FSTjtcclxuICBpZiAoIXNlY3JldEFybikge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdBUElfS0VZX1NFQ1JFVF9BUk4gZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgbm90IHNldCcpO1xyXG4gIH1cclxuXHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0U2VjcmV0VmFsdWVDb21tYW5kKHsgU2VjcmV0SWQ6IHNlY3JldEFybiB9KTtcclxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgc2VjcmV0c0NsaWVudC5zZW5kKGNvbW1hbmQpO1xyXG5cclxuICAgIGlmICghcmVzcG9uc2UuU2VjcmV0U3RyaW5nKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignU2VjcmV0IHZhbHVlIGlzIGVtcHR5Jyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQVBJ44Kt44O844KS44Kt44Oj44OD44K344Ol77yINeWIhlRUTO+8iVxyXG4gICAgY2FjaGVkQXBpS2V5ID0gcmVzcG9uc2UuU2VjcmV0U3RyaW5nO1xyXG4gICAgY2FjaGVFeHBpcnkgPSBEYXRlLm5vdygpICsgNSAqIDYwICogMTAwMDtcclxuXHJcbiAgICByZXR1cm4gY2FjaGVkQXBpS2V5O1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSBBUEkga2V5IGZyb20gU2VjcmV0cyBNYW5hZ2VyJywge1xyXG4gICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxyXG4gICAgICBzZWNyZXRfYXJuOiBzZWNyZXRBcm4sXHJcbiAgICB9KTtcclxuICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIEFQSSBrZXknKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBMYW1iZGEgUERGIERvd25sb2FkIEhhbmRsZXJcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEFQSUdhdGV3YXlQcm94eUV2ZW50XHJcbiAqIEBwYXJhbSBjb250ZXh0IExhbWJkYSBDb250ZXh0XHJcbiAqIEByZXR1cm5zIEFQSUdhdGV3YXlQcm94eVJlc3VsdFxyXG4gKlxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGB0eXBlc2NyaXB0XHJcbiAqIC8vIEdFVCAvZGlzY2xvc3VyZXMvMjAyNDAxMTVfNzIwM18wMDEvcGRmXHJcbiAqIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgaGFuZGxlcih7XHJcbiAqICAgcGF0aFBhcmFtZXRlcnM6IHsgZGlzY2xvc3VyZV9pZDogJzIwMjQwMTE1XzcyMDNfMDAxJyB9LFxyXG4gKiAgIHF1ZXJ5U3RyaW5nUGFyYW1ldGVyczogeyBleHBpcmF0aW9uOiAnMzYwMCcgfSxcclxuICogICBoZWFkZXJzOiB7ICd4LWFwaS1rZXknOiAneW91ci1hcGkta2V5JyB9LFxyXG4gKiB9LCBjb250ZXh0KTtcclxuICogYGBgXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaGFuZGxlcihcclxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQsXHJcbiAgY29udGV4dDogQ29udGV4dFxyXG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xyXG4gIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XHJcblxyXG4gIHRyeSB7XHJcbiAgICBsb2dnZXIuaW5mbygnTGFtYmRhIFBERiBEb3dubG9hZCBzdGFydGVkJywge1xyXG4gICAgICByZXF1ZXN0X2lkOiBjb250ZXh0LmF3c1JlcXVlc3RJZCxcclxuICAgICAgZnVuY3Rpb25fbmFtZTogY29udGV4dC5mdW5jdGlvbk5hbWUsXHJcbiAgICAgIGRpc2Nsb3N1cmVfaWQ6IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5kaXNjbG9zdXJlX2lkLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gQVBJ44Kt44O86KqN6Ki8XHJcbiAgICBhd2FpdCB2YWxpZGF0ZUFwaUtleShldmVudCk7XHJcblxyXG4gICAgLy8gZGlzY2xvc3VyZV9pZOOBruWPluW+l+OBqOODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gICAgY29uc3QgZGlzY2xvc3VyZUlkID0gdmFsaWRhdGVEaXNjbG9zdXJlSWQoZXZlbnQpO1xyXG5cclxuICAgIC8vIGV4cGlyYXRpb27jg5Hjg6njg6Hjg7zjgr/jga7lj5blvpfjgajjg5Djg6rjg4fjg7zjgrfjg6fjg7NcclxuICAgIGNvbnN0IGV4cGlyYXRpb24gPSB2YWxpZGF0ZUV4cGlyYXRpb24oZXZlbnQpO1xyXG5cclxuICAgIC8vIER5bmFtb0RC44GL44KJ6ZaL56S65oOF5aCx44KS5Y+W5b6XXHJcbiAgICBjb25zdCBkaXNjbG9zdXJlID0gYXdhaXQgZ2V0RGlzY2xvc3VyZShkaXNjbG9zdXJlSWQpO1xyXG5cclxuICAgIC8vIFMz44Kt44O844Gu5qSc6Ki8XHJcbiAgICBpZiAoIWRpc2Nsb3N1cmUucGRmX3MzX2tleSkge1xyXG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFcnJvcihgUERGIGZpbGUgbm90IGZvdW5kIGZvciBkaXNjbG9zdXJlOiAke2Rpc2Nsb3N1cmVJZH1gKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBTM+OCquODluOCuOOCp+OCr+ODiOOBruWtmOWcqOeiuuiqjVxyXG4gICAgYXdhaXQgdmVyaWZ5UzNPYmplY3RFeGlzdHMoZGlzY2xvc3VyZS5wZGZfczNfa2V5KTtcclxuXHJcbiAgICAvLyDnvbLlkI3ku5jjgY1VUkzjgpLnlJ/miJBcclxuICAgIGNvbnN0IHNpZ25lZFVybCA9IGF3YWl0IGdlbmVyYXRlU2lnbmVkVXJsKGRpc2Nsb3N1cmUucGRmX3MzX2tleSwgZXhwaXJhdGlvbik7XHJcblxyXG4gICAgLy8g5pyJ5Yq55pyf6ZmQ44KS6KiI566XXHJcbiAgICBjb25zdCBleHBpcmVzQXQgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgZXhwaXJhdGlvbiAqIDEwMDApLnRvSVNPU3RyaW5nKCk7XHJcblxyXG4gICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xyXG5cclxuICAgIGxvZ2dlci5pbmZvKCdMYW1iZGEgUERGIERvd25sb2FkIGNvbXBsZXRlZCcsIHtcclxuICAgICAgZGlzY2xvc3VyZV9pZDogZGlzY2xvc3VyZUlkLFxyXG4gICAgICBzM19rZXk6IGRpc2Nsb3N1cmUucGRmX3MzX2tleSxcclxuICAgICAgZXhwaXJhdGlvbixcclxuICAgICAgZHVyYXRpb25fbXM6IGR1cmF0aW9uLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g5oiQ5Yqf44Oh44OI44Oq44Kv44K56YCB5L+hXHJcbiAgICBhd2FpdCBzZW5kTWV0cmljcyhbXHJcbiAgICAgIHtcclxuICAgICAgICBuYW1lOiAnTGFtYmRhRXhlY3V0aW9uVGltZScsXHJcbiAgICAgICAgdmFsdWU6IGR1cmF0aW9uLFxyXG4gICAgICAgIHVuaXQ6ICdNaWxsaXNlY29uZHMnLFxyXG4gICAgICAgIGRpbWVuc2lvbnM6IHsgRnVuY3Rpb25OYW1lOiAnUERGRG93bmxvYWQnIH0sXHJcbiAgICAgIH0sXHJcbiAgICAgIHtcclxuICAgICAgICBuYW1lOiAnUERGRG93bmxvYWRSZXF1ZXN0cycsXHJcbiAgICAgICAgdmFsdWU6IDEsXHJcbiAgICAgICAgdW5pdDogJ0NvdW50JyxcclxuICAgICAgICBkaW1lbnNpb25zOiB7IFN0YXR1czogJ1N1Y2Nlc3MnIH0sXHJcbiAgICAgIH0sXHJcbiAgICBdKTtcclxuXHJcbiAgICAvLyDjg6zjgrnjg53jg7PjgrlcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcclxuICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6ICdDb250ZW50LVR5cGUsWC1BcGktS2V5JyxcclxuICAgICAgfSxcclxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICAgIHN0YXR1czogJ3N1Y2Nlc3MnLFxyXG4gICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgIGRvd25sb2FkX3VybDogc2lnbmVkVXJsLFxyXG4gICAgICAgICAgZXhwaXJlc19hdDogZXhwaXJlc0F0LFxyXG4gICAgICAgIH0sXHJcbiAgICAgIH0pLFxyXG4gICAgfTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xyXG5cclxuICAgIGxvZ2dlci5lcnJvcihcclxuICAgICAgJ0xhbWJkYSBQREYgRG93bmxvYWQgZmFpbGVkJyxcclxuICAgICAgY3JlYXRlRXJyb3JDb250ZXh0KGVycm9yIGFzIEVycm9yLCB7XHJcbiAgICAgICAgcmVxdWVzdF9pZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXHJcbiAgICAgICAgZGlzY2xvc3VyZV9pZDogZXZlbnQucGF0aFBhcmFtZXRlcnM/LmRpc2Nsb3N1cmVfaWQsXHJcbiAgICAgICAgZHVyYXRpb25fbXM6IGR1cmF0aW9uLFxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICAvLyDjgqjjg6njg7zjg6Hjg4jjg6rjgq/jgrnpgIHkv6FcclxuICAgIGF3YWl0IHNlbmRFcnJvck1ldHJpYyhcclxuICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLmNvbnN0cnVjdG9yLm5hbWUgOiAnVW5rbm93bicsXHJcbiAgICAgICdQREZEb3dubG9hZCdcclxuICAgICk7XHJcblxyXG4gICAgLy8g44Ko44Op44O844Os44K544Od44Oz44K5XHJcbiAgICByZXR1cm4gaGFuZGxlRXJyb3IoZXJyb3IgYXMgRXJyb3IsIGNvbnRleHQuYXdzUmVxdWVzdElkKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBBUEnjgq3jg7zoqo3oqLxcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEFQSUdhdGV3YXlQcm94eUV2ZW50XHJcbiAqIEB0aHJvd3MgQXV0aGVudGljYXRpb25FcnJvciBBUEnjgq3jg7zjgYznhKHlirnjgarloLTlkIhcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIHZhbGlkYXRlQXBpS2V5KGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IFByb21pc2U8dm9pZD4ge1xyXG4gIGNvbnN0IGFwaUtleSA9IGV2ZW50LmhlYWRlcnM/LlsneC1hcGkta2V5J10gfHwgZXZlbnQuaGVhZGVycz8uWydYLUFwaS1LZXknXTtcclxuXHJcbiAgaWYgKCFhcGlLZXkpIHtcclxuICAgIHRocm93IG5ldyBBdXRoZW50aWNhdGlvbkVycm9yKCdBUEkga2V5IGlzIHJlcXVpcmVkJyk7XHJcbiAgfVxyXG5cclxuICAvLyBTZWNyZXRzIE1hbmFnZXLjgYvjgolBUEnjgq3jg7zjgpLlj5blvpdcclxuICBjb25zdCB2YWxpZEFwaUtleSA9IGF3YWl0IGdldEFwaUtleSgpO1xyXG5cclxuICBpZiAoYXBpS2V5ICE9PSB2YWxpZEFwaUtleSkge1xyXG4gICAgdGhyb3cgbmV3IEF1dGhlbnRpY2F0aW9uRXJyb3IoJ0ludmFsaWQgQVBJIGtleScpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIGRpc2Nsb3N1cmVfaWTjga7jg5Djg6rjg4fjg7zjgrfjg6fjg7NcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEFQSUdhdGV3YXlQcm94eUV2ZW50XHJcbiAqIEByZXR1cm5zIGRpc2Nsb3N1cmVfaWRcclxuICogQHRocm93cyBWYWxpZGF0aW9uRXJyb3IgZGlzY2xvc3VyZV9pZOOBjOeEoeWKueOBquWgtOWQiFxyXG4gKi9cclxuZnVuY3Rpb24gdmFsaWRhdGVEaXNjbG9zdXJlSWQoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogc3RyaW5nIHtcclxuICBjb25zdCBkaXNjbG9zdXJlSWQgPSBldmVudC5wYXRoUGFyYW1ldGVycz8uZGlzY2xvc3VyZV9pZDtcclxuXHJcbiAgaWYgKCFkaXNjbG9zdXJlSWQpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ2Rpc2Nsb3N1cmVfaWQgaXMgcmVxdWlyZWQnKTtcclxuICB9XHJcblxyXG4gIC8vIGRpc2Nsb3N1cmVfaWTjga7jg5Xjgqnjg7zjg57jg4Pjg4jmpJzoqLzvvIjkvos6IDIwMjQwMTE1XzcyMDNfMDAx77yJXHJcbiAgaWYgKCEvXlxcZHs4fV9cXGR7NH1fXFxkezN9JC8udGVzdChkaXNjbG9zdXJlSWQpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCBkaXNjbG9zdXJlX2lkIGZvcm1hdDogJHtkaXNjbG9zdXJlSWR9LiBFeHBlY3RlZCBmb3JtYXQ6IFlZWVlNTUREX0NDQ0NfTk5OYFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBkaXNjbG9zdXJlSWQ7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBleHBpcmF0aW9u44OR44Op44Oh44O844K/44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAqXHJcbiAqIEBwYXJhbSBldmVudCBBUElHYXRld2F5UHJveHlFdmVudFxyXG4gKiBAcmV0dXJucyBleHBpcmF0aW9u77yI56eS77yJXHJcbiAqIEB0aHJvd3MgVmFsaWRhdGlvbkVycm9yIGV4cGlyYXRpb27jgYznhKHlirnjgarloLTlkIhcclxuICovXHJcbmZ1bmN0aW9uIHZhbGlkYXRlRXhwaXJhdGlvbihldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBudW1iZXIge1xyXG4gIGNvbnN0IGV4cGlyYXRpb25QYXJhbSA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycz8uZXhwaXJhdGlvbjtcclxuXHJcbiAgaWYgKCFleHBpcmF0aW9uUGFyYW0pIHtcclxuICAgIHJldHVybiBERUZBVUxUX0VYUElSQVRJT047XHJcbiAgfVxyXG5cclxuICBjb25zdCBleHBpcmF0aW9uID0gcGFyc2VJbnQoZXhwaXJhdGlvblBhcmFtLCAxMCk7XHJcblxyXG4gIGlmIChpc05hTihleHBpcmF0aW9uKSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEludmFsaWQgZXhwaXJhdGlvbiBmb3JtYXQ6ICR7ZXhwaXJhdGlvblBhcmFtfS4gRXhwZWN0ZWQgaW50ZWdlci5gXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgaWYgKGV4cGlyYXRpb24gPCBNSU5fRVhQSVJBVElPTiB8fCBleHBpcmF0aW9uID4gTUFYX0VYUElSQVRJT04pIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgIGBFeHBpcmF0aW9uIG91dCBvZiByYW5nZTogJHtleHBpcmF0aW9ufS4gTXVzdCBiZSBiZXR3ZWVuICR7TUlOX0VYUElSQVRJT059IGFuZCAke01BWF9FWFBJUkFUSU9OfSBzZWNvbmRzLmBcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gZXhwaXJhdGlvbjtcclxufVxyXG5cclxuLyoqXHJcbiAqIER5bmFtb0RC44GL44KJ6ZaL56S65oOF5aCx44KS5Y+W5b6XXHJcbiAqXHJcbiAqIEBwYXJhbSBkaXNjbG9zdXJlSWQg6ZaL56S6SURcclxuICogQHJldHVybnMg6ZaL56S65oOF5aCxXHJcbiAqIEB0aHJvd3MgTm90Rm91bmRFcnJvciDplovnpLrmg4XloLHjgYzopovjgaTjgYvjgonjgarjgYTloLTlkIhcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIGdldERpc2Nsb3N1cmUoZGlzY2xvc3VyZUlkOiBzdHJpbmcpOiBQcm9taXNlPERpc2Nsb3N1cmU+IHtcclxuICBsb2dnZXIuaW5mbygnRmV0Y2hpbmcgZGlzY2xvc3VyZSBmcm9tIER5bmFtb0RCJywge1xyXG4gICAgZGlzY2xvc3VyZV9pZDogZGlzY2xvc3VyZUlkLFxyXG4gICAgdGFibGU6IERJU0NMT1NVUkVTX1RBQkxFLFxyXG4gIH0pO1xyXG5cclxuICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXRyeVdpdGhCYWNrb2ZmKFxyXG4gICAgYXN5bmMgKCkgPT4ge1xyXG4gICAgICByZXR1cm4gYXdhaXQgZHluYW1vQ2xpZW50LnNlbmQoXHJcbiAgICAgICAgbmV3IEdldEl0ZW1Db21tYW5kKHtcclxuICAgICAgICAgIFRhYmxlTmFtZTogRElTQ0xPU1VSRVNfVEFCTEUsXHJcbiAgICAgICAgICBLZXk6IHtcclxuICAgICAgICAgICAgZGlzY2xvc3VyZV9pZDogeyBTOiBkaXNjbG9zdXJlSWQgfSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSlcclxuICAgICAgKTtcclxuICAgIH0sXHJcbiAgICB7XHJcbiAgICAgIG1heFJldHJpZXM6IDMsXHJcbiAgICAgIGluaXRpYWxEZWxheTogMTAwMCxcclxuICAgICAgYmFja29mZk11bHRpcGxpZXI6IDIsXHJcbiAgICAgIGppdHRlcjogdHJ1ZSxcclxuICAgICAgc2hvdWxkUmV0cnk6IChlcnJvcikgPT4ge1xyXG4gICAgICAgIHJldHVybiBlcnJvci5uYW1lID09PSAnUHJvdmlzaW9uZWRUaHJvdWdocHV0RXhjZWVkZWRFeGNlcHRpb24nO1xyXG4gICAgICB9LFxyXG4gICAgfVxyXG4gICk7XHJcblxyXG4gIGlmICghcmVzdWx0Lkl0ZW0pIHtcclxuICAgIHRocm93IG5ldyBOb3RGb3VuZEVycm9yKGBEaXNjbG9zdXJlIG5vdCBmb3VuZDogJHtkaXNjbG9zdXJlSWR9YCk7XHJcbiAgfVxyXG5cclxuICAvLyBEeW5hbW9EQuOCouOCpOODhuODoOOCkkRpc2Nsb3N1cmXjgavlpInmj5tcclxuICBjb25zdCBpdGVtID0gcmVzdWx0Lkl0ZW07XHJcblxyXG4gIGNvbnN0IGRpc2Nsb3N1cmU6IERpc2Nsb3N1cmUgPSB7XHJcbiAgICBkaXNjbG9zdXJlX2lkOiBpdGVtLmRpc2Nsb3N1cmVfaWQuUyEsXHJcbiAgICBjb21wYW55X2NvZGU6IGl0ZW0uY29tcGFueV9jb2RlLlMhLFxyXG4gICAgY29tcGFueV9uYW1lOiBpdGVtLmNvbXBhbnlfbmFtZS5TISxcclxuICAgIHBkZl9zM19rZXk6IGl0ZW0ucGRmX3MzX2tleT8uUyB8fCBudWxsLFxyXG4gIH07XHJcblxyXG4gIGxvZ2dlci5pbmZvKCdEaXNjbG9zdXJlIGZldGNoZWQgc3VjY2Vzc2Z1bGx5Jywge1xyXG4gICAgZGlzY2xvc3VyZV9pZDogZGlzY2xvc3VyZUlkLFxyXG4gICAgcGRmX3MzX2tleTogZGlzY2xvc3VyZS5wZGZfczNfa2V5LFxyXG4gIH0pO1xyXG5cclxuICByZXR1cm4gZGlzY2xvc3VyZTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFMz44Kq44OW44K444Kn44Kv44OI44Gu5a2Y5Zyo56K66KqNXHJcbiAqXHJcbiAqIEBwYXJhbSBzM0tleSBTM+OCreODvFxyXG4gKiBAdGhyb3dzIE5vdEZvdW5kRXJyb3IgUzPjgqrjg5bjgrjjgqfjgq/jg4jjgYzlrZjlnKjjgZfjgarjgYTloLTlkIhcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIHZlcmlmeVMzT2JqZWN0RXhpc3RzKHMzS2V5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICBsb2dnZXIuaW5mbygnVmVyaWZ5aW5nIFMzIG9iamVjdCBleGlzdHMnLCB7XHJcbiAgICBzM19rZXk6IHMzS2V5LFxyXG4gICAgYnVja2V0OiBQREZfQlVDS0VULFxyXG4gIH0pO1xyXG5cclxuICB0cnkge1xyXG4gICAgYXdhaXQgcmV0cnlXaXRoQmFja29mZihcclxuICAgICAgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIGF3YWl0IHMzQ2xpZW50LnNlbmQoXHJcbiAgICAgICAgICBuZXcgSGVhZE9iamVjdENvbW1hbmQoe1xyXG4gICAgICAgICAgICBCdWNrZXQ6IFBERl9CVUNLRVQsXHJcbiAgICAgICAgICAgIEtleTogczNLZXksXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICAgIH0sXHJcbiAgICAgIHtcclxuICAgICAgICBtYXhSZXRyaWVzOiAzLFxyXG4gICAgICAgIGluaXRpYWxEZWxheTogMTAwMCxcclxuICAgICAgICBiYWNrb2ZmTXVsdGlwbGllcjogMixcclxuICAgICAgICBqaXR0ZXI6IHRydWUsXHJcbiAgICAgICAgc2hvdWxkUmV0cnk6IChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgLy8gNDA044Ko44Op44O844Gv5YaN6Kmm6KGM44GX44Gq44GEXHJcbiAgICAgICAgICBpZiAoZXJyb3IubmFtZSA9PT0gJ05vdEZvdW5kJyB8fCBlcnJvci4kbWV0YWRhdGE/Lmh0dHBTdGF0dXNDb2RlID09PSA0MDQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8g44Gd44Gu5LuW44Gu44Ko44Op44O844Gv5YaN6Kmm6KGMXHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9LFxyXG4gICAgICB9XHJcbiAgICApO1xyXG5cclxuICAgIGxvZ2dlci5pbmZvKCdTMyBvYmplY3QgZXhpc3RzJywgeyBzM19rZXk6IHMzS2V5IH0pO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBpZiAoKGVycm9yIGFzIGFueSkubmFtZSA9PT0gJ05vdEZvdW5kJyB8fCAoZXJyb3IgYXMgYW55KS4kbWV0YWRhdGE/Lmh0dHBTdGF0dXNDb2RlID09PSA0MDQpIHtcclxuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoYFBERiBmaWxlIG5vdCBmb3VuZCBpbiBTMzogJHtzM0tleX1gKTtcclxuICAgIH1cclxuICAgIHRocm93IGVycm9yO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOe9suWQjeS7mOOBjVVSTOOCkueUn+aIkFxyXG4gKlxyXG4gKiBAcGFyYW0gczNLZXkgUzPjgq3jg7xcclxuICogQHBhcmFtIGV4cGlyZXNJbiDmnInlirnmnJ/pmZDvvIjnp5LvvIlcclxuICogQHJldHVybnMg572y5ZCN5LuY44GNVVJMXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBnZW5lcmF0ZVNpZ25lZFVybChzM0tleTogc3RyaW5nLCBleHBpcmVzSW46IG51bWJlcik6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgbG9nZ2VyLmluZm8oJ0dlbmVyYXRpbmcgc2lnbmVkIFVSTCcsIHtcclxuICAgIHMzX2tleTogczNLZXksXHJcbiAgICBidWNrZXQ6IFBERl9CVUNLRVQsXHJcbiAgICBleHBpcmVzX2luOiBleHBpcmVzSW4sXHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0T2JqZWN0Q29tbWFuZCh7XHJcbiAgICBCdWNrZXQ6IFBERl9CVUNLRVQsXHJcbiAgICBLZXk6IHMzS2V5LFxyXG4gIH0pO1xyXG5cclxuICBjb25zdCBzaWduZWRVcmwgPSBhd2FpdCBnZXRTaWduZWRVcmwoczNDbGllbnQsIGNvbW1hbmQsIHsgZXhwaXJlc0luIH0pO1xyXG5cclxuICBsb2dnZXIuaW5mbygnU2lnbmVkIFVSTCBnZW5lcmF0ZWQgc3VjY2Vzc2Z1bGx5Jywge1xyXG4gICAgczNfa2V5OiBzM0tleSxcclxuICAgIHVybF9sZW5ndGg6IHNpZ25lZFVybC5sZW5ndGgsXHJcbiAgfSk7XHJcblxyXG4gIHJldHVybiBzaWduZWRVcmw7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgqjjg6njg7zjg4/jg7Pjg4njg6rjg7PjgrBcclxuICpcclxuICogQHBhcmFtIGVycm9yIOOCqOODqeODvOOCquODluOCuOOCp+OCr+ODiFxyXG4gKiBAcGFyYW0gcmVxdWVzdElkIOODquOCr+OCqOOCueODiElEXHJcbiAqIEByZXR1cm5zIEFQSUdhdGV3YXlQcm94eVJlc3VsdFxyXG4gKi9cclxuZnVuY3Rpb24gaGFuZGxlRXJyb3IoZXJyb3I6IEVycm9yLCByZXF1ZXN0SWQ6IHN0cmluZyk6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCB7XHJcbiAgLy8g44Ko44Op44O856iu5Yil44Gr5b+c44GY44Gf44K544OG44O844K/44K544Kz44O844OJ44Go44Ko44Op44O844Kz44O844OJXHJcbiAgbGV0IHN0YXR1c0NvZGUgPSA1MDA7XHJcbiAgbGV0IGVycm9yQ29kZSA9ICdJTlRFUk5BTF9FUlJPUic7XHJcblxyXG4gIGlmIChlcnJvciBpbnN0YW5jZW9mIFZhbGlkYXRpb25FcnJvcikge1xyXG4gICAgc3RhdHVzQ29kZSA9IDQwMDtcclxuICAgIGVycm9yQ29kZSA9ICdWQUxJREFUSU9OX0VSUk9SJztcclxuICB9IGVsc2UgaWYgKGVycm9yIGluc3RhbmNlb2YgQXV0aGVudGljYXRpb25FcnJvcikge1xyXG4gICAgc3RhdHVzQ29kZSA9IDQwMTtcclxuICAgIGVycm9yQ29kZSA9ICdVTkFVVEhPUklaRUQnO1xyXG4gIH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEVycm9yKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDA0O1xyXG4gICAgZXJyb3JDb2RlID0gJ05PVF9GT1VORCc7XHJcbiAgfVxyXG5cclxuICByZXR1cm4ge1xyXG4gICAgc3RhdHVzQ29kZSxcclxuICAgIGhlYWRlcnM6IHtcclxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLFgtQXBpLUtleScsXHJcbiAgICB9LFxyXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICBzdGF0dXM6ICdlcnJvcicsXHJcbiAgICAgIGVycm9yOiB7XHJcbiAgICAgICAgY29kZTogZXJyb3JDb2RlLFxyXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXHJcbiAgICAgICAgZGV0YWlsczogKGVycm9yIGFzIGFueSkuZGV0YWlscyB8fCB7fSxcclxuICAgICAgfSxcclxuICAgICAgcmVxdWVzdF9pZDogcmVxdWVzdElkLFxyXG4gICAgfSksXHJcbiAgfTtcclxufVxyXG5cclxuLyoqXHJcbiAqIOmWi+ekuuaDheWgseOBruWei+Wumue+qe+8iOacgOWwj+mZkO+8iVxyXG4gKi9cclxuaW50ZXJmYWNlIERpc2Nsb3N1cmUge1xyXG4gIGRpc2Nsb3N1cmVfaWQ6IHN0cmluZztcclxuICBjb21wYW55X2NvZGU6IHN0cmluZztcclxuICBjb21wYW55X25hbWU6IHN0cmluZztcclxuICBwZGZfczNfa2V5OiBzdHJpbmcgfCBudWxsO1xyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==