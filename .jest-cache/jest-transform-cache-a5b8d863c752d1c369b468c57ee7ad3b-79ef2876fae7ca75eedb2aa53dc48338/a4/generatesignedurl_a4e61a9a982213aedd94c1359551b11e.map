{"version":3,"names":["cov_16ksq5qv17","path","hash","global","Function","gcv","coverageData","statementMap","start","line","column","end","fnMap","name","decl","loc","branchMap","type","locations","s","f","b","inputSourceMap","file","mappings","names","sources","sourcesContent","version","_coverageSchema","coverage","actualCoverage","exports","generateSignedUrl","client_s3_1","require","s3_request_presigner_1","logger_1","errors_1","s3Client","S3Client","region","process","env","AWS_REGION","EXPORT_BUCKET","EXPORT_BUCKET_NAME","s3_key","expiresIn","logger","info","expires_in","command","GetObjectCommand","Bucket","Key","signedUrl","getSignedUrl","signed_url","error","error_type","error_message","message","context","stack_trace","stack","RetryableError","cause"],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\generate-signed-url.ts"],"sourcesContent":["/**\r\n * 署名付きURL生成\r\n *\r\n * S3オブジェクトの署名付きURLを生成します（有効期限7日）。\r\n *\r\n * Requirements: 要件5.1（エクスポート）\r\n */\r\n\r\nimport { S3Client, GetObjectCommand } from '@aws-sdk/client-s3';\r\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\r\nimport { logger } from '../../utils/logger';\r\nimport { RetryableError } from '../../errors';\r\n\r\n// S3クライアント（グローバルスコープで初期化）\r\nconst s3Client = new S3Client({ region: process.env.AWS_REGION || 'ap-northeast-1' });\r\n\r\n// 環境変数\r\nconst EXPORT_BUCKET = process.env.EXPORT_BUCKET_NAME || 'tdnet-exports';\r\n\r\n/**\r\n * 署名付きURLを生成\r\n *\r\n * @param s3_key S3キー\r\n * @param expiresIn 有効期限（秒）\r\n * @returns 署名付きURL\r\n * @throws {RetryableError} S3アクセスエラー時\r\n */\r\nexport async function generateSignedUrl(\r\n  s3_key: string,\r\n  expiresIn: number = 7 * 24 * 60 * 60 // デフォルト: 7日間\r\n): Promise<string> {\r\n  try {\r\n    logger.info('Generating signed URL', {\r\n      s3_key,\r\n      expires_in: expiresIn,\r\n    });\r\n\r\n    // GetObjectCommandを作成\r\n    const command = new GetObjectCommand({\r\n      Bucket: EXPORT_BUCKET,\r\n      Key: s3_key,\r\n    });\r\n\r\n    // 署名付きURLを生成\r\n    const signedUrl = await getSignedUrl(s3Client, command, { expiresIn });\r\n\r\n    logger.info('Signed URL generated successfully', {\r\n      s3_key,\r\n      signed_url: signedUrl,\r\n    });\r\n\r\n    return signedUrl;\r\n  } catch (error) {\r\n    logger.error('Failed to generate signed URL', {\r\n      error_type: error.name,\r\n      error_message: error.message,\r\n      context: { s3_key, expires_in: expiresIn },\r\n      stack_trace: error.stack,\r\n    });\r\n\r\n    // S3エラーは再試行可能\r\n    throw new RetryableError('Failed to generate signed URL', {\r\n      cause: error,\r\n      context: { s3_key, expires_in: expiresIn },\r\n    });\r\n  }\r\n}\r\n"],"mappings":"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","ignoreList":[]}