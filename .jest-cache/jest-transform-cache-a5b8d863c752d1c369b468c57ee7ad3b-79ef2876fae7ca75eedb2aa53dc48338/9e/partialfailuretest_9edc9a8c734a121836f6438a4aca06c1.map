{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\__tests__\\partial-failure.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\__tests__\\partial-failure.test.ts"],"sourcesContent":["/**\r\n * 部分的失敗のユニットテスト\r\n *\r\n * Property 7: エラー時の部分的成功\r\n * Validates: Requirements 6.4\r\n *\r\n * 一部の開示情報の処理が失敗しても、成功した開示情報は永続化されることを検証します。\r\n */\r\n\r\nimport { DynamoDBClient, PutItemCommand } from '@aws-sdk/client-dynamodb';\r\nimport { mockClient } from 'aws-sdk-client-mock';\r\nimport { saveMetadata } from '../save-metadata';\r\nimport { Disclosure } from '../../../types';\r\n\r\n// モック設定\r\nconst dynamoMock = mockClient(DynamoDBClient);\r\n\r\ndescribe('Property 7: エラー時の部分的成功', () => {\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n    dynamoMock.reset();\r\n    process.env.DYNAMODB_TABLE = 'test-table';\r\n  });\r\n\r\n  describe('ユニットテスト', () => {\r\n    it('一部が失敗しても成功した開示情報は永続化される', async () => {\r\n      // Arrange\r\n      const disclosures: Disclosure[] = [\r\n        {\r\n          disclosure_id: 'TD20240115001',\r\n          company_code: '1234',\r\n          company_name: '株式会社サンプル1',\r\n          disclosure_type: '決算短信',\r\n          title: 'テスト開示1',\r\n          disclosed_at: '2024-01-15T10:30:00Z',\r\n          pdf_url: 'https://example.com/test1.pdf',\r\n          s3_key: '',\r\n          collected_at: '',\r\n          date_partition: '',\r\n        },\r\n        {\r\n          disclosure_id: 'TD20240115002',\r\n          company_code: '5678',\r\n          company_name: '株式会社サンプル2',\r\n          disclosure_type: '有価証券報告書',\r\n          title: 'テスト開示2',\r\n          disclosed_at: '2024-01-15T11:00:00Z',\r\n          pdf_url: 'https://example.com/test2.pdf',\r\n          s3_key: '',\r\n          collected_at: '',\r\n          date_partition: '',\r\n        },\r\n        {\r\n          disclosure_id: 'TD20240115003',\r\n          company_code: '9012',\r\n          company_name: '株式会社サンプル3',\r\n          disclosure_type: '適時開示',\r\n          title: 'テスト開示3',\r\n          disclosed_at: '2024-01-15T12:00:00Z',\r\n          pdf_url: 'https://example.com/test3.pdf',\r\n          s3_key: '',\r\n          collected_at: '',\r\n          date_partition: '',\r\n        },\r\n      ];\r\n\r\n      // モックの設定: 1件目成功、2件目失敗、3件目成功\r\n      let callCount = 0;\r\n      dynamoMock.on(PutItemCommand).callsFake(() => {\r\n        callCount++;\r\n        if (callCount === 2) {\r\n          throw new Error('DynamoDB error');\r\n        }\r\n        return {};\r\n      });\r\n\r\n      // Act\r\n      const results = await Promise.allSettled(\r\n        disclosures.map((disclosure) =>\r\n          saveMetadata(disclosure, `2024/01/15/${disclosure.disclosure_id}.pdf`)\r\n        )\r\n      );\r\n\r\n      // Assert\r\n      const successCount = results.filter((r) => r.status === 'fulfilled').length;\r\n      const failedCount = results.filter((r) => r.status === 'rejected').length;\r\n\r\n      expect(successCount).toBe(2); // 1件目と3件目が成功\r\n      expect(failedCount).toBe(1); // 2件目が失敗\r\n      expect(dynamoMock.calls()).toHaveLength(3); // 3回呼ばれた\r\n    });\r\n\r\n    it('すべて成功した場合、ステータスはsuccessになる', async () => {\r\n      // Arrange\r\n      const disclosures: Disclosure[] = [\r\n        {\r\n          disclosure_id: 'TD20240115001',\r\n          company_code: '1234',\r\n          company_name: '株式会社サンプル1',\r\n          disclosure_type: '決算短信',\r\n          title: 'テスト開示1',\r\n          disclosed_at: '2024-01-15T10:30:00Z',\r\n          pdf_url: 'https://example.com/test1.pdf',\r\n          s3_key: '',\r\n          collected_at: '',\r\n          date_partition: '',\r\n        },\r\n        {\r\n          disclosure_id: 'TD20240115002',\r\n          company_code: '5678',\r\n          company_name: '株式会社サンプル2',\r\n          disclosure_type: '有価証券報告書',\r\n          title: 'テスト開示2',\r\n          disclosed_at: '2024-01-15T11:00:00Z',\r\n          pdf_url: 'https://example.com/test2.pdf',\r\n          s3_key: '',\r\n          collected_at: '',\r\n          date_partition: '',\r\n        },\r\n      ];\r\n\r\n      dynamoMock.on(PutItemCommand).resolves({});\r\n\r\n      // Act\r\n      const results = await Promise.allSettled(\r\n        disclosures.map((disclosure) =>\r\n          saveMetadata(disclosure, `2024/01/15/${disclosure.disclosure_id}.pdf`)\r\n        )\r\n      );\r\n\r\n      // Assert\r\n      const successCount = results.filter((r) => r.status === 'fulfilled').length;\r\n      const failedCount = results.filter((r) => r.status === 'rejected').length;\r\n\r\n      expect(successCount).toBe(2);\r\n      expect(failedCount).toBe(0);\r\n\r\n      // ステータス判定\r\n      const status =\r\n        failedCount === 0 ? 'success' : successCount > 0 ? 'partial_success' : 'failed';\r\n      expect(status).toBe('success');\r\n    });\r\n\r\n    it('一部失敗した場合、ステータスはpartial_successになる', async () => {\r\n      // Arrange\r\n      const disclosures: Disclosure[] = [\r\n        {\r\n          disclosure_id: 'TD20240115001',\r\n          company_code: '1234',\r\n          company_name: '株式会社サンプル1',\r\n          disclosure_type: '決算短信',\r\n          title: 'テスト開示1',\r\n          disclosed_at: '2024-01-15T10:30:00Z',\r\n          pdf_url: 'https://example.com/test1.pdf',\r\n          s3_key: '',\r\n          collected_at: '',\r\n          date_partition: '',\r\n        },\r\n        {\r\n          disclosure_id: 'TD20240115002',\r\n          company_code: '5678',\r\n          company_name: '株式会社サンプル2',\r\n          disclosure_type: '有価証券報告書',\r\n          title: 'テスト開示2',\r\n          disclosed_at: '2024-01-15T11:00:00Z',\r\n          pdf_url: 'https://example.com/test2.pdf',\r\n          s3_key: '',\r\n          collected_at: '',\r\n          date_partition: '',\r\n        },\r\n      ];\r\n\r\n      // 1件目: 成功\r\n      dynamoMock.on(PutItemCommand).resolvesOnce({});\r\n\r\n      // 2件目: 失敗\r\n      dynamoMock.on(PutItemCommand).rejectsOnce(new Error('DynamoDB error'));\r\n\r\n      // Act\r\n      const results = await Promise.allSettled(\r\n        disclosures.map((disclosure) =>\r\n          saveMetadata(disclosure, `2024/01/15/${disclosure.disclosure_id}.pdf`)\r\n        )\r\n      );\r\n\r\n      // Assert\r\n      const successCount = results.filter((r) => r.status === 'fulfilled').length;\r\n      const failedCount = results.filter((r) => r.status === 'rejected').length;\r\n\r\n      expect(successCount).toBe(1);\r\n      expect(failedCount).toBe(1);\r\n\r\n      // ステータス判定\r\n      const status =\r\n        failedCount === 0 ? 'success' : successCount > 0 ? 'partial_success' : 'failed';\r\n      expect(status).toBe('partial_success');\r\n    });\r\n\r\n    it('すべて失敗した場合、ステータスはfailedになる', async () => {\r\n      // Arrange\r\n      const disclosures: Disclosure[] = [\r\n        {\r\n          disclosure_id: 'TD20240115001',\r\n          company_code: '1234',\r\n          company_name: '株式会社サンプル1',\r\n          disclosure_type: '決算短信',\r\n          title: 'テスト開示1',\r\n          disclosed_at: '2024-01-15T10:30:00Z',\r\n          pdf_url: 'https://example.com/test1.pdf',\r\n          s3_key: '',\r\n          collected_at: '',\r\n          date_partition: '',\r\n        },\r\n        {\r\n          disclosure_id: 'TD20240115002',\r\n          company_code: '5678',\r\n          company_name: '株式会社サンプル2',\r\n          disclosure_type: '有価証券報告書',\r\n          title: 'テスト開示2',\r\n          disclosed_at: '2024-01-15T11:00:00Z',\r\n          pdf_url: 'https://example.com/test2.pdf',\r\n          s3_key: '',\r\n          collected_at: '',\r\n          date_partition: '',\r\n        },\r\n      ];\r\n\r\n      // すべて失敗\r\n      dynamoMock.on(PutItemCommand).rejects(new Error('DynamoDB error'));\r\n\r\n      // Act\r\n      const results = await Promise.allSettled(\r\n        disclosures.map((disclosure) =>\r\n          saveMetadata(disclosure, `2024/01/15/${disclosure.disclosure_id}.pdf`)\r\n        )\r\n      );\r\n\r\n      // Assert\r\n      const successCount = results.filter((r) => r.status === 'fulfilled').length;\r\n      const failedCount = results.filter((r) => r.status === 'rejected').length;\r\n\r\n      expect(successCount).toBe(0);\r\n      expect(failedCount).toBe(2);\r\n\r\n      // ステータス判定\r\n      const status =\r\n        failedCount === 0 ? 'success' : successCount > 0 ? 'partial_success' : 'failed';\r\n      expect(status).toBe('failed');\r\n    });\r\n\r\n    it('collected_countとfailed_countが正確にカウントされる', async () => {\r\n      // Arrange\r\n      const disclosures: Disclosure[] = Array.from({ length: 10 }, (_, i) => ({\r\n        disclosure_id: `TD2024011500${String(i + 1).padStart(2, '0')}`,\r\n        company_code: `${1000 + i}`,\r\n        company_name: `株式会社サンプル${i + 1}`,\r\n        disclosure_type: '決算短信',\r\n        title: `テスト開示${i + 1}`,\r\n        disclosed_at: '2024-01-15T10:30:00Z',\r\n        pdf_url: `https://example.com/test${i + 1}.pdf`,\r\n        s3_key: '',\r\n        collected_at: '',\r\n        date_partition: '',\r\n      }));\r\n\r\n      // 7件成功、3件失敗（4番目、7番目、10番目が失敗）\r\n      let callCount = 0;\r\n      dynamoMock.on(PutItemCommand).callsFake(() => {\r\n        callCount++;\r\n        if (callCount === 4 || callCount === 7 || callCount === 10) {\r\n          throw new Error('Error');\r\n        }\r\n        return {};\r\n      });\r\n\r\n      // Act\r\n      const results = await Promise.allSettled(\r\n        disclosures.map((disclosure) =>\r\n          saveMetadata(disclosure, `2024/01/15/${disclosure.disclosure_id}.pdf`)\r\n        )\r\n      );\r\n\r\n      // Assert\r\n      const collected_count = results.filter((r) => r.status === 'fulfilled').length;\r\n      const failed_count = results.filter((r) => r.status === 'rejected').length;\r\n\r\n      expect(collected_count).toBe(7);\r\n      expect(failed_count).toBe(3);\r\n    });\r\n  });\r\n});\r\n"],"version":3}