{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\update-export-status.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\update-export-status.ts"],"sourcesContent":["/**\r\n * エクスポートステータス更新\r\n *\r\n * エクスポート状態の更新、エラー時のエラーメッセージ記録を行います。\r\n *\r\n * Requirements: 要件5.4（進捗）\r\n */\r\n\r\nimport { DynamoDBClient, UpdateItemCommand } from '@aws-sdk/client-dynamodb';\r\nimport { logger } from '../../utils/logger';\r\nimport { retryWithBackoff } from '../../utils/retry';\r\n\r\n// DynamoDBクライアント（グローバルスコープで初期化）\r\nconst dynamoClient = new DynamoDBClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });\r\n\r\n// 環境変数\r\nconst EXPORT_STATUS_TABLE = process.env.EXPORT_STATUS_TABLE_NAME || 'tdnet-export-status';\r\n\r\n/**\r\n * エクスポートステータスを更新\r\n *\r\n * @param export_id エクスポートID\r\n * @param status 状態（pending, processing, completed, failed）\r\n * @param progress 進捗率（0〜100）\r\n * @param s3_key S3キー（オプション）\r\n * @param download_url ダウンロードURL（オプション）\r\n * @param error_message エラーメッセージ（オプション）\r\n */\r\nexport async function updateExportStatus(\r\n  export_id: string,\r\n  status: 'pending' | 'processing' | 'completed' | 'failed',\r\n  progress: number,\r\n  s3_key?: string,\r\n  download_url?: string,\r\n  error_message?: string\r\n): Promise<void> {\r\n  logger.info('Updating export status', {\r\n    export_id,\r\n    status,\r\n    progress,\r\n    s3_key,\r\n    download_url,\r\n    error_message,\r\n  });\r\n\r\n  // 更新式を構築\r\n  const updateExpressions: string[] = [];\r\n  const expressionAttributeNames: Record<string, string> = {};\r\n  const expressionAttributeValues: Record<string, any> = {};\r\n\r\n  // status\r\n  updateExpressions.push('#status = :status');\r\n  expressionAttributeNames['#status'] = 'status';\r\n  expressionAttributeValues[':status'] = { S: status };\r\n\r\n  // progress\r\n  updateExpressions.push('#progress = :progress');\r\n  expressionAttributeNames['#progress'] = 'progress';\r\n  expressionAttributeValues[':progress'] = { N: String(progress) };\r\n\r\n  // completed_at（completedまたはfailedの場合）\r\n  if (status === 'completed' || status === 'failed') {\r\n    updateExpressions.push('#completed_at = :completed_at');\r\n    expressionAttributeNames['#completed_at'] = 'completed_at';\r\n    expressionAttributeValues[':completed_at'] = { S: new Date().toISOString() };\r\n  }\r\n\r\n  // s3_key（オプション）\r\n  if (s3_key) {\r\n    updateExpressions.push('#s3_key = :s3_key');\r\n    expressionAttributeNames['#s3_key'] = 's3_key';\r\n    expressionAttributeValues[':s3_key'] = { S: s3_key };\r\n  }\r\n\r\n  // download_url（オプション）\r\n  if (download_url) {\r\n    updateExpressions.push('#download_url = :download_url');\r\n    expressionAttributeNames['#download_url'] = 'download_url';\r\n    expressionAttributeValues[':download_url'] = { S: download_url };\r\n  }\r\n\r\n  // error_message（オプション）\r\n  if (error_message) {\r\n    updateExpressions.push('#error_message = :error_message');\r\n    expressionAttributeNames['#error_message'] = 'error_message';\r\n    expressionAttributeValues[':error_message'] = { S: error_message };\r\n  }\r\n\r\n  // DynamoDBを更新\r\n  await retryWithBackoff(\r\n    async () => {\r\n      await dynamoClient.send(\r\n        new UpdateItemCommand({\r\n          TableName: EXPORT_STATUS_TABLE,\r\n          Key: {\r\n            export_id: { S: export_id },\r\n          },\r\n          UpdateExpression: `SET ${updateExpressions.join(', ')}`,\r\n          ExpressionAttributeNames: expressionAttributeNames,\r\n          ExpressionAttributeValues: expressionAttributeValues,\r\n        })\r\n      );\r\n    },\r\n    {\r\n      maxRetries: 3,\r\n      initialDelay: 1000,\r\n      backoffMultiplier: 2,\r\n      jitter: true,\r\n      shouldRetry: (error) => {\r\n        return error.name === 'ProvisionedThroughputExceededException';\r\n      },\r\n    }\r\n  );\r\n\r\n  logger.info('Export status updated successfully', {\r\n    export_id,\r\n    status,\r\n    progress,\r\n  });\r\n}\r\n"],"version":3}