21c91e20354e44002564b6a613c13637
"use strict";
/**
 * Lambda Collector Dependencies
 *
 * 依存関係の注入（DI）パターンを実装し、テスト時にモックを注入可能にする。
 *
 * Requirements: テスト環境の整備（Task 9.4）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.createDefaultDependencies = createDefaultDependencies;
exports.getDependencies = getDependencies;
exports.setDependencies = setDependencies;
exports.resetDependencies = resetDependencies;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_s3_1 = require("@aws-sdk/client-s3");
const client_cloudwatch_1 = require("@aws-sdk/client-cloudwatch");
const rate_limiter_1 = require("../../utils/rate-limiter");
/**
 * デフォルトの依存関係を作成
 *
 * 本番環境では、この関数で作成した依存関係を使用する。
 * テスト環境では、モックを注入する。
 *
 * @returns CollectorDependencies
 */
function createDefaultDependencies() {
    // DynamoDB Client
    const dynamoClient = new client_dynamodb_1.DynamoDBClient({ region: 'ap-northeast-1' });
    const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient, {
        marshallOptions: {
            removeUndefinedValues: true,
            convertClassInstanceToMap: true,
        },
    });
    // S3 Client
    const s3Client = new client_s3_1.S3Client({ region: 'ap-northeast-1' });
    // CloudWatch Client
    const cloudWatchClient = new client_cloudwatch_1.CloudWatchClient({ region: 'ap-northeast-1' });
    // Rate Limiter（最小遅延2秒）
    const rateLimiter = new rate_limiter_1.RateLimiter(2000);
    return {
        dynamoClient: docClient,
        s3Client,
        cloudWatchClient,
        rateLimiter,
    };
}
/**
 * グローバルスコープで依存関係を初期化（Lambda実行間で再利用）
 *
 * テスト環境では、setDependencies()でモックを注入できる。
 */
let dependencies = null;
/**
 * 依存関係を取得
 *
 * 初回呼び出し時にデフォルトの依存関係を作成し、以降は再利用する。
 * テスト環境では、setDependencies()で事前にモックを注入できる。
 *
 * @returns CollectorDependencies
 */
function getDependencies() {
    if (!dependencies) {
        dependencies = createDefaultDependencies();
    }
    return dependencies;
}
/**
 * 依存関係を設定（テスト用）
 *
 * テスト環境でモックを注入するために使用する。
 *
 * @param deps CollectorDependencies
 */
function setDependencies(deps) {
    dependencies = deps;
}
/**
 * 依存関係をリセット（テスト用）
 *
 * テスト終了後にクリーンアップするために使用する。
 */
function resetDependencies() {
    dependencies = null;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGNvbGxlY3RvclxcZGVwZW5kZW5jaWVzLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7O0dBTUc7O0FBaUNILDhEQXlCQztBQWlCRCwwQ0FLQztBQVNELDBDQUVDO0FBT0QsOENBRUM7QUFsR0QsOERBQTBEO0FBQzFELHdEQUErRDtBQUMvRCxrREFBOEM7QUFDOUMsa0VBQThEO0FBQzlELDJEQUF1RDtBQW1CdkQ7Ozs7Ozs7R0FPRztBQUNILFNBQWdCLHlCQUF5QjtJQUN2QyxrQkFBa0I7SUFDbEIsTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLGdCQUFnQixFQUFFLENBQUMsQ0FBQztJQUN0RSxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFO1FBQzFELGVBQWUsRUFBRTtZQUNmLHFCQUFxQixFQUFFLElBQUk7WUFDM0IseUJBQXlCLEVBQUUsSUFBSTtTQUNoQztLQUNGLENBQUMsQ0FBQztJQUVILFlBQVk7SUFDWixNQUFNLFFBQVEsR0FBRyxJQUFJLG9CQUFRLENBQUMsRUFBRSxNQUFNLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO0lBRTVELG9CQUFvQjtJQUNwQixNQUFNLGdCQUFnQixHQUFHLElBQUksb0NBQWdCLENBQUMsRUFBRSxNQUFNLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO0lBRTVFLHVCQUF1QjtJQUN2QixNQUFNLFdBQVcsR0FBRyxJQUFJLDBCQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFMUMsT0FBTztRQUNMLFlBQVksRUFBRSxTQUFTO1FBQ3ZCLFFBQVE7UUFDUixnQkFBZ0I7UUFDaEIsV0FBVztLQUNaLENBQUM7QUFDSixDQUFDO0FBRUQ7Ozs7R0FJRztBQUNILElBQUksWUFBWSxHQUFpQyxJQUFJLENBQUM7QUFFdEQ7Ozs7Ozs7R0FPRztBQUNILFNBQWdCLGVBQWU7SUFDN0IsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ2xCLFlBQVksR0FBRyx5QkFBeUIsRUFBRSxDQUFDO0lBQzdDLENBQUM7SUFDRCxPQUFPLFlBQVksQ0FBQztBQUN0QixDQUFDO0FBRUQ7Ozs7OztHQU1HO0FBQ0gsU0FBZ0IsZUFBZSxDQUFDLElBQTJCO0lBQ3pELFlBQVksR0FBRyxJQUFJLENBQUM7QUFDdEIsQ0FBQztBQUVEOzs7O0dBSUc7QUFDSCxTQUFnQixpQkFBaUI7SUFDL0IsWUFBWSxHQUFHLElBQUksQ0FBQztBQUN0QixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcdGkxOThcXGludmVzdG1lbnRfYW5hbHlzaXNfb3BvcG9cXHNyY1xcbGFtYmRhXFxjb2xsZWN0b3JcXGRlcGVuZGVuY2llcy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogTGFtYmRhIENvbGxlY3RvciBEZXBlbmRlbmNpZXNcclxuICpcclxuICog5L6d5a2Y6Zai5L+C44Gu5rOo5YWl77yIREnvvInjg5Hjgr/jg7zjg7PjgpLlrp/oo4XjgZfjgIHjg4bjgrnjg4jmmYLjgavjg6Ljg4Pjgq/jgpLms6jlhaXlj6/og73jgavjgZnjgovjgIJcclxuICpcclxuICogUmVxdWlyZW1lbnRzOiDjg4bjgrnjg4jnkrDlooPjga7mlbTlgpnvvIhUYXNrIDkuNO+8iVxyXG4gKi9cclxuXHJcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcclxuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XHJcbmltcG9ydCB7IFMzQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcclxuaW1wb3J0IHsgQ2xvdWRXYXRjaENsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1jbG91ZHdhdGNoJztcclxuaW1wb3J0IHsgUmF0ZUxpbWl0ZXIgfSBmcm9tICcuLi8uLi91dGlscy9yYXRlLWxpbWl0ZXInO1xyXG5cclxuLyoqXHJcbiAqIExhbWJkYSBDb2xsZWN0b3Lkvp3lrZjplqLkv4JcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgQ29sbGVjdG9yRGVwZW5kZW5jaWVzIHtcclxuICAvKiogRHluYW1vREIgRG9jdW1lbnQgQ2xpZW50ICovXHJcbiAgZHluYW1vQ2xpZW50OiBEeW5hbW9EQkRvY3VtZW50Q2xpZW50O1xyXG5cclxuICAvKiogUzMgQ2xpZW50ICovXHJcbiAgczNDbGllbnQ6IFMzQ2xpZW50O1xyXG5cclxuICAvKiogQ2xvdWRXYXRjaCBDbGllbnQgKi9cclxuICBjbG91ZFdhdGNoQ2xpZW50OiBDbG91ZFdhdGNoQ2xpZW50O1xyXG5cclxuICAvKiogUmF0ZSBMaW1pdGVyICovXHJcbiAgcmF0ZUxpbWl0ZXI6IFJhdGVMaW1pdGVyO1xyXG59XHJcblxyXG4vKipcclxuICog44OH44OV44Kp44Or44OI44Gu5L6d5a2Y6Zai5L+C44KS5L2c5oiQXHJcbiAqXHJcbiAqIOacrOeVqueSsOWig+OBp+OBr+OAgeOBk+OBrumWouaVsOOBp+S9nOaIkOOBl+OBn+S+neWtmOmWouS/guOCkuS9v+eUqOOBmeOCi+OAglxyXG4gKiDjg4bjgrnjg4jnkrDlooPjgafjga/jgIHjg6Ljg4Pjgq/jgpLms6jlhaXjgZnjgovjgIJcclxuICpcclxuICogQHJldHVybnMgQ29sbGVjdG9yRGVwZW5kZW5jaWVzXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRGVmYXVsdERlcGVuZGVuY2llcygpOiBDb2xsZWN0b3JEZXBlbmRlbmNpZXMge1xyXG4gIC8vIER5bmFtb0RCIENsaWVudFxyXG4gIGNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7IHJlZ2lvbjogJ2FwLW5vcnRoZWFzdC0xJyB9KTtcclxuICBjb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZHluYW1vQ2xpZW50LCB7XHJcbiAgICBtYXJzaGFsbE9wdGlvbnM6IHtcclxuICAgICAgcmVtb3ZlVW5kZWZpbmVkVmFsdWVzOiB0cnVlLFxyXG4gICAgICBjb252ZXJ0Q2xhc3NJbnN0YW5jZVRvTWFwOiB0cnVlLFxyXG4gICAgfSxcclxuICB9KTtcclxuXHJcbiAgLy8gUzMgQ2xpZW50XHJcbiAgY29uc3QgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoeyByZWdpb246ICdhcC1ub3J0aGVhc3QtMScgfSk7XHJcblxyXG4gIC8vIENsb3VkV2F0Y2ggQ2xpZW50XHJcbiAgY29uc3QgY2xvdWRXYXRjaENsaWVudCA9IG5ldyBDbG91ZFdhdGNoQ2xpZW50KHsgcmVnaW9uOiAnYXAtbm9ydGhlYXN0LTEnIH0pO1xyXG5cclxuICAvLyBSYXRlIExpbWl0ZXLvvIjmnIDlsI/pgYXlu7Yy56eS77yJXHJcbiAgY29uc3QgcmF0ZUxpbWl0ZXIgPSBuZXcgUmF0ZUxpbWl0ZXIoMjAwMCk7XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBkeW5hbW9DbGllbnQ6IGRvY0NsaWVudCxcclxuICAgIHMzQ2xpZW50LFxyXG4gICAgY2xvdWRXYXRjaENsaWVudCxcclxuICAgIHJhdGVMaW1pdGVyLFxyXG4gIH07XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgrDjg63jg7zjg5Djg6vjgrnjgrPjg7zjg5fjgafkvp3lrZjplqLkv4LjgpLliJ3mnJ/ljJbvvIhMYW1iZGHlrp/ooYzplpPjgaflho3liKnnlKjvvIlcclxuICpcclxuICog44OG44K544OI55Kw5aKD44Gn44Gv44CBc2V0RGVwZW5kZW5jaWVzKCnjgafjg6Ljg4Pjgq/jgpLms6jlhaXjgafjgY3jgovjgIJcclxuICovXHJcbmxldCBkZXBlbmRlbmNpZXM6IENvbGxlY3RvckRlcGVuZGVuY2llcyB8IG51bGwgPSBudWxsO1xyXG5cclxuLyoqXHJcbiAqIOS+neWtmOmWouS/guOCkuWPluW+l1xyXG4gKlxyXG4gKiDliJ3lm57lkbzjgbPlh7rjgZfmmYLjgavjg4fjg5Xjgqnjg6vjg4jjga7kvp3lrZjplqLkv4LjgpLkvZzmiJDjgZfjgIHku6XpmY3jga/lho3liKnnlKjjgZnjgovjgIJcclxuICog44OG44K544OI55Kw5aKD44Gn44Gv44CBc2V0RGVwZW5kZW5jaWVzKCnjgafkuovliY3jgavjg6Ljg4Pjgq/jgpLms6jlhaXjgafjgY3jgovjgIJcclxuICpcclxuICogQHJldHVybnMgQ29sbGVjdG9yRGVwZW5kZW5jaWVzXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ2V0RGVwZW5kZW5jaWVzKCk6IENvbGxlY3RvckRlcGVuZGVuY2llcyB7XHJcbiAgaWYgKCFkZXBlbmRlbmNpZXMpIHtcclxuICAgIGRlcGVuZGVuY2llcyA9IGNyZWF0ZURlZmF1bHREZXBlbmRlbmNpZXMoKTtcclxuICB9XHJcbiAgcmV0dXJuIGRlcGVuZGVuY2llcztcclxufVxyXG5cclxuLyoqXHJcbiAqIOS+neWtmOmWouS/guOCkuioreWumu+8iOODhuOCueODiOeUqO+8iVxyXG4gKlxyXG4gKiDjg4bjgrnjg4jnkrDlooPjgafjg6Ljg4Pjgq/jgpLms6jlhaXjgZnjgovjgZ/jgoHjgavkvb/nlKjjgZnjgovjgIJcclxuICpcclxuICogQHBhcmFtIGRlcHMgQ29sbGVjdG9yRGVwZW5kZW5jaWVzXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gc2V0RGVwZW5kZW5jaWVzKGRlcHM6IENvbGxlY3RvckRlcGVuZGVuY2llcyk6IHZvaWQge1xyXG4gIGRlcGVuZGVuY2llcyA9IGRlcHM7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDkvp3lrZjplqLkv4LjgpLjg6rjgrvjg4Pjg4jvvIjjg4bjgrnjg4jnlKjvvIlcclxuICpcclxuICog44OG44K544OI57WC5LqG5b6M44Gr44Kv44Oq44O844Oz44Ki44OD44OX44GZ44KL44Gf44KB44Gr5L2/55So44GZ44KL44CCXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gcmVzZXREZXBlbmRlbmNpZXMoKTogdm9pZCB7XHJcbiAgZGVwZW5kZW5jaWVzID0gbnVsbDtcclxufVxyXG4iXSwidmVyc2lvbiI6M30=