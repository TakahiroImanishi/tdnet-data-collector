f4f54eb8c49681718d1cfe98736b2708
"use strict";
/**
 * Query Disclosures
 *
 * DynamoDBから開示情報を検索します。
 * GSI（Global Secondary Index）を使用して効率的にクエリします。
 *
 * Requirements: 要件4.1（検索API）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.queryDisclosures = queryDisclosures;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const util_dynamodb_1 = require("@aws-sdk/util-dynamodb");
const logger_1 = require("../../utils/logger");
const retry_1 = require("../../utils/retry");
const date_partition_1 = require("../../utils/date-partition");
// DynamoDBクライアント（グローバルスコープで初期化）
const dynamoClient = new client_dynamodb_1.DynamoDBClient({
    region: process.env.AWS_REGION || 'ap-northeast-1',
    maxAttempts: 3,
    ...(process.env.AWS_ENDPOINT_URL && {
        endpoint: process.env.AWS_ENDPOINT_URL,
    }),
});
const TABLE_NAME = process.env.DYNAMODB_TABLE_NAME || 'tdnet_disclosures';
/**
 * 開示情報を検索
 *
 * @param params クエリパラメータ
 * @returns クエリ結果
 */
async function queryDisclosures(params) {
    logger_1.logger.info('Querying disclosures', { params });
    let disclosures;
    // クエリ戦略の選択
    if (params.company_code) {
        // 企業コードでクエリ（GSI_CompanyCode_DiscloseDate使用）
        disclosures = await queryByCompanyCode(params);
    }
    else if (params.start_date && params.end_date) {
        // 日付範囲でクエリ（GSI_DatePartition使用）
        disclosures = await queryByDateRange(params);
    }
    else if (params.start_date) {
        // 開始日のみ指定（GSI_DatePartition使用）
        disclosures = await queryByDateRange({
            ...params,
            end_date: new Date().toISOString().split('T')[0], // 今日まで
        });
    }
    else {
        // フィルタなし（Scan）
        disclosures = await scanDisclosures(params);
    }
    // 開示種類でフィルタリング
    if (params.disclosure_type) {
        disclosures = disclosures.filter((d) => d.disclosure_type === params.disclosure_type);
    }
    // 開示日時で降順ソート
    disclosures.sort((a, b) => {
        return new Date(b.disclosed_at).getTime() - new Date(a.disclosed_at).getTime();
    });
    // ページネーション
    const total = disclosures.length;
    const paginatedDisclosures = disclosures.slice(params.offset, params.offset + params.limit);
    logger_1.logger.info('Query completed', {
        total,
        count: paginatedDisclosures.length,
        offset: params.offset,
        limit: params.limit,
    });
    return {
        disclosures: paginatedDisclosures,
        total,
        count: paginatedDisclosures.length,
        offset: params.offset,
        limit: params.limit,
    };
}
/**
 * 企業コードでクエリ
 *
 * GSI_CompanyCode_DiscloseDate（パーティションキー: company_code、ソートキー: disclosed_at）を使用
 *
 * @param params クエリパラメータ
 * @returns 開示情報リスト
 */
async function queryByCompanyCode(params) {
    logger_1.logger.info('Querying by company code', { company_code: params.company_code });
    const queryInput = {
        TableName: TABLE_NAME,
        IndexName: 'GSI_CompanyCode_DiscloseDate',
        KeyConditionExpression: 'company_code = :company_code',
        ExpressionAttributeValues: {
            ':company_code': { S: params.company_code },
        },
    };
    // 日付範囲フィルタ
    if (params.start_date && params.end_date) {
        queryInput.KeyConditionExpression += ' AND disclosed_at BETWEEN :start_date AND :end_date';
        queryInput.ExpressionAttributeValues[':start_date'] = { S: params.start_date };
        queryInput.ExpressionAttributeValues[':end_date'] = { S: params.end_date };
    }
    else if (params.start_date) {
        queryInput.KeyConditionExpression += ' AND disclosed_at >= :start_date';
        queryInput.ExpressionAttributeValues[':start_date'] = { S: params.start_date };
    }
    else if (params.end_date) {
        queryInput.KeyConditionExpression += ' AND disclosed_at <= :end_date';
        queryInput.ExpressionAttributeValues[':end_date'] = { S: params.end_date };
    }
    return await executeQuery(queryInput);
}
/**
 * 日付範囲でクエリ
 *
 * GSI_DatePartition（パーティションキー: date_partition、ソートキー: disclosed_at）を使用
 * 複数の月を並行クエリして結果を統合
 *
 * @param params クエリパラメータ
 * @returns 開示情報リスト
 */
async function queryByDateRange(params) {
    logger_1.logger.info('Querying by date range', {
        start_date: params.start_date,
        end_date: params.end_date,
    });
    // 開始月と終了月を生成
    const startPartition = (0, date_partition_1.generateDatePartition)(params.start_date + 'T00:00:00Z');
    const endPartition = (0, date_partition_1.generateDatePartition)(params.end_date + 'T00:00:00Z');
    // 月のリストを生成
    const partitions = generateMonthRange(startPartition, endPartition);
    logger_1.logger.info('Querying multiple partitions', {
        partitions,
        count: partitions.length,
    });
    // 並行クエリ
    const results = await Promise.all(partitions.map((partition) => queryByPartition(partition, params)));
    // 結果を統合
    const allDisclosures = results.flat();
    // 日付範囲でフィルタリング
    return allDisclosures.filter((disclosure) => {
        const disclosedAt = disclosure.disclosed_at.split('T')[0]; // YYYY-MM-DD部分を抽出
        return disclosedAt >= params.start_date && disclosedAt <= params.end_date;
    });
}
/**
 * 単一パーティションでクエリ
 *
 * @param partition date_partition（YYYY-MM形式）
 * @param params クエリパラメータ
 * @returns 開示情報リスト
 */
async function queryByPartition(partition, _params) {
    const queryInput = {
        TableName: TABLE_NAME,
        IndexName: 'GSI_DatePartition',
        KeyConditionExpression: 'date_partition = :partition',
        ExpressionAttributeValues: {
            ':partition': { S: partition },
        },
    };
    return await executeQuery(queryInput);
}
/**
 * Scanでクエリ（フィルタなし）
 *
 * @param params クエリパラメータ
 * @returns 開示情報リスト
 */
async function scanDisclosures(params) {
    logger_1.logger.warn('Scanning table without filters (inefficient)', { params });
    const scanInput = {
        TableName: TABLE_NAME,
        Limit: params.limit + params.offset, // オフセット分も取得
    };
    return await executeScan(scanInput);
}
/**
 * DynamoDBクエリを実行
 *
 * @param input QueryCommandInput
 * @returns 開示情報リスト
 */
async function executeQuery(input) {
    const disclosures = [];
    let lastEvaluatedKey;
    do {
        const command = new client_dynamodb_1.QueryCommand({
            ...input,
            ExclusiveStartKey: lastEvaluatedKey,
        });
        const response = await (0, retry_1.retryWithBackoff)(async () => await dynamoClient.send(command), {
            maxRetries: 3,
            initialDelay: 1000,
            backoffMultiplier: 2,
            jitter: true,
            shouldRetry: (error) => {
                return (error.name === 'ProvisionedThroughputExceededException' ||
                    error.name === 'ThrottlingException');
            },
        });
        if (response.Items) {
            for (const item of response.Items) {
                disclosures.push((0, util_dynamodb_1.unmarshall)(item));
            }
        }
        lastEvaluatedKey = response.LastEvaluatedKey;
    } while (lastEvaluatedKey);
    return disclosures;
}
/**
 * DynamoDB Scanを実行
 *
 * @param input ScanCommandInput
 * @returns 開示情報リスト
 */
async function executeScan(input) {
    const disclosures = [];
    let lastEvaluatedKey;
    do {
        const command = new client_dynamodb_1.ScanCommand({
            ...input,
            ExclusiveStartKey: lastEvaluatedKey,
        });
        const response = await (0, retry_1.retryWithBackoff)(async () => await dynamoClient.send(command), {
            maxRetries: 3,
            initialDelay: 1000,
            backoffMultiplier: 2,
            jitter: true,
            shouldRetry: (error) => {
                return (error.name === 'ProvisionedThroughputExceededException' ||
                    error.name === 'ThrottlingException');
            },
        });
        if (response.Items) {
            for (const item of response.Items) {
                disclosures.push((0, util_dynamodb_1.unmarshall)(item));
            }
        }
        lastEvaluatedKey = response.LastEvaluatedKey;
    } while (lastEvaluatedKey);
    return disclosures;
}
/**
 * 月範囲を生成
 *
 * @param start 開始月（YYYY-MM）
 * @param end 終了月（YYYY-MM）
 * @returns 月のリスト（YYYY-MM形式）
 */
function generateMonthRange(start, end) {
    const months = [];
    const [startYear, startMonth] = start.split('-').map(Number);
    const [endYear, endMonth] = end.split('-').map(Number);
    let year = startYear;
    let month = startMonth;
    while (year < endYear || (year === endYear && month <= endMonth)) {
        months.push(`${year}-${String(month).padStart(2, '0')}`);
        month++;
        if (month > 12) {
            month = 1;
            year++;
        }
    }
    return months;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXHF1ZXJ5XFxxdWVyeS1kaXNjbG9zdXJlcy50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7R0FPRzs7QUF3REgsNENBd0RDO0FBOUdELDhEQU1rQztBQUNsQywwREFBb0Q7QUFDcEQsK0NBQTRDO0FBQzVDLDZDQUFxRDtBQUVyRCwrREFBbUU7QUFFbkUsZ0NBQWdDO0FBQ2hDLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQztJQUN0QyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksZ0JBQWdCO0lBQ2xELFdBQVcsRUFBRSxDQUFDO0lBQ2QsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLElBQUk7UUFDbEMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCO0tBQ3ZDLENBQUM7Q0FDSCxDQUFDLENBQUM7QUFFSCxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLG1CQUFtQixDQUFDO0FBMEIxRTs7Ozs7R0FLRztBQUNJLEtBQUssVUFBVSxnQkFBZ0IsQ0FBQyxNQUFtQjtJQUN4RCxlQUFNLENBQUMsSUFBSSxDQUFDLHNCQUFzQixFQUFFLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUVoRCxJQUFJLFdBQXlCLENBQUM7SUFFOUIsV0FBVztJQUNYLElBQUksTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3hCLDRDQUE0QztRQUM1QyxXQUFXLEdBQUcsTUFBTSxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNqRCxDQUFDO1NBQU0sSUFBSSxNQUFNLENBQUMsVUFBVSxJQUFJLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNoRCxnQ0FBZ0M7UUFDaEMsV0FBVyxHQUFHLE1BQU0sZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDL0MsQ0FBQztTQUFNLElBQUksTUFB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QUFNLENBQUMsQ0FBQztJQUM3RCxNQUFNLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRXZELElBQUksSUFBSSxHQUFHLFNBQVMsQ0FBQztJQUNyQixJQUFJLEtBQUssR0FBRyxVQUFVLENBQUM7SUFFdkIsT0FBTyxJQUFJLEdBQUcsT0FBTyxJQUFJLENBQUMsSUFBSSxLQUFLLE9BQU8sSUFBSSxLQUFLLElBQUksUUFBUSxDQUFDLEVBQUUsQ0FBQztRQUNqRSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxJQUFJLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN6RCxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksS0FBSyxHQUFHLEVBQUUsRUFBRSxDQUFDO1lBQ2YsS0FBSyxHQUFHLENBQUMsQ0FBQztZQUNWLElBQUksRUFBRSxDQUFDO1FBQ1QsQ0FBQztJQUNILENBQUM7SUFFRCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcdGkxOThcXGludmVzdG1lbnRfYW5hbHlzaXNfb3BvcG9cXHNyY1xcbGFtYmRhXFxxdWVyeVxccXVlcnktZGlzY2xvc3VyZXMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIFF1ZXJ5IERpc2Nsb3N1cmVzXHJcbiAqXHJcbiAqIER5bmFtb0RC44GL44KJ6ZaL56S65oOF5aCx44KS5qSc57Si44GX44G+44GZ44CCXHJcbiAqIEdTSe+8iEdsb2JhbCBTZWNvbmRhcnkgSW5kZXjvvInjgpLkvb/nlKjjgZfjgablirnnjofnmoTjgavjgq/jgqjjg6rjgZfjgb7jgZnjgIJcclxuICpcclxuICogUmVxdWlyZW1lbnRzOiDopoHku7Y0LjHvvIjmpJzntKJBUEnvvIlcclxuICovXHJcblxyXG5pbXBvcnQge1xyXG4gIER5bmFtb0RCQ2xpZW50LFxyXG4gIFF1ZXJ5Q29tbWFuZCxcclxuICBTY2FuQ29tbWFuZCxcclxuICBRdWVyeUNvbW1hbmRJbnB1dCxcclxuICBTY2FuQ29tbWFuZElucHV0LFxyXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XHJcbmltcG9ydCB7IHVubWFyc2hhbGwgfSBmcm9tICdAYXdzLXNkay91dGlsLWR5bmFtb2RiJztcclxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vLi4vdXRpbHMvbG9nZ2VyJztcclxuaW1wb3J0IHsgcmV0cnlXaXRoQmFja29mZiB9IGZyb20gJy4uLy4uL3V0aWxzL3JldHJ5JztcclxuaW1wb3J0IHsgRGlzY2xvc3VyZSB9IGZyb20gJy4uLy4uL3R5cGVzJztcclxuaW1wb3J0IHsgZ2VuZXJhdGVEYXRlUGFydGl0aW9uIH0gZnJvbSAnLi4vLi4vdXRpbHMvZGF0ZS1wYXJ0aXRpb24nO1xyXG5cclxuLy8gRHluYW1vRELjgq/jg6njgqTjgqLjg7Pjg4jvvIjjgrDjg63jg7zjg5Djg6vjgrnjgrPjg7zjg5fjgafliJ3mnJ/ljJbvvIlcclxuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHtcclxuICByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ2FwLW5vcnRoZWFzdC0xJyxcclxuICBtYXhBdHRlbXB0czogMyxcclxuICAuLi4ocHJvY2Vzcy5lbnYuQVdTX0VORFBPSU5UX1VSTCAmJiB7XHJcbiAgICBlbmRwb2ludDogcHJvY2Vzcy5lbnYuQVdTX0VORFBPSU5UX1VSTCxcclxuICB9KSxcclxufSk7XHJcblxyXG5jb25zdCBUQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuRFlOQU1PREJfVEFCTEVfTkFNRSB8fCAndGRuZXRfZGlzY2xvc3VyZXMnO1xyXG5cclxuLyoqXHJcbiAqIOOCr+OCqOODquODkeODqeODoeODvOOCv1xyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBRdWVyeVBhcmFtcyB7XHJcbiAgY29tcGFueV9jb2RlPzogc3RyaW5nO1xyXG4gIHN0YXJ0X2RhdGU/OiBzdHJpbmc7XHJcbiAgZW5kX2RhdGU/OiBzdHJpbmc7XHJcbiAgZGlzY2xvc3VyZV90eXBlPzogc3RyaW5nO1xyXG4gIGZvcm1hdDogJ2pzb24nIHwgJ2Nzdic7XHJcbiAgbGltaXQ6IG51bWJlcjtcclxuICBvZmZzZXQ6IG51bWJlcjtcclxufVxyXG5cclxuLyoqXHJcbiAqIOOCr+OCqOODque1kOaenFxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBRdWVyeVJlc3VsdCB7XHJcbiAgZGlzY2xvc3VyZXM6IERpc2Nsb3N1cmVbXTtcclxuICB0b3RhbDogbnVtYmVyO1xyXG4gIGNvdW50OiBudW1iZXI7XHJcbiAgb2Zmc2V0OiBudW1iZXI7XHJcbiAgbGltaXQ6IG51bWJlcjtcclxufVxyXG5cclxuLyoqXHJcbiAqIOmWi+ekuuaDheWgseOCkuaknOe0olxyXG4gKlxyXG4gKiBAcGFyYW0gcGFyYW1zIOOCr+OCqOODquODkeODqeODoeODvOOCv1xyXG4gKiBAcmV0dXJucyDjgq/jgqjjg6rntZDmnpxcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBxdWVyeURpc2Nsb3N1cmVzKHBhcmFtczogUXVlcnlQYXJhbXMpOiBQcm9taXNlPFF1ZXJ5UmVzdWx0PiB7XHJcbiAgbG9nZ2VyLmluZm8oJ1F1ZXJ5aW5nIGRpc2Nsb3N1cmVzJywgeyBwYXJhbXMgfSk7XHJcblxyXG4gIGxldCBkaXNjbG9zdXJlczogRGlzY2xvc3VyZVtdO1xyXG5cclxuICAvLyDjgq/jgqjjg6rmiKbnlaXjga7pgbjmip5cclxuICBpZiAocGFyYW1zLmNvbXBhbnlfY29kZSkge1xyXG4gICAgLy8g5LyB5qWt44Kz44O844OJ44Gn44Kv44Ko44Oq77yIR1NJX0NvbXBhbnlDb2RlX0Rpc2Nsb3NlRGF0ZeS9v+eUqO+8iVxyXG4gICAgZGlzY2xvc3VyZXMgPSBhd2FpdCBxdWVyeUJ5Q29tcGFueUNvZGUocGFyYW1zKTtcclxuICB9IGVsc2UgaWYgKHBhcmFtcy5zdGFydF9kYXRlICYmIHBhcmFtcy5lbmRfZGF0ZSkge1xyXG4gICAgLy8g5pel5LuY56+E5Zuy44Gn44Kv44Ko44Oq77yIR1NJX0RhdGVQYXJ0aXRpb27kvb/nlKjvvIlcclxuICAgIGRpc2Nsb3N1cmVzID0gYXdhaXQgcXVlcnlCeURhdGVSYW5nZShwYXJhbXMpO1xyXG4gIH0gZWxzZSBpZiAocGFyYW1zLnN0YXJ0X2RhdGUpIHtcclxuICAgIC8vIOmWi+Wni+aXpeOBruOBv+aMh+Wumu+8iEdTSV9EYXRlUGFydGl0aW9u5L2/55So77yJXHJcbiAgICBkaXNjbG9zdXJlcyA9IGF3YWl0IHF1ZXJ5QnlEYXRlUmFuZ2Uoe1xyXG4gICAgICAuLi5wYXJhbXMsXHJcbiAgICAgIGVuZF9kYXRlOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXSwgLy8g5LuK5pel44G+44GnXHJcbiAgICB9KTtcclxuICB9IGVsc2Uge1xyXG4gICAgLy8g44OV44Kj44Or44K/44Gq44GX77yIU2Nhbu+8iVxyXG4gICAgZGlzY2xvc3VyZXMgPSBhd2FpdCBzY2FuRGlzY2xvc3VyZXMocGFyYW1zKTtcclxuICB9XHJcblxyXG4gIC8vIOmWi+ekuueorumhnuOBp+ODleOCo+ODq+OCv+ODquODs+OCsFxyXG4gIGlmIChwYXJhbXMuZGlzY2xvc3VyZV90eXBlKSB7XHJcbiAgICBkaXNjbG9zdXJlcyA9IGRpc2Nsb3N1cmVzLmZpbHRlcihcclxuICAgICAgKGQpID0+IGQuZGlzY2xvc3VyZV90eXBlID09PSBwYXJhbXMuZGlzY2xvc3VyZV90eXBlXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8g6ZaL56S65pel5pmC44Gn6ZmN6aCG44K944O844OIXHJcbiAgZGlzY2xvc3VyZXMuc29ydCgoYSwgYikgPT4ge1xyXG4gICAgcmV0dXJuIG5ldyBEYXRlKGIuZGlzY2xvc2VkX2F0KS5nZXRUaW1lKCkgLSBuZXcgRGF0ZShhLmRpc2Nsb3NlZF9hdCkuZ2V0VGltZSgpO1xyXG4gIH0pO1xyXG5cclxuICAvLyDjg5rjg7zjgrjjg43jg7zjgrfjg6fjg7NcclxuICBjb25zdCB0b3RhbCA9IGRpc2Nsb3N1cmVzLmxlbmd0aDtcclxuICBjb25zdCBwYWdpbmF0ZWREaXNjbG9zdXJlcyA9IGRpc2Nsb3N1cmVzLnNsaWNlKFxyXG4gICAgcGFyYW1zLm9mZnNldCxcclxuICAgIHBhcmFtcy5vZmZzZXQgKyBwYXJhbXMubGltaXRcclxuICApO1xyXG5cclxuICBsb2dnZXIuaW5mbygnUXVlcnkgY29tcGxldGVkJywge1xyXG4gICAgdG90YWwsXHJcbiAgICBjb3VudDogcGFnaW5hdGVkRGlzY2xvc3VyZXMubGVuZ3RoLFxyXG4gICAgb2Zmc2V0OiBwYXJhbXMub2Zmc2V0LFxyXG4gICAgbGltaXQ6IHBhcmFtcy5saW1pdCxcclxuICB9KTtcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIGRpc2Nsb3N1cmVzOiBwYWdpbmF0ZWREaXNjbG9zdXJlcyxcclxuICAgIHRvdGFsLFxyXG4gICAgY291bnQ6IHBhZ2luYXRlZERpc2Nsb3N1cmVzLmxlbmd0aCxcclxuICAgIG9mZnNldDogcGFyYW1zLm9mZnNldCxcclxuICAgIGxpbWl0OiBwYXJhbXMubGltaXQsXHJcbiAgfTtcclxufVxyXG5cclxuLyoqXHJcbiAqIOS8gealreOCs+ODvOODieOBp+OCr+OCqOODqlxyXG4gKlxyXG4gKiBHU0lfQ29tcGFueUNvZGVfRGlzY2xvc2VEYXRl77yI44OR44O844OG44Kj44K344On44Oz44Kt44O8OiBjb21wYW55X2NvZGXjgIHjgr3jg7zjg4jjgq3jg7w6IGRpc2Nsb3NlZF9hdO+8ieOCkuS9v+eUqFxyXG4gKlxyXG4gKiBAcGFyYW0gcGFyYW1zIOOCr+OCqOODquODkeODqeODoeODvOOCv1xyXG4gKiBAcmV0dXJucyDplovnpLrmg4XloLHjg6rjgrnjg4hcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIHF1ZXJ5QnlDb21wYW55Q29kZShwYXJhbXM6IFF1ZXJ5UGFyYW1zKTogUHJvbWlzZTxEaXNjbG9zdXJlW10+IHtcclxuICBsb2dnZXIuaW5mbygnUXVlcnlpbmcgYnkgY29tcGFueSBjb2RlJywgeyBjb21wYW55X2NvZGU6IHBhcmFtcy5jb21wYW55X2NvZGUgfSk7XHJcblxyXG4gIGNvbnN0IHF1ZXJ5SW5wdXQ6IFF1ZXJ5Q29tbWFuZElucHV0ID0ge1xyXG4gICAgVGFibGVOYW1lOiBUQUJMRV9OQU1FLFxyXG4gICAgSW5kZXhOYW1lOiAnR1NJX0NvbXBhbnlDb2RlX0Rpc2Nsb3NlRGF0ZScsXHJcbiAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnY29tcGFueV9jb2RlID0gOmNvbXBhbnlfY29kZScsXHJcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XHJcbiAgICAgICc6Y29tcGFueV9jb2RlJzogeyBTOiBwYXJhbXMuY29tcGFueV9jb2RlISB9LFxyXG4gICAgfSxcclxuICB9O1xyXG5cclxuICAvLyDml6Xku5jnr4Tlm7Ljg5XjgqPjg6vjgr9cclxuICBpZiAocGFyYW1zLnN0YXJ0X2RhdGUgJiYgcGFyYW1zLmVuZF9kYXRlKSB7XHJcbiAgICBxdWVyeUlucHV0LktleUNvbmRpdGlvbkV4cHJlc3Npb24gKz0gJyBBTkQgZGlzY2xvc2VkX2F0IEJFVFdFRU4gOnN0YXJ0X2RhdGUgQU5EIDplbmRfZGF0ZSc7XHJcbiAgICBxdWVyeUlucHV0LkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMhWyc6c3RhcnRfZGF0ZSddID0geyBTOiBwYXJhbXMuc3RhcnRfZGF0ZSB9O1xyXG4gICAgcXVlcnlJbnB1dC5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzIVsnOmVuZF9kYXRlJ10gPSB7IFM6IHBhcmFtcy5lbmRfZGF0ZSB9O1xyXG4gIH0gZWxzZSBpZiAocGFyYW1zLnN0YXJ0X2RhdGUpIHtcclxuICAgIHF1ZXJ5SW5wdXQuS2V5Q29uZGl0aW9uRXhwcmVzc2lvbiArPSAnIEFORCBkaXNjbG9zZWRfYXQgPj0gOnN0YXJ0X2RhdGUnO1xyXG4gICAgcXVlcnlJbnB1dC5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzIVsnOnN0YXJ0X2RhdGUnXSA9IHsgUzogcGFyYW1zLnN0YXJ0X2RhdGUgfTtcclxuICB9IGVsc2UgaWYgKHBhcmFtcy5lbmRfZGF0ZSkge1xyXG4gICAgcXVlcnlJbnB1dC5LZXlDb25kaXRpb25FeHByZXNzaW9uICs9ICcgQU5EIGRpc2Nsb3NlZF9hdCA8PSA6ZW5kX2RhdGUnO1xyXG4gICAgcXVlcnlJbnB1dC5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzIVsnOmVuZF9kYXRlJ10gPSB7IFM6IHBhcmFtcy5lbmRfZGF0ZSB9O1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGF3YWl0IGV4ZWN1dGVRdWVyeShxdWVyeUlucHV0KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIOaXpeS7mOevhOWbsuOBp+OCr+OCqOODqlxyXG4gKlxyXG4gKiBHU0lfRGF0ZVBhcnRpdGlvbu+8iOODkeODvOODhuOCo+OCt+ODp+ODs+OCreODvDogZGF0ZV9wYXJ0aXRpb27jgIHjgr3jg7zjg4jjgq3jg7w6IGRpc2Nsb3NlZF9hdO+8ieOCkuS9v+eUqFxyXG4gKiDopIfmlbDjga7mnIjjgpLkuKbooYzjgq/jgqjjg6rjgZfjgabntZDmnpzjgpLntbHlkIhcclxuICpcclxuICogQHBhcmFtIHBhcmFtcyDjgq/jgqjjg6rjg5Hjg6njg6Hjg7zjgr9cclxuICogQHJldHVybnMg6ZaL56S65oOF5aCx44Oq44K544OIXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBxdWVyeUJ5RGF0ZVJhbmdlKHBhcmFtczogUXVlcnlQYXJhbXMpOiBQcm9taXNlPERpc2Nsb3N1cmVbXT4ge1xyXG4gIGxvZ2dlci5pbmZvKCdRdWVyeWluZyBieSBkYXRlIHJhbmdlJywge1xyXG4gICAgc3RhcnRfZGF0ZTogcGFyYW1zLnN0YXJ0X2RhdGUsXHJcbiAgICBlbmRfZGF0ZTogcGFyYW1zLmVuZF9kYXRlLFxyXG4gIH0pO1xyXG5cclxuICAvLyDplovlp4vmnIjjgajntYLkuobmnIjjgpLnlJ/miJBcclxuICBjb25zdCBzdGFydFBhcnRpdGlvbiA9IGdlbmVyYXRlRGF0ZVBhcnRpdGlvbihwYXJhbXMuc3RhcnRfZGF0ZSEgKyAnVDAwOjAwOjAwWicpO1xyXG4gIGNvbnN0IGVuZFBhcnRpdGlvbiA9IGdlbmVyYXRlRGF0ZVBhcnRpdGlvbihwYXJhbXMuZW5kX2RhdGUhICsgJ1QwMDowMDowMFonKTtcclxuXHJcbiAgLy8g5pyI44Gu44Oq44K544OI44KS55Sf5oiQXHJcbiAgY29uc3QgcGFydGl0aW9ucyA9IGdlbmVyYXRlTW9udGhSYW5nZShzdGFydFBhcnRpdGlvbiwgZW5kUGFydGl0aW9uKTtcclxuXHJcbiAgbG9nZ2VyLmluZm8oJ1F1ZXJ5aW5nIG11bHRpcGxlIHBhcnRpdGlvbnMnLCB7XHJcbiAgICBwYXJ0aXRpb25zLFxyXG4gICAgY291bnQ6IHBhcnRpdGlvbnMubGVuZ3RoLFxyXG4gIH0pO1xyXG5cclxuICAvLyDkuKbooYzjgq/jgqjjg6pcclxuICBjb25zdCByZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwoXHJcbiAgICBwYXJ0aXRpb25zLm1hcCgocGFydGl0aW9uKSA9PiBxdWVyeUJ5UGFydGl0aW9uKHBhcnRpdGlvbiwgcGFyYW1zKSlcclxuICApO1xyXG5cclxuICAvLyDntZDmnpzjgpLntbHlkIhcclxuICBjb25zdCBhbGxEaXNjbG9zdXJlcyA9IHJlc3VsdHMuZmxhdCgpO1xyXG5cclxuICAvLyDml6Xku5jnr4Tlm7Ljgafjg5XjgqPjg6vjgr/jg6rjg7PjgrBcclxuICByZXR1cm4gYWxsRGlzY2xvc3VyZXMuZmlsdGVyKChkaXNjbG9zdXJlKSA9PiB7XHJcbiAgICBjb25zdCBkaXNjbG9zZWRBdCA9IGRpc2Nsb3N1cmUuZGlzY2xvc2VkX2F0LnNwbGl0KCdUJylbMF07IC8vIFlZWVktTU0tRETpg6jliIbjgpLmir3lh7pcclxuICAgIHJldHVybiBkaXNjbG9zZWRBdCA+PSBwYXJhbXMuc3RhcnRfZGF0ZSEgJiYgZGlzY2xvc2VkQXQgPD0gcGFyYW1zLmVuZF9kYXRlITtcclxuICB9KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIOWNmOS4gOODkeODvOODhuOCo+OCt+ODp+ODs+OBp+OCr+OCqOODqlxyXG4gKlxyXG4gKiBAcGFyYW0gcGFydGl0aW9uIGRhdGVfcGFydGl0aW9u77yIWVlZWS1NTeW9ouW8j++8iVxyXG4gKiBAcGFyYW0gcGFyYW1zIOOCr+OCqOODquODkeODqeODoeODvOOCv1xyXG4gKiBAcmV0dXJucyDplovnpLrmg4XloLHjg6rjgrnjg4hcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIHF1ZXJ5QnlQYXJ0aXRpb24oXHJcbiAgcGFydGl0aW9uOiBzdHJpbmcsXHJcbiAgX3BhcmFtczogUXVlcnlQYXJhbXNcclxuKTogUHJvbWlzZTxEaXNjbG9zdXJlW10+IHtcclxuICBjb25zdCBxdWVyeUlucHV0OiBRdWVyeUNvbW1hbmRJbnB1dCA9IHtcclxuICAgIFRhYmxlTmFtZTogVEFCTEVfTkFNRSxcclxuICAgIEluZGV4TmFtZTogJ0dTSV9EYXRlUGFydGl0aW9uJyxcclxuICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdkYXRlX3BhcnRpdGlvbiA9IDpwYXJ0aXRpb24nLFxyXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xyXG4gICAgICAnOnBhcnRpdGlvbic6IHsgUzogcGFydGl0aW9uIH0sXHJcbiAgICB9LFxyXG4gIH07XHJcblxyXG4gIHJldHVybiBhd2FpdCBleGVjdXRlUXVlcnkocXVlcnlJbnB1dCk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBTY2Fu44Gn44Kv44Ko44Oq77yI44OV44Kj44Or44K/44Gq44GX77yJXHJcbiAqXHJcbiAqIEBwYXJhbSBwYXJhbXMg44Kv44Ko44Oq44OR44Op44Oh44O844K/XHJcbiAqIEByZXR1cm5zIOmWi+ekuuaDheWgseODquOCueODiFxyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gc2NhbkRpc2Nsb3N1cmVzKHBhcmFtczogUXVlcnlQYXJhbXMpOiBQcm9taXNlPERpc2Nsb3N1cmVbXT4ge1xyXG4gIGxvZ2dlci53YXJuKCdTY2FubmluZyB0YWJsZSB3aXRob3V0IGZpbHRlcnMgKGluZWZmaWNpZW50KScsIHsgcGFyYW1zIH0pO1xyXG5cclxuICBjb25zdCBzY2FuSW5wdXQ6IFNjYW5Db21tYW5kSW5wdXQgPSB7XHJcbiAgICBUYWJsZU5hbWU6IFRBQkxFX05BTUUsXHJcbiAgICBMaW1pdDogcGFyYW1zLmxpbWl0ICsgcGFyYW1zLm9mZnNldCwgLy8g44Kq44OV44K744OD44OI5YiG44KC5Y+W5b6XXHJcbiAgfTtcclxuXHJcbiAgcmV0dXJuIGF3YWl0IGV4ZWN1dGVTY2FuKHNjYW5JbnB1dCk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBEeW5hbW9EQuOCr+OCqOODquOCkuWun+ihjFxyXG4gKlxyXG4gKiBAcGFyYW0gaW5wdXQgUXVlcnlDb21tYW5kSW5wdXRcclxuICogQHJldHVybnMg6ZaL56S65oOF5aCx44Oq44K544OIXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBleGVjdXRlUXVlcnkoaW5wdXQ6IFF1ZXJ5Q29tbWFuZElucHV0KTogUHJvbWlzZTxEaXNjbG9zdXJlW10+IHtcclxuICBjb25zdCBkaXNjbG9zdXJlczogRGlzY2xvc3VyZVtdID0gW107XHJcbiAgbGV0IGxhc3RFdmFsdWF0ZWRLZXk6IFJlY29yZDxzdHJpbmcsIGFueT4gfCB1bmRlZmluZWQ7XHJcblxyXG4gIGRvIHtcclxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHtcclxuICAgICAgLi4uaW5wdXQsXHJcbiAgICAgIEV4Y2x1c2l2ZVN0YXJ0S2V5OiBsYXN0RXZhbHVhdGVkS2V5LFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXRyeVdpdGhCYWNrb2ZmKFxyXG4gICAgICBhc3luYyAoKSA9PiBhd2FpdCBkeW5hbW9DbGllbnQuc2VuZChjb21tYW5kKSxcclxuICAgICAge1xyXG4gICAgICAgIG1heFJldHJpZXM6IDMsXHJcbiAgICAgICAgaW5pdGlhbERlbGF5OiAxMDAwLFxyXG4gICAgICAgIGJhY2tvZmZNdWx0aXBsaWVyOiAyLFxyXG4gICAgICAgIGppdHRlcjogdHJ1ZSxcclxuICAgICAgICBzaG91bGRSZXRyeTogKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICBlcnJvci5uYW1lID09PSAnUHJvdmlzaW9uZWRUaHJvdWdocHV0RXhjZWVkZWRFeGNlcHRpb24nIHx8XHJcbiAgICAgICAgICAgIGVycm9yLm5hbWUgPT09ICdUaHJvdHRsaW5nRXhjZXB0aW9uJ1xyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9LFxyXG4gICAgICB9XHJcbiAgICApO1xyXG5cclxuICAgIGlmIChyZXNwb25zZS5JdGVtcykge1xyXG4gICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgcmVzcG9uc2UuSXRlbXMpIHtcclxuICAgICAgICBkaXNjbG9zdXJlcy5wdXNoKHVubWFyc2hhbGwoaXRlbSkgYXMgRGlzY2xvc3VyZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBsYXN0RXZhbHVhdGVkS2V5ID0gcmVzcG9uc2UuTGFzdEV2YWx1YXRlZEtleTtcclxuICB9IHdoaWxlIChsYXN0RXZhbHVhdGVkS2V5KTtcclxuXHJcbiAgcmV0dXJuIGRpc2Nsb3N1cmVzO1xyXG59XHJcblxyXG4vKipcclxuICogRHluYW1vREIgU2NhbuOCkuWun+ihjFxyXG4gKlxyXG4gKiBAcGFyYW0gaW5wdXQgU2NhbkNvbW1hbmRJbnB1dFxyXG4gKiBAcmV0dXJucyDplovnpLrmg4XloLHjg6rjgrnjg4hcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIGV4ZWN1dGVTY2FuKGlucHV0OiBTY2FuQ29tbWFuZElucHV0KTogUHJvbWlzZTxEaXNjbG9zdXJlW10+IHtcclxuICBjb25zdCBkaXNjbG9zdXJlczogRGlzY2xvc3VyZVtdID0gW107XHJcbiAgbGV0IGxhc3RFdmFsdWF0ZWRLZXk6IFJlY29yZDxzdHJpbmcsIGFueT4gfCB1bmRlZmluZWQ7XHJcblxyXG4gIGRvIHtcclxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgU2NhbkNvbW1hbmQoe1xyXG4gICAgICAuLi5pbnB1dCxcclxuICAgICAgRXhjbHVzaXZlU3RhcnRLZXk6IGxhc3RFdmFsdWF0ZWRLZXksXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJldHJ5V2l0aEJhY2tvZmYoXHJcbiAgICAgIGFzeW5jICgpID0+IGF3YWl0IGR5bmFtb0NsaWVudC5zZW5kKGNvbW1hbmQpLFxyXG4gICAgICB7XHJcbiAgICAgICAgbWF4UmV0cmllczogMyxcclxuICAgICAgICBpbml0aWFsRGVsYXk6IDEwMDAsXHJcbiAgICAgICAgYmFja29mZk11bHRpcGxpZXI6IDIsXHJcbiAgICAgICAgaml0dGVyOiB0cnVlLFxyXG4gICAgICAgIHNob3VsZFJldHJ5OiAoZXJyb3IpID0+IHtcclxuICAgICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgIGVycm9yLm5hbWUgPT09ICdQcm92aXNpb25lZFRocm91Z2hwdXRFeGNlZWRlZEV4Y2VwdGlvbicgfHxcclxuICAgICAgICAgICAgZXJyb3IubmFtZSA9PT0gJ1Rocm90dGxpbmdFeGNlcHRpb24nXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH0sXHJcbiAgICAgIH1cclxuICAgICk7XHJcblxyXG4gICAgaWYgKHJlc3BvbnNlLkl0ZW1zKSB7XHJcbiAgICAgIGZvciAoY29uc3QgaXRlbSBvZiByZXNwb25zZS5JdGVtcykge1xyXG4gICAgICAgIGRpc2Nsb3N1cmVzLnB1c2godW5tYXJzaGFsbChpdGVtKSBhcyBEaXNjbG9zdXJlKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGxhc3RFdmFsdWF0ZWRLZXkgPSByZXNwb25zZS5MYXN0RXZhbHVhdGVkS2V5O1xyXG4gIH0gd2hpbGUgKGxhc3RFdmFsdWF0ZWRLZXkpO1xyXG5cclxuICByZXR1cm4gZGlzY2xvc3VyZXM7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDmnIjnr4Tlm7LjgpLnlJ/miJBcclxuICpcclxuICogQHBhcmFtIHN0YXJ0IOmWi+Wni+aciO+8iFlZWVktTU3vvIlcclxuICogQHBhcmFtIGVuZCDntYLkuobmnIjvvIhZWVlZLU1N77yJXHJcbiAqIEByZXR1cm5zIOaciOOBruODquOCueODiO+8iFlZWVktTU3lvaLlvI/vvIlcclxuICovXHJcbmZ1bmN0aW9uIGdlbmVyYXRlTW9udGhSYW5nZShzdGFydDogc3RyaW5nLCBlbmQ6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICBjb25zdCBtb250aHM6IHN0cmluZ1tdID0gW107XHJcbiAgY29uc3QgW3N0YXJ0WWVhciwgc3RhcnRNb250aF0gPSBzdGFydC5zcGxpdCgnLScpLm1hcChOdW1iZXIpO1xyXG4gIGNvbnN0IFtlbmRZZWFyLCBlbmRNb250aF0gPSBlbmQuc3BsaXQoJy0nKS5tYXAoTnVtYmVyKTtcclxuXHJcbiAgbGV0IHllYXIgPSBzdGFydFllYXI7XHJcbiAgbGV0IG1vbnRoID0gc3RhcnRNb250aDtcclxuXHJcbiAgd2hpbGUgKHllYXIgPCBlbmRZZWFyIHx8ICh5ZWFyID09PSBlbmRZZWFyICYmIG1vbnRoIDw9IGVuZE1vbnRoKSkge1xyXG4gICAgbW9udGhzLnB1c2goYCR7eWVhcn0tJHtTdHJpbmcobW9udGgpLnBhZFN0YXJ0KDIsICcwJyl9YCk7XHJcbiAgICBtb250aCsrO1xyXG4gICAgaWYgKG1vbnRoID4gMTIpIHtcclxuICAgICAgbW9udGggPSAxO1xyXG4gICAgICB5ZWFyKys7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4gbW9udGhzO1xyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==