e57531baf7d0b4610c025403474b36cb
"use strict";
/**
 * CloudWatch Logs Construct Tests
 *
 * Tests for CloudWatch Logs configuration with environment-specific retention periods
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
const cdk = __importStar(require("aws-cdk-lib"));
const logs = __importStar(require("aws-cdk-lib/aws-logs"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const assertions_1 = require("aws-cdk-lib/assertions");
const cloudwatch_logs_1 = require("../lib/constructs/cloudwatch-logs");
describe('CloudWatchLogs Construct', () => {
    describe('Development Environment', () => {
        let app;
        let stack;
        let cloudWatchLogs;
        beforeEach(() => {
            app = new cdk.App();
            stack = new cdk.Stack(app, 'TestStack');
            cloudWatchLogs = new cloudwatch_logs_1.CloudWatchLogs(stack, 'CloudWatchLogs', {
                environment: 'dev',
            });
        });
        test('should set retention to 7 days for dev environment', () => {
            expect(cloudWatchLogs.retentionDays).toBe(logs.RetentionDays.ONE_WEEK);
            expect(cloudWatchLogs.getRetentionDaysAsNumber()).toBe(7);
        });
        test('should set removal policy to DESTROY for dev environment', () => {
            expect(cloudWatchLogs.removalPolicy).toBe(cdk.RemovalPolicy.DESTROY);
        });
        test('should configure log group for Lambda function', () => {
            // Lambda関数を作成
            const testFunction = new lambda.Function(stack, 'TestFunction', {
                runtime: lambda.Runtime.NODEJS_20_X,
                handler: 'index.handler',
                code: lambda.Code.fromInline('exports.handler = async () => {};'),
                functionName: 'test-function',
            });
            // ログ設定を適用
            const logGroup = cloudWatchLogs.configureForLambda(testFunction);
            // CloudFormationテンプレートを検証
            const template = assertions_1.Template.fromStack(stack);
            // ログ保持期間が7日であることを確認
            template.hasResourceProperties('AWS::Logs::LogGroup', {
                RetentionInDays: 7,
            });
            // ロググループが作成されたことを確認
            expect(logGroup).toBeDefined();
            // LogGroupNameはCDKトークンとして生成されるため、文字列として検証できない
            expect(logGroup.logGroupName).toContain('Token');
        });
        test('should configure log groups for multiple Lambda functions', () => {
            // 複数のLambda関数を作成
            const functions = [
                new lambda.Function(stack, 'Function1', {
                    runtime: lambda.Runtime.NODEJS_20_X,
                    handler: 'index.handler',
                    code: lambda.Code.fromInline('exports.handler = async () => {};'),
                    functionName: 'function-1',
                }),
                new lambda.Function(stack, 'Function2', {
                    runtime: lambda.Runtime.NODEJS_20_X,
                    handler: 'index.handler',
                    code: lambda.Code.fromInline('exports.handler = async () => {};'),
                    functionName: 'function-2',
                }),
            ];
            // ログ設定を適用
            const logGroups = cloudWatchLogs.configureForLambdas(functions);
            // CloudFormationテンプレートを検証
            const template = assertions_1.Template.fromStack(stack);
            // 2つのロググループが作成されたことを確認
            template.resourceCountIs('AWS::Logs::LogGroup', 2);
            // 各ロググループの設定を確認（保持期間のみ検証）
            template.hasResourceProperties('AWS::Logs::LogGroup', {
                RetentionInDays: 7,
            });
            // ロググループが作成されたことを確認
            expect(logGroups).toHaveLength(2);
            expect(logGroups[0].logGroupName).toContain('Token');
            expect(logGroups[1].logGroupName).toContain('Token');
        });
        test('should support custom log group name', () => {
            const testFunction = new lambda.Function(stack, 'CustomFunction', {
                runtime: lambda.Runtime.NODEJS_20_X,
                handler: 'index.handler',
                code: lambda.Code.fromInline('exports.handler = async () => {};'),
                functionName: 'custom-function',
            });
            // カスタムロググループ名を指定
            const logGroup = cloudWatchLogs.configureForLambda(testFunction, '/custom/log/group');
            // CloudFormationテンプレートを検証
            const template = assertions_1.Template.fromStack(stack);
            template.hasResourceProperties('AWS::Logs::LogGroup', {
                RetentionInDays: 7,
            });
            expect(logGroup.logGroupName).toContain('Token');
        });
    });
    describe('Production Environment', () => {
        let app;
        let stack;
        let cloudWatchLogs;
        beforeEach(() => {
            app = new cdk.App();
            stack = new cdk.Stack(app, 'TestStack');
            cloudWatchLogs = new cloudwatch_logs_1.CloudWatchLogs(stack, 'CloudWatchLogs', {
                environment: 'prod',
            });
        });
        test('should set retention to 90 days for prod environment', () => {
            expect(cloudWatchLogs.retentionDays).toBe(logs.RetentionDays.THREE_MONTHS);
            expect(cloudWatchLogs.getRetentionDaysAsNumber()).toBe(90);
        });
        test('should set removal policy to RETAIN for prod environment', () => {
            expect(cloudWatchLogs.removalPolicy).toBe(cdk.RemovalPolicy.RETAIN);
        });
        test('should configure log group for Lambda function with 90 days retention', () => {
            const testFunction = new lambda.Function(stack, 'ProdFunction', {
                runtime: lambda.Runtime.NODEJS_20_X,
                handler: 'index.handler',
                code: lambda.Code.fromInline('exports.handler = async () => {};'),
                functionName: 'prod-function',
            });
            cloudWatchLogs.configureForLambda(testFunction);
            const template = assertions_1.Template.fromStack(stack);
            // ログ保持期間が90日であることを確認
            template.hasResourceProperties('AWS::Logs::LogGroup', {
                RetentionInDays: 90,
            });
        });
    });
    describe('CloudFormation Outputs', () => {
        test('should create CloudFormation output for log group', () => {
            const app = new cdk.App();
            const stack = new cdk.Stack(app, 'TestStack');
            const cloudWatchLogs = new cloudwatch_logs_1.CloudWatchLogs(stack, 'CloudWatchLogs', {
                environment: 'dev',
            });
            const testFunction = new lambda.Function(stack, 'OutputTestFunction', {
                runtime: lambda.Runtime.NODEJS_20_X,
                handler: 'index.handler',
                code: lambda.Code.fromInline('exports.handler = async () => {};'),
                functionName: 'output-test-function',
            });
            cloudWatchLogs.configureForLambda(testFunction);
            const template = assertions_1.Template.fromStack(stack);
            // CloudFormation Outputが作成されたことを確認
            // Output名は動的に生成されるため、存在確認のみ
            const outputs = template.findOutputs('*');
            const outputKeys = Object.keys(outputs);
            expect(outputKeys.length).toBeGreaterThan(0);
            expect(outputKeys.some(key => key.includes('LogGroupName'))).toBe(true);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcY2RrXFxfX3Rlc3RzX19cXGNsb3Vkd2F0Y2gtbG9ncy50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVILGlEQUFtQztBQUNuQywyREFBNkM7QUFDN0MsK0RBQWlEO0FBQ2pELHVEQUFrRDtBQUNsRCx1RUFBbUU7QUFFbkUsUUFBUSxDQUFDLDBCQUEwQixFQUFFLEdBQUcsRUFBRTtJQUN4QyxRQUFRLENBQUMseUJBQXlCLEVBQUUsR0FBRyxFQUFFO1FBQ3ZDLElBQUksR0FBWSxDQUFDO1FBQ2pCLElBQUksS0FBZ0IsQ0FBQztRQUNyQixJQUFJLGNBQThCLENBQUM7UUFFbkMsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNkLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNwQixLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxXQUFXLENBQUMsQ0FBQztZQUN4QyxjQUFjLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEtBQUssRUFBRSxnQkFBZ0IsRUFBRTtnQkFDM0QsV0FBVyxFQUFFLEtBQUs7YUFDbkIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsb0RBQW9ELEVBQUUsR0FBRyxFQUFFO1lBQzlELE1BQU0sQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDdkUsTUFBTSxDQUFDLGNBQWMsQ0FBQyx3QkFBd0IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzVELENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLDBEQUEwRCxFQUFFLEdBQUcsRUFBRTtZQUNwRSxNQUFNLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxD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QyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzFFLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpMTk4XFxpbnZlc3RtZW50X2FuYWx5c2lzX29wb3BvXFxjZGtcXF9fdGVzdHNfX1xcY2xvdWR3YXRjaC1sb2dzLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENsb3VkV2F0Y2ggTG9ncyBDb25zdHJ1Y3QgVGVzdHNcclxuICogXHJcbiAqIFRlc3RzIGZvciBDbG91ZFdhdGNoIExvZ3MgY29uZmlndXJhdGlvbiB3aXRoIGVudmlyb25tZW50LXNwZWNpZmljIHJldGVudGlvbiBwZXJpb2RzXHJcbiAqL1xyXG5cclxuaW1wb3J0ICogYXMgY2RrIGZyb20gJ2F3cy1jZGstbGliJztcclxuaW1wb3J0ICogYXMgbG9ncyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbG9ncyc7XHJcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcclxuaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hc3NlcnRpb25zJztcclxuaW1wb3J0IHsgQ2xvdWRXYXRjaExvZ3MgfSBmcm9tICcuLi9saWIvY29uc3RydWN0cy9jbG91ZHdhdGNoLWxvZ3MnO1xyXG5cclxuZGVzY3JpYmUoJ0Nsb3VkV2F0Y2hMb2dzIENvbnN0cnVjdCcsICgpID0+IHtcclxuICBkZXNjcmliZSgnRGV2ZWxvcG1lbnQgRW52aXJvbm1lbnQnLCAoKSA9PiB7XHJcbiAgICBsZXQgYXBwOiBjZGsuQXBwO1xyXG4gICAgbGV0IHN0YWNrOiBjZGsuU3RhY2s7XHJcbiAgICBsZXQgY2xvdWRXYXRjaExvZ3M6IENsb3VkV2F0Y2hMb2dzO1xyXG5cclxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICBhcHAgPSBuZXcgY2RrLkFwcCgpO1xyXG4gICAgICBzdGFjayA9IG5ldyBjZGsuU3RhY2soYXBwLCAnVGVzdFN0YWNrJyk7XHJcbiAgICAgIGNsb3VkV2F0Y2hMb2dzID0gbmV3IENsb3VkV2F0Y2hMb2dzKHN0YWNrLCAnQ2xvdWRXYXRjaExvZ3MnLCB7XHJcbiAgICAgICAgZW52aXJvbm1lbnQ6ICdkZXYnLFxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIHRlc3QoJ3Nob3VsZCBzZXQgcmV0ZW50aW9uIHRvIDcgZGF5cyBmb3IgZGV2IGVudmlyb25tZW50JywgKCkgPT4ge1xyXG4gICAgICBleHBlY3QoY2xvdWRXYXRjaExvZ3MucmV0ZW50aW9uRGF5cykudG9CZShsb2dzLlJldGVudGlvbkRheXMuT05FX1dFRUspO1xyXG4gICAgICBleHBlY3QoY2xvdWRXYXRjaExvZ3MuZ2V0UmV0ZW50aW9uRGF5c0FzTnVtYmVyKCkpLnRvQmUoNyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICB0ZXN0KCdzaG91bGQgc2V0IHJlbW92YWwgcG9saWN5IHRvIERFU1RST1kgZm9yIGRldiBlbnZpcm9ubWVudCcsICgpID0+IHtcclxuICAgICAgZXhwZWN0KGNsb3VkV2F0Y2hMb2dzLnJlbW92YWxQb2xpY3kpLnRvQmUoY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICB0ZXN0KCdzaG91bGQgY29uZmlndXJlIGxvZyBncm91cCBmb3IgTGFtYmRhIGZ1bmN0aW9uJywgKCkgPT4ge1xyXG4gICAgICAvLyBMYW1iZGHplqLmlbDjgpLkvZzmiJBcclxuICAgICAgY29uc3QgdGVzdEZ1bmN0aW9uID0gbmV3IGxhbWJkYS5GdW5jdGlvbihzdGFjaywgJ1Rlc3RGdW5jdGlvbicsIHtcclxuICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMjBfWCxcclxuICAgICAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXHJcbiAgICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUlubGluZSgnZXhwb3J0cy5oYW5kbGVyID0gYXN5bmMgKCkgPT4ge307JyksXHJcbiAgICAgICAgZnVuY3Rpb25OYW1lOiAndGVzdC1mdW5jdGlvbicsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgLy8g44Ot44Kw6Kit5a6a44KS6YGp55SoXHJcbiAgICAgIGNvbnN0IGxvZ0dyb3VwID0gY2xvdWRXYXRjaExvZ3MuY29uZmlndXJlRm9yTGFtYmRhKHRlc3RGdW5jdGlvbik7XHJcblxyXG4gICAgICAvLyBDbG91ZEZvcm1hdGlvbuODhuODs+ODl+ODrOODvOODiOOCkuaknOiovFxyXG4gICAgICBjb25zdCB0ZW1wbGF0ZSA9IFRlbXBsYXRlLmZyb21TdGFjayhzdGFjayk7XHJcblxyXG4gICAgICAvLyDjg63jgrDkv53mjIHmnJ/plpPjgYw35pel44Gn44GC44KL44GT44Go44KS56K66KqNXHJcbiAgICAgIHRlbXBsYXRlLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpMb2dzOjpMb2dHcm91cCcsIHtcclxuICAgICAgICBSZXRlbnRpb25JbkRheXM6IDcsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgLy8g44Ot44Kw44Kw44Or44O844OX44GM5L2c5oiQ44GV44KM44Gf44GT44Go44KS56K66KqNXHJcbiAgICAgIGV4cGVjdChsb2dHcm91cCkudG9CZURlZmluZWQoKTtcclxuICAgICAgLy8gTG9nR3JvdXBOYW1l44GvQ0RL44OI44O844Kv44Oz44Go44GX44Gm55Sf5oiQ44GV44KM44KL44Gf44KB44CB5paH5a2X5YiX44Go44GX44Gm5qSc6Ki844Gn44GN44Gq44GEXHJcbiAgICAgIGV4cGVjdChsb2dHcm91cC5sb2dHcm91cE5hbWUpLnRvQ29udGFpbignVG9rZW4nKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHRlc3QoJ3Nob3VsZCBjb25maWd1cmUgbG9nIGdyb3VwcyBmb3IgbXVsdGlwbGUgTGFtYmRhIGZ1bmN0aW9ucycsICgpID0+IHtcclxuICAgICAgLy8g6KSH5pWw44GuTGFtYmRh6Zai5pWw44KS5L2c5oiQXHJcbiAgICAgIGNvbnN0IGZ1bmN0aW9ucyA9IFtcclxuICAgICAgICBuZXcgbGFtYmRhLkZ1bmN0aW9uKHN0YWNrLCAnRnVuY3Rpb24xJywge1xyXG4gICAgICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzIwX1gsXHJcbiAgICAgICAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXHJcbiAgICAgICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tSW5saW5lKCdleHBvcnRzLmhhbmRsZXIgPSBhc3luYyAoKSA9PiB7fTsnKSxcclxuICAgICAgICAgIGZ1bmN0aW9uTmFtZTogJ2Z1bmN0aW9uLTEnLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssICdGdW5jdGlvbjInLCB7XHJcbiAgICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMjBfWCxcclxuICAgICAgICAgIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcclxuICAgICAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21JbmxpbmUoJ2V4cG9ydHMuaGFuZGxlciA9IGFzeW5jICgpID0+IHt9OycpLFxyXG4gICAgICAgICAgZnVuY3Rpb25OYW1lOiAnZnVuY3Rpb24tMicsXHJcbiAgICAgICAgfSksXHJcbiAgICAgIF07XHJcblxyXG4gICAgICAvLyDjg63jgrDoqK3lrprjgpLpgannlKhcclxuICAgICAgY29uc3QgbG9nR3JvdXBzID0gY2xvdWRXYXRjaExvZ3MuY29uZmlndXJlRm9yTGFtYmRhcyhmdW5jdGlvbnMpO1xyXG5cclxuICAgICAgLy8gQ2xvdWRGb3JtYXRpb27jg4bjg7Pjg5fjg6zjg7zjg4jjgpLmpJzoqLxcclxuICAgICAgY29uc3QgdGVtcGxhdGUgPSBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spO1xyXG5cclxuICAgICAgLy8gMuOBpOOBruODreOCsOOCsOODq+ODvOODl+OBjOS9nOaIkOOBleOCjOOBn+OBk+OBqOOCkueiuuiqjVxyXG4gICAgICB0ZW1wbGF0ZS5yZXNvdXJjZUNvdW50SXMoJ0FXUzo6TG9nczo6TG9nR3JvdXAnLCAyKTtcclxuXHJcbiAgICAgIC8vIOWQhOODreOCsOOCsOODq+ODvOODl+OBruioreWumuOCkueiuuiqje+8iOS/neaMgeacn+mWk+OBruOBv+aknOiovO+8iVxyXG4gICAgICB0ZW1wbGF0ZS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6TG9nczo6TG9nR3JvdXAnLCB7XHJcbiAgICAgICAgUmV0ZW50aW9uSW5EYXlzOiA3LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIC8vIOODreOCsOOCsOODq+ODvOODl+OBjOS9nOaIkOOBleOCjOOBn+OBk+OBqOOCkueiuuiqjVxyXG4gICAgICBleHBlY3QobG9nR3JvdXBzKS50b0hhdmVMZW5ndGgoMik7XHJcbiAgICAgIGV4cGVjdChsb2dHcm91cHNbMF0ubG9nR3JvdXBOYW1lKS50b0NvbnRhaW4oJ1Rva2VuJyk7XHJcbiAgICAgIGV4cGVjdChsb2dHcm91cHNbMV0ubG9nR3JvdXBOYW1lKS50b0NvbnRhaW4oJ1Rva2VuJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICB0ZXN0KCdzaG91bGQgc3VwcG9ydCBjdXN0b20gbG9nIGdyb3VwIG5hbWUnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRlc3RGdW5jdGlvbiA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssICdDdXN0b21GdW5jdGlvbicsIHtcclxuICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMjBfWCxcclxuICAgICAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXHJcbiAgICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUlubGluZSgnZXhwb3J0cy5oYW5kbGVyID0gYXN5bmMgKCkgPT4ge307JyksXHJcbiAgICAgICAgZnVuY3Rpb25OYW1lOiAnY3VzdG9tLWZ1bmN0aW9uJyxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvLyDjgqvjgrnjgr/jg6Djg63jgrDjgrDjg6vjg7zjg5flkI3jgpLmjIflrppcclxuICAgICAgY29uc3QgbG9nR3JvdXAgPSBjbG91ZFdhdGNoTG9ncy5jb25maWd1cmVGb3JMYW1iZGEoXHJcbiAgICAgICAgdGVzdEZ1bmN0aW9uLFxyXG4gICAgICAgICcvY3VzdG9tL2xvZy9ncm91cCdcclxuICAgICAgKTtcclxuXHJcbiAgICAgIC8vIENsb3VkRm9ybWF0aW9u44OG44Oz44OX44Os44O844OI44KS5qSc6Ki8XHJcbiAgICAgIGNvbnN0IHRlbXBsYXRlID0gVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKTtcclxuXHJcbiAgICAgIHRlbXBsYXRlLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpMb2dzOjpMb2dHcm91cCcsIHtcclxuICAgICAgICBSZXRlbnRpb25JbkRheXM6IDcsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgZXhwZWN0KGxvZ0dyb3VwLmxvZ0dyb3VwTmFtZSkudG9Db250YWluKCdUb2tlbicpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdQcm9kdWN0aW9uIEVudmlyb25tZW50JywgKCkgPT4ge1xyXG4gICAgbGV0IGFwcDogY2RrLkFwcDtcclxuICAgIGxldCBzdGFjazogY2RrLlN0YWNrO1xyXG4gICAgbGV0IGNsb3VkV2F0Y2hMb2dzOiBDbG91ZFdhdGNoTG9ncztcclxuXHJcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgICAgYXBwID0gbmV3IGNkay5BcHAoKTtcclxuICAgICAgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKGFwcCwgJ1Rlc3RTdGFjaycpO1xyXG4gICAgICBjbG91ZFdhdGNoTG9ncyA9IG5ldyBDbG91ZFdhdGNoTG9ncyhzdGFjaywgJ0Nsb3VkV2F0Y2hMb2dzJywge1xyXG4gICAgICAgIGVudmlyb25tZW50OiAncHJvZCcsXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdGVzdCgnc2hvdWxkIHNldCByZXRlbnRpb24gdG8gOTAgZGF5cyBmb3IgcHJvZCBlbnZpcm9ubWVudCcsICgpID0+IHtcclxuICAgICAgZXhwZWN0KGNsb3VkV2F0Y2hMb2dzLnJldGVudGlvbkRheXMpLnRvQmUobG9ncy5SZXRlbnRpb25EYXlzLlRIUkVFX01PTlRIUyk7XHJcbiAgICAgIGV4cGVjdChjbG91ZFdhdGNoTG9ncy5nZXRSZXRlbnRpb25EYXlzQXNOdW1iZXIoKSkudG9CZSg5MCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICB0ZXN0KCdzaG91bGQgc2V0IHJlbW92YWwgcG9saWN5IHRvIFJFVEFJTiBmb3IgcHJvZCBlbnZpcm9ubWVudCcsICgpID0+IHtcclxuICAgICAgZXhwZWN0KGNsb3VkV2F0Y2hMb2dzLnJlbW92YWxQb2xpY3kpLnRvQmUoY2RrLlJlbW92YWxQb2xpY3kuUkVUQUlOKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHRlc3QoJ3Nob3VsZCBjb25maWd1cmUgbG9nIGdyb3VwIGZvciBMYW1iZGEgZnVuY3Rpb24gd2l0aCA5MCBkYXlzIHJldGVudGlvbicsICgpID0+IHtcclxuICAgICAgY29uc3QgdGVzdEZ1bmN0aW9uID0gbmV3IGxhbWJkYS5GdW5jdGlvbihzdGFjaywgJ1Byb2RGdW5jdGlvbicsIHtcclxuICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMjBfWCxcclxuICAgICAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXHJcbiAgICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUlubGluZSgnZXhwb3J0cy5oYW5kbGVyID0gYXN5bmMgKCkgPT4ge307JyksXHJcbiAgICAgICAgZnVuY3Rpb25OYW1lOiAncHJvZC1mdW5jdGlvbicsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY2xvdWRXYXRjaExvZ3MuY29uZmlndXJlRm9yTGFtYmRhKHRlc3RGdW5jdGlvbik7XHJcblxyXG4gICAgICBjb25zdCB0ZW1wbGF0ZSA9IFRlbXBsYXRlLmZyb21TdGFjayhzdGFjayk7XHJcblxyXG4gICAgICAvLyDjg63jgrDkv53mjIHmnJ/plpPjgYw5MOaXpeOBp+OBguOCi+OBk+OBqOOCkueiuuiqjVxyXG4gICAgICB0ZW1wbGF0ZS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6TG9nczo6TG9nR3JvdXAnLCB7XHJcbiAgICAgICAgUmV0ZW50aW9uSW5EYXlzOiA5MCxcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0Nsb3VkRm9ybWF0aW9uIE91dHB1dHMnLCAoKSA9PiB7XHJcbiAgICB0ZXN0KCdzaG91bGQgY3JlYXRlIENsb3VkRm9ybWF0aW9uIG91dHB1dCBmb3IgbG9nIGdyb3VwJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCBhcHAgPSBuZXcgY2RrLkFwcCgpO1xyXG4gICAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soYXBwLCAnVGVzdFN0YWNrJyk7XHJcbiAgICAgIGNvbnN0IGNsb3VkV2F0Y2hMb2dzID0gbmV3IENsb3VkV2F0Y2hMb2dzKHN0YWNrLCAnQ2xvdWRXYXRjaExvZ3MnLCB7XHJcbiAgICAgICAgZW52aXJvbm1lbnQ6ICdkZXYnLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IHRlc3RGdW5jdGlvbiA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssICdPdXRwdXRUZXN0RnVuY3Rpb24nLCB7XHJcbiAgICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzIwX1gsXHJcbiAgICAgICAgaGFuZGxlcjogJ2luZGV4LmhhbmRsZXInLFxyXG4gICAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21JbmxpbmUoJ2V4cG9ydHMuaGFuZGxlciA9IGFzeW5jICgpID0+IHt9OycpLFxyXG4gICAgICAgIGZ1bmN0aW9uTmFtZTogJ291dHB1dC10ZXN0LWZ1bmN0aW9uJyxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjbG91ZFdhdGNoTG9ncy5jb25maWd1cmVGb3JMYW1iZGEodGVzdEZ1bmN0aW9uKTtcclxuXHJcbiAgICAgIGNvbnN0IHRlbXBsYXRlID0gVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKTtcclxuXHJcbiAgICAgIC8vIENsb3VkRm9ybWF0aW9uIE91dHB1dOOBjOS9nOaIkOOBleOCjOOBn+OBk+OBqOOCkueiuuiqjVxyXG4gICAgICAvLyBPdXRwdXTlkI3jga/li5XnmoTjgavnlJ/miJDjgZXjgozjgovjgZ/jgoHjgIHlrZjlnKjnorroqo3jga7jgb9cclxuICAgICAgY29uc3Qgb3V0cHV0cyA9IHRlbXBsYXRlLmZpbmRPdXRwdXRzKCcqJyk7XHJcbiAgICAgIGNvbnN0IG91dHB1dEtleXMgPSBPYmplY3Qua2V5cyhvdXRwdXRzKTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChvdXRwdXRLZXlzLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gICAgICBleHBlY3Qob3V0cHV0S2V5cy5zb21lKGtleSA9PiBrZXkuaW5jbHVkZXMoJ0xvZ0dyb3VwTmFtZScpKSkudG9CZSh0cnVlKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTtcclxuIl0sInZlcnNpb24iOjN9