{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\cdk\\__tests__\\cloudwatch-logs.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\cdk\\__tests__\\cloudwatch-logs.test.ts"],"sourcesContent":["/**\r\n * CloudWatch Logs Construct Tests\r\n * \r\n * Tests for CloudWatch Logs configuration with environment-specific retention periods\r\n */\r\n\r\nimport * as cdk from 'aws-cdk-lib';\r\nimport * as logs from 'aws-cdk-lib/aws-logs';\r\nimport * as lambda from 'aws-cdk-lib/aws-lambda';\r\nimport { Template } from 'aws-cdk-lib/assertions';\r\nimport { CloudWatchLogs } from '../lib/constructs/cloudwatch-logs';\r\n\r\ndescribe('CloudWatchLogs Construct', () => {\r\n  describe('Development Environment', () => {\r\n    let app: cdk.App;\r\n    let stack: cdk.Stack;\r\n    let cloudWatchLogs: CloudWatchLogs;\r\n\r\n    beforeEach(() => {\r\n      app = new cdk.App();\r\n      stack = new cdk.Stack(app, 'TestStack');\r\n      cloudWatchLogs = new CloudWatchLogs(stack, 'CloudWatchLogs', {\r\n        environment: 'dev',\r\n      });\r\n    });\r\n\r\n    test('should set retention to 7 days for dev environment', () => {\r\n      expect(cloudWatchLogs.retentionDays).toBe(logs.RetentionDays.ONE_WEEK);\r\n      expect(cloudWatchLogs.getRetentionDaysAsNumber()).toBe(7);\r\n    });\r\n\r\n    test('should set removal policy to DESTROY for dev environment', () => {\r\n      expect(cloudWatchLogs.removalPolicy).toBe(cdk.RemovalPolicy.DESTROY);\r\n    });\r\n\r\n    test('should configure log group for Lambda function', () => {\r\n      // Lambda関数を作成\r\n      const testFunction = new lambda.Function(stack, 'TestFunction', {\r\n        runtime: lambda.Runtime.NODEJS_20_X,\r\n        handler: 'index.handler',\r\n        code: lambda.Code.fromInline('exports.handler = async () => {};'),\r\n        functionName: 'test-function',\r\n      });\r\n\r\n      // ログ設定を適用\r\n      const logGroup = cloudWatchLogs.configureForLambda(testFunction);\r\n\r\n      // CloudFormationテンプレートを検証\r\n      const template = Template.fromStack(stack);\r\n\r\n      // ログ保持期間が7日であることを確認\r\n      template.hasResourceProperties('AWS::Logs::LogGroup', {\r\n        RetentionInDays: 7,\r\n      });\r\n\r\n      // ロググループが作成されたことを確認\r\n      expect(logGroup).toBeDefined();\r\n      // LogGroupNameはCDKトークンとして生成されるため、文字列として検証できない\r\n      expect(logGroup.logGroupName).toContain('Token');\r\n    });\r\n\r\n    test('should configure log groups for multiple Lambda functions', () => {\r\n      // 複数のLambda関数を作成\r\n      const functions = [\r\n        new lambda.Function(stack, 'Function1', {\r\n          runtime: lambda.Runtime.NODEJS_20_X,\r\n          handler: 'index.handler',\r\n          code: lambda.Code.fromInline('exports.handler = async () => {};'),\r\n          functionName: 'function-1',\r\n        }),\r\n        new lambda.Function(stack, 'Function2', {\r\n          runtime: lambda.Runtime.NODEJS_20_X,\r\n          handler: 'index.handler',\r\n          code: lambda.Code.fromInline('exports.handler = async () => {};'),\r\n          functionName: 'function-2',\r\n        }),\r\n      ];\r\n\r\n      // ログ設定を適用\r\n      const logGroups = cloudWatchLogs.configureForLambdas(functions);\r\n\r\n      // CloudFormationテンプレートを検証\r\n      const template = Template.fromStack(stack);\r\n\r\n      // 2つのロググループが作成されたことを確認\r\n      template.resourceCountIs('AWS::Logs::LogGroup', 2);\r\n\r\n      // 各ロググループの設定を確認（保持期間のみ検証）\r\n      template.hasResourceProperties('AWS::Logs::LogGroup', {\r\n        RetentionInDays: 7,\r\n      });\r\n\r\n      // ロググループが作成されたことを確認\r\n      expect(logGroups).toHaveLength(2);\r\n      expect(logGroups[0].logGroupName).toContain('Token');\r\n      expect(logGroups[1].logGroupName).toContain('Token');\r\n    });\r\n\r\n    test('should support custom log group name', () => {\r\n      const testFunction = new lambda.Function(stack, 'CustomFunction', {\r\n        runtime: lambda.Runtime.NODEJS_20_X,\r\n        handler: 'index.handler',\r\n        code: lambda.Code.fromInline('exports.handler = async () => {};'),\r\n        functionName: 'custom-function',\r\n      });\r\n\r\n      // カスタムロググループ名を指定\r\n      const logGroup = cloudWatchLogs.configureForLambda(\r\n        testFunction,\r\n        '/custom/log/group'\r\n      );\r\n\r\n      // CloudFormationテンプレートを検証\r\n      const template = Template.fromStack(stack);\r\n\r\n      template.hasResourceProperties('AWS::Logs::LogGroup', {\r\n        RetentionInDays: 7,\r\n      });\r\n\r\n      expect(logGroup.logGroupName).toContain('Token');\r\n    });\r\n  });\r\n\r\n  describe('Production Environment', () => {\r\n    let app: cdk.App;\r\n    let stack: cdk.Stack;\r\n    let cloudWatchLogs: CloudWatchLogs;\r\n\r\n    beforeEach(() => {\r\n      app = new cdk.App();\r\n      stack = new cdk.Stack(app, 'TestStack');\r\n      cloudWatchLogs = new CloudWatchLogs(stack, 'CloudWatchLogs', {\r\n        environment: 'prod',\r\n      });\r\n    });\r\n\r\n    test('should set retention to 90 days for prod environment', () => {\r\n      expect(cloudWatchLogs.retentionDays).toBe(logs.RetentionDays.THREE_MONTHS);\r\n      expect(cloudWatchLogs.getRetentionDaysAsNumber()).toBe(90);\r\n    });\r\n\r\n    test('should set removal policy to RETAIN for prod environment', () => {\r\n      expect(cloudWatchLogs.removalPolicy).toBe(cdk.RemovalPolicy.RETAIN);\r\n    });\r\n\r\n    test('should configure log group for Lambda function with 90 days retention', () => {\r\n      const testFunction = new lambda.Function(stack, 'ProdFunction', {\r\n        runtime: lambda.Runtime.NODEJS_20_X,\r\n        handler: 'index.handler',\r\n        code: lambda.Code.fromInline('exports.handler = async () => {};'),\r\n        functionName: 'prod-function',\r\n      });\r\n\r\n      cloudWatchLogs.configureForLambda(testFunction);\r\n\r\n      const template = Template.fromStack(stack);\r\n\r\n      // ログ保持期間が90日であることを確認\r\n      template.hasResourceProperties('AWS::Logs::LogGroup', {\r\n        RetentionInDays: 90,\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('CloudFormation Outputs', () => {\r\n    test('should create CloudFormation output for log group', () => {\r\n      const app = new cdk.App();\r\n      const stack = new cdk.Stack(app, 'TestStack');\r\n      const cloudWatchLogs = new CloudWatchLogs(stack, 'CloudWatchLogs', {\r\n        environment: 'dev',\r\n      });\r\n\r\n      const testFunction = new lambda.Function(stack, 'OutputTestFunction', {\r\n        runtime: lambda.Runtime.NODEJS_20_X,\r\n        handler: 'index.handler',\r\n        code: lambda.Code.fromInline('exports.handler = async () => {};'),\r\n        functionName: 'output-test-function',\r\n      });\r\n\r\n      cloudWatchLogs.configureForLambda(testFunction);\r\n\r\n      const template = Template.fromStack(stack);\r\n\r\n      // CloudFormation Outputが作成されたことを確認\r\n      // Output名は動的に生成されるため、存在確認のみ\r\n      const outputs = template.findOutputs('*');\r\n      const outputKeys = Object.keys(outputs);\r\n      \r\n      expect(outputKeys.length).toBeGreaterThan(0);\r\n      expect(outputKeys.some(key => key.includes('LogGroupName'))).toBe(true);\r\n    });\r\n  });\r\n});\r\n"],"version":3}