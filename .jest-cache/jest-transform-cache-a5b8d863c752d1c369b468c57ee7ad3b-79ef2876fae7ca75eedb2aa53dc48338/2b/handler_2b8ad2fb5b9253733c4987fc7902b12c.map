{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\api\\pdf-download\\handler.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\api\\pdf-download\\handler.ts"],"sourcesContent":["/**\r\n * Lambda PDF Download Handler\r\n *\r\n * GET /disclosures/{disclosure_id}/pdf エンドポイント\r\n * PDFファイルの署名付きURLを生成して返却します。\r\n *\r\n * Requirements: タスク13.6\r\n */\r\n\r\nimport { APIGatewayProxyEvent, APIGatewayProxyResult, Context } from 'aws-lambda';\r\nimport { DynamoDBClient, GetItemCommand } from '@aws-sdk/client-dynamodb';\r\nimport { S3Client, GetObjectCommand, HeadObjectCommand } from '@aws-sdk/client-s3';\r\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\r\nimport { logger, createErrorContext } from '../../../utils/logger';\r\nimport { sendErrorMetric, sendMetrics } from '../../../utils/cloudwatch-metrics';\r\nimport { ValidationError, NotFoundError, AuthenticationError } from '../../../errors';\r\nimport { retryWithBackoff } from '../../../utils/retry';\r\n\r\n// クライアント（グローバルスコープで初期化）\r\nconst dynamoClient = new DynamoDBClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });\r\nconst s3Client = new S3Client({ region: process.env.AWS_REGION || 'ap-northeast-1' });\r\n\r\n// 環境変数\r\nconst DISCLOSURES_TABLE = process.env.DYNAMODB_TABLE_NAME || 'tdnet_disclosures';\r\nconst PDF_BUCKET = process.env.S3_BUCKET_NAME || 'tdnet-data-collector-pdfs';\r\nconst API_KEY = process.env.API_KEY;\r\nconst DEFAULT_EXPIRATION = 3600; // 1時間（秒）\r\nconst MAX_EXPIRATION = 86400; // 24時間（秒）\r\nconst MIN_EXPIRATION = 60; // 1分（秒）\r\n\r\n/**\r\n * Lambda PDF Download Handler\r\n *\r\n * @param event APIGatewayProxyEvent\r\n * @param context Lambda Context\r\n * @returns APIGatewayProxyResult\r\n *\r\n * @example\r\n * ```typescript\r\n * // GET /disclosures/20240115_7203_001/pdf\r\n * const response = await handler({\r\n *   pathParameters: { disclosure_id: '20240115_7203_001' },\r\n *   queryStringParameters: { expiration: '3600' },\r\n *   headers: { 'x-api-key': 'your-api-key' },\r\n * }, context);\r\n * ```\r\n */\r\nexport async function handler(\r\n  event: APIGatewayProxyEvent,\r\n  context: Context\r\n): Promise<APIGatewayProxyResult> {\r\n  const startTime = Date.now();\r\n\r\n  try {\r\n    logger.info('Lambda PDF Download started', {\r\n      request_id: context.awsRequestId,\r\n      function_name: context.functionName,\r\n      disclosure_id: event.pathParameters?.disclosure_id,\r\n    });\r\n\r\n    // APIキー認証\r\n    validateApiKey(event);\r\n\r\n    // disclosure_idの取得とバリデーション\r\n    const disclosureId = validateDisclosureId(event);\r\n\r\n    // expirationパラメータの取得とバリデーション\r\n    const expiration = validateExpiration(event);\r\n\r\n    // DynamoDBから開示情報を取得\r\n    const disclosure = await getDisclosure(disclosureId);\r\n\r\n    // S3キーの検証\r\n    if (!disclosure.pdf_s3_key) {\r\n      throw new NotFoundError(`PDF file not found for disclosure: ${disclosureId}`);\r\n    }\r\n\r\n    // S3オブジェクトの存在確認\r\n    await verifyS3ObjectExists(disclosure.pdf_s3_key);\r\n\r\n    // 署名付きURLを生成\r\n    const signedUrl = await generateSignedUrl(disclosure.pdf_s3_key, expiration);\r\n\r\n    // 有効期限を計算\r\n    const expiresAt = new Date(Date.now() + expiration * 1000).toISOString();\r\n\r\n    const duration = Date.now() - startTime;\r\n\r\n    logger.info('Lambda PDF Download completed', {\r\n      disclosure_id: disclosureId,\r\n      s3_key: disclosure.pdf_s3_key,\r\n      expiration,\r\n      duration_ms: duration,\r\n    });\r\n\r\n    // 成功メトリクス送信\r\n    await sendMetrics([\r\n      {\r\n        name: 'LambdaExecutionTime',\r\n        value: duration,\r\n        unit: 'Milliseconds',\r\n        dimensions: { FunctionName: 'PDFDownload' },\r\n      },\r\n      {\r\n        name: 'PDFDownloadRequests',\r\n        value: 1,\r\n        unit: 'Count',\r\n        dimensions: { Status: 'Success' },\r\n      },\r\n    ]);\r\n\r\n    // レスポンス\r\n    return {\r\n      statusCode: 200,\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Headers': 'Content-Type,X-Api-Key',\r\n      },\r\n      body: JSON.stringify({\r\n        status: 'success',\r\n        data: {\r\n          download_url: signedUrl,\r\n          expires_at: expiresAt,\r\n        },\r\n      }),\r\n    };\r\n  } catch (error) {\r\n    const duration = Date.now() - startTime;\r\n\r\n    logger.error(\r\n      'Lambda PDF Download failed',\r\n      createErrorContext(error as Error, {\r\n        request_id: context.awsRequestId,\r\n        disclosure_id: event.pathParameters?.disclosure_id,\r\n        duration_ms: duration,\r\n      })\r\n    );\r\n\r\n    // エラーメトリクス送信\r\n    await sendErrorMetric(\r\n      error instanceof Error ? error.constructor.name : 'Unknown',\r\n      'PDFDownload'\r\n    );\r\n\r\n    // エラーレスポンス\r\n    return handleError(error as Error, context.awsRequestId);\r\n  }\r\n}\r\n\r\n/**\r\n * APIキー認証\r\n *\r\n * @param event APIGatewayProxyEvent\r\n * @throws AuthenticationError APIキーが無効な場合\r\n */\r\nfunction validateApiKey(event: APIGatewayProxyEvent): void {\r\n  const apiKey = event.headers?.['x-api-key'] || event.headers?.['X-Api-Key'];\r\n\r\n  if (!apiKey) {\r\n    throw new AuthenticationError('API key is required');\r\n  }\r\n\r\n  // 環境変数から直接読み取る（テスト環境での動的設定に対応）\r\n  const expectedApiKey = process.env.API_KEY;\r\n  if (expectedApiKey && apiKey !== expectedApiKey) {\r\n    throw new AuthenticationError('Invalid API key');\r\n  }\r\n}\r\n\r\n/**\r\n * disclosure_idのバリデーション\r\n *\r\n * @param event APIGatewayProxyEvent\r\n * @returns disclosure_id\r\n * @throws ValidationError disclosure_idが無効な場合\r\n */\r\nfunction validateDisclosureId(event: APIGatewayProxyEvent): string {\r\n  const disclosureId = event.pathParameters?.disclosure_id;\r\n\r\n  if (!disclosureId) {\r\n    throw new ValidationError('disclosure_id is required');\r\n  }\r\n\r\n  // disclosure_idのフォーマット検証（例: 20240115_7203_001）\r\n  if (!/^\\d{8}_\\d{4}_\\d{3}$/.test(disclosureId)) {\r\n    throw new ValidationError(\r\n      `Invalid disclosure_id format: ${disclosureId}. Expected format: YYYYMMDD_CCCC_NNN`\r\n    );\r\n  }\r\n\r\n  return disclosureId;\r\n}\r\n\r\n/**\r\n * expirationパラメータのバリデーション\r\n *\r\n * @param event APIGatewayProxyEvent\r\n * @returns expiration（秒）\r\n * @throws ValidationError expirationが無効な場合\r\n */\r\nfunction validateExpiration(event: APIGatewayProxyEvent): number {\r\n  const expirationParam = event.queryStringParameters?.expiration;\r\n\r\n  if (!expirationParam) {\r\n    return DEFAULT_EXPIRATION;\r\n  }\r\n\r\n  const expiration = parseInt(expirationParam, 10);\r\n\r\n  if (isNaN(expiration)) {\r\n    throw new ValidationError(\r\n      `Invalid expiration format: ${expirationParam}. Expected integer.`\r\n    );\r\n  }\r\n\r\n  if (expiration < MIN_EXPIRATION || expiration > MAX_EXPIRATION) {\r\n    throw new ValidationError(\r\n      `Expiration out of range: ${expiration}. Must be between ${MIN_EXPIRATION} and ${MAX_EXPIRATION} seconds.`\r\n    );\r\n  }\r\n\r\n  return expiration;\r\n}\r\n\r\n/**\r\n * DynamoDBから開示情報を取得\r\n *\r\n * @param disclosureId 開示ID\r\n * @returns 開示情報\r\n * @throws NotFoundError 開示情報が見つからない場合\r\n */\r\nasync function getDisclosure(disclosureId: string): Promise<Disclosure> {\r\n  logger.info('Fetching disclosure from DynamoDB', {\r\n    disclosure_id: disclosureId,\r\n    table: DISCLOSURES_TABLE,\r\n  });\r\n\r\n  const result = await retryWithBackoff(\r\n    async () => {\r\n      return await dynamoClient.send(\r\n        new GetItemCommand({\r\n          TableName: DISCLOSURES_TABLE,\r\n          Key: {\r\n            disclosure_id: { S: disclosureId },\r\n          },\r\n        })\r\n      );\r\n    },\r\n    {\r\n      maxRetries: 3,\r\n      initialDelay: 1000,\r\n      backoffMultiplier: 2,\r\n      jitter: true,\r\n      shouldRetry: (error) => {\r\n        return error.name === 'ProvisionedThroughputExceededException';\r\n      },\r\n    }\r\n  );\r\n\r\n  if (!result.Item) {\r\n    throw new NotFoundError(`Disclosure not found: ${disclosureId}`);\r\n  }\r\n\r\n  // DynamoDBアイテムをDisclosureに変換\r\n  const item = result.Item;\r\n\r\n  const disclosure: Disclosure = {\r\n    disclosure_id: item.disclosure_id.S!,\r\n    company_code: item.company_code.S!,\r\n    company_name: item.company_name.S!,\r\n    pdf_s3_key: item.pdf_s3_key?.S || null,\r\n  };\r\n\r\n  logger.info('Disclosure fetched successfully', {\r\n    disclosure_id: disclosureId,\r\n    pdf_s3_key: disclosure.pdf_s3_key,\r\n  });\r\n\r\n  return disclosure;\r\n}\r\n\r\n/**\r\n * S3オブジェクトの存在確認\r\n *\r\n * @param s3Key S3キー\r\n * @throws NotFoundError S3オブジェクトが存在しない場合\r\n */\r\nasync function verifyS3ObjectExists(s3Key: string): Promise<void> {\r\n  logger.info('Verifying S3 object exists', {\r\n    s3_key: s3Key,\r\n    bucket: PDF_BUCKET,\r\n  });\r\n\r\n  try {\r\n    await retryWithBackoff(\r\n      async () => {\r\n        await s3Client.send(\r\n          new HeadObjectCommand({\r\n            Bucket: PDF_BUCKET,\r\n            Key: s3Key,\r\n          })\r\n        );\r\n      },\r\n      {\r\n        maxRetries: 3,\r\n        initialDelay: 1000,\r\n        backoffMultiplier: 2,\r\n        jitter: true,\r\n        shouldRetry: (error) => {\r\n          // 404エラーは再試行しない\r\n          if (error.name === 'NotFound' || error.$metadata?.httpStatusCode === 404) {\r\n            return false;\r\n          }\r\n          // その他のエラーは再試行\r\n          return true;\r\n        },\r\n      }\r\n    );\r\n\r\n    logger.info('S3 object exists', { s3_key: s3Key });\r\n  } catch (error) {\r\n    if ((error as any).name === 'NotFound' || (error as any).$metadata?.httpStatusCode === 404) {\r\n      throw new NotFoundError(`PDF file not found in S3: ${s3Key}`);\r\n    }\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * 署名付きURLを生成\r\n *\r\n * @param s3Key S3キー\r\n * @param expiresIn 有効期限（秒）\r\n * @returns 署名付きURL\r\n */\r\nasync function generateSignedUrl(s3Key: string, expiresIn: number): Promise<string> {\r\n  logger.info('Generating signed URL', {\r\n    s3_key: s3Key,\r\n    bucket: PDF_BUCKET,\r\n    expires_in: expiresIn,\r\n  });\r\n\r\n  const command = new GetObjectCommand({\r\n    Bucket: PDF_BUCKET,\r\n    Key: s3Key,\r\n  });\r\n\r\n  const signedUrl = await getSignedUrl(s3Client, command, { expiresIn });\r\n\r\n  logger.info('Signed URL generated successfully', {\r\n    s3_key: s3Key,\r\n    url_length: signedUrl.length,\r\n  });\r\n\r\n  return signedUrl;\r\n}\r\n\r\n/**\r\n * エラーハンドリング\r\n *\r\n * @param error エラーオブジェクト\r\n * @param requestId リクエストID\r\n * @returns APIGatewayProxyResult\r\n */\r\nfunction handleError(error: Error, requestId: string): APIGatewayProxyResult {\r\n  // エラー種別に応じたステータスコードとエラーコード\r\n  let statusCode = 500;\r\n  let errorCode = 'INTERNAL_ERROR';\r\n\r\n  if (error instanceof ValidationError) {\r\n    statusCode = 400;\r\n    errorCode = 'VALIDATION_ERROR';\r\n  } else if (error instanceof AuthenticationError) {\r\n    statusCode = 401;\r\n    errorCode = 'UNAUTHORIZED';\r\n  } else if (error instanceof NotFoundError) {\r\n    statusCode = 404;\r\n    errorCode = 'NOT_FOUND';\r\n  }\r\n\r\n  return {\r\n    statusCode,\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n      'Access-Control-Allow-Origin': '*',\r\n      'Access-Control-Allow-Headers': 'Content-Type,X-Api-Key',\r\n    },\r\n    body: JSON.stringify({\r\n      status: 'error',\r\n      error: {\r\n        code: errorCode,\r\n        message: error.message,\r\n        details: (error as any).details || {},\r\n      },\r\n      request_id: requestId,\r\n    }),\r\n  };\r\n}\r\n\r\n/**\r\n * 開示情報の型定義（最小限）\r\n */\r\ninterface Disclosure {\r\n  disclosure_id: string;\r\n  company_code: string;\r\n  company_name: string;\r\n  pdf_s3_key: string | null;\r\n}\r\n"],"version":3}