deefc532cb37b34a740bce4c252b4d63
"use strict";
/**
 * Lambda PDF Download Handler
 *
 * GET /disclosures/{disclosure_id}/pdf エンドポイント
 * PDFファイルの署名付きURLを生成して返却します。
 *
 * Requirements: タスク13.6
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const client_s3_1 = require("@aws-sdk/client-s3");
const s3_request_presigner_1 = require("@aws-sdk/s3-request-presigner");
const logger_1 = require("../../../utils/logger");
const cloudwatch_metrics_1 = require("../../../utils/cloudwatch-metrics");
const errors_1 = require("../../../errors");
const retry_1 = require("../../../utils/retry");
// クライアント（グローバルスコープで初期化）
const dynamoClient = new client_dynamodb_1.DynamoDBClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });
const s3Client = new client_s3_1.S3Client({ region: process.env.AWS_REGION || 'ap-northeast-1' });
// 環境変数
const DISCLOSURES_TABLE = process.env.DYNAMODB_TABLE_NAME || 'tdnet_disclosures';
const PDF_BUCKET = process.env.S3_BUCKET_NAME || 'tdnet-data-collector-pdfs';
const API_KEY = process.env.API_KEY;
const DEFAULT_EXPIRATION = 3600; // 1時間（秒）
const MAX_EXPIRATION = 86400; // 24時間（秒）
const MIN_EXPIRATION = 60; // 1分（秒）
/**
 * Lambda PDF Download Handler
 *
 * @param event APIGatewayProxyEvent
 * @param context Lambda Context
 * @returns APIGatewayProxyResult
 *
 * @example
 * ```typescript
 * // GET /disclosures/20240115_7203_001/pdf
 * const response = await handler({
 *   pathParameters: { disclosure_id: '20240115_7203_001' },
 *   queryStringParameters: { expiration: '3600' },
 *   headers: { 'x-api-key': 'your-api-key' },
 * }, context);
 * ```
 */
async function handler(event, context) {
    const startTime = Date.now();
    try {
        logger_1.logger.info('Lambda PDF Download started', {
            request_id: context.awsRequestId,
            function_name: context.functionName,
            disclosure_id: event.pathParameters?.disclosure_id,
        });
        // APIキー認証
        validateApiKey(event);
        // disclosure_idの取得とバリデーション
        const disclosureId = validateDisclosureId(event);
        // expirationパラメータの取得とバリデーション
        const expiration = validateExpiration(event);
        // DynamoDBから開示情報を取得
        const disclosure = await getDisclosure(disclosureId);
        // S3キーの検証
        if (!disclosure.pdf_s3_key) {
            throw new errors_1.NotFoundError(`PDF file not found for disclosure: ${disclosureId}`);
        }
        // S3オブジェクトの存在確認
        await verifyS3ObjectExists(disclosure.pdf_s3_key);
        // 署名付きURLを生成
        const signedUrl = await generateSignedUrl(disclosure.pdf_s3_key, expiration);
        // 有効期限を計算
        const expiresAt = new Date(Date.now() + expiration * 1000).toISOString();
        const duration = Date.now() - startTime;
        logger_1.logger.info('Lambda PDF Download completed', {
            disclosure_id: disclosureId,
            s3_key: disclosure.pdf_s3_key,
            expiration,
            duration_ms: duration,
        });
        // 成功メトリクス送信
        await (0, cloudwatch_metrics_1.sendMetrics)([
            {
                name: 'LambdaExecutionTime',
                value: duration,
                unit: 'Milliseconds',
                dimensions: { FunctionName: 'PDFDownload' },
            },
            {
                name: 'PDFDownloadRequests',
                value: 1,
                unit: 'Count',
                dimensions: { Status: 'Success' },
            },
        ]);
        // レスポンス
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Headers': 'Content-Type,X-Api-Key',
            },
            body: JSON.stringify({
                status: 'success',
                data: {
                    download_url: signedUrl,
                    expires_at: expiresAt,
                },
            }),
        };
    }
    catch (error) {
        const duration = Date.now() - startTime;
        logger_1.logger.error('Lambda PDF Download failed', (0, logger_1.createErrorContext)(error, {
            request_id: context.awsRequestId,
            disclosure_id: event.pathParameters?.disclosure_id,
            duration_ms: duration,
        }));
        // エラーメトリクス送信
        await (0, cloudwatch_metrics_1.sendErrorMetric)(error instanceof Error ? error.constructor.name : 'Unknown', 'PDFDownload');
        // エラーレスポンス
        return handleError(error, context.awsRequestId);
    }
}
/**
 * APIキー認証
 *
 * @param event APIGatewayProxyEvent
 * @throws AuthenticationError APIキーが無効な場合
 */
function validateApiKey(event) {
    const apiKey = event.headers?.['x-api-key'] || event.headers?.['X-Api-Key'];
    if (!apiKey) {
        throw new errors_1.AuthenticationError('API key is required');
    }
    // 環境変数から直接読み取る（テスト環境での動的設定に対応）
    const expectedApiKey = process.env.API_KEY;
    if (expectedApiKey && apiKey !== expectedApiKey) {
        throw new errors_1.AuthenticationError('Invalid API key');
    }
}
/**
 * disclosure_idのバリデーション
 *
 * @param event APIGatewayProxyEvent
 * @returns disclosure_id
 * @throws ValidationError disclosure_idが無効な場合
 */
function validateDisclosureId(event) {
    const disclosureId = event.pathParameters?.disclosure_id;
    if (!disclosureId) {
        throw new errors_1.ValidationError('disclosure_id is required');
    }
    // disclosure_idのフォーマット検証（例: 20240115_7203_001）
    if (!/^\d{8}_\d{4}_\d{3}$/.test(disclosureId)) {
        throw new errors_1.ValidationError(`Invalid disclosure_id format: ${disclosureId}. Expected format: YYYYMMDD_CCCC_NNN`);
    }
    return disclosureId;
}
/**
 * expirationパラメータのバリデーション
 *
 * @param event APIGatewayProxyEvent
 * @returns expiration（秒）
 * @throws ValidationError expirationが無効な場合
 */
function validateExpiration(event) {
    const expirationParam = event.queryStringParameters?.expiration;
    if (!expirationParam) {
        return DEFAULT_EXPIRATION;
    }
    const expiration = parseInt(expirationParam, 10);
    if (isNaN(expiration)) {
        throw new errors_1.ValidationError(`Invalid expiration format: ${expirationParam}. Expected integer.`);
    }
    if (expiration < MIN_EXPIRATION || expiration > MAX_EXPIRATION) {
        throw new errors_1.ValidationError(`Expiration out of range: ${expiration}. Must be between ${MIN_EXPIRATION} and ${MAX_EXPIRATION} seconds.`);
    }
    return expiration;
}
/**
 * DynamoDBから開示情報を取得
 *
 * @param disclosureId 開示ID
 * @returns 開示情報
 * @throws NotFoundError 開示情報が見つからない場合
 */
async function getDisclosure(disclosureId) {
    logger_1.logger.info('Fetching disclosure from DynamoDB', {
        disclosure_id: disclosureId,
        table: DISCLOSURES_TABLE,
    });
    const result = await (0, retry_1.retryWithBackoff)(async () => {
        return await dynamoClient.send(new client_dynamodb_1.GetItemCommand({
            TableName: DISCLOSURES_TABLE,
            Key: {
                disclosure_id: { S: disclosureId },
            },
        }));
    }, {
        maxRetries: 3,
        initialDelay: 1000,
        backoffMultiplier: 2,
        jitter: true,
        shouldRetry: (error) => {
            return error.name === 'ProvisionedThroughputExceededException';
        },
    });
    if (!result.Item) {
        throw new errors_1.NotFoundError(`Disclosure not found: ${disclosureId}`);
    }
    // DynamoDBアイテムをDisclosureに変換
    const item = result.Item;
    const disclosure = {
        disclosure_id: item.disclosure_id.S,
        company_code: item.company_code.S,
        company_name: item.company_name.S,
        pdf_s3_key: item.pdf_s3_key?.S || null,
    };
    logger_1.logger.info('Disclosure fetched successfully', {
        disclosure_id: disclosureId,
        pdf_s3_key: disclosure.pdf_s3_key,
    });
    return disclosure;
}
/**
 * S3オブジェクトの存在確認
 *
 * @param s3Key S3キー
 * @throws NotFoundError S3オブジェクトが存在しない場合
 */
async function verifyS3ObjectExists(s3Key) {
    logger_1.logger.info('Verifying S3 object exists', {
        s3_key: s3Key,
        bucket: PDF_BUCKET,
    });
    try {
        await (0, retry_1.retryWithBackoff)(async () => {
            await s3Client.send(new client_s3_1.HeadObjectCommand({
                Bucket: PDF_BUCKET,
                Key: s3Key,
            }));
        }, {
            maxRetries: 3,
            initialDelay: 1000,
            backoffMultiplier: 2,
            jitter: true,
            shouldRetry: (error) => {
                // 404エラーは再試行しない
                if (error.name === 'NotFound' || error.$metadata?.httpStatusCode === 404) {
                    return false;
                }
                // その他のエラーは再試行
                return true;
            },
        });
        logger_1.logger.info('S3 object exists', { s3_key: s3Key });
    }
    catch (error) {
        if (error.name === 'NotFound' || error.$metadata?.httpStatusCode === 404) {
            throw new errors_1.NotFoundError(`PDF file not found in S3: ${s3Key}`);
        }
        throw error;
    }
}
/**
 * 署名付きURLを生成
 *
 * @param s3Key S3キー
 * @param expiresIn 有効期限（秒）
 * @returns 署名付きURL
 */
async function generateSignedUrl(s3Key, expiresIn) {
    logger_1.logger.info('Generating signed URL', {
        s3_key: s3Key,
        bucket: PDF_BUCKET,
        expires_in: expiresIn,
    });
    const command = new client_s3_1.GetObjectCommand({
        Bucket: PDF_BUCKET,
        Key: s3Key,
    });
    const signedUrl = await (0, s3_request_presigner_1.getSignedUrl)(s3Client, command, { expiresIn });
    logger_1.logger.info('Signed URL generated successfully', {
        s3_key: s3Key,
        url_length: signedUrl.length,
    });
    return signedUrl;
}
/**
 * エラーハンドリング
 *
 * @param error エラーオブジェクト
 * @param requestId リクエストID
 * @returns APIGatewayProxyResult
 */
function handleError(error, requestId) {
    // エラー種別に応じたステータスコードとエラーコード
    let statusCode = 500;
    let errorCode = 'INTERNAL_ERROR';
    if (error instanceof errors_1.ValidationError) {
        statusCode = 400;
        errorCode = 'VALIDATION_ERROR';
    }
    else if (error instanceof errors_1.AuthenticationError) {
        statusCode = 401;
        errorCode = 'UNAUTHORIZED';
    }
    else if (error instanceof errors_1.NotFoundError) {
        statusCode = 404;
        errorCode = 'NOT_FOUND';
    }
    return {
        statusCode,
        headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Headers': 'Content-Type,X-Api-Key',
        },
        body: JSON.stringify({
            status: 'error',
            error: {
                code: errorCode,
                message: error.message,
                details: error.details || {},
            },
            request_id: requestId,
        }),
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGFwaVxccGRmLWRvd25sb2FkXFxoYW5kbGVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7OztHQU9HOztBQXdDSCwwQkFxR0M7QUExSUQsOERBQTBFO0FBQzFFLGtEQUFtRjtBQUNuRix3RUFBNkQ7QUFDN0Qsa0RBQW1FO0FBQ25FLDBFQUFpRjtBQUNqRiw0Q0FBc0Y7QUFDdEYsZ0RBQXdEO0FBRXhELHdCQUF3QjtBQUN4QixNQUFNLFlBQVksR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO0FBQ2hHLE1BQU0sUUFBUSxHQUFHLElBQUksb0JBQVEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7QUFFdEYsT0FBTztBQUNQLE1BQU0saUJBQWlCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsSUFBSSxtQkFBbUIsQ0FBQztBQUNqRixNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSwyQkFBMkIsQ0FBQztBQUM3RSxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQztBQUNwQyxNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyxDQUFDLFNBQVM7QUFDMUMsTUFBTSxjQUFjLEdBQUcsS0FBSyxDQUFDLENBQUMsVUFBVTtBQUN4QyxNQUFNLGNBQWMsR0FBRyxFQUFFLENBQUMsQ0FBQyxRQUFRO0FBRW5DOzs7Ozs7Ozs7Ozs7Ozs7O0dBZ0JHO0FBQ0ksS0FBSyxVQUFVLE9BQU8sQ0FDM0IsS0FBMkIsRUFDM0IsT0FBZ0I7SUFFaEIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBRTdCLElBQUksQ0FB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Q0FBQyxTQUFTLENBQUM7WUFDbkIsTUFBTSxFQUFFLE9BQU87WUFDZixLQUFLLEVBQUU7Z0JBQ0wsSUFBSSxFQUFFLFNBQVM7Z0JBQ2YsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO2dCQUN0QixPQUFPLEVBQUcsS0FBYSxDQUFDLE9BQU8sSUFBSSxFQUFFO2FBQ3RDO1lBQ0QsVUFBVSxFQUFFLFNBQVM7U0FDdEIsQ0FBQztLQUNILENBQUM7QUFDSixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcdGkxOThcXGludmVzdG1lbnRfYW5hbHlzaXNfb3BvcG9cXHNyY1xcbGFtYmRhXFxhcGlcXHBkZi1kb3dubG9hZFxcaGFuZGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogTGFtYmRhIFBERiBEb3dubG9hZCBIYW5kbGVyXHJcbiAqXHJcbiAqIEdFVCAvZGlzY2xvc3VyZXMve2Rpc2Nsb3N1cmVfaWR9L3BkZiDjgqjjg7Pjg4njg53jgqTjg7Pjg4hcclxuICogUERG44OV44Kh44Kk44Or44Gu572y5ZCN5LuY44GNVVJM44KS55Sf5oiQ44GX44Gm6L+U5Y2044GX44G+44GZ44CCXHJcbiAqXHJcbiAqIFJlcXVpcmVtZW50czog44K/44K544KvMTMuNlxyXG4gKi9cclxuXHJcbmltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQsIENvbnRleHQgfSBmcm9tICdhd3MtbGFtYmRhJztcclxuaW1wb3J0IHsgRHluYW1vREJDbGllbnQsIEdldEl0ZW1Db21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcclxuaW1wb3J0IHsgUzNDbGllbnQsIEdldE9iamVjdENvbW1hbmQsIEhlYWRPYmplY3RDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcclxuaW1wb3J0IHsgZ2V0U2lnbmVkVXJsIH0gZnJvbSAnQGF3cy1zZGsvczMtcmVxdWVzdC1wcmVzaWduZXInO1xyXG5pbXBvcnQgeyBsb2dnZXIsIGNyZWF0ZUVycm9yQ29udGV4dCB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL2xvZ2dlcic7XHJcbmltcG9ydCB7IHNlbmRFcnJvck1ldHJpYywgc2VuZE1ldHJpY3MgfSBmcm9tICcuLi8uLi8uLi91dGlscy9jbG91ZHdhdGNoLW1ldHJpY3MnO1xyXG5pbXBvcnQgeyBWYWxpZGF0aW9uRXJyb3IsIE5vdEZvdW5kRXJyb3IsIEF1dGhlbnRpY2F0aW9uRXJyb3IgfSBmcm9tICcuLi8uLi8uLi9lcnJvcnMnO1xyXG5pbXBvcnQgeyByZXRyeVdpdGhCYWNrb2ZmIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvcmV0cnknO1xyXG5cclxuLy8g44Kv44Op44Kk44Ki44Oz44OI77yI44Kw44Ot44O844OQ44Or44K544Kz44O844OX44Gn5Yid5pyf5YyW77yJXHJcbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7IHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB8fCAnYXAtbm9ydGhlYXN0LTEnIH0pO1xyXG5jb25zdCBzM0NsaWVudCA9IG5ldyBTM0NsaWVudCh7IHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB8fCAnYXAtbm9ydGhlYXN0LTEnIH0pO1xyXG5cclxuLy8g55Kw5aKD5aSJ5pWwXHJcbmNvbnN0IERJU0NMT1NVUkVTX1RBQkxFID0gcHJvY2Vzcy5lbnYuRFlOQU1PREJfVEFCTEVfTkFNRSB8fCAndGRuZXRfZGlzY2xvc3VyZXMnO1xyXG5jb25zdCBQREZfQlVDS0VUID0gcHJvY2Vzcy5lbnYuUzNfQlVDS0VUX05BTUUgfHwgJ3RkbmV0LWRhdGEtY29sbGVjdG9yLXBkZnMnO1xyXG5jb25zdCBBUElfS0VZID0gcHJvY2Vzcy5lbnYuQVBJX0tFWTtcclxuY29uc3QgREVGQVVMVF9FWFBJUkFUSU9OID0gMzYwMDsgLy8gMeaZgumWk++8iOenku+8iVxyXG5jb25zdCBNQVhfRVhQSVJBVElPTiA9IDg2NDAwOyAvLyAyNOaZgumWk++8iOenku+8iVxyXG5jb25zdCBNSU5fRVhQSVJBVElPTiA9IDYwOyAvLyAx5YiG77yI56eS77yJXHJcblxyXG4vKipcclxuICogTGFtYmRhIFBERiBEb3dubG9hZCBIYW5kbGVyXHJcbiAqXHJcbiAqIEBwYXJhbSBldmVudCBBUElHYXRld2F5UHJveHlFdmVudFxyXG4gKiBAcGFyYW0gY29udGV4dCBMYW1iZGEgQ29udGV4dFxyXG4gKiBAcmV0dXJucyBBUElHYXRld2F5UHJveHlSZXN1bHRcclxuICpcclxuICogQGV4YW1wbGVcclxuICogYGBgdHlwZXNjcmlwdFxyXG4gKiAvLyBHRVQgL2Rpc2Nsb3N1cmVzLzIwMjQwMTE1XzcyMDNfMDAxL3BkZlxyXG4gKiBjb25zdCByZXNwb25zZSA9IGF3YWl0IGhhbmRsZXIoe1xyXG4gKiAgIHBhdGhQYXJhbWV0ZXJzOiB7IGRpc2Nsb3N1cmVfaWQ6ICcyMDI0MDExNV83MjAzXzAwMScgfSxcclxuICogICBxdWVyeVN0cmluZ1BhcmFtZXRlcnM6IHsgZXhwaXJhdGlvbjogJzM2MDAnIH0sXHJcbiAqICAgaGVhZGVyczogeyAneC1hcGkta2V5JzogJ3lvdXItYXBpLWtleScgfSxcclxuICogfSwgY29udGV4dCk7XHJcbiAqIGBgYFxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhhbmRsZXIoXHJcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50LFxyXG4gIGNvbnRleHQ6IENvbnRleHRcclxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcclxuICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xyXG5cclxuICB0cnkge1xyXG4gICAgbG9nZ2VyLmluZm8oJ0xhbWJkYSBQREYgRG93bmxvYWQgc3RhcnRlZCcsIHtcclxuICAgICAgcmVxdWVzdF9pZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXHJcbiAgICAgIGZ1bmN0aW9uX25hbWU6IGNvbnRleHQuZnVuY3Rpb25OYW1lLFxyXG4gICAgICBkaXNjbG9zdXJlX2lkOiBldmVudC5wYXRoUGFyYW1ldGVycz8uZGlzY2xvc3VyZV9pZCxcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIEFQSeOCreODvOiqjeiovFxyXG4gICAgdmFsaWRhdGVBcGlLZXkoZXZlbnQpO1xyXG5cclxuICAgIC8vIGRpc2Nsb3N1cmVfaWTjga7lj5blvpfjgajjg5Djg6rjg4fjg7zjgrfjg6fjg7NcclxuICAgIGNvbnN0IGRpc2Nsb3N1cmVJZCA9IHZhbGlkYXRlRGlzY2xvc3VyZUlkKGV2ZW50KTtcclxuXHJcbiAgICAvLyBleHBpcmF0aW9u44OR44Op44Oh44O844K/44Gu5Y+W5b6X44Go44OQ44Oq44OH44O844K344On44OzXHJcbiAgICBjb25zdCBleHBpcmF0aW9uID0gdmFsaWRhdGVFeHBpcmF0aW9uKGV2ZW50KTtcclxuXHJcbiAgICAvLyBEeW5hbW9EQuOBi+OCiemWi+ekuuaDheWgseOCkuWPluW+l1xyXG4gICAgY29uc3QgZGlzY2xvc3VyZSA9IGF3YWl0IGdldERpc2Nsb3N1cmUoZGlzY2xvc3VyZUlkKTtcclxuXHJcbiAgICAvLyBTM+OCreODvOOBruaknOiovFxyXG4gICAgaWYgKCFkaXNjbG9zdXJlLnBkZl9zM19rZXkpIHtcclxuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoYFBERiBmaWxlIG5vdCBmb3VuZCBmb3IgZGlzY2xvc3VyZTogJHtkaXNjbG9zdXJlSWR9YCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUzPjgqrjg5bjgrjjgqfjgq/jg4jjga7lrZjlnKjnorroqo1cclxuICAgIGF3YWl0IHZlcmlmeVMzT2JqZWN0RXhpc3RzKGRpc2Nsb3N1cmUucGRmX3MzX2tleSk7XHJcblxyXG4gICAgLy8g572y5ZCN5LuY44GNVVJM44KS55Sf5oiQXHJcbiAgICBjb25zdCBzaWduZWRVcmwgPSBhd2FpdCBnZW5lcmF0ZVNpZ25lZFVybChkaXNjbG9zdXJlLnBkZl9zM19rZXksIGV4cGlyYXRpb24pO1xyXG5cclxuICAgIC8vIOacieWKueacn+mZkOOCkuioiOeul1xyXG4gICAgY29uc3QgZXhwaXJlc0F0ID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIGV4cGlyYXRpb24gKiAxMDAwKS50b0lTT1N0cmluZygpO1xyXG5cclxuICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcclxuXHJcbiAgICBsb2dnZXIuaW5mbygnTGFtYmRhIFBERiBEb3dubG9hZCBjb21wbGV0ZWQnLCB7XHJcbiAgICAgIGRpc2Nsb3N1cmVfaWQ6IGRpc2Nsb3N1cmVJZCxcclxuICAgICAgczNfa2V5OiBkaXNjbG9zdXJlLnBkZl9zM19rZXksXHJcbiAgICAgIGV4cGlyYXRpb24sXHJcbiAgICAgIGR1cmF0aW9uX21zOiBkdXJhdGlvbixcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOaIkOWKn+ODoeODiOODquOCr+OCuemAgeS/oVxyXG4gICAgYXdhaXQgc2VuZE1ldHJpY3MoW1xyXG4gICAgICB7XHJcbiAgICAgICAgbmFtZTogJ0xhbWJkYUV4ZWN1dGlvblRpbWUnLFxyXG4gICAgICAgIHZhbHVlOiBkdXJhdGlvbixcclxuICAgICAgICB1bml0OiAnTWlsbGlzZWNvbmRzJyxcclxuICAgICAgICBkaW1lbnNpb25zOiB7IEZ1bmN0aW9uTmFtZTogJ1BERkRvd25sb2FkJyB9LFxyXG4gICAgICB9LFxyXG4gICAgICB7XHJcbiAgICAgICAgbmFtZTogJ1BERkRvd25sb2FkUmVxdWVzdHMnLFxyXG4gICAgICAgIHZhbHVlOiAxLFxyXG4gICAgICAgIHVuaXQ6ICdDb3VudCcsXHJcbiAgICAgICAgZGltZW5zaW9uczogeyBTdGF0dXM6ICdTdWNjZXNzJyB9LFxyXG4gICAgICB9LFxyXG4gICAgXSk7XHJcblxyXG4gICAgLy8g44Os44K544Od44Oz44K5XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXHJcbiAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXHJcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLFgtQXBpLUtleScsXHJcbiAgICAgIH0sXHJcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICBzdGF0dXM6ICdzdWNjZXNzJyxcclxuICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICBkb3dubG9hZF91cmw6IHNpZ25lZFVybCxcclxuICAgICAgICAgIGV4cGlyZXNfYXQ6IGV4cGlyZXNBdCxcclxuICAgICAgICB9LFxyXG4gICAgICB9KSxcclxuICAgIH07XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcclxuXHJcbiAgICBsb2dnZXIuZXJyb3IoXHJcbiAgICAgICdMYW1iZGEgUERGIERvd25sb2FkIGZhaWxlZCcsXHJcbiAgICAgIGNyZWF0ZUVycm9yQ29udGV4dChlcnJvciBhcyBFcnJvciwge1xyXG4gICAgICAgIHJlcXVlc3RfaWQ6IGNvbnRleHQuYXdzUmVxdWVzdElkLFxyXG4gICAgICAgIGRpc2Nsb3N1cmVfaWQ6IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5kaXNjbG9zdXJlX2lkLFxyXG4gICAgICAgIGR1cmF0aW9uX21zOiBkdXJhdGlvbixcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gICAgLy8g44Ko44Op44O844Oh44OI44Oq44Kv44K56YCB5L+hXHJcbiAgICBhd2FpdCBzZW5kRXJyb3JNZXRyaWMoXHJcbiAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5jb25zdHJ1Y3Rvci5uYW1lIDogJ1Vua25vd24nLFxyXG4gICAgICAnUERGRG93bmxvYWQnXHJcbiAgICApO1xyXG5cclxuICAgIC8vIOOCqOODqeODvOODrOOCueODneODs+OCuVxyXG4gICAgcmV0dXJuIGhhbmRsZUVycm9yKGVycm9yIGFzIEVycm9yLCBjb250ZXh0LmF3c1JlcXVlc3RJZCk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogQVBJ44Kt44O86KqN6Ki8XHJcbiAqXHJcbiAqIEBwYXJhbSBldmVudCBBUElHYXRld2F5UHJveHlFdmVudFxyXG4gKiBAdGhyb3dzIEF1dGhlbnRpY2F0aW9uRXJyb3IgQVBJ44Kt44O844GM54Sh5Yq544Gq5aC05ZCIXHJcbiAqL1xyXG5mdW5jdGlvbiB2YWxpZGF0ZUFwaUtleShldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiB2b2lkIHtcclxuICBjb25zdCBhcGlLZXkgPSBldmVudC5oZWFkZXJzPy5bJ3gtYXBpLWtleSddIHx8IGV2ZW50LmhlYWRlcnM/LlsnWC1BcGktS2V5J107XHJcblxyXG4gIGlmICghYXBpS2V5KSB7XHJcbiAgICB0aHJvdyBuZXcgQXV0aGVudGljYXRpb25FcnJvcignQVBJIGtleSBpcyByZXF1aXJlZCcpO1xyXG4gIH1cclxuXHJcbiAgLy8g55Kw5aKD5aSJ5pWw44GL44KJ55u05o6l6Kqt44G/5Y+W44KL77yI44OG44K544OI55Kw5aKD44Gn44Gu5YuV55qE6Kit5a6a44Gr5a++5b+c77yJXHJcbiAgY29uc3QgZXhwZWN0ZWRBcGlLZXkgPSBwcm9jZXNzLmVudi5BUElfS0VZO1xyXG4gIGlmIChleHBlY3RlZEFwaUtleSAmJiBhcGlLZXkgIT09IGV4cGVjdGVkQXBpS2V5KSB7XHJcbiAgICB0aHJvdyBuZXcgQXV0aGVudGljYXRpb25FcnJvcignSW52YWxpZCBBUEkga2V5Jyk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogZGlzY2xvc3VyZV9pZOOBruODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gKlxyXG4gKiBAcGFyYW0gZXZlbnQgQVBJR2F0ZXdheVByb3h5RXZlbnRcclxuICogQHJldHVybnMgZGlzY2xvc3VyZV9pZFxyXG4gKiBAdGhyb3dzIFZhbGlkYXRpb25FcnJvciBkaXNjbG9zdXJlX2lk44GM54Sh5Yq544Gq5aC05ZCIXHJcbiAqL1xyXG5mdW5jdGlvbiB2YWxpZGF0ZURpc2Nsb3N1cmVJZChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBzdHJpbmcge1xyXG4gIGNvbnN0IGRpc2Nsb3N1cmVJZCA9IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5kaXNjbG9zdXJlX2lkO1xyXG5cclxuICBpZiAoIWRpc2Nsb3N1cmVJZCkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignZGlzY2xvc3VyZV9pZCBpcyByZXF1aXJlZCcpO1xyXG4gIH1cclxuXHJcbiAgLy8gZGlzY2xvc3VyZV9pZOOBruODleOCqeODvOODnuODg+ODiOaknOiovO+8iOS+izogMjAyNDAxMTVfNzIwM18wMDHvvIlcclxuICBpZiAoIS9eXFxkezh9X1xcZHs0fV9cXGR7M30kLy50ZXN0KGRpc2Nsb3N1cmVJZCkpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgIGBJbnZhbGlkIGRpc2Nsb3N1cmVfaWQgZm9ybWF0OiAke2Rpc2Nsb3N1cmVJZH0uIEV4cGVjdGVkIGZvcm1hdDogWVlZWU1NRERfQ0NDQ19OTk5gXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGRpc2Nsb3N1cmVJZDtcclxufVxyXG5cclxuLyoqXHJcbiAqIGV4cGlyYXRpb27jg5Hjg6njg6Hjg7zjgr/jga7jg5Djg6rjg4fjg7zjgrfjg6fjg7NcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEFQSUdhdGV3YXlQcm94eUV2ZW50XHJcbiAqIEByZXR1cm5zIGV4cGlyYXRpb27vvIjnp5LvvIlcclxuICogQHRocm93cyBWYWxpZGF0aW9uRXJyb3IgZXhwaXJhdGlvbuOBjOeEoeWKueOBquWgtOWQiFxyXG4gKi9cclxuZnVuY3Rpb24gdmFsaWRhdGVFeHBpcmF0aW9uKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IG51bWJlciB7XHJcbiAgY29uc3QgZXhwaXJhdGlvblBhcmFtID0gZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzPy5leHBpcmF0aW9uO1xyXG5cclxuICBpZiAoIWV4cGlyYXRpb25QYXJhbSkge1xyXG4gICAgcmV0dXJuIERFRkFVTFRfRVhQSVJBVElPTjtcclxuICB9XHJcblxyXG4gIGNvbnN0IGV4cGlyYXRpb24gPSBwYXJzZUludChleHBpcmF0aW9uUGFyYW0sIDEwKTtcclxuXHJcbiAgaWYgKGlzTmFOKGV4cGlyYXRpb24pKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCBleHBpcmF0aW9uIGZvcm1hdDogJHtleHBpcmF0aW9uUGFyYW19LiBFeHBlY3RlZCBpbnRlZ2VyLmBcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBpZiAoZXhwaXJhdGlvbiA8IE1JTl9FWFBJUkFUSU9OIHx8IGV4cGlyYXRpb24gPiBNQVhfRVhQSVJBVElPTikge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEV4cGlyYXRpb24gb3V0IG9mIHJhbmdlOiAke2V4cGlyYXRpb259LiBNdXN0IGJlIGJldHdlZW4gJHtNSU5fRVhQSVJBVElPTn0gYW5kICR7TUFYX0VYUElSQVRJT059IHNlY29uZHMuYFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBleHBpcmF0aW9uO1xyXG59XHJcblxyXG4vKipcclxuICogRHluYW1vRELjgYvjgonplovnpLrmg4XloLHjgpLlj5blvpdcclxuICpcclxuICogQHBhcmFtIGRpc2Nsb3N1cmVJZCDplovnpLpJRFxyXG4gKiBAcmV0dXJucyDplovnpLrmg4XloLFcclxuICogQHRocm93cyBOb3RGb3VuZEVycm9yIOmWi+ekuuaDheWgseOBjOimi+OBpOOBi+OCieOBquOBhOWgtOWQiFxyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gZ2V0RGlzY2xvc3VyZShkaXNjbG9zdXJlSWQ6IHN0cmluZyk6IFByb21pc2U8RGlzY2xvc3VyZT4ge1xyXG4gIGxvZ2dlci5pbmZvKCdGZXRjaGluZyBkaXNjbG9zdXJlIGZyb20gRHluYW1vREInLCB7XHJcbiAgICBkaXNjbG9zdXJlX2lkOiBkaXNjbG9zdXJlSWQsXHJcbiAgICB0YWJsZTogRElTQ0xPU1VSRVNfVEFCTEUsXHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJldHJ5V2l0aEJhY2tvZmYoXHJcbiAgICBhc3luYyAoKSA9PiB7XHJcbiAgICAgIHJldHVybiBhd2FpdCBkeW5hbW9DbGllbnQuc2VuZChcclxuICAgICAgICBuZXcgR2V0SXRlbUNvbW1hbmQoe1xyXG4gICAgICAgICAgVGFibGVOYW1lOiBESVNDTE9TVVJFU19UQUJMRSxcclxuICAgICAgICAgIEtleToge1xyXG4gICAgICAgICAgICBkaXNjbG9zdXJlX2lkOiB7IFM6IGRpc2Nsb3N1cmVJZCB9LFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9KVxyXG4gICAgICApO1xyXG4gICAgfSxcclxuICAgIHtcclxuICAgICAgbWF4UmV0cmllczogMyxcclxuICAgICAgaW5pdGlhbERlbGF5OiAxMDAwLFxyXG4gICAgICBiYWNrb2ZmTXVsdGlwbGllcjogMixcclxuICAgICAgaml0dGVyOiB0cnVlLFxyXG4gICAgICBzaG91bGRSZXRyeTogKGVycm9yKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGVycm9yLm5hbWUgPT09ICdQcm92aXNpb25lZFRocm91Z2hwdXRFeGNlZWRlZEV4Y2VwdGlvbic7XHJcbiAgICAgIH0sXHJcbiAgICB9XHJcbiAgKTtcclxuXHJcbiAgaWYgKCFyZXN1bHQuSXRlbSkge1xyXG4gICAgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoYERpc2Nsb3N1cmUgbm90IGZvdW5kOiAke2Rpc2Nsb3N1cmVJZH1gKTtcclxuICB9XHJcblxyXG4gIC8vIER5bmFtb0RC44Ki44Kk44OG44Og44KSRGlzY2xvc3VyZeOBq+WkieaPm1xyXG4gIGNvbnN0IGl0ZW0gPSByZXN1bHQuSXRlbTtcclxuXHJcbiAgY29uc3QgZGlzY2xvc3VyZTogRGlzY2xvc3VyZSA9IHtcclxuICAgIGRpc2Nsb3N1cmVfaWQ6IGl0ZW0uZGlzY2xvc3VyZV9pZC5TISxcclxuICAgIGNvbXBhbnlfY29kZTogaXRlbS5jb21wYW55X2NvZGUuUyEsXHJcbiAgICBjb21wYW55X25hbWU6IGl0ZW0uY29tcGFueV9uYW1lLlMhLFxyXG4gICAgcGRmX3MzX2tleTogaXRlbS5wZGZfczNfa2V5Py5TIHx8IG51bGwsXHJcbiAgfTtcclxuXHJcbiAgbG9nZ2VyLmluZm8oJ0Rpc2Nsb3N1cmUgZmV0Y2hlZCBzdWNjZXNzZnVsbHknLCB7XHJcbiAgICBkaXNjbG9zdXJlX2lkOiBkaXNjbG9zdXJlSWQsXHJcbiAgICBwZGZfczNfa2V5OiBkaXNjbG9zdXJlLnBkZl9zM19rZXksXHJcbiAgfSk7XHJcblxyXG4gIHJldHVybiBkaXNjbG9zdXJlO1xyXG59XHJcblxyXG4vKipcclxuICogUzPjgqrjg5bjgrjjgqfjgq/jg4jjga7lrZjlnKjnorroqo1cclxuICpcclxuICogQHBhcmFtIHMzS2V5IFMz44Kt44O8XHJcbiAqIEB0aHJvd3MgTm90Rm91bmRFcnJvciBTM+OCquODluOCuOOCp+OCr+ODiOOBjOWtmOWcqOOBl+OBquOBhOWgtOWQiFxyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gdmVyaWZ5UzNPYmplY3RFeGlzdHMoczNLZXk6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gIGxvZ2dlci5pbmZvKCdWZXJpZnlpbmcgUzMgb2JqZWN0IGV4aXN0cycsIHtcclxuICAgIHMzX2tleTogczNLZXksXHJcbiAgICBidWNrZXQ6IFBERl9CVUNLRVQsXHJcbiAgfSk7XHJcblxyXG4gIHRyeSB7XHJcbiAgICBhd2FpdCByZXRyeVdpdGhCYWNrb2ZmKFxyXG4gICAgICBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgYXdhaXQgczNDbGllbnQuc2VuZChcclxuICAgICAgICAgIG5ldyBIZWFkT2JqZWN0Q29tbWFuZCh7XHJcbiAgICAgICAgICAgIEJ1Y2tldDogUERGX0JVQ0tFVCxcclxuICAgICAgICAgICAgS2V5OiBzM0tleSxcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuICAgICAgfSxcclxuICAgICAge1xyXG4gICAgICAgIG1heFJldHJpZXM6IDMsXHJcbiAgICAgICAgaW5pdGlhbERlbGF5OiAxMDAwLFxyXG4gICAgICAgIGJhY2tvZmZNdWx0aXBsaWVyOiAyLFxyXG4gICAgICAgIGppdHRlcjogdHJ1ZSxcclxuICAgICAgICBzaG91bGRSZXRyeTogKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICAvLyA0MDTjgqjjg6njg7zjga/lho3oqabooYzjgZfjgarjgYRcclxuICAgICAgICAgIGlmIChlcnJvci5uYW1lID09PSAnTm90Rm91bmQnIHx8IGVycm9yLiRtZXRhZGF0YT8uaHR0cFN0YXR1c0NvZGUgPT09IDQwNCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyDjgZ3jga7ku5bjga7jgqjjg6njg7zjga/lho3oqabooYxcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0sXHJcbiAgICAgIH1cclxuICAgICk7XHJcblxyXG4gICAgbG9nZ2VyLmluZm8oJ1MzIG9iamVjdCBleGlzdHMnLCB7IHMzX2tleTogczNLZXkgfSk7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGlmICgoZXJyb3IgYXMgYW55KS5uYW1lID09PSAnTm90Rm91bmQnIHx8IChlcnJvciBhcyBhbnkpLiRtZXRhZGF0YT8uaHR0cFN0YXR1c0NvZGUgPT09IDQwNCkge1xyXG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFcnJvcihgUERGIGZpbGUgbm90IGZvdW5kIGluIFMzOiAke3MzS2V5fWApO1xyXG4gICAgfVxyXG4gICAgdGhyb3cgZXJyb3I7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog572y5ZCN5LuY44GNVVJM44KS55Sf5oiQXHJcbiAqXHJcbiAqIEBwYXJhbSBzM0tleSBTM+OCreODvFxyXG4gKiBAcGFyYW0gZXhwaXJlc0luIOacieWKueacn+mZkO+8iOenku+8iVxyXG4gKiBAcmV0dXJucyDnvbLlkI3ku5jjgY1VUkxcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlU2lnbmVkVXJsKHMzS2V5OiBzdHJpbmcsIGV4cGlyZXNJbjogbnVtYmVyKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICBsb2dnZXIuaW5mbygnR2VuZXJhdGluZyBzaWduZWQgVVJMJywge1xyXG4gICAgczNfa2V5OiBzM0tleSxcclxuICAgIGJ1Y2tldDogUERGX0JVQ0tFVCxcclxuICAgIGV4cGlyZXNfaW46IGV4cGlyZXNJbixcclxuICB9KTtcclxuXHJcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRPYmplY3RDb21tYW5kKHtcclxuICAgIEJ1Y2tldDogUERGX0JVQ0tFVCxcclxuICAgIEtleTogczNLZXksXHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IHNpZ25lZFVybCA9IGF3YWl0IGdldFNpZ25lZFVybChzM0NsaWVudCwgY29tbWFuZCwgeyBleHBpcmVzSW4gfSk7XHJcblxyXG4gIGxvZ2dlci5pbmZvKCdTaWduZWQgVVJMIGdlbmVyYXRlZCBzdWNjZXNzZnVsbHknLCB7XHJcbiAgICBzM19rZXk6IHMzS2V5LFxyXG4gICAgdXJsX2xlbmd0aDogc2lnbmVkVXJsLmxlbmd0aCxcclxuICB9KTtcclxuXHJcbiAgcmV0dXJuIHNpZ25lZFVybDtcclxufVxyXG5cclxuLyoqXHJcbiAqIOOCqOODqeODvOODj+ODs+ODieODquODs+OCsFxyXG4gKlxyXG4gKiBAcGFyYW0gZXJyb3Ig44Ko44Op44O844Kq44OW44K444Kn44Kv44OIXHJcbiAqIEBwYXJhbSByZXF1ZXN0SWQg44Oq44Kv44Ko44K544OISURcclxuICogQHJldHVybnMgQVBJR2F0ZXdheVByb3h5UmVzdWx0XHJcbiAqL1xyXG5mdW5jdGlvbiBoYW5kbGVFcnJvcihlcnJvcjogRXJyb3IsIHJlcXVlc3RJZDogc3RyaW5nKTogQVBJR2F0ZXdheVByb3h5UmVzdWx0IHtcclxuICAvLyDjgqjjg6njg7znqK7liKXjgavlv5zjgZjjgZ/jgrnjg4bjg7zjgr/jgrnjgrPjg7zjg4njgajjgqjjg6njg7zjgrPjg7zjg4lcclxuICBsZXQgc3RhdHVzQ29kZSA9IDUwMDtcclxuICBsZXQgZXJyb3JDb2RlID0gJ0lOVEVSTkFMX0VSUk9SJztcclxuXHJcbiAgaWYgKGVycm9yIGluc3RhbmNlb2YgVmFsaWRhdGlvbkVycm9yKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDAwO1xyXG4gICAgZXJyb3JDb2RlID0gJ1ZBTElEQVRJT05fRVJST1InO1xyXG4gIH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBBdXRoZW50aWNhdGlvbkVycm9yKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDAxO1xyXG4gICAgZXJyb3JDb2RlID0gJ1VOQVVUSE9SSVpFRCc7XHJcbiAgfSBlbHNlIGlmIChlcnJvciBpbnN0YW5jZW9mIE5vdEZvdW5kRXJyb3IpIHtcclxuICAgIHN0YXR1c0NvZGUgPSA0MDQ7XHJcbiAgICBlcnJvckNvZGUgPSAnTk9UX0ZPVU5EJztcclxuICB9XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBzdGF0dXNDb2RlLFxyXG4gICAgaGVhZGVyczoge1xyXG4gICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxyXG4gICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6ICdDb250ZW50LVR5cGUsWC1BcGktS2V5JyxcclxuICAgIH0sXHJcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgIHN0YXR1czogJ2Vycm9yJyxcclxuICAgICAgZXJyb3I6IHtcclxuICAgICAgICBjb2RlOiBlcnJvckNvZGUsXHJcbiAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcclxuICAgICAgICBkZXRhaWxzOiAoZXJyb3IgYXMgYW55KS5kZXRhaWxzIHx8IHt9LFxyXG4gICAgICB9LFxyXG4gICAgICByZXF1ZXN0X2lkOiByZXF1ZXN0SWQsXHJcbiAgICB9KSxcclxuICB9O1xyXG59XHJcblxyXG4vKipcclxuICog6ZaL56S65oOF5aCx44Gu5Z6L5a6a576p77yI5pyA5bCP6ZmQ77yJXHJcbiAqL1xyXG5pbnRlcmZhY2UgRGlzY2xvc3VyZSB7XHJcbiAgZGlzY2xvc3VyZV9pZDogc3RyaW5nO1xyXG4gIGNvbXBhbnlfY29kZTogc3RyaW5nO1xyXG4gIGNvbXBhbnlfbmFtZTogc3RyaW5nO1xyXG4gIHBkZl9zM19rZXk6IHN0cmluZyB8IG51bGw7XHJcbn1cclxuIl0sInZlcnNpb24iOjN9