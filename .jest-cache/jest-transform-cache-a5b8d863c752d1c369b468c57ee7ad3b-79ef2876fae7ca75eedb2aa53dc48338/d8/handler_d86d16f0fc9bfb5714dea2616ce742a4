956b416a568c75e4857d53411ffa5e51
"use strict";
/**
 * Lambda Export Status Handler
 *
 * GET /exports/{export_id} エンドポイント
 * エクスポート状態をDynamoDBから取得して返却します。
 *
 * Requirements: タスク13.5
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const logger_1 = require("../../../utils/logger");
const cloudwatch_metrics_1 = require("../../../utils/cloudwatch-metrics");
const errors_1 = require("../../../errors");
const retry_1 = require("../../../utils/retry");
// クライアント（グローバルスコープで初期化）
const dynamoClient = new client_dynamodb_1.DynamoDBClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });
const secretsClient = new client_secrets_manager_1.SecretsManagerClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });
// 環境変数
const EXPORT_STATUS_TABLE = process.env.EXPORT_STATUS_TABLE_NAME || 'tdnet_export_status';
// APIキーキャッシュ（5分TTL）
let cachedApiKey = null;
let cacheExpiry = 0;
/**
 * Secrets ManagerからAPIキーを取得
 *
 * テスト環境（TEST_ENV=e2e）では、API_KEY環境変数から直接取得します。
 * 本番環境では、Secrets Managerから取得します。
 *
 * @returns APIキー
 * @throws Error Secrets Managerからの取得に失敗した場合
 */
async function getApiKey() {
    // キャッシュチェック
    if (cachedApiKey && Date.now() < cacheExpiry) {
        return cachedApiKey;
    }
    // テスト環境: API_KEY環境変数から直接取得
    if (process.env.TEST_ENV === 'e2e' && process.env.API_KEY) {
        cachedApiKey = process.env.API_KEY;
        cacheExpiry = Date.now() + 5 * 60 * 1000;
        return cachedApiKey;
    }
    // 本番環境: Secrets Managerから取得
    const secretArn = process.env.API_KEY_SECRET_ARN;
    if (!secretArn) {
        throw new Error('API_KEY_SECRET_ARN environment variable is not set');
    }
    try {
        const command = new client_secrets_manager_1.GetSecretValueCommand({ SecretId: secretArn });
        const response = await secretsClient.send(command);
        if (!response.SecretString) {
            throw new Error('Secret value is empty');
        }
        // APIキーをキャッシュ（5分TTL）
        cachedApiKey = response.SecretString;
        cacheExpiry = Date.now() + 5 * 60 * 1000;
        return cachedApiKey;
    }
    catch (error) {
        logger_1.logger.error('Failed to retrieve API key from Secrets Manager', {
            error: error instanceof Error ? error.message : String(error),
            secret_arn: secretArn,
        });
        throw new Error('Failed to retrieve API key');
    }
}
/**
 * Lambda Export Status Handler
 *
 * @param event APIGatewayProxyEvent
 * @param context Lambda Context
 * @returns APIGatewayProxyResult
 *
 * @example
 * ```typescript
 * // GET /exports/export-20240115-xyz789
 * const response = await handler({
 *   pathParameters: { export_id: 'export-20240115-xyz789' },
 *   headers: { 'x-api-key': 'your-api-key' },
 * }, context);
 * ```
 */
async function handler(event, context) {
    const startTime = Date.now();
    try {
        logger_1.logger.info('Lambda Export Status started', {
            request_id: context.awsRequestId,
            function_name: context.functionName,
            export_id: event.pathParameters?.export_id,
        });
        // APIキー認証
        await validateApiKey(event);
        // export_idの取得とバリデーション
        const exportId = validateExportId(event);
        // DynamoDBからエクスポート状態を取得
        const exportStatus = await getExportStatus(exportId);
        const duration = Date.now() - startTime;
        logger_1.logger.info('Lambda Export Status completed', {
            export_id: exportId,
            status: exportStatus.status,
            duration_ms: duration,
        });
        // 成功メトリクス送信
        await (0, cloudwatch_metrics_1.sendMetrics)([
            {
                name: 'LambdaExecutionTime',
                value: duration,
                unit: 'Milliseconds',
                dimensions: { FunctionName: 'ExportStatus' },
            },
            {
                name: 'ExportStatusQueries',
                value: 1,
                unit: 'Count',
                dimensions: { Status: exportStatus.status },
            },
        ]);
        // レスポンス
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Headers': 'Content-Type,X-Api-Key',
            },
            body: JSON.stringify({
                status: 'success',
                data: exportStatus,
            }),
        };
    }
    catch (error) {
        const duration = Date.now() - startTime;
        logger_1.logger.error('Lambda Export Status failed', (0, logger_1.createErrorContext)(error, {
            request_id: context.awsRequestId,
            export_id: event.pathParameters?.export_id,
            duration_ms: duration,
        }));
        // エラーメトリクス送信
        await (0, cloudwatch_metrics_1.sendErrorMetric)(error instanceof Error ? error.constructor.name : 'Unknown', 'ExportStatus');
        // エラーレスポンス
        return handleError(error, context.awsRequestId);
    }
}
/**
 * APIキー認証
 *
 * @param event APIGatewayProxyEvent
 * @throws AuthenticationError APIキーが無効な場合
 */
async function validateApiKey(event) {
    const apiKey = event.headers?.['x-api-key'] || event.headers?.['X-Api-Key'];
    if (!apiKey) {
        throw new errors_1.AuthenticationError('API key is required');
    }
    // Secrets ManagerからAPIキーを取得
    const validApiKey = await getApiKey();
    if (apiKey !== validApiKey) {
        throw new errors_1.AuthenticationError('Invalid API key');
    }
}
/**
 * export_idのバリデーション
 *
 * @param event APIGatewayProxyEvent
 * @returns export_id
 * @throws ValidationError export_idが無効な場合
 */
function validateExportId(event) {
    const exportId = event.pathParameters?.export_id;
    if (!exportId) {
        throw new errors_1.ValidationError('export_id is required');
    }
    // export_idのフォーマット検証（例: export-20240115-xyz789）
    if (!/^export-\d{8}-[a-z0-9]+$/.test(exportId)) {
        throw new errors_1.ValidationError(`Invalid export_id format: ${exportId}. Expected format: export-YYYYMMDD-{id}`);
    }
    return exportId;
}
/**
 * DynamoDBからエクスポート状態を取得
 *
 * @param exportId エクスポートID
 * @returns エクスポート状態
 * @throws NotFoundError エクスポートが見つからない場合
 */
async function getExportStatus(exportId) {
    logger_1.logger.info('Fetching export status from DynamoDB', {
        export_id: exportId,
        table: EXPORT_STATUS_TABLE,
    });
    const result = await (0, retry_1.retryWithBackoff)(async () => {
        return await dynamoClient.send(new client_dynamodb_1.GetItemCommand({
            TableName: EXPORT_STATUS_TABLE,
            Key: {
                export_id: { S: exportId },
            },
        }));
    }, {
        maxRetries: 3,
        initialDelay: 1000,
        backoffMultiplier: 2,
        jitter: true,
        shouldRetry: (error) => {
            return error.name === 'ProvisionedThroughputExceededException';
        },
    });
    if (!result.Item) {
        throw new errors_1.NotFoundError(`Export not found: ${exportId}`);
    }
    // DynamoDBアイテムをExportStatusに変換
    const item = result.Item;
    const exportStatus = {
        export_id: item.export_id.S,
        status: item.status.S,
        progress: parseInt(item.progress.N, 10),
        requested_at: item.requested_at.S,
        completed_at: item.completed_at?.S || null,
        export_count: item.export_count?.N ? parseInt(item.export_count.N, 10) : null,
        file_size: item.file_size?.N ? parseInt(item.file_size.N, 10) : null,
        download_url: item.download_url?.S || null,
        expires_at: item.expires_at?.S || null,
        error_message: item.error_message?.S || null,
    };
    logger_1.logger.info('Export status fetched successfully', {
        export_id: exportId,
        status: exportStatus.status,
        progress: exportStatus.progress,
    });
    return exportStatus;
}
/**
 * エラーハンドリング
 *
 * @param error エラーオブジェクト
 * @param requestId リクエストID
 * @returns APIGatewayProxyResult
 */
function handleError(error, requestId) {
    // エラー種別に応じたステータスコードとエラーコード
    let statusCode = 500;
    let errorCode = 'INTERNAL_ERROR';
    if (error instanceof errors_1.ValidationError) {
        statusCode = 400;
        errorCode = 'VALIDATION_ERROR';
    }
    else if (error instanceof errors_1.AuthenticationError) {
        statusCode = 401;
        errorCode = 'UNAUTHORIZED';
    }
    else if (error instanceof errors_1.NotFoundError) {
        statusCode = 404;
        errorCode = 'NOT_FOUND';
    }
    return {
        statusCode,
        headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Headers': 'Content-Type,X-Api-Key',
        },
        body: JSON.stringify({
            status: 'error',
            error: {
                code: errorCode,
                message: error.message,
                details: error.details || {},
            },
            request_id: requestId,
        }),
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGFwaVxcZXhwb3J0LXN0YXR1c1xcaGFuZGxlci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7R0FPRzs7QUF1RkgsMEJBZ0ZDO0FBcEtELDhEQUEwRTtBQUMxRSw0RUFBOEY7QUFDOUYsa0RBQW1FO0FBQ25FLDBFQUFpRjtBQUNqRiw0Q0FBc0Y7QUFDdEYsZ0RBQXdEO0FBRXhELHdCQUF3QjtBQUN4QixNQUFNLFlBQVksR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO0FBQ2hHLE1BQU0sYUFBYSxHQUFHLElBQUksNkNBQW9CLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO0FBRXZHLE9BQU87QUFDUCxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLElBQUkscUJBQXFCLENBQUM7QUFFMUYsb0JBQW9CO0FBQ3BCLElBQUksWUFBWSxHQUFrQixJQUFJLENBQUM7QUFDdkMsSUFBSSxXQUFXLEdBQVcsQ0FBQyxDQUFDO0FBRTVCOzs7Ozs7OztHQVFHO0FBQ0gsS0FBSyxVQUFVLFNBQVM7SUFDdEIsWUFBWTtJQUNaLElBQUksWUFBWSxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxXQUFXLEVBQUUsQ0FBQztRQUM3QyxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO0lBRUQsMkJBQTJCO0lBQzNCLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssS0FBSyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDMUQsWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO1FBQ25DLFdBQVcsR0FBRyxJQUFJ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RSxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQ25CLE1BQU0sRUFBRSxPQUFPO1lBQ2YsS0FBSyxFQUFFO2dCQUNMLElBQUksRUFBRSxTQUFTO2dCQUNmLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTztnQkFDdEIsT0FBTyxFQUFHLEtBQWEsQ0FBQyxPQUFPLElBQUksRUFBRTthQUN0QztZQUNELFVBQVUsRUFBRSxTQUFTO1NBQ3RCLENBQUM7S0FDSCxDQUFDO0FBQ0osQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpMTk4XFxpbnZlc3RtZW50X2FuYWx5c2lzX29wb3BvXFxzcmNcXGxhbWJkYVxcYXBpXFxleHBvcnQtc3RhdHVzXFxoYW5kbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBMYW1iZGEgRXhwb3J0IFN0YXR1cyBIYW5kbGVyXHJcbiAqXHJcbiAqIEdFVCAvZXhwb3J0cy97ZXhwb3J0X2lkfSDjgqjjg7Pjg4njg53jgqTjg7Pjg4hcclxuICog44Ko44Kv44K544Od44O844OI54q25oWL44KSRHluYW1vRELjgYvjgonlj5blvpfjgZfjgabov5TljbTjgZfjgb7jgZnjgIJcclxuICpcclxuICogUmVxdWlyZW1lbnRzOiDjgr/jgrnjgq8xMy41XHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCwgQ29udGV4dCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xyXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCwgR2V0SXRlbUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xyXG5pbXBvcnQgeyBTZWNyZXRzTWFuYWdlckNsaWVudCwgR2V0U2VjcmV0VmFsdWVDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXNlY3JldHMtbWFuYWdlcic7XHJcbmltcG9ydCB7IGxvZ2dlciwgY3JlYXRlRXJyb3JDb250ZXh0IH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvbG9nZ2VyJztcclxuaW1wb3J0IHsgc2VuZEVycm9yTWV0cmljLCBzZW5kTWV0cmljcyB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL2Nsb3Vkd2F0Y2gtbWV0cmljcyc7XHJcbmltcG9ydCB7IFZhbGlkYXRpb25FcnJvciwgTm90Rm91bmRFcnJvciwgQXV0aGVudGljYXRpb25FcnJvciB9IGZyb20gJy4uLy4uLy4uL2Vycm9ycyc7XHJcbmltcG9ydCB7IHJldHJ5V2l0aEJhY2tvZmYgfSBmcm9tICcuLi8uLi8uLi91dGlscy9yZXRyeSc7XHJcblxyXG4vLyDjgq/jg6njgqTjgqLjg7Pjg4jvvIjjgrDjg63jg7zjg5Djg6vjgrnjgrPjg7zjg5fjgafliJ3mnJ/ljJbvvIlcclxuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICdhcC1ub3J0aGVhc3QtMScgfSk7XHJcbmNvbnN0IHNlY3JldHNDbGllbnQgPSBuZXcgU2VjcmV0c01hbmFnZXJDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ2FwLW5vcnRoZWFzdC0xJyB9KTtcclxuXHJcbi8vIOeSsOWig+WkieaVsFxyXG5jb25zdCBFWFBPUlRfU1RBVFVTX1RBQkxFID0gcHJvY2Vzcy5lbnYuRVhQT1JUX1NUQVRVU19UQUJMRV9OQU1FIHx8ICd0ZG5ldF9leHBvcnRfc3RhdHVzJztcclxuXHJcbi8vIEFQSeOCreODvOOCreODo+ODg+OCt+ODpe+8iDXliIZUVEzvvIlcclxubGV0IGNhY2hlZEFwaUtleTogc3RyaW5nIHwgbnVsbCA9IG51bGw7XHJcbmxldCBjYWNoZUV4cGlyeTogbnVtYmVyID0gMDtcclxuXHJcbi8qKlxyXG4gKiBTZWNyZXRzIE1hbmFnZXLjgYvjgolBUEnjgq3jg7zjgpLlj5blvpdcclxuICpcclxuICog44OG44K544OI55Kw5aKD77yIVEVTVF9FTlY9ZTJl77yJ44Gn44Gv44CBQVBJX0tFWeeSsOWig+WkieaVsOOBi+OCieebtOaOpeWPluW+l+OBl+OBvuOBmeOAglxyXG4gKiDmnKznlarnkrDlooPjgafjga/jgIFTZWNyZXRzIE1hbmFnZXLjgYvjgonlj5blvpfjgZfjgb7jgZnjgIJcclxuICpcclxuICogQHJldHVybnMgQVBJ44Kt44O8XHJcbiAqIEB0aHJvd3MgRXJyb3IgU2VjcmV0cyBNYW5hZ2Vy44GL44KJ44Gu5Y+W5b6X44Gr5aSx5pWX44GX44Gf5aC05ZCIXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBnZXRBcGlLZXkoKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAvLyDjgq3jg6Pjg4Pjgrfjg6Xjg4Hjgqfjg4Pjgq9cclxuICBpZiAoY2FjaGVkQXBpS2V5ICYmIERhdGUubm93KCkgPCBjYWNoZUV4cGlyeSkge1xyXG4gICAgcmV0dXJuIGNhY2hlZEFwaUtleTtcclxuICB9XHJcblxyXG4gIC8vIOODhuOCueODiOeSsOWigzogQVBJX0tFWeeSsOWig+WkieaVsOOBi+OCieebtOaOpeWPluW+l1xyXG4gIGlmIChwcm9jZXNzLmVudi5URVNUX0VOViA9PT0gJ2UyZScgJiYgcHJvY2Vzcy5lbnYuQVBJX0tFWSkge1xyXG4gICAgY2FjaGVkQXBpS2V5ID0gcHJvY2Vzcy5lbnYuQVBJX0tFWTtcclxuICAgIGNhY2hlRXhwaXJ5ID0gRGF0ZS5ub3coKSArIDUgKiA2MCAqIDEwMDA7XHJcbiAgICByZXR1cm4gY2FjaGVkQXBpS2V5O1xyXG4gIH1cclxuXHJcbiAgLy8g5pys55Wq55Kw5aKDOiBTZWNyZXRzIE1hbmFnZXLjgYvjgonlj5blvpdcclxuICBjb25zdCBzZWNyZXRBcm4gPSBwcm9jZXNzLmVudi5BUElfS0VZX1NFQ1JFVF9BUk47XHJcbiAgaWYgKCFzZWNyZXRBcm4pIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignQVBJX0tFWV9TRUNSRVRfQVJOIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIG5vdCBzZXQnKTtcclxuICB9XHJcblxyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldFNlY3JldFZhbHVlQ29tbWFuZCh7IFNlY3JldElkOiBzZWNyZXRBcm4gfSk7XHJcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHNlY3JldHNDbGllbnQuc2VuZChjb21tYW5kKTtcclxuXHJcbiAgICBpZiAoIXJlc3BvbnNlLlNlY3JldFN0cmluZykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NlY3JldCB2YWx1ZSBpcyBlbXB0eScpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEFQSeOCreODvOOCkuOCreODo+ODg+OCt+ODpe+8iDXliIZUVEzvvIlcclxuICAgIGNhY2hlZEFwaUtleSA9IHJlc3BvbnNlLlNlY3JldFN0cmluZztcclxuICAgIGNhY2hlRXhwaXJ5ID0gRGF0ZS5ub3coKSArIDUgKiA2MCAqIDEwMDA7XHJcblxyXG4gICAgcmV0dXJuIGNhY2hlZEFwaUtleTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gcmV0cmlldmUgQVBJIGtleSBmcm9tIFNlY3JldHMgTWFuYWdlcicsIHtcclxuICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcclxuICAgICAgc2VjcmV0X2Fybjogc2VjcmV0QXJuLFxyXG4gICAgfSk7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSBBUEkga2V5Jyk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogTGFtYmRhIEV4cG9ydCBTdGF0dXMgSGFuZGxlclxyXG4gKlxyXG4gKiBAcGFyYW0gZXZlbnQgQVBJR2F0ZXdheVByb3h5RXZlbnRcclxuICogQHBhcmFtIGNvbnRleHQgTGFtYmRhIENvbnRleHRcclxuICogQHJldHVybnMgQVBJR2F0ZXdheVByb3h5UmVzdWx0XHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYHR5cGVzY3JpcHRcclxuICogLy8gR0VUIC9leHBvcnRzL2V4cG9ydC0yMDI0MDExNS14eXo3ODlcclxuICogY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBoYW5kbGVyKHtcclxuICogICBwYXRoUGFyYW1ldGVyczogeyBleHBvcnRfaWQ6ICdleHBvcnQtMjAyNDAxMTUteHl6Nzg5JyB9LFxyXG4gKiAgIGhlYWRlcnM6IHsgJ3gtYXBpLWtleSc6ICd5b3VyLWFwaS1rZXknIH0sXHJcbiAqIH0sIGNvbnRleHQpO1xyXG4gKiBgYGBcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVyKFxyXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCxcclxuICBjb250ZXh0OiBDb250ZXh0XHJcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XHJcbiAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcclxuXHJcbiAgdHJ5IHtcclxuICAgIGxvZ2dlci5pbmZvKCdMYW1iZGEgRXhwb3J0IFN0YXR1cyBzdGFydGVkJywge1xyXG4gICAgICByZXF1ZXN0X2lkOiBjb250ZXh0LmF3c1JlcXVlc3RJZCxcclxuICAgICAgZnVuY3Rpb25fbmFtZTogY29udGV4dC5mdW5jdGlvbk5hbWUsXHJcbiAgICAgIGV4cG9ydF9pZDogZXZlbnQucGF0aFBhcmFtZXRlcnM/LmV4cG9ydF9pZCxcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIEFQSeOCreODvOiqjeiovFxyXG4gICAgYXdhaXQgdmFsaWRhdGVBcGlLZXkoZXZlbnQpO1xyXG5cclxuICAgIC8vIGV4cG9ydF9pZOOBruWPluW+l+OBqOODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gICAgY29uc3QgZXhwb3J0SWQgPSB2YWxpZGF0ZUV4cG9ydElkKGV2ZW50KTtcclxuXHJcbiAgICAvLyBEeW5hbW9EQuOBi+OCieOCqOOCr+OCueODneODvOODiOeKtuaFi+OCkuWPluW+l1xyXG4gICAgY29uc3QgZXhwb3J0U3RhdHVzID0gYXdhaXQgZ2V0RXhwb3J0U3RhdHVzKGV4cG9ydElkKTtcclxuXHJcbiAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XHJcblxyXG4gICAgbG9nZ2VyLmluZm8oJ0xhbWJkYSBFeHBvcnQgU3RhdHVzIGNvbXBsZXRlZCcsIHtcclxuICAgICAgZXhwb3J0X2lkOiBleHBvcnRJZCxcclxuICAgICAgc3RhdHVzOiBleHBvcnRTdGF0dXMuc3RhdHVzLFxyXG4gICAgICBkdXJhdGlvbl9tczogZHVyYXRpb24sXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyDmiJDlip/jg6Hjg4jjg6rjgq/jgrnpgIHkv6FcclxuICAgIGF3YWl0IHNlbmRNZXRyaWNzKFtcclxuICAgICAge1xyXG4gICAgICAgIG5hbWU6ICdMYW1iZGFFeGVjdXRpb25UaW1lJyxcclxuICAgICAgICB2YWx1ZTogZHVyYXRpb24sXHJcbiAgICAgICAgdW5pdDogJ01pbGxpc2Vjb25kcycsXHJcbiAgICAgICAgZGltZW5zaW9uczogeyBGdW5jdGlvbk5hbWU6ICdFeHBvcnRTdGF0dXMnIH0sXHJcbiAgICAgIH0sXHJcbiAgICAgIHtcclxuICAgICAgICBuYW1lOiAnRXhwb3J0U3RhdHVzUXVlcmllcycsXHJcbiAgICAgICAgdmFsdWU6IDEsXHJcbiAgICAgICAgdW5pdDogJ0NvdW50JyxcclxuICAgICAgICBkaW1lbnNpb25zOiB7IFN0YXR1czogZXhwb3J0U3RhdHVzLnN0YXR1cyB9LFxyXG4gICAgICB9LFxyXG4gICAgXSk7XHJcblxyXG4gICAgLy8g44Os44K544Od44Oz44K5XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXHJcbiAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXHJcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLFgtQXBpLUtleScsXHJcbiAgICAgIH0sXHJcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICBzdGF0dXM6ICdzdWNjZXNzJyxcclxuICAgICAgICBkYXRhOiBleHBvcnRTdGF0dXMsXHJcbiAgICAgIH0pLFxyXG4gICAgfTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xyXG5cclxuICAgIGxvZ2dlci5lcnJvcihcclxuICAgICAgJ0xhbWJkYSBFeHBvcnQgU3RhdHVzIGZhaWxlZCcsXHJcbiAgICAgIGNyZWF0ZUVycm9yQ29udGV4dChlcnJvciBhcyBFcnJvciwge1xyXG4gICAgICAgIHJlcXVlc3RfaWQ6IGNvbnRleHQuYXdzUmVxdWVzdElkLFxyXG4gICAgICAgIGV4cG9ydF9pZDogZXZlbnQucGF0aFBhcmFtZXRlcnM/LmV4cG9ydF9pZCxcclxuICAgICAgICBkdXJhdGlvbl9tczogZHVyYXRpb24sXHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIC8vIOOCqOODqeODvOODoeODiOODquOCr+OCuemAgeS/oVxyXG4gICAgYXdhaXQgc2VuZEVycm9yTWV0cmljKFxyXG4gICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IuY29uc3RydWN0b3IubmFtZSA6ICdVbmtub3duJyxcclxuICAgICAgJ0V4cG9ydFN0YXR1cydcclxuICAgICk7XHJcblxyXG4gICAgLy8g44Ko44Op44O844Os44K544Od44Oz44K5XHJcbiAgICByZXR1cm4gaGFuZGxlRXJyb3IoZXJyb3IgYXMgRXJyb3IsIGNvbnRleHQuYXdzUmVxdWVzdElkKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBBUEnjgq3jg7zoqo3oqLxcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEFQSUdhdGV3YXlQcm94eUV2ZW50XHJcbiAqIEB0aHJvd3MgQXV0aGVudGljYXRpb25FcnJvciBBUEnjgq3jg7zjgYznhKHlirnjgarloLTlkIhcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIHZhbGlkYXRlQXBpS2V5KGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IFByb21pc2U8dm9pZD4ge1xyXG4gIGNvbnN0IGFwaUtleSA9IGV2ZW50LmhlYWRlcnM/LlsneC1hcGkta2V5J10gfHwgZXZlbnQuaGVhZGVycz8uWydYLUFwaS1LZXknXTtcclxuXHJcbiAgaWYgKCFhcGlLZXkpIHtcclxuICAgIHRocm93IG5ldyBBdXRoZW50aWNhdGlvbkVycm9yKCdBUEkga2V5IGlzIHJlcXVpcmVkJyk7XHJcbiAgfVxyXG5cclxuICAvLyBTZWNyZXRzIE1hbmFnZXLjgYvjgolBUEnjgq3jg7zjgpLlj5blvpdcclxuICBjb25zdCB2YWxpZEFwaUtleSA9IGF3YWl0IGdldEFwaUtleSgpO1xyXG5cclxuICBpZiAoYXBpS2V5ICE9PSB2YWxpZEFwaUtleSkge1xyXG4gICAgdGhyb3cgbmV3IEF1dGhlbnRpY2F0aW9uRXJyb3IoJ0ludmFsaWQgQVBJIGtleScpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIGV4cG9ydF9pZOOBruODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gKlxyXG4gKiBAcGFyYW0gZXZlbnQgQVBJR2F0ZXdheVByb3h5RXZlbnRcclxuICogQHJldHVybnMgZXhwb3J0X2lkXHJcbiAqIEB0aHJvd3MgVmFsaWRhdGlvbkVycm9yIGV4cG9ydF9pZOOBjOeEoeWKueOBquWgtOWQiFxyXG4gKi9cclxuZnVuY3Rpb24gdmFsaWRhdGVFeHBvcnRJZChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBzdHJpbmcge1xyXG4gIGNvbnN0IGV4cG9ydElkID0gZXZlbnQucGF0aFBhcmFtZXRlcnM/LmV4cG9ydF9pZDtcclxuXHJcbiAgaWYgKCFleHBvcnRJZCkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignZXhwb3J0X2lkIGlzIHJlcXVpcmVkJyk7XHJcbiAgfVxyXG5cclxuICAvLyBleHBvcnRfaWTjga7jg5Xjgqnjg7zjg57jg4Pjg4jmpJzoqLzvvIjkvos6IGV4cG9ydC0yMDI0MDExNS14eXo3ODnvvIlcclxuICBpZiAoIS9eZXhwb3J0LVxcZHs4fS1bYS16MC05XSskLy50ZXN0KGV4cG9ydElkKSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEludmFsaWQgZXhwb3J0X2lkIGZvcm1hdDogJHtleHBvcnRJZH0uIEV4cGVjdGVkIGZvcm1hdDogZXhwb3J0LVlZWVlNTURELXtpZH1gXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGV4cG9ydElkO1xyXG59XHJcblxyXG4vKipcclxuICogRHluYW1vRELjgYvjgonjgqjjgq/jgrnjg53jg7zjg4jnirbmhYvjgpLlj5blvpdcclxuICpcclxuICogQHBhcmFtIGV4cG9ydElkIOOCqOOCr+OCueODneODvOODiElEXHJcbiAqIEByZXR1cm5zIOOCqOOCr+OCueODneODvOODiOeKtuaFi1xyXG4gKiBAdGhyb3dzIE5vdEZvdW5kRXJyb3Ig44Ko44Kv44K544Od44O844OI44GM6KaL44Gk44GL44KJ44Gq44GE5aC05ZCIXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBnZXRFeHBvcnRTdGF0dXMoZXhwb3J0SWQ6IHN0cmluZyk6IFByb21pc2U8RXhwb3J0U3RhdHVzPiB7XHJcbiAgbG9nZ2VyLmluZm8oJ0ZldGNoaW5nIGV4cG9ydCBzdGF0dXMgZnJvbSBEeW5hbW9EQicsIHtcclxuICAgIGV4cG9ydF9pZDogZXhwb3J0SWQsXHJcbiAgICB0YWJsZTogRVhQT1JUX1NUQVRVU19UQUJMRSxcclxuICB9KTtcclxuXHJcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmV0cnlXaXRoQmFja29mZihcclxuICAgIGFzeW5jICgpID0+IHtcclxuICAgICAgcmV0dXJuIGF3YWl0IGR5bmFtb0NsaWVudC5zZW5kKFxyXG4gICAgICAgIG5ldyBHZXRJdGVtQ29tbWFuZCh7XHJcbiAgICAgICAgICBUYWJsZU5hbWU6IEVYUE9SVF9TVEFUVVNfVEFCTEUsXHJcbiAgICAgICAgICBLZXk6IHtcclxuICAgICAgICAgICAgZXhwb3J0X2lkOiB7IFM6IGV4cG9ydElkIH0sXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0pXHJcbiAgICAgICk7XHJcbiAgICB9LFxyXG4gICAge1xyXG4gICAgICBtYXhSZXRyaWVzOiAzLFxyXG4gICAgICBpbml0aWFsRGVsYXk6IDEwMDAsXHJcbiAgICAgIGJhY2tvZmZNdWx0aXBsaWVyOiAyLFxyXG4gICAgICBqaXR0ZXI6IHRydWUsXHJcbiAgICAgIHNob3VsZFJldHJ5OiAoZXJyb3IpID0+IHtcclxuICAgICAgICByZXR1cm4gZXJyb3IubmFtZSA9PT0gJ1Byb3Zpc2lvbmVkVGhyb3VnaHB1dEV4Y2VlZGVkRXhjZXB0aW9uJztcclxuICAgICAgfSxcclxuICAgIH1cclxuICApO1xyXG5cclxuICBpZiAoIXJlc3VsdC5JdGVtKSB7XHJcbiAgICB0aHJvdyBuZXcgTm90Rm91bmRFcnJvcihgRXhwb3J0IG5vdCBmb3VuZDogJHtleHBvcnRJZH1gKTtcclxuICB9XHJcblxyXG4gIC8vIER5bmFtb0RC44Ki44Kk44OG44Og44KSRXhwb3J0U3RhdHVz44Gr5aSJ5o+bXHJcbiAgY29uc3QgaXRlbSA9IHJlc3VsdC5JdGVtO1xyXG5cclxuICBjb25zdCBleHBvcnRTdGF0dXM6IEV4cG9ydFN0YXR1cyA9IHtcclxuICAgIGV4cG9ydF9pZDogaXRlbS5leHBvcnRfaWQuUyEsXHJcbiAgICBzdGF0dXM6IGl0ZW0uc3RhdHVzLlMhIGFzICdwZW5kaW5nJyB8ICdwcm9jZXNzaW5nJyB8ICdjb21wbGV0ZWQnIHwgJ2ZhaWxlZCcsXHJcbiAgICBwcm9ncmVzczogcGFyc2VJbnQoaXRlbS5wcm9ncmVzcy5OISwgMTApLFxyXG4gICAgcmVxdWVzdGVkX2F0OiBpdGVtLnJlcXVlc3RlZF9hdC5TISxcclxuICAgIGNvbXBsZXRlZF9hdDogaXRlbS5jb21wbGV0ZWRfYXQ/LlMgfHwgbnVsbCxcclxuICAgIGV4cG9ydF9jb3VudDogaXRlbS5leHBvcnRfY291bnQ/Lk4gPyBwYXJzZUludChpdGVtLmV4cG9ydF9jb3VudC5OLCAxMCkgOiBudWxsLFxyXG4gICAgZmlsZV9zaXplOiBpdGVtLmZpbGVfc2l6ZT8uTiA/IHBhcnNlSW50KGl0ZW0uZmlsZV9zaXplLk4sIDEwKSA6IG51bGwsXHJcbiAgICBkb3dubG9hZF91cmw6IGl0ZW0uZG93bmxvYWRfdXJsPy5TIHx8IG51bGwsXHJcbiAgICBleHBpcmVzX2F0OiBpdGVtLmV4cGlyZXNfYXQ/LlMgfHwgbnVsbCxcclxuICAgIGVycm9yX21lc3NhZ2U6IGl0ZW0uZXJyb3JfbWVzc2FnZT8uUyB8fCBudWxsLFxyXG4gIH07XHJcblxyXG4gIGxvZ2dlci5pbmZvKCdFeHBvcnQgc3RhdHVzIGZldGNoZWQgc3VjY2Vzc2Z1bGx5Jywge1xyXG4gICAgZXhwb3J0X2lkOiBleHBvcnRJZCxcclxuICAgIHN0YXR1czogZXhwb3J0U3RhdHVzLnN0YXR1cyxcclxuICAgIHByb2dyZXNzOiBleHBvcnRTdGF0dXMucHJvZ3Jlc3MsXHJcbiAgfSk7XHJcblxyXG4gIHJldHVybiBleHBvcnRTdGF0dXM7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgqjjg6njg7zjg4/jg7Pjg4njg6rjg7PjgrBcclxuICpcclxuICogQHBhcmFtIGVycm9yIOOCqOODqeODvOOCquODluOCuOOCp+OCr+ODiFxyXG4gKiBAcGFyYW0gcmVxdWVzdElkIOODquOCr+OCqOOCueODiElEXHJcbiAqIEByZXR1cm5zIEFQSUdhdGV3YXlQcm94eVJlc3VsdFxyXG4gKi9cclxuZnVuY3Rpb24gaGFuZGxlRXJyb3IoZXJyb3I6IEVycm9yLCByZXF1ZXN0SWQ6IHN0cmluZyk6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCB7XHJcbiAgLy8g44Ko44Op44O856iu5Yil44Gr5b+c44GY44Gf44K544OG44O844K/44K544Kz44O844OJ44Go44Ko44Op44O844Kz44O844OJXHJcbiAgbGV0IHN0YXR1c0NvZGUgPSA1MDA7XHJcbiAgbGV0IGVycm9yQ29kZSA9ICdJTlRFUk5BTF9FUlJPUic7XHJcblxyXG4gIGlmIChlcnJvciBpbnN0YW5jZW9mIFZhbGlkYXRpb25FcnJvcikge1xyXG4gICAgc3RhdHVzQ29kZSA9IDQwMDtcclxuICAgIGVycm9yQ29kZSA9ICdWQUxJREFUSU9OX0VSUk9SJztcclxuICB9IGVsc2UgaWYgKGVycm9yIGluc3RhbmNlb2YgQXV0aGVudGljYXRpb25FcnJvcikge1xyXG4gICAgc3RhdHVzQ29kZSA9IDQwMTtcclxuICAgIGVycm9yQ29kZSA9ICdVTkFVVEhPUklaRUQnO1xyXG4gIH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEVycm9yKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDA0O1xyXG4gICAgZXJyb3JDb2RlID0gJ05PVF9GT1VORCc7XHJcbiAgfVxyXG5cclxuICByZXR1cm4ge1xyXG4gICAgc3RhdHVzQ29kZSxcclxuICAgIGhlYWRlcnM6IHtcclxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLFgtQXBpLUtleScsXHJcbiAgICB9LFxyXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICBzdGF0dXM6ICdlcnJvcicsXHJcbiAgICAgIGVycm9yOiB7XHJcbiAgICAgICAgY29kZTogZXJyb3JDb2RlLFxyXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXHJcbiAgICAgICAgZGV0YWlsczogKGVycm9yIGFzIGFueSkuZGV0YWlscyB8fCB7fSxcclxuICAgICAgfSxcclxuICAgICAgcmVxdWVzdF9pZDogcmVxdWVzdElkLFxyXG4gICAgfSksXHJcbiAgfTtcclxufVxyXG5cclxuLyoqXHJcbiAqIOOCqOOCr+OCueODneODvOODiOeKtuaFi+OBruWei+Wumue+qVxyXG4gKi9cclxuaW50ZXJmYWNlIEV4cG9ydFN0YXR1cyB7XHJcbiAgZXhwb3J0X2lkOiBzdHJpbmc7XHJcbiAgc3RhdHVzOiAncGVuZGluZycgfCAncHJvY2Vzc2luZycgfCAnY29tcGxldGVkJyB8ICdmYWlsZWQnO1xyXG4gIHByb2dyZXNzOiBudW1iZXI7XHJcbiAgcmVxdWVzdGVkX2F0OiBzdHJpbmc7XHJcbiAgY29tcGxldGVkX2F0OiBzdHJpbmcgfCBudWxsO1xyXG4gIGV4cG9ydF9jb3VudDogbnVtYmVyIHwgbnVsbDtcclxuICBmaWxlX3NpemU6IG51bWJlciB8IG51bGw7XHJcbiAgZG93bmxvYWRfdXJsOiBzdHJpbmcgfCBudWxsO1xyXG4gIGV4cGlyZXNfYXQ6IHN0cmluZyB8IG51bGw7XHJcbiAgZXJyb3JfbWVzc2FnZTogc3RyaW5nIHwgbnVsbDtcclxufVxyXG4iXSwidmVyc2lvbiI6M30=