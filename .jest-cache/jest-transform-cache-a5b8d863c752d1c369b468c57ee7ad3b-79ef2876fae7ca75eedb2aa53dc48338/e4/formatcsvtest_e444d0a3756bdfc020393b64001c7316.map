{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\query\\__tests__\\format-csv.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\query\\__tests__\\format-csv.test.ts"],"sourcesContent":["/**\r\n * Format CSV Tests\r\n *\r\n * Requirements: 要件14.1（ユニットテスト）\r\n */\r\n\r\nimport { formatAsCsv, parseCsv } from '../format-csv';\r\nimport { Disclosure } from '../../../types';\r\n\r\ndescribe('Format CSV', () => {\r\n  const mockDisclosures: Disclosure[] = [\r\n    {\r\n      disclosure_id: 'TD20240115001',\r\n      company_code: '7203',\r\n      company_name: 'トヨタ自動車',\r\n      disclosure_type: '決算短信',\r\n      title: '2024年3月期 第3四半期決算短信',\r\n      disclosed_at: '2024-01-15T10:30:00Z',\r\n      pdf_url: 'https://www.release.tdnet.info/inbs/140120240115533808.pdf',\r\n      s3_key: '2024/01/15/TD20240115001_7203.pdf',\r\n      collected_at: '2024-01-15T10:35:00Z',\r\n      date_partition: '2024-01',\r\n    },\r\n    {\r\n      disclosure_id: 'TD20240115002',\r\n      company_code: '6758',\r\n      company_name: 'ソニーグループ',\r\n      disclosure_type: '有価証券報告書',\r\n      title: '第78期有価証券報告書',\r\n      disclosed_at: '2024-01-15T11:00:00Z',\r\n      pdf_url: 'https://www.release.tdnet.info/inbs/140120240115534001.pdf',\r\n      s3_key: '2024/01/15/TD20240115002_6758.pdf',\r\n      collected_at: '2024-01-15T11:05:00Z',\r\n      date_partition: '2024-01',\r\n    },\r\n  ];\r\n\r\n  describe('formatAsCsv', () => {\r\n    it('開示情報リストをCSV形式に変換', () => {\r\n      const csv = formatAsCsv(mockDisclosures);\r\n\r\n      // ヘッダー行を確認\r\n      expect(csv).toContain('disclosure_id,company_code,company_name');\r\n      expect(csv).toContain('disclosure_type,title,disclosed_at');\r\n      expect(csv).toContain('pdf_url,s3_key,collected_at,date_partition');\r\n\r\n      // データ行を確認\r\n      expect(csv).toContain('TD20240115001');\r\n      expect(csv).toContain('7203');\r\n      expect(csv).toContain('トヨタ自動車');\r\n      expect(csv).toContain('TD20240115002');\r\n      expect(csv).toContain('6758');\r\n      expect(csv).toContain('ソニーグループ');\r\n    });\r\n\r\n    it('空のリストは ヘッダーのみ返す', () => {\r\n      const csv = formatAsCsv([]);\r\n\r\n      const lines = csv.split('\\n');\r\n      expect(lines.length).toBe(1); // ヘッダーのみ\r\n      expect(lines[0]).toContain('disclosure_id,company_code');\r\n    });\r\n\r\n    it('カンマを含むフィールドをエスケープ', () => {\r\n      const disclosures: Disclosure[] = [\r\n        {\r\n          ...mockDisclosures[0],\r\n          title: 'タイトル, カンマ付き',\r\n        },\r\n      ];\r\n\r\n      const csv = formatAsCsv(disclosures);\r\n\r\n      // カンマを含むフィールドはダブルクォートで囲まれる\r\n      expect(csv).toContain('\"タイトル, カンマ付き\"');\r\n    });\r\n\r\n    it('ダブルクォートを含むフィールドをエスケープ', () => {\r\n      const disclosures: Disclosure[] = [\r\n        {\r\n          ...mockDisclosures[0],\r\n          title: 'タイトル \"引用符\" 付き',\r\n        },\r\n      ];\r\n\r\n      const csv = formatAsCsv(disclosures);\r\n\r\n      // ダブルクォートは2つ連続させてエスケープ\r\n      expect(csv).toContain('\"タイトル \"\"引用符\"\" 付き\"');\r\n    });\r\n\r\n    it('改行を含むフィールドをエスケープ', () => {\r\n      const disclosures: Disclosure[] = [\r\n        {\r\n          ...mockDisclosures[0],\r\n          title: 'タイトル\\n改行付き',\r\n        },\r\n      ];\r\n\r\n      const csv = formatAsCsv(disclosures);\r\n\r\n      // 改行を含むフィールドはダブルクォートで囲まれる\r\n      expect(csv).toContain('\"タイトル\\n改行付き\"');\r\n    });\r\n\r\n    it('すべてのフィールドが含まれる', () => {\r\n      const csv = formatAsCsv(mockDisclosures);\r\n\r\n      const lines = csv.split('\\n');\r\n      const headers = lines[0].split(',');\r\n\r\n      expect(headers).toContain('disclosure_id');\r\n      expect(headers).toContain('company_code');\r\n      expect(headers).toContain('company_name');\r\n      expect(headers).toContain('disclosure_type');\r\n      expect(headers).toContain('title');\r\n      expect(headers).toContain('disclosed_at');\r\n      expect(headers).toContain('pdf_url');\r\n      expect(headers).toContain('s3_key');\r\n      expect(headers).toContain('collected_at');\r\n      expect(headers).toContain('date_partition');\r\n    });\r\n\r\n    it('複数の開示情報を正しく変換', () => {\r\n      const csv = formatAsCsv(mockDisclosures);\r\n\r\n      const lines = csv.split('\\n').filter((line) => line.trim() !== '');\r\n      expect(lines.length).toBe(3); // ヘッダー + 2データ行\r\n    });\r\n  });\r\n\r\n  describe('parseCsv（テスト用）', () => {\r\n    it('CSV文字列をパース', () => {\r\n      const csv = formatAsCsv(mockDisclosures);\r\n      const parsed = parseCsv(csv);\r\n\r\n      expect(parsed.length).toBe(2);\r\n      expect(parsed[0].disclosure_id).toBe('TD20240115001');\r\n      expect(parsed[0].company_code).toBe('7203');\r\n      expect(parsed[1].disclosure_id).toBe('TD20240115002');\r\n      expect(parsed[1].company_code).toBe('6758');\r\n    });\r\n\r\n    it('空のCSV文字列は空配列を返す', () => {\r\n      const parsed = parseCsv('');\r\n\r\n      expect(parsed).toEqual([]);\r\n    });\r\n  });\r\n\r\n  describe('エッジケース', () => {\r\n    it('null/undefinedフィールドは空文字列として扱う', () => {\r\n      const disclosures: any[] = [\r\n        {\r\n          disclosure_id: 'TD20240115001',\r\n          company_code: '7203',\r\n          company_name: null,\r\n          disclosure_type: undefined,\r\n          title: '2024年3月期 第3四半期決算短信',\r\n          disclosed_at: '2024-01-15T10:30:00Z',\r\n          pdf_url: 'https://www.release.tdnet.info/...',\r\n          s3_key: '2024/01/15/TD20240115001_7203.pdf',\r\n          collected_at: '2024-01-15T10:35:00Z',\r\n          date_partition: '2024-01',\r\n        },\r\n      ];\r\n\r\n      const csv = formatAsCsv(disclosures as Disclosure[]);\r\n\r\n      // null/undefinedは空文字列として扱われる\r\n      expect(csv).toContain('TD20240115001,7203,,');\r\n    });\r\n\r\n    it('特殊文字を含むフィールドを正しく処理', () => {\r\n      const disclosures: Disclosure[] = [\r\n        {\r\n          ...mockDisclosures[0],\r\n          title: 'タイトル & 特殊文字 < > \" \\' / \\\\',\r\n        },\r\n      ];\r\n\r\n      const csv = formatAsCsv(disclosures);\r\n\r\n      // ダブルクォートのみエスケープが必要\r\n      expect(csv).toContain('\"タイトル & 特殊文字 < > \"\" \\' / \\\\\"');\r\n    });\r\n  });\r\n});\r\n"],"version":3}