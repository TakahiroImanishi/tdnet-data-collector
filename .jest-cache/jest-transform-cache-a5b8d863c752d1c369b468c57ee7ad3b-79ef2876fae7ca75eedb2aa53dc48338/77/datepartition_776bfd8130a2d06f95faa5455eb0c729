85cb5968b34f6b0c8373ba5aed620928
"use strict";
/**
 * date_partition生成ユーティリティ
 *
 * disclosed_atからdate_partition（YYYY-MM形式、JST基準）を生成します。
 * DynamoDBのGSIパーティションキーとして使用され、月単位のクエリを高速化します。
 *
 * Requirements: 要件2.1（date_partition）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.validateDisclosedAt = validateDisclosedAt;
exports.generateDatePartition = generateDatePartition;
exports.generateMonthRange = generateMonthRange;
exports.validateYearMonth = validateYearMonth;
const errors_1 = require("../errors");
/**
 * disclosed_atのバリデーション
 *
 * @param disclosedAt - ISO 8601形式の日時文字列（UTC推奨）
 * @throws {ValidationError} フォーマットまたは範囲が不正な場合
 */
function validateDisclosedAt(disclosedAt) {
    // ISO 8601形式チェック
    const iso8601Regex = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?([Z]|[+-]\d{2}:\d{2})$/;
    if (!iso8601Regex.test(disclosedAt)) {
        throw new errors_1.ValidationError(`Invalid disclosed_at format: ${disclosedAt}. Expected ISO 8601 format (e.g., "2024-01-15T10:30:00Z")`, { disclosed_at: disclosedAt });
    }
    // 有効な日付チェック
    const date = new Date(disclosedAt);
    if (isNaN(date.getTime())) {
        throw new errors_1.ValidationError(`Invalid date: ${disclosedAt}. Date does not exist.`, {
            disclosed_at: disclosedAt,
        });
    }
    // 日付の正規化チェック（例: 2024-02-30 → 2024-03-01 のような変換を検出）
    // ISO8601文字列から年月日を抽出して、Dateオブジェクトと比較
    const match = disclosedAt.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (match) {
        const [, yearStr, monthStr, dayStr] = match;
        const inputYear = parseInt(yearStr, 10);
        const inputMonth = parseInt(monthStr, 10);
        const inputDay = parseInt(dayStr, 10);
        // Dateオブジェクトの年月日と比較（UTCで比較）
        if (date.getUTCFullYear() !== inputYear ||
            date.getUTCMonth() + 1 !== inputMonth ||
            date.getUTCDate() !== inputDay) {
            throw new errors_1.ValidationError(`Invalid date: ${disclosedAt}. Date does not exist.`, {
                disclosed_at: disclosedAt,
                parsed_date: date.toISOString(),
            });
        }
    }
    // 範囲チェック（1970-01-01 以降、現在時刻+1日以内）
    const minDate = new Date('1970-01-01T00:00:00Z');
    const maxDate = new Date(Date.now() + 24 * 60 * 60 * 1000); // 現在時刻+1日
    if (date < minDate || date > maxDate) {
        throw new errors_1.ValidationError(`Date out of range: ${disclosedAt}. Must be between 1970-01-01 and ${maxDate.toISOString()}`, {
            disclosed_at: disclosedAt,
            min_date: minDate.toISOString(),
            max_date: maxDate.toISOString(),
        });
    }
}
/**
 * disclosed_atからdate_partitionを生成（JST基準）
 *
 * TDnetは日本の開示情報サービスであり、開示時刻は日本時間（JST, UTC+9）で管理されます。
 * そのため、date_partitionはJST基準で生成します。
 *
 * 例：
 * - UTC: 2024-01-31T15:30:00Z → JST: 2024-02-01T00:30:00 → "2024-02"
 * - UTC: 2024-02-01T14:59:59Z → JST: 2024-01-31T23:59:59 → "2024-01"
 *
 * @param disclosedAt - ISO 8601形式の日時文字列（UTC推奨）
 * @returns YYYY-MM形式のdate_partition
 * @throws {ValidationError} 不正なフォーマットまたは日付の場合
 */
function generateDatePartition(disclosedAt) {
    // バリデーション
    validateDisclosedAt(disclosedAt);
    // UTCからJSTに変換（UTC+9時間）
    const utcDate = new Date(disclosedAt);
    const jstDate = new Date(utcDate.getTime() + 9 * 60 * 60 * 1000);
    // YYYY-MM形式で返却
    const year = jstDate.getUTCFullYear();
    const month = String(jstDate.getUTCMonth() + 1).padStart(2, '0');
    return `${year}-${month}`;
}
/**
 * 月範囲を生成するヘルパー関数
 *
 * 開始月から終了月までの月のリストを生成します。
 * 日付範囲クエリで複数月を並行クエリする際に使用します。
 *
 * 例：
 * - generateMonthRange("2024-01", "2024-03") → ["2024-01", "2024-02", "2024-03"]
 *
 * @param start - 開始月（YYYY-MM形式）
 * @param end - 終了月（YYYY-MM形式）
 * @returns 月のリスト（YYYY-MM形式）
 * @throws {ValidationError} フォーマットまたは範囲が不正な場合
 */
function generateMonthRange(start, end) {
    // フォーマット検証
    const monthRegex = /^\d{4}-\d{2}$/;
    if (!monthRegex.test(start) || !monthRegex.test(end)) {
        throw new errors_1.ValidationError(`Invalid month format. Expected YYYY-MM format. Got: start=${start}, end=${end}`, { start, end });
    }
    const [startYear, startMonth] = start.split('-').map(Number);
    const [endYear, endMonth] = end.split('-').map(Number);
    // 範囲チェック（開始月 <= 終了月）
    if (startYear > endYear || (startYear === endYear && startMonth > endMonth)) {
        throw new errors_1.ValidationError(`Invalid month range: start (${start}) must be before or equal to end (${end})`, { start, end });
    }
    const months = [];
    let year = startYear;
    let month = startMonth;
    while (year < endYear || (year === endYear && month <= endMonth)) {
        months.push(`${year}-${String(month).padStart(2, '0')}`);
        month++;
        if (month > 12) {
            month = 1;
            year++;
        }
    }
    return months;
}
/**
 * yearMonthフォーマットのバリデーション
 *
 * @param yearMonth - YYYY-MM形式の文字列
 * @throws {ValidationError} フォーマットが不正な場合
 */
function validateYearMonth(yearMonth) {
    const monthRegex = /^\d{4}-\d{2}$/;
    if (!monthRegex.test(yearMonth)) {
        throw new errors_1.ValidationError(`Invalid yearMonth format: ${yearMonth}. Expected YYYY-MM format.`, {
            year_month: yearMonth,
        });
    }
    // 月の範囲チェック（01〜12）
    const [, monthStr] = yearMonth.split('-');
    const month = Number(monthStr);
    if (month < 1 || month > 12) {
        throw new errors_1.ValidationError(`Invalid month: ${month}. Month must be between 01 and 12.`, {
            year_month: yearMonth,
            month,
        });
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFx1dGlsc1xcZGF0ZS1wYXJ0aXRpb24udHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7O0dBT0c7O0FBVUgsa0RBcURDO0FBZ0JELHNEQWFDO0FBZ0JELGdEQW1DQztBQVFELDhDQWlCQztBQXRLRCxzQ0FBNEM7QUFFNUM7Ozs7O0dBS0c7QUFDSCxTQUFnQixtQkFBbUIsQ0FBQyxXQUFtQjtJQUNyRCxpQkFBaUI7SUFDakIsTUFBTSxZQUFZLEdBQUcsc0VBQXNFLENBQUM7SUFDNUYsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQztRQUNwQyxNQUFNLElBQUksd0JBQWUsQ0FDdkIsZ0NBQWdDLFdBQVcsMkRBQTJELEVBQ3RHLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxDQUM5QixDQUFDO0lBQ0osQ0FBQztJQUVELFlBQVk7SUFDWixNQUFNLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNuQyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQzFCLE1BQU0sSUFBSSx3QkFBZSxDQUFDLGlCQUFpQixXQUFXLHdCQUF3QixFQUFFO1lBQzlFLFlBQVksRUFBRSxXQUFXO1NBQzFCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxtREFBbUQ7SUFDbkQscUNBQXFDO0lBQ3JDLE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQztJQUM1RCxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQ1YsTUFBTSxDQUFDLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUMsR0FBRyxLQUFLLENBQUM7UUFDNUMsTUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN4QyxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsUUFB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QUFFLFFBQVEsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDMUMsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQy9CLElBQUksS0FBSyxHQUFHLENBQUMsSUFBSSxLQUFLLEdBQUcsRUFBRSxFQUFFLENBQUM7UUFDNUIsTUFBTSxJQUFJLHdCQUFlLENBQUMsa0JBQWtCLEtBQUssb0NBQW9DLEVBQUU7WUFDckYsVUFBVSxFQUFFLFNBQVM7WUFDckIsS0FBSztTQUNOLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcdGkxOThcXGludmVzdG1lbnRfYW5hbHlzaXNfb3BvcG9cXHNyY1xcdXRpbHNcXGRhdGUtcGFydGl0aW9uLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogZGF0ZV9wYXJ0aXRpb27nlJ/miJDjg6bjg7zjg4bjgqPjg6rjg4bjgqNcbiAqXG4gKiBkaXNjbG9zZWRfYXTjgYvjgolkYXRlX3BhcnRpdGlvbu+8iFlZWVktTU3lvaLlvI/jgIFKU1Tln7rmupbvvInjgpLnlJ/miJDjgZfjgb7jgZnjgIJcbiAqIER5bmFtb0RC44GuR1NJ44OR44O844OG44Kj44K344On44Oz44Kt44O844Go44GX44Gm5L2/55So44GV44KM44CB5pyI5Y2Y5L2N44Gu44Kv44Ko44Oq44KS6auY6YCf5YyW44GX44G+44GZ44CCXG4gKlxuICogUmVxdWlyZW1lbnRzOiDopoHku7YyLjHvvIhkYXRlX3BhcnRpdGlvbu+8iVxuICovXG5cbmltcG9ydCB7IFZhbGlkYXRpb25FcnJvciB9IGZyb20gJy4uL2Vycm9ycyc7XG5cbi8qKlxuICogZGlzY2xvc2VkX2F044Gu44OQ44Oq44OH44O844K344On44OzXG4gKlxuICogQHBhcmFtIGRpc2Nsb3NlZEF0IC0gSVNPIDg2MDHlvaLlvI/jga7ml6XmmYLmloflrZfliJfvvIhVVEPmjqjlpajvvIlcbiAqIEB0aHJvd3Mge1ZhbGlkYXRpb25FcnJvcn0g44OV44Kp44O844Oe44OD44OI44G+44Gf44Gv56+E5Zuy44GM5LiN5q2j44Gq5aC05ZCIXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZURpc2Nsb3NlZEF0KGRpc2Nsb3NlZEF0OiBzdHJpbmcpOiB2b2lkIHtcbiAgLy8gSVNPIDg2MDHlvaLlvI/jg4Hjgqfjg4Pjgq9cbiAgY29uc3QgaXNvODYwMVJlZ2V4ID0gL15cXGR7NH0tXFxkezJ9LVxcZHsyfVRcXGR7Mn06XFxkezJ9OlxcZHsyfShcXC5cXGR7M30pPyhbWl18WystXVxcZHsyfTpcXGR7Mn0pJC87XG4gIGlmICghaXNvODYwMVJlZ2V4LnRlc3QoZGlzY2xvc2VkQXQpKSB7XG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcbiAgICAgIGBJbnZhbGlkIGRpc2Nsb3NlZF9hdCBmb3JtYXQ6ICR7ZGlzY2xvc2VkQXR9LiBFeHBlY3RlZCBJU08gODYwMSBmb3JtYXQgKGUuZy4sIFwiMjAyNC0wMS0xNVQxMDozMDowMFpcIilgLFxuICAgICAgeyBkaXNjbG9zZWRfYXQ6IGRpc2Nsb3NlZEF0IH1cbiAgICApO1xuICB9XG5cbiAgLy8g5pyJ5Yq544Gq5pel5LuY44OB44Kn44OD44KvXG4gIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZShkaXNjbG9zZWRBdCk7XG4gIGlmIChpc05hTihkYXRlLmdldFRpbWUoKSkpIHtcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKGBJbnZhbGlkIGRhdGU6ICR7ZGlzY2xvc2VkQXR9LiBEYXRlIGRvZXMgbm90IGV4aXN0LmAsIHtcbiAgICAgIGRpc2Nsb3NlZF9hdDogZGlzY2xvc2VkQXQsXG4gICAgfSk7XG4gIH1cblxuICAvLyDml6Xku5jjga7mraPopo/ljJbjg4Hjgqfjg4Pjgq/vvIjkvos6IDIwMjQtMDItMzAg4oaSIDIwMjQtMDMtMDEg44Gu44KI44GG44Gq5aSJ5o+b44KS5qSc5Ye677yJXG4gIC8vIElTTzg2MDHmloflrZfliJfjgYvjgonlubTmnIjml6XjgpLmir3lh7rjgZfjgabjgIFEYXRl44Kq44OW44K444Kn44Kv44OI44Go5q+U6LyDXG4gIGNvbnN0IG1hdGNoID0gZGlzY2xvc2VkQXQubWF0Y2goL14oXFxkezR9KS0oXFxkezJ9KS0oXFxkezJ9KS8pO1xuICBpZiAobWF0Y2gpIHtcbiAgICBjb25zdCBbLCB5ZWFyU3RyLCBtb250aFN0ciwgZGF5U3RyXSA9IG1hdGNoO1xuICAgIGNvbnN0IGlucHV0WWVhciA9IHBhcnNlSW50KHllYXJTdHIsIDEwKTtcbiAgICBjb25zdCBpbnB1dE1vbnRoID0gcGFyc2VJbnQobW9udGhTdHIsIDEwKTtcbiAgICBjb25zdCBpbnB1dERheSA9IHBhcnNlSW50KGRheVN0ciwgMTApO1xuXG4gICAgLy8gRGF0ZeOCquODluOCuOOCp+OCr+ODiOOBruW5tOaciOaXpeOBqOavlOi8g++8iFVUQ+OBp+avlOi8g++8iVxuICAgIGlmIChcbiAgICAgIGRhdGUuZ2V0VVRDRnVsbFllYXIoKSAhPT0gaW5wdXRZZWFyIHx8XG4gICAgICBkYXRlLmdldFVUQ01vbnRoKCkgKyAxICE9PSBpbnB1dE1vbnRoIHx8XG4gICAgICBkYXRlLmdldFVUQ0RhdGUoKSAhPT0gaW5wdXREYXlcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoYEludmFsaWQgZGF0ZTogJHtkaXNjbG9zZWRBdH0uIERhdGUgZG9lcyBub3QgZXhpc3QuYCwge1xuICAgICAgICBkaXNjbG9zZWRfYXQ6IGRpc2Nsb3NlZEF0LFxuICAgICAgICBwYXJzZWRfZGF0ZTogZGF0ZS50b0lTT1N0cmluZygpLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8g56+E5Zuy44OB44Kn44OD44Kv77yIMTk3MC0wMS0wMSDku6XpmY3jgIHnj77lnKjmmYLliLsrMeaXpeS7peWGhe+8iVxuICBjb25zdCBtaW5EYXRlID0gbmV3IERhdGUoJzE5NzAtMDEtMDFUMDA6MDA6MDBaJyk7XG4gIGNvbnN0IG1heERhdGUgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgMjQgKiA2MCAqIDYwICogMTAwMCk7IC8vIOePvuWcqOaZguWIuysx5pelXG4gIGlmIChkYXRlIDwgbWluRGF0ZSB8fCBkYXRlID4gbWF4RGF0ZSkge1xuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXG4gICAgICBgRGF0ZSBvdXQgb2YgcmFuZ2U6ICR7ZGlzY2xvc2VkQXR9LiBNdXN0IGJlIGJldHdlZW4gMTk3MC0wMS0wMSBhbmQgJHttYXhEYXRlLnRvSVNPU3RyaW5nKCl9YCxcbiAgICAgIHtcbiAgICAgICAgZGlzY2xvc2VkX2F0OiBkaXNjbG9zZWRBdCxcbiAgICAgICAgbWluX2RhdGU6IG1pbkRhdGUudG9JU09TdHJpbmcoKSxcbiAgICAgICAgbWF4X2RhdGU6IG1heERhdGUudG9JU09TdHJpbmcoKSxcbiAgICAgIH1cbiAgICApO1xuICB9XG59XG5cbi8qKlxuICogZGlzY2xvc2VkX2F044GL44KJZGF0ZV9wYXJ0aXRpb27jgpLnlJ/miJDvvIhKU1Tln7rmupbvvIlcbiAqXG4gKiBURG5ldOOBr+aXpeacrOOBrumWi+ekuuaDheWgseOCteODvOODk+OCueOBp+OBguOCiuOAgemWi+ekuuaZguWIu+OBr+aXpeacrOaZgumWk++8iEpTVCwgVVRDKznvvInjgafnrqHnkIbjgZXjgozjgb7jgZnjgIJcbiAqIOOBneOBruOBn+OCgeOAgWRhdGVfcGFydGl0aW9u44GvSlNU5Z+65rqW44Gn55Sf5oiQ44GX44G+44GZ44CCXG4gKlxuICog5L6L77yaXG4gKiAtIFVUQzogMjAyNC0wMS0zMVQxNTozMDowMFog4oaSIEpTVDogMjAyNC0wMi0wMVQwMDozMDowMCDihpIgXCIyMDI0LTAyXCJcbiAqIC0gVVRDOiAyMDI0LTAyLTAxVDE0OjU5OjU5WiDihpIgSlNUOiAyMDI0LTAxLTMxVDIzOjU5OjU5IOKGkiBcIjIwMjQtMDFcIlxuICpcbiAqIEBwYXJhbSBkaXNjbG9zZWRBdCAtIElTTyA4NjAx5b2i5byP44Gu5pel5pmC5paH5a2X5YiX77yIVVRD5o6o5aWo77yJXG4gKiBAcmV0dXJucyBZWVlZLU1N5b2i5byP44GuZGF0ZV9wYXJ0aXRpb25cbiAqIEB0aHJvd3Mge1ZhbGlkYXRpb25FcnJvcn0g5LiN5q2j44Gq44OV44Kp44O844Oe44OD44OI44G+44Gf44Gv5pel5LuY44Gu5aC05ZCIXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZURhdGVQYXJ0aXRpb24oZGlzY2xvc2VkQXQ6IHN0cmluZyk6IHN0cmluZyB7XG4gIC8vIOODkOODquODh+ODvOOCt+ODp+ODs1xuICB2YWxpZGF0ZURpc2Nsb3NlZEF0KGRpc2Nsb3NlZEF0KTtcblxuICAvLyBVVEPjgYvjgolKU1TjgavlpInmj5vvvIhVVEMrOeaZgumWk++8iVxuICBjb25zdCB1dGNEYXRlID0gbmV3IERhdGUoZGlzY2xvc2VkQXQpO1xuICBjb25zdCBqc3REYXRlID0gbmV3IERhdGUodXRjRGF0ZS5nZXRUaW1lKCkgKyA5ICogNjAgKiA2MCAqIDEwMDApO1xuXG4gIC8vIFlZWVktTU3lvaLlvI/jgafov5TljbRcbiAgY29uc3QgeWVhciA9IGpzdERhdGUuZ2V0VVRDRnVsbFllYXIoKTtcbiAgY29uc3QgbW9udGggPSBTdHJpbmcoanN0RGF0ZS5nZXRVVENNb250aCgpICsgMSkucGFkU3RhcnQoMiwgJzAnKTtcblxuICByZXR1cm4gYCR7eWVhcn0tJHttb250aH1gO1xufVxuXG4vKipcbiAqIOaciOevhOWbsuOCkueUn+aIkOOBmeOCi+ODmOODq+ODkeODvOmWouaVsFxuICpcbiAqIOmWi+Wni+aciOOBi+OCiee1guS6huaciOOBvuOBp+OBruaciOOBruODquOCueODiOOCkueUn+aIkOOBl+OBvuOBmeOAglxuICog5pel5LuY56+E5Zuy44Kv44Ko44Oq44Gn6KSH5pWw5pyI44KS5Lim6KGM44Kv44Ko44Oq44GZ44KL6Zqb44Gr5L2/55So44GX44G+44GZ44CCXG4gKlxuICog5L6L77yaXG4gKiAtIGdlbmVyYXRlTW9udGhSYW5nZShcIjIwMjQtMDFcIiwgXCIyMDI0LTAzXCIpIOKGkiBbXCIyMDI0LTAxXCIsIFwiMjAyNC0wMlwiLCBcIjIwMjQtMDNcIl1cbiAqXG4gKiBAcGFyYW0gc3RhcnQgLSDplovlp4vmnIjvvIhZWVlZLU1N5b2i5byP77yJXG4gKiBAcGFyYW0gZW5kIC0g57WC5LqG5pyI77yIWVlZWS1NTeW9ouW8j++8iVxuICogQHJldHVybnMg5pyI44Gu44Oq44K544OI77yIWVlZWS1NTeW9ouW8j++8iVxuICogQHRocm93cyB7VmFsaWRhdGlvbkVycm9yfSDjg5Xjgqnjg7zjg57jg4Pjg4jjgb7jgZ/jga/nr4Tlm7LjgYzkuI3mraPjgarloLTlkIhcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlTW9udGhSYW5nZShzdGFydDogc3RyaW5nLCBlbmQ6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgLy8g44OV44Kp44O844Oe44OD44OI5qSc6Ki8XG4gIGNvbnN0IG1vbnRoUmVnZXggPSAvXlxcZHs0fS1cXGR7Mn0kLztcbiAgaWYgKCFtb250aFJlZ2V4LnRlc3Qoc3RhcnQpIHx8ICFtb250aFJlZ2V4LnRlc3QoZW5kKSkge1xuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXG4gICAgICBgSW52YWxpZCBtb250aCBmb3JtYXQuIEV4cGVjdGVkIFlZWVktTU0gZm9ybWF0LiBHb3Q6IHN0YXJ0PSR7c3RhcnR9LCBlbmQ9JHtlbmR9YCxcbiAgICAgIHsgc3RhcnQsIGVuZCB9XG4gICAgKTtcbiAgfVxuXG4gIGNvbnN0IFtzdGFydFllYXIsIHN0YXJ0TW9udGhdID0gc3RhcnQuc3BsaXQoJy0nKS5tYXAoTnVtYmVyKTtcbiAgY29uc3QgW2VuZFllYXIsIGVuZE1vbnRoXSA9IGVuZC5zcGxpdCgnLScpLm1hcChOdW1iZXIpO1xuXG4gIC8vIOevhOWbsuODgeOCp+ODg+OCr++8iOmWi+Wni+aciCA8PSDntYLkuobmnIjvvIlcbiAgaWYgKHN0YXJ0WWVhciA+IGVuZFllYXIgfHwgKHN0YXJ0WWVhciA9PT0gZW5kWWVhciAmJiBzdGFydE1vbnRoID4gZW5kTW9udGgpKSB7XG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcbiAgICAgIGBJbnZhbGlkIG1vbnRoIHJhbmdlOiBzdGFydCAoJHtzdGFydH0pIG11c3QgYmUgYmVmb3JlIG9yIGVxdWFsIHRvIGVuZCAoJHtlbmR9KWAsXG4gICAgICB7IHN0YXJ0LCBlbmQgfVxuICAgICk7XG4gIH1cblxuICBjb25zdCBtb250aHM6IHN0cmluZ1tdID0gW107XG4gIGxldCB5ZWFyID0gc3RhcnRZZWFyO1xuICBsZXQgbW9udGggPSBzdGFydE1vbnRoO1xuXG4gIHdoaWxlICh5ZWFyIDwgZW5kWWVhciB8fCAoeWVhciA9PT0gZW5kWWVhciAmJiBtb250aCA8PSBlbmRNb250aCkpIHtcbiAgICBtb250aHMucHVzaChgJHt5ZWFyfS0ke1N0cmluZyhtb250aCkucGFkU3RhcnQoMiwgJzAnKX1gKTtcbiAgICBtb250aCsrO1xuICAgIGlmIChtb250aCA+IDEyKSB7XG4gICAgICBtb250aCA9IDE7XG4gICAgICB5ZWFyKys7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG1vbnRocztcbn1cblxuLyoqXG4gKiB5ZWFyTW9udGjjg5Xjgqnjg7zjg57jg4Pjg4jjga7jg5Djg6rjg4fjg7zjgrfjg6fjg7NcbiAqXG4gKiBAcGFyYW0geWVhck1vbnRoIC0gWVlZWS1NTeW9ouW8j+OBruaWh+Wtl+WIl1xuICogQHRocm93cyB7VmFsaWRhdGlvbkVycm9yfSDjg5Xjgqnjg7zjg57jg4Pjg4jjgYzkuI3mraPjgarloLTlkIhcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlWWVhck1vbnRoKHllYXJNb250aDogc3RyaW5nKTogdm9pZCB7XG4gIGNvbnN0IG1vbnRoUmVnZXggPSAvXlxcZHs0fS1cXGR7Mn0kLztcbiAgaWYgKCFtb250aFJlZ2V4LnRlc3QoeWVhck1vbnRoKSkge1xuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoYEludmFsaWQgeWVhck1vbnRoIGZvcm1hdDogJHt5ZWFyTW9udGh9LiBFeHBlY3RlZCBZWVlZLU1NIGZvcm1hdC5gLCB7XG4gICAgICB5ZWFyX21vbnRoOiB5ZWFyTW9udGgsXG4gICAgfSk7XG4gIH1cblxuICAvLyDmnIjjga7nr4Tlm7Ljg4Hjgqfjg4Pjgq/vvIgwMeOAnDEy77yJXG4gIGNvbnN0IFssIG1vbnRoU3RyXSA9IHllYXJNb250aC5zcGxpdCgnLScpO1xuICBjb25zdCBtb250aCA9IE51bWJlcihtb250aFN0cik7XG4gIGlmIChtb250aCA8IDEgfHwgbW9udGggPiAxMikge1xuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoYEludmFsaWQgbW9udGg6ICR7bW9udGh9LiBNb250aCBtdXN0IGJlIGJldHdlZW4gMDEgYW5kIDEyLmAsIHtcbiAgICAgIHllYXJfbW9udGg6IHllYXJNb250aCxcbiAgICAgIG1vbnRoLFxuICAgIH0pO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=