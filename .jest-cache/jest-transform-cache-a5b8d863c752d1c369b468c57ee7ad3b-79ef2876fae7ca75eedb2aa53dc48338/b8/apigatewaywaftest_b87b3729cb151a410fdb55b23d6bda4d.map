{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\cdk\\__tests__\\api-gateway-waf.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\cdk\\__tests__\\api-gateway-waf.test.ts"],"sourcesContent":["/**\r\n * API Gateway + WAF構造の検証テスト\r\n * \r\n * このテストは、API GatewayとAWS WAFが正しく設定されていることを検証します。\r\n * \r\n * Requirements:\r\n * - 要件11.1: API認証（APIキー認証）\r\n * - 要件11.2: 使用量プラン設定\r\n * - 要件13.1: WAF保護（レート制限、マネージドルール）\r\n * \r\n * Test Coverage:\r\n * - API Gatewayが正しく作成されていることを確認\r\n * - APIキー認証が有効化されていることを確認\r\n * - 使用量プランが設定されていることを確認\r\n * - CORS設定が正しいことを確認\r\n * - WAFが関連付けられていることを確認\r\n * - WAFルールが正しく設定されていることを確認\r\n */\r\n\r\nimport * as cdk from 'aws-cdk-lib';\r\nimport { Template, Match } from 'aws-cdk-lib/assertions';\r\nimport { TdnetDataCollectorStack } from '../lib/tdnet-data-collector-stack';\r\n\r\ndescribe('API Gateway + WAF構造の検証', () => {\r\n  let template: Template;\r\n\r\n  beforeAll(() => {\r\n    const app = new cdk.App();\r\n    const stack = new TdnetDataCollectorStack(app, 'TestStack', {\r\n      env: {\r\n        account: '123456789012',\r\n        region: 'ap-northeast-1',\r\n      },\r\n    });\r\n    template = Template.fromStack(stack);\r\n  });\r\n\r\n  describe('API Gateway REST API', () => {\r\n    it('REST APIが作成されていること', () => {\r\n      template.hasResourceProperties('AWS::ApiGateway::RestApi', {\r\n        Name: 'tdnet-data-collector-api',\r\n        Description: 'TDnet Data Collector REST API',\r\n      });\r\n    });\r\n\r\n    it('デプロイメント設定が正しいこと', () => {\r\n      template.hasResourceProperties('AWS::ApiGateway::Deployment', {\r\n        Description: Match.anyValue(),\r\n      });\r\n\r\n      template.hasResourceProperties('AWS::ApiGateway::Stage', {\r\n        StageName: 'prod',\r\n        ThrottlingRateLimit: 100,\r\n        ThrottlingBurstLimit: 200,\r\n        MethodSettings: Match.arrayWith([\r\n          Match.objectLike({\r\n            LoggingLevel: 'INFO',\r\n            DataTraceEnabled: true,\r\n            MetricsEnabled: true,\r\n          }),\r\n        ]),\r\n      });\r\n    });\r\n\r\n    it('CORS設定が有効化されていること', () => {\r\n      // OPTIONSメソッドが存在することを確認\r\n      template.hasResourceProperties('AWS::ApiGateway::Method', {\r\n        HttpMethod: 'OPTIONS',\r\n        Integration: Match.objectLike({\r\n          Type: 'MOCK',\r\n          IntegrationResponses: Match.arrayWith([\r\n            Match.objectLike({\r\n              ResponseParameters: Match.objectLike({\r\n                'method.response.header.Access-Control-Allow-Headers': Match.stringLikeRegexp('.*X-Api-Key.*'),\r\n                'method.response.header.Access-Control-Allow-Methods': Match.anyValue(),\r\n                'method.response.header.Access-Control-Allow-Origin': Match.anyValue(),\r\n              }),\r\n            }),\r\n          ]),\r\n        }),\r\n      });\r\n    });\r\n\r\n    it('CloudWatch Logsロールが設定されていること', () => {\r\n      template.hasResourceProperties('AWS::ApiGateway::Account', {\r\n        CloudWatchRoleArn: Match.anyValue(),\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('API Key認証', () => {\r\n    it('APIキーが作成されていること', () => {\r\n      template.hasResourceProperties('AWS::ApiGateway::ApiKey', {\r\n        Name: 'tdnet-api-key',\r\n        Description: 'API Key for TDnet Data Collector',\r\n        Enabled: true,\r\n      });\r\n    });\r\n\r\n    it('使用量プランが作成されていること', () => {\r\n      template.hasResourceProperties('AWS::ApiGateway::UsagePlan', {\r\n        UsagePlanName: 'tdnet-usage-plan',\r\n        Description: 'Usage plan for TDnet Data Collector API',\r\n        Throttle: {\r\n          RateLimit: 100,\r\n          BurstLimit: 200,\r\n        },\r\n        Quota: {\r\n          Limit: 10000,\r\n          Period: 'MONTH',\r\n        },\r\n      });\r\n    });\r\n\r\n    it('APIキーが使用量プランに関連付けられていること', () => {\r\n      template.hasResourceProperties('AWS::ApiGateway::UsagePlanKey', {\r\n        KeyType: 'API_KEY',\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('AWS WAF設定', () => {\r\n    it('Web ACLが作成されていること', () => {\r\n      template.hasResourceProperties('AWS::WAFv2::WebACL', {\r\n        Name: 'tdnet-web-acl',\r\n        Scope: 'REGIONAL',\r\n        DefaultAction: { Allow: {} },\r\n        Description: 'Web ACL for TDnet Data Collector API',\r\n        VisibilityConfig: {\r\n          SampledRequestsEnabled: true,\r\n          CloudWatchMetricsEnabled: true,\r\n          MetricName: 'TdnetWebAcl',\r\n        },\r\n      });\r\n    });\r\n\r\n    it('レート制限ルールが設定されていること', () => {\r\n      template.hasResourceProperties('AWS::WAFv2::WebACL', {\r\n        Rules: Match.arrayWith([\r\n          Match.objectLike({\r\n            Name: 'RateLimitRule',\r\n            Priority: 1,\r\n            Statement: {\r\n              RateBasedStatement: {\r\n                Limit: 2000, // 5分間で2000リクエスト\r\n                AggregateKeyType: 'IP',\r\n              },\r\n            },\r\n            Action: {\r\n              Block: {\r\n                CustomResponse: {\r\n                  ResponseCode: 429,\r\n                  CustomResponseBodyKey: 'RateLimitExceeded',\r\n                },\r\n              },\r\n            },\r\n            VisibilityConfig: {\r\n              SampledRequestsEnabled: true,\r\n              CloudWatchMetricsEnabled: true,\r\n              MetricName: 'RateLimitRule',\r\n            },\r\n          }),\r\n        ]),\r\n      });\r\n    });\r\n\r\n    it('AWSマネージドルール（Common Rule Set）が適用されていること', () => {\r\n      template.hasResourceProperties('AWS::WAFv2::WebACL', {\r\n        Rules: Match.arrayWith([\r\n          Match.objectLike({\r\n            Name: 'AWSManagedRulesCommonRuleSet',\r\n            Priority: 2,\r\n            Statement: {\r\n              ManagedRuleGroupStatement: {\r\n                VendorName: 'AWS',\r\n                Name: 'AWSManagedRulesCommonRuleSet',\r\n              },\r\n            },\r\n            OverrideAction: { None: {} },\r\n          }),\r\n        ]),\r\n      });\r\n    });\r\n\r\n    it('AWSマネージドルール（Known Bad Inputs）が適用されていること', () => {\r\n      template.hasResourceProperties('AWS::WAFv2::WebACL', {\r\n        Rules: Match.arrayWith([\r\n          Match.objectLike({\r\n            Name: 'AWSManagedRulesKnownBadInputsRuleSet',\r\n            Priority: 3,\r\n            Statement: {\r\n              ManagedRuleGroupStatement: {\r\n                VendorName: 'AWS',\r\n                Name: 'AWSManagedRulesKnownBadInputsRuleSet',\r\n              },\r\n            },\r\n            OverrideAction: { None: {} },\r\n          }),\r\n        ]),\r\n      });\r\n    });\r\n\r\n    it('カスタムレスポンスボディが設定されていること', () => {\r\n      template.hasResourceProperties('AWS::WAFv2::WebACL', {\r\n        CustomResponseBodies: {\r\n          RateLimitExceeded: {\r\n            ContentType: 'APPLICATION_JSON',\r\n            Content: Match.stringLikeRegexp('.*RATE_LIMIT_EXCEEDED.*'),\r\n          },\r\n        },\r\n      });\r\n    });\r\n\r\n    it('WAFがAPI Gatewayに関連付けられていること', () => {\r\n      template.hasResourceProperties('AWS::WAFv2::WebACLAssociation', {\r\n        ResourceArn: Match.anyValue(),\r\n        WebAclArn: Match.anyValue(),\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('CloudFormation Outputs', () => {\r\n    it('API Endpointが出力されていること', () => {\r\n      template.hasOutput('ApiEndpoint', {\r\n        Description: 'API Gateway endpoint URL',\r\n        Export: {\r\n          Name: 'TdnetApiEndpoint',\r\n        },\r\n      });\r\n    });\r\n\r\n    it('API Key IDが出力されていること', () => {\r\n      template.hasOutput('ApiKeyId', {\r\n        Description: 'API Key ID',\r\n        Export: {\r\n          Name: 'TdnetApiKeyId',\r\n        },\r\n      });\r\n    });\r\n\r\n    it('Web ACL ARNが出力されていること', () => {\r\n      template.hasOutput('WebAclArn', {\r\n        Description: 'WAF Web ACL ARN',\r\n        Export: {\r\n          Name: 'TdnetWebAclArn',\r\n        },\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('セキュリティ設定', () => {\r\n    it('API Gatewayのログが有効化されていること', () => {\r\n      template.hasResourceProperties('AWS::ApiGateway::Stage', {\r\n        MethodSettings: Match.arrayWith([\r\n          Match.objectLike({\r\n            LoggingLevel: 'INFO',\r\n            DataTraceEnabled: true,\r\n          }),\r\n        ]),\r\n      });\r\n    });\r\n\r\n    it('スロットリング設定が有効化されていること', () => {\r\n      template.hasResourceProperties('AWS::ApiGateway::Stage', {\r\n        ThrottlingRateLimit: 100,\r\n        ThrottlingBurstLimit: 200,\r\n      });\r\n    });\r\n\r\n    it('使用量プランにクォータが設定されていること', () => {\r\n      template.hasResourceProperties('AWS::ApiGateway::UsagePlan', {\r\n        Quota: {\r\n          Limit: 10000,\r\n          Period: 'MONTH',\r\n        },\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('パフォーマンス設定', () => {\r\n    it('API Gatewayメトリクスが有効化されていること', () => {\r\n      template.hasResourceProperties('AWS::ApiGateway::Stage', {\r\n        MethodSettings: Match.arrayWith([\r\n          Match.objectLike({\r\n            MetricsEnabled: true,\r\n          }),\r\n        ]),\r\n      });\r\n    });\r\n\r\n    it('WAFメトリクスが有効化されていること', () => {\r\n      template.hasResourceProperties('AWS::WAFv2::WebACL', {\r\n        VisibilityConfig: {\r\n          CloudWatchMetricsEnabled: true,\r\n          MetricName: 'TdnetWebAcl',\r\n        },\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('エラーハンドリング', () => {\r\n    it('レート制限超過時のカスタムレスポンスが設定されていること', () => {\r\n      template.hasResourceProperties('AWS::WAFv2::WebACL', {\r\n        Rules: Match.arrayWith([\r\n          Match.objectLike({\r\n            Name: 'RateLimitRule',\r\n            Action: {\r\n              Block: {\r\n                CustomResponse: {\r\n                  ResponseCode: 429,\r\n                  CustomResponseBodyKey: 'RateLimitExceeded',\r\n                },\r\n              },\r\n            },\r\n          }),\r\n        ]),\r\n      });\r\n    });\r\n\r\n    it('カスタムレスポンスにエラーコードが含まれていること', () => {\r\n      template.hasResourceProperties('AWS::WAFv2::WebACL', {\r\n        CustomResponseBodies: {\r\n          RateLimitExceeded: {\r\n            Content: Match.stringLikeRegexp('.*error_code.*'),\r\n          },\r\n        },\r\n      });\r\n    });\r\n  });\r\n});\r\n"],"version":3}