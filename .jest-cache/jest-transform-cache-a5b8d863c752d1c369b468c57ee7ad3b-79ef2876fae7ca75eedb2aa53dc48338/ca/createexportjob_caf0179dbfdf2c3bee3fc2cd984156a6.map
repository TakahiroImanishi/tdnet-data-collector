{"version":3,"names":["cov_v7sgsnt3z","path","hash","global","Function","gcv","coverageData","statementMap","start","line","column","end","fnMap","name","decl","loc","branchMap","type","locations","s","f","b","inputSourceMap","file","mappings","names","sources","sourcesContent","version","_coverageSchema","coverage","actualCoverage","exports","createExportJob","client_dynamodb_1","require","logger_1","retry_1","dynamoClient","DynamoDBClient","region","process","env","AWS_REGION","AWS_ENDPOINT_URL","endpoint","EXPORT_STATUS_TABLE","EXPORT_STATUS_TABLE_NAME","requestBody","requestId","export_id","generateExportId","requested_at","Date","toISOString","ttl","Math","floor","now","exportStatus","status","progress","format","filter","JSON","stringify","logger","info","retryWithBackoff","send","PutItemCommand","TableName","Item","S","N","String","ConditionExpression","maxRetries","initialDelay","backoffMultiplier","jitter","shouldRetry","error","timestamp","random","toString","substring","requestIdPrefix"],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\create-export-job.ts"],"sourcesContent":["/**\r\n * エクスポートジョブ作成\r\n *\r\n * エクスポートIDを生成し、実行状態をDynamoDBに保存します。\r\n *\r\n * Requirements: 要件5.1（エクスポート）\r\n */\r\n\r\nimport { DynamoDBClient, PutItemCommand } from '@aws-sdk/client-dynamodb';\r\nimport { logger } from '../../utils/logger';\r\nimport { retryWithBackoff } from '../../utils/retry';\r\nimport { ExportRequestBody, ExportStatusItem } from './types';\r\n\r\n// DynamoDBクライアント（グローバルスコープで初期化）\r\nconst dynamoClient = new DynamoDBClient({\r\n  region: process.env.AWS_REGION || 'ap-northeast-1',\r\n  ...(process.env.AWS_ENDPOINT_URL && {\r\n    endpoint: process.env.AWS_ENDPOINT_URL,\r\n  }),\r\n});\r\n\r\n// 環境変数\r\nconst EXPORT_STATUS_TABLE = process.env.EXPORT_STATUS_TABLE_NAME || 'tdnet-export-status';\r\n\r\n/**\r\n * エクスポートジョブを作成\r\n *\r\n * @param requestBody エクスポートリクエストボディ\r\n * @param requestId リクエストID\r\n * @returns エクスポートステータス\r\n */\r\nexport async function createExportJob(\r\n  requestBody: ExportRequestBody,\r\n  requestId: string\r\n): Promise<ExportStatusItem> {\r\n  // エクスポートIDを生成\r\n  const export_id = generateExportId(requestId);\r\n\r\n  // 現在時刻（ISO 8601形式、UTC）\r\n  const requested_at = new Date().toISOString();\r\n\r\n  // TTL（30日後に自動削除）\r\n  const ttl = Math.floor(Date.now() / 1000) + 30 * 24 * 60 * 60;\r\n\r\n  // エクスポートステータスアイテム\r\n  const exportStatus: ExportStatusItem = {\r\n    export_id,\r\n    status: 'pending',\r\n    requested_at,\r\n    progress: 0,\r\n    ttl,\r\n    format: requestBody.format,\r\n    filter: JSON.stringify(requestBody.filter),\r\n  };\r\n\r\n  logger.info('Creating export job', {\r\n    export_id,\r\n    format: requestBody.format,\r\n    filter: requestBody.filter,\r\n  });\r\n\r\n  // DynamoDBに保存\r\n  await retryWithBackoff(\r\n    async () => {\r\n      await dynamoClient.send(\r\n        new PutItemCommand({\r\n          TableName: EXPORT_STATUS_TABLE,\r\n          Item: {\r\n            export_id: { S: exportStatus.export_id },\r\n            status: { S: exportStatus.status },\r\n            requested_at: { S: exportStatus.requested_at },\r\n            progress: { N: String(exportStatus.progress) },\r\n            ttl: { N: String(exportStatus.ttl) },\r\n            format: { S: exportStatus.format },\r\n            filter: { S: exportStatus.filter },\r\n          },\r\n          ConditionExpression: 'attribute_not_exists(export_id)',\r\n        })\r\n      );\r\n    },\r\n    {\r\n      maxRetries: 3,\r\n      initialDelay: 1000,\r\n      backoffMultiplier: 2,\r\n      jitter: true,\r\n      shouldRetry: (error) => {\r\n        return error.name === 'ProvisionedThroughputExceededException';\r\n      },\r\n    }\r\n  );\r\n\r\n  logger.info('Export job created successfully', {\r\n    export_id,\r\n    status: exportStatus.status,\r\n  });\r\n\r\n  return exportStatus;\r\n}\r\n\r\n/**\r\n * エクスポートIDを生成\r\n *\r\n * フォーマット: export_タイムスタンプ_ランダム文字列_リクエストID先頭8文字\r\n * 例: export_1705305600000_abc123_12345678\r\n *\r\n * @param requestId リクエストID\r\n * @returns エクスポートID\r\n */\r\nfunction generateExportId(requestId: string): string {\r\n  const timestamp = Date.now();\r\n  const random = Math.random().toString(36).substring(2, 8);\r\n  const requestIdPrefix = requestId.substring(0, 8);\r\n  return `export_${timestamp}_${random}_${requestIdPrefix}`;\r\n}\r\n"],"mappings":"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","ignoreList":[]}