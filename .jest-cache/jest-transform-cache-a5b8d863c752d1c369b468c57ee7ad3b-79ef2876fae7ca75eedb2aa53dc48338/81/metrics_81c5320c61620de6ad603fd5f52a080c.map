{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\utils\\metrics.ts","mappings":";AAAA;;;;;;;GAOG;;AAqEH,gCA4CC;AAsBD,0CAaC;AAoBD,8CAQC;AAsBD,0DAcC;AAeD,wDAeC;AAkBD,wEAWC;AAkBD,kEAWC;AAmBD,0EAcC;AA3UD,kEAAoF;AACpF,qCAAkC;AAElC;;GAEG;AACH,MAAM,UAAU,GAAG,IAAI,oCAAgB,CAAC,EAAE,CAAC,CAAC;AAmC5C;;;;;;;;;;;;;;;;;;;;;;;;;GAyBG;AACI,KAAK,UAAU,UAAU,CAC9B,UAAkB,EAClB,KAAa,EACb,UAAyB,EAAE;IAE3B,MAAM,EACJ,SAAS,GAAG,oBAAoB,EAChC,UAAU,GAAG,EAAE,EACf,IAAI,GAAG,OAAO,EACd,SAAS,GAAG,IAAI,IAAI,EAAE,GACvB,GAAG,OAAO,CAAC;IAEZ,IAAI,CAAC;QACH,MAAM,OAAO,GAAG,IAAI,wCAAoB,CAAC;YACvC,SAAS,EAAE,SAAS;YACpB,UAAU,EAAE;gBACV;oBACE,UAAU,EAAE,UAAU;oBACtB,KAAK,EAAE,KAAK;oBACZ,IAAI,EAAE,IAAI;oBACV,SAAS,EAAE,SAAS;oBACpB,UAAU,EAAE,UAAU;iBACvB;aACF;SACF,CAAC,CAAC;QAEH,MAAM,UAAU,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAE/B,eAAM,CAAC,KAAK,CAAC,0BAA0B,EAAE;YACvC,WAAW,EAAE,UAAU;YACvB,KAAK;YACL,SAAS;YACT,UAAU;SACX,CAAC,CAAC;IACL,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,gCAAgC;QAChC,8BAA8B;QAC9B,eAAM,CAAC,IAAI,CAAC,uBAAuB,EAAE;YACnC,WAAW,EAAE,UAAU;YACvB,KAAK;YACL,UAAU,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,CAAC,SAAS;YACvE,aAAa,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC;SACtE,CAAC,CAAC;IACL,CAAC;AACH,CAAC;AAED;;;;;;;;;;;;;;;;;;;GAmBG;AACI,KAAK,UAAU,eAAe,CACnC,KAAY,EACZ,YAAqB;IAErB,MAAM,UAAU,GAAsB;QACpC,EAAE,IAAI,EAAE,WAAW,EAAE,KAAK,EAAE,KAAK,CAAC,WAAW,CAAC,IAAI,EAAE;KACrD,CAAC;IAEF,IAAI,YAAY,EAAE,CAAC;QACjB,UAAU,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,cAAc,EAAE,KAAK,EAAE,YAAY,EAAE,CAAC,CAAC;IACjE,CAAC;IAED,MAAM,UAAU,CAAC,aAAa,EAAE,CAAC,EAAE,EAAE,UAAU,EAAE,CAAC,CAAC;AACrD,CAAC;AAED;;;;;;;;;;;;;;;;;GAiBG;AACI,KAAK,UAAU,iBAAiB,CAAC,YAAqB;IAC3D,MAAM,UAAU,GAAsB,EAAE,CAAC;IAEzC,IAAI,YAAY,EAAE,CAAC;QACjB,UAAU,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,cAAc,EAAE,KAAK,EAAE,YAAY,EAAE,CAAC,CAAC;IACjE,CAAC;IAED,MAAM,UAAU,CAAC,eAAe,EAAE,CAAC,EAAE,EAAE,UAAU,EAAE,CAAC,CAAC;AACvD,CAAC;AAED;;;;;;;;;;;;;;;;;;;GAmBG;AACI,KAAK,UAAU,uBAAuB,CAC3C,aAAqB,EACrB,YAAqB;IAErB,MAAM,UAAU,GAAsB,EAAE,CAAC;IAEzC,IAAI,YAAY,EAAE,CAAC;QACjB,UAAU,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,cAAc,EAAE,KAAK,EAAE,YAAY,EAAE,CAAC,CAAC;IACjE,CAAC;IAED,MAAM,UAAU,CAAC,eAAe,EAAE,aAAa,EAAE;QAC/C,IAAI,EAAE,cAAc;QACpB,UAAU;KACX,CAAC,CAAC;AACL,CAAC;AAED;;;;;;;;;;;;GAYG;AACI,KAAK,UAAU,sBAAsB,CAC1C,OAAe,EACf,MAAc,EACd,YAAqB;IAErB,MAAM,UAAU,GAAsB,EAAE,CAAC;IAEzC,IAAI,YAAY,EAAE,CAAC;QACjB,UAAU,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,cAAc,EAAE,KAAK,EAAE,YAAY,EAAE,CAAC,CAAC;IACjE,CAAC;IAED,MAAM,OAAO,CAAC,GAAG,CAAC;QAChB,UAAU,CAAC,cAAc,EAAE,OAAO,EAAE,EAAE,UAAU,EAAE,CAAC;QACnD,UAAU,CAAC,aAAa,EAAE,MAAM,EAAE,EAAE,UAAU,EAAE,CAAC;KAClD,CAAC,CAAC;AACL,CAAC;AAED;;;;;;;;;;;;;;;GAeG;AACI,KAAK,UAAU,8BAA8B,CAClD,KAAa,EACb,YAAqB;IAErB,MAAM,UAAU,GAAsB,EAAE,CAAC;IAEzC,IAAI,YAAY,EAAE,CAAC;QACjB,UAAU,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,cAAc,EAAE,KAAK,EAAE,YAAY,EAAE,CAAC,CAAC;IACjE,CAAC;IAED,MAAM,UAAU,CAAC,sBAAsB,EAAE,KAAK,EAAE,EAAE,UAAU,EAAE,CAAC,CAAC;AAClE,CAAC;AAED;;;;;;;;;;;;;;;GAeG;AACI,KAAK,UAAU,2BAA2B,CAC/C,KAAa,EACb,YAAqB;IAErB,MAAM,UAAU,GAAsB,EAAE,CAAC;IAEzC,IAAI,YAAY,EAAE,CAAC;QACjB,UAAU,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,cAAc,EAAE,KAAK,EAAE,YAAY,EAAE,CAAC,CAAC;IACjE,CAAC;IAED,MAAM,UAAU,CAAC,mBAAmB,EAAE,KAAK,EAAE,EAAE,UAAU,EAAE,CAAC,CAAC;AAC/D,CAAC;AAED;;;;;;;;;;;;;;;;GAgBG;AACI,KAAK,UAAU,+BAA+B,CACnD,WAAmB,EACnB,YAAqB;IAErB,MAAM,UAAU,GAAsB,EAAE,CAAC;IAEzC,IAAI,YAAY,EAAE,CAAC;QACjB,UAAU,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,cAAc,EAAE,KAAK,EAAE,YAAY,EAAE,CAAC,CAAC;IACjE,CAAC;IAED,MAAM,UAAU,CAAC,uBAAuB,EAAE,WAAW,EAAE;QACrD,IAAI,EAAE,OAAO;QACb,UAAU;KACX,CAAC,CAAC;AACL,CAAC","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\utils\\metrics.ts"],"sourcesContent":["/**\r\n * CloudWatchメトリクス送信ヘルパー\r\n *\r\n * Lambda実装チェックリストの「エラーメトリクス送信」に対応。\r\n * CloudWatch Metricsにカスタムメトリクスを送信します。\r\n *\r\n * Requirements: 要件6.4（エラーメトリクス）\r\n */\r\n\r\nimport { CloudWatchClient, PutMetricDataCommand } from '@aws-sdk/client-cloudwatch';\r\nimport { logger } from './logger';\r\n\r\n/**\r\n * CloudWatchクライアント\r\n */\r\nconst cloudwatch = new CloudWatchClient({});\r\n\r\n/**\r\n * メトリクスディメンション\r\n */\r\nexport interface MetricDimension {\r\n  Name: string;\r\n  Value: string;\r\n}\r\n\r\n/**\r\n * メトリクスオプション\r\n */\r\nexport interface MetricOptions {\r\n  /**\r\n   * メトリクス名前空間（デフォルト: TDnetDataCollector）\r\n   */\r\n  namespace?: string;\r\n\r\n  /**\r\n   * メトリクスディメンション（オプション）\r\n   */\r\n  dimensions?: MetricDimension[];\r\n\r\n  /**\r\n   * メトリクス単位（オプション）\r\n   */\r\n  unit?: 'Count' | 'Seconds' | 'Milliseconds' | 'Bytes';\r\n\r\n  /**\r\n   * タイムスタンプ（オプション、デフォルト: 現在時刻）\r\n   */\r\n  timestamp?: Date;\r\n}\r\n\r\n/**\r\n * CloudWatchにメトリクスを送信\r\n *\r\n * @param metricName メトリクス名\r\n * @param value メトリクス値\r\n * @param options メトリクスオプション\r\n *\r\n * @example\r\n * ```typescript\r\n * // エラーカウントを送信\r\n * await sendMetric('LambdaError', 1, {\r\n *   dimensions: [\r\n *     { Name: 'ErrorType', Value: 'ValidationError' },\r\n *     { Name: 'FunctionName', Value: 'CollectorFunction' },\r\n *   ],\r\n * });\r\n *\r\n * // 実行時間を送信\r\n * await sendMetric('ExecutionTime', 1234, {\r\n *   unit: 'Milliseconds',\r\n *   dimensions: [\r\n *     { Name: 'FunctionName', Value: 'CollectorFunction' },\r\n *   ],\r\n * });\r\n * ```\r\n */\r\nexport async function sendMetric(\r\n  metricName: string,\r\n  value: number,\r\n  options: MetricOptions = {}\r\n): Promise<void> {\r\n  const {\r\n    namespace = 'TDnetDataCollector',\r\n    dimensions = [],\r\n    unit = 'Count',\r\n    timestamp = new Date(),\r\n  } = options;\r\n\r\n  try {\r\n    const command = new PutMetricDataCommand({\r\n      Namespace: namespace,\r\n      MetricData: [\r\n        {\r\n          MetricName: metricName,\r\n          Value: value,\r\n          Unit: unit,\r\n          Timestamp: timestamp,\r\n          Dimensions: dimensions,\r\n        },\r\n      ],\r\n    });\r\n\r\n    await cloudwatch.send(command);\r\n\r\n    logger.debug('Metric sent successfully', {\r\n      metric_name: metricName,\r\n      value,\r\n      namespace,\r\n      dimensions,\r\n    });\r\n  } catch (error) {\r\n    // メトリクス送信失敗はログに記録するが、エラーをスローしない\r\n    // （メトリクス送信失敗でLambda実行を失敗させない）\r\n    logger.warn('Failed to send metric', {\r\n      metric_name: metricName,\r\n      value,\r\n      error_type: error instanceof Error ? error.constructor.name : 'Unknown',\r\n      error_message: error instanceof Error ? error.message : String(error),\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * エラーメトリクスを送信\r\n *\r\n * Lambda実装チェックリストに準拠したエラーメトリクス送信。\r\n *\r\n * @param error エラーオブジェクト\r\n * @param functionName Lambda関数名（オプション）\r\n *\r\n * @example\r\n * ```typescript\r\n * export async function handler(event: any, context: any) {\r\n *   try {\r\n *     await operation();\r\n *   } catch (error) {\r\n *     await sendErrorMetric(error, context.functionName);\r\n *     throw error;\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport async function sendErrorMetric(\r\n  error: Error,\r\n  functionName?: string\r\n): Promise<void> {\r\n  const dimensions: MetricDimension[] = [\r\n    { Name: 'ErrorType', Value: error.constructor.name },\r\n  ];\r\n\r\n  if (functionName) {\r\n    dimensions.push({ Name: 'FunctionName', Value: functionName });\r\n  }\r\n\r\n  await sendMetric('LambdaError', 1, { dimensions });\r\n}\r\n\r\n/**\r\n * 成功メトリクスを送信\r\n *\r\n * @param functionName Lambda関数名（オプション）\r\n *\r\n * @example\r\n * ```typescript\r\n * export async function handler(event: any, context: any) {\r\n *   try {\r\n *     await operation();\r\n *     await sendSuccessMetric(context.functionName);\r\n *   } catch (error) {\r\n *     await sendErrorMetric(error, context.functionName);\r\n *     throw error;\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport async function sendSuccessMetric(functionName?: string): Promise<void> {\r\n  const dimensions: MetricDimension[] = [];\r\n\r\n  if (functionName) {\r\n    dimensions.push({ Name: 'FunctionName', Value: functionName });\r\n  }\r\n\r\n  await sendMetric('LambdaSuccess', 1, { dimensions });\r\n}\r\n\r\n/**\r\n * 実行時間メトリクスを送信\r\n *\r\n * @param executionTime 実行時間（ミリ秒）\r\n * @param functionName Lambda関数名（オプション）\r\n *\r\n * @example\r\n * ```typescript\r\n * export async function handler(event: any, context: any) {\r\n *   const startTime = Date.now();\r\n *   try {\r\n *     await operation();\r\n *     const executionTime = Date.now() - startTime;\r\n *     await sendExecutionTimeMetric(executionTime, context.functionName);\r\n *   } catch (error) {\r\n *     throw error;\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport async function sendExecutionTimeMetric(\r\n  executionTime: number,\r\n  functionName?: string\r\n): Promise<void> {\r\n  const dimensions: MetricDimension[] = [];\r\n\r\n  if (functionName) {\r\n    dimensions.push({ Name: 'FunctionName', Value: functionName });\r\n  }\r\n\r\n  await sendMetric('ExecutionTime', executionTime, {\r\n    unit: 'Milliseconds',\r\n    dimensions,\r\n  });\r\n}\r\n\r\n/**\r\n * バッチ処理結果メトリクスを送信\r\n *\r\n * @param success 成功件数\r\n * @param failed 失敗件数\r\n * @param functionName Lambda関数名（オプション）\r\n *\r\n * @example\r\n * ```typescript\r\n * const results = { success: 95, failed: 5 };\r\n * await sendBatchResultMetrics(results.success, results.failed, context.functionName);\r\n * ```\r\n */\r\nexport async function sendBatchResultMetrics(\r\n  success: number,\r\n  failed: number,\r\n  functionName?: string\r\n): Promise<void> {\r\n  const dimensions: MetricDimension[] = [];\r\n\r\n  if (functionName) {\r\n    dimensions.push({ Name: 'FunctionName', Value: functionName });\r\n  }\r\n\r\n  await Promise.all([\r\n    sendMetric('BatchSuccess', success, { dimensions }),\r\n    sendMetric('BatchFailed', failed, { dimensions }),\r\n  ]);\r\n}\r\n\r\n/**\r\n * 開示情報収集成功メトリクスを送信\r\n *\r\n * 日次収集件数を記録します。\r\n *\r\n * @param count 収集成功件数\r\n * @param functionName Lambda関数名(オプション)\r\n *\r\n * @example\r\n * ```typescript\r\n * // 収集完了時に送信\r\n * await sendDisclosuresCollectedMetric(150, context.functionName);\r\n * ```\r\n *\r\n * Requirements: 要件12.1（監視）\r\n */\r\nexport async function sendDisclosuresCollectedMetric(\r\n  count: number,\r\n  functionName?: string\r\n): Promise<void> {\r\n  const dimensions: MetricDimension[] = [];\r\n\r\n  if (functionName) {\r\n    dimensions.push({ Name: 'FunctionName', Value: functionName });\r\n  }\r\n\r\n  await sendMetric('DisclosuresCollected', count, { dimensions });\r\n}\r\n\r\n/**\r\n * 開示情報収集失敗メトリクスを送信\r\n *\r\n * 失敗件数を記録します。\r\n *\r\n * @param count 収集失敗件数\r\n * @param functionName Lambda関数名(オプション)\r\n *\r\n * @example\r\n * ```typescript\r\n * // 収集完了時に送信\r\n * await sendDisclosuresFailedMetric(5, context.functionName);\r\n * ```\r\n *\r\n * Requirements: 要件12.1（監視）\r\n */\r\nexport async function sendDisclosuresFailedMetric(\r\n  count: number,\r\n  functionName?: string\r\n): Promise<void> {\r\n  const dimensions: MetricDimension[] = [];\r\n\r\n  if (functionName) {\r\n    dimensions.push({ Name: 'FunctionName', Value: functionName });\r\n  }\r\n\r\n  await sendMetric('DisclosuresFailed', count, { dimensions });\r\n}\r\n\r\n/**\r\n * 開示情報収集成功率メトリクスを送信\r\n *\r\n * 成功率（パーセンテージ）を記録します。\r\n *\r\n * @param successRate 成功率（0-100）\r\n * @param functionName Lambda関数名(オプション)\r\n *\r\n * @example\r\n * ```typescript\r\n * // 収集完了時に送信\r\n * const successRate = (collected / (collected + failed)) * 100;\r\n * await sendCollectionSuccessRateMetric(successRate, context.functionName);\r\n * ```\r\n *\r\n * Requirements: 要件12.1（監視）\r\n */\r\nexport async function sendCollectionSuccessRateMetric(\r\n  successRate: number,\r\n  functionName?: string\r\n): Promise<void> {\r\n  const dimensions: MetricDimension[] = [];\r\n\r\n  if (functionName) {\r\n    dimensions.push({ Name: 'FunctionName', Value: functionName });\r\n  }\r\n\r\n  await sendMetric('CollectionSuccessRate', successRate, {\r\n    unit: 'Count',\r\n    dimensions,\r\n  });\r\n}\r\n"],"version":3}