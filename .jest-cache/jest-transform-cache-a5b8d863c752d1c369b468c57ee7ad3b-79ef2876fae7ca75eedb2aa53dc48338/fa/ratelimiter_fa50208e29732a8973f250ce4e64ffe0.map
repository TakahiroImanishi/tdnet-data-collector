{"version":3,"names":["cov_29cznk85ar","path","hash","global","Function","gcv","coverageData","statementMap","start","line","column","end","fnMap","name","decl","loc","branchMap","type","locations","undefined","s","f","b","inputSourceMap","file","mappings","names","sources","sourcesContent","version","_coverageSchema","coverage","actualCoverage","logger_1","require","RateLimiter","lastRequestTime","minDelayMs","constructor","options","waitIfNeeded","Date","now","logger","debug","elapsed","delay","waitTime","Promise","resolve","setTimeout","reset","getMinDelayMs","getLastRequestTime","exports"],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\utils\\rate-limiter.ts"],"sourcesContent":["/**\r\n * RateLimiter - リクエストレート制限クラス\r\n * \r\n * TDnetへのリクエストを適切に制限し、過度な負荷をかけないようにする。\r\n * 連続リクエスト間で最小遅延時間を確保する。\r\n * \r\n * Steering準拠:\r\n * - development/tdnet-scraping-patterns.md: レート制限実装パターン\r\n * - core/error-handling-patterns.md: 構造化ログの記録\r\n * \r\n * @example\r\n * ```typescript\r\n * const rateLimiter = new RateLimiter({ minDelayMs: 2000 });\r\n * \r\n * for (const url of urls) {\r\n *     await rateLimiter.waitIfNeeded();\r\n *     const data = await fetchData(url);\r\n * }\r\n * ```\r\n */\r\n\r\nimport { logger } from './logger';\r\n\r\n/**\r\n * RateLimiterのオプション\r\n */\r\nexport interface RateLimiterOptions {\r\n    /**\r\n     * 最小遅延時間（ミリ秒）\r\n     * @default 2000\r\n     */\r\n    minDelayMs: number;\r\n}\r\n\r\n/**\r\n * レート制限を管理するクラス\r\n * \r\n * 連続リクエスト間で最小遅延時間を確保し、\r\n * 外部サービスへの過度な負荷を防ぐ。\r\n */\r\nexport class RateLimiter {\r\n    private lastRequestTime: number | null = null;\r\n    private minDelayMs: number;\r\n\r\n    /**\r\n     * RateLimiterを初期化\r\n     * \r\n     * @param options - レート制限のオプション\r\n     */\r\n    constructor(options: RateLimiterOptions = { minDelayMs: 2000 }) {\r\n        this.minDelayMs = options.minDelayMs;\r\n    }\r\n\r\n    /**\r\n     * リクエスト前に呼び出し、必要に応じて待機する\r\n     * \r\n     * 最後のリクエストから最小遅延時間が経過していない場合、\r\n     * 残り時間だけ待機する。\r\n     * \r\n     * Steering準拠: 構造化ログを記録（development/tdnet-scraping-patterns.md）\r\n     * \r\n     * @returns Promise<void>\r\n     * \r\n     * @example\r\n     * ```typescript\r\n     * const rateLimiter = new RateLimiter({ minDelayMs: 2000 });\r\n     * \r\n     * await rateLimiter.waitIfNeeded(); // 最初のリクエスト（即座に実行）\r\n     * await rateLimiter.waitIfNeeded(); // 2回目のリクエスト（2000ms待機）\r\n     * ```\r\n     */\r\n    async waitIfNeeded(): Promise<void> {\r\n        if (this.lastRequestTime === null) {\r\n            // 最初のリクエストは即座に実行\r\n            this.lastRequestTime = Date.now();\r\n            logger.debug('Rate limiter: first request, no delay');\r\n            return;\r\n        }\r\n\r\n        const elapsed = Date.now() - this.lastRequestTime;\r\n        const delay = this.minDelayMs - elapsed;\r\n\r\n        if (delay > 0) {\r\n            // 最小遅延時間が経過していない場合、残り時間だけ待機\r\n            logger.debug('Rate limiting: waiting', {\r\n                waitTime: delay,\r\n                minDelayMs: this.minDelayMs,\r\n                elapsed,\r\n            });\r\n            await new Promise(resolve => setTimeout(resolve, delay));\r\n        }\r\n\r\n        this.lastRequestTime = Date.now();\r\n    }\r\n\r\n    /**\r\n     * 最後のリクエスト時刻をリセット\r\n     * \r\n     * リセット後の最初のリクエストは即座に実行される。\r\n     * \r\n     * @example\r\n     * ```typescript\r\n     * const rateLimiter = new RateLimiter({ minDelayMs: 2000 });\r\n     * \r\n     * await rateLimiter.waitIfNeeded(); // 最初のリクエスト\r\n     * rateLimiter.reset(); // リセット\r\n     * await rateLimiter.waitIfNeeded(); // リセット後の最初のリクエスト（即座に実行）\r\n     * ```\r\n     */\r\n    reset(): void {\r\n        this.lastRequestTime = null;\r\n    }\r\n\r\n    /**\r\n     * 最小遅延時間を取得\r\n     * \r\n     * @returns 最小遅延時間（ミリ秒）\r\n     */\r\n    getMinDelayMs(): number {\r\n        return this.minDelayMs;\r\n    }\r\n\r\n    /**\r\n     * 最後のリクエスト時刻を取得\r\n     * \r\n     * @returns 最後のリクエスト時刻（Unix時刻）、またはnull（リクエスト未実行）\r\n     */\r\n    getLastRequestTime(): number | null {\r\n        return this.lastRequestTime;\r\n    }\r\n}\r\n"],"mappings":"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","ignoreList":[]}