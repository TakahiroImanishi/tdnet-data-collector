1b795e120245b91cefa8e927d5adfea2
"use strict";
/**
 * generate-signed-url.ts のユニットテスト
 *
 * ブランチカバレッジ目標: 80%以上
 * 現状: 40% (2/5ブランチ)
 * 目標: 80%+ (4/5ブランチ以上)
 */
Object.defineProperty(exports, "__esModule", { value: true });
// モック
jest.mock('@aws-sdk/client-s3');
jest.mock('@aws-sdk/s3-request-presigner');
jest.mock('../../../utils/logger');
const generate_signed_url_1 = require("../generate-signed-url");
const client_s3_1 = require("@aws-sdk/client-s3");
const s3_request_presigner_1 = require("@aws-sdk/s3-request-presigner");
const logger_1 = require("../../../utils/logger");
describe('generateSignedUrl', () => {
    const mockGetSignedUrl = s3_request_presigner_1.getSignedUrl;
    const mockLogger = logger_1.logger;
    beforeEach(() => {
        jest.clearAllMocks();
        // デフォルトのモック設定
        mockGetSignedUrl.mockResolvedValue('https://s3.amazonaws.com/signed-url');
        mockLogger.info = jest.fn();
        mockLogger.error = jest.fn();
    });
    describe('正常系', () => {
        it('署名付きURLを生成できること', async () => {
            const s3Key = 'exports/test-export.json';
            const expectedUrl = 'https://s3.amazonaws.com/signed-url';
            mockGetSignedUrl.mockResolvedValue(expectedUrl);
            const result = await (0, generate_signed_url_1.generateSignedUrl)(s3Key);
            expect(result).toBe(expectedUrl);
            expect(mockLogger.info).toHaveBeenCalledWith('Generating signed URL', {
                s3_key: s3Key,
                expires_in: 7 * 24 * 60 * 60,
            });
            expect(mockLogger.info).toHaveBeenCalledWith('Signed URL generated successfully', {
                s3_key: s3Key,
                signed_url: expectedUrl,
            });
        });
        it('カスタム有効期限で署名付きURLを生成できること', async () => {
            const s3Key = 'exports/test-export.json';
            const customExpiry = 3600; // 1時間
            const expectedUrl = 'https://s3.amazonaws.com/signed-url-custom';
            mockGetSignedUrl.mockResolvedValue(expectedUrl);
            const result = await (0, generate_signed_url_1.generateSignedUrl)(s3Key, customExpiry);
            expect(result).toBe(expectedUrl);
            expect(mockLogger.info).toHaveBeenCalledWith('Generating signed URL', {
                s3_key: s3Key,
                expires_in: customExpiry,
            });
        });
        it('デフォルト有効期限（7日間）が適用されること', async () => {
            const s3Key = 'exports/test-export.json';
            await (0, generate_signed_url_1.generateSignedUrl)(s3Key);
            expect(mockGetSignedUrl).toHaveBeenCalledWith(expect.any(client_s3_1.S3Client), expect.any(client_s3_1.GetObjectCommand), { expiresIn: 7 * 24 * 60 * 60 });
        });
    });
    describe('環境変数', () => {
        it('EXPORT_BUCKET_NAME環境変数がデフォルト値を持つこと', async () => {
            // デフォルト値 'tdnet-exports' が使用されることを確認
            const s3Key = 'test-key';
            await (0, generate_signed_url_1.generateSignedUrl)(s3Key);
            // GetObjectCommandが呼ばれたことを確認（バケット名はモジュール初期化時に決定）
            expect(mockGetSignedUrl).toHaveBeenCalled();
        });
        it('AWS_REGIONのデフォルト値が ap-northeast-1 であること', async () => {
            // S3Clientがデフォルトリージョンで初期化されることを確認
            const s3Key = 'test-key';
            await (0, generate_signed_url_1.generateSignedUrl)(s3Key);
            // 関数が正常に実行されることを確認
            expect(mockGetSignedUrl).toHaveBeenCalled();
        });
    });
    describe('エラーハンドリング', () => {
        it('getSignedUrlがエラーをスローした場合、エラーが伝播すること', async () => {
            const s3Key = 'exports/test-export.json';
            const error = new Error('S3 access denied');
            mockGetSignedUrl.mockRejectedValue(error);
            await expect((0, generate_signed_url_1.generateSignedUrl)(s3Key)).rejects.toThrow('S3 access denied');
        });
        it('S3Clientエラー時にエラーが伝播すること', async () => {
            const s3Key = 'exports/test-export.json';
            const error = new Error('Network error');
            mockGetSignedUrl.mockRejectedValue(error);
            await expect((0, generate_signed_url_1.generateSignedUrl)(s3Key)).rejects.toThrow('Network error');
        });
        it('無効なS3キーでもエラーハンドリングされること', async () => {
            const invalidKey = '';
            const error = new Error('Invalid S3 key');
            mockGetSignedUrl.mockRejectedValue(error);
            await expect((0, generate_signed_url_1.generateSignedUrl)(invalidKey)).rejects.toThrow('Invalid S3 key');
        });
    });
    describe('境界値テスト', () => {
        it('有効期限が0秒の場合でも処理できること', async () => {
            const s3Key = 'exports/test-export.json';
            const zeroExpiry = 0;
            await (0, generate_signed_url_1.generateSignedUrl)(s3Key, zeroExpiry);
            expect(mockGetSignedUrl).toHaveBeenCalledWith(expect.any(client_s3_1.S3Client), expect.any(client_s3_1.GetObjectCommand), { expiresIn: zeroExpiry });
        });
        it('有効期限が最大値（7日間）の場合でも処理できること', async () => {
            const s3Key = 'exports/test-export.json';
            const maxExpiry = 7 * 24 * 60 * 60;
            await (0, generate_signed_url_1.generateSignedUrl)(s3Key, maxExpiry);
            expect(mockGetSignedUrl).toHaveBeenCalledWith(expect.any(client_s3_1.S3Client), expect.any(client_s3_1.GetObjectCommand), { expiresIn: maxExpiry });
        });
        it('長いS3キーでも処理できること', async () => {
            const longKey = 'exports/' + 'a'.repeat(1000) + '.json';
            await (0, generate_signed_url_1.generateSignedUrl)(longKey);
            expect(mockGetSignedUrl).toHaveBeenCalled();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGV4cG9ydFxcX190ZXN0c19fXFxnZW5lcmF0ZS1zaWduZWQtdXJsLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7R0FNRzs7QUFPSCxNQUFNO0FBQ04sSUFBSSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBQ2hDLElBQUksQ0FBQyxJQUFJLENBQUMsK0JBQStCLENBQUMsQ0FBQztBQUMzQyxJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFSbkMsZ0VBQTJEO0FBQzNELGtEQUFnRTtBQUNoRSx3RUFBNkQ7QUFDN0Qsa0RBQStDO0FBTy9DLFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUU7SUFDakMsTUFBTSxnQkFBZ0IsR0FBRyxtQ0FBd0QsQ0FBQztJQUNsRixNQUFNLFVBQVUsR0FBRyxlQUFvQyxDQUFDO0lBRXhELFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFFckIsY0FBYztRQUNkLGdCQUFnQixDQUFDLGlCQUFpQixDQUFDLHFDQUFxQyxDQUFDLENBQUM7UUFDMUUsVUFBVSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDNUIsVUFBVSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDL0IsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRTtRQUNuQixFQUFFLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDL0IsTUFBTSxLQUFLLEdBQUcsMEJBQTBCLENBQUM7WUFDekMsTUFBTSxXQUFXLEdBQUcscUNBQXFDLENBQUM7WUFFMUQsZ0JBQWdCLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFaEQsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFBLHVDQUFp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W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGV4cG9ydFxcX190ZXN0c19fXFxnZW5lcmF0ZS1zaWduZWQtdXJsLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIGdlbmVyYXRlLXNpZ25lZC11cmwudHMg44Gu44Om44OL44OD44OI44OG44K544OIXHJcbiAqXHJcbiAqIOODluODqeODs+ODgeOCq+ODkOODrOODg+OCuOebruaomTogODAl5Lul5LiKXHJcbiAqIOePvueKtjogNDAlICgyLzXjg5bjg6njg7Pjg4EpXHJcbiAqIOebruaomTogODAlKyAoNC8144OW44Op44Oz44OB5Lul5LiKKVxyXG4gKi9cclxuXHJcbmltcG9ydCB7IGdlbmVyYXRlU2lnbmVkVXJsIH0gZnJvbSAnLi4vZ2VuZXJhdGUtc2lnbmVkLXVybCc7XHJcbmltcG9ydCB7IFMzQ2xpZW50LCBHZXRPYmplY3RDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcclxuaW1wb3J0IHsgZ2V0U2lnbmVkVXJsIH0gZnJvbSAnQGF3cy1zZGsvczMtcmVxdWVzdC1wcmVzaWduZXInO1xyXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi8uLi8uLi91dGlscy9sb2dnZXInO1xyXG5cclxuLy8g44Oi44OD44KvXHJcbmplc3QubW9jaygnQGF3cy1zZGsvY2xpZW50LXMzJyk7XHJcbmplc3QubW9jaygnQGF3cy1zZGsvczMtcmVxdWVzdC1wcmVzaWduZXInKTtcclxuamVzdC5tb2NrKCcuLi8uLi8uLi91dGlscy9sb2dnZXInKTtcclxuXHJcbmRlc2NyaWJlKCdnZW5lcmF0ZVNpZ25lZFVybCcsICgpID0+IHtcclxuICBjb25zdCBtb2NrR2V0U2lnbmVkVXJsID0gZ2V0U2lnbmVkVXJsIGFzIGplc3QuTW9ja2VkRnVuY3Rpb248dHlwZW9mIGdldFNpZ25lZFVybD47XHJcbiAgY29uc3QgbW9ja0xvZ2dlciA9IGxvZ2dlciBhcyBqZXN0Lk1vY2tlZDx0eXBlb2YgbG9nZ2VyPjtcclxuXHJcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcclxuICAgIFxyXG4gICAgLy8g44OH44OV44Kp44Or44OI44Gu44Oi44OD44Kv6Kit5a6aXHJcbiAgICBtb2NrR2V0U2lnbmVkVXJsLm1vY2tSZXNvbHZlZFZhbHVlKCdodHRwczovL3MzLmFtYXpvbmF3cy5jb20vc2lnbmVkLXVybCcpO1xyXG4gICAgbW9ja0xvZ2dlci5pbmZvID0gamVzdC5mbigpO1xyXG4gICAgbW9ja0xvZ2dlci5lcnJvciA9IGplc3QuZm4oKTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ+ato+W4uOezuycsICgpID0+IHtcclxuICAgIGl0KCfnvbLlkI3ku5jjgY1VUkzjgpLnlJ/miJDjgafjgY3jgovjgZPjgagnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHMzS2V5ID0gJ2V4cG9ydHMvdGVzdC1leHBvcnQuanNvbic7XHJcbiAgICAgIGNvbnN0IGV4cGVjdGVkVXJsID0gJ2h0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9zaWduZWQtdXJsJztcclxuICAgICAgXHJcbiAgICAgIG1vY2tHZXRTaWduZWRVcmwubW9ja1Jlc29sdmVkVmFsdWUoZXhwZWN0ZWRVcmwpO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2VuZXJhdGVTaWduZWRVcmwoczNLZXkpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZShleHBlY3RlZFVybCk7XHJcbiAgICAgIGV4cGVjdChtb2NrTG9nZ2VyLmluZm8pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdHZW5lcmF0aW5nIHNpZ25lZCBVUkwnLCB7XHJcbiAgICAgICAgczNfa2V5OiBzM0tleSxcclxuICAgICAgICBleHBpcmVzX2luOiA3ICogMjQgKiA2MCAqIDYwLFxyXG4gICAgICB9KTtcclxuICAgICAgZXhwZWN0KG1vY2tMb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ1NpZ25lZCBVUkwgZ2VuZXJhdGVkIHN1Y2Nlc3NmdWxseScsIHtcclxuICAgICAgICBzM19rZXk6IHMzS2V5LFxyXG4gICAgICAgIHNpZ25lZF91cmw6IGV4cGVjdGVkVXJsLFxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCfjgqvjgrnjgr/jg6DmnInlirnmnJ/pmZDjgafnvbLlkI3ku5jjgY1VUkzjgpLnlJ/miJDjgafjgY3jgovjgZPjgagnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHMzS2V5ID0gJ2V4cG9ydHMvdGVzdC1leHBvcnQuanNvbic7XHJcbiAgICAgIGNvbnN0IGN1c3RvbUV4cGlyeSA9IDM2MDA7IC8vIDHmmYLplpNcclxuICAgICAgY29uc3QgZXhwZWN0ZWRVcmwgPSAnaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL3NpZ25lZC11cmwtY3VzdG9tJztcclxuICAgICAgXHJcbiAgICAgIG1vY2tHZXRTaWduZWRVcmwubW9ja1Jlc29sdmVkVmFsdWUoZXhwZWN0ZWRVcmwpO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2VuZXJhdGVTaWduZWRVcmwoczNLZXksIGN1c3RvbUV4cGlyeSk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKGV4cGVjdGVkVXJsKTtcclxuICAgICAgZXhwZWN0KG1vY2tMb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ0dlbmVyYXRpbmcgc2lnbmVkIFVSTCcsIHtcclxuICAgICAgICBzM19rZXk6IHMzS2V5LFxyXG4gICAgICAgIGV4cGlyZXNfaW46IGN1c3RvbUV4cGlyeSxcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgn44OH44OV44Kp44Or44OI5pyJ5Yq55pyf6ZmQ77yIN+aXpemWk++8ieOBjOmBqeeUqOOBleOCjOOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgczNLZXkgPSAnZXhwb3J0cy90ZXN0LWV4cG9ydC5qc29uJztcclxuICAgICAgXHJcbiAgICAgIGF3YWl0IGdlbmVyYXRlU2lnbmVkVXJsKHMzS2V5KTtcclxuXHJcbiAgICAgIGV4cGVjdChtb2NrR2V0U2lnbmVkVXJsKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICBleHBlY3QuYW55KFMzQ2xpZW50KSxcclxuICAgICAgICBleHBlY3QuYW55KEdldE9iamVjdENvbW1hbmQpLFxyXG4gICAgICAgIHsgZXhwaXJlc0luOiA3ICogMjQgKiA2MCAqIDYwIH1cclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgn55Kw5aKD5aSJ5pWwJywgKCkgPT4ge1xyXG4gICAgaXQoJ0VYUE9SVF9CVUNLRVRfTkFNReeSsOWig+WkieaVsOOBjOODh+ODleOCqeODq+ODiOWApOOCkuaMgeOBpOOBk+OBqCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgLy8g44OH44OV44Kp44Or44OI5YCkICd0ZG5ldC1leHBvcnRzJyDjgYzkvb/nlKjjgZXjgozjgovjgZPjgajjgpLnorroqo1cclxuICAgICAgY29uc3QgczNLZXkgPSAndGVzdC1rZXknO1xyXG4gICAgICBcclxuICAgICAgYXdhaXQgZ2VuZXJhdGVTaWduZWRVcmwoczNLZXkpO1xyXG5cclxuICAgICAgLy8gR2V0T2JqZWN0Q29tbWFuZOOBjOWRvOOBsOOCjOOBn+OBk+OBqOOCkueiuuiqje+8iOODkOOCseODg+ODiOWQjeOBr+ODouOCuOODpeODvOODq+WIneacn+WMluaZguOBq+axuuWumu+8iVxyXG4gICAgICBleHBlY3QobW9ja0dldFNpZ25lZFVybCkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ0FXU19SRUdJT07jga7jg4fjg5Xjgqnjg6vjg4jlgKTjgYwgYXAtbm9ydGhlYXN0LTEg44Gn44GC44KL44GT44GoJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAvLyBTM0NsaWVudOOBjOODh+ODleOCqeODq+ODiOODquODvOOCuOODp+ODs+OBp+WIneacn+WMluOBleOCjOOCi+OBk+OBqOOCkueiuuiqjVxyXG4gICAgICBjb25zdCBzM0tleSA9ICd0ZXN0LWtleSc7XHJcbiAgICAgIFxyXG4gICAgICBhd2FpdCBnZW5lcmF0ZVNpZ25lZFVybChzM0tleSk7XHJcblxyXG4gICAgICAvLyDplqLmlbDjgYzmraPluLjjgavlrp/ooYzjgZXjgozjgovjgZPjgajjgpLnorroqo1cclxuICAgICAgZXhwZWN0KG1vY2tHZXRTaWduZWRVcmwpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgn44Ko44Op44O844OP44Oz44OJ44Oq44Oz44KwJywgKCkgPT4ge1xyXG4gICAgaXQoJ2dldFNpZ25lZFVybOOBjOOCqOODqeODvOOCkuOCueODreODvOOBl+OBn+WgtOWQiOOAgeOCqOODqeODvOOBjOS8neaSreOBmeOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgczNLZXkgPSAnZXhwb3J0cy90ZXN0LWV4cG9ydC5qc29uJztcclxuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ1MzIGFjY2VzcyBkZW5pZWQnKTtcclxuICAgICAgXHJcbiAgICAgIG1vY2tHZXRTaWduZWRVcmwubW9ja1JlamVjdGVkVmFsdWUoZXJyb3IpO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KGdlbmVyYXRlU2lnbmVkVXJsKHMzS2V5KSkucmVqZWN0cy50b1Rocm93KCdTMyBhY2Nlc3MgZGVuaWVkJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnUzNDbGllbnTjgqjjg6njg7zmmYLjgavjgqjjg6njg7zjgYzkvJ3mkq3jgZnjgovjgZPjgagnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHMzS2V5ID0gJ2V4cG9ydHMvdGVzdC1leHBvcnQuanNvbic7XHJcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCdOZXR3b3JrIGVycm9yJyk7XHJcbiAgICAgIFxyXG4gICAgICBtb2NrR2V0U2lnbmVkVXJsLm1vY2tSZWplY3RlZFZhbHVlKGVycm9yKTtcclxuXHJcbiAgICAgIGF3YWl0IGV4cGVjdChnZW5lcmF0ZVNpZ25lZFVybChzM0tleSkpLnJlamVjdHMudG9UaHJvdygnTmV0d29yayBlcnJvcicpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ+eEoeWKueOBqlMz44Kt44O844Gn44KC44Ko44Op44O844OP44Oz44OJ44Oq44Oz44Kw44GV44KM44KL44GT44GoJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBpbnZhbGlkS2V5ID0gJyc7XHJcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCdJbnZhbGlkIFMzIGtleScpO1xyXG4gICAgICBcclxuICAgICAgbW9ja0dldFNpZ25lZFVybC5tb2NrUmVqZWN0ZWRWYWx1ZShlcnJvcik7XHJcblxyXG4gICAgICBhd2FpdCBleHBlY3QoZ2VuZXJhdGVTaWduZWRVcmwoaW52YWxpZEtleSkpLnJlamVjdHMudG9UaHJvdygnSW52YWxpZCBTMyBrZXknKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgn5aKD55WM5YCk44OG44K544OIJywgKCkgPT4ge1xyXG4gICAgaXQoJ+acieWKueacn+mZkOOBjDDnp5Ljga7loLTlkIjjgafjgoLlh6bnkIbjgafjgY3jgovjgZPjgagnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHMzS2V5ID0gJ2V4cG9ydHMvdGVzdC1leHBvcnQuanNvbic7XHJcbiAgICAgIGNvbnN0IHplcm9FeHBpcnkgPSAwO1xyXG4gICAgICBcclxuICAgICAgYXdhaXQgZ2VuZXJhdGVTaWduZWRVcmwoczNLZXksIHplcm9FeHBpcnkpO1xyXG5cclxuICAgICAgZXhwZWN0KG1vY2tHZXRTaWduZWRVcmwpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgIGV4cGVjdC5hbnkoUzNDbGllbnQpLFxyXG4gICAgICAgIGV4cGVjdC5hbnkoR2V0T2JqZWN0Q29tbWFuZCksXHJcbiAgICAgICAgeyBleHBpcmVzSW46IHplcm9FeHBpcnkgfVxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ+acieWKueacn+mZkOOBjOacgOWkp+WApO+8iDfml6XplpPvvInjga7loLTlkIjjgafjgoLlh6bnkIbjgafjgY3jgovjgZPjgagnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHMzS2V5ID0gJ2V4cG9ydHMvdGVzdC1leHBvcnQuanNvbic7XHJcbiAgICAgIGNvbnN0IG1heEV4cGlyeSA9IDcgKiAyNCAqIDYwICogNjA7XHJcbiAgICAgIFxyXG4gICAgICBhd2FpdCBnZW5lcmF0ZVNpZ25lZFVybChzM0tleSwgbWF4RXhwaXJ5KTtcclxuXHJcbiAgICAgIGV4cGVjdChtb2NrR2V0U2lnbmVkVXJsKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICBleHBlY3QuYW55KFMzQ2xpZW50KSxcclxuICAgICAgICBleHBlY3QuYW55KEdldE9iamVjdENvbW1hbmQpLFxyXG4gICAgICAgIHsgZXhwaXJlc0luOiBtYXhFeHBpcnkgfVxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ+mVt+OBhFMz44Kt44O844Gn44KC5Yem55CG44Gn44GN44KL44GT44GoJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBsb25nS2V5ID0gJ2V4cG9ydHMvJyArICdhJy5yZXBlYXQoMTAwMCkgKyAnLmpzb24nO1xyXG4gICAgICBcclxuICAgICAgYXdhaXQgZ2VuZXJhdGVTaWduZWRVcmwobG9uZ0tleSk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja0dldFNpZ25lZFVybCkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcbn0pO1xyXG4iXSwidmVyc2lvbiI6M30=