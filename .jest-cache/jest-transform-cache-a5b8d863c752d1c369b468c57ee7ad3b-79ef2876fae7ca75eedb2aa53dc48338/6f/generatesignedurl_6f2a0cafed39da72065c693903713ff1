df4d3779ff9983a7ef63d3daac44060f
"use strict";
/**
 * 署名付きURL生成
 *
 * S3オブジェクトの署名付きURLを生成します（有効期限7日）。
 *
 * Requirements: 要件5.1（エクスポート）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateSignedUrl = generateSignedUrl;
const client_s3_1 = require("@aws-sdk/client-s3");
const s3_request_presigner_1 = require("@aws-sdk/s3-request-presigner");
const logger_1 = require("../../utils/logger");
const errors_1 = require("../../errors");
// S3クライアント（グローバルスコープで初期化）
const s3Client = new client_s3_1.S3Client({ region: process.env.AWS_REGION || 'ap-northeast-1' });
// 環境変数
const EXPORT_BUCKET = process.env.EXPORT_BUCKET_NAME || 'tdnet-exports';
/**
 * 署名付きURLを生成
 *
 * @param s3_key S3キー
 * @param expiresIn 有効期限（秒）
 * @returns 署名付きURL
 * @throws {RetryableError} S3アクセスエラー時
 */
async function generateSignedUrl(s3_key, expiresIn = 7 * 24 * 60 * 60 // デフォルト: 7日間
) {
    try {
        logger_1.logger.info('Generating signed URL', {
            s3_key,
            expires_in: expiresIn,
        });
        // GetObjectCommandを作成
        const command = new client_s3_1.GetObjectCommand({
            Bucket: EXPORT_BUCKET,
            Key: s3_key,
        });
        // 署名付きURLを生成
        const signedUrl = await (0, s3_request_presigner_1.getSignedUrl)(s3Client, command, { expiresIn });
        logger_1.logger.info('Signed URL generated successfully', {
            s3_key,
            signed_url: signedUrl,
        });
        return signedUrl;
    }
    catch (error) {
        logger_1.logger.error('Failed to generate signed URL', {
            error_type: error.name,
            error_message: error.message,
            context: { s3_key, expires_in: expiresIn },
            stack_trace: error.stack,
        });
        // S3エラーは再試行可能
        throw new errors_1.RetryableError('Failed to generate signed URL', {
            cause: error,
            context: { s3_key, expires_in: expiresIn },
        });
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGV4cG9ydFxcZ2VuZXJhdGUtc2lnbmVkLXVybC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7OztHQU1HOztBQXFCSCw4Q0F1Q0M7QUExREQsa0RBQWdFO0FBQ2hFLHdFQUE2RDtBQUM3RCwrQ0FBNEM7QUFDNUMseUNBQThDO0FBRTlDLDBCQUEwQjtBQUMxQixNQUFNLFFBQVEsR0FBRyxJQUFJLG9CQUFRLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO0FBRXRGLE9BQU87QUFDUCxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLGVBQWUsQ0FBQztBQUV4RTs7Ozs7OztHQU9HO0FBQ0ksS0FBSyxVQUFVLGlCQUFpQixDQUNyQyxNQUFjLEVBQ2QsWUFBb0IsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLGFBQWE7O0lBRWxELElBQUksQ0FBQztRQUNILGVBQU0sQ0FBQyxJQUFJLENBQUMsdUJBQXVCLEVBQUU7WUFDbkMsTUFBTTtZQUNOLFVBQVUsRUFBRSxTQUFTO1NBQ3RCLENBQUMsQ0FBQztRQUVILHNCQUFzQjtRQUN0QixNQUFNLE9BQU8sR0FBRyxJQUFJLDRCQUFnQixDQUFDO1lBQ25DLE1BQU0sRUFBRSxhQUFhO1lBQ3JCLEdBQUcsRUFBRSxNQUFNO1NBQ1osQ0FBQyxDQUFDO1FBRUgsYUFBYTtRQUNiLE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBQSxtQ0FBWSxFQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBRXZFLGVBQU0sQ0FBQyxJQUFJLENBQUMsbUNBQW1DLEVBQUU7WUFDL0MsTUFBTTtZQUNOLFVBQVUsRUFBRSxTQUFTO1NBQ3RCLENBQUMsQ0FBQztRQUVILE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsZUFBTSxDQUFDLEtBQUssQ0FBQywrQkFBK0IsRUFBRTtZQUM1QyxVQUFVLEVBQUUsS0FBSyxDQUFDLElBQUk7WUFDdEIsYUFBYSxFQUFFLEtBQUssQ0FBQyxPQUFPO1lBQzVCLE9BQU8sRUFBRSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFO1lBQzFDLFdBQVcsRUFBRSxLQUFLLENBQUMsS0FBSztTQUN6QixDQUFDLENBQUM7UUFFSCxjQUFjO1FBQ2QsTUFBTSxJQUFJLHVCQUFjLENBQUMsK0JBQStCLEVBQUU7WUFDeEQsS0FBSyxFQUFFLEtBQUs7WUFDWixPQUFPLEVBQUUsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRTtTQUMzQyxDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpMTk4XFxpbnZlc3RtZW50X2FuYWx5c2lzX29wb3BvXFxzcmNcXGxhbWJkYVxcZXhwb3J0XFxnZW5lcmF0ZS1zaWduZWQtdXJsLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiDnvbLlkI3ku5jjgY1VUkznlJ/miJBcclxuICpcclxuICogUzPjgqrjg5bjgrjjgqfjgq/jg4jjga7nvbLlkI3ku5jjgY1VUkzjgpLnlJ/miJDjgZfjgb7jgZnvvIjmnInlirnmnJ/pmZA35pel77yJ44CCXHJcbiAqXHJcbiAqIFJlcXVpcmVtZW50czog6KaB5Lu2NS4x77yI44Ko44Kv44K544Od44O844OI77yJXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgUzNDbGllbnQsIEdldE9iamVjdENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xyXG5pbXBvcnQgeyBnZXRTaWduZWRVcmwgfSBmcm9tICdAYXdzLXNkay9zMy1yZXF1ZXN0LXByZXNpZ25lcic7XHJcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uLy4uL3V0aWxzL2xvZ2dlcic7XHJcbmltcG9ydCB7IFJldHJ5YWJsZUVycm9yIH0gZnJvbSAnLi4vLi4vZXJyb3JzJztcclxuXHJcbi8vIFMz44Kv44Op44Kk44Ki44Oz44OI77yI44Kw44Ot44O844OQ44Or44K544Kz44O844OX44Gn5Yid5pyf5YyW77yJXHJcbmNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICdhcC1ub3J0aGVhc3QtMScgfSk7XHJcblxyXG4vLyDnkrDlooPlpInmlbBcclxuY29uc3QgRVhQT1JUX0JVQ0tFVCA9IHByb2Nlc3MuZW52LkVYUE9SVF9CVUNLRVRfTkFNRSB8fCAndGRuZXQtZXhwb3J0cyc7XHJcblxyXG4vKipcclxuICog572y5ZCN5LuY44GNVVJM44KS55Sf5oiQXHJcbiAqXHJcbiAqIEBwYXJhbSBzM19rZXkgUzPjgq3jg7xcclxuICogQHBhcmFtIGV4cGlyZXNJbiDmnInlirnmnJ/pmZDvvIjnp5LvvIlcclxuICogQHJldHVybnMg572y5ZCN5LuY44GNVVJMXHJcbiAqIEB0aHJvd3Mge1JldHJ5YWJsZUVycm9yfSBTM+OCouOCr+OCu+OCueOCqOODqeODvOaZglxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlU2lnbmVkVXJsKFxyXG4gIHMzX2tleTogc3RyaW5nLFxyXG4gIGV4cGlyZXNJbjogbnVtYmVyID0gNyAqIDI0ICogNjAgKiA2MCAvLyDjg4fjg5Xjgqnjg6vjg4g6IDfml6XplpNcclxuKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICB0cnkge1xyXG4gICAgbG9nZ2VyLmluZm8oJ0dlbmVyYXRpbmcgc2lnbmVkIFVSTCcsIHtcclxuICAgICAgczNfa2V5LFxyXG4gICAgICBleHBpcmVzX2luOiBleHBpcmVzSW4sXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBHZXRPYmplY3RDb21tYW5k44KS5L2c5oiQXHJcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldE9iamVjdENvbW1hbmQoe1xyXG4gICAgICBCdWNrZXQ6IEVYUE9SVF9CVUNLRVQsXHJcbiAgICAgIEtleTogczNfa2V5LFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g572y5ZCN5LuY44GNVVJM44KS55Sf5oiQXHJcbiAgICBjb25zdCBzaWduZWRVcmwgPSBhd2FpdCBnZXRTaWduZWRVcmwoczNDbGllbnQsIGNvbW1hbmQsIHsgZXhwaXJlc0luIH0pO1xyXG5cclxuICAgIGxvZ2dlci5pbmZvKCdTaWduZWQgVVJMIGdlbmVyYXRlZCBzdWNjZXNzZnVsbHknLCB7XHJcbiAgICAgIHMzX2tleSxcclxuICAgICAgc2lnbmVkX3VybDogc2lnbmVkVXJsLFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHNpZ25lZFVybDtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gZ2VuZXJhdGUgc2lnbmVkIFVSTCcsIHtcclxuICAgICAgZXJyb3JfdHlwZTogZXJyb3IubmFtZSxcclxuICAgICAgZXJyb3JfbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcclxuICAgICAgY29udGV4dDogeyBzM19rZXksIGV4cGlyZXNfaW46IGV4cGlyZXNJbiB9LFxyXG4gICAgICBzdGFja190cmFjZTogZXJyb3Iuc3RhY2ssXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBTM+OCqOODqeODvOOBr+WGjeippuihjOWPr+iDvVxyXG4gICAgdGhyb3cgbmV3IFJldHJ5YWJsZUVycm9yKCdGYWlsZWQgdG8gZ2VuZXJhdGUgc2lnbmVkIFVSTCcsIHtcclxuICAgICAgY2F1c2U6IGVycm9yLFxyXG4gICAgICBjb250ZXh0OiB7IHMzX2tleSwgZXhwaXJlc19pbjogZXhwaXJlc0luIH0sXHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuIl0sInZlcnNpb24iOjN9