{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\cdk\\lib\\constructs\\cloudwatch-alarms.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\cdk\\lib\\constructs\\cloudwatch-alarms.ts"],"sourcesContent":["import * as cdk from 'aws-cdk-lib';\r\nimport * as cloudwatch from 'aws-cdk-lib/aws-cloudwatch';\r\nimport * as cloudwatch_actions from 'aws-cdk-lib/aws-cloudwatch-actions';\r\nimport * as sns from 'aws-cdk-lib/aws-sns';\r\nimport * as subscriptions from 'aws-cdk-lib/aws-sns-subscriptions';\r\nimport * as lambda from 'aws-cdk-lib/aws-lambda';\r\nimport { Construct } from 'constructs';\r\n\r\n/**\r\n * CloudWatch Alarms Construct Properties\r\n */\r\nexport interface CloudWatchAlarmsProps {\r\n  /**\r\n   * Lambda関数のリスト（監視対象）\r\n   */\r\n  lambdaFunctions: lambda.IFunction[];\r\n\r\n  /**\r\n   * 環境名（dev, staging, prod）\r\n   */\r\n  environment: string;\r\n\r\n  /**\r\n   * アラート通知先メールアドレス（オプション）\r\n   */\r\n  alertEmail?: string;\r\n\r\n  /**\r\n   * Lambda Error Rate閾値（デフォルト: 10%）\r\n   */\r\n  errorRateThreshold?: number;\r\n\r\n  /**\r\n   * Lambda Duration閾値（秒、デフォルト: 840秒 = 14分）\r\n   */\r\n  durationThreshold?: number;\r\n\r\n  /**\r\n   * CollectionSuccessRate閾値（デフォルト: 95%）\r\n   */\r\n  collectionSuccessRateThreshold?: number;\r\n}\r\n\r\n/**\r\n * CloudWatch Alarms Construct\r\n * \r\n * Lambda関数とシステム全体の監視アラームを設定します。\r\n * \r\n * 設定されるアラーム:\r\n * - Lambda Error Rate > 10% → Critical\r\n * - Lambda Duration > 14分 → Warning\r\n * - CollectionSuccessRate < 95% → Warning\r\n * - SNS Topicへの通知設定\r\n */\r\nexport class CloudWatchAlarms extends Construct {\r\n  /**\r\n   * SNS Topic（アラート通知用）\r\n   */\r\n  public readonly alertTopic: sns.Topic;\r\n\r\n  /**\r\n   * 作成されたアラームのリスト\r\n   */\r\n  public readonly alarms: cloudwatch.Alarm[] = [];\r\n\r\n  constructor(scope: Construct, id: string, props: CloudWatchAlarmsProps) {\r\n    super(scope, id);\r\n\r\n    // デフォルト値の設定\r\n    const errorRateThreshold = props.errorRateThreshold ?? 10; // 10%\r\n    const durationThreshold = props.durationThreshold ?? 840; // 14分 = 840秒\r\n    const collectionSuccessRateThreshold = props.collectionSuccessRateThreshold ?? 95; // 95%\r\n\r\n    // ========================================\r\n    // SNS Topic作成（アラート通知用）\r\n    // ========================================\r\n    this.alertTopic = new sns.Topic(this, 'AlertTopic', {\r\n      topicName: `tdnet-alerts-${props.environment}`,\r\n      displayName: `TDnet Data Collector Alerts (${props.environment})`,\r\n    });\r\n\r\n    // メール通知の追加（オプション）\r\n    if (props.alertEmail) {\r\n      this.alertTopic.addSubscription(\r\n        new subscriptions.EmailSubscription(props.alertEmail)\r\n      );\r\n    }\r\n\r\n    // ========================================\r\n    // Lambda関数ごとのアラーム設定\r\n    // ========================================\r\n    for (const lambdaFunction of props.lambdaFunctions) {\r\n      const functionName = lambdaFunction.functionName;\r\n\r\n      // 1. Lambda Error Rate アラーム（Critical）\r\n      const errorRateAlarm = new cloudwatch.Alarm(this, `${functionName}-ErrorRateAlarm`, {\r\n        alarmName: `${functionName}-error-rate-${props.environment}`,\r\n        alarmDescription: `Lambda関数 ${functionName} のエラー率が ${errorRateThreshold}% を超えました`,\r\n        metric: this.createErrorRateMetric(lambdaFunction),\r\n        threshold: errorRateThreshold,\r\n        evaluationPeriods: 1,\r\n        comparisonOperator: cloudwatch.ComparisonOperator.GREATER_THAN_THRESHOLD,\r\n        treatMissingData: cloudwatch.TreatMissingData.NOT_BREACHING,\r\n      });\r\n\r\n      errorRateAlarm.addAlarmAction(new cloudwatch_actions.SnsAction(this.alertTopic));\r\n      this.alarms.push(errorRateAlarm);\r\n\r\n      // 2. Lambda Duration アラーム（Warning）\r\n      const durationAlarm = new cloudwatch.Alarm(this, `${functionName}-DurationAlarm`, {\r\n        alarmName: `${functionName}-duration-${props.environment}`,\r\n        alarmDescription: `Lambda関数 ${functionName} の実行時間が ${durationThreshold} 秒を超えました`,\r\n        metric: lambdaFunction.metricDuration({\r\n          statistic: 'Average',\r\n          period: cdk.Duration.minutes(5),\r\n        }),\r\n        threshold: durationThreshold * 1000, // ミリ秒に変換\r\n        evaluationPeriods: 2,\r\n        comparisonOperator: cloudwatch.ComparisonOperator.GREATER_THAN_THRESHOLD,\r\n        treatMissingData: cloudwatch.TreatMissingData.NOT_BREACHING,\r\n      });\r\n\r\n      durationAlarm.addAlarmAction(new cloudwatch_actions.SnsAction(this.alertTopic));\r\n      this.alarms.push(durationAlarm);\r\n\r\n      // 3. Lambda Throttles アラーム（Critical）\r\n      const throttleAlarm = new cloudwatch.Alarm(this, `${functionName}-ThrottleAlarm`, {\r\n        alarmName: `${functionName}-throttles-${props.environment}`,\r\n        alarmDescription: `Lambda関数 ${functionName} でスロットリングが発生しました`,\r\n        metric: lambdaFunction.metricThrottles({\r\n          statistic: 'Sum',\r\n          period: cdk.Duration.minutes(5),\r\n        }),\r\n        threshold: 1,\r\n        evaluationPeriods: 1,\r\n        comparisonOperator: cloudwatch.ComparisonOperator.GREATER_THAN_OR_EQUAL_TO_THRESHOLD,\r\n        treatMissingData: cloudwatch.TreatMissingData.NOT_BREACHING,\r\n      });\r\n\r\n      throttleAlarm.addAlarmAction(new cloudwatch_actions.SnsAction(this.alertTopic));\r\n      this.alarms.push(throttleAlarm);\r\n    }\r\n\r\n    // ========================================\r\n    // カスタムメトリクスのアラーム\r\n    // ========================================\r\n\r\n    // 4. CollectionSuccessRate アラーム（Warning）\r\n    const collectionSuccessRateAlarm = new cloudwatch.Alarm(\r\n      this,\r\n      'CollectionSuccessRateAlarm',\r\n      {\r\n        alarmName: `tdnet-collection-success-rate-${props.environment}`,\r\n        alarmDescription: `収集成功率が ${collectionSuccessRateThreshold}% を下回りました`,\r\n        metric: this.createCollectionSuccessRateMetric(props.environment),\r\n        threshold: collectionSuccessRateThreshold,\r\n        evaluationPeriods: 1,\r\n        comparisonOperator: cloudwatch.ComparisonOperator.LESS_THAN_THRESHOLD,\r\n        treatMissingData: cloudwatch.TreatMissingData.NOT_BREACHING,\r\n      }\r\n    );\r\n\r\n    collectionSuccessRateAlarm.addAlarmAction(\r\n      new cloudwatch_actions.SnsAction(this.alertTopic)\r\n    );\r\n    this.alarms.push(collectionSuccessRateAlarm);\r\n\r\n    // 5. データ収集停止アラーム（Critical）\r\n    const noDataAlarm = new cloudwatch.Alarm(this, 'NoDataCollectedAlarm', {\r\n      alarmName: `tdnet-no-data-collected-${props.environment}`,\r\n      alarmDescription: '24時間データ収集がありません',\r\n      metric: new cloudwatch.Metric({\r\n        namespace: 'TDnet/Collector',\r\n        metricName: 'DisclosuresCollected',\r\n        statistic: 'Sum',\r\n        period: cdk.Duration.hours(24),\r\n        dimensionsMap: {\r\n          Environment: props.environment,\r\n        },\r\n      }),\r\n      threshold: 1,\r\n      evaluationPeriods: 1,\r\n      comparisonOperator: cloudwatch.ComparisonOperator.LESS_THAN_THRESHOLD,\r\n      treatMissingData: cloudwatch.TreatMissingData.BREACHING,\r\n    });\r\n\r\n    noDataAlarm.addAlarmAction(new cloudwatch_actions.SnsAction(this.alertTopic));\r\n    this.alarms.push(noDataAlarm);\r\n\r\n    // 6. 収集失敗アラーム（Warning）\r\n    const collectionFailureAlarm = new cloudwatch.Alarm(this, 'CollectionFailureAlarm', {\r\n      alarmName: `tdnet-collection-failures-${props.environment}`,\r\n      alarmDescription: '24時間で10件以上の収集失敗が発生しました',\r\n      metric: new cloudwatch.Metric({\r\n        namespace: 'TDnet/Collector',\r\n        metricName: 'DisclosuresFailed',\r\n        statistic: 'Sum',\r\n        period: cdk.Duration.hours(24),\r\n        dimensionsMap: {\r\n          Environment: props.environment,\r\n        },\r\n      }),\r\n      threshold: 10,\r\n      evaluationPeriods: 1,\r\n      comparisonOperator: cloudwatch.ComparisonOperator.GREATER_THAN_THRESHOLD,\r\n      treatMissingData: cloudwatch.TreatMissingData.NOT_BREACHING,\r\n    });\r\n\r\n    collectionFailureAlarm.addAlarmAction(new cloudwatch_actions.SnsAction(this.alertTopic));\r\n    this.alarms.push(collectionFailureAlarm);\r\n\r\n    // ========================================\r\n    // CloudFormation Outputs\r\n    // ========================================\r\n    new cdk.CfnOutput(this, 'AlertTopicArn', {\r\n      value: this.alertTopic.topicArn,\r\n      description: 'SNS Topic ARN for alerts',\r\n      exportName: `TdnetAlertTopicArn-${props.environment}`,\r\n    });\r\n\r\n    new cdk.CfnOutput(this, 'AlarmCount', {\r\n      value: this.alarms.length.toString(),\r\n      description: 'Number of CloudWatch Alarms created',\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Lambda Error Rateメトリクスを作成\r\n   * \r\n   * Error Rate = (Errors / Invocations) * 100\r\n   */\r\n  private createErrorRateMetric(lambdaFunction: lambda.IFunction): cloudwatch.IMetric {\r\n    const errors = lambdaFunction.metricErrors({\r\n      statistic: 'Sum',\r\n      period: cdk.Duration.minutes(5),\r\n    });\r\n\r\n    const invocations = lambdaFunction.metricInvocations({\r\n      statistic: 'Sum',\r\n      period: cdk.Duration.minutes(5),\r\n    });\r\n\r\n    // Error Rate = (Errors / Invocations) * 100\r\n    return new cloudwatch.MathExpression({\r\n      expression: '(errors / invocations) * 100',\r\n      usingMetrics: {\r\n        errors,\r\n        invocations,\r\n      },\r\n      label: 'Error Rate (%)',\r\n      period: cdk.Duration.minutes(5),\r\n    });\r\n  }\r\n\r\n  /**\r\n   * CollectionSuccessRateメトリクスを作成\r\n   * \r\n   * Success Rate = (DisclosuresCollected / (DisclosuresCollected + DisclosuresFailed)) * 100\r\n   */\r\n  private createCollectionSuccessRateMetric(environment: string): cloudwatch.IMetric {\r\n    const collected = new cloudwatch.Metric({\r\n      namespace: 'TDnet/Collector',\r\n      metricName: 'DisclosuresCollected',\r\n      statistic: 'Sum',\r\n      period: cdk.Duration.hours(1),\r\n      dimensionsMap: {\r\n        Environment: environment,\r\n      },\r\n    });\r\n\r\n    const failed = new cloudwatch.Metric({\r\n      namespace: 'TDnet/Collector',\r\n      metricName: 'DisclosuresFailed',\r\n      statistic: 'Sum',\r\n      period: cdk.Duration.hours(1),\r\n      dimensionsMap: {\r\n        Environment: environment,\r\n      },\r\n    });\r\n\r\n    // Success Rate = (Collected / (Collected + Failed)) * 100\r\n    return new cloudwatch.MathExpression({\r\n      expression: '(collected / (collected + failed)) * 100',\r\n      usingMetrics: {\r\n        collected,\r\n        failed,\r\n      },\r\n      label: 'Collection Success Rate (%)',\r\n      period: cdk.Duration.hours(1),\r\n    });\r\n  }\r\n}\r\n"],"version":3}