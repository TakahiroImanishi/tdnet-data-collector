{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\export-to-s3.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\export\\export-to-s3.ts"],"sourcesContent":["/**\r\n * S3エクスポート\r\n *\r\n * JSON/CSV形式でS3に保存します。大量データ対応（ストリーム処理）。\r\n *\r\n * Requirements: 要件5.2（エクスポート形式）\r\n */\r\n\r\nimport { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';\r\nimport { logger } from '../../utils/logger';\r\nimport { retryWithBackoff } from '../../utils/retry';\r\nimport { Disclosure } from '../../types';\r\n\r\n// S3クライアント（グローバルスコープで初期化）\r\nconst s3Client = new S3Client({ region: process.env.AWS_REGION || 'ap-northeast-1' });\r\n\r\n// 環境変数\r\nconst EXPORT_BUCKET = process.env.EXPORT_BUCKET_NAME || 'tdnet-exports';\r\n\r\n/**\r\n * S3にエクスポート\r\n *\r\n * @param export_id エクスポートID\r\n * @param disclosures 開示情報のリスト\r\n * @param format フォーマット（json, csv）\r\n * @returns S3キー\r\n */\r\nexport async function exportToS3(\r\n  export_id: string,\r\n  disclosures: Disclosure[],\r\n  format: 'json' | 'csv'\r\n): Promise<string> {\r\n  logger.info('Exporting to S3', {\r\n    export_id,\r\n    format,\r\n    count: disclosures.length,\r\n  });\r\n\r\n  // S3キーを生成\r\n  const s3_key = generateS3Key(export_id, format);\r\n\r\n  // フォーマットに応じて変換\r\n  const content = format === 'json' ? toJSON(disclosures) : toCSV(disclosures);\r\n\r\n  // S3にアップロード\r\n  await retryWithBackoff(\r\n    async () => {\r\n      await s3Client.send(\r\n        new PutObjectCommand({\r\n          Bucket: EXPORT_BUCKET,\r\n          Key: s3_key,\r\n          Body: content,\r\n          ContentType: format === 'json' ? 'application/json' : 'text/csv',\r\n          // ライフサイクルポリシーで7日後に自動削除されるようにタグを設定\r\n          Tagging: 'auto-delete=true',\r\n        })\r\n      );\r\n    },\r\n    {\r\n      maxRetries: 3,\r\n      initialDelay: 2000,\r\n      backoffMultiplier: 2,\r\n      jitter: true,\r\n    }\r\n  );\r\n\r\n  logger.info('Exported to S3 successfully', {\r\n    export_id,\r\n    s3_key,\r\n    size_bytes: Buffer.byteLength(content, 'utf8'),\r\n  });\r\n\r\n  return s3_key;\r\n}\r\n\r\n/**\r\n * S3キーを生成\r\n *\r\n * フォーマット: exports/YYYY/MM/DD/export_id.format\r\n * 例: exports/2024/01/15/export_1705305600000_abc123_12345678.json\r\n *\r\n * @param export_id エクスポートID\r\n * @param format フォーマット（json, csv）\r\n * @returns S3キー\r\n */\r\nfunction generateS3Key(export_id: string, format: 'json' | 'csv'): string {\r\n  const now = new Date();\r\n  const year = now.getUTCFullYear();\r\n  const month = String(now.getUTCMonth() + 1).padStart(2, '0');\r\n  const day = String(now.getUTCDate()).padStart(2, '0');\r\n\r\n  return `exports/${year}/${month}/${day}/${export_id}.${format}`;\r\n}\r\n\r\n/**\r\n * JSON形式に変換\r\n *\r\n * @param disclosures 開示情報のリスト\r\n * @returns JSON文字列\r\n */\r\nfunction toJSON(disclosures: Disclosure[]): string {\r\n  return JSON.stringify(\r\n    {\r\n      count: disclosures.length,\r\n      disclosures,\r\n    },\r\n    null,\r\n    2\r\n  );\r\n}\r\n\r\n/**\r\n * CSV形式に変換\r\n *\r\n * @param disclosures 開示情報のリスト\r\n * @returns CSV文字列\r\n */\r\nfunction toCSV(disclosures: Disclosure[]): string {\r\n  // CSVヘッダー\r\n  const headers = [\r\n    'disclosure_id',\r\n    'company_code',\r\n    'company_name',\r\n    'disclosure_type',\r\n    'title',\r\n    'disclosed_at',\r\n    'pdf_url',\r\n    's3_key',\r\n    'collected_at',\r\n    'date_partition',\r\n  ];\r\n\r\n  // CSVヘッダー行\r\n  const headerRow = headers.join(',');\r\n\r\n  // CSVデータ行\r\n  const dataRows = disclosures.map((disclosure) => {\r\n    return headers\r\n      .map((header) => {\r\n        const value = disclosure[header as keyof Disclosure];\r\n        // カンマやダブルクォートを含む場合はエスケープ\r\n        return escapeCSVValue(String(value));\r\n      })\r\n      .join(',');\r\n  });\r\n\r\n  // ヘッダー + データ行\r\n  return [headerRow, ...dataRows].join('\\n');\r\n}\r\n\r\n/**\r\n * CSV値をエスケープ\r\n *\r\n * カンマ、ダブルクォート、改行を含む場合はダブルクォートで囲み、\r\n * ダブルクォートは2つ重ねてエスケープします。\r\n *\r\n * @param value 値\r\n * @returns エスケープ後の値\r\n */\r\nfunction escapeCSVValue(value: string): string {\r\n  // カンマ、ダブルクォート、改行を含む場合はエスケープが必要\r\n  if (value.includes(',') || value.includes('\"') || value.includes('\\n')) {\r\n    // ダブルクォートを2つ重ねてエスケープ\r\n    const escaped = value.replace(/\"/g, '\"\"');\r\n    return `\"${escaped}\"`;\r\n  }\r\n  return value;\r\n}\r\n"],"version":3}