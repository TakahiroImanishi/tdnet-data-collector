{"version":3,"names":["cdk","cov_qjzwmglrb","s","__importStar","require","cloudfront","origins","iam","constructs_1","DashboardCloudFront","Construct","distribution","originAccessIdentity","constructor","scope","id","props","f","OriginAccessIdentity","comment","environment","dashboardBucket","addToResourcePolicy","PolicyStatement","actions","resources","arnForObjects","principals","CanonicalUserPrincipal","cloudFrontOriginAccessIdentityS3CanonicalUserId","indexCachePolicy","CachePolicy","cachePolicyName","defaultTtl","Duration","seconds","minTtl","maxTtl","cookieBehavior","CacheCookieBehavior","none","headerBehavior","CacheHeaderBehavior","queryStringBehavior","CacheQueryStringBehavior","enableAcceptEncodingGzip","enableAcceptEncodingBrotli","assetsCachePolicy","days","Distribution","defaultRootObject","defaultBehavior","origin","S3Origin","viewerProtocolPolicy","ViewerProtocolPolicy","REDIRECT_TO_HTTPS","cachePolicy","compress","additionalBehaviors","errorResponses","httpStatus","responseHttpStatus","responsePagePath","ttl","priceClass","PriceClass","PRICE_CLASS_100","httpVersion","HttpVersion","HTTP2_AND_3","minimumProtocolVersion","SecurityPolicyProtocol","TLS_V1_2_2021","CfnOutput","value","distributionDomainName","description","exportName","distributionId","exports"],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\cdk\\lib\\constructs\\cloudfront.ts"],"sourcesContent":["import * as cdk from 'aws-cdk-lib';\r\nimport * as cloudfront from 'aws-cdk-lib/aws-cloudfront';\r\nimport * as origins from 'aws-cdk-lib/aws-cloudfront-origins';\r\nimport * as s3 from 'aws-cdk-lib/aws-s3';\r\nimport * as iam from 'aws-cdk-lib/aws-iam';\r\nimport { Construct } from 'constructs';\r\n\r\n/**\r\n * CloudFront Distribution Constructのプロパティ\r\n */\r\nexport interface DashboardCloudFrontProps {\r\n  /**\r\n   * ダッシュボードのS3バケット\r\n   */\r\n  readonly dashboardBucket: s3.IBucket;\r\n\r\n  /**\r\n   * 環境名（dev, prod等）\r\n   */\r\n  readonly environment: string;\r\n}\r\n\r\n/**\r\n * TDnet Dashboard用CloudFront Distribution Construct\r\n * \r\n * 機能:\r\n * - S3バケットへのOAI（Origin Access Identity）アクセス\r\n * - HTTPS強制\r\n * - キャッシュ最適化（index.html: 1分、その他: 1日）\r\n * - エラーページ設定（404 → index.html for SPA routing）\r\n */\r\nexport class DashboardCloudFront extends Construct {\r\n  public readonly distribution: cloudfront.Distribution;\r\n  public readonly originAccessIdentity: cloudfront.OriginAccessIdentity;\r\n\r\n  constructor(scope: Construct, id: string, props: DashboardCloudFrontProps) {\r\n    super(scope, id);\r\n\r\n    // Origin Access Identity (OAI) を作成\r\n    // S3バケットへの直接アクセスを防ぎ、CloudFront経由のみ許可\r\n    this.originAccessIdentity = new cloudfront.OriginAccessIdentity(this, 'OAI', {\r\n      comment: `OAI for TDnet Dashboard (${props.environment})`,\r\n    });\r\n\r\n    // S3バケットポリシーにOAIからの読み取りを許可\r\n    props.dashboardBucket.addToResourcePolicy(\r\n      new iam.PolicyStatement({\r\n        actions: ['s3:GetObject'],\r\n        resources: [props.dashboardBucket.arnForObjects('*')],\r\n        principals: [\r\n          new iam.CanonicalUserPrincipal(\r\n            this.originAccessIdentity.cloudFrontOriginAccessIdentityS3CanonicalUserId\r\n          ),\r\n        ],\r\n      })\r\n    );\r\n\r\n    // index.html用のキャッシュポリシー（短いTTL: 1分）\r\n    const indexCachePolicy = new cloudfront.CachePolicy(this, 'IndexCachePolicy', {\r\n      cachePolicyName: `tdnet-dashboard-index-${props.environment}`,\r\n      comment: 'Cache policy for index.html with short TTL',\r\n      defaultTtl: cdk.Duration.seconds(60),\r\n      minTtl: cdk.Duration.seconds(0),\r\n      maxTtl: cdk.Duration.seconds(60),\r\n      cookieBehavior: cloudfront.CacheCookieBehavior.none(),\r\n      headerBehavior: cloudfront.CacheHeaderBehavior.none(),\r\n      queryStringBehavior: cloudfront.CacheQueryStringBehavior.none(),\r\n      enableAcceptEncodingGzip: true,\r\n      enableAcceptEncodingBrotli: true,\r\n    });\r\n\r\n    // 静的アセット用のキャッシュポリシー（長いTTL: 1日）\r\n    const assetsCachePolicy = new cloudfront.CachePolicy(this, 'AssetsCachePolicy', {\r\n      cachePolicyName: `tdnet-dashboard-assets-${props.environment}`,\r\n      comment: 'Cache policy for static assets with long TTL',\r\n      defaultTtl: cdk.Duration.days(1),\r\n      minTtl: cdk.Duration.seconds(0),\r\n      maxTtl: cdk.Duration.days(365),\r\n      cookieBehavior: cloudfront.CacheCookieBehavior.none(),\r\n      headerBehavior: cloudfront.CacheHeaderBehavior.none(),\r\n      queryStringBehavior: cloudfront.CacheQueryStringBehavior.none(),\r\n      enableAcceptEncodingGzip: true,\r\n      enableAcceptEncodingBrotli: true,\r\n    });\r\n\r\n    // CloudFront Distribution作成\r\n    this.distribution = new cloudfront.Distribution(this, 'Distribution', {\r\n      comment: `TDnet Dashboard Distribution (${props.environment})`,\r\n      defaultRootObject: 'index.html',\r\n      \r\n      // S3オリジン設定\r\n      defaultBehavior: {\r\n        origin: new origins.S3Origin(props.dashboardBucket, {\r\n          originAccessIdentity: this.originAccessIdentity,\r\n        }),\r\n        viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,\r\n        cachePolicy: indexCachePolicy,\r\n        compress: true,\r\n      },\r\n\r\n      // 静的アセット用の追加ビヘイビア\r\n      additionalBehaviors: {\r\n        '/static/*': {\r\n          origin: new origins.S3Origin(props.dashboardBucket, {\r\n            originAccessIdentity: this.originAccessIdentity,\r\n          }),\r\n          viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,\r\n          cachePolicy: assetsCachePolicy,\r\n          compress: true,\r\n        },\r\n        '*.js': {\r\n          origin: new origins.S3Origin(props.dashboardBucket, {\r\n            originAccessIdentity: this.originAccessIdentity,\r\n          }),\r\n          viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,\r\n          cachePolicy: assetsCachePolicy,\r\n          compress: true,\r\n        },\r\n        '*.css': {\r\n          origin: new origins.S3Origin(props.dashboardBucket, {\r\n            originAccessIdentity: this.originAccessIdentity,\r\n          }),\r\n          viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,\r\n          cachePolicy: assetsCachePolicy,\r\n          compress: true,\r\n        },\r\n      },\r\n\r\n      // SPA用エラーページ設定（404 → index.html）\r\n      errorResponses: [\r\n        {\r\n          httpStatus: 404,\r\n          responseHttpStatus: 200,\r\n          responsePagePath: '/index.html',\r\n          ttl: cdk.Duration.seconds(60),\r\n        },\r\n        {\r\n          httpStatus: 403,\r\n          responseHttpStatus: 200,\r\n          responsePagePath: '/index.html',\r\n          ttl: cdk.Duration.seconds(60),\r\n        },\r\n      ],\r\n\r\n      // 価格クラス（コスト最適化: 北米・欧州のみ）\r\n      priceClass: cloudfront.PriceClass.PRICE_CLASS_100,\r\n\r\n      // HTTPバージョン\r\n      httpVersion: cloudfront.HttpVersion.HTTP2_AND_3,\r\n\r\n      // 最小TLSバージョン\r\n      minimumProtocolVersion: cloudfront.SecurityPolicyProtocol.TLS_V1_2_2021,\r\n    });\r\n\r\n    // CloudFront Distribution URLを出力\r\n    new cdk.CfnOutput(this, 'DistributionDomainName', {\r\n      value: this.distribution.distributionDomainName,\r\n      description: 'CloudFront Distribution Domain Name',\r\n      exportName: `tdnet-dashboard-domain-${props.environment}`,\r\n    });\r\n\r\n    new cdk.CfnOutput(this, 'DistributionId', {\r\n      value: this.distribution.distributionId,\r\n      description: 'CloudFront Distribution ID',\r\n      exportName: `tdnet-dashboard-distribution-id-${props.environment}`,\r\n    });\r\n\r\n    // CloudFront Distribution URLをHTTPS形式で出力\r\n    new cdk.CfnOutput(this, 'DashboardUrl', {\r\n      value: `https://${this.distribution.distributionDomainName}`,\r\n      description: 'TDnet Dashboard URL',\r\n      exportName: `tdnet-dashboard-url-${props.environment}`,\r\n    });\r\n  }\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}