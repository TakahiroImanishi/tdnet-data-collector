name: E2E Tests with LocalStack

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

jobs:
  # ==========================================
  # E2E Tests with LocalStack
  # ==========================================
  e2e-tests:
    name: E2E Tests (LocalStack)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # ==========================================
      # 1. Checkout & Setup
      # ==========================================
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      # ==========================================
      # 2. LocalStack Setup
      # ==========================================
      - name: Start LocalStack
        run: |
          docker-compose up -d
          echo "LocalStack started"
      
      - name: Wait for LocalStack to be ready
        run: |
          echo "Waiting for LocalStack to be ready..."
          timeout 120 bash -c 'until curl -f http://localhost:4566/_localstack/health; do 
            echo "Waiting for LocalStack..."
            sleep 5
          done'
          echo "LocalStack is ready!"
      
      - name: Verify LocalStack health
        run: |
          echo "Checking LocalStack health..."
          curl -s http://localhost:4566/_localstack/health | jq '.'
      
      # ==========================================
      # 3. AWS Resources Setup
      # ==========================================
      - name: Install AWS CLI
        run: |
          if ! command -v aws &> /dev/null; then
            echo "Installing AWS CLI..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install
          fi
          aws --version
      
      - name: Create DynamoDB tables
        env:
          AWS_REGION: ap-northeast-1
          AWS_ENDPOINT_URL: http://localhost:4566
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
        run: |
          echo "Creating DynamoDB tables..."
          
          # Table 1: tdnet_disclosures
          aws --endpoint-url=$AWS_ENDPOINT_URL --region=$AWS_REGION \
              dynamodb create-table \
              --table-name tdnet_disclosures \
              --attribute-definitions \
                  AttributeName=disclosure_id,AttributeType=S \
                  AttributeName=date_partition,AttributeType=S \
                  AttributeName=disclosed_at,AttributeType=S \
              --key-schema AttributeName=disclosure_id,KeyType=HASH \
              --global-secondary-indexes \
                  '[{"IndexName":"DatePartitionIndex","KeySchema":[{"AttributeName":"date_partition","KeyType":"HASH"},{"AttributeName":"disclosed_at","KeyType":"RANGE"}],"Projection":{"ProjectionType":"ALL"},"ProvisionedThroughput":{"ReadCapacityUnits":5,"WriteCapacityUnits":5}}]' \
              --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
              --no-cli-pager || echo "Table may already exist"
          
          # Table 2: tdnet_executions
          aws --endpoint-url=$AWS_ENDPOINT_URL --region=$AWS_REGION \
              dynamodb create-table \
              --table-name tdnet_executions \
              --attribute-definitions \
                  AttributeName=execution_id,AttributeType=S \
                  AttributeName=started_at,AttributeType=S \
              --key-schema AttributeName=execution_id,KeyType=HASH \
              --global-secondary-indexes \
                  '[{"IndexName":"StartedAtIndex","KeySchema":[{"AttributeName":"started_at","KeyType":"HASH"}],"Projection":{"ProjectionType":"ALL"},"ProvisionedThroughput":{"ReadCapacityUnits":5,"WriteCapacityUnits":5}}]' \
              --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
              --no-cli-pager || echo "Table may already exist"
          
          echo "DynamoDB tables created successfully"
      
      - name: Create S3 buckets
        env:
          AWS_REGION: ap-northeast-1
          AWS_ENDPOINT_URL: http://localhost:4566
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
        run: |
          echo "Creating S3 buckets..."
          
          # Bucket 1: PDFs
          aws --endpoint-url=$AWS_ENDPOINT_URL --region=$AWS_REGION \
              s3 mb s3://tdnet-data-collector-pdfs-local \
              --no-cli-pager || echo "Bucket may already exist"
          
          # Bucket 2: Exports
          aws --endpoint-url=$AWS_ENDPOINT_URL --region=$AWS_REGION \
              s3 mb s3://tdnet-data-collector-exports-local \
              --no-cli-pager || echo "Bucket may already exist"
          
          echo "S3 buckets created successfully"
      
      - name: Verify AWS resources
        env:
          AWS_REGION: ap-northeast-1
          AWS_ENDPOINT_URL: http://localhost:4566
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
        run: |
          echo "Verifying DynamoDB tables..."
          aws --endpoint-url=$AWS_ENDPOINT_URL --region=$AWS_REGION \
              dynamodb list-tables --no-cli-pager
          
          echo "Verifying S3 buckets..."
          aws --endpoint-url=$AWS_ENDPOINT_URL --region=$AWS_REGION \
              s3 ls --no-cli-pager
      
      # ==========================================
      # 4. Run E2E Tests
      # ==========================================
      - name: Run E2E tests
        env:
          AWS_REGION: ap-northeast-1
          AWS_ENDPOINT_URL: http://localhost:4566
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          DYNAMODB_TABLE_DISCLOSURES: tdnet_disclosures
          DYNAMODB_TABLE_EXECUTIONS: tdnet_executions
          S3_BUCKET_PDFS: tdnet-data-collector-pdfs-local
          S3_BUCKET_EXPORTS: tdnet-data-collector-exports-local
          API_KEY: test-api-key-localstack-e2e
          LOG_LEVEL: DEBUG
          RATE_LIMIT_DELAY_MS: 100
          ENVIRONMENT: ci
          NODE_ENV: test
          TEST_ENV: e2e
        run: |
          echo "Running E2E tests..."
          npm run test:e2e -- --verbose --ci --json --outputFile=test-results/e2e-results.json
      
      # ==========================================
      # 5. Generate Test Reports
      # ==========================================
      - name: Generate test report
        if: always()
        run: |
          echo "# ðŸ§ª E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f test-results/e2e-results.json ]; then
            # Parse test results
            TOTAL=$(jq '.numTotalTests' test-results/e2e-results.json)
            PASSED=$(jq '.numPassedTests' test-results/e2e-results.json)
            FAILED=$(jq '.numFailedTests' test-results/e2e-results.json)
            DURATION=$(jq '.testResults[0].perfStats.runtime / 1000' test-results/e2e-results.json)
            
            echo "## Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Tests**: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Passed**: âœ… $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed**: âŒ $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "- **Duration**: ${DURATION}s" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$FAILED" -gt 0 ]; then
              echo "## âŒ Failed Tests" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              jq -r '.testResults[].assertionResults[] | select(.status == "failed") | "- **\(.ancestorTitles | join(" > "))**: \(.title)"' test-results/e2e-results.json >> $GITHUB_STEP_SUMMARY
            else
              echo "## âœ… All Tests Passed!" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Test results file not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Test completed at $(date)" >> $GITHUB_STEP_SUMMARY
      
      # ==========================================
      # 6. Collect Logs & Artifacts
      # ==========================================
      - name: Collect LocalStack logs
        if: always()
        run: |
          mkdir -p test-artifacts/logs
          docker-compose logs localstack > test-artifacts/logs/localstack.log 2>&1 || true
          echo "LocalStack logs collected"
      
      - name: Collect test artifacts
        if: always()
        run: |
          mkdir -p test-artifacts
          
          # Copy test results
          if [ -d test-results ]; then
            cp -r test-results test-artifacts/
          fi
          
          # Create environment info
          cat > test-artifacts/environment.txt << EOF
          Node.js: $(node --version)
          npm: $(npm --version)
          OS: $(uname -a)
          Date: $(date)
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref }}
          EOF
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-test-artifacts
          path: test-artifacts/
          retention-days: 30
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-test-results
          path: test-results/
          retention-days: 30
      
      # ==========================================
      # 7. Cleanup
      # ==========================================
      - name: Stop LocalStack
        if: always()
        run: |
          docker-compose down -v
          echo "LocalStack stopped and cleaned up"
      
      # ==========================================
      # 8. Fail if tests failed
      # ==========================================
      - name: Check test results
        if: always()
        run: |
          if [ -f test-results/e2e-results.json ]; then
            FAILED=$(jq '.numFailedTests' test-results/e2e-results.json)
            if [ "$FAILED" -gt 0 ]; then
              echo "âŒ $FAILED test(s) failed"
              exit 1
            else
              echo "âœ… All tests passed"
            fi
          else
            echo "âš ï¸ Test results file not found"
            exit 1
          fi
