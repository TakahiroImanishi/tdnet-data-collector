e18442f1777f6d5626169c1cfbd2f24d
"use strict";
/**
 * Lambda Query Handler
 *
 * TDnet開示情報を検索するLambda関数のメインハンドラー。
 * API Gateway統合により、RESTful APIとして公開されます。
 *
 * Requirements: 要件4.1, 4.3, 4.4, 5.2, 11.1（検索API、認証、PDFダウンロード、CSV形式）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const logger_1 = require("../../utils/logger");
const cloudwatch_metrics_1 = require("../../utils/cloudwatch-metrics");
const errors_1 = require("../../errors");
const query_disclosures_1 = require("./query-disclosures");
const format_csv_1 = require("./format-csv");
/**
 * Lambda Queryハンドラー
 *
 * @param event API Gateway Proxy Event
 * @param context Lambda Context
 * @returns API Gateway Proxy Result
 *
 * @example
 * ```typescript
 * // 企業コードで検索
 * GET /disclosures?company_code=7203
 *
 * // 日付範囲で検索
 * GET /disclosures?start_date=2024-01-15&end_date=2024-01-20
 *
 * // CSV形式で取得
 * GET /disclosures?format=csv&start_date=2024-01-15&end_date=2024-01-20
 * ```
 */
async function handler(event, context) {
    const startTime = Date.now();
    try {
        logger_1.logger.info('Lambda Query started', {
            queryStringParameters: event.queryStringParameters,
            request_id: context.awsRequestId,
            function_name: context.functionName,
        });
        // APIキー認証の検証
        validateApiKey(event);
        // クエリパラメータのパース
        const params = parseQueryParameters(event);
        // 開示情報を検索
        const result = await (0, query_disclosures_1.queryDisclosures)(params);
        const duration = Date.now() - startTime;
        logger_1.logger.info('Lambda Query completed', {
            request_id: context.awsRequestId,
            count: result.count,
            duration_ms: duration,
        });
        // 成功メトリクス送信
        await (0, cloudwatch_metrics_1.sendMetrics)([
            {
                name: 'LambdaExecutionTime',
                value: duration,
                unit: 'Milliseconds',
                dimensions: { FunctionName: 'Query' },
            },
            {
                name: 'QueryResultCount',
                value: result.count,
                unit: 'Count',
                dimensions: { Format: params.format },
            },
        ]);
        // フォーマット別レスポンス
        if (params.format === 'csv') {
            const csv = (0, format_csv_1.formatAsCsv)(result.disclosures);
            return {
                statusCode: 200,
                headers: {
                    'Content-Type': 'text/csv',
                    'Content-Disposition': `attachment; filename="disclosures-${Date.now()}.csv"`,
                    'Access-Control-Allow-Origin': '*',
                },
                body: csv,
            };
        }
        // JSON形式（デフォルト）
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify(result),
        };
    }
    catch (error) {
        const duration = Date.now() - startTime;
        logger_1.logger.error('Lambda Query failed', (0, logger_1.createErrorContext)(error, {
            request_id: context.awsRequestId,
            duration_ms: duration,
        }));
        // エラーメトリクス送信
        await (0, cloudwatch_metrics_1.sendErrorMetric)(error instanceof Error ? error.constructor.name : 'Unknown', 'Query');
        return handleError(error, context.awsRequestId);
    }
}
/**
 * APIキー認証の検証
 *
 * @param event API Gateway Proxy Event
 * @throws ValidationError APIキーが無効な場合
 */
function validateApiKey(event) {
    const apiKey = event.headers['x-api-key'] || event.headers['X-Api-Key'];
    if (!apiKey) {
        throw new errors_1.ValidationError('API key is required. Please provide x-api-key header.');
    }
    // APIキーの検証（実際の実装ではSecrets Managerから取得した値と比較）
    // ここでは環境変数から取得した値と比較
    const validApiKey = process.env.API_KEY;
    if (!validApiKey) {
        logger_1.logger.error('API_KEY environment variable is not set');
        throw new Error('API key validation is not configured');
    }
    if (apiKey !== validApiKey) {
        throw new errors_1.ValidationError('Invalid API key');
    }
}
/**
 * クエリパラメータのパース
 *
 * @param event API Gateway Proxy Event
 * @returns パース済みクエリパラメータ
 * @throws ValidationError バリデーションエラー
 */
function parseQueryParameters(event) {
    const params = event.queryStringParameters || {};
    // フォーマットのバリデーション
    const format = (params.format || 'json');
    if (!['json', 'csv'].includes(format)) {
        throw new errors_1.ValidationError(`Invalid format: ${format}. Expected 'json' or 'csv'.`);
    }
    // リミットのバリデーション（デフォルト: 100、最大: 1000）
    let limit = 100;
    if (params.limit) {
        limit = parseInt(params.limit, 10);
        if (isNaN(limit) || limit < 1 || limit > 1000) {
            throw new errors_1.ValidationError(`Invalid limit: ${params.limit}. Expected a number between 1 and 1000.`);
        }
    }
    // オフセットのバリデーション（デフォルト: 0）
    let offset = 0;
    if (params.offset) {
        offset = parseInt(params.offset, 10);
        if (isNaN(offset) || offset < 0) {
            throw new errors_1.ValidationError(`Invalid offset: ${params.offset}. Expected a non-negative number.`);
        }
    }
    // 日付フォーマットのバリデーション
    if (params.start_date) {
        validateDateFormat(params.start_date, 'start_date');
    }
    if (params.end_date) {
        validateDateFormat(params.end_date, 'end_date');
    }
    // 日付範囲の順序性チェック（Property 8）
    if (params.start_date && params.end_date) {
        const startDate = new Date(params.start_date);
        const endDate = new Date(params.end_date);
        if (startDate > endDate) {
            throw new errors_1.ValidationError(`start_date (${params.start_date}) must be before or equal to end_date (${params.end_date})`);
        }
    }
    // 企業コードのバリデーション（4桁の数字）
    if (params.company_code) {
        const companyCodeRegex = /^\d{4}$/;
        if (!companyCodeRegex.test(params.company_code)) {
            throw new errors_1.ValidationError(`Invalid company_code: ${params.company_code}. Expected 4-digit number.`);
        }
    }
    return {
        company_code: params.company_code,
        start_date: params.start_date,
        end_date: params.end_date,
        disclosure_type: params.disclosure_type,
        format,
        limit,
        offset,
    };
}
/**
 * 日付フォーマットのバリデーション
 *
 * @param date 日付文字列（YYYY-MM-DD）
 * @param fieldName フィールド名
 * @throws ValidationError バリデーションエラー
 */
function validateDateFormat(date, fieldName) {
    // YYYY-MM-DD形式のチェック
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateRegex.test(date)) {
        throw new errors_1.ValidationError(`Invalid ${fieldName} format: ${date}. Expected YYYY-MM-DD format.`);
    }
    // 有効な日付かチェック
    const parsedDate = new Date(date);
    if (isNaN(parsedDate.getTime())) {
        throw new errors_1.ValidationError(`Invalid ${fieldName}: ${date}. Date does not exist.`);
    }
}
/**
 * エラーハンドリング
 *
 * カスタムエラーを適切なHTTPステータスコードとエラーコードに変換します。
 *
 * @param error エラーオブジェクト
 * @param requestId リクエストID
 * @returns API Gateway Proxy Result
 */
function handleError(error, requestId) {
    // エラー種別に応じたステータスコードとエラーコード
    let statusCode = 500;
    let errorCode = 'INTERNAL_ERROR';
    if (error instanceof errors_1.ValidationError) {
        statusCode = 400;
        errorCode = 'VALIDATION_ERROR';
    }
    else if (error instanceof errors_1.NotFoundError) {
        statusCode = 404;
        errorCode = 'NOT_FOUND';
    }
    else if (error.message.includes('API key')) {
        statusCode = 401;
        errorCode = 'UNAUTHORIZED';
    }
    // センシティブ情報を除外したエラーレスポンス
    const errorResponse = {
        error_code: errorCode,
        message: error.message,
        request_id: requestId,
    };
    // 本番環境ではスタックトレースを含めない
    if (process.env.NODE_ENV !== 'production') {
        errorResponse.stack = error.stack;
    }
    return {
        statusCode,
        headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
        },
        body: JSON.stringify(errorResponse),
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXHF1ZXJ5XFxoYW5kbGVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7OztHQU9HOztBQWdFSCwwQkF3RkM7QUFySkQsK0NBQWdFO0FBQ2hFLHVFQUE4RTtBQUM5RSx5Q0FBOEQ7QUFDOUQsMkRBQXVEO0FBQ3ZELDZDQUEyQztBQXNDM0M7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWtCRztBQUNJLEtBQUssVUFBVSxPQUFPLENBQzNCLEtBQWlCLEVBQ2pCLE9BQWdCO0lBRWhCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUU3QixJQUFJLENBQUM7UUFDSCxlQUFNLENBQUMsSUFBSSxDQUFDLHNCQUFzQixFQUFFO1lBQ2xDLHFCQUFxQixFQUFFLEtBQUssQ0FBQyxxQkFBcUI7WUFDbEQsVUFBVSxFQUFFLE9BQU8sQ0FBQyxZQUFZO1lBQ2hDLGFBQWEsRUFBRSxPQUFPLENBQUMsWUFBWTtTQUNwQyxDQUFDLENBQUM7UUFFSCxhQUFhO1FBQ2IsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXRCLGVBQWU7UUFDZixNQUFNLE1BQU0sR0FBRyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUUzQyxVQUFVO1FBQ1YsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFBLG9DQUFnQixFQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTlDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxTQUFTLENBQUM7UUFFeEMsZUFBTSxDQUFDLElBQUksQ0FBQyx3QkFBd0IsRUFBRTtZQUNwQyxVQUFVLEVBQUUsT0FBTyxDQUFDLFlBQVk7WUFDaEMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLO1lBQ25CLFdBQVcsRUFBRSxRQUFRO1NBQ3RCLENBQUMsQ0FBQztRQUVILFlBQVk7UUFDWixNQUFNLElBQUEsZ0NBQVcsRUFBQztZQUNoQjtnQkFDRSxJQUFJLEVBQUUscUJB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UUFDckIsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO1FBQ3RCLFVBQVUsRUFBRSxTQUFTO0tBQ3RCLENBQUM7SUFFRixzQkFBc0I7SUFDdEIsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxZQUFZLEVBQUUsQ0FBQztRQUN6QyxhQUFxQixDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDO0lBQzdDLENBQUM7SUFFRCxPQUFPO1FBQ0wsVUFBVTtRQUNWLE9BQU8sRUFBRTtZQUNQLGNBQWMsRUFBRSxrQkFBa0I7WUFDbEMsNkJBQTZCLEVBQUUsR0FBRztTQUNuQztRQUNELElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQztLQUNwQyxDQUFDO0FBQ0osQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpMTk4XFxpbnZlc3RtZW50X2FuYWx5c2lzX29wb3BvXFxzcmNcXGxhbWJkYVxccXVlcnlcXGhhbmRsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIExhbWJkYSBRdWVyeSBIYW5kbGVyXHJcbiAqXHJcbiAqIFREbmV06ZaL56S65oOF5aCx44KS5qSc57Si44GZ44KLTGFtYmRh6Zai5pWw44Gu44Oh44Kk44Oz44OP44Oz44OJ44Op44O844CCXHJcbiAqIEFQSSBHYXRld2F557Wx5ZCI44Gr44KI44KK44CBUkVTVGZ1bCBBUEnjgajjgZfjgablhazplovjgZXjgozjgb7jgZnjgIJcclxuICpcclxuICogUmVxdWlyZW1lbnRzOiDopoHku7Y0LjEsIDQuMywgNC40LCA1LjIsIDExLjHvvIjmpJzntKJBUEnjgIHoqo3oqLzjgIFQREbjg4Djgqbjg7Pjg63jg7zjg4njgIFDU1blvaLlvI/vvIlcclxuICovXHJcblxyXG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0LCBDb250ZXh0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XHJcbmltcG9ydCB7IGxvZ2dlciwgY3JlYXRlRXJyb3JDb250ZXh0IH0gZnJvbSAnLi4vLi4vdXRpbHMvbG9nZ2VyJztcclxuaW1wb3J0IHsgc2VuZEVycm9yTWV0cmljLCBzZW5kTWV0cmljcyB9IGZyb20gJy4uLy4uL3V0aWxzL2Nsb3Vkd2F0Y2gtbWV0cmljcyc7XHJcbmltcG9ydCB7IFZhbGlkYXRpb25FcnJvciwgTm90Rm91bmRFcnJvciB9IGZyb20gJy4uLy4uL2Vycm9ycyc7XHJcbmltcG9ydCB7IHF1ZXJ5RGlzY2xvc3VyZXMgfSBmcm9tICcuL3F1ZXJ5LWRpc2Nsb3N1cmVzJztcclxuaW1wb3J0IHsgZm9ybWF0QXNDc3YgfSBmcm9tICcuL2Zvcm1hdC1jc3YnO1xyXG5pbXBvcnQgeyBEaXNjbG9zdXJlIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xyXG5cclxuLyoqXHJcbiAqIExhbWJkYSBRdWVyeeOCpOODmeODs+ODiO+8iEFQSSBHYXRld2F557Wx5ZCI77yJXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIFF1ZXJ5RXZlbnQgZXh0ZW5kcyBBUElHYXRld2F5UHJveHlFdmVudCB7XHJcbiAgcXVlcnlTdHJpbmdQYXJhbWV0ZXJzOiB7XHJcbiAgICBjb21wYW55X2NvZGU/OiBzdHJpbmc7XHJcbiAgICBzdGFydF9kYXRlPzogc3RyaW5nO1xyXG4gICAgZW5kX2RhdGU/OiBzdHJpbmc7XHJcbiAgICBkaXNjbG9zdXJlX3R5cGU/OiBzdHJpbmc7XHJcbiAgICBmb3JtYXQ/OiAnanNvbicgfCAnY3N2JztcclxuICAgIGxpbWl0Pzogc3RyaW5nO1xyXG4gICAgb2Zmc2V0Pzogc3RyaW5nO1xyXG4gIH0gfCBudWxsO1xyXG59XHJcblxyXG4vKipcclxuICog44Kv44Ko44Oq44Os44K544Od44Oz44K5XHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIFF1ZXJ5UmVzcG9uc2Uge1xyXG4gIC8qKiDmpJzntKLntZDmnpwgKi9cclxuICBkaXNjbG9zdXJlczogRGlzY2xvc3VyZVtdO1xyXG5cclxuICAvKiog57eP5Lu25pWwICovXHJcbiAgdG90YWw6IG51bWJlcjtcclxuXHJcbiAgLyoqIOWPluW+l+S7tuaVsCAqL1xyXG4gIGNvdW50OiBudW1iZXI7XHJcblxyXG4gIC8qKiDjgqrjg5Xjgrvjg4Pjg4ggKi9cclxuICBvZmZzZXQ6IG51bWJlcjtcclxuXHJcbiAgLyoqIOODquODn+ODg+ODiCAqL1xyXG4gIGxpbWl0OiBudW1iZXI7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBMYW1iZGEgUXVlcnnjg4/jg7Pjg4njg6njg7xcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEFQSSBHYXRld2F5IFByb3h5IEV2ZW50XHJcbiAqIEBwYXJhbSBjb250ZXh0IExhbWJkYSBDb250ZXh0XHJcbiAqIEByZXR1cm5zIEFQSSBHYXRld2F5IFByb3h5IFJlc3VsdFxyXG4gKlxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGB0eXBlc2NyaXB0XHJcbiAqIC8vIOS8gealreOCs+ODvOODieOBp+aknOe0olxyXG4gKiBHRVQgL2Rpc2Nsb3N1cmVzP2NvbXBhbnlfY29kZT03MjAzXHJcbiAqXHJcbiAqIC8vIOaXpeS7mOevhOWbsuOBp+aknOe0olxyXG4gKiBHRVQgL2Rpc2Nsb3N1cmVzP3N0YXJ0X2RhdGU9MjAyNC0wMS0xNSZlbmRfZGF0ZT0yMDI0LTAxLTIwXHJcbiAqXHJcbiAqIC8vIENTVuW9ouW8j+OBp+WPluW+l1xyXG4gKiBHRVQgL2Rpc2Nsb3N1cmVzP2Zvcm1hdD1jc3Ymc3RhcnRfZGF0ZT0yMDI0LTAxLTE1JmVuZF9kYXRlPTIwMjQtMDEtMjBcclxuICogYGBgXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaGFuZGxlcihcclxuICBldmVudDogUXVlcnlFdmVudCxcclxuICBjb250ZXh0OiBDb250ZXh0XHJcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XHJcbiAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcclxuXHJcbiAgdHJ5IHtcclxuICAgIGxvZ2dlci5pbmZvKCdMYW1iZGEgUXVlcnkgc3RhcnRlZCcsIHtcclxuICAgICAgcXVlcnlTdHJpbmdQYXJhbWV0ZXJzOiBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMsXHJcbiAgICAgIHJlcXVlc3RfaWQ6IGNvbnRleHQuYXdzUmVxdWVzdElkLFxyXG4gICAgICBmdW5jdGlvbl9uYW1lOiBjb250ZXh0LmZ1bmN0aW9uTmFtZSxcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIEFQSeOCreODvOiqjeiovOOBruaknOiovFxyXG4gICAgdmFsaWRhdGVBcGlLZXkoZXZlbnQpO1xyXG5cclxuICAgIC8vIOOCr+OCqOODquODkeODqeODoeODvOOCv+OBruODkeODvOOCuVxyXG4gICAgY29uc3QgcGFyYW1zID0gcGFyc2VRdWVyeVBhcmFtZXRlcnMoZXZlbnQpO1xyXG5cclxuICAgIC8vIOmWi+ekuuaDheWgseOCkuaknOe0olxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcXVlcnlEaXNjbG9zdXJlcyhwYXJhbXMpO1xyXG5cclxuICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcclxuXHJcbiAgICBsb2dnZXIuaW5mbygnTGFtYmRhIFF1ZXJ5IGNvbXBsZXRlZCcsIHtcclxuICAgICAgcmVxdWVzdF9pZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXHJcbiAgICAgIGNvdW50OiByZXN1bHQuY291bnQsXHJcbiAgICAgIGR1cmF0aW9uX21zOiBkdXJhdGlvbixcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOaIkOWKn+ODoeODiOODquOCr+OCuemAgeS/oVxyXG4gICAgYXdhaXQgc2VuZE1ldHJpY3MoW1xyXG4gICAgICB7XHJcbiAgICAgICAgbmFtZTogJ0xhbWJkYUV4ZWN1dGlvblRpbWUnLFxyXG4gICAgICAgIHZhbHVlOiBkdXJhdGlvbixcclxuICAgICAgICB1bml0OiAnTWlsbGlzZWNvbmRzJyxcclxuICAgICAgICBkaW1lbnNpb25zOiB7IEZ1bmN0aW9uTmFtZTogJ1F1ZXJ5JyB9LFxyXG4gICAgICB9LFxyXG4gICAgICB7XHJcbiAgICAgICAgbmFtZTogJ1F1ZXJ5UmVzdWx0Q291bnQnLFxyXG4gICAgICAgIHZhbHVlOiByZXN1bHQuY291bnQsXHJcbiAgICAgICAgdW5pdDogJ0NvdW50JyxcclxuICAgICAgICBkaW1lbnNpb25zOiB7IEZvcm1hdDogcGFyYW1zLmZvcm1hdCB9LFxyXG4gICAgICB9LFxyXG4gICAgXSk7XHJcblxyXG4gICAgLy8g44OV44Kp44O844Oe44OD44OI5Yil44Os44K544Od44Oz44K5XHJcbiAgICBpZiAocGFyYW1zLmZvcm1hdCA9PT0gJ2NzdicpIHtcclxuICAgICAgY29uc3QgY3N2ID0gZm9ybWF0QXNDc3YocmVzdWx0LmRpc2Nsb3N1cmVzKTtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdGF0dXNDb2RlOiAyMDAsXHJcbiAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICd0ZXh0L2NzdicsXHJcbiAgICAgICAgICAnQ29udGVudC1EaXNwb3NpdGlvbic6IGBhdHRhY2htZW50OyBmaWxlbmFtZT1cImRpc2Nsb3N1cmVzLSR7RGF0ZS5ub3coKX0uY3N2XCJgLFxyXG4gICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGJvZHk6IGNzdixcclxuICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBKU09O5b2i5byP77yI44OH44OV44Kp44Or44OI77yJXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXHJcbiAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXHJcbiAgICAgIH0sXHJcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHJlc3VsdCksXHJcbiAgICB9O1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XHJcblxyXG4gICAgbG9nZ2VyLmVycm9yKFxyXG4gICAgICAnTGFtYmRhIFF1ZXJ5IGZhaWxlZCcsXHJcbiAgICAgIGNyZWF0ZUVycm9yQ29udGV4dChlcnJvciBhcyBFcnJvciwge1xyXG4gICAgICAgIHJlcXVlc3RfaWQ6IGNvbnRleHQuYXdzUmVxdWVzdElkLFxyXG4gICAgICAgIGR1cmF0aW9uX21zOiBkdXJhdGlvbixcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gICAgLy8g44Ko44Op44O844Oh44OI44Oq44Kv44K56YCB5L+hXHJcbiAgICBhd2FpdCBzZW5kRXJyb3JNZXRyaWMoXHJcbiAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5jb25zdHJ1Y3Rvci5uYW1lIDogJ1Vua25vd24nLFxyXG4gICAgICAnUXVlcnknXHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiBoYW5kbGVFcnJvcihlcnJvciBhcyBFcnJvciwgY29udGV4dC5hd3NSZXF1ZXN0SWQpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIEFQSeOCreODvOiqjeiovOOBruaknOiovFxyXG4gKlxyXG4gKiBAcGFyYW0gZXZlbnQgQVBJIEdhdGV3YXkgUHJveHkgRXZlbnRcclxuICogQHRocm93cyBWYWxpZGF0aW9uRXJyb3IgQVBJ44Kt44O844GM54Sh5Yq544Gq5aC05ZCIXHJcbiAqL1xyXG5mdW5jdGlvbiB2YWxpZGF0ZUFwaUtleShldmVudDogUXVlcnlFdmVudCk6IHZvaWQge1xyXG4gIGNvbnN0IGFwaUtleSA9IGV2ZW50LmhlYWRlcnNbJ3gtYXBpLWtleSddIHx8IGV2ZW50LmhlYWRlcnNbJ1gtQXBpLUtleSddO1xyXG5cclxuICBpZiAoIWFwaUtleSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignQVBJIGtleSBpcyByZXF1aXJlZC4gUGxlYXNlIHByb3ZpZGUgeC1hcGkta2V5IGhlYWRlci4nKTtcclxuICB9XHJcblxyXG4gIC8vIEFQSeOCreODvOOBruaknOiovO+8iOWun+mam+OBruWun+ijheOBp+OBr1NlY3JldHMgTWFuYWdlcuOBi+OCieWPluW+l+OBl+OBn+WApOOBqOavlOi8g++8iVxyXG4gIC8vIOOBk+OBk+OBp+OBr+eSsOWig+WkieaVsOOBi+OCieWPluW+l+OBl+OBn+WApOOBqOavlOi8g1xyXG4gIGNvbnN0IHZhbGlkQXBpS2V5ID0gcHJvY2Vzcy5lbnYuQVBJX0tFWTtcclxuXHJcbiAgaWYgKCF2YWxpZEFwaUtleSkge1xyXG4gICAgbG9nZ2VyLmVycm9yKCdBUElfS0VZIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIG5vdCBzZXQnKTtcclxuICAgIHRocm93IG5ldyBFcnJvcignQVBJIGtleSB2YWxpZGF0aW9uIGlzIG5vdCBjb25maWd1cmVkJyk7XHJcbiAgfVxyXG5cclxuICBpZiAoYXBpS2V5ICE9PSB2YWxpZEFwaUtleSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignSW52YWxpZCBBUEkga2V5Jyk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog44Kv44Ko44Oq44OR44Op44Oh44O844K/44Gu44OR44O844K5XHJcbiAqXHJcbiAqIEBwYXJhbSBldmVudCBBUEkgR2F0ZXdheSBQcm94eSBFdmVudFxyXG4gKiBAcmV0dXJucyDjg5Hjg7zjgrnmuIjjgb/jgq/jgqjjg6rjg5Hjg6njg6Hjg7zjgr9cclxuICogQHRocm93cyBWYWxpZGF0aW9uRXJyb3Ig44OQ44Oq44OH44O844K344On44Oz44Ko44Op44O8XHJcbiAqL1xyXG5mdW5jdGlvbiBwYXJzZVF1ZXJ5UGFyYW1ldGVycyhldmVudDogUXVlcnlFdmVudCk6IHtcclxuICBjb21wYW55X2NvZGU/OiBzdHJpbmc7XHJcbiAgc3RhcnRfZGF0ZT86IHN0cmluZztcclxuICBlbmRfZGF0ZT86IHN0cmluZztcclxuICBkaXNjbG9zdXJlX3R5cGU/OiBzdHJpbmc7XHJcbiAgZm9ybWF0OiAnanNvbicgfCAnY3N2JztcclxuICBsaW1pdDogbnVtYmVyO1xyXG4gIG9mZnNldDogbnVtYmVyO1xyXG59IHtcclxuICBjb25zdCBwYXJhbXMgPSBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMgfHwge307XHJcblxyXG4gIC8vIOODleOCqeODvOODnuODg+ODiOOBruODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gIGNvbnN0IGZvcm1hdCA9IChwYXJhbXMuZm9ybWF0IHx8ICdqc29uJykgYXMgJ2pzb24nIHwgJ2Nzdic7XHJcbiAgaWYgKCFbJ2pzb24nLCAnY3N2J10uaW5jbHVkZXMoZm9ybWF0KSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEludmFsaWQgZm9ybWF0OiAke2Zvcm1hdH0uIEV4cGVjdGVkICdqc29uJyBvciAnY3N2Jy5gXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8g44Oq44Of44OD44OI44Gu44OQ44Oq44OH44O844K344On44Oz77yI44OH44OV44Kp44Or44OIOiAxMDDjgIHmnIDlpKc6IDEwMDDvvIlcclxuICBsZXQgbGltaXQgPSAxMDA7XHJcbiAgaWYgKHBhcmFtcy5saW1pdCkge1xyXG4gICAgbGltaXQgPSBwYXJzZUludChwYXJhbXMubGltaXQsIDEwKTtcclxuICAgIGlmIChpc05hTihsaW1pdCkgfHwgbGltaXQgPCAxIHx8IGxpbWl0ID4gMTAwMCkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICAgIGBJbnZhbGlkIGxpbWl0OiAke3BhcmFtcy5saW1pdH0uIEV4cGVjdGVkIGEgbnVtYmVyIGJldHdlZW4gMSBhbmQgMTAwMC5gXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDjgqrjg5Xjgrvjg4Pjg4jjga7jg5Djg6rjg4fjg7zjgrfjg6fjg7PvvIjjg4fjg5Xjgqnjg6vjg4g6IDDvvIlcclxuICBsZXQgb2Zmc2V0ID0gMDtcclxuICBpZiAocGFyYW1zLm9mZnNldCkge1xyXG4gICAgb2Zmc2V0ID0gcGFyc2VJbnQocGFyYW1zLm9mZnNldCwgMTApO1xyXG4gICAgaWYgKGlzTmFOKG9mZnNldCkgfHwgb2Zmc2V0IDwgMCkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICAgIGBJbnZhbGlkIG9mZnNldDogJHtwYXJhbXMub2Zmc2V0fS4gRXhwZWN0ZWQgYSBub24tbmVnYXRpdmUgbnVtYmVyLmBcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOaXpeS7mOODleOCqeODvOODnuODg+ODiOOBruODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gIGlmIChwYXJhbXMuc3RhcnRfZGF0ZSkge1xyXG4gICAgdmFsaWRhdGVEYXRlRm9ybWF0KHBhcmFtcy5zdGFydF9kYXRlLCAnc3RhcnRfZGF0ZScpO1xyXG4gIH1cclxuICBpZiAocGFyYW1zLmVuZF9kYXRlKSB7XHJcbiAgICB2YWxpZGF0ZURhdGVGb3JtYXQocGFyYW1zLmVuZF9kYXRlLCAnZW5kX2RhdGUnKTtcclxuICB9XHJcblxyXG4gIC8vIOaXpeS7mOevhOWbsuOBrumghuW6j+aAp+ODgeOCp+ODg+OCr++8iFByb3BlcnR5IDjvvIlcclxuICBpZiAocGFyYW1zLnN0YXJ0X2RhdGUgJiYgcGFyYW1zLmVuZF9kYXRlKSB7XHJcbiAgICBjb25zdCBzdGFydERhdGUgPSBuZXcgRGF0ZShwYXJhbXMuc3RhcnRfZGF0ZSk7XHJcbiAgICBjb25zdCBlbmREYXRlID0gbmV3IERhdGUocGFyYW1zLmVuZF9kYXRlKTtcclxuXHJcbiAgICBpZiAoc3RhcnREYXRlID4gZW5kRGF0ZSkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICAgIGBzdGFydF9kYXRlICgke3BhcmFtcy5zdGFydF9kYXRlfSkgbXVzdCBiZSBiZWZvcmUgb3IgZXF1YWwgdG8gZW5kX2RhdGUgKCR7cGFyYW1zLmVuZF9kYXRlfSlgXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDkvIHmpa3jgrPjg7zjg4njga7jg5Djg6rjg4fjg7zjgrfjg6fjg7PvvIg05qGB44Gu5pWw5a2X77yJXHJcbiAgaWYgKHBhcmFtcy5jb21wYW55X2NvZGUpIHtcclxuICAgIGNvbnN0IGNvbXBhbnlDb2RlUmVnZXggPSAvXlxcZHs0fSQvO1xyXG4gICAgaWYgKCFjb21wYW55Q29kZVJlZ2V4LnRlc3QocGFyYW1zLmNvbXBhbnlfY29kZSkpIHtcclxuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgICBgSW52YWxpZCBjb21wYW55X2NvZGU6ICR7cGFyYW1zLmNvbXBhbnlfY29kZX0uIEV4cGVjdGVkIDQtZGlnaXQgbnVtYmVyLmBcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBjb21wYW55X2NvZGU6IHBhcmFtcy5jb21wYW55X2NvZGUsXHJcbiAgICBzdGFydF9kYXRlOiBwYXJhbXMuc3RhcnRfZGF0ZSxcclxuICAgIGVuZF9kYXRlOiBwYXJhbXMuZW5kX2RhdGUsXHJcbiAgICBkaXNjbG9zdXJlX3R5cGU6IHBhcmFtcy5kaXNjbG9zdXJlX3R5cGUsXHJcbiAgICBmb3JtYXQsXHJcbiAgICBsaW1pdCxcclxuICAgIG9mZnNldCxcclxuICB9O1xyXG59XHJcblxyXG4vKipcclxuICog5pel5LuY44OV44Kp44O844Oe44OD44OI44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAqXHJcbiAqIEBwYXJhbSBkYXRlIOaXpeS7mOaWh+Wtl+WIl++8iFlZWVktTU0tRETvvIlcclxuICogQHBhcmFtIGZpZWxkTmFtZSDjg5XjgqPjg7zjg6vjg4nlkI1cclxuICogQHRocm93cyBWYWxpZGF0aW9uRXJyb3Ig44OQ44Oq44OH44O844K344On44Oz44Ko44Op44O8XHJcbiAqL1xyXG5mdW5jdGlvbiB2YWxpZGF0ZURhdGVGb3JtYXQoZGF0ZTogc3RyaW5nLCBmaWVsZE5hbWU6IHN0cmluZyk6IHZvaWQge1xyXG4gIC8vIFlZWVktTU0tRETlvaLlvI/jga7jg4Hjgqfjg4Pjgq9cclxuICBjb25zdCBkYXRlUmVnZXggPSAvXlxcZHs0fS1cXGR7Mn0tXFxkezJ9JC87XHJcbiAgaWYgKCFkYXRlUmVnZXgudGVzdChkYXRlKSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEludmFsaWQgJHtmaWVsZE5hbWV9IGZvcm1hdDogJHtkYXRlfS4gRXhwZWN0ZWQgWVlZWS1NTS1ERCBmb3JtYXQuYFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIOacieWKueOBquaXpeS7mOOBi+ODgeOCp+ODg+OCr1xyXG4gIGNvbnN0IHBhcnNlZERhdGUgPSBuZXcgRGF0ZShkYXRlKTtcclxuICBpZiAoaXNOYU4ocGFyc2VkRGF0ZS5nZXRUaW1lKCkpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCAke2ZpZWxkTmFtZX06ICR7ZGF0ZX0uIERhdGUgZG9lcyBub3QgZXhpc3QuYFxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgqjjg6njg7zjg4/jg7Pjg4njg6rjg7PjgrBcclxuICpcclxuICog44Kr44K544K/44Og44Ko44Op44O844KS6YGp5YiH44GqSFRUUOOCueODhuODvOOCv+OCueOCs+ODvOODieOBqOOCqOODqeODvOOCs+ODvOODieOBq+WkieaPm+OBl+OBvuOBmeOAglxyXG4gKlxyXG4gKiBAcGFyYW0gZXJyb3Ig44Ko44Op44O844Kq44OW44K444Kn44Kv44OIXHJcbiAqIEBwYXJhbSByZXF1ZXN0SWQg44Oq44Kv44Ko44K544OISURcclxuICogQHJldHVybnMgQVBJIEdhdGV3YXkgUHJveHkgUmVzdWx0XHJcbiAqL1xyXG5mdW5jdGlvbiBoYW5kbGVFcnJvcihlcnJvcjogRXJyb3IsIHJlcXVlc3RJZDogc3RyaW5nKTogQVBJR2F0ZXdheVByb3h5UmVzdWx0IHtcclxuICAvLyDjgqjjg6njg7znqK7liKXjgavlv5zjgZjjgZ/jgrnjg4bjg7zjgr/jgrnjgrPjg7zjg4njgajjgqjjg6njg7zjgrPjg7zjg4lcclxuICBsZXQgc3RhdHVzQ29kZSA9IDUwMDtcclxuICBsZXQgZXJyb3JDb2RlID0gJ0lOVEVSTkFMX0VSUk9SJztcclxuXHJcbiAgaWYgKGVycm9yIGluc3RhbmNlb2YgVmFsaWRhdGlvbkVycm9yKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDAwO1xyXG4gICAgZXJyb3JDb2RlID0gJ1ZBTElEQVRJT05fRVJST1InO1xyXG4gIH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEVycm9yKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDA0O1xyXG4gICAgZXJyb3JDb2RlID0gJ05PVF9GT1VORCc7XHJcbiAgfSBlbHNlIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdBUEkga2V5JykpIHtcclxuICAgIHN0YXR1c0NvZGUgPSA0MDE7XHJcbiAgICBlcnJvckNvZGUgPSAnVU5BVVRIT1JJWkVEJztcclxuICB9XHJcblxyXG4gIC8vIOOCu+ODs+OCt+ODhuOCo+ODluaDheWgseOCkumZpOWkluOBl+OBn+OCqOODqeODvOODrOOCueODneODs+OCuVxyXG4gIGNvbnN0IGVycm9yUmVzcG9uc2UgPSB7XHJcbiAgICBlcnJvcl9jb2RlOiBlcnJvckNvZGUsXHJcbiAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxyXG4gICAgcmVxdWVzdF9pZDogcmVxdWVzdElkLFxyXG4gIH07XHJcblxyXG4gIC8vIOacrOeVqueSsOWig+OBp+OBr+OCueOCv+ODg+OCr+ODiOODrOODvOOCueOCkuWQq+OCgeOBquOBhFxyXG4gIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7XHJcbiAgICAoZXJyb3JSZXNwb25zZSBhcyBhbnkpLnN0YWNrID0gZXJyb3Iuc3RhY2s7XHJcbiAgfVxyXG5cclxuICByZXR1cm4ge1xyXG4gICAgc3RhdHVzQ29kZSxcclxuICAgIGhlYWRlcnM6IHtcclxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgIH0sXHJcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeShlcnJvclJlc3BvbnNlKSxcclxuICB9O1xyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==