3618d3cb197521b598d18b32275facc6
"use strict";
/**
 * Lambda Query Handler
 *
 * TDnet開示情報を検索するLambda関数のメインハンドラー。
 * API Gateway統合により、RESTful APIとして公開されます。
 *
 * Requirements: 要件4.1, 4.3, 4.4, 5.2, 11.1（検索API、認証、PDFダウンロード、CSV形式）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const logger_1 = require("../../utils/logger");
const cloudwatch_metrics_1 = require("../../utils/cloudwatch-metrics");
const errors_1 = require("../../errors");
const query_disclosures_1 = require("./query-disclosures");
const format_csv_1 = require("./format-csv");
// Secrets Managerクライアント（グローバルスコープで初期化）
const secretsClient = new client_secrets_manager_1.SecretsManagerClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });
// APIキーキャッシュ（5分TTL）
let cachedApiKey = null;
let cacheExpiry = 0;
/**
 * Secrets ManagerからAPIキーを取得
 *
 * @returns APIキー
 * @throws Error Secrets Managerからの取得に失敗した場合
 */
async function getApiKey() {
    // キャッシュチェック
    if (cachedApiKey && Date.now() < cacheExpiry) {
        return cachedApiKey;
    }
    const secretArn = process.env.API_KEY_SECRET_ARN;
    if (!secretArn) {
        throw new Error('API_KEY_SECRET_ARN environment variable is not set');
    }
    try {
        const command = new client_secrets_manager_1.GetSecretValueCommand({ SecretId: secretArn });
        const response = await secretsClient.send(command);
        if (!response.SecretString) {
            throw new Error('Secret value is empty');
        }
        // APIキーをキャッシュ（5分TTL）
        cachedApiKey = response.SecretString;
        cacheExpiry = Date.now() + 5 * 60 * 1000;
        return cachedApiKey;
    }
    catch (error) {
        logger_1.logger.error('Failed to retrieve API key from Secrets Manager', {
            error: error instanceof Error ? error.message : String(error),
            secret_arn: secretArn,
        });
        throw new Error('Failed to retrieve API key');
    }
}
/**
 * Lambda Queryハンドラー
 *
 * @param event API Gateway Proxy Event
 * @param context Lambda Context
 * @returns API Gateway Proxy Result
 *
 * @example
 * ```typescript
 * // 企業コードで検索
 * GET /disclosures?company_code=7203
 *
 * // 日付範囲で検索
 * GET /disclosures?start_date=2024-01-15&end_date=2024-01-20
 *
 * // CSV形式で取得
 * GET /disclosures?format=csv&start_date=2024-01-15&end_date=2024-01-20
 * ```
 */
async function handler(event, context) {
    const startTime = Date.now();
    try {
        logger_1.logger.info('Lambda Query started', {
            queryStringParameters: event.queryStringParameters,
            request_id: context.awsRequestId,
            function_name: context.functionName,
        });
        // APIキー認証の検証
        await validateApiKey(event);
        // クエリパラメータのパース
        const params = parseQueryParameters(event);
        // 開示情報を検索
        const result = await (0, query_disclosures_1.queryDisclosures)(params);
        const duration = Date.now() - startTime;
        logger_1.logger.info('Lambda Query completed', {
            request_id: context.awsRequestId,
            count: result.count,
            duration_ms: duration,
        });
        // 成功メトリクス送信
        await (0, cloudwatch_metrics_1.sendMetrics)([
            {
                name: 'LambdaExecutionTime',
                value: duration,
                unit: 'Milliseconds',
                dimensions: { FunctionName: 'Query' },
            },
            {
                name: 'QueryResultCount',
                value: result.count,
                unit: 'Count',
                dimensions: { Format: params.format },
            },
        ]);
        // フォーマット別レスポンス
        if (params.format === 'csv') {
            const csv = (0, format_csv_1.formatAsCsv)(result.disclosures);
            return {
                statusCode: 200,
                headers: {
                    'Content-Type': 'text/csv',
                    'Content-Disposition': `attachment; filename="disclosures-${Date.now()}.csv"`,
                    'Access-Control-Allow-Origin': '*',
                },
                body: csv,
            };
        }
        // JSON形式（デフォルト）
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify(result),
        };
    }
    catch (error) {
        const duration = Date.now() - startTime;
        logger_1.logger.error('Lambda Query failed', (0, logger_1.createErrorContext)(error, {
            request_id: context.awsRequestId,
            duration_ms: duration,
        }));
        // エラーメトリクス送信
        await (0, cloudwatch_metrics_1.sendErrorMetric)(error instanceof Error ? error.constructor.name : 'Unknown', 'Query');
        return handleError(error, context.awsRequestId);
    }
}
/**
 * 認証エラークラス
 */
class UnauthorizedError extends Error {
    constructor(message) {
        super(message);
        this.name = 'UnauthorizedError';
    }
}
/**
 * APIキー認証の検証
 *
 * @param event API Gateway Proxy Event
 * @throws UnauthorizedError APIキーが無効な場合
 */
async function validateApiKey(event) {
    const apiKey = event.headers['x-api-key'] || event.headers['X-Api-Key'];
    if (!apiKey) {
        throw new UnauthorizedError('API key is required. Please provide x-api-key header.');
    }
    // Secrets ManagerからAPIキーを取得
    const validApiKey = await getApiKey();
    if (apiKey !== validApiKey) {
        throw new UnauthorizedError('Invalid API key');
    }
}
/**
 * クエリパラメータのパース
 *
 * @param event API Gateway Proxy Event
 * @returns パース済みクエリパラメータ
 * @throws ValidationError バリデーションエラー
 */
function parseQueryParameters(event) {
    const params = event.queryStringParameters || {};
    // フォーマットのバリデーション
    const format = (params.format || 'json');
    if (!['json', 'csv'].includes(format)) {
        throw new errors_1.ValidationError(`Invalid format: ${format}. Expected 'json' or 'csv'.`);
    }
    // リミットのバリデーション（デフォルト: 100、最大: 1000）
    let limit = 100;
    if (params.limit) {
        limit = parseInt(params.limit, 10);
        if (isNaN(limit) || limit < 1 || limit > 1000) {
            throw new errors_1.ValidationError(`Invalid limit: ${params.limit}. Expected a number between 1 and 1000.`);
        }
    }
    // オフセットのバリデーション（デフォルト: 0）
    let offset = 0;
    if (params.offset) {
        offset = parseInt(params.offset, 10);
        if (isNaN(offset) || offset < 0) {
            throw new errors_1.ValidationError(`Invalid offset: ${params.offset}. Expected a non-negative number.`);
        }
    }
    // 日付フォーマットのバリデーション
    if (params.start_date) {
        validateDateFormat(params.start_date, 'start_date');
    }
    if (params.end_date) {
        validateDateFormat(params.end_date, 'end_date');
    }
    // 日付範囲の順序性チェック（Property 8）
    if (params.start_date && params.end_date) {
        const startDate = new Date(params.start_date);
        const endDate = new Date(params.end_date);
        if (startDate > endDate) {
            throw new errors_1.ValidationError(`start_date (${params.start_date}) must be before or equal to end_date (${params.end_date})`);
        }
    }
    // 企業コードのバリデーション（4桁の数字）
    if (params.company_code) {
        const companyCodeRegex = /^\d{4}$/;
        if (!companyCodeRegex.test(params.company_code)) {
            throw new errors_1.ValidationError(`Invalid company_code: ${params.company_code}. Expected 4-digit number.`);
        }
    }
    return {
        company_code: params.company_code,
        start_date: params.start_date,
        end_date: params.end_date,
        disclosure_type: params.disclosure_type,
        format,
        limit,
        offset,
    };
}
/**
 * 日付フォーマットのバリデーション
 *
 * @param date 日付文字列（YYYY-MM-DD）
 * @param fieldName フィールド名
 * @throws ValidationError バリデーションエラー
 */
function validateDateFormat(date, fieldName) {
    // YYYY-MM-DD形式のチェック
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateRegex.test(date)) {
        throw new errors_1.ValidationError(`Invalid ${fieldName} format: ${date}. Expected YYYY-MM-DD format.`);
    }
    // 有効な日付かチェック
    const parsedDate = new Date(date);
    if (isNaN(parsedDate.getTime())) {
        throw new errors_1.ValidationError(`Invalid ${fieldName}: ${date}. Date does not exist.`);
    }
}
/**
 * エラーハンドリング
 *
 * カスタムエラーを適切なHTTPステータスコードとエラーコードに変換します。
 *
 * @param error エラーオブジェクト
 * @param requestId リクエストID
 * @returns API Gateway Proxy Result
 */
function handleError(error, requestId) {
    // エラー種別に応じたステータスコードとエラーコード
    let statusCode = 500;
    let errorCode = 'INTERNAL_ERROR';
    if (error instanceof errors_1.ValidationError) {
        statusCode = 400;
        errorCode = 'VALIDATION_ERROR';
    }
    else if (error instanceof errors_1.NotFoundError) {
        statusCode = 404;
        errorCode = 'NOT_FOUND';
    }
    else if (error instanceof UnauthorizedError) {
        statusCode = 401;
        errorCode = 'UNAUTHORIZED';
    }
    else if (error.message.includes('API key')) {
        statusCode = 401;
        errorCode = 'UNAUTHORIZED';
    }
    // センシティブ情報を除外したエラーレスポンス
    const errorResponse = {
        error_code: errorCode,
        message: error.message,
        request_id: requestId,
    };
    // 本番環境ではスタックトレースを含めない
    if (process.env.NODE_ENV !== 'production') {
        errorResponse.stack = error.stack;
    }
    return {
        statusCode,
        headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
        },
        body: JSON.stringify(errorResponse),
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXHF1ZXJ5XFxoYW5kbGVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7OztHQU9HOztBQStHSCwwQkF3RkM7QUFwTUQsNEVBQThGO0FBQzlGLCtDQUFnRTtBQUNoRSx1RUFBOEU7QUFDOUUseUNBQThEO0FBQzlELDJEQUF1RDtBQUN2RCw2Q0FBMkM7QUFHM0MsdUNBQXVDO0FBQ3ZDLE1BQU0sYUFBYSxHQUFHLElBQUksNkNBQW9CLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO0FBRXZHLG9CQUFvQjtBQUNwQixJQUFJLFlBQVksR0FBa0IsSUFBSSxDQUFDO0FBQ3ZDLElBQUksV0FBVyxHQUFXLENBQUMsQ0FBQztBQUU1Qjs7Ozs7R0FLRztBQUNILEtBQUssVUFBVSxTQUFTO0lBQ3RCLFlBQVk7SUFDWixJQUFJLFlBQVksSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsV0FBVyxFQUFFLENBQUM7UUFDN0MsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQztJQUVELE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUM7SUFDakQsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2YsTUFBTSxJQUFJLEtBQUssQ0FBQyxvREFBb0QsQ0FBQyxDQUFDO0lBQ3hFLENBQUM7SUFFRCxJQUFJLENBQUM7UUFDSCxNQUFNLE9BQU8sR0FBRyxJQUFJLDhDQUFxQixDQUFDLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7UUFDbkUsTUFBTSxRQUFRLEdBQUcsTUFBTSxhQUFhLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRW5ELElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDM0IsTUFBTSxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsQ0FB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QVUsR0FBRyxHQUFHLENBQUM7UUFDakIsU0FBUyxHQUFHLFdBQVcsQ0FBQztJQUMxQixDQUFDO1NBQU0sSUFBSSxLQUFLLFlBQVksaUJBQWlCLEVBQUUsQ0FBQztRQUM5QyxVQUFVLEdBQUcsR0FBRyxDQUFDO1FBQ2pCLFNBQVMsR0FBRyxjQUFjLENBQUM7SUFDN0IsQ0FBQztTQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztRQUM3QyxVQUFVLEdBQUcsR0FBRyxDQUFDO1FBQ2pCLFNBQVMsR0FBRyxjQUFjLENBQUM7SUFDN0IsQ0FBQztJQUVELHdCQUF3QjtJQUN4QixNQUFNLGFBQWEsR0FBRztRQUNwQixVQUFVLEVBQUUsU0FBUztRQUNyQixPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU87UUFDdEIsVUFBVSxFQUFFLFNBQVM7S0FDdEIsQ0FBQztJQUVGLHNCQUFzQjtJQUN0QixJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLFlBQVksRUFBRSxDQUFDO1FBQ3pDLGFBQXFCLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUM7SUFDN0MsQ0FBQztJQUVELE9BQU87UUFDTCxVQUFVO1FBQ1YsT0FBTyxFQUFFO1lBQ1AsY0FBYyxFQUFFLGtCQUFrQjtZQUNsQyw2QkFBNkIsRUFBRSxHQUFHO1NBQ25DO1FBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDO0tBQ3BDLENBQUM7QUFDSixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcdGkxOThcXGludmVzdG1lbnRfYW5hbHlzaXNfb3BvcG9cXHNyY1xcbGFtYmRhXFxxdWVyeVxcaGFuZGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogTGFtYmRhIFF1ZXJ5IEhhbmRsZXJcclxuICpcclxuICogVERuZXTplovnpLrmg4XloLHjgpLmpJzntKLjgZnjgotMYW1iZGHplqLmlbDjga7jg6HjgqTjg7Pjg4/jg7Pjg4njg6njg7zjgIJcclxuICogQVBJIEdhdGV3YXnntbHlkIjjgavjgojjgorjgIFSRVNUZnVsIEFQSeOBqOOBl+OBpuWFrOmWi+OBleOCjOOBvuOBmeOAglxyXG4gKlxyXG4gKiBSZXF1aXJlbWVudHM6IOimgeS7tjQuMSwgNC4zLCA0LjQsIDUuMiwgMTEuMe+8iOaknOe0okFQSeOAgeiqjeiovOOAgVBERuODgOOCpuODs+ODreODvOODieOAgUNTVuW9ouW8j++8iVxyXG4gKi9cclxuXHJcbmltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQsIENvbnRleHQgfSBmcm9tICdhd3MtbGFtYmRhJztcclxuaW1wb3J0IHsgU2VjcmV0c01hbmFnZXJDbGllbnQsIEdldFNlY3JldFZhbHVlQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zZWNyZXRzLW1hbmFnZXInO1xyXG5pbXBvcnQgeyBsb2dnZXIsIGNyZWF0ZUVycm9yQ29udGV4dCB9IGZyb20gJy4uLy4uL3V0aWxzL2xvZ2dlcic7XHJcbmltcG9ydCB7IHNlbmRFcnJvck1ldHJpYywgc2VuZE1ldHJpY3MgfSBmcm9tICcuLi8uLi91dGlscy9jbG91ZHdhdGNoLW1ldHJpY3MnO1xyXG5pbXBvcnQgeyBWYWxpZGF0aW9uRXJyb3IsIE5vdEZvdW5kRXJyb3IgfSBmcm9tICcuLi8uLi9lcnJvcnMnO1xyXG5pbXBvcnQgeyBxdWVyeURpc2Nsb3N1cmVzIH0gZnJvbSAnLi9xdWVyeS1kaXNjbG9zdXJlcyc7XHJcbmltcG9ydCB7IGZvcm1hdEFzQ3N2IH0gZnJvbSAnLi9mb3JtYXQtY3N2JztcclxuaW1wb3J0IHsgRGlzY2xvc3VyZSB9IGZyb20gJy4uLy4uL3R5cGVzJztcclxuXHJcbi8vIFNlY3JldHMgTWFuYWdlcuOCr+ODqeOCpOOCouODs+ODiO+8iOOCsOODreODvOODkOODq+OCueOCs+ODvOODl+OBp+WIneacn+WMlu+8iVxyXG5jb25zdCBzZWNyZXRzQ2xpZW50ID0gbmV3IFNlY3JldHNNYW5hZ2VyQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICdhcC1ub3J0aGVhc3QtMScgfSk7XHJcblxyXG4vLyBBUEnjgq3jg7zjgq3jg6Pjg4Pjgrfjg6XvvIg15YiGVFRM77yJXHJcbmxldCBjYWNoZWRBcGlLZXk6IHN0cmluZyB8IG51bGwgPSBudWxsO1xyXG5sZXQgY2FjaGVFeHBpcnk6IG51bWJlciA9IDA7XHJcblxyXG4vKipcclxuICogU2VjcmV0cyBNYW5hZ2Vy44GL44KJQVBJ44Kt44O844KS5Y+W5b6XXHJcbiAqXHJcbiAqIEByZXR1cm5zIEFQSeOCreODvFxyXG4gKiBAdGhyb3dzIEVycm9yIFNlY3JldHMgTWFuYWdlcuOBi+OCieOBruWPluW+l+OBq+WkseaVl+OBl+OBn+WgtOWQiFxyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gZ2V0QXBpS2V5KCk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgLy8g44Kt44Oj44OD44K344Ol44OB44Kn44OD44KvXHJcbiAgaWYgKGNhY2hlZEFwaUtleSAmJiBEYXRlLm5vdygpIDwgY2FjaGVFeHBpcnkpIHtcclxuICAgIHJldHVybiBjYWNoZWRBcGlLZXk7XHJcbiAgfVxyXG5cclxuICBjb25zdCBzZWNyZXRBcm4gPSBwcm9jZXNzLmVudi5BUElfS0VZX1NFQ1JFVF9BUk47XHJcbiAgaWYgKCFzZWNyZXRBcm4pIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignQVBJX0tFWV9TRUNSRVRfQVJOIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIG5vdCBzZXQnKTtcclxuICB9XHJcblxyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldFNlY3JldFZhbHVlQ29tbWFuZCh7IFNlY3JldElkOiBzZWNyZXRBcm4gfSk7XHJcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHNlY3JldHNDbGllbnQuc2VuZChjb21tYW5kKTtcclxuXHJcbiAgICBpZiAoIXJlc3BvbnNlLlNlY3JldFN0cmluZykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NlY3JldCB2YWx1ZSBpcyBlbXB0eScpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEFQSeOCreODvOOCkuOCreODo+ODg+OCt+ODpe+8iDXliIZUVEzvvIlcclxuICAgIGNhY2hlZEFwaUtleSA9IHJlc3BvbnNlLlNlY3JldFN0cmluZztcclxuICAgIGNhY2hlRXhwaXJ5ID0gRGF0ZS5ub3coKSArIDUgKiA2MCAqIDEwMDA7XHJcblxyXG4gICAgcmV0dXJuIGNhY2hlZEFwaUtleTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gcmV0cmlldmUgQVBJIGtleSBmcm9tIFNlY3JldHMgTWFuYWdlcicsIHtcclxuICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcclxuICAgICAgc2VjcmV0X2Fybjogc2VjcmV0QXJuLFxyXG4gICAgfSk7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSBBUEkga2V5Jyk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogTGFtYmRhIFF1ZXJ544Kk44OZ44Oz44OI77yIQVBJIEdhdGV3YXnntbHlkIjvvIlcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgUXVlcnlFdmVudCBleHRlbmRzIEFQSUdhdGV3YXlQcm94eUV2ZW50IHtcclxuICBxdWVyeVN0cmluZ1BhcmFtZXRlcnM6IHtcclxuICAgIGNvbXBhbnlfY29kZT86IHN0cmluZztcclxuICAgIHN0YXJ0X2RhdGU/OiBzdHJpbmc7XHJcbiAgICBlbmRfZGF0ZT86IHN0cmluZztcclxuICAgIGRpc2Nsb3N1cmVfdHlwZT86IHN0cmluZztcclxuICAgIGZvcm1hdD86ICdqc29uJyB8ICdjc3YnO1xyXG4gICAgbGltaXQ/OiBzdHJpbmc7XHJcbiAgICBvZmZzZXQ/OiBzdHJpbmc7XHJcbiAgfSB8IG51bGw7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgq/jgqjjg6rjg6zjgrnjg53jg7PjgrlcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgUXVlcnlSZXNwb25zZSB7XHJcbiAgLyoqIOaknOe0oue1kOaenCAqL1xyXG4gIGRpc2Nsb3N1cmVzOiBEaXNjbG9zdXJlW107XHJcblxyXG4gIC8qKiDnt4/ku7bmlbAgKi9cclxuICB0b3RhbDogbnVtYmVyO1xyXG5cclxuICAvKiog5Y+W5b6X5Lu25pWwICovXHJcbiAgY291bnQ6IG51bWJlcjtcclxuXHJcbiAgLyoqIOOCquODleOCu+ODg+ODiCAqL1xyXG4gIG9mZnNldDogbnVtYmVyO1xyXG5cclxuICAvKiog44Oq44Of44OD44OIICovXHJcbiAgbGltaXQ6IG51bWJlcjtcclxufVxyXG5cclxuLyoqXHJcbiAqIExhbWJkYSBRdWVyeeODj+ODs+ODieODqeODvFxyXG4gKlxyXG4gKiBAcGFyYW0gZXZlbnQgQVBJIEdhdGV3YXkgUHJveHkgRXZlbnRcclxuICogQHBhcmFtIGNvbnRleHQgTGFtYmRhIENvbnRleHRcclxuICogQHJldHVybnMgQVBJIEdhdGV3YXkgUHJveHkgUmVzdWx0XHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYHR5cGVzY3JpcHRcclxuICogLy8g5LyB5qWt44Kz44O844OJ44Gn5qSc57SiXHJcbiAqIEdFVCAvZGlzY2xvc3VyZXM/Y29tcGFueV9jb2RlPTcyMDNcclxuICpcclxuICogLy8g5pel5LuY56+E5Zuy44Gn5qSc57SiXHJcbiAqIEdFVCAvZGlzY2xvc3VyZXM/c3RhcnRfZGF0ZT0yMDI0LTAxLTE1JmVuZF9kYXRlPTIwMjQtMDEtMjBcclxuICpcclxuICogLy8gQ1NW5b2i5byP44Gn5Y+W5b6XXHJcbiAqIEdFVCAvZGlzY2xvc3VyZXM/Zm9ybWF0PWNzdiZzdGFydF9kYXRlPTIwMjQtMDEtMTUmZW5kX2RhdGU9MjAyNC0wMS0yMFxyXG4gKiBgYGBcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVyKFxyXG4gIGV2ZW50OiBRdWVyeUV2ZW50LFxyXG4gIGNvbnRleHQ6IENvbnRleHRcclxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcclxuICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xyXG5cclxuICB0cnkge1xyXG4gICAgbG9nZ2VyLmluZm8oJ0xhbWJkYSBRdWVyeSBzdGFydGVkJywge1xyXG4gICAgICBxdWVyeVN0cmluZ1BhcmFtZXRlcnM6IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyxcclxuICAgICAgcmVxdWVzdF9pZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXHJcbiAgICAgIGZ1bmN0aW9uX25hbWU6IGNvbnRleHQuZnVuY3Rpb25OYW1lLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gQVBJ44Kt44O86KqN6Ki844Gu5qSc6Ki8XHJcbiAgICBhd2FpdCB2YWxpZGF0ZUFwaUtleShldmVudCk7XHJcblxyXG4gICAgLy8g44Kv44Ko44Oq44OR44Op44Oh44O844K/44Gu44OR44O844K5XHJcbiAgICBjb25zdCBwYXJhbXMgPSBwYXJzZVF1ZXJ5UGFyYW1ldGVycyhldmVudCk7XHJcblxyXG4gICAgLy8g6ZaL56S65oOF5aCx44KS5qSc57SiXHJcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBxdWVyeURpc2Nsb3N1cmVzKHBhcmFtcyk7XHJcblxyXG4gICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xyXG5cclxuICAgIGxvZ2dlci5pbmZvKCdMYW1iZGEgUXVlcnkgY29tcGxldGVkJywge1xyXG4gICAgICByZXF1ZXN0X2lkOiBjb250ZXh0LmF3c1JlcXVlc3RJZCxcclxuICAgICAgY291bnQ6IHJlc3VsdC5jb3VudCxcclxuICAgICAgZHVyYXRpb25fbXM6IGR1cmF0aW9uLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g5oiQ5Yqf44Oh44OI44Oq44Kv44K56YCB5L+hXHJcbiAgICBhd2FpdCBzZW5kTWV0cmljcyhbXHJcbiAgICAgIHtcclxuICAgICAgICBuYW1lOiAnTGFtYmRhRXhlY3V0aW9uVGltZScsXHJcbiAgICAgICAgdmFsdWU6IGR1cmF0aW9uLFxyXG4gICAgICAgIHVuaXQ6ICdNaWxsaXNlY29uZHMnLFxyXG4gICAgICAgIGRpbWVuc2lvbnM6IHsgRnVuY3Rpb25OYW1lOiAnUXVlcnknIH0sXHJcbiAgICAgIH0sXHJcbiAgICAgIHtcclxuICAgICAgICBuYW1lOiAnUXVlcnlSZXN1bHRDb3VudCcsXHJcbiAgICAgICAgdmFsdWU6IHJlc3VsdC5jb3VudCxcclxuICAgICAgICB1bml0OiAnQ291bnQnLFxyXG4gICAgICAgIGRpbWVuc2lvbnM6IHsgRm9ybWF0OiBwYXJhbXMuZm9ybWF0IH0sXHJcbiAgICAgIH0sXHJcbiAgICBdKTtcclxuXHJcbiAgICAvLyDjg5Xjgqnjg7zjg57jg4Pjg4jliKXjg6zjgrnjg53jg7PjgrlcclxuICAgIGlmIChwYXJhbXMuZm9ybWF0ID09PSAnY3N2Jykge1xyXG4gICAgICBjb25zdCBjc3YgPSBmb3JtYXRBc0NzdihyZXN1bHQuZGlzY2xvc3VyZXMpO1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHN0YXR1c0NvZGU6IDIwMCxcclxuICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ3RleHQvY3N2JyxcclxuICAgICAgICAgICdDb250ZW50LURpc3Bvc2l0aW9uJzogYGF0dGFjaG1lbnQ7IGZpbGVuYW1lPVwiZGlzY2xvc3VyZXMtJHtEYXRlLm5vdygpfS5jc3ZcImAsXHJcbiAgICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgYm9keTogY3N2LFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEpTT07lvaLlvI/vvIjjg4fjg5Xjgqnjg6vjg4jvvIlcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcclxuICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgICAgfSxcclxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVzdWx0KSxcclxuICAgIH07XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcclxuXHJcbiAgICBsb2dnZXIuZXJyb3IoXHJcbiAgICAgICdMYW1iZGEgUXVlcnkgZmFpbGVkJyxcclxuICAgICAgY3JlYXRlRXJyb3JDb250ZXh0KGVycm9yIGFzIEVycm9yLCB7XHJcbiAgICAgICAgcmVxdWVzdF9pZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXHJcbiAgICAgICAgZHVyYXRpb25fbXM6IGR1cmF0aW9uLFxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICAvLyDjgqjjg6njg7zjg6Hjg4jjg6rjgq/jgrnpgIHkv6FcclxuICAgIGF3YWl0IHNlbmRFcnJvck1ldHJpYyhcclxuICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLmNvbnN0cnVjdG9yLm5hbWUgOiAnVW5rbm93bicsXHJcbiAgICAgICdRdWVyeSdcclxuICAgICk7XHJcblxyXG4gICAgcmV0dXJuIGhhbmRsZUVycm9yKGVycm9yIGFzIEVycm9yLCBjb250ZXh0LmF3c1JlcXVlc3RJZCk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog6KqN6Ki844Ko44Op44O844Kv44Op44K5XHJcbiAqL1xyXG5jbGFzcyBVbmF1dGhvcml6ZWRFcnJvciBleHRlbmRzIEVycm9yIHtcclxuICBjb25zdHJ1Y3RvcihtZXNzYWdlOiBzdHJpbmcpIHtcclxuICAgIHN1cGVyKG1lc3NhZ2UpO1xyXG4gICAgdGhpcy5uYW1lID0gJ1VuYXV0aG9yaXplZEVycm9yJztcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBBUEnjgq3jg7zoqo3oqLzjga7mpJzoqLxcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEFQSSBHYXRld2F5IFByb3h5IEV2ZW50XHJcbiAqIEB0aHJvd3MgVW5hdXRob3JpemVkRXJyb3IgQVBJ44Kt44O844GM54Sh5Yq544Gq5aC05ZCIXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiB2YWxpZGF0ZUFwaUtleShldmVudDogUXVlcnlFdmVudCk6IFByb21pc2U8dm9pZD4ge1xyXG4gIGNvbnN0IGFwaUtleSA9IGV2ZW50LmhlYWRlcnNbJ3gtYXBpLWtleSddIHx8IGV2ZW50LmhlYWRlcnNbJ1gtQXBpLUtleSddO1xyXG5cclxuICBpZiAoIWFwaUtleSkge1xyXG4gICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEVycm9yKCdBUEkga2V5IGlzIHJlcXVpcmVkLiBQbGVhc2UgcHJvdmlkZSB4LWFwaS1rZXkgaGVhZGVyLicpO1xyXG4gIH1cclxuXHJcbiAgLy8gU2VjcmV0cyBNYW5hZ2Vy44GL44KJQVBJ44Kt44O844KS5Y+W5b6XXHJcbiAgY29uc3QgdmFsaWRBcGlLZXkgPSBhd2FpdCBnZXRBcGlLZXkoKTtcclxuXHJcbiAgaWYgKGFwaUtleSAhPT0gdmFsaWRBcGlLZXkpIHtcclxuICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFcnJvcignSW52YWxpZCBBUEkga2V5Jyk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog44Kv44Ko44Oq44OR44Op44Oh44O844K/44Gu44OR44O844K5XHJcbiAqXHJcbiAqIEBwYXJhbSBldmVudCBBUEkgR2F0ZXdheSBQcm94eSBFdmVudFxyXG4gKiBAcmV0dXJucyDjg5Hjg7zjgrnmuIjjgb/jgq/jgqjjg6rjg5Hjg6njg6Hjg7zjgr9cclxuICogQHRocm93cyBWYWxpZGF0aW9uRXJyb3Ig44OQ44Oq44OH44O844K344On44Oz44Ko44Op44O8XHJcbiAqL1xyXG5mdW5jdGlvbiBwYXJzZVF1ZXJ5UGFyYW1ldGVycyhldmVudDogUXVlcnlFdmVudCk6IHtcclxuICBjb21wYW55X2NvZGU/OiBzdHJpbmc7XHJcbiAgc3RhcnRfZGF0ZT86IHN0cmluZztcclxuICBlbmRfZGF0ZT86IHN0cmluZztcclxuICBkaXNjbG9zdXJlX3R5cGU/OiBzdHJpbmc7XHJcbiAgZm9ybWF0OiAnanNvbicgfCAnY3N2JztcclxuICBsaW1pdDogbnVtYmVyO1xyXG4gIG9mZnNldDogbnVtYmVyO1xyXG59IHtcclxuICBjb25zdCBwYXJhbXMgPSBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMgfHwge307XHJcblxyXG4gIC8vIOODleOCqeODvOODnuODg+ODiOOBruODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gIGNvbnN0IGZvcm1hdCA9IChwYXJhbXMuZm9ybWF0IHx8ICdqc29uJykgYXMgJ2pzb24nIHwgJ2Nzdic7XHJcbiAgaWYgKCFbJ2pzb24nLCAnY3N2J10uaW5jbHVkZXMoZm9ybWF0KSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEludmFsaWQgZm9ybWF0OiAke2Zvcm1hdH0uIEV4cGVjdGVkICdqc29uJyBvciAnY3N2Jy5gXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8g44Oq44Of44OD44OI44Gu44OQ44Oq44OH44O844K344On44Oz77yI44OH44OV44Kp44Or44OIOiAxMDDjgIHmnIDlpKc6IDEwMDDvvIlcclxuICBsZXQgbGltaXQgPSAxMDA7XHJcbiAgaWYgKHBhcmFtcy5saW1pdCkge1xyXG4gICAgbGltaXQgPSBwYXJzZUludChwYXJhbXMubGltaXQsIDEwKTtcclxuICAgIGlmIChpc05hTihsaW1pdCkgfHwgbGltaXQgPCAxIHx8IGxpbWl0ID4gMTAwMCkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICAgIGBJbnZhbGlkIGxpbWl0OiAke3BhcmFtcy5saW1pdH0uIEV4cGVjdGVkIGEgbnVtYmVyIGJldHdlZW4gMSBhbmQgMTAwMC5gXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDjgqrjg5Xjgrvjg4Pjg4jjga7jg5Djg6rjg4fjg7zjgrfjg6fjg7PvvIjjg4fjg5Xjgqnjg6vjg4g6IDDvvIlcclxuICBsZXQgb2Zmc2V0ID0gMDtcclxuICBpZiAocGFyYW1zLm9mZnNldCkge1xyXG4gICAgb2Zmc2V0ID0gcGFyc2VJbnQocGFyYW1zLm9mZnNldCwgMTApO1xyXG4gICAgaWYgKGlzTmFOKG9mZnNldCkgfHwgb2Zmc2V0IDwgMCkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICAgIGBJbnZhbGlkIG9mZnNldDogJHtwYXJhbXMub2Zmc2V0fS4gRXhwZWN0ZWQgYSBub24tbmVnYXRpdmUgbnVtYmVyLmBcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOaXpeS7mOODleOCqeODvOODnuODg+ODiOOBruODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gIGlmIChwYXJhbXMuc3RhcnRfZGF0ZSkge1xyXG4gICAgdmFsaWRhdGVEYXRlRm9ybWF0KHBhcmFtcy5zdGFydF9kYXRlLCAnc3RhcnRfZGF0ZScpO1xyXG4gIH1cclxuICBpZiAocGFyYW1zLmVuZF9kYXRlKSB7XHJcbiAgICB2YWxpZGF0ZURhdGVGb3JtYXQocGFyYW1zLmVuZF9kYXRlLCAnZW5kX2RhdGUnKTtcclxuICB9XHJcblxyXG4gIC8vIOaXpeS7mOevhOWbsuOBrumghuW6j+aAp+ODgeOCp+ODg+OCr++8iFByb3BlcnR5IDjvvIlcclxuICBpZiAocGFyYW1zLnN0YXJ0X2RhdGUgJiYgcGFyYW1zLmVuZF9kYXRlKSB7XHJcbiAgICBjb25zdCBzdGFydERhdGUgPSBuZXcgRGF0ZShwYXJhbXMuc3RhcnRfZGF0ZSk7XHJcbiAgICBjb25zdCBlbmREYXRlID0gbmV3IERhdGUocGFyYW1zLmVuZF9kYXRlKTtcclxuXHJcbiAgICBpZiAoc3RhcnREYXRlID4gZW5kRGF0ZSkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICAgIGBzdGFydF9kYXRlICgke3BhcmFtcy5zdGFydF9kYXRlfSkgbXVzdCBiZSBiZWZvcmUgb3IgZXF1YWwgdG8gZW5kX2RhdGUgKCR7cGFyYW1zLmVuZF9kYXRlfSlgXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDkvIHmpa3jgrPjg7zjg4njga7jg5Djg6rjg4fjg7zjgrfjg6fjg7PvvIg05qGB44Gu5pWw5a2X77yJXHJcbiAgaWYgKHBhcmFtcy5jb21wYW55X2NvZGUpIHtcclxuICAgIGNvbnN0IGNvbXBhbnlDb2RlUmVnZXggPSAvXlxcZHs0fSQvO1xyXG4gICAgaWYgKCFjb21wYW55Q29kZVJlZ2V4LnRlc3QocGFyYW1zLmNvbXBhbnlfY29kZSkpIHtcclxuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgICBgSW52YWxpZCBjb21wYW55X2NvZGU6ICR7cGFyYW1zLmNvbXBhbnlfY29kZX0uIEV4cGVjdGVkIDQtZGlnaXQgbnVtYmVyLmBcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBjb21wYW55X2NvZGU6IHBhcmFtcy5jb21wYW55X2NvZGUsXHJcbiAgICBzdGFydF9kYXRlOiBwYXJhbXMuc3RhcnRfZGF0ZSxcclxuICAgIGVuZF9kYXRlOiBwYXJhbXMuZW5kX2RhdGUsXHJcbiAgICBkaXNjbG9zdXJlX3R5cGU6IHBhcmFtcy5kaXNjbG9zdXJlX3R5cGUsXHJcbiAgICBmb3JtYXQsXHJcbiAgICBsaW1pdCxcclxuICAgIG9mZnNldCxcclxuICB9O1xyXG59XHJcblxyXG4vKipcclxuICog5pel5LuY44OV44Kp44O844Oe44OD44OI44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAqXHJcbiAqIEBwYXJhbSBkYXRlIOaXpeS7mOaWh+Wtl+WIl++8iFlZWVktTU0tRETvvIlcclxuICogQHBhcmFtIGZpZWxkTmFtZSDjg5XjgqPjg7zjg6vjg4nlkI1cclxuICogQHRocm93cyBWYWxpZGF0aW9uRXJyb3Ig44OQ44Oq44OH44O844K344On44Oz44Ko44Op44O8XHJcbiAqL1xyXG5mdW5jdGlvbiB2YWxpZGF0ZURhdGVGb3JtYXQoZGF0ZTogc3RyaW5nLCBmaWVsZE5hbWU6IHN0cmluZyk6IHZvaWQge1xyXG4gIC8vIFlZWVktTU0tRETlvaLlvI/jga7jg4Hjgqfjg4Pjgq9cclxuICBjb25zdCBkYXRlUmVnZXggPSAvXlxcZHs0fS1cXGR7Mn0tXFxkezJ9JC87XHJcbiAgaWYgKCFkYXRlUmVnZXgudGVzdChkYXRlKSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEludmFsaWQgJHtmaWVsZE5hbWV9IGZvcm1hdDogJHtkYXRlfS4gRXhwZWN0ZWQgWVlZWS1NTS1ERCBmb3JtYXQuYFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIOacieWKueOBquaXpeS7mOOBi+ODgeOCp+ODg+OCr1xyXG4gIGNvbnN0IHBhcnNlZERhdGUgPSBuZXcgRGF0ZShkYXRlKTtcclxuICBpZiAoaXNOYU4ocGFyc2VkRGF0ZS5nZXRUaW1lKCkpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCAke2ZpZWxkTmFtZX06ICR7ZGF0ZX0uIERhdGUgZG9lcyBub3QgZXhpc3QuYFxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgqjjg6njg7zjg4/jg7Pjg4njg6rjg7PjgrBcclxuICpcclxuICog44Kr44K544K/44Og44Ko44Op44O844KS6YGp5YiH44GqSFRUUOOCueODhuODvOOCv+OCueOCs+ODvOODieOBqOOCqOODqeODvOOCs+ODvOODieOBq+WkieaPm+OBl+OBvuOBmeOAglxyXG4gKlxyXG4gKiBAcGFyYW0gZXJyb3Ig44Ko44Op44O844Kq44OW44K444Kn44Kv44OIXHJcbiAqIEBwYXJhbSByZXF1ZXN0SWQg44Oq44Kv44Ko44K544OISURcclxuICogQHJldHVybnMgQVBJIEdhdGV3YXkgUHJveHkgUmVzdWx0XHJcbiAqL1xyXG5mdW5jdGlvbiBoYW5kbGVFcnJvcihlcnJvcjogRXJyb3IsIHJlcXVlc3RJZDogc3RyaW5nKTogQVBJR2F0ZXdheVByb3h5UmVzdWx0IHtcclxuICAvLyDjgqjjg6njg7znqK7liKXjgavlv5zjgZjjgZ/jgrnjg4bjg7zjgr/jgrnjgrPjg7zjg4njgajjgqjjg6njg7zjgrPjg7zjg4lcclxuICBsZXQgc3RhdHVzQ29kZSA9IDUwMDtcclxuICBsZXQgZXJyb3JDb2RlID0gJ0lOVEVSTkFMX0VSUk9SJztcclxuXHJcbiAgaWYgKGVycm9yIGluc3RhbmNlb2YgVmFsaWRhdGlvbkVycm9yKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDAwO1xyXG4gICAgZXJyb3JDb2RlID0gJ1ZBTElEQVRJT05fRVJST1InO1xyXG4gIH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEVycm9yKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDA0O1xyXG4gICAgZXJyb3JDb2RlID0gJ05PVF9GT1VORCc7XHJcbiAgfSBlbHNlIGlmIChlcnJvciBpbnN0YW5jZW9mIFVuYXV0aG9yaXplZEVycm9yKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDAxO1xyXG4gICAgZXJyb3JDb2RlID0gJ1VOQVVUSE9SSVpFRCc7XHJcbiAgfSBlbHNlIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdBUEkga2V5JykpIHtcclxuICAgIHN0YXR1c0NvZGUgPSA0MDE7XHJcbiAgICBlcnJvckNvZGUgPSAnVU5BVVRIT1JJWkVEJztcclxuICB9XHJcblxyXG4gIC8vIOOCu+ODs+OCt+ODhuOCo+ODluaDheWgseOCkumZpOWkluOBl+OBn+OCqOODqeODvOODrOOCueODneODs+OCuVxyXG4gIGNvbnN0IGVycm9yUmVzcG9uc2UgPSB7XHJcbiAgICBlcnJvcl9jb2RlOiBlcnJvckNvZGUsXHJcbiAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxyXG4gICAgcmVxdWVzdF9pZDogcmVxdWVzdElkLFxyXG4gIH07XHJcblxyXG4gIC8vIOacrOeVqueSsOWig+OBp+OBr+OCueOCv+ODg+OCr+ODiOODrOODvOOCueOCkuWQq+OCgeOBquOBhFxyXG4gIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7XHJcbiAgICAoZXJyb3JSZXNwb25zZSBhcyBhbnkpLnN0YWNrID0gZXJyb3Iuc3RhY2s7XHJcbiAgfVxyXG5cclxuICByZXR1cm4ge1xyXG4gICAgc3RhdHVzQ29kZSxcclxuICAgIGhlYWRlcnM6IHtcclxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgIH0sXHJcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeShlcnJvclJlc3BvbnNlKSxcclxuICB9O1xyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==