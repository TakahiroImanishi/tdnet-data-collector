438e9d0f75bc723e622a487fee062a86
"use strict";
/**
 * Lambda Query Handler
 *
 * TDnet開示情報を検索するLambda関数のメインハンドラー。
 * API Gateway統合により、RESTful APIとして公開されます。
 *
 * Requirements: 要件4.1, 4.3, 4.4, 5.2, 11.1（検索API、認証、PDFダウンロード、CSV形式）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const logger_1 = require("../../utils/logger");
const cloudwatch_metrics_1 = require("../../utils/cloudwatch-metrics");
const errors_1 = require("../../errors");
const query_disclosures_1 = require("./query-disclosures");
const format_csv_1 = require("./format-csv");
// Secrets Managerクライアント（グローバルスコープで初期化）
const secretsClient = new client_secrets_manager_1.SecretsManagerClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });
// APIキーキャッシュ（5分TTL）
let cachedApiKey = null;
let cacheExpiry = 0;
/**
 * Secrets ManagerからAPIキーを取得
 *
 * テスト環境（TEST_ENV=e2e）では、API_KEY環境変数から直接取得します。
 * 本番環境では、Secrets Managerから取得します。
 *
 * @returns APIキー
 * @throws Error Secrets Managerからの取得に失敗した場合
 */
async function getApiKey() {
    // キャッシュチェック
    if (cachedApiKey && Date.now() < cacheExpiry) {
        return cachedApiKey;
    }
    // テスト環境: API_KEY環境変数から直接取得
    if (process.env.TEST_ENV === 'e2e' && process.env.API_KEY) {
        cachedApiKey = process.env.API_KEY;
        cacheExpiry = Date.now() + 5 * 60 * 1000;
        return cachedApiKey;
    }
    // 本番環境: Secrets Managerから取得
    const secretArn = process.env.API_KEY_SECRET_ARN;
    if (!secretArn) {
        throw new Error('API_KEY_SECRET_ARN environment variable is not set');
    }
    try {
        const command = new client_secrets_manager_1.GetSecretValueCommand({ SecretId: secretArn });
        const response = await secretsClient.send(command);
        if (!response.SecretString) {
            throw new Error('Secret value is empty');
        }
        // APIキーをキャッシュ（5分TTL）
        cachedApiKey = response.SecretString;
        cacheExpiry = Date.now() + 5 * 60 * 1000;
        return cachedApiKey;
    }
    catch (error) {
        logger_1.logger.error('Failed to retrieve API key from Secrets Manager', {
            error: error instanceof Error ? error.message : String(error),
            secret_arn: secretArn,
        });
        throw new Error('Failed to retrieve API key');
    }
}
/**
 * Lambda Queryハンドラー
 *
 * @param event API Gateway Proxy Event
 * @param context Lambda Context
 * @returns API Gateway Proxy Result
 *
 * @example
 * ```typescript
 * // 企業コードで検索
 * GET /disclosures?company_code=7203
 *
 * // 日付範囲で検索
 * GET /disclosures?start_date=2024-01-15&end_date=2024-01-20
 *
 * // CSV形式で取得
 * GET /disclosures?format=csv&start_date=2024-01-15&end_date=2024-01-20
 * ```
 */
async function handler(event, context) {
    const startTime = Date.now();
    try {
        logger_1.logger.info('Lambda Query started', {
            queryStringParameters: event.queryStringParameters,
            request_id: context.awsRequestId,
            function_name: context.functionName,
        });
        // APIキー認証の検証
        await validateApiKey(event);
        // クエリパラメータのパース
        const params = parseQueryParameters(event);
        // 開示情報を検索
        const result = await (0, query_disclosures_1.queryDisclosures)(params);
        const duration = Date.now() - startTime;
        logger_1.logger.info('Lambda Query completed', {
            request_id: context.awsRequestId,
            count: result.count,
            duration_ms: duration,
        });
        // 成功メトリクス送信
        await (0, cloudwatch_metrics_1.sendMetrics)([
            {
                name: 'LambdaExecutionTime',
                value: duration,
                unit: 'Milliseconds',
                dimensions: { FunctionName: 'Query' },
            },
            {
                name: 'QueryResultCount',
                value: result.count,
                unit: 'Count',
                dimensions: { Format: params.format },
            },
        ]);
        // フォーマット別レスポンス
        if (params.format === 'csv') {
            const csv = (0, format_csv_1.formatAsCsv)(result.disclosures);
            return {
                statusCode: 200,
                headers: {
                    'Content-Type': 'text/csv',
                    'Content-Disposition': `attachment; filename="disclosures-${Date.now()}.csv"`,
                    'Access-Control-Allow-Origin': '*',
                },
                body: csv,
            };
        }
        // JSON形式（デフォルト）
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify(result),
        };
    }
    catch (error) {
        const duration = Date.now() - startTime;
        logger_1.logger.error('Lambda Query failed', (0, logger_1.createErrorContext)(error, {
            request_id: context.awsRequestId,
            duration_ms: duration,
        }));
        // エラーメトリクス送信
        await (0, cloudwatch_metrics_1.sendErrorMetric)(error instanceof Error ? error.constructor.name : 'Unknown', 'Query');
        return handleError(error, context.awsRequestId);
    }
}
/**
 * 認証エラークラス
 */
class UnauthorizedError extends Error {
    constructor(message) {
        super(message);
        this.name = 'UnauthorizedError';
    }
}
/**
 * APIキー認証の検証
 *
 * @param event API Gateway Proxy Event
 * @throws UnauthorizedError APIキーが無効な場合
 */
async function validateApiKey(event) {
    const apiKey = event.headers['x-api-key'] || event.headers['X-Api-Key'];
    if (!apiKey) {
        throw new UnauthorizedError('API key is required. Please provide x-api-key header.');
    }
    // Secrets ManagerからAPIキーを取得
    const validApiKey = await getApiKey();
    if (apiKey !== validApiKey) {
        throw new UnauthorizedError('Invalid API key');
    }
}
/**
 * クエリパラメータのパース
 *
 * @param event API Gateway Proxy Event
 * @returns パース済みクエリパラメータ
 * @throws ValidationError バリデーションエラー
 */
function parseQueryParameters(event) {
    const params = event.queryStringParameters || {};
    // フォーマットのバリデーション
    const format = (params.format || 'json');
    if (!['json', 'csv'].includes(format)) {
        throw new errors_1.ValidationError(`Invalid format: ${format}. Expected 'json' or 'csv'.`);
    }
    // リミットのバリデーション（デフォルト: 100、最大: 1000）
    let limit = 100;
    if (params.limit) {
        limit = parseInt(params.limit, 10);
        if (isNaN(limit) || limit < 1 || limit > 1000) {
            throw new errors_1.ValidationError(`Invalid limit: ${params.limit}. Expected a number between 1 and 1000.`);
        }
    }
    // オフセットのバリデーション（デフォルト: 0）
    let offset = 0;
    if (params.offset) {
        offset = parseInt(params.offset, 10);
        if (isNaN(offset) || offset < 0) {
            throw new errors_1.ValidationError(`Invalid offset: ${params.offset}. Expected a non-negative number.`);
        }
    }
    // 日付フォーマットのバリデーション
    if (params.start_date) {
        validateDateFormat(params.start_date, 'start_date');
    }
    if (params.end_date) {
        validateDateFormat(params.end_date, 'end_date');
    }
    // 日付範囲の順序性チェック（Property 8）
    if (params.start_date && params.end_date) {
        const startDate = new Date(params.start_date);
        const endDate = new Date(params.end_date);
        if (startDate > endDate) {
            throw new errors_1.ValidationError(`start_date (${params.start_date}) must be before or equal to end_date (${params.end_date})`);
        }
    }
    // 企業コードのバリデーション（4桁の数字）
    if (params.company_code) {
        const companyCodeRegex = /^\d{4}$/;
        if (!companyCodeRegex.test(params.company_code)) {
            throw new errors_1.ValidationError(`Invalid company_code: ${params.company_code}. Expected 4-digit number.`);
        }
    }
    return {
        company_code: params.company_code,
        start_date: params.start_date,
        end_date: params.end_date,
        disclosure_type: params.disclosure_type,
        format,
        limit,
        offset,
    };
}
/**
 * 日付フォーマットのバリデーション
 *
 * @param date 日付文字列（YYYY-MM-DD）
 * @param fieldName フィールド名
 * @throws ValidationError バリデーションエラー
 */
function validateDateFormat(date, fieldName) {
    // YYYY-MM-DD形式のチェック
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateRegex.test(date)) {
        throw new errors_1.ValidationError(`Invalid ${fieldName} format: ${date}. Expected YYYY-MM-DD format.`);
    }
    // 有効な日付かチェック
    const parsedDate = new Date(date);
    if (isNaN(parsedDate.getTime())) {
        throw new errors_1.ValidationError(`Invalid ${fieldName}: ${date}. Date does not exist.`);
    }
}
/**
 * エラーハンドリング
 *
 * カスタムエラーを適切なHTTPステータスコードとエラーコードに変換します。
 * API設計ガイドラインに準拠した形式でエラーレスポンスを返します。
 *
 * @param error エラーオブジェクト
 * @param requestId リクエストID
 * @returns API Gateway Proxy Result
 */
function handleError(error, requestId) {
    // エラー種別に応じたステータスコードとエラーコード
    let statusCode = 500;
    let errorCode = 'INTERNAL_ERROR';
    let details = {};
    if (error instanceof errors_1.ValidationError) {
        statusCode = 400;
        errorCode = 'VALIDATION_ERROR';
        // ValidationErrorの詳細情報を含める
        if (error.details) {
            details = error.details;
        }
    }
    else if (error instanceof errors_1.NotFoundError) {
        statusCode = 404;
        errorCode = 'NOT_FOUND';
    }
    else if (error instanceof UnauthorizedError) {
        statusCode = 401;
        errorCode = 'UNAUTHORIZED';
    }
    else if (error.message.includes('API key')) {
        statusCode = 401;
        errorCode = 'UNAUTHORIZED';
    }
    // API設計ガイドラインに準拠したエラーレスポンス形式
    const errorResponse = {
        status: 'error',
        error: {
            code: errorCode,
            message: error.message,
            details,
        },
        request_id: requestId,
    };
    // 本番環境ではスタックトレースを含めない
    if (process.env.NODE_ENV !== 'production') {
        errorResponse.error.stack = error.stack;
    }
    return {
        statusCode,
        headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
        },
        body: JSON.stringify(errorResponse),
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXHF1ZXJ5XFxoYW5kbGVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7OztHQU9HOztBQTBISCwwQkF3RkM7QUEvTUQsNEVBQThGO0FBQzlGLCtDQUFnRTtBQUNoRSx1RUFBOEU7QUFDOUUseUNBQThEO0FBQzlELDJEQUF1RDtBQUN2RCw2Q0FBMkM7QUFHM0MsdUNBQXVDO0FBQ3ZDLE1BQU0sYUFBYSxHQUFHLElBQUksNkNBQW9CLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO0FBRXZHLG9CQUFvQjtBQUNwQixJQUFJLFlBQVksR0FBa0IsSUFBSSxDQUFDO0FBQ3ZDLElBQUksV0FBVyxHQUFXLENBQUMsQ0FBQztBQUU1Qjs7Ozs7Ozs7R0FRRztBQUNILEtBQUssVUFBVSxTQUFTO0lBQ3RCLFlBQVk7SUFDWixJQUFJLFlBQVksSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsV0FBVyxFQUFFLENBQUM7UUFDN0MsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQztJQUVELDJCQUEyQjtJQUMzQixJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLEtBQUssSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQzFELFlBQVksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQztRQUNuQyxXQUFXLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQ3pDLE9BQU8sWUFBWSxDQUFDO0lBQ3RCLENBQUM7SUFFRCw0QkFBNEI7SUFDNUIsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQztJQUNqRCxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDZixNQUFNLElBQUks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QUM7UUFDekMsYUFBYSxDQUFDLEtBQWEsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztJQUNuRCxDQUFDO0lBRUQsT0FBTztRQUNMLFVBQVU7UUFDVixPQUFPLEVBQUU7WUFDUCxjQUFjLEVBQUUsa0JBQWtCO1lBQ2xDLDZCQUE2QixFQUFFLEdBQUc7U0FDbkM7UUFDRCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUM7S0FDcEMsQ0FBQztBQUNKLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXHF1ZXJ5XFxoYW5kbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBMYW1iZGEgUXVlcnkgSGFuZGxlclxyXG4gKlxyXG4gKiBURG5ldOmWi+ekuuaDheWgseOCkuaknOe0ouOBmeOCi0xhbWJkYemWouaVsOOBruODoeOCpOODs+ODj+ODs+ODieODqeODvOOAglxyXG4gKiBBUEkgR2F0ZXdheee1seWQiOOBq+OCiOOCiuOAgVJFU1RmdWwgQVBJ44Go44GX44Gm5YWs6ZaL44GV44KM44G+44GZ44CCXHJcbiAqXHJcbiAqIFJlcXVpcmVtZW50czog6KaB5Lu2NC4xLCA0LjMsIDQuNCwgNS4yLCAxMS4x77yI5qSc57SiQVBJ44CB6KqN6Ki844CBUERG44OA44Km44Oz44Ot44O844OJ44CBQ1NW5b2i5byP77yJXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCwgQ29udGV4dCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xyXG5pbXBvcnQgeyBTZWNyZXRzTWFuYWdlckNsaWVudCwgR2V0U2VjcmV0VmFsdWVDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXNlY3JldHMtbWFuYWdlcic7XHJcbmltcG9ydCB7IGxvZ2dlciwgY3JlYXRlRXJyb3JDb250ZXh0IH0gZnJvbSAnLi4vLi4vdXRpbHMvbG9nZ2VyJztcclxuaW1wb3J0IHsgc2VuZEVycm9yTWV0cmljLCBzZW5kTWV0cmljcyB9IGZyb20gJy4uLy4uL3V0aWxzL2Nsb3Vkd2F0Y2gtbWV0cmljcyc7XHJcbmltcG9ydCB7IFZhbGlkYXRpb25FcnJvciwgTm90Rm91bmRFcnJvciB9IGZyb20gJy4uLy4uL2Vycm9ycyc7XHJcbmltcG9ydCB7IHF1ZXJ5RGlzY2xvc3VyZXMgfSBmcm9tICcuL3F1ZXJ5LWRpc2Nsb3N1cmVzJztcclxuaW1wb3J0IHsgZm9ybWF0QXNDc3YgfSBmcm9tICcuL2Zvcm1hdC1jc3YnO1xyXG5pbXBvcnQgeyBEaXNjbG9zdXJlIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xyXG5cclxuLy8gU2VjcmV0cyBNYW5hZ2Vy44Kv44Op44Kk44Ki44Oz44OI77yI44Kw44Ot44O844OQ44Or44K544Kz44O844OX44Gn5Yid5pyf5YyW77yJXHJcbmNvbnN0IHNlY3JldHNDbGllbnQgPSBuZXcgU2VjcmV0c01hbmFnZXJDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ2FwLW5vcnRoZWFzdC0xJyB9KTtcclxuXHJcbi8vIEFQSeOCreODvOOCreODo+ODg+OCt+ODpe+8iDXliIZUVEzvvIlcclxubGV0IGNhY2hlZEFwaUtleTogc3RyaW5nIHwgbnVsbCA9IG51bGw7XHJcbmxldCBjYWNoZUV4cGlyeTogbnVtYmVyID0gMDtcclxuXHJcbi8qKlxyXG4gKiBTZWNyZXRzIE1hbmFnZXLjgYvjgolBUEnjgq3jg7zjgpLlj5blvpdcclxuICpcclxuICog44OG44K544OI55Kw5aKD77yIVEVTVF9FTlY9ZTJl77yJ44Gn44Gv44CBQVBJX0tFWeeSsOWig+WkieaVsOOBi+OCieebtOaOpeWPluW+l+OBl+OBvuOBmeOAglxyXG4gKiDmnKznlarnkrDlooPjgafjga/jgIFTZWNyZXRzIE1hbmFnZXLjgYvjgonlj5blvpfjgZfjgb7jgZnjgIJcclxuICpcclxuICogQHJldHVybnMgQVBJ44Kt44O8XHJcbiAqIEB0aHJvd3MgRXJyb3IgU2VjcmV0cyBNYW5hZ2Vy44GL44KJ44Gu5Y+W5b6X44Gr5aSx5pWX44GX44Gf5aC05ZCIXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBnZXRBcGlLZXkoKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAvLyDjgq3jg6Pjg4Pjgrfjg6Xjg4Hjgqfjg4Pjgq9cclxuICBpZiAoY2FjaGVkQXBpS2V5ICYmIERhdGUubm93KCkgPCBjYWNoZUV4cGlyeSkge1xyXG4gICAgcmV0dXJuIGNhY2hlZEFwaUtleTtcclxuICB9XHJcblxyXG4gIC8vIOODhuOCueODiOeSsOWigzogQVBJX0tFWeeSsOWig+WkieaVsOOBi+OCieebtOaOpeWPluW+l1xyXG4gIGlmIChwcm9jZXNzLmVudi5URVNUX0VOViA9PT0gJ2UyZScgJiYgcHJvY2Vzcy5lbnYuQVBJX0tFWSkge1xyXG4gICAgY2FjaGVkQXBpS2V5ID0gcHJvY2Vzcy5lbnYuQVBJX0tFWTtcclxuICAgIGNhY2hlRXhwaXJ5ID0gRGF0ZS5ub3coKSArIDUgKiA2MCAqIDEwMDA7XHJcbiAgICByZXR1cm4gY2FjaGVkQXBpS2V5O1xyXG4gIH1cclxuXHJcbiAgLy8g5pys55Wq55Kw5aKDOiBTZWNyZXRzIE1hbmFnZXLjgYvjgonlj5blvpdcclxuICBjb25zdCBzZWNyZXRBcm4gPSBwcm9jZXNzLmVudi5BUElfS0VZX1NFQ1JFVF9BUk47XHJcbiAgaWYgKCFzZWNyZXRBcm4pIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignQVBJX0tFWV9TRUNSRVRfQVJOIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIG5vdCBzZXQnKTtcclxuICB9XHJcblxyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldFNlY3JldFZhbHVlQ29tbWFuZCh7IFNlY3JldElkOiBzZWNyZXRBcm4gfSk7XHJcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHNlY3JldHNDbGllbnQuc2VuZChjb21tYW5kKTtcclxuXHJcbiAgICBpZiAoIXJlc3BvbnNlLlNlY3JldFN0cmluZykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NlY3JldCB2YWx1ZSBpcyBlbXB0eScpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEFQSeOCreODvOOCkuOCreODo+ODg+OCt+ODpe+8iDXliIZUVEzvvIlcclxuICAgIGNhY2hlZEFwaUtleSA9IHJlc3BvbnNlLlNlY3JldFN0cmluZztcclxuICAgIGNhY2hlRXhwaXJ5ID0gRGF0ZS5ub3coKSArIDUgKiA2MCAqIDEwMDA7XHJcblxyXG4gICAgcmV0dXJuIGNhY2hlZEFwaUtleTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gcmV0cmlldmUgQVBJIGtleSBmcm9tIFNlY3JldHMgTWFuYWdlcicsIHtcclxuICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcclxuICAgICAgc2VjcmV0X2Fybjogc2VjcmV0QXJuLFxyXG4gICAgfSk7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSBBUEkga2V5Jyk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogTGFtYmRhIFF1ZXJ544Kk44OZ44Oz44OI77yIQVBJIEdhdGV3YXnntbHlkIjvvIlcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgUXVlcnlFdmVudCBleHRlbmRzIEFQSUdhdGV3YXlQcm94eUV2ZW50IHtcclxuICBxdWVyeVN0cmluZ1BhcmFtZXRlcnM6IHtcclxuICAgIGNvbXBhbnlfY29kZT86IHN0cmluZztcclxuICAgIHN0YXJ0X2RhdGU/OiBzdHJpbmc7XHJcbiAgICBlbmRfZGF0ZT86IHN0cmluZztcclxuICAgIGRpc2Nsb3N1cmVfdHlwZT86IHN0cmluZztcclxuICAgIGZvcm1hdD86ICdqc29uJyB8ICdjc3YnO1xyXG4gICAgbGltaXQ/OiBzdHJpbmc7XHJcbiAgICBvZmZzZXQ/OiBzdHJpbmc7XHJcbiAgfSB8IG51bGw7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgq/jgqjjg6rjg6zjgrnjg53jg7PjgrlcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgUXVlcnlSZXNwb25zZSB7XHJcbiAgLyoqIOaknOe0oue1kOaenCAqL1xyXG4gIGRpc2Nsb3N1cmVzOiBEaXNjbG9zdXJlW107XHJcblxyXG4gIC8qKiDnt4/ku7bmlbAgKi9cclxuICB0b3RhbDogbnVtYmVyO1xyXG5cclxuICAvKiog5Y+W5b6X5Lu25pWwICovXHJcbiAgY291bnQ6IG51bWJlcjtcclxuXHJcbiAgLyoqIOOCquODleOCu+ODg+ODiCAqL1xyXG4gIG9mZnNldDogbnVtYmVyO1xyXG5cclxuICAvKiog44Oq44Of44OD44OIICovXHJcbiAgbGltaXQ6IG51bWJlcjtcclxufVxyXG5cclxuLyoqXHJcbiAqIExhbWJkYSBRdWVyeeODj+ODs+ODieODqeODvFxyXG4gKlxyXG4gKiBAcGFyYW0gZXZlbnQgQVBJIEdhdGV3YXkgUHJveHkgRXZlbnRcclxuICogQHBhcmFtIGNvbnRleHQgTGFtYmRhIENvbnRleHRcclxuICogQHJldHVybnMgQVBJIEdhdGV3YXkgUHJveHkgUmVzdWx0XHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYHR5cGVzY3JpcHRcclxuICogLy8g5LyB5qWt44Kz44O844OJ44Gn5qSc57SiXHJcbiAqIEdFVCAvZGlzY2xvc3VyZXM/Y29tcGFueV9jb2RlPTcyMDNcclxuICpcclxuICogLy8g5pel5LuY56+E5Zuy44Gn5qSc57SiXHJcbiAqIEdFVCAvZGlzY2xvc3VyZXM/c3RhcnRfZGF0ZT0yMDI0LTAxLTE1JmVuZF9kYXRlPTIwMjQtMDEtMjBcclxuICpcclxuICogLy8gQ1NW5b2i5byP44Gn5Y+W5b6XXHJcbiAqIEdFVCAvZGlzY2xvc3VyZXM/Zm9ybWF0PWNzdiZzdGFydF9kYXRlPTIwMjQtMDEtMTUmZW5kX2RhdGU9MjAyNC0wMS0yMFxyXG4gKiBgYGBcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVyKFxyXG4gIGV2ZW50OiBRdWVyeUV2ZW50LFxyXG4gIGNvbnRleHQ6IENvbnRleHRcclxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcclxuICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xyXG5cclxuICB0cnkge1xyXG4gICAgbG9nZ2VyLmluZm8oJ0xhbWJkYSBRdWVyeSBzdGFydGVkJywge1xyXG4gICAgICBxdWVyeVN0cmluZ1BhcmFtZXRlcnM6IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyxcclxuICAgICAgcmVxdWVzdF9pZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXHJcbiAgICAgIGZ1bmN0aW9uX25hbWU6IGNvbnRleHQuZnVuY3Rpb25OYW1lLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gQVBJ44Kt44O86KqN6Ki844Gu5qSc6Ki8XHJcbiAgICBhd2FpdCB2YWxpZGF0ZUFwaUtleShldmVudCk7XHJcblxyXG4gICAgLy8g44Kv44Ko44Oq44OR44Op44Oh44O844K/44Gu44OR44O844K5XHJcbiAgICBjb25zdCBwYXJhbXMgPSBwYXJzZVF1ZXJ5UGFyYW1ldGVycyhldmVudCk7XHJcblxyXG4gICAgLy8g6ZaL56S65oOF5aCx44KS5qSc57SiXHJcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBxdWVyeURpc2Nsb3N1cmVzKHBhcmFtcyk7XHJcblxyXG4gICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xyXG5cclxuICAgIGxvZ2dlci5pbmZvKCdMYW1iZGEgUXVlcnkgY29tcGxldGVkJywge1xyXG4gICAgICByZXF1ZXN0X2lkOiBjb250ZXh0LmF3c1JlcXVlc3RJZCxcclxuICAgICAgY291bnQ6IHJlc3VsdC5jb3VudCxcclxuICAgICAgZHVyYXRpb25fbXM6IGR1cmF0aW9uLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g5oiQ5Yqf44Oh44OI44Oq44Kv44K56YCB5L+hXHJcbiAgICBhd2FpdCBzZW5kTWV0cmljcyhbXHJcbiAgICAgIHtcclxuICAgICAgICBuYW1lOiAnTGFtYmRhRXhlY3V0aW9uVGltZScsXHJcbiAgICAgICAgdmFsdWU6IGR1cmF0aW9uLFxyXG4gICAgICAgIHVuaXQ6ICdNaWxsaXNlY29uZHMnLFxyXG4gICAgICAgIGRpbWVuc2lvbnM6IHsgRnVuY3Rpb25OYW1lOiAnUXVlcnknIH0sXHJcbiAgICAgIH0sXHJcbiAgICAgIHtcclxuICAgICAgICBuYW1lOiAnUXVlcnlSZXN1bHRDb3VudCcsXHJcbiAgICAgICAgdmFsdWU6IHJlc3VsdC5jb3VudCxcclxuICAgICAgICB1bml0OiAnQ291bnQnLFxyXG4gICAgICAgIGRpbWVuc2lvbnM6IHsgRm9ybWF0OiBwYXJhbXMuZm9ybWF0IH0sXHJcbiAgICAgIH0sXHJcbiAgICBdKTtcclxuXHJcbiAgICAvLyDjg5Xjgqnjg7zjg57jg4Pjg4jliKXjg6zjgrnjg53jg7PjgrlcclxuICAgIGlmIChwYXJhbXMuZm9ybWF0ID09PSAnY3N2Jykge1xyXG4gICAgICBjb25zdCBjc3YgPSBmb3JtYXRBc0NzdihyZXN1bHQuZGlzY2xvc3VyZXMpO1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHN0YXR1c0NvZGU6IDIwMCxcclxuICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ3RleHQvY3N2JyxcclxuICAgICAgICAgICdDb250ZW50LURpc3Bvc2l0aW9uJzogYGF0dGFjaG1lbnQ7IGZpbGVuYW1lPVwiZGlzY2xvc3VyZXMtJHtEYXRlLm5vdygpfS5jc3ZcImAsXHJcbiAgICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgYm9keTogY3N2LFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEpTT07lvaLlvI/vvIjjg4fjg5Xjgqnjg6vjg4jvvIlcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcclxuICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgICAgfSxcclxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVzdWx0KSxcclxuICAgIH07XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcclxuXHJcbiAgICBsb2dnZXIuZXJyb3IoXHJcbiAgICAgICdMYW1iZGEgUXVlcnkgZmFpbGVkJyxcclxuICAgICAgY3JlYXRlRXJyb3JDb250ZXh0KGVycm9yIGFzIEVycm9yLCB7XHJcbiAgICAgICAgcmVxdWVzdF9pZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXHJcbiAgICAgICAgZHVyYXRpb25fbXM6IGR1cmF0aW9uLFxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICAvLyDjgqjjg6njg7zjg6Hjg4jjg6rjgq/jgrnpgIHkv6FcclxuICAgIGF3YWl0IHNlbmRFcnJvck1ldHJpYyhcclxuICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLmNvbnN0cnVjdG9yLm5hbWUgOiAnVW5rbm93bicsXHJcbiAgICAgICdRdWVyeSdcclxuICAgICk7XHJcblxyXG4gICAgcmV0dXJuIGhhbmRsZUVycm9yKGVycm9yIGFzIEVycm9yLCBjb250ZXh0LmF3c1JlcXVlc3RJZCk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog6KqN6Ki844Ko44Op44O844Kv44Op44K5XHJcbiAqL1xyXG5jbGFzcyBVbmF1dGhvcml6ZWRFcnJvciBleHRlbmRzIEVycm9yIHtcclxuICBjb25zdHJ1Y3RvcihtZXNzYWdlOiBzdHJpbmcpIHtcclxuICAgIHN1cGVyKG1lc3NhZ2UpO1xyXG4gICAgdGhpcy5uYW1lID0gJ1VuYXV0aG9yaXplZEVycm9yJztcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBBUEnjgq3jg7zoqo3oqLzjga7mpJzoqLxcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEFQSSBHYXRld2F5IFByb3h5IEV2ZW50XHJcbiAqIEB0aHJvd3MgVW5hdXRob3JpemVkRXJyb3IgQVBJ44Kt44O844GM54Sh5Yq544Gq5aC05ZCIXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiB2YWxpZGF0ZUFwaUtleShldmVudDogUXVlcnlFdmVudCk6IFByb21pc2U8dm9pZD4ge1xyXG4gIGNvbnN0IGFwaUtleSA9IGV2ZW50LmhlYWRlcnNbJ3gtYXBpLWtleSddIHx8IGV2ZW50LmhlYWRlcnNbJ1gtQXBpLUtleSddO1xyXG5cclxuICBpZiAoIWFwaUtleSkge1xyXG4gICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEVycm9yKCdBUEkga2V5IGlzIHJlcXVpcmVkLiBQbGVhc2UgcHJvdmlkZSB4LWFwaS1rZXkgaGVhZGVyLicpO1xyXG4gIH1cclxuXHJcbiAgLy8gU2VjcmV0cyBNYW5hZ2Vy44GL44KJQVBJ44Kt44O844KS5Y+W5b6XXHJcbiAgY29uc3QgdmFsaWRBcGlLZXkgPSBhd2FpdCBnZXRBcGlLZXkoKTtcclxuXHJcbiAgaWYgKGFwaUtleSAhPT0gdmFsaWRBcGlLZXkpIHtcclxuICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFcnJvcignSW52YWxpZCBBUEkga2V5Jyk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog44Kv44Ko44Oq44OR44Op44Oh44O844K/44Gu44OR44O844K5XHJcbiAqXHJcbiAqIEBwYXJhbSBldmVudCBBUEkgR2F0ZXdheSBQcm94eSBFdmVudFxyXG4gKiBAcmV0dXJucyDjg5Hjg7zjgrnmuIjjgb/jgq/jgqjjg6rjg5Hjg6njg6Hjg7zjgr9cclxuICogQHRocm93cyBWYWxpZGF0aW9uRXJyb3Ig44OQ44Oq44OH44O844K344On44Oz44Ko44Op44O8XHJcbiAqL1xyXG5mdW5jdGlvbiBwYXJzZVF1ZXJ5UGFyYW1ldGVycyhldmVudDogUXVlcnlFdmVudCk6IHtcclxuICBjb21wYW55X2NvZGU/OiBzdHJpbmc7XHJcbiAgc3RhcnRfZGF0ZT86IHN0cmluZztcclxuICBlbmRfZGF0ZT86IHN0cmluZztcclxuICBkaXNjbG9zdXJlX3R5cGU/OiBzdHJpbmc7XHJcbiAgZm9ybWF0OiAnanNvbicgfCAnY3N2JztcclxuICBsaW1pdDogbnVtYmVyO1xyXG4gIG9mZnNldDogbnVtYmVyO1xyXG59IHtcclxuICBjb25zdCBwYXJhbXMgPSBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMgfHwge307XHJcblxyXG4gIC8vIOODleOCqeODvOODnuODg+ODiOOBruODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gIGNvbnN0IGZvcm1hdCA9IChwYXJhbXMuZm9ybWF0IHx8ICdqc29uJykgYXMgJ2pzb24nIHwgJ2Nzdic7XHJcbiAgaWYgKCFbJ2pzb24nLCAnY3N2J10uaW5jbHVkZXMoZm9ybWF0KSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEludmFsaWQgZm9ybWF0OiAke2Zvcm1hdH0uIEV4cGVjdGVkICdqc29uJyBvciAnY3N2Jy5gXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8g44Oq44Of44OD44OI44Gu44OQ44Oq44OH44O844K344On44Oz77yI44OH44OV44Kp44Or44OIOiAxMDDjgIHmnIDlpKc6IDEwMDDvvIlcclxuICBsZXQgbGltaXQgPSAxMDA7XHJcbiAgaWYgKHBhcmFtcy5saW1pdCkge1xyXG4gICAgbGltaXQgPSBwYXJzZUludChwYXJhbXMubGltaXQsIDEwKTtcclxuICAgIGlmIChpc05hTihsaW1pdCkgfHwgbGltaXQgPCAxIHx8IGxpbWl0ID4gMTAwMCkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICAgIGBJbnZhbGlkIGxpbWl0OiAke3BhcmFtcy5saW1pdH0uIEV4cGVjdGVkIGEgbnVtYmVyIGJldHdlZW4gMSBhbmQgMTAwMC5gXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDjgqrjg5Xjgrvjg4Pjg4jjga7jg5Djg6rjg4fjg7zjgrfjg6fjg7PvvIjjg4fjg5Xjgqnjg6vjg4g6IDDvvIlcclxuICBsZXQgb2Zmc2V0ID0gMDtcclxuICBpZiAocGFyYW1zLm9mZnNldCkge1xyXG4gICAgb2Zmc2V0ID0gcGFyc2VJbnQocGFyYW1zLm9mZnNldCwgMTApO1xyXG4gICAgaWYgKGlzTmFOKG9mZnNldCkgfHwgb2Zmc2V0IDwgMCkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICAgIGBJbnZhbGlkIG9mZnNldDogJHtwYXJhbXMub2Zmc2V0fS4gRXhwZWN0ZWQgYSBub24tbmVnYXRpdmUgbnVtYmVyLmBcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOaXpeS7mOODleOCqeODvOODnuODg+ODiOOBruODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gIGlmIChwYXJhbXMuc3RhcnRfZGF0ZSkge1xyXG4gICAgdmFsaWRhdGVEYXRlRm9ybWF0KHBhcmFtcy5zdGFydF9kYXRlLCAnc3RhcnRfZGF0ZScpO1xyXG4gIH1cclxuICBpZiAocGFyYW1zLmVuZF9kYXRlKSB7XHJcbiAgICB2YWxpZGF0ZURhdGVGb3JtYXQocGFyYW1zLmVuZF9kYXRlLCAnZW5kX2RhdGUnKTtcclxuICB9XHJcblxyXG4gIC8vIOaXpeS7mOevhOWbsuOBrumghuW6j+aAp+ODgeOCp+ODg+OCr++8iFByb3BlcnR5IDjvvIlcclxuICBpZiAocGFyYW1zLnN0YXJ0X2RhdGUgJiYgcGFyYW1zLmVuZF9kYXRlKSB7XHJcbiAgICBjb25zdCBzdGFydERhdGUgPSBuZXcgRGF0ZShwYXJhbXMuc3RhcnRfZGF0ZSk7XHJcbiAgICBjb25zdCBlbmREYXRlID0gbmV3IERhdGUocGFyYW1zLmVuZF9kYXRlKTtcclxuXHJcbiAgICBpZiAoc3RhcnREYXRlID4gZW5kRGF0ZSkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICAgIGBzdGFydF9kYXRlICgke3BhcmFtcy5zdGFydF9kYXRlfSkgbXVzdCBiZSBiZWZvcmUgb3IgZXF1YWwgdG8gZW5kX2RhdGUgKCR7cGFyYW1zLmVuZF9kYXRlfSlgXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDkvIHmpa3jgrPjg7zjg4njga7jg5Djg6rjg4fjg7zjgrfjg6fjg7PvvIg05qGB44Gu5pWw5a2X77yJXHJcbiAgaWYgKHBhcmFtcy5jb21wYW55X2NvZGUpIHtcclxuICAgIGNvbnN0IGNvbXBhbnlDb2RlUmVnZXggPSAvXlxcZHs0fSQvO1xyXG4gICAgaWYgKCFjb21wYW55Q29kZVJlZ2V4LnRlc3QocGFyYW1zLmNvbXBhbnlfY29kZSkpIHtcclxuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgICBgSW52YWxpZCBjb21wYW55X2NvZGU6ICR7cGFyYW1zLmNvbXBhbnlfY29kZX0uIEV4cGVjdGVkIDQtZGlnaXQgbnVtYmVyLmBcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBjb21wYW55X2NvZGU6IHBhcmFtcy5jb21wYW55X2NvZGUsXHJcbiAgICBzdGFydF9kYXRlOiBwYXJhbXMuc3RhcnRfZGF0ZSxcclxuICAgIGVuZF9kYXRlOiBwYXJhbXMuZW5kX2RhdGUsXHJcbiAgICBkaXNjbG9zdXJlX3R5cGU6IHBhcmFtcy5kaXNjbG9zdXJlX3R5cGUsXHJcbiAgICBmb3JtYXQsXHJcbiAgICBsaW1pdCxcclxuICAgIG9mZnNldCxcclxuICB9O1xyXG59XHJcblxyXG4vKipcclxuICog5pel5LuY44OV44Kp44O844Oe44OD44OI44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAqXHJcbiAqIEBwYXJhbSBkYXRlIOaXpeS7mOaWh+Wtl+WIl++8iFlZWVktTU0tRETvvIlcclxuICogQHBhcmFtIGZpZWxkTmFtZSDjg5XjgqPjg7zjg6vjg4nlkI1cclxuICogQHRocm93cyBWYWxpZGF0aW9uRXJyb3Ig44OQ44Oq44OH44O844K344On44Oz44Ko44Op44O8XHJcbiAqL1xyXG5mdW5jdGlvbiB2YWxpZGF0ZURhdGVGb3JtYXQoZGF0ZTogc3RyaW5nLCBmaWVsZE5hbWU6IHN0cmluZyk6IHZvaWQge1xyXG4gIC8vIFlZWVktTU0tRETlvaLlvI/jga7jg4Hjgqfjg4Pjgq9cclxuICBjb25zdCBkYXRlUmVnZXggPSAvXlxcZHs0fS1cXGR7Mn0tXFxkezJ9JC87XHJcbiAgaWYgKCFkYXRlUmVnZXgudGVzdChkYXRlKSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEludmFsaWQgJHtmaWVsZE5hbWV9IGZvcm1hdDogJHtkYXRlfS4gRXhwZWN0ZWQgWVlZWS1NTS1ERCBmb3JtYXQuYFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIOacieWKueOBquaXpeS7mOOBi+ODgeOCp+ODg+OCr1xyXG4gIGNvbnN0IHBhcnNlZERhdGUgPSBuZXcgRGF0ZShkYXRlKTtcclxuICBpZiAoaXNOYU4ocGFyc2VkRGF0ZS5nZXRUaW1lKCkpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCAke2ZpZWxkTmFtZX06ICR7ZGF0ZX0uIERhdGUgZG9lcyBub3QgZXhpc3QuYFxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgqjjg6njg7zjg4/jg7Pjg4njg6rjg7PjgrBcclxuICpcclxuICog44Kr44K544K/44Og44Ko44Op44O844KS6YGp5YiH44GqSFRUUOOCueODhuODvOOCv+OCueOCs+ODvOODieOBqOOCqOODqeODvOOCs+ODvOODieOBq+WkieaPm+OBl+OBvuOBmeOAglxyXG4gKiBBUEnoqK3oqIjjgqzjgqTjg4njg6njgqTjg7Pjgavmupbmi6DjgZfjgZ/lvaLlvI/jgafjgqjjg6njg7zjg6zjgrnjg53jg7PjgrnjgpLov5TjgZfjgb7jgZnjgIJcclxuICpcclxuICogQHBhcmFtIGVycm9yIOOCqOODqeODvOOCquODluOCuOOCp+OCr+ODiFxyXG4gKiBAcGFyYW0gcmVxdWVzdElkIOODquOCr+OCqOOCueODiElEXHJcbiAqIEByZXR1cm5zIEFQSSBHYXRld2F5IFByb3h5IFJlc3VsdFxyXG4gKi9cclxuZnVuY3Rpb24gaGFuZGxlRXJyb3IoZXJyb3I6IEVycm9yLCByZXF1ZXN0SWQ6IHN0cmluZyk6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCB7XHJcbiAgLy8g44Ko44Op44O856iu5Yil44Gr5b+c44GY44Gf44K544OG44O844K/44K544Kz44O844OJ44Go44Ko44Op44O844Kz44O844OJXHJcbiAgbGV0IHN0YXR1c0NvZGUgPSA1MDA7XHJcbiAgbGV0IGVycm9yQ29kZSA9ICdJTlRFUk5BTF9FUlJPUic7XHJcbiAgbGV0IGRldGFpbHM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcclxuXHJcbiAgaWYgKGVycm9yIGluc3RhbmNlb2YgVmFsaWRhdGlvbkVycm9yKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDAwO1xyXG4gICAgZXJyb3JDb2RlID0gJ1ZBTElEQVRJT05fRVJST1InO1xyXG4gICAgLy8gVmFsaWRhdGlvbkVycm9y44Gu6Kmz57Sw5oOF5aCx44KS5ZCr44KB44KLXHJcbiAgICBpZiAoKGVycm9yIGFzIGFueSkuZGV0YWlscykge1xyXG4gICAgICBkZXRhaWxzID0gKGVycm9yIGFzIGFueSkuZGV0YWlscztcclxuICAgIH1cclxuICB9IGVsc2UgaWYgKGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFcnJvcikge1xyXG4gICAgc3RhdHVzQ29kZSA9IDQwNDtcclxuICAgIGVycm9yQ29kZSA9ICdOT1RfRk9VTkQnO1xyXG4gIH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBVbmF1dGhvcml6ZWRFcnJvcikge1xyXG4gICAgc3RhdHVzQ29kZSA9IDQwMTtcclxuICAgIGVycm9yQ29kZSA9ICdVTkFVVEhPUklaRUQnO1xyXG4gIH0gZWxzZSBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnQVBJIGtleScpKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDAxO1xyXG4gICAgZXJyb3JDb2RlID0gJ1VOQVVUSE9SSVpFRCc7XHJcbiAgfVxyXG5cclxuICAvLyBBUEnoqK3oqIjjgqzjgqTjg4njg6njgqTjg7Pjgavmupbmi6DjgZfjgZ/jgqjjg6njg7zjg6zjgrnjg53jg7PjgrnlvaLlvI9cclxuICBjb25zdCBlcnJvclJlc3BvbnNlID0ge1xyXG4gICAgc3RhdHVzOiAnZXJyb3InLFxyXG4gICAgZXJyb3I6IHtcclxuICAgICAgY29kZTogZXJyb3JDb2RlLFxyXG4gICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxyXG4gICAgICBkZXRhaWxzLFxyXG4gICAgfSxcclxuICAgIHJlcXVlc3RfaWQ6IHJlcXVlc3RJZCxcclxuICB9O1xyXG5cclxuICAvLyDmnKznlarnkrDlooPjgafjga/jgrnjgr/jg4Pjgq/jg4jjg6zjg7zjgrnjgpLlkKvjgoHjgarjgYRcclxuICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykge1xyXG4gICAgKGVycm9yUmVzcG9uc2UuZXJyb3IgYXMgYW55KS5zdGFjayA9IGVycm9yLnN0YWNrO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIHN0YXR1c0NvZGUsXHJcbiAgICBoZWFkZXJzOiB7XHJcbiAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXHJcbiAgICB9LFxyXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoZXJyb3JSZXNwb25zZSksXHJcbiAgfTtcclxufVxyXG4iXSwidmVyc2lvbiI6M30=