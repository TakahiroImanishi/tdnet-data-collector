290d8221ef3b06b9833a52e89ee39fda
"use strict";
/**
 * Lambda Query Handler
 *
 * TDnet開示情報を検索するLambda関数のメインハンドラー。
 * API Gateway統合により、RESTful APIとして公開されます。
 *
 * Requirements: 要件4.1, 4.3, 4.4, 5.2, 11.1（検索API、認証、PDFダウンロード、CSV形式）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const logger_1 = require("../../utils/logger");
const cloudwatch_metrics_1 = require("../../utils/cloudwatch-metrics");
const errors_1 = require("../../errors");
const query_disclosures_1 = require("./query-disclosures");
const format_csv_1 = require("./format-csv");
/**
 * Lambda Queryハンドラー
 *
 * @param event API Gateway Proxy Event
 * @param context Lambda Context
 * @returns API Gateway Proxy Result
 *
 * @example
 * ```typescript
 * // 企業コードで検索
 * GET /disclosures?company_code=7203
 *
 * // 日付範囲で検索
 * GET /disclosures?start_date=2024-01-15&end_date=2024-01-20
 *
 * // CSV形式で取得
 * GET /disclosures?format=csv&start_date=2024-01-15&end_date=2024-01-20
 * ```
 */
async function handler(event, context) {
    const startTime = Date.now();
    try {
        logger_1.logger.info('Lambda Query started', {
            queryStringParameters: event.queryStringParameters,
            request_id: context.awsRequestId,
            function_name: context.functionName,
        });
        // クエリパラメータのパース
        const params = parseQueryParameters(event);
        // 開示情報を検索
        const result = await (0, query_disclosures_1.queryDisclosures)(params);
        const duration = Date.now() - startTime;
        logger_1.logger.info('Lambda Query completed', {
            request_id: context.awsRequestId,
            count: result.count,
            duration_ms: duration,
        });
        // 成功メトリクス送信
        await (0, cloudwatch_metrics_1.sendMetrics)([
            {
                name: 'LambdaExecutionTime',
                value: duration,
                unit: 'Milliseconds',
                dimensions: { FunctionName: 'Query' },
            },
            {
                name: 'QueryResultCount',
                value: result.count,
                unit: 'Count',
                dimensions: { Format: params.format },
            },
        ]);
        // フォーマット別レスポンス
        if (params.format === 'csv') {
            const csv = (0, format_csv_1.formatAsCsv)(result.disclosures);
            return {
                statusCode: 200,
                headers: {
                    'Content-Type': 'text/csv',
                    'Content-Disposition': `attachment; filename="disclosures-${Date.now()}.csv"`,
                    'Access-Control-Allow-Origin': '*',
                },
                body: csv,
            };
        }
        // JSON形式（デフォルト）
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify(result),
        };
    }
    catch (error) {
        const duration = Date.now() - startTime;
        logger_1.logger.error('Lambda Query failed', (0, logger_1.createErrorContext)(error, {
            request_id: context.awsRequestId,
            duration_ms: duration,
        }));
        // エラーメトリクス送信
        await (0, cloudwatch_metrics_1.sendErrorMetric)(error instanceof Error ? error.constructor.name : 'Unknown', 'Query');
        return handleError(error, context.awsRequestId);
    }
}
/**
 * クエリパラメータのパース
 *
 * @param event API Gateway Proxy Event
 * @returns パース済みクエリパラメータ
 * @throws ValidationError バリデーションエラー
 */
function parseQueryParameters(event) {
    const params = event.queryStringParameters || {};
    // フォーマットのバリデーション
    const format = (params.format || 'json');
    if (!['json', 'csv'].includes(format)) {
        throw new errors_1.ValidationError(`Invalid format: ${format}. Expected 'json' or 'csv'.`);
    }
    // リミットのバリデーション（デフォルト: 100、最大: 1000）
    let limit = 100;
    if (params.limit) {
        limit = parseInt(params.limit, 10);
        if (isNaN(limit) || limit < 1 || limit > 1000) {
            throw new errors_1.ValidationError(`Invalid limit: ${params.limit}. Expected a number between 1 and 1000.`);
        }
    }
    // オフセットのバリデーション（デフォルト: 0）
    let offset = 0;
    if (params.offset) {
        offset = parseInt(params.offset, 10);
        if (isNaN(offset) || offset < 0) {
            throw new errors_1.ValidationError(`Invalid offset: ${params.offset}. Expected a non-negative number.`);
        }
    }
    // 日付フォーマットのバリデーション
    if (params.start_date) {
        validateDateFormat(params.start_date, 'start_date');
    }
    if (params.end_date) {
        validateDateFormat(params.end_date, 'end_date');
    }
    // 日付範囲の順序性チェック（Property 8）
    if (params.start_date && params.end_date) {
        const startDate = new Date(params.start_date);
        const endDate = new Date(params.end_date);
        if (startDate > endDate) {
            throw new errors_1.ValidationError(`start_date (${params.start_date}) must be before or equal to end_date (${params.end_date})`);
        }
    }
    // 企業コードのバリデーション（4桁の数字）
    if (params.company_code) {
        const companyCodeRegex = /^\d{4}$/;
        if (!companyCodeRegex.test(params.company_code)) {
            throw new errors_1.ValidationError(`Invalid company_code: ${params.company_code}. Expected 4-digit number.`);
        }
    }
    return {
        company_code: params.company_code,
        start_date: params.start_date,
        end_date: params.end_date,
        disclosure_type: params.disclosure_type,
        format,
        limit,
        offset,
    };
}
/**
 * 日付フォーマットのバリデーション
 *
 * @param date 日付文字列（YYYY-MM-DD）
 * @param fieldName フィールド名
 * @throws ValidationError バリデーションエラー
 */
function validateDateFormat(date, fieldName) {
    // YYYY-MM-DD形式のチェック
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateRegex.test(date)) {
        throw new errors_1.ValidationError(`Invalid ${fieldName} format: ${date}. Expected YYYY-MM-DD format.`);
    }
    // 有効な日付かチェック
    const parsedDate = new Date(date);
    if (isNaN(parsedDate.getTime())) {
        throw new errors_1.ValidationError(`Invalid ${fieldName}: ${date}. Date does not exist.`);
    }
    // 日付の整合性チェック（例: 2023-02-29は2023-03-01に変換されるため検出）
    const [year, month, day] = date.split('-').map(Number);
    if (parsedDate.getFullYear() !== year ||
        parsedDate.getMonth() + 1 !== month ||
        parsedDate.getDate() !== day) {
        throw new errors_1.ValidationError(`Invalid ${fieldName}: ${date}. Date does not exist.`);
    }
}
/**
 * エラーハンドリング
 *
 * カスタムエラーを適切なHTTPステータスコードとエラーコードに変換します。
 * API設計ガイドラインに準拠した形式でエラーレスポンスを返します。
 *
 * @param error エラーオブジェクト
 * @param requestId リクエストID
 * @returns API Gateway Proxy Result
 */
function handleError(error, requestId) {
    // エラー種別に応じたステータスコードとエラーコード
    let statusCode = 500;
    let errorCode = 'INTERNAL_ERROR';
    let details = {};
    if (error instanceof errors_1.ValidationError) {
        statusCode = 400;
        errorCode = 'VALIDATION_ERROR';
        // ValidationErrorの詳細情報を含める
        if (error.details) {
            details = error.details;
        }
    }
    else if (error instanceof errors_1.NotFoundError) {
        statusCode = 404;
        errorCode = 'NOT_FOUND';
    }
    // API設計ガイドラインに準拠したエラーレスポンス形式
    const errorResponse = {
        status: 'error',
        error: {
            code: errorCode,
            message: error.message,
            details,
        },
        request_id: requestId,
    };
    // 本番環境ではスタックトレースを含めない
    if (process.env.NODE_ENV !== 'production') {
        errorResponse.error.stack = error.stack;
    }
    return {
        statusCode,
        headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
        },
        body: JSON.stringify(errorResponse),
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXHF1ZXJ5XFxoYW5kbGVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7OztHQU9HOztBQWdFSCwwQkFxRkM7QUFsSkQsK0NBQWdFO0FBQ2hFLHVFQUE4RTtBQUM5RSx5Q0FBOEQ7QUFDOUQsMkRBQXVEO0FBQ3ZELDZDQUEyQztBQXNDM0M7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWtCRztBQUNJLEtBQUssVUFBVSxPQUFPLENBQzNCLEtBQWlCLEVBQ2pCLE9BQWdCO0lBRWhCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUU3QixJQUFJLENBQUM7UUFDSCxlQUFNLENBQUMsSUFBSSxDQUFDLHNCQUFzQixFQUFFO1lBQ2xDLHFCQUFxQixFQUFFLEtBQUssQ0FBQyxxQkFBcUI7WUFDbEQsVUFBVSxFQUFFLE9BQU8sQ0FBQyxZQUFZO1lBQ2hDLGFBQWEsRUFBRSxPQUFPLENBQUMsWUFBWTtTQUNwQyxDQUFDLENBQUM7UUFFSCxlQUFlO1FBQ2YsTUFBTSxNQUFNLEdBQUcsb0JBQW9CLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFM0MsVUFBVTtRQUNWLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBQSxvQ0FBZ0IsRUFBQyxNQUFNLENBQUMsQ0FBQztRQUU5QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsU0FBUyxDQUFDO1FBRXhDLGVBQU0sQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUU7WUFDcEMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxZQUFZO1lBQ2hDLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSztZQUNuQixXQUFXLEVBQUUsUUFBUTtTQUN0QixDQUFDLENBQUM7UUFFSCxZQUFZO1FBQ1osTUFBTSxJQUFBLGdDQUFXLEVBQUM7WUFDaEI7Z0JBQ0UsSUFBSSxFQUFFLHFCQUFxQjtnQkFDM0IsS0FBSyxFQUFFLFFBQVE7Z0JBQ2YsSUFBSSxFQUFF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QyxLQUFLLENBQUM7SUFDbkQsQ0FBQztJQUVELE9BQU87UUFDTCxVQUFVO1FBQ1YsT0FBTyxFQUFFO1lBQ1AsY0FBYyxFQUFFLGtCQUFrQjtZQUNsQyw2QkFBNkIsRUFBRSxHQUFHO1NBQ25DO1FBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDO0tBQ3BDLENBQUM7QUFDSixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcdGkxOThcXGludmVzdG1lbnRfYW5hbHlzaXNfb3BvcG9cXHNyY1xcbGFtYmRhXFxxdWVyeVxcaGFuZGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogTGFtYmRhIFF1ZXJ5IEhhbmRsZXJcclxuICpcclxuICogVERuZXTplovnpLrmg4XloLHjgpLmpJzntKLjgZnjgotMYW1iZGHplqLmlbDjga7jg6HjgqTjg7Pjg4/jg7Pjg4njg6njg7zjgIJcclxuICogQVBJIEdhdGV3YXnntbHlkIjjgavjgojjgorjgIFSRVNUZnVsIEFQSeOBqOOBl+OBpuWFrOmWi+OBleOCjOOBvuOBmeOAglxyXG4gKlxyXG4gKiBSZXF1aXJlbWVudHM6IOimgeS7tjQuMSwgNC4zLCA0LjQsIDUuMiwgMTEuMe+8iOaknOe0okFQSeOAgeiqjeiovOOAgVBERuODgOOCpuODs+ODreODvOODieOAgUNTVuW9ouW8j++8iVxyXG4gKi9cclxuXHJcbmltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQsIENvbnRleHQgfSBmcm9tICdhd3MtbGFtYmRhJztcclxuaW1wb3J0IHsgbG9nZ2VyLCBjcmVhdGVFcnJvckNvbnRleHQgfSBmcm9tICcuLi8uLi91dGlscy9sb2dnZXInO1xyXG5pbXBvcnQgeyBzZW5kRXJyb3JNZXRyaWMsIHNlbmRNZXRyaWNzIH0gZnJvbSAnLi4vLi4vdXRpbHMvY2xvdWR3YXRjaC1tZXRyaWNzJztcclxuaW1wb3J0IHsgVmFsaWRhdGlvbkVycm9yLCBOb3RGb3VuZEVycm9yIH0gZnJvbSAnLi4vLi4vZXJyb3JzJztcclxuaW1wb3J0IHsgcXVlcnlEaXNjbG9zdXJlcyB9IGZyb20gJy4vcXVlcnktZGlzY2xvc3VyZXMnO1xyXG5pbXBvcnQgeyBmb3JtYXRBc0NzdiB9IGZyb20gJy4vZm9ybWF0LWNzdic7XHJcbmltcG9ydCB7IERpc2Nsb3N1cmUgfSBmcm9tICcuLi8uLi90eXBlcyc7XHJcblxyXG4vKipcclxuICogTGFtYmRhIFF1ZXJ544Kk44OZ44Oz44OI77yIQVBJIEdhdGV3YXnntbHlkIjvvIlcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgUXVlcnlFdmVudCBleHRlbmRzIEFQSUdhdGV3YXlQcm94eUV2ZW50IHtcclxuICBxdWVyeVN0cmluZ1BhcmFtZXRlcnM6IHtcclxuICAgIGNvbXBhbnlfY29kZT86IHN0cmluZztcclxuICAgIHN0YXJ0X2RhdGU/OiBzdHJpbmc7XHJcbiAgICBlbmRfZGF0ZT86IHN0cmluZztcclxuICAgIGRpc2Nsb3N1cmVfdHlwZT86IHN0cmluZztcclxuICAgIGZvcm1hdD86ICdqc29uJyB8ICdjc3YnO1xyXG4gICAgbGltaXQ/OiBzdHJpbmc7XHJcbiAgICBvZmZzZXQ/OiBzdHJpbmc7XHJcbiAgfSB8IG51bGw7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgq/jgqjjg6rjg6zjgrnjg53jg7PjgrlcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgUXVlcnlSZXNwb25zZSB7XHJcbiAgLyoqIOaknOe0oue1kOaenCAqL1xyXG4gIGRpc2Nsb3N1cmVzOiBEaXNjbG9zdXJlW107XHJcblxyXG4gIC8qKiDnt4/ku7bmlbAgKi9cclxuICB0b3RhbDogbnVtYmVyO1xyXG5cclxuICAvKiog5Y+W5b6X5Lu25pWwICovXHJcbiAgY291bnQ6IG51bWJlcjtcclxuXHJcbiAgLyoqIOOCquODleOCu+ODg+ODiCAqL1xyXG4gIG9mZnNldDogbnVtYmVyO1xyXG5cclxuICAvKiog44Oq44Of44OD44OIICovXHJcbiAgbGltaXQ6IG51bWJlcjtcclxufVxyXG5cclxuLyoqXHJcbiAqIExhbWJkYSBRdWVyeeODj+ODs+ODieODqeODvFxyXG4gKlxyXG4gKiBAcGFyYW0gZXZlbnQgQVBJIEdhdGV3YXkgUHJveHkgRXZlbnRcclxuICogQHBhcmFtIGNvbnRleHQgTGFtYmRhIENvbnRleHRcclxuICogQHJldHVybnMgQVBJIEdhdGV3YXkgUHJveHkgUmVzdWx0XHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYHR5cGVzY3JpcHRcclxuICogLy8g5LyB5qWt44Kz44O844OJ44Gn5qSc57SiXHJcbiAqIEdFVCAvZGlzY2xvc3VyZXM/Y29tcGFueV9jb2RlPTcyMDNcclxuICpcclxuICogLy8g5pel5LuY56+E5Zuy44Gn5qSc57SiXHJcbiAqIEdFVCAvZGlzY2xvc3VyZXM/c3RhcnRfZGF0ZT0yMDI0LTAxLTE1JmVuZF9kYXRlPTIwMjQtMDEtMjBcclxuICpcclxuICogLy8gQ1NW5b2i5byP44Gn5Y+W5b6XXHJcbiAqIEdFVCAvZGlzY2xvc3VyZXM/Zm9ybWF0PWNzdiZzdGFydF9kYXRlPTIwMjQtMDEtMTUmZW5kX2RhdGU9MjAyNC0wMS0yMFxyXG4gKiBgYGBcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVyKFxyXG4gIGV2ZW50OiBRdWVyeUV2ZW50LFxyXG4gIGNvbnRleHQ6IENvbnRleHRcclxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcclxuICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xyXG5cclxuICB0cnkge1xyXG4gICAgbG9nZ2VyLmluZm8oJ0xhbWJkYSBRdWVyeSBzdGFydGVkJywge1xyXG4gICAgICBxdWVyeVN0cmluZ1BhcmFtZXRlcnM6IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyxcclxuICAgICAgcmVxdWVzdF9pZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXHJcbiAgICAgIGZ1bmN0aW9uX25hbWU6IGNvbnRleHQuZnVuY3Rpb25OYW1lLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g44Kv44Ko44Oq44OR44Op44Oh44O844K/44Gu44OR44O844K5XHJcbiAgICBjb25zdCBwYXJhbXMgPSBwYXJzZVF1ZXJ5UGFyYW1ldGVycyhldmVudCk7XHJcblxyXG4gICAgLy8g6ZaL56S65oOF5aCx44KS5qSc57SiXHJcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBxdWVyeURpc2Nsb3N1cmVzKHBhcmFtcyk7XHJcblxyXG4gICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xyXG5cclxuICAgIGxvZ2dlci5pbmZvKCdMYW1iZGEgUXVlcnkgY29tcGxldGVkJywge1xyXG4gICAgICByZXF1ZXN0X2lkOiBjb250ZXh0LmF3c1JlcXVlc3RJZCxcclxuICAgICAgY291bnQ6IHJlc3VsdC5jb3VudCxcclxuICAgICAgZHVyYXRpb25fbXM6IGR1cmF0aW9uLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g5oiQ5Yqf44Oh44OI44Oq44Kv44K56YCB5L+hXHJcbiAgICBhd2FpdCBzZW5kTWV0cmljcyhbXHJcbiAgICAgIHtcclxuICAgICAgICBuYW1lOiAnTGFtYmRhRXhlY3V0aW9uVGltZScsXHJcbiAgICAgICAgdmFsdWU6IGR1cmF0aW9uLFxyXG4gICAgICAgIHVuaXQ6ICdNaWxsaXNlY29uZHMnLFxyXG4gICAgICAgIGRpbWVuc2lvbnM6IHsgRnVuY3Rpb25OYW1lOiAnUXVlcnknIH0sXHJcbiAgICAgIH0sXHJcbiAgICAgIHtcclxuICAgICAgICBuYW1lOiAnUXVlcnlSZXN1bHRDb3VudCcsXHJcbiAgICAgICAgdmFsdWU6IHJlc3VsdC5jb3VudCxcclxuICAgICAgICB1bml0OiAnQ291bnQnLFxyXG4gICAgICAgIGRpbWVuc2lvbnM6IHsgRm9ybWF0OiBwYXJhbXMuZm9ybWF0IH0sXHJcbiAgICAgIH0sXHJcbiAgICBdKTtcclxuXHJcbiAgICAvLyDjg5Xjgqnjg7zjg57jg4Pjg4jliKXjg6zjgrnjg53jg7PjgrlcclxuICAgIGlmIChwYXJhbXMuZm9ybWF0ID09PSAnY3N2Jykge1xyXG4gICAgICBjb25zdCBjc3YgPSBmb3JtYXRBc0NzdihyZXN1bHQuZGlzY2xvc3VyZXMpO1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHN0YXR1c0NvZGU6IDIwMCxcclxuICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ3RleHQvY3N2JyxcclxuICAgICAgICAgICdDb250ZW50LURpc3Bvc2l0aW9uJzogYGF0dGFjaG1lbnQ7IGZpbGVuYW1lPVwiZGlzY2xvc3VyZXMtJHtEYXRlLm5vdygpfS5jc3ZcImAsXHJcbiAgICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgYm9keTogY3N2LFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEpTT07lvaLlvI/vvIjjg4fjg5Xjgqnjg6vjg4jvvIlcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcclxuICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgICAgfSxcclxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVzdWx0KSxcclxuICAgIH07XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcclxuXHJcbiAgICBsb2dnZXIuZXJyb3IoXHJcbiAgICAgICdMYW1iZGEgUXVlcnkgZmFpbGVkJyxcclxuICAgICAgY3JlYXRlRXJyb3JDb250ZXh0KGVycm9yIGFzIEVycm9yLCB7XHJcbiAgICAgICAgcmVxdWVzdF9pZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXHJcbiAgICAgICAgZHVyYXRpb25fbXM6IGR1cmF0aW9uLFxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICAvLyDjgqjjg6njg7zjg6Hjg4jjg6rjgq/jgrnpgIHkv6FcclxuICAgIGF3YWl0IHNlbmRFcnJvck1ldHJpYyhcclxuICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLmNvbnN0cnVjdG9yLm5hbWUgOiAnVW5rbm93bicsXHJcbiAgICAgICdRdWVyeSdcclxuICAgICk7XHJcblxyXG4gICAgcmV0dXJuIGhhbmRsZUVycm9yKGVycm9yIGFzIEVycm9yLCBjb250ZXh0LmF3c1JlcXVlc3RJZCk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog44Kv44Ko44Oq44OR44Op44Oh44O844K/44Gu44OR44O844K5XHJcbiAqXHJcbiAqIEBwYXJhbSBldmVudCBBUEkgR2F0ZXdheSBQcm94eSBFdmVudFxyXG4gKiBAcmV0dXJucyDjg5Hjg7zjgrnmuIjjgb/jgq/jgqjjg6rjg5Hjg6njg6Hjg7zjgr9cclxuICogQHRocm93cyBWYWxpZGF0aW9uRXJyb3Ig44OQ44Oq44OH44O844K344On44Oz44Ko44Op44O8XHJcbiAqL1xyXG5mdW5jdGlvbiBwYXJzZVF1ZXJ5UGFyYW1ldGVycyhldmVudDogUXVlcnlFdmVudCk6IHtcclxuICBjb21wYW55X2NvZGU/OiBzdHJpbmc7XHJcbiAgc3RhcnRfZGF0ZT86IHN0cmluZztcclxuICBlbmRfZGF0ZT86IHN0cmluZztcclxuICBkaXNjbG9zdXJlX3R5cGU/OiBzdHJpbmc7XHJcbiAgZm9ybWF0OiAnanNvbicgfCAnY3N2JztcclxuICBsaW1pdDogbnVtYmVyO1xyXG4gIG9mZnNldDogbnVtYmVyO1xyXG59IHtcclxuICBjb25zdCBwYXJhbXMgPSBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMgfHwge307XHJcblxyXG4gIC8vIOODleOCqeODvOODnuODg+ODiOOBruODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gIGNvbnN0IGZvcm1hdCA9IChwYXJhbXMuZm9ybWF0IHx8ICdqc29uJykgYXMgJ2pzb24nIHwgJ2Nzdic7XHJcbiAgaWYgKCFbJ2pzb24nLCAnY3N2J10uaW5jbHVkZXMoZm9ybWF0KSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEludmFsaWQgZm9ybWF0OiAke2Zvcm1hdH0uIEV4cGVjdGVkICdqc29uJyBvciAnY3N2Jy5gXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8g44Oq44Of44OD44OI44Gu44OQ44Oq44OH44O844K344On44Oz77yI44OH44OV44Kp44Or44OIOiAxMDDjgIHmnIDlpKc6IDEwMDDvvIlcclxuICBsZXQgbGltaXQgPSAxMDA7XHJcbiAgaWYgKHBhcmFtcy5saW1pdCkge1xyXG4gICAgbGltaXQgPSBwYXJzZUludChwYXJhbXMubGltaXQsIDEwKTtcclxuICAgIGlmIChpc05hTihsaW1pdCkgfHwgbGltaXQgPCAxIHx8IGxpbWl0ID4gMTAwMCkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICAgIGBJbnZhbGlkIGxpbWl0OiAke3BhcmFtcy5saW1pdH0uIEV4cGVjdGVkIGEgbnVtYmVyIGJldHdlZW4gMSBhbmQgMTAwMC5gXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDjgqrjg5Xjgrvjg4Pjg4jjga7jg5Djg6rjg4fjg7zjgrfjg6fjg7PvvIjjg4fjg5Xjgqnjg6vjg4g6IDDvvIlcclxuICBsZXQgb2Zmc2V0ID0gMDtcclxuICBpZiAocGFyYW1zLm9mZnNldCkge1xyXG4gICAgb2Zmc2V0ID0gcGFyc2VJbnQocGFyYW1zLm9mZnNldCwgMTApO1xyXG4gICAgaWYgKGlzTmFOKG9mZnNldCkgfHwgb2Zmc2V0IDwgMCkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICAgIGBJbnZhbGlkIG9mZnNldDogJHtwYXJhbXMub2Zmc2V0fS4gRXhwZWN0ZWQgYSBub24tbmVnYXRpdmUgbnVtYmVyLmBcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOaXpeS7mOODleOCqeODvOODnuODg+ODiOOBruODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gIGlmIChwYXJhbXMuc3RhcnRfZGF0ZSkge1xyXG4gICAgdmFsaWRhdGVEYXRlRm9ybWF0KHBhcmFtcy5zdGFydF9kYXRlLCAnc3RhcnRfZGF0ZScpO1xyXG4gIH1cclxuICBpZiAocGFyYW1zLmVuZF9kYXRlKSB7XHJcbiAgICB2YWxpZGF0ZURhdGVGb3JtYXQocGFyYW1zLmVuZF9kYXRlLCAnZW5kX2RhdGUnKTtcclxuICB9XHJcblxyXG4gIC8vIOaXpeS7mOevhOWbsuOBrumghuW6j+aAp+ODgeOCp+ODg+OCr++8iFByb3BlcnR5IDjvvIlcclxuICBpZiAocGFyYW1zLnN0YXJ0X2RhdGUgJiYgcGFyYW1zLmVuZF9kYXRlKSB7XHJcbiAgICBjb25zdCBzdGFydERhdGUgPSBuZXcgRGF0ZShwYXJhbXMuc3RhcnRfZGF0ZSk7XHJcbiAgICBjb25zdCBlbmREYXRlID0gbmV3IERhdGUocGFyYW1zLmVuZF9kYXRlKTtcclxuXHJcbiAgICBpZiAoc3RhcnREYXRlID4gZW5kRGF0ZSkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICAgIGBzdGFydF9kYXRlICgke3BhcmFtcy5zdGFydF9kYXRlfSkgbXVzdCBiZSBiZWZvcmUgb3IgZXF1YWwgdG8gZW5kX2RhdGUgKCR7cGFyYW1zLmVuZF9kYXRlfSlgXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDkvIHmpa3jgrPjg7zjg4njga7jg5Djg6rjg4fjg7zjgrfjg6fjg7PvvIg05qGB44Gu5pWw5a2X77yJXHJcbiAgaWYgKHBhcmFtcy5jb21wYW55X2NvZGUpIHtcclxuICAgIGNvbnN0IGNvbXBhbnlDb2RlUmVnZXggPSAvXlxcZHs0fSQvO1xyXG4gICAgaWYgKCFjb21wYW55Q29kZVJlZ2V4LnRlc3QocGFyYW1zLmNvbXBhbnlfY29kZSkpIHtcclxuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgICBgSW52YWxpZCBjb21wYW55X2NvZGU6ICR7cGFyYW1zLmNvbXBhbnlfY29kZX0uIEV4cGVjdGVkIDQtZGlnaXQgbnVtYmVyLmBcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBjb21wYW55X2NvZGU6IHBhcmFtcy5jb21wYW55X2NvZGUsXHJcbiAgICBzdGFydF9kYXRlOiBwYXJhbXMuc3RhcnRfZGF0ZSxcclxuICAgIGVuZF9kYXRlOiBwYXJhbXMuZW5kX2RhdGUsXHJcbiAgICBkaXNjbG9zdXJlX3R5cGU6IHBhcmFtcy5kaXNjbG9zdXJlX3R5cGUsXHJcbiAgICBmb3JtYXQsXHJcbiAgICBsaW1pdCxcclxuICAgIG9mZnNldCxcclxuICB9O1xyXG59XHJcblxyXG4vKipcclxuICog5pel5LuY44OV44Kp44O844Oe44OD44OI44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAqXHJcbiAqIEBwYXJhbSBkYXRlIOaXpeS7mOaWh+Wtl+WIl++8iFlZWVktTU0tRETvvIlcclxuICogQHBhcmFtIGZpZWxkTmFtZSDjg5XjgqPjg7zjg6vjg4nlkI1cclxuICogQHRocm93cyBWYWxpZGF0aW9uRXJyb3Ig44OQ44Oq44OH44O844K344On44Oz44Ko44Op44O8XHJcbiAqL1xyXG5mdW5jdGlvbiB2YWxpZGF0ZURhdGVGb3JtYXQoZGF0ZTogc3RyaW5nLCBmaWVsZE5hbWU6IHN0cmluZyk6IHZvaWQge1xyXG4gIC8vIFlZWVktTU0tRETlvaLlvI/jga7jg4Hjgqfjg4Pjgq9cclxuICBjb25zdCBkYXRlUmVnZXggPSAvXlxcZHs0fS1cXGR7Mn0tXFxkezJ9JC87XHJcbiAgaWYgKCFkYXRlUmVnZXgudGVzdChkYXRlKSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEludmFsaWQgJHtmaWVsZE5hbWV9IGZvcm1hdDogJHtkYXRlfS4gRXhwZWN0ZWQgWVlZWS1NTS1ERCBmb3JtYXQuYFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIOacieWKueOBquaXpeS7mOOBi+ODgeOCp+ODg+OCr1xyXG4gIGNvbnN0IHBhcnNlZERhdGUgPSBuZXcgRGF0ZShkYXRlKTtcclxuICBpZiAoaXNOYU4ocGFyc2VkRGF0ZS5nZXRUaW1lKCkpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCAke2ZpZWxkTmFtZX06ICR7ZGF0ZX0uIERhdGUgZG9lcyBub3QgZXhpc3QuYFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIOaXpeS7mOOBruaVtOWQiOaAp+ODgeOCp+ODg+OCr++8iOS+izogMjAyMy0wMi0yOeOBrzIwMjMtMDMtMDHjgavlpInmj5vjgZXjgozjgovjgZ/jgoHmpJzlh7rvvIlcclxuICBjb25zdCBbeWVhciwgbW9udGgsIGRheV0gPSBkYXRlLnNwbGl0KCctJykubWFwKE51bWJlcik7XHJcbiAgaWYgKFxyXG4gICAgcGFyc2VkRGF0ZS5nZXRGdWxsWWVhcigpICE9PSB5ZWFyIHx8XHJcbiAgICBwYXJzZWREYXRlLmdldE1vbnRoKCkgKyAxICE9PSBtb250aCB8fFxyXG4gICAgcGFyc2VkRGF0ZS5nZXREYXRlKCkgIT09IGRheVxyXG4gICkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEludmFsaWQgJHtmaWVsZE5hbWV9OiAke2RhdGV9LiBEYXRlIGRvZXMgbm90IGV4aXN0LmBcclxuICAgICk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog44Ko44Op44O844OP44Oz44OJ44Oq44Oz44KwXHJcbiAqXHJcbiAqIOOCq+OCueOCv+ODoOOCqOODqeODvOOCkumBqeWIh+OBqkhUVFDjgrnjg4bjg7zjgr/jgrnjgrPjg7zjg4njgajjgqjjg6njg7zjgrPjg7zjg4njgavlpInmj5vjgZfjgb7jgZnjgIJcclxuICogQVBJ6Kit6KiI44Ks44Kk44OJ44Op44Kk44Oz44Gr5rqW5oug44GX44Gf5b2i5byP44Gn44Ko44Op44O844Os44K544Od44Oz44K544KS6L+U44GX44G+44GZ44CCXHJcbiAqXHJcbiAqIEBwYXJhbSBlcnJvciDjgqjjg6njg7zjgqrjg5bjgrjjgqfjgq/jg4hcclxuICogQHBhcmFtIHJlcXVlc3RJZCDjg6rjgq/jgqjjgrnjg4hJRFxyXG4gKiBAcmV0dXJucyBBUEkgR2F0ZXdheSBQcm94eSBSZXN1bHRcclxuICovXHJcbmZ1bmN0aW9uIGhhbmRsZUVycm9yKGVycm9yOiBFcnJvciwgcmVxdWVzdElkOiBzdHJpbmcpOiBBUElHYXRld2F5UHJveHlSZXN1bHQge1xyXG4gIC8vIOOCqOODqeODvOeoruWIpeOBq+W/nOOBmOOBn+OCueODhuODvOOCv+OCueOCs+ODvOODieOBqOOCqOODqeODvOOCs+ODvOODiVxyXG4gIGxldCBzdGF0dXNDb2RlID0gNTAwO1xyXG4gIGxldCBlcnJvckNvZGUgPSAnSU5URVJOQUxfRVJST1InO1xyXG4gIGxldCBkZXRhaWxzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XHJcblxyXG4gIGlmIChlcnJvciBpbnN0YW5jZW9mIFZhbGlkYXRpb25FcnJvcikge1xyXG4gICAgc3RhdHVzQ29kZSA9IDQwMDtcclxuICAgIGVycm9yQ29kZSA9ICdWQUxJREFUSU9OX0VSUk9SJztcclxuICAgIC8vIFZhbGlkYXRpb25FcnJvcuOBruips+e0sOaDheWgseOCkuWQq+OCgeOCi1xyXG4gICAgaWYgKChlcnJvciBhcyBhbnkpLmRldGFpbHMpIHtcclxuICAgICAgZGV0YWlscyA9IChlcnJvciBhcyBhbnkpLmRldGFpbHM7XHJcbiAgICB9XHJcbiAgfSBlbHNlIGlmIChlcnJvciBpbnN0YW5jZW9mIE5vdEZvdW5kRXJyb3IpIHtcclxuICAgIHN0YXR1c0NvZGUgPSA0MDQ7XHJcbiAgICBlcnJvckNvZGUgPSAnTk9UX0ZPVU5EJztcclxuICB9XHJcblxyXG4gIC8vIEFQSeioreioiOOCrOOCpOODieODqeOCpOODs+OBq+a6luaLoOOBl+OBn+OCqOODqeODvOODrOOCueODneODs+OCueW9ouW8j1xyXG4gIGNvbnN0IGVycm9yUmVzcG9uc2UgPSB7XHJcbiAgICBzdGF0dXM6ICdlcnJvcicsXHJcbiAgICBlcnJvcjoge1xyXG4gICAgICBjb2RlOiBlcnJvckNvZGUsXHJcbiAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXHJcbiAgICAgIGRldGFpbHMsXHJcbiAgICB9LFxyXG4gICAgcmVxdWVzdF9pZDogcmVxdWVzdElkLFxyXG4gIH07XHJcblxyXG4gIC8vIOacrOeVqueSsOWig+OBp+OBr+OCueOCv+ODg+OCr+ODiOODrOODvOOCueOCkuWQq+OCgeOBquOBhFxyXG4gIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7XHJcbiAgICAoZXJyb3JSZXNwb25zZS5lcnJvciBhcyBhbnkpLnN0YWNrID0gZXJyb3Iuc3RhY2s7XHJcbiAgfVxyXG5cclxuICByZXR1cm4ge1xyXG4gICAgc3RhdHVzQ29kZSxcclxuICAgIGhlYWRlcnM6IHtcclxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgIH0sXHJcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeShlcnJvclJlc3BvbnNlKSxcclxuICB9O1xyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==