8cfd0b8932955d714afc483fb81c081f
"use strict";
/**
 * エクスポートジョブ作成
 *
 * エクスポートIDを生成し、実行状態をDynamoDBに保存します。
 *
 * Requirements: 要件5.1（エクスポート）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.createExportJob = createExportJob;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const logger_1 = require("../../utils/logger");
const retry_1 = require("../../utils/retry");
// DynamoDBクライアント（グローバルスコープで初期化）
const dynamoClient = new client_dynamodb_1.DynamoDBClient({
    region: process.env.AWS_REGION || 'ap-northeast-1',
    ...(process.env.AWS_ENDPOINT_URL && {
        endpoint: process.env.AWS_ENDPOINT_URL,
    }),
});
// 環境変数
const EXPORT_STATUS_TABLE = process.env.EXPORT_STATUS_TABLE_NAME || 'tdnet-export-status';
/**
 * エクスポートジョブを作成
 *
 * @param requestBody エクスポートリクエストボディ
 * @param requestId リクエストID
 * @returns エクスポートステータス
 */
async function createExportJob(requestBody, requestId) {
    // エクスポートIDを生成
    const export_id = generateExportId(requestId);
    // 現在時刻（ISO 8601形式、UTC）
    const requested_at = new Date().toISOString();
    // TTL（30日後に自動削除）
    const ttl = Math.floor(Date.now() / 1000) + 30 * 24 * 60 * 60;
    // エクスポートステータスアイテム
    const exportStatus = {
        export_id,
        status: 'pending',
        requested_at,
        progress: 0,
        ttl,
        format: requestBody.format,
        filter: JSON.stringify(requestBody.filter),
    };
    logger_1.logger.info('Creating export job', {
        export_id,
        format: requestBody.format,
        filter: requestBody.filter,
    });
    // DynamoDBに保存
    await (0, retry_1.retryWithBackoff)(async () => {
        await dynamoClient.send(new client_dynamodb_1.PutItemCommand({
            TableName: EXPORT_STATUS_TABLE,
            Item: {
                export_id: { S: exportStatus.export_id },
                status: { S: exportStatus.status },
                requested_at: { S: exportStatus.requested_at },
                progress: { N: String(exportStatus.progress) },
                ttl: { N: String(exportStatus.ttl) },
                format: { S: exportStatus.format },
                filter: { S: exportStatus.filter },
            },
            ConditionExpression: 'attribute_not_exists(export_id)',
        }));
    }, {
        maxRetries: 3,
        initialDelay: 1000,
        backoffMultiplier: 2,
        jitter: true,
        shouldRetry: (error) => {
            return error.name === 'ProvisionedThroughputExceededException';
        },
    });
    logger_1.logger.info('Export job created successfully', {
        export_id,
        status: exportStatus.status,
    });
    return exportStatus;
}
/**
 * エクスポートIDを生成
 *
 * フォーマット: export_タイムスタンプ_ランダム文字列_リクエストID先頭8文字
 * 例: export_1705305600000_abc123_12345678
 *
 * @param requestId リクエストID
 * @returns エクスポートID
 */
function generateExportId(requestId) {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 8);
    const requestIdPrefix = requestId.substring(0, 8);
    return `export_${timestamp}_${random}_${requestIdPrefix}`;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGV4cG9ydFxcY3JlYXRlLWV4cG9ydC1qb2IudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7R0FNRzs7QUF5QkgsMENBa0VDO0FBekZELDhEQUEwRTtBQUMxRSwrQ0FBNEM7QUFDNUMsNkNBQXFEO0FBR3JELGdDQUFnQztBQUNoQyxNQUFNLFlBQVksR0FBRyxJQUFJLGdDQUFjLENBQUM7SUFDdEMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLGdCQUFnQjtJQUNsRCxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsSUFBSTtRQUNsQyxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0I7S0FDdkMsQ0FBQztDQUNILENBQUMsQ0FBQztBQUVILE9BQU87QUFDUCxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLElBQUkscUJBQXFCLENBQUM7QUFFMUY7Ozs7OztHQU1HO0FBQ0ksS0FBSyxVQUFVLGVBQWUsQ0FDbkMsV0FBOEIsRUFDOUIsU0FBaUI7SUFFakIsY0FBYztJQUNkLE1BQU0sU0FBUyxHQUFHLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRTlDLHVCQUF1QjtJQUN2QixNQUFNLFlBQVksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBRTlDLGlCQUFpQjtJQUNqQixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUM7SUFFOUQsa0JBQWtCO0lBQ2xCLE1BQU0sWUFBWSxHQUFxQjtRQUNyQyxTQUFTO1FBQ1QsTUFBTSxFQUFFLFNBQVM7UUFDakIsWUFBWTtRQUNaLFFBQVEsRUFBRSxDQUFDO1FBQ1gsR0FBRztRQUNILE1BQU0sRUFBRSxXQUFXLENBQUMsTUFBTTtRQUMxQixNQUFNLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDO0tBQzNDLENBQUM7SUFFRixlQUFNLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUFFO1FBQ2pDLFNBQVM7UUFDVCxNQUFNLEVBQUUsV0FBVyxDQUFDLE1BQU07UUFDMUIsTUFBTSxFQUFFLFdBQVcsQ0FBQyxNQUFNO0tBQzNCLENBQUMsQ0FBQztJQUVILGNBQWM7SUFDZCxNQUFNLElBQUEsd0JBQWdCLEVBQ3BCLEtBQUssSUFBSSxFQUFFO1FBQ1QsTUFBTSxZQUFZLENBQUMsSUFBSSxDQUNyQixJQUFJLGdDQUFjLENBQUM7WUFDakIsU0FBUyxFQUFFLG1CQUFtQjtZQUM5QixJQUFJLEVBQUU7Z0JBQ0osU0FBUyxFQUFFLEVBQUUsQ0FBQyxFQUFFLFlBQVksQ0FBQyxTQUFTLEVBQUU7Z0JBQ3hDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRSxZQUFZLENBQUMsTUFBTSxFQUFFO2dCQUNsQyxZQUFZLEVBQUUsRUFBRSxDQUFDLEVBQUUsWUFBWSxDQUFDLFlBQVksRUFBRTtnQkFDOUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0JBQzlDLEdBQUcsRUFBRSxFQUFFLENBQUMsRUFBRSxNQUFNLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxFQUFFO2dCQUNwQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsWUFBWSxDQUFDLE1BQU0sRUFBRTtnQkFDbEMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxFQUFFLFlBQVksQ0FBQyxNQUFNLEVBQUU7YUFDbkM7WUFDRCxtQkFBbUIsRUFBRSxpQ0FBaUM7U0FDdkQsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDLEVBQ0Q7UUFDRSxVQUFVLEVBQUUsQ0FBQztRQUNiLFlBQVksRUFBRSxJQUFJO1FBQ2xCLGlCQUFpQixFQUFFLENBQUM7UUFDcEIsTUFBTSxFQUFFLElBQUk7UUFDWixXQUFXLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUNyQixPQUFPLEtBQUssQ0FBQyxJQUFJLEtBQUssd0NBQXdDLENBQUM7UUFDakUsQ0FBQztLQUNGLENBQ0YsQ0FBQztJQUVGLGVBQU0sQ0FBQyxJQUFJLENBQUMsaUNBQWlDLEVBQUU7UUFDN0MsU0FBUztRQUNULE1BQU0sRUFBRSxZQUFZLENBQUMsTUFBTTtLQUM1QixDQUFDLENBQUM7SUFFSCxPQUFPLFlBQVksQ0FBQztBQUN0QixDQUFDO0FBRUQ7Ozs7Ozs7O0dBUUc7QUFDSCxTQUFTLGdCQUFnQixDQUFDLFNBQWlCO0lBQ3pDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUM3QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDMUQsTUFBTSxlQUFlLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDbEQsT0FBTyxVQUFVLFNBQVMsSUFBSSxNQUFNLElBQUksZUFBZSxFQUFFLENBQUM7QUFDNUQsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpMTk4XFxpbnZlc3RtZW50X2FuYWx5c2lzX29wb3BvXFxzcmNcXGxhbWJkYVxcZXhwb3J0XFxjcmVhdGUtZXhwb3J0LWpvYi50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICog44Ko44Kv44K544Od44O844OI44K444On44OW5L2c5oiQXHJcbiAqXHJcbiAqIOOCqOOCr+OCueODneODvOODiElE44KS55Sf5oiQ44GX44CB5a6f6KGM54q25oWL44KSRHluYW1vRELjgavkv53lrZjjgZfjgb7jgZnjgIJcclxuICpcclxuICogUmVxdWlyZW1lbnRzOiDopoHku7Y1LjHvvIjjgqjjgq/jgrnjg53jg7zjg4jvvIlcclxuICovXHJcblxyXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCwgUHV0SXRlbUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xyXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi8uLi91dGlscy9sb2dnZXInO1xyXG5pbXBvcnQgeyByZXRyeVdpdGhCYWNrb2ZmIH0gZnJvbSAnLi4vLi4vdXRpbHMvcmV0cnknO1xyXG5pbXBvcnQgeyBFeHBvcnRSZXF1ZXN0Qm9keSwgRXhwb3J0U3RhdHVzSXRlbSB9IGZyb20gJy4vdHlwZXMnO1xyXG5cclxuLy8gRHluYW1vRELjgq/jg6njgqTjgqLjg7Pjg4jvvIjjgrDjg63jg7zjg5Djg6vjgrnjgrPjg7zjg5fjgafliJ3mnJ/ljJbvvIlcclxuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHtcclxuICByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ2FwLW5vcnRoZWFzdC0xJyxcclxuICAuLi4ocHJvY2Vzcy5lbnYuQVdTX0VORFBPSU5UX1VSTCAmJiB7XHJcbiAgICBlbmRwb2ludDogcHJvY2Vzcy5lbnYuQVdTX0VORFBPSU5UX1VSTCxcclxuICB9KSxcclxufSk7XHJcblxyXG4vLyDnkrDlooPlpInmlbBcclxuY29uc3QgRVhQT1JUX1NUQVRVU19UQUJMRSA9IHByb2Nlc3MuZW52LkVYUE9SVF9TVEFUVVNfVEFCTEVfTkFNRSB8fCAndGRuZXQtZXhwb3J0LXN0YXR1cyc7XHJcblxyXG4vKipcclxuICog44Ko44Kv44K544Od44O844OI44K444On44OW44KS5L2c5oiQXHJcbiAqXHJcbiAqIEBwYXJhbSByZXF1ZXN0Qm9keSDjgqjjgq/jgrnjg53jg7zjg4jjg6rjgq/jgqjjgrnjg4jjg5zjg4fjgqNcclxuICogQHBhcmFtIHJlcXVlc3RJZCDjg6rjgq/jgqjjgrnjg4hJRFxyXG4gKiBAcmV0dXJucyDjgqjjgq/jgrnjg53jg7zjg4jjgrnjg4bjg7zjgr/jgrlcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVFeHBvcnRKb2IoXHJcbiAgcmVxdWVzdEJvZHk6IEV4cG9ydFJlcXVlc3RCb2R5LFxyXG4gIHJlcXVlc3RJZDogc3RyaW5nXHJcbik6IFByb21pc2U8RXhwb3J0U3RhdHVzSXRlbT4ge1xyXG4gIC8vIOOCqOOCr+OCueODneODvOODiElE44KS55Sf5oiQXHJcbiAgY29uc3QgZXhwb3J0X2lkID0gZ2VuZXJhdGVFeHBvcnRJZChyZXF1ZXN0SWQpO1xyXG5cclxuICAvLyDnj77lnKjmmYLliLvvvIhJU08gODYwMeW9ouW8j+OAgVVUQ++8iVxyXG4gIGNvbnN0IHJlcXVlc3RlZF9hdCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcclxuXHJcbiAgLy8gVFRM77yIMzDml6Xlvozjgavoh6rli5XliYrpmaTvvIlcclxuICBjb25zdCB0dGwgPSBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwKSArIDMwICogMjQgKiA2MCAqIDYwO1xyXG5cclxuICAvLyDjgqjjgq/jgrnjg53jg7zjg4jjgrnjg4bjg7zjgr/jgrnjgqLjgqTjg4bjg6BcclxuICBjb25zdCBleHBvcnRTdGF0dXM6IEV4cG9ydFN0YXR1c0l0ZW0gPSB7XHJcbiAgICBleHBvcnRfaWQsXHJcbiAgICBzdGF0dXM6ICdwZW5kaW5nJyxcclxuICAgIHJlcXVlc3RlZF9hdCxcclxuICAgIHByb2dyZXNzOiAwLFxyXG4gICAgdHRsLFxyXG4gICAgZm9ybWF0OiByZXF1ZXN0Qm9keS5mb3JtYXQsXHJcbiAgICBmaWx0ZXI6IEpTT04uc3RyaW5naWZ5KHJlcXVlc3RCb2R5LmZpbHRlciksXHJcbiAgfTtcclxuXHJcbiAgbG9nZ2VyLmluZm8oJ0NyZWF0aW5nIGV4cG9ydCBqb2InLCB7XHJcbiAgICBleHBvcnRfaWQsXHJcbiAgICBmb3JtYXQ6IHJlcXVlc3RCb2R5LmZvcm1hdCxcclxuICAgIGZpbHRlcjogcmVxdWVzdEJvZHkuZmlsdGVyLFxyXG4gIH0pO1xyXG5cclxuICAvLyBEeW5hbW9EQuOBq+S/neWtmFxyXG4gIGF3YWl0IHJldHJ5V2l0aEJhY2tvZmYoXHJcbiAgICBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGF3YWl0IGR5bmFtb0NsaWVudC5zZW5kKFxyXG4gICAgICAgIG5ldyBQdXRJdGVtQ29tbWFuZCh7XHJcbiAgICAgICAgICBUYWJsZU5hbWU6IEVYUE9SVF9TVEFUVVNfVEFCTEUsXHJcbiAgICAgICAgICBJdGVtOiB7XHJcbiAgICAgICAgICAgIGV4cG9ydF9pZDogeyBTOiBleHBvcnRTdGF0dXMuZXhwb3J0X2lkIH0sXHJcbiAgICAgICAgICAgIHN0YXR1czogeyBTOiBleHBvcnRTdGF0dXMuc3RhdHVzIH0sXHJcbiAgICAgICAgICAgIHJlcXVlc3RlZF9hdDogeyBTOiBleHBvcnRTdGF0dXMucmVxdWVzdGVkX2F0IH0sXHJcbiAgICAgICAgICAgIHByb2dyZXNzOiB7IE46IFN0cmluZyhleHBvcnRTdGF0dXMucHJvZ3Jlc3MpIH0sXHJcbiAgICAgICAgICAgIHR0bDogeyBOOiBTdHJpbmcoZXhwb3J0U3RhdHVzLnR0bCkgfSxcclxuICAgICAgICAgICAgZm9ybWF0OiB7IFM6IGV4cG9ydFN0YXR1cy5mb3JtYXQgfSxcclxuICAgICAgICAgICAgZmlsdGVyOiB7IFM6IGV4cG9ydFN0YXR1cy5maWx0ZXIgfSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBDb25kaXRpb25FeHByZXNzaW9uOiAnYXR0cmlidXRlX25vdF9leGlzdHMoZXhwb3J0X2lkKScsXHJcbiAgICAgICAgfSlcclxuICAgICAgKTtcclxuICAgIH0sXHJcbiAgICB7XHJcbiAgICAgIG1heFJldHJpZXM6IDMsXHJcbiAgICAgIGluaXRpYWxEZWxheTogMTAwMCxcclxuICAgICAgYmFja29mZk11bHRpcGxpZXI6IDIsXHJcbiAgICAgIGppdHRlcjogdHJ1ZSxcclxuICAgICAgc2hvdWxkUmV0cnk6IChlcnJvcikgPT4ge1xyXG4gICAgICAgIHJldHVybiBlcnJvci5uYW1lID09PSAnUHJvdmlzaW9uZWRUaHJvdWdocHV0RXhjZWVkZWRFeGNlcHRpb24nO1xyXG4gICAgICB9LFxyXG4gICAgfVxyXG4gICk7XHJcblxyXG4gIGxvZ2dlci5pbmZvKCdFeHBvcnQgam9iIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5Jywge1xyXG4gICAgZXhwb3J0X2lkLFxyXG4gICAgc3RhdHVzOiBleHBvcnRTdGF0dXMuc3RhdHVzLFxyXG4gIH0pO1xyXG5cclxuICByZXR1cm4gZXhwb3J0U3RhdHVzO1xyXG59XHJcblxyXG4vKipcclxuICog44Ko44Kv44K544Od44O844OISUTjgpLnlJ/miJBcclxuICpcclxuICog44OV44Kp44O844Oe44OD44OIOiBleHBvcnRf44K/44Kk44Og44K544K/44Oz44OXX+ODqeODs+ODgOODoOaWh+Wtl+WIl1/jg6rjgq/jgqjjgrnjg4hJROWFiOmgrTjmloflrZdcclxuICog5L6LOiBleHBvcnRfMTcwNTMwNTYwMDAwMF9hYmMxMjNfMTIzNDU2NzhcclxuICpcclxuICogQHBhcmFtIHJlcXVlc3RJZCDjg6rjgq/jgqjjgrnjg4hJRFxyXG4gKiBAcmV0dXJucyDjgqjjgq/jgrnjg53jg7zjg4hJRFxyXG4gKi9cclxuZnVuY3Rpb24gZ2VuZXJhdGVFeHBvcnRJZChyZXF1ZXN0SWQ6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgY29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKTtcclxuICBjb25zdCByYW5kb20gPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHJpbmcoMiwgOCk7XHJcbiAgY29uc3QgcmVxdWVzdElkUHJlZml4ID0gcmVxdWVzdElkLnN1YnN0cmluZygwLCA4KTtcclxuICByZXR1cm4gYGV4cG9ydF8ke3RpbWVzdGFtcH1fJHtyYW5kb219XyR7cmVxdWVzdElkUHJlZml4fWA7XHJcbn1cclxuIl0sInZlcnNpb24iOjN9