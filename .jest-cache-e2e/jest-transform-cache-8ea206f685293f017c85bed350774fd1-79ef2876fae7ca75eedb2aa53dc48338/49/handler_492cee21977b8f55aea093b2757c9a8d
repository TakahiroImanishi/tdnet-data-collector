6ad5ea959b6708c60e3c7eda8f567113
"use strict";
/**
 * Lambda Export Handler
 *
 * TDnet開示情報をJSON/CSV形式でエクスポートするLambda関数のメインハンドラー。
 * APIキー認証を実装し、非同期でエクスポート処理を実行します。
 *
 * Requirements: 要件5.1, 5.2, 5.4, 11.1（エクスポート、認証）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const logger_1 = require("../../utils/logger");
const cloudwatch_metrics_1 = require("../../utils/cloudwatch-metrics");
const errors_1 = require("../../errors");
const create_export_job_1 = require("./create-export-job");
const process_export_1 = require("./process-export");
// Secrets Managerクライアント（グローバルスコープで初期化）
const secretsClient = new client_secrets_manager_1.SecretsManagerClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });
// APIキーキャッシュ（5分TTL）
let cachedApiKey = null;
let cacheExpiry = 0;
/**
 * Secrets ManagerからAPIキーを取得
 *
 * テスト環境（TEST_ENV=e2e）では、API_KEY環境変数から直接取得します。
 * 本番環境では、Secrets Managerから取得します。
 *
 * @returns APIキー
 * @throws Error Secrets Managerからの取得に失敗した場合
 */
async function getApiKey() {
    // キャッシュチェック
    if (cachedApiKey && Date.now() < cacheExpiry) {
        return cachedApiKey;
    }
    // テスト環境: API_KEY環境変数から直接取得
    if (process.env.TEST_ENV === 'e2e' && process.env.API_KEY) {
        cachedApiKey = process.env.API_KEY;
        cacheExpiry = Date.now() + 5 * 60 * 1000;
        return cachedApiKey;
    }
    // 本番環境: Secrets Managerから取得
    const secretArn = process.env.API_KEY_SECRET_ARN;
    if (!secretArn) {
        throw new Error('API_KEY_SECRET_ARN environment variable is not set');
    }
    try {
        const command = new client_secrets_manager_1.GetSecretValueCommand({ SecretId: secretArn });
        const response = await secretsClient.send(command);
        if (!response.SecretString) {
            throw new Error('Secret value is empty');
        }
        // APIキーをキャッシュ（5分TTL）
        cachedApiKey = response.SecretString;
        cacheExpiry = Date.now() + 5 * 60 * 1000;
        return cachedApiKey;
    }
    catch (error) {
        logger_1.logger.error('Failed to retrieve API key from Secrets Manager', {
            error: error instanceof Error ? error.message : String(error),
            secret_arn: secretArn,
        });
        throw new Error('Failed to retrieve API key');
    }
}
/**
 * Lambda Exportハンドラー
 *
 * @param event ExportEvent（API Gateway経由）
 * @param context Lambda Context
 * @returns APIGatewayProxyResult
 *
 * @example
 * ```typescript
 * // JSON形式でエクスポート
 * const response = await handler({
 *   headers: { 'x-api-key': 'your-api-key' },
 *   body: JSON.stringify({
 *     format: 'json',
 *     filter: {
 *       start_date: '2024-01-15',
 *       end_date: '2024-01-20',
 *     },
 *   }),
 * }, context);
 *
 * // CSV形式でエクスポート
 * const response = await handler({
 *   headers: { 'x-api-key': 'your-api-key' },
 *   body: JSON.stringify({
 *     format: 'csv',
 *     filter: {
 *       company_code: '1234',
 *       start_date: '2024-01-01',
 *       end_date: '2024-01-31',
 *     },
 *   }),
 * }, context);
 * ```
 */
async function handler(event, context) {
    const startTime = Date.now();
    try {
        logger_1.logger.info('Lambda Export started', {
            request_id: context.awsRequestId,
            function_name: context.functionName,
        });
        // APIキー認証
        await validateApiKey(event);
        // リクエストボディのパース
        const requestBody = parseRequestBody(event.body);
        // バリデーション
        validateRequestBody(requestBody);
        // エクスポートジョブを作成
        const exportJob = await (0, create_export_job_1.createExportJob)(requestBody, context.awsRequestId);
        // 非同期でエクスポート処理を開始（await しない）
        (0, process_export_1.processExport)(exportJob.export_id, requestBody)
            .catch((error) => {
            logger_1.logger.error('Export processing failed', (0, logger_1.createErrorContext)(error, {
                export_id: exportJob.export_id,
            }));
        });
        const duration = Date.now() - startTime;
        logger_1.logger.info('Lambda Export completed', {
            export_id: exportJob.export_id,
            status: exportJob.status,
            duration_ms: duration,
        });
        // 成功メトリクス送信
        await (0, cloudwatch_metrics_1.sendMetrics)([
            {
                name: 'LambdaExecutionTime',
                value: duration,
                unit: 'Milliseconds',
                dimensions: { FunctionName: 'Export' },
            },
            {
                name: 'ExportJobsCreated',
                value: 1,
                unit: 'Count',
                dimensions: { Format: requestBody.format },
            },
        ]);
        // レスポンス
        const response = {
            export_id: exportJob.export_id,
            status: exportJob.status,
            message: 'Export job created successfully',
            progress: exportJob.progress,
        };
        return {
            statusCode: 202, // Accepted
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Headers': 'Content-Type,X-Api-Key',
            },
            body: JSON.stringify(response),
        };
    }
    catch (error) {
        const duration = Date.now() - startTime;
        logger_1.logger.error('Lambda Export failed', (0, logger_1.createErrorContext)(error, {
            request_id: context.awsRequestId,
            duration_ms: duration,
        }));
        // エラーメトリクス送信
        await (0, cloudwatch_metrics_1.sendErrorMetric)(error instanceof Error ? error.constructor.name : 'Unknown', 'Export');
        // エラーレスポンス
        return handleError(error, context.awsRequestId);
    }
}
/**
 * APIキー認証
 *
 * @param event ExportEvent
 * @throws AuthenticationError APIキーが無効な場合
 */
async function validateApiKey(event) {
    const apiKey = event.headers?.['x-api-key'] || event.headers?.['X-Api-Key'];
    if (!apiKey) {
        throw new errors_1.AuthenticationError('API key is required');
    }
    // Secrets ManagerからAPIキーを取得
    const validApiKey = await getApiKey();
    if (apiKey !== validApiKey) {
        throw new errors_1.AuthenticationError('Invalid API key');
    }
}
/**
 * リクエストボディのパース
 *
 * @param body リクエストボディ（JSON文字列）
 * @returns ExportRequestBody
 * @throws ValidationError パースエラーの場合
 */
function parseRequestBody(body) {
    if (!body) {
        throw new errors_1.ValidationError('Request body is required');
    }
    try {
        return JSON.parse(body);
    }
    catch (error) {
        throw new errors_1.ValidationError('Invalid JSON format in request body', {
            body,
            error: error instanceof Error ? error.message : String(error),
        });
    }
}
/**
 * リクエストボディのバリデーション
 *
 * @param requestBody ExportRequestBody
 * @throws ValidationError バリデーションエラーの場合
 */
function validateRequestBody(requestBody) {
    // フォーマットのバリデーション
    if (!requestBody.format || !['json', 'csv'].includes(requestBody.format)) {
        throw new errors_1.ValidationError(`Invalid format: ${requestBody.format}. Expected 'json' or 'csv'.`);
    }
    // フィルターのバリデーション
    if (!requestBody.filter) {
        throw new errors_1.ValidationError('Filter is required');
    }
    const { filter } = requestBody;
    // 日付フォーマットのバリデーション（YYYY-MM-DD）
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (filter.start_date && !dateRegex.test(filter.start_date)) {
        throw new errors_1.ValidationError(`Invalid start_date format: ${filter.start_date}. Expected YYYY-MM-DD format.`);
    }
    if (filter.end_date && !dateRegex.test(filter.end_date)) {
        throw new errors_1.ValidationError(`Invalid end_date format: ${filter.end_date}. Expected YYYY-MM-DD format.`);
    }
    // 日付の有効性チェック
    if (filter.start_date) {
        const startDate = new Date(filter.start_date);
        if (isNaN(startDate.getTime())) {
            throw new errors_1.ValidationError(`Invalid start_date: ${filter.start_date}. Date does not exist.`);
        }
    }
    if (filter.end_date) {
        const endDate = new Date(filter.end_date);
        if (isNaN(endDate.getTime())) {
            throw new errors_1.ValidationError(`Invalid end_date: ${filter.end_date}. Date does not exist.`);
        }
    }
    // 日付順序チェック
    if (filter.start_date && filter.end_date) {
        const startDate = new Date(filter.start_date);
        const endDate = new Date(filter.end_date);
        if (startDate > endDate) {
            throw new errors_1.ValidationError(`start_date (${filter.start_date}) must be before or equal to end_date (${filter.end_date})`);
        }
    }
    // 企業コードのバリデーション（4桁の数字）
    if (filter.company_code && !/^\d{4}$/.test(filter.company_code)) {
        throw new errors_1.ValidationError(`Invalid company_code format: ${filter.company_code}. Expected 4-digit number.`);
    }
}
/**
 * エラーハンドリング
 *
 * @param error エラーオブジェクト
 * @param requestId リクエストID
 * @returns APIGatewayProxyResult
 */
function handleError(error, requestId) {
    // エラー種別に応じたステータスコードとエラーコード
    let statusCode = 500;
    let errorCode = 'INTERNAL_ERROR';
    if (error instanceof errors_1.ValidationError) {
        statusCode = 400;
        errorCode = 'VALIDATION_ERROR';
    }
    else if (error instanceof errors_1.AuthenticationError) {
        statusCode = 401;
        errorCode = 'UNAUTHORIZED';
    }
    return {
        statusCode,
        headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Headers': 'Content-Type,X-Api-Key',
        },
        body: JSON.stringify({
            status: 'error',
            error: {
                code: errorCode,
                message: error.message,
                details: error.details || {},
            },
            request_id: requestId,
        }),
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGV4cG9ydFxcaGFuZGxlci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7R0FPRzs7QUF1R0gsMEJBZ0dDO0FBcE1ELDRFQUE4RjtBQUM5RiwrQ0FBZ0U7QUFDaEUsdUVBQThFO0FBQzlFLHlDQUFvRTtBQUVwRSwyREFBc0Q7QUFDdEQscURBQWlEO0FBRWpELHVDQUF1QztBQUN2QyxNQUFNLGFBQWEsR0FBRyxJQUFJLDZDQUFvQixDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLGdCQUFnQixFQUFFLENBQUMsQ0FBQztBQUV2RyxvQkFBb0I7QUFDcEIsSUFBSSxZQUFZLEdBQWtCLElBQUksQ0FBQztBQUN2QyxJQUFJLFdBQVcsR0FBVyxDQUFDLENBQUM7QUFFNUI7Ozs7Ozs7O0dBUUc7QUFDSCxLQUFLLFVBQVUsU0FBUztJQUN0QixZQUFZO0lBQ1osSUFBSSxZQUFZLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLFdBQVcsRUFBRSxDQUFDO1FBQzdDLE9BQU8sWUFBWSxDQUFDO0lBQ3RCLENBQUM7SUFFRCwyQkFBMkI7SUFDM0IsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxLQUFLLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUMxRCxZQUFZLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUM7UUFDbkMsV0FBVyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztRQUN6QyxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO0lBRUQsNEJBQTRCO0lBQzVCLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUM7SUFDakQsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2YsTUFBTSxJQUFJ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QUcsZ0JBQWdCLENBQUM7SUFFakMsSUFBSSxLQUFLLFlBQVksd0JBQWUsRUFBRSxDQUFDO1FBQ3JDLFVBQVUsR0FBRyxHQUFHLENBQUM7UUFDakIsU0FBUyxHQUFHLGtCQUFrQixDQUFDO0lBQ2pDLENBQUM7U0FBTSxJQUFJLEtBQUssWUFBWSw0QkFBbUIsRUFBRSxDQUFDO1FBQ2hELFVBQVUsR0FBRyxHQUFHLENBQUM7UUFDakIsU0FBUyxHQUFHLGNBQWMsQ0FBQztJQUM3QixDQUFDO0lBRUQsT0FBTztRQUNMLFVBQVU7UUFDVixPQUFPLEVBQUU7WUFDUCxjQUFjLEVBQUUsa0JBQWtCO1lBQ2xDLDZCQUE2QixFQUFFLEdBQUc7WUFDbEMsOEJBQThCLEVBQUUsd0JBQXdCO1NBQ3pEO1FBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7WUFDbkIsTUFBTSxFQUFFLE9BQU87WUFDZixLQUFLLEVBQUU7Z0JBQ0wsSUFBSSxFQUFFLFNBQVM7Z0JBQ2YsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO2dCQUN0QixPQUFPLEVBQUcsS0FBYSxDQUFDLE9BQU8sSUFBSSxFQUFFO2FBQ3RDO1lBQ0QsVUFBVSxFQUFFLFNBQVM7U0FDdEIsQ0FBQztLQUNILENBQUM7QUFDSixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcdGkxOThcXGludmVzdG1lbnRfYW5hbHlzaXNfb3BvcG9cXHNyY1xcbGFtYmRhXFxleHBvcnRcXGhhbmRsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIExhbWJkYSBFeHBvcnQgSGFuZGxlclxyXG4gKlxyXG4gKiBURG5ldOmWi+ekuuaDheWgseOCkkpTT04vQ1NW5b2i5byP44Gn44Ko44Kv44K544Od44O844OI44GZ44KLTGFtYmRh6Zai5pWw44Gu44Oh44Kk44Oz44OP44Oz44OJ44Op44O844CCXHJcbiAqIEFQSeOCreODvOiqjeiovOOCkuWun+ijheOBl+OAgemdnuWQjOacn+OBp+OCqOOCr+OCueODneODvOODiOWHpueQhuOCkuWun+ihjOOBl+OBvuOBmeOAglxyXG4gKlxyXG4gKiBSZXF1aXJlbWVudHM6IOimgeS7tjUuMSwgNS4yLCA1LjQsIDExLjHvvIjjgqjjgq/jgrnjg53jg7zjg4jjgIHoqo3oqLzvvIlcclxuICovXHJcblxyXG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlSZXN1bHQsIENvbnRleHQgfSBmcm9tICdhd3MtbGFtYmRhJztcclxuaW1wb3J0IHsgU2VjcmV0c01hbmFnZXJDbGllbnQsIEdldFNlY3JldFZhbHVlQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zZWNyZXRzLW1hbmFnZXInO1xyXG5pbXBvcnQgeyBsb2dnZXIsIGNyZWF0ZUVycm9yQ29udGV4dCB9IGZyb20gJy4uLy4uL3V0aWxzL2xvZ2dlcic7XHJcbmltcG9ydCB7IHNlbmRFcnJvck1ldHJpYywgc2VuZE1ldHJpY3MgfSBmcm9tICcuLi8uLi91dGlscy9jbG91ZHdhdGNoLW1ldHJpY3MnO1xyXG5pbXBvcnQgeyBWYWxpZGF0aW9uRXJyb3IsIEF1dGhlbnRpY2F0aW9uRXJyb3IgfSBmcm9tICcuLi8uLi9lcnJvcnMnO1xyXG5pbXBvcnQgeyBFeHBvcnRFdmVudCwgRXhwb3J0UmVxdWVzdEJvZHksIEV4cG9ydFJlc3BvbnNlIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IGNyZWF0ZUV4cG9ydEpvYiB9IGZyb20gJy4vY3JlYXRlLWV4cG9ydC1qb2InO1xyXG5pbXBvcnQgeyBwcm9jZXNzRXhwb3J0IH0gZnJvbSAnLi9wcm9jZXNzLWV4cG9ydCc7XHJcblxyXG4vLyBTZWNyZXRzIE1hbmFnZXLjgq/jg6njgqTjgqLjg7Pjg4jvvIjjgrDjg63jg7zjg5Djg6vjgrnjgrPjg7zjg5fjgafliJ3mnJ/ljJbvvIlcclxuY29uc3Qgc2VjcmV0c0NsaWVudCA9IG5ldyBTZWNyZXRzTWFuYWdlckNsaWVudCh7IHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB8fCAnYXAtbm9ydGhlYXN0LTEnIH0pO1xyXG5cclxuLy8gQVBJ44Kt44O844Kt44Oj44OD44K344Ol77yINeWIhlRUTO+8iVxyXG5sZXQgY2FjaGVkQXBpS2V5OiBzdHJpbmcgfCBudWxsID0gbnVsbDtcclxubGV0IGNhY2hlRXhwaXJ5OiBudW1iZXIgPSAwO1xyXG5cclxuLyoqXHJcbiAqIFNlY3JldHMgTWFuYWdlcuOBi+OCiUFQSeOCreODvOOCkuWPluW+l1xyXG4gKlxyXG4gKiDjg4bjgrnjg4jnkrDlooPvvIhURVNUX0VOVj1lMmXvvInjgafjga/jgIFBUElfS0VZ55Kw5aKD5aSJ5pWw44GL44KJ55u05o6l5Y+W5b6X44GX44G+44GZ44CCXHJcbiAqIOacrOeVqueSsOWig+OBp+OBr+OAgVNlY3JldHMgTWFuYWdlcuOBi+OCieWPluW+l+OBl+OBvuOBmeOAglxyXG4gKlxyXG4gKiBAcmV0dXJucyBBUEnjgq3jg7xcclxuICogQHRocm93cyBFcnJvciBTZWNyZXRzIE1hbmFnZXLjgYvjgonjga7lj5blvpfjgavlpLHmlZfjgZfjgZ/loLTlkIhcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIGdldEFwaUtleSgpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gIC8vIOOCreODo+ODg+OCt+ODpeODgeOCp+ODg+OCr1xyXG4gIGlmIChjYWNoZWRBcGlLZXkgJiYgRGF0ZS5ub3coKSA8IGNhY2hlRXhwaXJ5KSB7XHJcbiAgICByZXR1cm4gY2FjaGVkQXBpS2V5O1xyXG4gIH1cclxuXHJcbiAgLy8g44OG44K544OI55Kw5aKDOiBBUElfS0VZ55Kw5aKD5aSJ5pWw44GL44KJ55u05o6l5Y+W5b6XXHJcbiAgaWYgKHByb2Nlc3MuZW52LlRFU1RfRU5WID09PSAnZTJlJyAmJiBwcm9jZXNzLmVudi5BUElfS0VZKSB7XHJcbiAgICBjYWNoZWRBcGlLZXkgPSBwcm9jZXNzLmVudi5BUElfS0VZO1xyXG4gICAgY2FjaGVFeHBpcnkgPSBEYXRlLm5vdygpICsgNSAqIDYwICogMTAwMDtcclxuICAgIHJldHVybiBjYWNoZWRBcGlLZXk7XHJcbiAgfVxyXG5cclxuICAvLyDmnKznlarnkrDlooM6IFNlY3JldHMgTWFuYWdlcuOBi+OCieWPluW+l1xyXG4gIGNvbnN0IHNlY3JldEFybiA9IHByb2Nlc3MuZW52LkFQSV9LRVlfU0VDUkVUX0FSTjtcclxuICBpZiAoIXNlY3JldEFybikge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdBUElfS0VZX1NFQ1JFVF9BUk4gZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgbm90IHNldCcpO1xyXG4gIH1cclxuXHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0U2VjcmV0VmFsdWVDb21tYW5kKHsgU2VjcmV0SWQ6IHNlY3JldEFybiB9KTtcclxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgc2VjcmV0c0NsaWVudC5zZW5kKGNvbW1hbmQpO1xyXG5cclxuICAgIGlmICghcmVzcG9uc2UuU2VjcmV0U3RyaW5nKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignU2VjcmV0IHZhbHVlIGlzIGVtcHR5Jyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQVBJ44Kt44O844KS44Kt44Oj44OD44K344Ol77yINeWIhlRUTO+8iVxyXG4gICAgY2FjaGVkQXBpS2V5ID0gcmVzcG9uc2UuU2VjcmV0U3RyaW5nO1xyXG4gICAgY2FjaGVFeHBpcnkgPSBEYXRlLm5vdygpICsgNSAqIDYwICogMTAwMDtcclxuXHJcbiAgICByZXR1cm4gY2FjaGVkQXBpS2V5O1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSBBUEkga2V5IGZyb20gU2VjcmV0cyBNYW5hZ2VyJywge1xyXG4gICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxyXG4gICAgICBzZWNyZXRfYXJuOiBzZWNyZXRBcm4sXHJcbiAgICB9KTtcclxuICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIEFQSSBrZXknKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBMYW1iZGEgRXhwb3J044OP44Oz44OJ44Op44O8XHJcbiAqXHJcbiAqIEBwYXJhbSBldmVudCBFeHBvcnRFdmVudO+8iEFQSSBHYXRld2F557WM55Sx77yJXHJcbiAqIEBwYXJhbSBjb250ZXh0IExhbWJkYSBDb250ZXh0XHJcbiAqIEByZXR1cm5zIEFQSUdhdGV3YXlQcm94eVJlc3VsdFxyXG4gKlxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGB0eXBlc2NyaXB0XHJcbiAqIC8vIEpTT07lvaLlvI/jgafjgqjjgq/jgrnjg53jg7zjg4hcclxuICogY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBoYW5kbGVyKHtcclxuICogICBoZWFkZXJzOiB7ICd4LWFwaS1rZXknOiAneW91ci1hcGkta2V5JyB9LFxyXG4gKiAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcclxuICogICAgIGZvcm1hdDogJ2pzb24nLFxyXG4gKiAgICAgZmlsdGVyOiB7XHJcbiAqICAgICAgIHN0YXJ0X2RhdGU6ICcyMDI0LTAxLTE1JyxcclxuICogICAgICAgZW5kX2RhdGU6ICcyMDI0LTAxLTIwJyxcclxuICogICAgIH0sXHJcbiAqICAgfSksXHJcbiAqIH0sIGNvbnRleHQpO1xyXG4gKlxyXG4gKiAvLyBDU1blvaLlvI/jgafjgqjjgq/jgrnjg53jg7zjg4hcclxuICogY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBoYW5kbGVyKHtcclxuICogICBoZWFkZXJzOiB7ICd4LWFwaS1rZXknOiAneW91ci1hcGkta2V5JyB9LFxyXG4gKiAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcclxuICogICAgIGZvcm1hdDogJ2NzdicsXHJcbiAqICAgICBmaWx0ZXI6IHtcclxuICogICAgICAgY29tcGFueV9jb2RlOiAnMTIzNCcsXHJcbiAqICAgICAgIHN0YXJ0X2RhdGU6ICcyMDI0LTAxLTAxJyxcclxuICogICAgICAgZW5kX2RhdGU6ICcyMDI0LTAxLTMxJyxcclxuICogICAgIH0sXHJcbiAqICAgfSksXHJcbiAqIH0sIGNvbnRleHQpO1xyXG4gKiBgYGBcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVyKFxyXG4gIGV2ZW50OiBFeHBvcnRFdmVudCxcclxuICBjb250ZXh0OiBDb250ZXh0XHJcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XHJcbiAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcclxuXHJcbiAgdHJ5IHtcclxuICAgIGxvZ2dlci5pbmZvKCdMYW1iZGEgRXhwb3J0IHN0YXJ0ZWQnLCB7XHJcbiAgICAgIHJlcXVlc3RfaWQ6IGNvbnRleHQuYXdzUmVxdWVzdElkLFxyXG4gICAgICBmdW5jdGlvbl9uYW1lOiBjb250ZXh0LmZ1bmN0aW9uTmFtZSxcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIEFQSeOCreODvOiqjeiovFxyXG4gICAgYXdhaXQgdmFsaWRhdGVBcGlLZXkoZXZlbnQpO1xyXG5cclxuICAgIC8vIOODquOCr+OCqOOCueODiOODnOODh+OCo+OBruODkeODvOOCuVxyXG4gICAgY29uc3QgcmVxdWVzdEJvZHkgPSBwYXJzZVJlcXVlc3RCb2R5KGV2ZW50LmJvZHkpO1xyXG5cclxuICAgIC8vIOODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gICAgdmFsaWRhdGVSZXF1ZXN0Qm9keShyZXF1ZXN0Qm9keSk7XHJcblxyXG4gICAgLy8g44Ko44Kv44K544Od44O844OI44K444On44OW44KS5L2c5oiQXHJcbiAgICBjb25zdCBleHBvcnRKb2IgPSBhd2FpdCBjcmVhdGVFeHBvcnRKb2IocmVxdWVzdEJvZHksIGNvbnRleHQuYXdzUmVxdWVzdElkKTtcclxuXHJcbiAgICAvLyDpnZ7lkIzmnJ/jgafjgqjjgq/jgrnjg53jg7zjg4jlh6bnkIbjgpLplovlp4vvvIhhd2FpdCDjgZfjgarjgYTvvIlcclxuICAgIHByb2Nlc3NFeHBvcnQoZXhwb3J0Sm9iLmV4cG9ydF9pZCwgcmVxdWVzdEJvZHkpXHJcbiAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcclxuICAgICAgICBsb2dnZXIuZXJyb3IoXHJcbiAgICAgICAgICAnRXhwb3J0IHByb2Nlc3NpbmcgZmFpbGVkJyxcclxuICAgICAgICAgIGNyZWF0ZUVycm9yQ29udGV4dChlcnJvciBhcyBFcnJvciwge1xyXG4gICAgICAgICAgICBleHBvcnRfaWQ6IGV4cG9ydEpvYi5leHBvcnRfaWQsXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcclxuXHJcbiAgICBsb2dnZXIuaW5mbygnTGFtYmRhIEV4cG9ydCBjb21wbGV0ZWQnLCB7XHJcbiAgICAgIGV4cG9ydF9pZDogZXhwb3J0Sm9iLmV4cG9ydF9pZCxcclxuICAgICAgc3RhdHVzOiBleHBvcnRKb2Iuc3RhdHVzLFxyXG4gICAgICBkdXJhdGlvbl9tczogZHVyYXRpb24sXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyDmiJDlip/jg6Hjg4jjg6rjgq/jgrnpgIHkv6FcclxuICAgIGF3YWl0IHNlbmRNZXRyaWNzKFtcclxuICAgICAge1xyXG4gICAgICAgIG5hbWU6ICdMYW1iZGFFeGVjdXRpb25UaW1lJyxcclxuICAgICAgICB2YWx1ZTogZHVyYXRpb24sXHJcbiAgICAgICAgdW5pdDogJ01pbGxpc2Vjb25kcycsXHJcbiAgICAgICAgZGltZW5zaW9uczogeyBGdW5jdGlvbk5hbWU6ICdFeHBvcnQnIH0sXHJcbiAgICAgIH0sXHJcbiAgICAgIHtcclxuICAgICAgICBuYW1lOiAnRXhwb3J0Sm9ic0NyZWF0ZWQnLFxyXG4gICAgICAgIHZhbHVlOiAxLFxyXG4gICAgICAgIHVuaXQ6ICdDb3VudCcsXHJcbiAgICAgICAgZGltZW5zaW9uczogeyBGb3JtYXQ6IHJlcXVlc3RCb2R5LmZvcm1hdCB9LFxyXG4gICAgICB9LFxyXG4gICAgXSk7XHJcblxyXG4gICAgLy8g44Os44K544Od44Oz44K5XHJcbiAgICBjb25zdCByZXNwb25zZTogRXhwb3J0UmVzcG9uc2UgPSB7XHJcbiAgICAgIGV4cG9ydF9pZDogZXhwb3J0Sm9iLmV4cG9ydF9pZCxcclxuICAgICAgc3RhdHVzOiBleHBvcnRKb2Iuc3RhdHVzLFxyXG4gICAgICBtZXNzYWdlOiAnRXhwb3J0IGpvYiBjcmVhdGVkIHN1Y2Nlc3NmdWxseScsXHJcbiAgICAgIHByb2dyZXNzOiBleHBvcnRKb2IucHJvZ3Jlc3MsXHJcbiAgICB9O1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIHN0YXR1c0NvZGU6IDIwMiwgLy8gQWNjZXB0ZWRcclxuICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6ICdDb250ZW50LVR5cGUsWC1BcGktS2V5JyxcclxuICAgICAgfSxcclxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpLFxyXG4gICAgfTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xyXG5cclxuICAgIGxvZ2dlci5lcnJvcihcclxuICAgICAgJ0xhbWJkYSBFeHBvcnQgZmFpbGVkJyxcclxuICAgICAgY3JlYXRlRXJyb3JDb250ZXh0KGVycm9yIGFzIEVycm9yLCB7XHJcbiAgICAgICAgcmVxdWVzdF9pZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXHJcbiAgICAgICAgZHVyYXRpb25fbXM6IGR1cmF0aW9uLFxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICAvLyDjgqjjg6njg7zjg6Hjg4jjg6rjgq/jgrnpgIHkv6FcclxuICAgIGF3YWl0IHNlbmRFcnJvck1ldHJpYyhcclxuICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLmNvbnN0cnVjdG9yLm5hbWUgOiAnVW5rbm93bicsXHJcbiAgICAgICdFeHBvcnQnXHJcbiAgICApO1xyXG5cclxuICAgIC8vIOOCqOODqeODvOODrOOCueODneODs+OCuVxyXG4gICAgcmV0dXJuIGhhbmRsZUVycm9yKGVycm9yIGFzIEVycm9yLCBjb250ZXh0LmF3c1JlcXVlc3RJZCk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogQVBJ44Kt44O86KqN6Ki8XHJcbiAqXHJcbiAqIEBwYXJhbSBldmVudCBFeHBvcnRFdmVudFxyXG4gKiBAdGhyb3dzIEF1dGhlbnRpY2F0aW9uRXJyb3IgQVBJ44Kt44O844GM54Sh5Yq544Gq5aC05ZCIXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiB2YWxpZGF0ZUFwaUtleShldmVudDogRXhwb3J0RXZlbnQpOiBQcm9taXNlPHZvaWQ+IHtcclxuICBjb25zdCBhcGlLZXkgPSBldmVudC5oZWFkZXJzPy5bJ3gtYXBpLWtleSddIHx8IGV2ZW50LmhlYWRlcnM/LlsnWC1BcGktS2V5J107XHJcblxyXG4gIGlmICghYXBpS2V5KSB7XHJcbiAgICB0aHJvdyBuZXcgQXV0aGVudGljYXRpb25FcnJvcignQVBJIGtleSBpcyByZXF1aXJlZCcpO1xyXG4gIH1cclxuXHJcbiAgLy8gU2VjcmV0cyBNYW5hZ2Vy44GL44KJQVBJ44Kt44O844KS5Y+W5b6XXHJcbiAgY29uc3QgdmFsaWRBcGlLZXkgPSBhd2FpdCBnZXRBcGlLZXkoKTtcclxuXHJcbiAgaWYgKGFwaUtleSAhPT0gdmFsaWRBcGlLZXkpIHtcclxuICAgIHRocm93IG5ldyBBdXRoZW50aWNhdGlvbkVycm9yKCdJbnZhbGlkIEFQSSBrZXknKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjg6rjgq/jgqjjgrnjg4jjg5zjg4fjgqPjga7jg5Hjg7zjgrlcclxuICpcclxuICogQHBhcmFtIGJvZHkg44Oq44Kv44Ko44K544OI44Oc44OH44Kj77yISlNPTuaWh+Wtl+WIl++8iVxyXG4gKiBAcmV0dXJucyBFeHBvcnRSZXF1ZXN0Qm9keVxyXG4gKiBAdGhyb3dzIFZhbGlkYXRpb25FcnJvciDjg5Hjg7zjgrnjgqjjg6njg7zjga7loLTlkIhcclxuICovXHJcbmZ1bmN0aW9uIHBhcnNlUmVxdWVzdEJvZHkoYm9keTogc3RyaW5nKTogRXhwb3J0UmVxdWVzdEJvZHkge1xyXG4gIGlmICghYm9keSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignUmVxdWVzdCBib2R5IGlzIHJlcXVpcmVkJyk7XHJcbiAgfVxyXG5cclxuICB0cnkge1xyXG4gICAgcmV0dXJuIEpTT04ucGFyc2UoYm9keSkgYXMgRXhwb3J0UmVxdWVzdEJvZHk7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ0ludmFsaWQgSlNPTiBmb3JtYXQgaW4gcmVxdWVzdCBib2R5Jywge1xyXG4gICAgICBib2R5LFxyXG4gICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxyXG4gICAgfSk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog44Oq44Kv44Ko44K544OI44Oc44OH44Kj44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAqXHJcbiAqIEBwYXJhbSByZXF1ZXN0Qm9keSBFeHBvcnRSZXF1ZXN0Qm9keVxyXG4gKiBAdGhyb3dzIFZhbGlkYXRpb25FcnJvciDjg5Djg6rjg4fjg7zjgrfjg6fjg7Pjgqjjg6njg7zjga7loLTlkIhcclxuICovXHJcbmZ1bmN0aW9uIHZhbGlkYXRlUmVxdWVzdEJvZHkocmVxdWVzdEJvZHk6IEV4cG9ydFJlcXVlc3RCb2R5KTogdm9pZCB7XHJcbiAgLy8g44OV44Kp44O844Oe44OD44OI44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAgaWYgKCFyZXF1ZXN0Qm9keS5mb3JtYXQgfHwgIVsnanNvbicsICdjc3YnXS5pbmNsdWRlcyhyZXF1ZXN0Qm9keS5mb3JtYXQpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCBmb3JtYXQ6ICR7cmVxdWVzdEJvZHkuZm9ybWF0fS4gRXhwZWN0ZWQgJ2pzb24nIG9yICdjc3YnLmBcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvLyDjg5XjgqPjg6vjgr/jg7zjga7jg5Djg6rjg4fjg7zjgrfjg6fjg7NcclxuICBpZiAoIXJlcXVlc3RCb2R5LmZpbHRlcikge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignRmlsdGVyIGlzIHJlcXVpcmVkJyk7XHJcbiAgfVxyXG5cclxuICBjb25zdCB7IGZpbHRlciB9ID0gcmVxdWVzdEJvZHk7XHJcblxyXG4gIC8vIOaXpeS7mOODleOCqeODvOODnuODg+ODiOOBruODkOODquODh+ODvOOCt+ODp+ODs++8iFlZWVktTU0tRETvvIlcclxuICBjb25zdCBkYXRlUmVnZXggPSAvXlxcZHs0fS1cXGR7Mn0tXFxkezJ9JC87XHJcblxyXG4gIGlmIChmaWx0ZXIuc3RhcnRfZGF0ZSAmJiAhZGF0ZVJlZ2V4LnRlc3QoZmlsdGVyLnN0YXJ0X2RhdGUpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCBzdGFydF9kYXRlIGZvcm1hdDogJHtmaWx0ZXIuc3RhcnRfZGF0ZX0uIEV4cGVjdGVkIFlZWVktTU0tREQgZm9ybWF0LmBcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBpZiAoZmlsdGVyLmVuZF9kYXRlICYmICFkYXRlUmVnZXgudGVzdChmaWx0ZXIuZW5kX2RhdGUpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCBlbmRfZGF0ZSBmb3JtYXQ6ICR7ZmlsdGVyLmVuZF9kYXRlfS4gRXhwZWN0ZWQgWVlZWS1NTS1ERCBmb3JtYXQuYFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIOaXpeS7mOOBruacieWKueaAp+ODgeOCp+ODg+OCr1xyXG4gIGlmIChmaWx0ZXIuc3RhcnRfZGF0ZSkge1xyXG4gICAgY29uc3Qgc3RhcnREYXRlID0gbmV3IERhdGUoZmlsdGVyLnN0YXJ0X2RhdGUpO1xyXG4gICAgaWYgKGlzTmFOKHN0YXJ0RGF0ZS5nZXRUaW1lKCkpKSB7XHJcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgICAgYEludmFsaWQgc3RhcnRfZGF0ZTogJHtmaWx0ZXIuc3RhcnRfZGF0ZX0uIERhdGUgZG9lcyBub3QgZXhpc3QuYFxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaWYgKGZpbHRlci5lbmRfZGF0ZSkge1xyXG4gICAgY29uc3QgZW5kRGF0ZSA9IG5ldyBEYXRlKGZpbHRlci5lbmRfZGF0ZSk7XHJcbiAgICBpZiAoaXNOYU4oZW5kRGF0ZS5nZXRUaW1lKCkpKSB7XHJcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgICAgYEludmFsaWQgZW5kX2RhdGU6ICR7ZmlsdGVyLmVuZF9kYXRlfS4gRGF0ZSBkb2VzIG5vdCBleGlzdC5gXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDml6Xku5jpoIbluo/jg4Hjgqfjg4Pjgq9cclxuICBpZiAoZmlsdGVyLnN0YXJ0X2RhdGUgJiYgZmlsdGVyLmVuZF9kYXRlKSB7XHJcbiAgICBjb25zdCBzdGFydERhdGUgPSBuZXcgRGF0ZShmaWx0ZXIuc3RhcnRfZGF0ZSk7XHJcbiAgICBjb25zdCBlbmREYXRlID0gbmV3IERhdGUoZmlsdGVyLmVuZF9kYXRlKTtcclxuXHJcbiAgICBpZiAoc3RhcnREYXRlID4gZW5kRGF0ZSkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICAgIGBzdGFydF9kYXRlICgke2ZpbHRlci5zdGFydF9kYXRlfSkgbXVzdCBiZSBiZWZvcmUgb3IgZXF1YWwgdG8gZW5kX2RhdGUgKCR7ZmlsdGVyLmVuZF9kYXRlfSlgXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDkvIHmpa3jgrPjg7zjg4njga7jg5Djg6rjg4fjg7zjgrfjg6fjg7PvvIg05qGB44Gu5pWw5a2X77yJXHJcbiAgaWYgKGZpbHRlci5jb21wYW55X2NvZGUgJiYgIS9eXFxkezR9JC8udGVzdChmaWx0ZXIuY29tcGFueV9jb2RlKSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEludmFsaWQgY29tcGFueV9jb2RlIGZvcm1hdDogJHtmaWx0ZXIuY29tcGFueV9jb2RlfS4gRXhwZWN0ZWQgNC1kaWdpdCBudW1iZXIuYFxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgqjjg6njg7zjg4/jg7Pjg4njg6rjg7PjgrBcclxuICpcclxuICogQHBhcmFtIGVycm9yIOOCqOODqeODvOOCquODluOCuOOCp+OCr+ODiFxyXG4gKiBAcGFyYW0gcmVxdWVzdElkIOODquOCr+OCqOOCueODiElEXHJcbiAqIEByZXR1cm5zIEFQSUdhdGV3YXlQcm94eVJlc3VsdFxyXG4gKi9cclxuZnVuY3Rpb24gaGFuZGxlRXJyb3IoZXJyb3I6IEVycm9yLCByZXF1ZXN0SWQ6IHN0cmluZyk6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCB7XHJcbiAgLy8g44Ko44Op44O856iu5Yil44Gr5b+c44GY44Gf44K544OG44O844K/44K544Kz44O844OJ44Go44Ko44Op44O844Kz44O844OJXHJcbiAgbGV0IHN0YXR1c0NvZGUgPSA1MDA7XHJcbiAgbGV0IGVycm9yQ29kZSA9ICdJTlRFUk5BTF9FUlJPUic7XHJcblxyXG4gIGlmIChlcnJvciBpbnN0YW5jZW9mIFZhbGlkYXRpb25FcnJvcikge1xyXG4gICAgc3RhdHVzQ29kZSA9IDQwMDtcclxuICAgIGVycm9yQ29kZSA9ICdWQUxJREFUSU9OX0VSUk9SJztcclxuICB9IGVsc2UgaWYgKGVycm9yIGluc3RhbmNlb2YgQXV0aGVudGljYXRpb25FcnJvcikge1xyXG4gICAgc3RhdHVzQ29kZSA9IDQwMTtcclxuICAgIGVycm9yQ29kZSA9ICdVTkFVVEhPUklaRUQnO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIHN0YXR1c0NvZGUsXHJcbiAgICBoZWFkZXJzOiB7XHJcbiAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXHJcbiAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxYLUFwaS1LZXknLFxyXG4gICAgfSxcclxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgc3RhdHVzOiAnZXJyb3InLFxyXG4gICAgICBlcnJvcjoge1xyXG4gICAgICAgIGNvZGU6IGVycm9yQ29kZSxcclxuICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxyXG4gICAgICAgIGRldGFpbHM6IChlcnJvciBhcyBhbnkpLmRldGFpbHMgfHwge30sXHJcbiAgICAgIH0sXHJcbiAgICAgIHJlcXVlc3RfaWQ6IHJlcXVlc3RJZCxcclxuICAgIH0pLFxyXG4gIH07XHJcbn1cclxuIl0sInZlcnNpb24iOjN9