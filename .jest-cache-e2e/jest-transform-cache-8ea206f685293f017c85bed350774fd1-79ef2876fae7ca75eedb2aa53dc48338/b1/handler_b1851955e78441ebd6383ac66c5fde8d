1d8427aebab31d12db34e8fd3edd7343
"use strict";
/**
 * Lambda Export Handler
 *
 * TDnet開示情報をJSON/CSV形式でエクスポートするLambda関数のメインハンドラー。
 * APIキー認証を実装し、非同期でエクスポート処理を実行します。
 *
 * Requirements: 要件5.1, 5.2, 5.4, 11.1（エクスポート、認証）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const logger_1 = require("../../utils/logger");
const cloudwatch_metrics_1 = require("../../utils/cloudwatch-metrics");
const errors_1 = require("../../errors");
const create_export_job_1 = require("./create-export-job");
const process_export_1 = require("./process-export");
/**
 * Lambda Exportハンドラー
 *
 * @param event ExportEvent（API Gateway経由）
 * @param context Lambda Context
 * @returns APIGatewayProxyResult
 *
 * @example
 * ```typescript
 * // JSON形式でエクスポート
 * const response = await handler({
 *   headers: { 'x-api-key': 'your-api-key' },
 *   body: JSON.stringify({
 *     format: 'json',
 *     filter: {
 *       start_date: '2024-01-15',
 *       end_date: '2024-01-20',
 *     },
 *   }),
 * }, context);
 *
 * // CSV形式でエクスポート
 * const response = await handler({
 *   headers: { 'x-api-key': 'your-api-key' },
 *   body: JSON.stringify({
 *     format: 'csv',
 *     filter: {
 *       company_code: '1234',
 *       start_date: '2024-01-01',
 *       end_date: '2024-01-31',
 *     },
 *   }),
 * }, context);
 * ```
 */
async function handler(event, context) {
    const startTime = Date.now();
    try {
        logger_1.logger.info('Lambda Export started', {
            request_id: context.awsRequestId,
            function_name: context.functionName,
        });
        // APIキー認証
        validateApiKey(event);
        // リクエストボディのパース
        const requestBody = parseRequestBody(event.body);
        // バリデーション
        validateRequestBody(requestBody);
        // エクスポートジョブを作成
        const exportJob = await (0, create_export_job_1.createExportJob)(requestBody, context.awsRequestId);
        // 非同期でエクスポート処理を開始（await しない）
        (0, process_export_1.processExport)(exportJob.export_id, requestBody)
            .catch((error) => {
            logger_1.logger.error('Export processing failed', (0, logger_1.createErrorContext)(error, {
                export_id: exportJob.export_id,
            }));
        });
        const duration = Date.now() - startTime;
        logger_1.logger.info('Lambda Export completed', {
            export_id: exportJob.export_id,
            status: exportJob.status,
            duration_ms: duration,
        });
        // 成功メトリクス送信
        await (0, cloudwatch_metrics_1.sendMetrics)([
            {
                name: 'LambdaExecutionTime',
                value: duration,
                unit: 'Milliseconds',
                dimensions: { FunctionName: 'Export' },
            },
            {
                name: 'ExportJobsCreated',
                value: 1,
                unit: 'Count',
                dimensions: { Format: requestBody.format },
            },
        ]);
        // レスポンス
        const response = {
            export_id: exportJob.export_id,
            status: exportJob.status,
            message: 'Export job created successfully',
            progress: exportJob.progress,
        };
        return {
            statusCode: 202, // Accepted
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Headers': 'Content-Type,X-Api-Key',
            },
            body: JSON.stringify(response),
        };
    }
    catch (error) {
        const duration = Date.now() - startTime;
        logger_1.logger.error('Lambda Export failed', (0, logger_1.createErrorContext)(error, {
            request_id: context.awsRequestId,
            duration_ms: duration,
        }));
        // エラーメトリクス送信
        await (0, cloudwatch_metrics_1.sendErrorMetric)(error instanceof Error ? error.constructor.name : 'Unknown', 'Export');
        // エラーレスポンス
        return handleError(error, context.awsRequestId);
    }
}
/**
 * APIキー認証
 *
 * @param event ExportEvent
 * @throws AuthenticationError APIキーが無効な場合
 */
function validateApiKey(event) {
    const apiKey = event.headers?.['x-api-key'] || event.headers?.['X-Api-Key'];
    if (!apiKey) {
        throw new errors_1.AuthenticationError('API key is required');
    }
    // 環境変数からAPIキーを取得
    const validApiKey = process.env.API_KEY;
    if (!validApiKey) {
        throw new Error('API_KEY environment variable is not set');
    }
    if (apiKey !== validApiKey) {
        throw new errors_1.AuthenticationError('Invalid API key');
    }
}
/**
 * リクエストボディのパース
 *
 * @param body リクエストボディ（JSON文字列）
 * @returns ExportRequestBody
 * @throws ValidationError パースエラーの場合
 */
function parseRequestBody(body) {
    if (!body) {
        throw new errors_1.ValidationError('Request body is required');
    }
    try {
        return JSON.parse(body);
    }
    catch (error) {
        throw new errors_1.ValidationError('Invalid JSON format in request body', {
            body,
            error: error instanceof Error ? error.message : String(error),
        });
    }
}
/**
 * リクエストボディのバリデーション
 *
 * @param requestBody ExportRequestBody
 * @throws ValidationError バリデーションエラーの場合
 */
function validateRequestBody(requestBody) {
    // フォーマットのバリデーション
    if (!requestBody.format || !['json', 'csv'].includes(requestBody.format)) {
        throw new errors_1.ValidationError(`Invalid format: ${requestBody.format}. Expected 'json' or 'csv'.`);
    }
    // フィルターのバリデーション
    if (!requestBody.filter) {
        throw new errors_1.ValidationError('Filter is required');
    }
    const { filter } = requestBody;
    // 日付フォーマットのバリデーション（YYYY-MM-DD）
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (filter.start_date && !dateRegex.test(filter.start_date)) {
        throw new errors_1.ValidationError(`Invalid start_date format: ${filter.start_date}. Expected YYYY-MM-DD format.`);
    }
    if (filter.end_date && !dateRegex.test(filter.end_date)) {
        throw new errors_1.ValidationError(`Invalid end_date format: ${filter.end_date}. Expected YYYY-MM-DD format.`);
    }
    // 日付の有効性チェック
    if (filter.start_date) {
        const startDate = new Date(filter.start_date);
        if (isNaN(startDate.getTime())) {
            throw new errors_1.ValidationError(`Invalid start_date: ${filter.start_date}. Date does not exist.`);
        }
    }
    if (filter.end_date) {
        const endDate = new Date(filter.end_date);
        if (isNaN(endDate.getTime())) {
            throw new errors_1.ValidationError(`Invalid end_date: ${filter.end_date}. Date does not exist.`);
        }
    }
    // 日付順序チェック
    if (filter.start_date && filter.end_date) {
        const startDate = new Date(filter.start_date);
        const endDate = new Date(filter.end_date);
        if (startDate > endDate) {
            throw new errors_1.ValidationError(`start_date (${filter.start_date}) must be before or equal to end_date (${filter.end_date})`);
        }
    }
    // 企業コードのバリデーション（4桁の数字）
    if (filter.company_code && !/^\d{4}$/.test(filter.company_code)) {
        throw new errors_1.ValidationError(`Invalid company_code format: ${filter.company_code}. Expected 4-digit number.`);
    }
}
/**
 * エラーハンドリング
 *
 * @param error エラーオブジェクト
 * @param requestId リクエストID
 * @returns APIGatewayProxyResult
 */
function handleError(error, requestId) {
    // エラー種別に応じたステータスコードとエラーコード
    let statusCode = 500;
    let errorCode = 'INTERNAL_ERROR';
    if (error instanceof errors_1.ValidationError) {
        statusCode = 400;
        errorCode = 'VALIDATION_ERROR';
    }
    else if (error instanceof errors_1.AuthenticationError) {
        statusCode = 401;
        errorCode = 'UNAUTHORIZED';
    }
    return {
        statusCode,
        headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Headers': 'Content-Type,X-Api-Key',
        },
        body: JSON.stringify({
            status: 'error',
            error: {
                code: errorCode,
                message: error.message,
                details: error.details || {},
            },
            request_id: requestId,
        }),
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGV4cG9ydFxcaGFuZGxlci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7R0FPRzs7QUE2Q0gsMEJBZ0dDO0FBMUlELCtDQUFnRTtBQUNoRSx1RUFBOEU7QUFDOUUseUNBQW9FO0FBRXBFLDJEQUFzRDtBQUN0RCxxREFBaUQ7QUFFakQ7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FrQ0c7QUFDSSxLQUFLLFVBQVUsT0FBTyxDQUMzQixLQUFrQixFQUNsQixPQUFnQjtJQUVoQixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFFN0IsSUFBSSxDQUFDO1FBQ0gsZUFBTSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRTtZQUNuQyxVQUFVLEVBQUUsT0FBTyxDQUFDLFlBQVk7WUFDaEMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxZQUFZO1NBQ3BDLENBQUMsQ0FBQztRQUVILFVBQVU7UUFDVixjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFdEIsZUFBZTtRQUNmLE1BQU0sV0FBVyxHQUFHLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVqRCxVQUFVO1FBQ1YsbUJBQW1CLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFakMsZUFBZTtRQUNmLE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBQSxtQ0FBZSxFQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFM0UsNkJBQTZCO1FBQzdCLElBQUEsOEJBQWEsRUFBQyxTQUFTLENBQUMsU0FBUyxFQUFFLFdBQVcsQ0FBQzthQUM1QyxLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUNmLGVBQU0sQ0FBQyxLQUFLLENBQ1YsMEJBQTBCLEVBQzFCLElBQUEsMkJBQWtCLEVBQUMsS0FBYyxFQUFFO2dCQUNqQyxTQUFTLEVBQUUsU0FBUyxDQUFDLFNBQVM7YUFD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QUFFLFNBQVM7Z0JBQ2YsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO2dCQUN0QixPQUFPLEVBQUcsS0FBYSxDQUFDLE9BQU8sSUFBSSxFQUFFO2FBQ3RDO1lBQ0QsVUFBVSxFQUFFLFNBQVM7U0FDdEIsQ0FBQztLQUNILENBQUM7QUFDSixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcdGkxOThcXGludmVzdG1lbnRfYW5hbHlzaXNfb3BvcG9cXHNyY1xcbGFtYmRhXFxleHBvcnRcXGhhbmRsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIExhbWJkYSBFeHBvcnQgSGFuZGxlclxyXG4gKlxyXG4gKiBURG5ldOmWi+ekuuaDheWgseOCkkpTT04vQ1NW5b2i5byP44Gn44Ko44Kv44K544Od44O844OI44GZ44KLTGFtYmRh6Zai5pWw44Gu44Oh44Kk44Oz44OP44Oz44OJ44Op44O844CCXHJcbiAqIEFQSeOCreODvOiqjeiovOOCkuWun+ijheOBl+OAgemdnuWQjOacn+OBp+OCqOOCr+OCueODneODvOODiOWHpueQhuOCkuWun+ihjOOBl+OBvuOBmeOAglxyXG4gKlxyXG4gKiBSZXF1aXJlbWVudHM6IOimgeS7tjUuMSwgNS4yLCA1LjQsIDExLjHvvIjjgqjjgq/jgrnjg53jg7zjg4jjgIHoqo3oqLzvvIlcclxuICovXHJcblxyXG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlSZXN1bHQsIENvbnRleHQgfSBmcm9tICdhd3MtbGFtYmRhJztcclxuaW1wb3J0IHsgbG9nZ2VyLCBjcmVhdGVFcnJvckNvbnRleHQgfSBmcm9tICcuLi8uLi91dGlscy9sb2dnZXInO1xyXG5pbXBvcnQgeyBzZW5kRXJyb3JNZXRyaWMsIHNlbmRNZXRyaWNzIH0gZnJvbSAnLi4vLi4vdXRpbHMvY2xvdWR3YXRjaC1tZXRyaWNzJztcclxuaW1wb3J0IHsgVmFsaWRhdGlvbkVycm9yLCBBdXRoZW50aWNhdGlvbkVycm9yIH0gZnJvbSAnLi4vLi4vZXJyb3JzJztcclxuaW1wb3J0IHsgRXhwb3J0RXZlbnQsIEV4cG9ydFJlcXVlc3RCb2R5LCBFeHBvcnRSZXNwb25zZSB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBjcmVhdGVFeHBvcnRKb2IgfSBmcm9tICcuL2NyZWF0ZS1leHBvcnQtam9iJztcclxuaW1wb3J0IHsgcHJvY2Vzc0V4cG9ydCB9IGZyb20gJy4vcHJvY2Vzcy1leHBvcnQnO1xyXG5cclxuLyoqXHJcbiAqIExhbWJkYSBFeHBvcnTjg4/jg7Pjg4njg6njg7xcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEV4cG9ydEV2ZW5077yIQVBJIEdhdGV3YXnntYznlLHvvIlcclxuICogQHBhcmFtIGNvbnRleHQgTGFtYmRhIENvbnRleHRcclxuICogQHJldHVybnMgQVBJR2F0ZXdheVByb3h5UmVzdWx0XHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYHR5cGVzY3JpcHRcclxuICogLy8gSlNPTuW9ouW8j+OBp+OCqOOCr+OCueODneODvOODiFxyXG4gKiBjb25zdCByZXNwb25zZSA9IGF3YWl0IGhhbmRsZXIoe1xyXG4gKiAgIGhlYWRlcnM6IHsgJ3gtYXBpLWtleSc6ICd5b3VyLWFwaS1rZXknIH0sXHJcbiAqICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xyXG4gKiAgICAgZm9ybWF0OiAnanNvbicsXHJcbiAqICAgICBmaWx0ZXI6IHtcclxuICogICAgICAgc3RhcnRfZGF0ZTogJzIwMjQtMDEtMTUnLFxyXG4gKiAgICAgICBlbmRfZGF0ZTogJzIwMjQtMDEtMjAnLFxyXG4gKiAgICAgfSxcclxuICogICB9KSxcclxuICogfSwgY29udGV4dCk7XHJcbiAqXHJcbiAqIC8vIENTVuW9ouW8j+OBp+OCqOOCr+OCueODneODvOODiFxyXG4gKiBjb25zdCByZXNwb25zZSA9IGF3YWl0IGhhbmRsZXIoe1xyXG4gKiAgIGhlYWRlcnM6IHsgJ3gtYXBpLWtleSc6ICd5b3VyLWFwaS1rZXknIH0sXHJcbiAqICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xyXG4gKiAgICAgZm9ybWF0OiAnY3N2JyxcclxuICogICAgIGZpbHRlcjoge1xyXG4gKiAgICAgICBjb21wYW55X2NvZGU6ICcxMjM0JyxcclxuICogICAgICAgc3RhcnRfZGF0ZTogJzIwMjQtMDEtMDEnLFxyXG4gKiAgICAgICBlbmRfZGF0ZTogJzIwMjQtMDEtMzEnLFxyXG4gKiAgICAgfSxcclxuICogICB9KSxcclxuICogfSwgY29udGV4dCk7XHJcbiAqIGBgYFxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhhbmRsZXIoXHJcbiAgZXZlbnQ6IEV4cG9ydEV2ZW50LFxyXG4gIGNvbnRleHQ6IENvbnRleHRcclxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcclxuICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xyXG5cclxuICB0cnkge1xyXG4gICAgbG9nZ2VyLmluZm8oJ0xhbWJkYSBFeHBvcnQgc3RhcnRlZCcsIHtcclxuICAgICAgcmVxdWVzdF9pZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXHJcbiAgICAgIGZ1bmN0aW9uX25hbWU6IGNvbnRleHQuZnVuY3Rpb25OYW1lLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gQVBJ44Kt44O86KqN6Ki8XHJcbiAgICB2YWxpZGF0ZUFwaUtleShldmVudCk7XHJcblxyXG4gICAgLy8g44Oq44Kv44Ko44K544OI44Oc44OH44Kj44Gu44OR44O844K5XHJcbiAgICBjb25zdCByZXF1ZXN0Qm9keSA9IHBhcnNlUmVxdWVzdEJvZHkoZXZlbnQuYm9keSk7XHJcblxyXG4gICAgLy8g44OQ44Oq44OH44O844K344On44OzXHJcbiAgICB2YWxpZGF0ZVJlcXVlc3RCb2R5KHJlcXVlc3RCb2R5KTtcclxuXHJcbiAgICAvLyDjgqjjgq/jgrnjg53jg7zjg4jjgrjjg6fjg5bjgpLkvZzmiJBcclxuICAgIGNvbnN0IGV4cG9ydEpvYiA9IGF3YWl0IGNyZWF0ZUV4cG9ydEpvYihyZXF1ZXN0Qm9keSwgY29udGV4dC5hd3NSZXF1ZXN0SWQpO1xyXG5cclxuICAgIC8vIOmdnuWQjOacn+OBp+OCqOOCr+OCueODneODvOODiOWHpueQhuOCkumWi+Wni++8iGF3YWl0IOOBl+OBquOBhO+8iVxyXG4gICAgcHJvY2Vzc0V4cG9ydChleHBvcnRKb2IuZXhwb3J0X2lkLCByZXF1ZXN0Qm9keSlcclxuICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcihcclxuICAgICAgICAgICdFeHBvcnQgcHJvY2Vzc2luZyBmYWlsZWQnLFxyXG4gICAgICAgICAgY3JlYXRlRXJyb3JDb250ZXh0KGVycm9yIGFzIEVycm9yLCB7XHJcbiAgICAgICAgICAgIGV4cG9ydF9pZDogZXhwb3J0Sm9iLmV4cG9ydF9pZCxcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xyXG5cclxuICAgIGxvZ2dlci5pbmZvKCdMYW1iZGEgRXhwb3J0IGNvbXBsZXRlZCcsIHtcclxuICAgICAgZXhwb3J0X2lkOiBleHBvcnRKb2IuZXhwb3J0X2lkLFxyXG4gICAgICBzdGF0dXM6IGV4cG9ydEpvYi5zdGF0dXMsXHJcbiAgICAgIGR1cmF0aW9uX21zOiBkdXJhdGlvbixcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOaIkOWKn+ODoeODiOODquOCr+OCuemAgeS/oVxyXG4gICAgYXdhaXQgc2VuZE1ldHJpY3MoW1xyXG4gICAgICB7XHJcbiAgICAgICAgbmFtZTogJ0xhbWJkYUV4ZWN1dGlvblRpbWUnLFxyXG4gICAgICAgIHZhbHVlOiBkdXJhdGlvbixcclxuICAgICAgICB1bml0OiAnTWlsbGlzZWNvbmRzJyxcclxuICAgICAgICBkaW1lbnNpb25zOiB7IEZ1bmN0aW9uTmFtZTogJ0V4cG9ydCcgfSxcclxuICAgICAgfSxcclxuICAgICAge1xyXG4gICAgICAgIG5hbWU6ICdFeHBvcnRKb2JzQ3JlYXRlZCcsXHJcbiAgICAgICAgdmFsdWU6IDEsXHJcbiAgICAgICAgdW5pdDogJ0NvdW50JyxcclxuICAgICAgICBkaW1lbnNpb25zOiB7IEZvcm1hdDogcmVxdWVzdEJvZHkuZm9ybWF0IH0sXHJcbiAgICAgIH0sXHJcbiAgICBdKTtcclxuXHJcbiAgICAvLyDjg6zjgrnjg53jg7PjgrlcclxuICAgIGNvbnN0IHJlc3BvbnNlOiBFeHBvcnRSZXNwb25zZSA9IHtcclxuICAgICAgZXhwb3J0X2lkOiBleHBvcnRKb2IuZXhwb3J0X2lkLFxyXG4gICAgICBzdGF0dXM6IGV4cG9ydEpvYi5zdGF0dXMsXHJcbiAgICAgIG1lc3NhZ2U6ICdFeHBvcnQgam9iIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5JyxcclxuICAgICAgcHJvZ3Jlc3M6IGV4cG9ydEpvYi5wcm9ncmVzcyxcclxuICAgIH07XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc3RhdHVzQ29kZTogMjAyLCAvLyBBY2NlcHRlZFxyXG4gICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxyXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxYLUFwaS1LZXknLFxyXG4gICAgICB9LFxyXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShyZXNwb25zZSksXHJcbiAgICB9O1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XHJcblxyXG4gICAgbG9nZ2VyLmVycm9yKFxyXG4gICAgICAnTGFtYmRhIEV4cG9ydCBmYWlsZWQnLFxyXG4gICAgICBjcmVhdGVFcnJvckNvbnRleHQoZXJyb3IgYXMgRXJyb3IsIHtcclxuICAgICAgICByZXF1ZXN0X2lkOiBjb250ZXh0LmF3c1JlcXVlc3RJZCxcclxuICAgICAgICBkdXJhdGlvbl9tczogZHVyYXRpb24sXHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIC8vIOOCqOODqeODvOODoeODiOODquOCr+OCuemAgeS/oVxyXG4gICAgYXdhaXQgc2VuZEVycm9yTWV0cmljKFxyXG4gICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IuY29uc3RydWN0b3IubmFtZSA6ICdVbmtub3duJyxcclxuICAgICAgJ0V4cG9ydCdcclxuICAgICk7XHJcblxyXG4gICAgLy8g44Ko44Op44O844Os44K544Od44Oz44K5XHJcbiAgICByZXR1cm4gaGFuZGxlRXJyb3IoZXJyb3IgYXMgRXJyb3IsIGNvbnRleHQuYXdzUmVxdWVzdElkKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBBUEnjgq3jg7zoqo3oqLxcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEV4cG9ydEV2ZW50XHJcbiAqIEB0aHJvd3MgQXV0aGVudGljYXRpb25FcnJvciBBUEnjgq3jg7zjgYznhKHlirnjgarloLTlkIhcclxuICovXHJcbmZ1bmN0aW9uIHZhbGlkYXRlQXBpS2V5KGV2ZW50OiBFeHBvcnRFdmVudCk6IHZvaWQge1xyXG4gIGNvbnN0IGFwaUtleSA9IGV2ZW50LmhlYWRlcnM/LlsneC1hcGkta2V5J10gfHwgZXZlbnQuaGVhZGVycz8uWydYLUFwaS1LZXknXTtcclxuXHJcbiAgaWYgKCFhcGlLZXkpIHtcclxuICAgIHRocm93IG5ldyBBdXRoZW50aWNhdGlvbkVycm9yKCdBUEkga2V5IGlzIHJlcXVpcmVkJyk7XHJcbiAgfVxyXG5cclxuICAvLyDnkrDlooPlpInmlbDjgYvjgolBUEnjgq3jg7zjgpLlj5blvpdcclxuICBjb25zdCB2YWxpZEFwaUtleSA9IHByb2Nlc3MuZW52LkFQSV9LRVk7XHJcblxyXG4gIGlmICghdmFsaWRBcGlLZXkpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignQVBJX0tFWSBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyBub3Qgc2V0Jyk7XHJcbiAgfVxyXG5cclxuICBpZiAoYXBpS2V5ICE9PSB2YWxpZEFwaUtleSkge1xyXG4gICAgdGhyb3cgbmV3IEF1dGhlbnRpY2F0aW9uRXJyb3IoJ0ludmFsaWQgQVBJIGtleScpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOODquOCr+OCqOOCueODiOODnOODh+OCo+OBruODkeODvOOCuVxyXG4gKlxyXG4gKiBAcGFyYW0gYm9keSDjg6rjgq/jgqjjgrnjg4jjg5zjg4fjgqPvvIhKU09O5paH5a2X5YiX77yJXHJcbiAqIEByZXR1cm5zIEV4cG9ydFJlcXVlc3RCb2R5XHJcbiAqIEB0aHJvd3MgVmFsaWRhdGlvbkVycm9yIOODkeODvOOCueOCqOODqeODvOOBruWgtOWQiFxyXG4gKi9cclxuZnVuY3Rpb24gcGFyc2VSZXF1ZXN0Qm9keShib2R5OiBzdHJpbmcpOiBFeHBvcnRSZXF1ZXN0Qm9keSB7XHJcbiAgaWYgKCFib2R5KSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdSZXF1ZXN0IGJvZHkgaXMgcmVxdWlyZWQnKTtcclxuICB9XHJcblxyXG4gIHRyeSB7XHJcbiAgICByZXR1cm4gSlNPTi5wYXJzZShib2R5KSBhcyBFeHBvcnRSZXF1ZXN0Qm9keTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignSW52YWxpZCBKU09OIGZvcm1hdCBpbiByZXF1ZXN0IGJvZHknLCB7XHJcbiAgICAgIGJvZHksXHJcbiAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjg6rjgq/jgqjjgrnjg4jjg5zjg4fjgqPjga7jg5Djg6rjg4fjg7zjgrfjg6fjg7NcclxuICpcclxuICogQHBhcmFtIHJlcXVlc3RCb2R5IEV4cG9ydFJlcXVlc3RCb2R5XHJcbiAqIEB0aHJvd3MgVmFsaWRhdGlvbkVycm9yIOODkOODquODh+ODvOOCt+ODp+ODs+OCqOODqeODvOOBruWgtOWQiFxyXG4gKi9cclxuZnVuY3Rpb24gdmFsaWRhdGVSZXF1ZXN0Qm9keShyZXF1ZXN0Qm9keTogRXhwb3J0UmVxdWVzdEJvZHkpOiB2b2lkIHtcclxuICAvLyDjg5Xjgqnjg7zjg57jg4Pjg4jjga7jg5Djg6rjg4fjg7zjgrfjg6fjg7NcclxuICBpZiAoIXJlcXVlc3RCb2R5LmZvcm1hdCB8fCAhWydqc29uJywgJ2NzdiddLmluY2x1ZGVzKHJlcXVlc3RCb2R5LmZvcm1hdCkpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgIGBJbnZhbGlkIGZvcm1hdDogJHtyZXF1ZXN0Qm9keS5mb3JtYXR9LiBFeHBlY3RlZCAnanNvbicgb3IgJ2NzdicuYFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIOODleOCo+ODq+OCv+ODvOOBruODkOODquODh+ODvOOCt+ODp+ODs1xyXG4gIGlmICghcmVxdWVzdEJvZHkuZmlsdGVyKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdGaWx0ZXIgaXMgcmVxdWlyZWQnKTtcclxuICB9XHJcblxyXG4gIGNvbnN0IHsgZmlsdGVyIH0gPSByZXF1ZXN0Qm9keTtcclxuXHJcbiAgLy8g5pel5LuY44OV44Kp44O844Oe44OD44OI44Gu44OQ44Oq44OH44O844K344On44Oz77yIWVlZWS1NTS1ERO+8iVxyXG4gIGNvbnN0IGRhdGVSZWdleCA9IC9eXFxkezR9LVxcZHsyfS1cXGR7Mn0kLztcclxuXHJcbiAgaWYgKGZpbHRlci5zdGFydF9kYXRlICYmICFkYXRlUmVnZXgudGVzdChmaWx0ZXIuc3RhcnRfZGF0ZSkpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgIGBJbnZhbGlkIHN0YXJ0X2RhdGUgZm9ybWF0OiAke2ZpbHRlci5zdGFydF9kYXRlfS4gRXhwZWN0ZWQgWVlZWS1NTS1ERCBmb3JtYXQuYFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGlmIChmaWx0ZXIuZW5kX2RhdGUgJiYgIWRhdGVSZWdleC50ZXN0KGZpbHRlci5lbmRfZGF0ZSkpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgIGBJbnZhbGlkIGVuZF9kYXRlIGZvcm1hdDogJHtmaWx0ZXIuZW5kX2RhdGV9LiBFeHBlY3RlZCBZWVlZLU1NLUREIGZvcm1hdC5gXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8g5pel5LuY44Gu5pyJ5Yq55oCn44OB44Kn44OD44KvXHJcbiAgaWYgKGZpbHRlci5zdGFydF9kYXRlKSB7XHJcbiAgICBjb25zdCBzdGFydERhdGUgPSBuZXcgRGF0ZShmaWx0ZXIuc3RhcnRfZGF0ZSk7XHJcbiAgICBpZiAoaXNOYU4oc3RhcnREYXRlLmdldFRpbWUoKSkpIHtcclxuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgICBgSW52YWxpZCBzdGFydF9kYXRlOiAke2ZpbHRlci5zdGFydF9kYXRlfS4gRGF0ZSBkb2VzIG5vdCBleGlzdC5gXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBpZiAoZmlsdGVyLmVuZF9kYXRlKSB7XHJcbiAgICBjb25zdCBlbmREYXRlID0gbmV3IERhdGUoZmlsdGVyLmVuZF9kYXRlKTtcclxuICAgIGlmIChpc05hTihlbmREYXRlLmdldFRpbWUoKSkpIHtcclxuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgICBgSW52YWxpZCBlbmRfZGF0ZTogJHtmaWx0ZXIuZW5kX2RhdGV9LiBEYXRlIGRvZXMgbm90IGV4aXN0LmBcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOaXpeS7mOmghuW6j+ODgeOCp+ODg+OCr1xyXG4gIGlmIChmaWx0ZXIuc3RhcnRfZGF0ZSAmJiBmaWx0ZXIuZW5kX2RhdGUpIHtcclxuICAgIGNvbnN0IHN0YXJ0RGF0ZSA9IG5ldyBEYXRlKGZpbHRlci5zdGFydF9kYXRlKTtcclxuICAgIGNvbnN0IGVuZERhdGUgPSBuZXcgRGF0ZShmaWx0ZXIuZW5kX2RhdGUpO1xyXG5cclxuICAgIGlmIChzdGFydERhdGUgPiBlbmREYXRlKSB7XHJcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgICAgYHN0YXJ0X2RhdGUgKCR7ZmlsdGVyLnN0YXJ0X2RhdGV9KSBtdXN0IGJlIGJlZm9yZSBvciBlcXVhbCB0byBlbmRfZGF0ZSAoJHtmaWx0ZXIuZW5kX2RhdGV9KWBcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOS8gealreOCs+ODvOODieOBruODkOODquODh+ODvOOCt+ODp+ODs++8iDTmoYHjga7mlbDlrZfvvIlcclxuICBpZiAoZmlsdGVyLmNvbXBhbnlfY29kZSAmJiAhL15cXGR7NH0kLy50ZXN0KGZpbHRlci5jb21wYW55X2NvZGUpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCBjb21wYW55X2NvZGUgZm9ybWF0OiAke2ZpbHRlci5jb21wYW55X2NvZGV9LiBFeHBlY3RlZCA0LWRpZ2l0IG51bWJlci5gXHJcbiAgICApO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOOCqOODqeODvOODj+ODs+ODieODquODs+OCsFxyXG4gKlxyXG4gKiBAcGFyYW0gZXJyb3Ig44Ko44Op44O844Kq44OW44K444Kn44Kv44OIXHJcbiAqIEBwYXJhbSByZXF1ZXN0SWQg44Oq44Kv44Ko44K544OISURcclxuICogQHJldHVybnMgQVBJR2F0ZXdheVByb3h5UmVzdWx0XHJcbiAqL1xyXG5mdW5jdGlvbiBoYW5kbGVFcnJvcihlcnJvcjogRXJyb3IsIHJlcXVlc3RJZDogc3RyaW5nKTogQVBJR2F0ZXdheVByb3h5UmVzdWx0IHtcclxuICAvLyDjgqjjg6njg7znqK7liKXjgavlv5zjgZjjgZ/jgrnjg4bjg7zjgr/jgrnjgrPjg7zjg4njgajjgqjjg6njg7zjgrPjg7zjg4lcclxuICBsZXQgc3RhdHVzQ29kZSA9IDUwMDtcclxuICBsZXQgZXJyb3JDb2RlID0gJ0lOVEVSTkFMX0VSUk9SJztcclxuXHJcbiAgaWYgKGVycm9yIGluc3RhbmNlb2YgVmFsaWRhdGlvbkVycm9yKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDAwO1xyXG4gICAgZXJyb3JDb2RlID0gJ1ZBTElEQVRJT05fRVJST1InO1xyXG4gIH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBBdXRoZW50aWNhdGlvbkVycm9yKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDAxO1xyXG4gICAgZXJyb3JDb2RlID0gJ1VOQVVUSE9SSVpFRCc7XHJcbiAgfVxyXG5cclxuICByZXR1cm4ge1xyXG4gICAgc3RhdHVzQ29kZSxcclxuICAgIGhlYWRlcnM6IHtcclxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLFgtQXBpLUtleScsXHJcbiAgICB9LFxyXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICBzdGF0dXM6ICdlcnJvcicsXHJcbiAgICAgIGVycm9yOiB7XHJcbiAgICAgICAgY29kZTogZXJyb3JDb2RlLFxyXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXHJcbiAgICAgICAgZGV0YWlsczogKGVycm9yIGFzIGFueSkuZGV0YWlscyB8fCB7fSxcclxuICAgICAgfSxcclxuICAgICAgcmVxdWVzdF9pZDogcmVxdWVzdElkLFxyXG4gICAgfSksXHJcbiAgfTtcclxufVxyXG4iXSwidmVyc2lvbiI6M30=