---
inclusion: fileMatch
fileMatchPattern: '**/.kiro/specs/**/*.md|**/work-logs/**/*.md|**/improvements/**/*.md'
---

# TDnet Data Collector - ワークフローガイドライン

このファイルは、サブエージェントの活用方法と並列実行パターンの詳細ガイドラインをまとめたものです。

---

## サブエージェントの積極的活用

### 基本方針

**タスク実行時は、適切な場面でサブエージェントを積極的に活用すること。特に並列実行可能なタスクは、サブエージェントに分割して効率的に実行すること。**

### 利用可能なサブエージェント

#### 1. context-gatherer（コンテキスト収集エージェント）

**役割:** コードベースの探索と関連ファイルの特定

**必ず使用すべき場面:**

| 場面 | 説明 |
|------|------|
| 新機能の実装開始前 | 関連ファイルの特定 |
| バグ調査・原因特定 | 影響範囲の把握 |
| 既存コードの理解 | コンポーネント間の関係性 |
| リファクタリング前 | 影響範囲調査 |
| 複数ファイルの変更計画 | 変更対象の特定 |

**使用タイミング:**
- ✅ タスク開始時に1回のみ使用
- ✅ 収集したコンテキストを基に作業を進める
- ❌ 再度の呼び出しは避ける（効率化のため）

**使用例:**
```
「Lambda関数のエラーハンドリングを改善したい」
→ context-gathererで関連するLambda関数、エラーハンドリングユーティリティ、テストファイルを特定
→ 収集した情報を基に改善を実施
```

#### 2. general-task-execution（汎用タスク実行エージェント）

**役割:** 明確に定義されたサブタスクの委譲と並列実行

**使用すべき場面:**

| 場面 | 説明 |
|------|------|
| 明確なサブタスク | 独立した作業の委譲 |
| 並列実行可能なタスク | 複数の独立した作業を同時実行 |
| 特定機能の実装 | 分離して実行可能な機能 |
| ドキュメント作成 | 複数のドキュメントを並列作成 |
| テストファイル作成 | 複数のテストファイルを並列作成 |

**使用例:**
```
「テストファイルの作成」「ドキュメントの更新」など、
メインタスクと独立した作業
```

#### 3. custom-agent-creator（カスタムエージェント作成）

**役割:** 繰り返しタスクの自動化

**使用すべき場面:**

| 場面 | 説明 |
|------|------|
| 繰り返しタスク | 同じパターンのタスクの自動化 |
| プロジェクト固有ワークフロー | 特定のワークフローの定義 |

**使用例:**
```
「改善記録の自動生成エージェント」
「テストカバレッジレポート生成エージェント」の作成
```

---

## 並列実行ルール

### 並列実行の基本原則

**タスクを分析し、並列実行可能な独立したサブタスクを特定した場合、積極的にサブエージェントに分割して並列実行すること。**

### 並列実行可能なタスクの判定基準

| 判定項目 | 並列実行可能 ✅ | 並列実行不可 ❌ |
|---------|--------------|--------------|
| **ファイル依存** | 異なるファイルを編集 | 同一ファイルを編集 |
| **データ依存** | データの読み書きが独立 | 同じデータを読み書き |
| **実行順序** | 順序に依存しない | 順序に依存する |
| **リソース競合** | リソースが競合しない | リソースが競合する |
| **タスク独立性** | 完全に独立したタスク | 相互に依存するタスク |

### 並列実行可能なタスクの例

| タスクの種類 | 並列実行の可否 | 理由 |
|------------|--------------|------|
| **複数のLambda関数を作成** | ✅ 可能 | 異なるファイルを作成 |
| **複数のテストファイルを作成** | ✅ 可能 | 異なるファイルを作成 |
| **複数のドキュメントを作成** | ✅ 可能 | 異なるファイルを作成 |
| **複数のsteeringファイルを更新** | ✅ 可能 | 異なるファイルを更新 |
| **Lambda関数とそのテストを作成** | ✅ 可能 | 異なるファイルを作成 |
| **CDKスタックと設定ファイルを作成** | ✅ 可能 | 異なるファイルを作成 |
| **同一ファイルの複数箇所を編集** | ❌ 不可 | ファイル競合のリスク |
| **依存関係のあるファイルを順次作成** | ❌ 不可 | 実行順序に依存 |
| **同一DynamoDBテーブルへの書込** | ❌ 不可 | リソース競合のリスク |

---

## 並列実行の実装パターン

### パターン1: 複数のLambda関数を並列作成

```
タスク: 3つのLambda関数（collector, parser, query）を作成

並列実行:
- サブエージェント1: collector Lambda関数を作成
- サブエージェント2: parser Lambda関数を作成
- サブエージェント3: query Lambda関数を作成

理由: 各Lambda関数は独立したファイルで、相互依存なし
```

### パターン2: Lambda関数とテストを並列作成

```
タスク: Lambda関数とそのテストファイルを作成

並列実行:
- サブエージェント1: Lambda関数の実装を作成
- サブエージェント2: テストファイルを作成

理由: 実装ファイルとテストファイルは異なるファイル
```

### パターン3: 複数のドキュメントを並列作成

```
タスク: README.md、API仕様書、デプロイガイドを作成

並列実行:
- サブエージェント1: README.mdを作成
- サブエージェント2: API仕様書を作成
- サブエージェント3: デプロイガイドを作成

理由: 各ドキュメントは独立したファイル
```

### パターン4: 複数のsteeringファイルを並列更新

```
タスク: 3つのsteeringファイルを更新

並列実行:
- サブエージェント1: testing-strategy.mdを更新
- サブエージェント2: data-validation.mdを更新
- サブエージェント3: api-design-guidelines.mdを更新

理由: 各steeringファイルは独立したファイル
```

---

## 並列実行不可のパターン（競合リスク）

### 競合パターン1: 同一ファイルの編集

```
❌ 不可: 同一ファイルの複数箇所を並列編集

タスク: Lambda関数の2つの関数を追加

並列実行不可:
- サブエージェント1: 関数Aを追加
- サブエージェント2: 関数Bを追加

理由: 同一ファイルへの同時編集は競合のリスク

正しいアプローチ:
- 自分で順次実行、またはサブエージェント1つに委譲
```

### 競合パターン2: 依存関係のあるファイル

```
❌ 不可: 依存関係のあるファイルを並列作成

タスク: インターフェースと実装クラスを作成

並列実行不可:
- サブエージェント1: インターフェースを作成
- サブエージェント2: 実装クラスを作成（インターフェースに依存）

理由: 実装クラスはインターフェースに依存

正しいアプローチ:
- インターフェースを先に作成 → 実装クラスを作成
```

### 競合パターン3: 共有リソースへのアクセス

```
❌ 不可: 同一DynamoDBテーブルへの並列書込

タスク: 複数のデータを同一テーブルに書込

並列実行不可:
- サブエージェント1: データAを書込
- サブエージェント2: データBを書込

理由: リソース競合のリスク（ただし、DynamoDBは並行書込をサポート）

正しいアプローチ:
- 1つのサブエージェントでバッチ書込
```

---

## 並列実行の判断フローチャート

```
タスクを分析
    ↓
複数の独立したサブタスクに分割可能？
    ↓ YES
各サブタスクは異なるファイルを編集？
    ↓ YES
各サブタスクは実行順序に依存しない？
    ↓ YES
各サブタスクはリソース競合しない？
    ↓ YES
✅ 並列実行可能 → サブエージェントに分割
    ↓ NO（いずれかの条件）
❌ 並列実行不可 → 順次実行または自分で実行
```

---

## 並列実行時の注意事項

| 注意事項 | 説明 |
|---------|------|
| **タスクの独立性を確認** | 各サブタスクが完全に独立していることを確認 |
| **ファイル競合を回避** | 同一ファイルを複数のサブエージェントで編集しない |
| **依存関係を考慮** | 依存関係のあるタスクは順次実行 |
| **リソース競合を回避** | 共有リソースへのアクセスは1つのサブエージェントに集約 |
| **エラーハンドリング** | 1つのサブエージェントが失敗しても他は継続 |
| **結果の統合** | すべてのサブエージェントの結果を統合して検証 |

---

## サブエージェント活用のベストプラクティス

| 原則 | 説明 |
|------|------|
| **context-gathererを最初に使用** | 不慣れなコードベースでは必ず最初に使用 |
| **1クエリ1回の原則** | context-gathererは1つのクエリで1回のみ |
| **並列実行を積極的に活用** | 独立したタスクは並列実行で効率化 |
| **競合を回避** | 同一ファイル編集や依存関係のあるタスクは並列実行しない |
| **結果を信頼** | サブエージェントの分析結果を信頼し、重複調査を避ける |
| **適切な委譲** | 単純なタスクは自分で実行、複雑なタスクのみ委譲 |
| **Autopilotモード** | サブエージェントはAutopilotモードでのみ利用可能 |

---

## サブエージェント活用の判断基準

| 状況 | 推奨アクション |
|------|--------------|
| 初めて触るコード領域 | ✅ context-gathererを使用 |
| バグの原因が不明 | ✅ context-gathererで影響範囲を調査 |
| 複数ファイルの変更が必要 | ✅ context-gathererで関連ファイルを特定 |
| 独立したサブタスク | ✅ general-task-executionに委譲 |
| 並列実行可能な複数タスク | ✅ 複数のgeneral-task-executionで並列実行 |
| 繰り返しタスク | ✅ custom-agent-creatorで自動化 |
| 単純な1ファイル編集 | ❌ 自分で実行 |
| 同一ファイルの複数箇所編集 | ❌ 自分で順次実行 |
| 依存関係のあるタスク | ❌ 順次実行または1つのサブエージェントに委譲 |

---

## 関連ドキュメント

- **タスク実行ルール**: `tdnet-data-collector.md` - 基本的なタスク実行フロー
- **ドキュメント標準**: `documentation-standards.md` - ドキュメント作成の標準規則
- **作業記録**: `../../specs/tdnet-data-collector/work-logs/README.md` - 作業記録の作成方法
- **改善記録**: `../../specs/tdnet-data-collector/improvements/README.md` - 改善記録の作成方法
