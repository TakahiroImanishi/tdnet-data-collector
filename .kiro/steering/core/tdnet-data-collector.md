# TDnet Data Collector - タスク実行ルール

このファイルは、TDnet Data Collectorプロジェクトのタスク実行時に従うべきルールとフィードバックループをまとめたものです。

---

## 目次

1. [ドキュメント言語規則](#1-ドキュメント言語規則)
2. [タスク実行と記録のワークフロー](#2-タスク実行と記録のワークフロー)
3. [改善の優先順位](#3-改善の優先順位)
4. [サブエージェントの積極的活用](#4-サブエージェントの積極的活用)

---

## 1. ドキュメント言語規則

### 基本方針

**すべてのドキュメント、コメント、ログメッセージは日本語で記述すること。**

### ファイルエンコーディング規則

**すべてのファイルはUTF-8エンコーディングで作成・保存すること。**

| 対象 | エンコーディング | BOM | 備考 |
|------|----------------|-----|------|
| TypeScript/JavaScript | UTF-8 | なし | - |
| Markdown | UTF-8 | なし | - |
| JSON | UTF-8 | なし | - |
| YAML | UTF-8 | なし | - |
| HTML | UTF-8 | なし | `<meta charset="UTF-8">` を含める |
| CSV | UTF-8 | BOM付き推奨 | Excel互換性のため |
| テキストファイル | UTF-8 | なし | - |

**理由:**
- クロスプラットフォーム互換性（Windows、macOS、Linux）
- Git差分の正確性
- 日本語文字の正確な表現
- CI/CD環境での一貫性
- 国際標準への準拠

**エディタ設定:**

**VS Code (.vscode/settings.json):**
```json
{
  "files.encoding": "utf8",
  "files.autoGuessEncoding": false,
  "files.eol": "\n"
}
```

**Git設定 (.gitattributes):**
```
* text=auto eol=lf
*.ts text eol=lf
*.js text eol=lf
*.json text eol=lf
*.md text eol=lf
*.yaml text eol=lf
*.yml text eol=lf
```

**Node.js/TypeScriptでのファイル操作:**
```typescript
import { promises as fs } from 'fs';

// ファイル読み込み（UTF-8）
const content = await fs.readFile('file.txt', 'utf-8');

// ファイル書き込み（UTF-8）
await fs.writeFile('file.txt', content, 'utf-8');
```

### 日本語で記述するもの

| 対象 | 言語 | 備考 |
|------|------|------|
| 要件定義書（requirements.md） | 日本語 | - |
| 設計書（design.md） | 日本語 | - |
| steeringファイル | 日本語 | - |
| 改善記録（improvements/） | 日本語 | - |
| 作業記録（work-logs/） | 日本語 | - |
| READMEファイル | 日本語 | - |
| コード内コメント | 日本語 | - |
| ログメッセージ | 日本語 | - |
| エラーメッセージ | 日本語 | ユーザー向け |

### 例外（英語のまま使用）

| 対象 | 理由 |
|------|------|
| コード自体（変数名、関数名、クラス名） | TypeScript/JavaScriptの慣習に従う |
| 技術用語（Lambda, DynamoDB, API等） | 業界標準の用語 |
| 外部APIのレスポンス | 元の言語のまま |

### 理由

- プロジェクトの主要な利用者が日本語話者
- TDnetは日本の開示情報サービス
- 日本語での記述により、理解と保守が容易

---

## 2. タスク実行と記録のワークフロー

### 記録ファイルの保存場所

| 記録の種類 | 保存先 |
|-----------|--------|
| 作業記録 | `.kiro/specs/tdnet-data-collector/work-logs/` |
| 改善記録 | `.kiro/specs/tdnet-data-collector/improvements/` |

### 全体フロー

```
タスク開始
    ↓
【作業記録作成】work-log-[日時].md を作成
    ↓
タスク実行（作業記録に随時記録）
    ↓
タスク完了
    ↓
【フィードバックループ】問題点の分析と改善点の特定
    ↓
【改善記録作成】task-[番号]-improvement-[連番]-[日時].md を作成
    ↓
改善実施
```

### 2.1 作業記録の作成（タスク実行中）

#### 目的

| 目的 | 説明 |
|------|------|
| 実行履歴の追跡 | いつ、何を実施したかを記録 |
| 作業内容の記録 | 変更ファイル、実行コマンドを記録 |
| 問題と解決策の文書化 | トラブルシューティングの参考 |
| 次回作業の参考資料 | 同様のタスクを実施する際の参考 |

#### 記録先

作業記録は `.kiro/specs/tdnet-data-collector/work-logs/` に保存します。

#### ファイル命名規則

```
work-log-[YYYYMMDD-HHMMSS].md
```

**例:**
- `work-log-20260207-143025.md`
- `work-log-20260207-150530.md`

**日時の取得:**

**Windows (PowerShell):**
```powershell
Get-Date -Format "yyyyMMdd-HHmmss"
```

**macOS/Linux (Bash):**
```bash
date +"%Y%m%d-%H%M%S"
```

**Node.js (環境非依存):**
```javascript
new Date().toISOString().replace(/[-:T]/g, '').slice(0, 15)
```

#### 作業記録のタイミング

| タイミング | 実施内容 |
|-----------|---------|
| **1. タスク開始時** | 作業記録ファイルを作成し、作業概要を記入 |
| **2. 作業中** | 実施内容を随時更新 |
| **3. 問題発生時** | 問題と解決策を記録 |
| **4. タスク完了時** | 成果物と次回への申し送りを記入 |

#### 作業記録フォーマット

```markdown
# 作業記録 - [作業タイトル]

**作成日時**: YYYY-MM-DD HH:MM:SS JST
**作業者**: Kiro AI Assistant
**関連タスク**: [タスク番号または説明]

## 作業概要
[作業の目的と概要を簡潔に記述]

## 実施内容
### 1. [作業項目1]
- 実施内容の詳細
- 変更したファイル
- 実行したコマンド

## 発生した問題と解決策
### 問題1: [問題の概要]
**状況:** [問題が発生した状況]
**原因:** [問題の原因]
**解決策:** [実施した解決策]

## 成果物
- [作成・更新したファイル一覧]
- [実行結果のサマリー]

## 次回への申し送り
- [次回作業時の注意点]
- [未完了の作業]
- [改善提案]
```

詳細は `.kiro/specs/tdnet-data-collector/work-logs/README.md` を参照。

---

### 2.2 フィードバックループ（タスク完了後）

#### 基本方針

**すべてのタスク完了後、必ず以下のフィードバックループを実施すること。**

#### フィードバックループの5ステップ

##### ステップ1: 実行結果の分析

作業記録を基に、タスクの実行結果を詳細に確認：

- [ ] タスクの実行結果
- [ ] 発生したエラーや警告
- [ ] パフォーマンスメトリクス（実行時間、メモリ使用量、コスト）

##### ステップ2: 問題点の洗い出し

以下の観点から問題点を特定：

| 問題の種類 | 具体例 |
|-----------|--------|
| **実装上の問題** | バグ、非効率なコード、エッジケースの見落とし |
| **設計上の問題** | アーキテクチャの不備、コンポーネント間の結合度 |
| **要件上の問題** | 不明確な要件、矛盾する要件、欠落している要件 |
| **テストの問題** | テストカバレッジ不足、不適切なテストケース |

##### ステップ3: 改善点の特定

問題点を基に改善点を特定：

| 改善の種類 | 具体例 |
|-----------|--------|
| **コードの改善** | リファクタリング、最適化、可読性向上 |
| **設計の改善** | より良いアーキテクチャパターン、疎結合化 |
| **要件の改善** | 要件の明確化、追加、修正 |
| **テストの改善** | 新しいテストケース、プロパティテストの追加 |
| **ドキュメントの改善** | steeringファイルの更新 |

##### ステップ4: 改善の実施

優先度の高い改善から順次実施：

1. **要件定義書（requirements.md）** の更新が必要な場合は更新
2. **設計書（design.md）** の更新が必要な場合は更新
3. **steeringファイル** の更新が必要な場合は更新
4. **コードのリファクタリング** を実施
5. **テストの追加・修正** を実施

##### ステップ5: 改善結果の検証

改善が正しく機能していることを確認：

- [ ] 改善後のテストを実行して問題が解決されたことを確認
- [ ] パフォーマンスが改善されたことを確認
- [ ] 新たな問題が発生していないことを確認

---

### 2.3 改善記録の作成（フィードバックループ後）

#### 記録先

改善記録は `.kiro/specs/tdnet-data-collector/improvements/` に保存します。

#### ファイル命名規則

```
task-[タスク番号]-improvement-[連番]-[YYYYMMDD-HHMMSS].md
```

**例:**
- `task-1.1-improvement-1-20260207-143025.md` - タスク1.1の1回目の改善分析
- `task-1.1-improvement-2-20260207-150530.md` - タスク1.1の2回目の改善分析

**日時の取得:**

**Windows (PowerShell):**
```powershell
Get-Date -Format "yyyyMMdd-HHmmss"
```

**macOS/Linux (Bash):**
```bash
date +"%Y%m%d-%H%M%S"
```

**Node.js (環境非依存):**
```javascript
new Date().toISOString().replace(/[-:T]/g, '').slice(0, 15)
```

#### 改善記録の内容

改善記録には以下を記載：

- 問題点の洗い出し結果
- 特定した改善点
- 実施した改善内容
- 改善結果の検証

詳細は `.kiro/specs/tdnet-data-collector/improvements/README.md` を参照。

---

### 2.4 作業記録と改善記録の違い

| 項目 | 作業記録（work-logs/） | 改善記録（improvements/） |
|------|----------------------|------------------------|
| **作成タイミング** | タスク実行中（開始時に作成） | タスク完了後（フィードバックループ時） |
| **目的** | 実行履歴の記録 | 継続的改善の記録 |
| **内容** | 実施した作業、問題と解決策、成果物 | 問題点の分析、改善点の特定、改善結果 |
| **対象** | すべてのタスク | 改善が必要なタスク |
| **関係性** | 作業記録を基に改善記録を作成 | - |

**ワークフロー:**
```
作業記録（実行中） → タスク完了 → フィードバックループ → 改善記録（分析結果）
```

---

## 3. 改善の優先順位

改善を実施する際は、以下の優先順位に従うこと：

| 優先度 | 分類 | 対象 |
|--------|------|------|
| **Critical** | 🔴 最優先 | システムが動作しない、データ損失のリスクがある |
| **High** | 🟠 高 | パフォーマンス問題、セキュリティ問題、コスト問題 |
| **Medium** | 🟡 中 | コード品質、保守性、テストカバレッジ |
| **Low** | 🟢 低 | ドキュメント、コメント、コーディングスタイル |

---

## 4. サブエージェントの積極的活用

### 基本方針

**タスク実行時は、適切な場面でサブエージェントを積極的に活用すること。特に並列実行可能なタスクは、サブエージェントに分割して効率的に実行すること。**

### 利用可能なサブエージェント

#### 1. context-gatherer（コンテキスト収集エージェント）

**役割:** コードベースの探索と関連ファイルの特定

**必ず使用すべき場面:**

| 場面 | 説明 |
|------|------|
| 新機能の実装開始前 | 関連ファイルの特定 |
| バグ調査・原因特定 | 影響範囲の把握 |
| 既存コードの理解 | コンポーネント間の関係性 |
| リファクタリング前 | 影響範囲調査 |
| 複数ファイルの変更計画 | 変更対象の特定 |

**使用タイミング:**
- ✅ タスク開始時に1回のみ使用
- ✅ 収集したコンテキストを基に作業を進める
- ❌ 再度の呼び出しは避ける（効率化のため）

**使用例:**
```
「Lambda関数のエラーハンドリングを改善したい」
→ context-gathererで関連するLambda関数、エラーハンドリングユーティリティ、テストファイルを特定
→ 収集した情報を基に改善を実施
```

#### 2. general-task-execution（汎用タスク実行エージェント）

**役割:** 明確に定義されたサブタスクの委譲と並列実行

**使用すべき場面:**

| 場面 | 説明 |
|------|------|
| 明確なサブタスク | 独立した作業の委譲 |
| 並列実行可能なタスク | 複数の独立した作業を同時実行 |
| 特定機能の実装 | 分離して実行可能な機能 |
| ドキュメント作成 | 複数のドキュメントを並列作成 |
| テストファイル作成 | 複数のテストファイルを並列作成 |

**使用例:**
```
「テストファイルの作成」「ドキュメントの更新」など、
メインタスクと独立した作業
```

#### 3. custom-agent-creator（カスタムエージェント作成）

**役割:** 繰り返しタスクの自動化

**使用すべき場面:**

| 場面 | 説明 |
|------|------|
| 繰り返しタスク | 同じパターンのタスクの自動化 |
| プロジェクト固有ワークフロー | 特定のワークフローの定義 |

**使用例:**
```
「改善記録の自動生成エージェント」
「テストカバレッジレポート生成エージェント」の作成
```

---

### 並列実行ルール

#### 並列実行の基本原則

**タスクを分析し、並列実行可能な独立したサブタスクを特定した場合、積極的にサブエージェントに分割して並列実行すること。**

#### 並列実行可能なタスクの判定基準

| 判定項目 | 並列実行可能 ✅ | 並列実行不可 ❌ |
|---------|--------------|--------------|
| **ファイル依存** | 異なるファイルを編集 | 同一ファイルを編集 |
| **データ依存** | データの読み書きが独立 | 同じデータを読み書き |
| **実行順序** | 順序に依存しない | 順序に依存する |
| **リソース競合** | リソースが競合しない | リソースが競合する |
| **タスク独立性** | 完全に独立したタスク | 相互に依存するタスク |

#### 並列実行可能なタスクの例

| タスクの種類 | 並列実行の可否 | 理由 |
|------------|--------------|------|
| **複数のLambda関数を作成** | ✅ 可能 | 異なるファイルを作成 |
| **複数のテストファイルを作成** | ✅ 可能 | 異なるファイルを作成 |
| **複数のドキュメントを作成** | ✅ 可能 | 異なるファイルを作成 |
| **複数のsteeringファイルを更新** | ✅ 可能 | 異なるファイルを更新 |
| **Lambda関数とそのテストを作成** | ✅ 可能 | 異なるファイルを作成 |
| **CDKスタックと設定ファイルを作成** | ✅ 可能 | 異なるファイルを作成 |
| **同一ファイルの複数箇所を編集** | ❌ 不可 | ファイル競合のリスク |
| **依存関係のあるファイルを順次作成** | ❌ 不可 | 実行順序に依存 |
| **同一DynamoDBテーブルへの書込** | ❌ 不可 | リソース競合のリスク |

#### 並列実行の実装パターン

##### パターン1: 複数のLambda関数を並列作成

```
タスク: 3つのLambda関数（collector, parser, query）を作成

並列実行:
- サブエージェント1: collector Lambda関数を作成
- サブエージェント2: parser Lambda関数を作成
- サブエージェント3: query Lambda関数を作成

理由: 各Lambda関数は独立したファイルで、相互依存なし
```

##### パターン2: Lambda関数とテストを並列作成

```
タスク: Lambda関数とそのテストファイルを作成

並列実行:
- サブエージェント1: Lambda関数の実装を作成
- サブエージェント2: テストファイルを作成

理由: 実装ファイルとテストファイルは異なるファイル
```

##### パターン3: 複数のドキュメントを並列作成

```
タスク: README.md、API仕様書、デプロイガイドを作成

並列実行:
- サブエージェント1: README.mdを作成
- サブエージェント2: API仕様書を作成
- サブエージェント3: デプロイガイドを作成

理由: 各ドキュメントは独立したファイル
```

##### パターン4: 複数のsteeringファイルを並列更新

```
タスク: 3つのsteeringファイルを更新

並列実行:
- サブエージェント1: testing-strategy.mdを更新
- サブエージェント2: data-validation.mdを更新
- サブエージェント3: api-design-guidelines.mdを更新

理由: 各steeringファイルは独立したファイル
```

#### 並列実行不可のパターン（競合リスク）

##### 競合パターン1: 同一ファイルの編集

```
❌ 不可: 同一ファイルの複数箇所を並列編集

タスク: Lambda関数の2つの関数を追加

並列実行不可:
- サブエージェント1: 関数Aを追加
- サブエージェント2: 関数Bを追加

理由: 同一ファイルへの同時編集は競合のリスク

正しいアプローチ:
- 自分で順次実行、またはサブエージェント1つに委譲
```

##### 競合パターン2: 依存関係のあるファイル

```
❌ 不可: 依存関係のあるファイルを並列作成

タスク: インターフェースと実装クラスを作成

並列実行不可:
- サブエージェント1: インターフェースを作成
- サブエージェント2: 実装クラスを作成（インターフェースに依存）

理由: 実装クラスはインターフェースに依存

正しいアプローチ:
- インターフェースを先に作成 → 実装クラスを作成
```

##### 競合パターン3: 共有リソースへのアクセス

```
❌ 不可: 同一DynamoDBテーブルへの並列書込

タスク: 複数のデータを同一テーブルに書込

並列実行不可:
- サブエージェント1: データAを書込
- サブエージェント2: データBを書込

理由: リソース競合のリスク（ただし、DynamoDBは並行書込をサポート）

正しいアプローチ:
- 1つのサブエージェントでバッチ書込
```

#### 並列実行の判断フローチャート

```
タスクを分析
    ↓
複数の独立したサブタスクに分割可能？
    ↓ YES
各サブタスクは異なるファイルを編集？
    ↓ YES
各サブタスクは実行順序に依存しない？
    ↓ YES
各サブタスクはリソース競合しない？
    ↓ YES
✅ 並列実行可能 → サブエージェントに分割
    ↓ NO（いずれかの条件）
❌ 並列実行不可 → 順次実行または自分で実行
```

#### 並列実行時の注意事項

| 注意事項 | 説明 |
|---------|------|
| **タスクの独立性を確認** | 各サブタスクが完全に独立していることを確認 |
| **ファイル競合を回避** | 同一ファイルを複数のサブエージェントで編集しない |
| **依存関係を考慮** | 依存関係のあるタスクは順次実行 |
| **リソース競合を回避** | 共有リソースへのアクセスは1つのサブエージェントに集約 |
| **エラーハンドリング** | 1つのサブエージェントが失敗しても他は継続 |
| **結果の統合** | すべてのサブエージェントの結果を統合して検証 |

---

### サブエージェント活用のベストプラクティス

| 原則 | 説明 |
|------|------|
| **context-gathererを最初に使用** | 不慣れなコードベースでは必ず最初に使用 |
| **1クエリ1回の原則** | context-gathererは1つのクエリで1回のみ |
| **並列実行を積極的に活用** | 独立したタスクは並列実行で効率化 |
| **競合を回避** | 同一ファイル編集や依存関係のあるタスクは並列実行しない |
| **結果を信頼** | サブエージェントの分析結果を信頼し、重複調査を避ける |
| **適切な委譲** | 単純なタスクは自分で実行、複雑なタスクのみ委譲 |
| **Autopilotモード** | サブエージェントはAutopilotモードでのみ利用可能 |

### サブエージェント活用の判断基準

| 状況 | 推奨アクション |
|------|--------------|
| 初めて触るコード領域 | ✅ context-gathererを使用 |
| バグの原因が不明 | ✅ context-gathererで影響範囲を調査 |
| 複数ファイルの変更が必要 | ✅ context-gathererで関連ファイルを特定 |
| 独立したサブタスク | ✅ general-task-executionに委譲 |
| 並列実行可能な複数タスク | ✅ 複数のgeneral-task-executionで並列実行 |
| 繰り返しタスク | ✅ custom-agent-creatorで自動化 |
| 単純な1ファイル編集 | ❌ 自分で実行 |
| 同一ファイルの複数箇所編集 | ❌ 自分で順次実行 |
| 依存関係のあるタスク | ❌ 順次実行または1つのサブエージェントに委譲 |

---

## 関連ドキュメント

- **実装ルール**: `tdnet-implementation-rules.md` - 基本的な実装原則
- **エラーハンドリング**: `error-handling-patterns.md` - エラー処理の詳細パターン
- **改善記録**: `../../specs/tdnet-data-collector/improvements/README.md` - 改善記録の作成方法
- **作業記録**: `../../specs/tdnet-data-collector/work-logs/README.md` - 作業記録の作成方法

