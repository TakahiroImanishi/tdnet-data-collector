# CI/CD Workflow Guide

**ä½œæˆæ—¥**: 2026-02-08  
**ç›®çš„**: GitHub Actionsã§ã®E2Eãƒ†ã‚¹ãƒˆè‡ªå‹•å®Ÿè¡Œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä½¿ç”¨æ–¹æ³•ã‚’èª¬æ˜Žã™ã‚‹

---

## æ¦‚è¦

TDnet Data Collectorãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã€2ã¤ã®GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ï¼š

1. **ci.yml** - åŒ…æ‹¬çš„ãªCI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆã‚³ãƒ¼ãƒ‰å“è³ª + E2Eï¼‰
2. **e2e-test.yml** - E2Eãƒ†ã‚¹ãƒˆå°‚ç”¨ï¼ˆè©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ + ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆç®¡ç†ï¼‰

---

## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æ¯”è¼ƒ

| é …ç›® | ci.yml | e2e-test.yml |
|------|--------|--------------|
| **ç›®çš„** | åŒ…æ‹¬çš„ãªCI/CD | E2Eãƒ†ã‚¹ãƒˆå°‚ç”¨ |
| **å®Ÿè¡Œå†…å®¹** | Lint + Format + Build + Unit + E2E | E2Eãƒ†ã‚¹ãƒˆã®ã¿ |
| **LocalStack** | GitHub Actions Services | Docker Compose |
| **ãƒ¬ãƒãƒ¼ãƒˆ** | åŸºæœ¬çš„ãªçµ±è¨ˆ | è©³ç´°ãªJSONè§£æž |
| **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ** | ãƒ†ã‚¹ãƒˆçµæžœ | ãƒ†ã‚¹ãƒˆçµæžœ + ãƒ­ã‚° + ç’°å¢ƒæƒ…å ± |
| **å®Ÿè¡Œæ™‚é–“** | 15-30åˆ† | 10-20åˆ† |
| **æŽ¨å¥¨ç”¨é€”** | ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ | E2Eãƒ†ã‚¹ãƒˆé–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚°æ™‚ |

---

## e2e-test.yml ã®ç‰¹å¾´

### 1. å …ç‰¢ãªLocalStackèµ·å‹•

```yaml
- name: Start LocalStack
  run: docker-compose up -d

- name: Wait for LocalStack to be ready
  run: |
    timeout 120 bash -c 'until curl -f http://localhost:4566/_localstack/health; do 
      sleep 5
    done'
```

**ç‰¹å¾´:**
- Docker Composeã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã§èµ·å‹•ã‚’ç¢ºèªï¼ˆæœ€å¤§120ç§’ï¼‰
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã§ç„¡é™å¾…æ©Ÿã‚’é˜²æ­¢

### 2. è‡ªå‹•ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ

```yaml
- name: Create DynamoDB tables
  env:
    AWS_ENDPOINT_URL: http://localhost:4566
  run: |
    # tdnet_disclosures ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    aws dynamodb create-table ...
    
    # tdnet_executions ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    aws dynamodb create-table ...

- name: Create S3 buckets
  run: |
    # PDFãƒã‚±ãƒƒãƒˆä½œæˆ
    aws s3 mb s3://tdnet-data-collector-pdfs-local
    
    # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒã‚±ãƒƒãƒˆä½œæˆ
    aws s3 mb s3://tdnet-data-collector-exports-local
```

**ç‰¹å¾´:**
- DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ2ã¤ï¼‰ã‚’è‡ªå‹•ä½œæˆ
- S3ãƒã‚±ãƒƒãƒˆï¼ˆ2ã¤ï¼‰ã‚’è‡ªå‹•ä½œæˆ
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆæ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã®å ´åˆã¯è­¦å‘Šã®ã¿ï¼‰

### 3. è©³ç´°ãªãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ

```yaml
- name: Generate test report
  run: |
    # JSONçµæžœã‚’è§£æž
    TOTAL=$(jq '.numTotalTests' test-results/e2e-results.json)
    PASSED=$(jq '.numPassedTests' test-results/e2e-results.json)
    FAILED=$(jq '.numFailedTests' test-results/e2e-results.json)
    
    # GitHub Summaryã«è¡¨ç¤º
    echo "## Summary" >> $GITHUB_STEP_SUMMARY
    echo "- **Total Tests**: $TOTAL" >> $GITHUB_STEP_SUMMARY
    echo "- **Passed**: âœ… $PASSED" >> $GITHUB_STEP_SUMMARY
    echo "- **Failed**: âŒ $FAILED" >> $GITHUB_STEP_SUMMARY
```

**ç‰¹å¾´:**
- JSONå½¢å¼ã®ãƒ†ã‚¹ãƒˆçµæžœã‚’è§£æž
- GitHub Summaryã«çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
- å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®è©³ç´°ã‚’è¡¨ç¤º

### 4. åŒ…æ‹¬çš„ãªã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆåŽé›†

```yaml
- name: Collect LocalStack logs
  run: |
    docker-compose logs localstack > test-artifacts/logs/localstack.log

- name: Collect test artifacts
  run: |
    # ãƒ†ã‚¹ãƒˆçµæžœã‚’ã‚³ãƒ”ãƒ¼
    cp -r test-results test-artifacts/
    
    # ç’°å¢ƒæƒ…å ±ã‚’ä½œæˆ
    cat > test-artifacts/environment.txt << EOF
    Node.js: $(node --version)
    npm: $(npm --version)
    OS: $(uname -a)
    Date: $(date)
    Commit: ${{ github.sha }}
    EOF
```

**ç‰¹å¾´:**
- LocalStackãƒ­ã‚°ã‚’ä¿å­˜
- ãƒ†ã‚¹ãƒˆçµæžœï¼ˆJSONï¼‰ã‚’ä¿å­˜
- ç’°å¢ƒæƒ…å ±ï¼ˆNode.jsã€npmã€OSã€ã‚³ãƒŸãƒƒãƒˆï¼‰ã‚’ä¿å­˜
- ä¿å­˜æœŸé–“: 30æ—¥

### 5. è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```yaml
- name: Stop LocalStack
  if: always()
  run: docker-compose down -v
```

**ç‰¹å¾´:**
- ãƒ†ã‚¹ãƒˆæˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšå®Ÿè¡Œ
- ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚‚å‰Šé™¤ï¼ˆ-vï¼‰
- æ¬¡å›žå®Ÿè¡Œæ™‚ã«ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã‹ã‚‰é–‹å§‹

---

## ä½¿ç”¨æ–¹æ³•

### è‡ªå‹•å®Ÿè¡Œï¼ˆæŽ¨å¥¨ï¼‰

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ï¼š

1. **ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆæ™‚**
   ```bash
   git checkout -b feature/new-feature
   git push origin feature/new-feature
   # GitHubä¸Šã§ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
   ```

2. **ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ›´æ–°æ™‚**
   ```bash
   git commit -m "Update feature"
   git push origin feature/new-feature
   ```

3. **mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚**
   ```bash
   git push origin main
   ```

### æ‰‹å‹•å®Ÿè¡Œ

GitHub Actionsã®ç”»é¢ã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã§ã™ï¼š

1. GitHubãƒªãƒã‚¸ãƒˆãƒªã®ã€ŒActionsã€ã‚¿ãƒ–ã‚’é–‹ã
2. ã€ŒE2E Tests with LocalStackã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’é¸æŠž
3. ã€ŒRun workflowã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ãƒ–ãƒ©ãƒ³ãƒã‚’é¸æŠžã—ã¦ã€ŒRun workflowã€ã‚’å®Ÿè¡Œ

---

## ãƒ†ã‚¹ãƒˆçµæžœã®ç¢ºèª

### GitHub Summary

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå¾Œã€GitHub Summaryã«ä»¥ä¸‹ã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

```
# ðŸ§ª E2E Test Results

## Summary

- **Total Tests**: 28
- **Passed**: âœ… 28
- **Failed**: âŒ 0
- **Duration**: 15.3s

## âœ… All Tests Passed!

---
Test completed at 2026-02-08 13:30:00
```

### ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

1. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒšãƒ¼ã‚¸ã‚’é–‹ã
2. ã€ŒArtifactsã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
3. ä»¥ä¸‹ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ï¼š
   - **e2e-test-artifacts**: ãƒ­ã‚°ã€ç’°å¢ƒæƒ…å ±
   - **e2e-test-results**: ãƒ†ã‚¹ãƒˆçµæžœï¼ˆJSONï¼‰

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### LocalStackãŒèµ·å‹•ã—ãªã„

**ç—‡çŠ¶**: "Waiting for LocalStack..." ãŒ120ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

**åŽŸå› **:
- Docker Composeã®èµ·å‹•å¤±æ•—
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å¿œç­”ãªã—

**è§£æ±ºç­–**:
1. docker-compose.ymlã®è¨­å®šã‚’ç¢ºèª
2. LocalStackã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
3. GitHub Actionsã®ãƒ­ã‚°ã‚’ç¢ºèª

### ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã«å¤±æ•—

**ç—‡çŠ¶**: "ResourceNotFoundException" ã‚¨ãƒ©ãƒ¼

**åŽŸå› **:
- AWS CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¤±æ•—
- LocalStackã®èµ·å‹•æœªå®Œäº†
- ç’°å¢ƒå¤‰æ•°ã®è¨­å®šãƒŸã‚¹

**è§£æ±ºç­–**:
1. AWS CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¢ºèª
2. LocalStackã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ç¢ºèª
3. ç’°å¢ƒå¤‰æ•°ï¼ˆAWS_ENDPOINT_URLã€AWS_REGIONï¼‰ã‚’ç¢ºèª

### ãƒ†ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

**ç—‡çŠ¶**: ãƒ†ã‚¹ãƒˆãŒ60ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

**åŽŸå› **:
- LocalStackã®å¿œç­”é…å»¶
- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å®Ÿè£…ãƒŸã‚¹

**è§£æ±ºç­–**:
1. jest.config.e2e.jsã®testTimeoutã‚’å»¶é•·
2. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¢ºèª
3. LocalStackã®ãƒ­ã‚°ã‚’ç¢ºèª

### JSONçµæžœãŒç”Ÿæˆã•ã‚Œãªã„

**ç—‡çŠ¶**: "Test results file not found" ã‚¨ãƒ©ãƒ¼

**åŽŸå› **:
- Jestã®å®Ÿè¡Œå¤±æ•—
- --json --outputFileã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æœªæŒ‡å®š

**è§£æ±ºç­–**:
1. npm run test:e2eã‚³ãƒžãƒ³ãƒ‰ã‚’ç¢ºèª
2. test-resultsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ã‚’ç¢ºèª
3. Jestã®å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèª

---

## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‰ã«ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆ

```powershell
# LocalStackã‚’èµ·å‹•
docker-compose up -d

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
.\scripts\localstack-setup.ps1

# E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
npm run test:e2e

# LocalStackã‚’åœæ­¢
docker-compose down -v
```

### 2. ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã¯ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ç¢ºèª

1. GitHub Actionsã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒšãƒ¼ã‚¸ã‚’é–‹ã
2. ã€ŒArtifactsã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã€Œe2e-test-artifactsã€ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
3. `logs/localstack.log`ã‚’ç¢ºèª
4. `environment.txt`ã§ç’°å¢ƒæƒ…å ±ã‚’ç¢ºèª

### 3. å®šæœŸçš„ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ

- é€±1å›žã€æ‰‹å‹•ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
- ä¾å­˜é–¢ä¿‚ã®æ›´æ–°å¾Œã¯å¿…ãšå®Ÿè¡Œ
- LocalStackã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°å¾Œã¯å¿…ãšå®Ÿè¡Œ

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### Phase 4: CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰ï¼ˆã‚¿ã‚¹ã‚¯25ï¼‰

e2e-test.ymlã¨ci.ymlã‚’çµ±åˆã—ã€ä»¥ä¸‹ã‚’å®Ÿè£…äºˆå®šï¼š

1. **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**
   - é–‹ç™ºç’°å¢ƒã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
   - æœ¬ç•ªç’°å¢ƒã¸ã®æ‰‹å‹•æ‰¿èªãƒ‡ãƒ—ãƒ­ã‚¤

2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³**
   - ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
   - ã‚³ãƒ¼ãƒ‰ã®é™çš„è§£æž

3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ**
   - è² è·ãƒ†ã‚¹ãƒˆ
   - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ æ¸¬å®š

4. **é€šçŸ¥æ©Ÿèƒ½**
   - Slacké€šçŸ¥
   - ãƒ¡ãƒ¼ãƒ«é€šçŸ¥

---

## ã¾ã¨ã‚

e2e-test.ymlãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€LocalStackã‚’ä½¿ç”¨ã—ãŸE2Eãƒ†ã‚¹ãƒˆã®è‡ªå‹•å®Ÿè¡Œã‚’æä¾›ã—ã¾ã™ã€‚è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆç®¡ç†ã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚

**æŽ¨å¥¨ã•ã‚Œã‚‹ä½¿ç”¨æ–¹æ³•:**
- ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚: è‡ªå‹•å®Ÿè¡Œï¼ˆci.ymlï¼‰
- E2Eãƒ†ã‚¹ãƒˆé–‹ç™ºæ™‚: æ‰‹å‹•å®Ÿè¡Œï¼ˆe2e-test.ymlï¼‰
- ãƒ‡ãƒãƒƒã‚°æ™‚: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦è©³ç´°ç¢ºèª

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:**
- [E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¬ã‚¤ãƒ‰](e2e-test-guide.md)
- [LocalStackã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰](localstack-setup.md)
- [GitHub Actionså…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.github.com/en/actions)
