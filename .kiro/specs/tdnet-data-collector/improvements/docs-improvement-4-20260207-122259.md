# Specs Improvements 2-7 Implementation

**実行日時:** 2026-02-07 12:22:59 JST

## 実施した改善

以下の改善提案（2-7）を実装しました：

### Improvement 2: Monitoring Dashboard Details ✅ COMPLETED (前回)
- design.mdに詳細な監視ダッシュボード設計を追加済み

### Improvement 3: Correctness Properties Test Guide ✅ COMPLETED (前回)
- design.mdにProperty実装マトリクスとテストテンプレートを追加済み

### Improvement 4: Error Code Standardization ✅ COMPLETED (今回)

**対応内容:**
- `error-handling-patterns.md`にエラーコード標準化セクションを追加
- 9種類のエラーコード（VALIDATION_ERROR, UNAUTHORIZED, FORBIDDEN, NOT_FOUND, CONFLICT, RATE_LIMIT_EXCEEDED, INTERNAL_ERROR, SERVICE_UNAVAILABLE, GATEWAY_TIMEOUT）を定義
- 各エラーコードの使用場面、実装例、レスポンス例を詳細に記載
- エラーコード変換マップ（ERROR_CODE_MAP）を実装
- カスタムエラークラスの定義と使用方法を明確化

**追加内容:**
- エラーコード一覧表（使用場面付き）
- 9種類のエラーコード別実装ガイドライン
- エラーコード変換関数（toErrorResponse）
- エラーコード使用の一貫性ガイドライン
- 関連ドキュメントへのリンク

**ファイル:**
- `.kiro/steering/core/error-handling-patterns.md` (約300行追加)

### Improvement 5: Performance Benchmark Targets ✅ COMPLETED (今回)

**対応内容:**
- `design.md`にパフォーマンスベンチマーク目標セクションを追加
- Lambda Collector、Query、Export、DynamoDB、S3、TDnetスクレイピングの各コンポーネントに対して具体的な目標値を設定
- 並列処理実装例を追加
- パフォーマンステスト実装例を追加
- CloudWatch監視メトリクスとアラート設定を追加

**追加した目標値:**
- Lambda Collector: 1件あたり5秒以内、日次バッチ5分以内、メモリ256MB以下
- Lambda Query: 応答時間500ms以内、100件取得1秒以内、メモリ128MB以下
- Lambda Export: 1,000件30秒以内、10,000件5分以内、メモリ512MB以下
- DynamoDB: 書き込み10ms以内、読み取り5ms以内
- S3: PDFアップロード2秒以内、署名付きURL生成50ms以内
- TDnetスクレイピング: HTMLパース500ms以内、PDFダウンロード2秒以内

**ファイル:**
- `.kiro/specs/tdnet-data-collector/docs/design.md` (約200行追加)

### Improvement 6: Data Retention Policy Details ✅ COMPLETED (今回)

**対応内容:**
- `design.md`にデータ保持ポリシーセクションを追加
- DynamoDB、S3、CloudWatch Logsの各データストアに対して詳細な保持期間と削除方法を定義
- ライフサイクルポリシーのCDK実装例を追加
- コスト影響の試算を追加
- データ保持ポリシーの監視とコンプライアンス要件を追加

**追加した保持ポリシー:**

**DynamoDB:**
- tdnet_disclosures: 無期限保持（5年以上経過データはアーカイブ推奨）
- tdnet_executions: 30日後TTL自動削除

**S3:**
- PDFファイル: Standard(90日) → Standard-IA(365日) → Glacier(無期限)
- エクスポートファイル: 7日後自動削除
- CloudTrailログ: Standard(90日) → Glacier(7年) → 削除

**CloudWatch Logs:**
- Lambda Collector（本番）: 3ヶ月保持
- Lambda Query/Export（本番）: 1ヶ月保持
- Lambda（開発）: 1週間保持

**ファイル:**
- `.kiro/specs/tdnet-data-collector/docs/design.md` (約300行追加)

### Improvement 7: OpenAPI Placement ✅ COMPLETED (今回)

**決定事項:**
- OpenAPI定義は`specs`フォルダに配置（`docs/openapi.yaml`）
- 理由: OpenAPIは実装のための仕様書であり、ガイドラインではないため

**対応内容:**
- `api-design-guidelines.md`からOpenAPI定義を抽出
- `.kiro/specs/tdnet-data-collector/docs/openapi.yaml`を新規作成
- 全エンドポイント、スキーマ、レスポンスを含む完全なOpenAPI 3.0定義
- エラーコードにCONFLICT(409)とGATEWAY_TIMEOUT(504)を追加（Improvement 4と整合）

**ファイル:**
- `.kiro/specs/tdnet-data-collector/docs/openapi.yaml` (新規作成、約800行)

## 影響範囲

### 更新ファイル

1. **`.kiro/steering/core/error-handling-patterns.md`**
   - エラーコード標準化セクション追加（約300行）
   - 9種類のエラーコード詳細ガイドライン
   - エラーコード変換マップ実装

2. **`.kiro/specs/tdnet-data-collector/docs/design.md`**
   - パフォーマンスベンチマーク目標セクション追加（約200行）
   - データ保持ポリシーセクション追加（約300行）
   - 合計約500行追加

### 新規ファイル

3. **`.kiro/specs/tdnet-data-collector/docs/openapi.yaml`**
   - 完全なOpenAPI 3.0定義（約800行）
   - 全エンドポイント、スキーマ、レスポンス定義

## 検証結果

- ✅ エラーコードが9種類に標準化され、使用方法が明確化された
- ✅ パフォーマンス目標が全コンポーネントに対して定義された
- ✅ データ保持ポリシーが詳細に定義され、コスト影響が試算された
- ✅ OpenAPI定義が独立したファイルとして抽出され、実装時に参照しやすくなった
- ✅ すべての改善がdesign.mdまたはerror-handling-patterns.mdに統合され、一貫性が保たれた

## 優先度

**High** - 実装開始に必要な詳細仕様が整備された

## 残りの改善提案

以下の改善提案は今回実施済み：
- ✅ Improvement 1: DR/Backup Strategy（前回実施：要件15として「実施しない」を追加）
- ✅ Improvement 2: Monitoring Dashboard Details（前回実施）
- ✅ Improvement 3: Correctness Properties Test Guide（前回実施）
- ✅ Improvement 4: Error Code Standardization（今回実施）
- ✅ Improvement 5: Performance Benchmark Targets（今回実施）
- ✅ Improvement 6: Data Retention Policy Details（今回実施）
- ✅ Improvement 7: OpenAPI Placement（今回実施）

**すべての改善提案が完了しました！**

## 次のステップ

1. ✅ すべての改善提案が実施済み
2. 実装開始前チェックリストの実施（`docs/implementation-checklist.md`）
3. 実装開始

## メトリクス

- **更新ファイル数:** 2
- **新規ファイル数:** 1
- **追加行数合計:** 約1,600行
- **改善提案完了率:** 7/7 (100%)

## 総括

Improvements 2-7の実装により、以下が達成されました：

1. **エラーハンドリングの標準化**: 9種類のエラーコードと実装パターンが明確化
2. **パフォーマンス目標の明確化**: 全コンポーネントに対して測定可能な目標値を設定
3. **データ保持ポリシーの詳細化**: コスト最適化とコンプライアンス要件を考慮した保持期間を定義
4. **OpenAPI仕様の独立化**: 実装時に参照しやすい独立したファイルとして抽出

これにより、実装開始に必要なすべての詳細仕様が整備され、実装者が迷うことなく開発を進められる状態になりました。
