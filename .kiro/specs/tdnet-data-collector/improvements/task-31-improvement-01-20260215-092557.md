# 改善記録: タスク31 - 実行ステータス管理の不具合

**作成日時**: 2026-02-15 09:25:57  
**関連タスク**: タスク31.5（本番環境の監視開始）  
**関連作業記録**: work-log-20260215-085941-production-verification.md

## 問題の概要

本番環境の監視開始時に、実行ステータス管理に以下の2つの問題が発見されました：

1. **実行ステータス更新の不具合**: `started_at`が毎回上書きされ、実行開始時刻が正しく記録されない
2. **CloudWatchメトリクス送信の失敗**: メトリクス名前空間の不一致により、権限エラーが発生

## 問題の詳細

### 問題1: 実行ステータス更新の不具合

**症状**:
- Lambda Collectorのログでは収集完了（2,694件）
- DynamoDBの`tdnet_executions_prod`では`status: "running"`のまま
- `collected_count: 0`、`progress: 0`が更新されていない

**根本原因**:
`src/lambda/collector/update-execution-status.ts`の`updateExecutionStatus`関数で、`started_at`を常に現在時刻で上書きしていた。

```typescript
// 問題のあるコード
const item: ExecutionStatus = {
  execution_id,
  status,
  progress: clampedProgress,
  collected_count,
  failed_count,
  started_at: now,  // ← 常に現在時刻で上書き
  updated_at: now,
  // ...
};
```

**影響**:
- 実行開始時刻が正しく記録されない
- 実行時間の計算が不正確になる
- 監視ダッシュボードで実行履歴が正しく表示されない

### 問題2: CloudWatchメトリクス送信の失敗

**症状**:
```
User: arn:aws:sts::803879841964:assumed-role/TdnetCompute-prod-CollectorFunctionServiceRoleE40F9-1O0qKouRDKN8/tdnet-collector-prod is not authorized to perform: cloudwatch:PutMetricData
```

**根本原因**:
- `src/utils/cloudwatch-metrics.ts`のメトリクス名前空間が`TDnetDataCollector`
- `cdk/lib/constructs/lambda-collector.ts`のIAM Policy条件では`TDnet`に限定

```typescript
// cloudwatch-metrics.ts
const NAMESPACE = 'TDnetDataCollector';  // ← 不一致

// lambda-collector.ts (CDK)
conditions: {
  StringEquals: {
    'cloudwatch:namespace': 'TDnet',  // ← 不一致
  },
}
```

**影響**:
- カスタムメトリクスが送信されない
- CloudWatchダッシュボードでメトリクスが表示されない
- アラート設定が機能しない可能性

## 修正内容

### 修正1: 実行ステータス更新処理の改善

**ファイル**: `src/lambda/collector/update-execution-status.ts`

```typescript
// 既存のレコードを取得してstarted_atを保持
const existingStatus = await getExecutionStatus(execution_id);
const started_at = existingStatus?.started_at || now;

const item: ExecutionStatus = {
  execution_id,
  status,
  progress: clampedProgress,
  collected_count,
  failed_count,
  started_at,  // ← 既存の値を保持
  updated_at: now,
  // ...
};
```

**変更点**:
- 既存レコードを取得して`started_at`を保持
- 初回作成時のみ現在時刻を設定
- 更新時は既存の`started_at`を維持

### 修正2: CloudWatchメトリクス名前空間の統一

**ファイル**: `src/utils/cloudwatch-metrics.ts`

```typescript
// 修正前
const NAMESPACE = 'TDnetDataCollector';

// 修正後
const NAMESPACE = 'TDnet';
```

**変更点**:
- メトリクス名前空間をCDKのIAM Policy条件と一致させる

## 再発防止策

### 1. ユニットテストの追加（タスク34.1）

`update-execution-status.test.ts`に以下のテストケースを追加：

- 初回作成時に`started_at`が設定されることを確認
- 更新時に`started_at`が保持されることを確認
- 複数回の更新で`started_at`が変わらないことを確認

### 2. 統合テストの追加（タスク34.2）

CloudWatchメトリクス送信の統合テストを追加：

- メトリクスが正常に送信されることを確認
- IAM権限が正しく設定されていることを確認

### 3. E2Eテストの追加（タスク34.3）

実行ステータス管理の一連の流れをテスト：

- 実行開始→進捗更新→完了の流れを確認
- DynamoDBに正しい値が保存されることを確認
- タイムスタンプが正しいことを確認

### 4. 本番環境での動作確認（タスク34.4）

修正版を本番環境にデプロイして動作確認：

- 実行ステータスが正しく更新されることを確認
- CloudWatchメトリクスが正常に送信されることを確認

## 学んだこと

### 1. 状態管理の重要性

- 既存レコードの値を保持する必要がある場合、必ず既存データを取得してから更新する
- 初回作成と更新を明確に区別する

### 2. 設定の一貫性

- CDKのIAM Policy条件とアプリケーションコードの設定値は一致させる必要がある
- 名前空間、リソース名などの設定値は定数化して一元管理する

### 3. 本番環境での検証の重要性

- 開発環境では発見できない問題が本番環境で発生する可能性がある
- 本番環境デプロイ後は必ず動作確認を実施する
- ログとメトリクスを確認して異常がないか確認する

### 4. テストカバレッジの重要性

- 状態管理のロジックは複雑になりやすいため、十分なテストが必要
- 初回作成、更新、複数回更新など、様々なシナリオをテストする

## 関連タスク

- **タスク34.1**: 実行ステータス更新処理のユニットテスト追加
- **タスク34.2**: CloudWatchメトリクス名前空間の統一性検証
- **タスク34.3**: 実行ステータス管理のE2Eテスト追加
- **タスク34.4**: 本番環境での修正の動作確認

## 参考資料

- **作業記録**: `.kiro/specs/tdnet-data-collector/work-logs/work-log-20260215-085941-production-verification.md`
- **修正コミット**: `292922e`
- **関連ファイル**:
  - `src/lambda/collector/update-execution-status.ts`
  - `src/utils/cloudwatch-metrics.ts`
  - `cdk/lib/constructs/lambda-collector.ts`

---

**改善記録作成者**: AI Assistant  
**レビュー状態**: 未レビュー  
**優先度**: 高（本番環境の問題）
