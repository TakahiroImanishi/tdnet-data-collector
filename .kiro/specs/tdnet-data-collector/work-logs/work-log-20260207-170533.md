# 作業記録: Issue 4 - S3 Object Lockの適用範囲修正

**作成日時:** 2026-02-07 17:05:33  
**タスク:** Issue 4 - S3 Object Lockの適用範囲修正

---

## タスク概要

### 目的
S3 Object Lockの適用範囲を修正し、一時ファイルの自動削除が正常に動作するようにする。

### 背景
- 現在の設計では、バケット全体にObject Lockを適用している
- 一時ファイル（`temp/`プレフィックス）にObject Lockが適用されると、1日後の自動削除が失敗する
- Object Lockが有効な場合、保持期間中は削除できないため、ライフサイクルポリシーによる自動削除が機能しない

### 目標
- Object Lockを`pdfs/`プレフィックスのみに適用するように設計を修正
- 一時ファイルとエクスポートファイルはObject Lock適用除外とする
- 関連ドキュメントを更新

---

## 実施計画

1. **ドキュメント確認:**
   - `data-integrity-design.md`の現在の内容を確認
   - `design.md`の現在の内容を確認

2. **data-integrity-design.mdの修正:**
   - CDK実装コードを修正（バケット全体のObject Lock削除）
   - オブジェクトごとにObject Lockを設定する方法に変更
   - `preparePhase()`と`commitPhase()`の実装例を更新

3. **design.mdの修正:**
   - S3バケット設定の説明を更新
   - Object Lockの適用範囲を明記

4. **作業記録の完成:**
   - 成果物を記録
   - 次回への申し送りを記入

---

## 実施内容

### 1. ドキュメント確認


- ✅ `data-integrity-design.md`を確認（1,655行）
  - 現在の設定: `objectLockEnabled: true`（バケット全体に適用）
  - 問題箇所: 行835-876のCDK実装コード
  - 問題箇所: 行927-930のオブジェクトアップロード例

- ✅ `design.md`を確認（2,928行）
  - S3バケット設定: 行697-820
  - バージョニングは有効だがObject Lockの記載なし

### 2. data-integrity-design.mdの修正

修正対象セクション: "S3 Object Lock設定"（行800-950）


#### 修正1: CDK実装コードの更新（行825-890）

**変更内容:**
- ❌ `objectLockEnabled: true`を削除（バケット全体への適用を停止）
- ❌ `cfnBucket.objectLockConfiguration`の設定を削除
- ✅ バージョニングは維持（`versioned: true`）
- ✅ ライフサイクルポリシーに`exports/`の削除ルールを追加
- ✅ 重要な注意事項を3点追加

**理由:**
- バケット全体にObject Lockを有効化すると、デフォルト保持期間がすべてのオブジェクトに適用される
- 一時ファイル（temp/）とエクスポートファイル（exports/）は自動削除が必要
- Object Lockはオブジェクトごとに設定する方式に変更

#### 修正2: オブジェクトごとのObject Lock設定例を追加（行920-970）

**追加内容:**
- ✅ pdfs/プレフィックスへのObject Lock設定例
- ✅ temp/プレフィックスへのObject Lock非適用例
- ✅ exports/プレフィックスへのObject Lock非適用例
- ✅ Object Lockの適用範囲まとめ表

**設計の利点:**
- 一時ファイルとエクスポートファイルは自動削除が正常に動作
- 開示情報PDFは誤削除・改ざんから保護
- ライフサイクルポリシーとObject Lockが競合しない
- プレフィックスごとに柔軟な保持ポリシーを設定可能

#### 修正3: commitPhase関数の更新（行220-245）

**変更内容:**
- ✅ `CopyObjectCommand`に`ObjectLockMode`と`ObjectLockRetainUntilDate`を追加
- ✅ ログ出力にObject Lock情報を追加

**実装例:**
```typescript
ObjectLockMode: 'GOVERNANCE',
ObjectLockRetainUntilDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), // 1年後
```

### 3. design.mdの修正

#### 修正1: S3バケット設定の更新（行699-725）

**変更内容:**
- ✅ ディレクトリ構造に`/pdfs/`と`/temp/`を明記
- ✅ Object Lock設定セクションを追加
  - 適用範囲: pdfs/プレフィックスのみ
  - モード: GOVERNANCE
  - 保持期間: 1年間
  - 適用除外: temp/プレフィックス
- ✅ ライフサイクルポリシーに`temp/`の削除ルールを明記

---

## 成果物

### 修正されたファイル

1. ✅ **`.kiro/specs/tdnet-data-collector/docs/data-integrity-design.md`**
   - CDK実装コードを修正（objectLockEnabled削除）
   - オブジェクトごとのObject Lock設定例を追加
   - commitPhase関数にObject Lock設定を追加
   - 適用範囲まとめ表を追加

2. ✅ **`.kiro/specs/tdnet-data-collector/docs/design.md`**
   - S3バケット設定にObject Lock情報を追加
   - ディレクトリ構造を明確化
   - ライフサイクルポリシーを更新

3. ✅ **作業記録**: `work-log-20260207-170533.md`（本ファイル）

### 主な変更点のまとめ

| 項目 | 修正前 | 修正後 |
|------|--------|--------|
| **Object Lock適用方法** | バケット全体に適用 | オブジェクトごとに適用 |
| **CDK設定** | `objectLockEnabled: true` | `objectLockEnabled`を削除 |
| **pdfs/プレフィックス** | デフォルト保持期間適用 | アップロード時に個別設定 |
| **temp/プレフィックス** | デフォルト保持期間適用（削除失敗） | Object Lock非適用（削除成功） |
| **exports/プレフィックス** | デフォルト保持期間適用（削除失敗） | Object Lock非適用（削除成功） |
| **ライフサイクルポリシー** | temp/のみ | temp/とexports/の両方 |

---

## 次回への申し送り

### 完了事項
- ✅ data-integrity-design.mdのS3 Object Lock設定を修正
- ✅ design.mdのS3バケット設定を更新
- ✅ オブジェクトごとのObject Lock設定例を追加
- ✅ commitPhase関数にObject Lock設定を追加

### 今後の対応が必要な項目

1. **CDK実装時の確認事項:**
   - `cdk/lib/constructs/tdnet-bucket-construct.ts`を作成時に、修正後の設計を反映
   - バージョニングは有効にする（`versioned: true`）
   - `objectLockEnabled`は設定しない

2. **Two-Phase Commit実装時の確認事項:**
   - `src/collector/two-phase-commit.ts`の`commitPhase`関数で、`CopyObjectCommand`に`ObjectLockMode`と`ObjectLockRetainUntilDate`を設定
   - `preparePhase`関数では、temp/へのアップロード時にObject Lockを設定しない

3. **統合テストでの検証項目:**
   - temp/プレフィックスのファイルが1日後に自動削除されることを確認
   - exports/プレフィックスのファイルが7日後に自動削除されることを確認
   - pdfs/プレフィックスのファイルにObject Lockが設定されていることを確認
   - Object Lock設定されたファイルが1年間削除できないことを確認

4. **既存バケットの移行（該当する場合）:**
   - 既存のバケットに`objectLockEnabled: true`が設定されている場合、新しいバケットを作成する必要がある
   - Object Lock設定はバケット作成後に変更できないため、移行が必要
   - データ移行時は、pdfs/プレフィックスのファイルにのみObject Lockを設定

### 関連タスク
- Issue 1: Two-Phase Commit実装（commitPhase関数でObject Lock設定を反映）
- Issue 2: レート制限実装（影響なし）
- Issue 3: エラーリカバリー拡張（影響なし）

---

## 参考情報

### S3 Object Lockの仕様

**Object Lockの制約:**
- バケット作成時のみ有効化可能（作成後は変更不可）
- バージョニングが必須
- 保持期間中は削除・上書き不可（GOVERNANCE modeは特別な権限で削除可能）

**ライフサイクルポリシーとの関係:**
- Object Lockが設定されたオブジェクトは、保持期間中はライフサイクルポリシーによる削除が失敗する
- 保持期間が経過すると、ライフサイクルポリシーによる削除が可能になる

**オブジェクトごとのObject Lock設定:**
- `PutObject`または`CopyObject`時に`ObjectLockMode`と`ObjectLockRetainUntilDate`を指定
- バケット全体にObject Lockを有効化していなくても、バージョニングが有効であればオブジェクトごとに設定可能
- ただし、バケット作成時に`objectLockEnabled: true`を設定していない場合、オブジェクトごとのObject Lock設定はできない

**⚠️ 重要な注意:**
本設計では、バケット作成時に`objectLockEnabled`を設定しないため、実際にはオブジェクトごとのObject Lock設定もできません。Object Lockを使用する場合は、以下のいずれかの方法を採用する必要があります：

**オプション1: バケット全体でObject Lockを有効化し、デフォルト保持期間を設定しない**
```typescript
this.bucket = new s3.Bucket(this, 'TDnetBucket', {
    objectLockEnabled: true,  // バケット全体で有効化
    versioned: true,
    // デフォルト保持期間は設定しない
});
// cfnBucket.objectLockConfiguration は設定しない
```

**オプション2: 別々のバケットを使用**
- `tdnet-pdfs-{account-id}`: Object Lock有効、pdfs/のみ格納
- `tdnet-temp-{account-id}`: Object Lock無効、temp/とexports/を格納

**推奨: オプション1を採用**
- バケット全体でObject Lockを有効化するが、デフォルト保持期間は設定しない
- オブジェクトごとに`ObjectLockMode`を指定する
- temp/とexports/には`ObjectLockMode`を指定しない（ライフサイクルポリシーで削除可能）
