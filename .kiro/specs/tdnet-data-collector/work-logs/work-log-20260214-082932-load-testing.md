# 作業記録: 負荷テストの実装と実行

**タスク**: 26.6 負荷テストの実行  
**開始日時**: 2026-02-14 08:29:32  
**担当**: Kiro AI Assistant

## 目的

大量データ収集時（100件以上）と同時アクセス時のシステム動作を確認し、負荷テストを実施する。

## 要件

- **Requirements 9.1**: 負荷テスト
  - 大量データ収集時の動作確認（100件以上）
  - 同時アクセス時の動作確認
  - レート制限の遵守確認
  - エラーハンドリングの確認
  - パフォーマンス目標の達成確認

## 実装計画

### 1. 負荷テストスクリプトの作成

#### 1.1 大量データ収集テスト
- 100件以上の開示情報を収集
- 並列処理の動作確認
- レート制限の遵守確認
- メモリ使用量の監視

#### 1.2 同時アクセステスト
- 複数のAPIリクエストを同時実行
- API Gateway/Lambda の同時実行制限確認
- DynamoDB スロットリング確認
- エラーレート監視

### 2. テストシナリオ

#### シナリオ1: 大量データ収集（100件）
- Lambda Collector を呼び出し
- 100件の開示情報を収集
- 実行時間、成功率、エラー率を測定

#### シナリオ2: 同時API呼び出し（10並列）
- GET /disclosures を10並列で呼び出し
- レスポンスタイム、成功率を測定

#### シナリオ3: エクスポート同時実行（5並列）
- POST /exports を5並列で呼び出し
- エクスポート完了時間、成功率を測定

## 実装内容


### 1. 負荷テストスクリプトの作成

**ファイル**: `src/__tests__/load/load-test.test.ts`

**実装内容**:

#### シナリオ1: 大量データ収集（100件以上）
- Lambda Collector を呼び出し、過去30日間のデータを収集
- 合格基準:
  - 収集件数: 100件以上
  - 成功率: 95%以上
  - 実行時間: 15分以内

#### シナリオ2: 同時API呼び出し（10並列）
- GET /disclosures を10並列で呼び出し
- 合格基準:
  - 成功率: 80%以上
  - 平均応答時間: 5秒以内

#### シナリオ3: エクスポート同時実行（5並列）
- POST /exports を5並列で呼び出し
- 合格基準:
  - 成功率: 80%以上
  - 総実行時間: 10秒以内

#### シナリオ4: レート制限の確認
- 連続リクエストでレート制限が機能することを確認

#### シナリオ5: エラーハンドリングの確認
- 不正なリクエストで適切なエラーが返されることを確認

### 2. ドキュメント作成

**ファイル**: `docs/load-testing-guide.md`

**内容**:
- テストシナリオの詳細説明
- 実行方法（環境変数設定、AWS認証）
- テスト結果の確認方法
- トラブルシューティング
- パフォーマンス目標

## テスト実行


### テスト実行結果

**実行日時**: 2026-02-14 08:35

**環境**: LocalStack

**結果**:
- LocalStack環境ではAPI Gatewayが完全には動作しないため、実際の負荷テストは開発環境または本番環境で実施する必要があります
- テストスクリプトは正常に作成され、実行可能な状態です

**LocalStack環境での制限事項**:
1. API Gateway エンドポイントが正しく動作しない
2. Lambda関数の同期呼び出しが制限される
3. 実際のネットワーク負荷をシミュレートできない

## 成果物

### 1. 負荷テストスクリプト
- **ファイル**: `src/__tests__/load/load-test.test.ts`
- **内容**: 5つのテストシナリオを実装
  - シナリオ1: 大量データ収集（100件以上）
  - シナリオ2: 同時API呼び出し（10並列）
  - シナリオ3: エクスポート同時実行（5並列）
  - シナリオ4: レート制限の確認
  - シナリオ5: エラーハンドリングの確認

### 2. 負荷テストガイド
- **ファイル**: `docs/load-testing-guide.md`
- **内容**:
  - テストシナリオの詳細説明
  - 実行方法（環境変数設定、AWS認証）
  - テスト結果の確認方法（CloudWatch Logs、Metrics、DynamoDB）
  - トラブルシューティング
  - パフォーマンス目標

### 3. 環境設定ファイル
- **ファイル**: `.env.load-test`
- **内容**: 負荷テスト用の環境変数設定

## 実際の環境でのテスト手順

### 前提条件

1. **開発環境または本番環境にデプロイ済み**
   ```bash
   npm run cdk:deploy -- --profile your-aws-profile
   ```

2. **環境変数の設定**
   
   `.env.load-test` を編集:
   ```bash
   TEST_ENV=dev
   API_BASE_URL=https://your-api-gateway-url.execute-api.ap-northeast-1.amazonaws.com/dev
   API_KEY=your-actual-api-key
   AWS_REGION=ap-northeast-1
   COLLECTOR_FUNCTION_NAME=tdnet-collector-dev
   DISCLOSURES_TABLE_NAME=tdnet-disclosures-dev
   ```

3. **AWS認証情報の設定**
   ```bash
   aws configure --profile your-aws-profile
   ```

### テスト実行

```bash
# 環境変数を読み込んで実行
npm test -- load-test.test.ts --testTimeout=600000
```

### 期待される結果

#### シナリオ1: 大量データ収集
- ✅ 収集件数: 100件以上
- ✅ 成功率: 95%以上
- ✅ 実行時間: 15分以内

#### シナリオ2: 同時API呼び出し
- ✅ 成功率: 80%以上
- ✅ 平均応答時間: 5秒以内

#### シナリオ3: エクスポート同時実行
- ✅ 成功率: 80%以上
- ✅ 総実行時間: 10秒以内

#### シナリオ4: レート制限
- ✅ レート制限が機能すること

#### シナリオ5: エラーハンドリング
- ✅ 不正なリクエストで適切なエラーが返されること

## 申し送り事項

### 次のステップ

1. **開発環境へのデプロイ**
   - CDK Deploy を実行
   - API Gateway URLとAPIキーを取得
   - `.env.load-test` を更新

2. **負荷テストの実行**
   - 上記の手順に従ってテストを実行
   - テスト結果をCloudWatchで確認
   - パフォーマンス目標の達成を確認

3. **結果の記録**
   - テスト結果を作業記録に追記
   - 問題があれば改善記録を作成

### 注意事項

1. **本番環境でのテスト**
   - 本番環境でテストする場合は、事前に関係者に通知すること
   - テストデータと本番データを区別できるようにすること

2. **コスト**
   - 負荷テストはAWS利用料金が発生します
   - テスト後は不要なリソースを削除すること

3. **レート制限**
   - TDnet APIのレート制限（1リクエスト/秒）を遵守すること
   - 過度なリクエストはTDnetサーバーに負荷をかける可能性があります

## 完了日時

2026-02-14 08:40

## ステータス

✅ 負荷テストスクリプトとドキュメントの作成完了
⚠️ 実際の負荷テストは開発環境または本番環境で実施する必要があります
