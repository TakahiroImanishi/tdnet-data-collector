# 作業記録（Work Logs）

このフォルダには、TDnet Data Collectorプロジェクトのタスク実行時の作業記録が格納されています。

## 目的

- タスクの実行履歴を追跡
- 実施した作業内容を記録
- 問題点と解決策を文書化
- 次回の作業時の参考資料

## ファイル命名規則

```
work-log-[YYYYMMDD-HHMMSS].md
```

**例:**
- `work-log-20260207-143025.md`
- `work-log-20260207-150530.md`

**日時の取得:**
```powershell
Get-Date -Format "yyyyMMdd-HHmmss"
```

## 作業記録フォーマット

```markdown
# 作業記録 - [作業タイトル]

**作成日時**: YYYY-MM-DD HH:MM:SS JST
**作業者**: Kiro AI Assistant
**関連タスク**: [タスク番号または説明]

## 作業概要

[作業の目的と概要を簡潔に記述]

## 実施内容

### 1. [作業項目1]

- 実施内容の詳細
- 変更したファイル
- 実行したコマンド

### 2. [作業項目2]

- 実施内容の詳細
- 変更したファイル
- 実行したコマンド

## 発生した問題と解決策

### 問題1: [問題の概要]

**状況:**
[問題が発生した状況]

**原因:**
[問題の原因]

**解決策:**
[実施した解決策]

## 成果物

- [作成・更新したファイル一覧]
- [実行結果のサマリー]

## 次回への申し送り

- [次回作業時の注意点]
- [未完了の作業]
- [改善提案]

## 参考情報

- [参照したドキュメント]
- [関連するissueやPR]
```

## 作業記録の作成方法

### PowerShellスクリプトを使用（推奨）

作業記録を簡単に作成できるPowerShellスクリプトを用意しています：

**基本的な使用方法:**
```powershell
# 最小限の使用（タイトルとタスク番号は後で記入）
.\create-work-log.ps1

# タイトルを指定
.\create-work-log.ps1 -Title "Lambda関数の実装"

# タスク番号を指定
.\create-work-log.ps1 -Task "タスク1.1"

# 作成後にファイルを開く
.\create-work-log.ps1 -Open

# すべてのオプションを指定
.\create-work-log.ps1 -Title "Lambda関数の実装" -Task "タスク1.1" -Open
```

**スクリプトの機能:**
- ✅ 現在時刻（JST）を自動取得
- ✅ テンプレートから新しい作業記録ファイルを作成
- ✅ ファイル名は `work-log-[YYYYMMDD-HHMMSS].md` 形式
- ✅ タイトルとタスク番号を自動挿入（オプション）
- ✅ 作成後にエディタで開く（オプション）
- ✅ UTF-8エンコーディング（BOMなし）で保存

**対応エディタ（-Openオプション使用時）:**
1. VS Code（優先）
2. Notepad++
3. メモ帳（デフォルト）

**実行例:**
```powershell
# 例1: 基本的な使用
PS> .\create-work-log.ps1
作業記録を作成します...
ファイル名: work-log-20260207-143025.md
作成日時: 2026-02-07 14:30:25 JST

作業記録ファイルを作成しました！
ファイルパス: C:\...\work-logs\work-log-20260207-143025.md

# 例2: タイトルとタスク番号を指定
PS> .\create-work-log.ps1 -Title "エラーハンドリング改善" -Task "タスク2.3"
作業記録を作成します...
ファイル名: work-log-20260207-143530.md
作成日時: 2026-02-07 14:35:30 JST
タイトル: エラーハンドリング改善
関連タスク: タスク2.3

作業記録ファイルを作成しました！
```

### 手動で作成

スクリプトを使用しない場合は、以下の手順で作成できます：

```powershell
# 現在時刻を取得
$timestamp = Get-Date -Format "yyyyMMdd-HHmmss"

# テンプレートをコピーして新しいファイルを作成
Copy-Item ".kiro/specs/tdnet-data-collector/work-logs/work-log-template.md" `
          ".kiro/specs/tdnet-data-collector/work-logs/work-log-$timestamp.md"
```

## 作業記録作成のタイミング

### 1. タスク開始時

作業記録ファイルを作成し、作業概要を記入：

```powershell
# PowerShellスクリプトを使用
.\create-work-log.ps1 -Title "タスクのタイトル" -Task "タスク番号" -Open
```

### 2. 作業中

実施内容を随時更新：
- 変更したファイル
- 実行したコマンド
- 実施した作業の詳細

### 3. 問題発生時

問題と解決策を記録：
- 問題の状況
- 原因の分析
- 実施した解決策

### 4. タスク完了時

成果物と次回への申し送りを記入：
- 作成・更新したファイル一覧
- 実行結果のサマリー
- 次回作業時の注意点

## 作業記録の管理

### 基本原則

- **1つのタスクに1つの作業記録**: タスクごとに独立した作業記録を作成
- **継続作業の場合**: 新しい作業記録を作成し、前回の作業記録を参照
- **長期タスクの場合**: 日ごとまたは作業セッションごとに作業記録を作成

### ファイル整理

作業記録が増えてきた場合、年月ごとにサブフォルダを作成：

```
work-logs/
├── 2026-01/
│   ├── work-log-20260115-143025.md
│   └── work-log-20260120-150530.md
├── 2026-02/
│   ├── work-log-20260207-143025.md
│   └── work-log-20260215-150530.md
└── README.md
```

## 作業記録の活用

### 1. 振り返り

過去の作業内容を確認：
- 同じタスクを再度実施する際の参考
- 作業時間の見積もり
- 作業プロセスの改善

### 2. トラブルシューティング

類似問題の解決策を参照：
- 過去に発生した問題の解決策を検索
- 同じエラーの再発防止
- ナレッジベースとして活用

### 3. ナレッジ共有

チームメンバーへの情報共有：
- 新しいメンバーのオンボーディング
- ベストプラクティスの共有
- 作業手順の標準化

### 4. 改善提案

作業プロセスの改善点を特定：
- 繰り返し発生する問題の特定
- 自動化可能な作業の洗い出し
- steeringファイルの更新提案

## 作業記録と改善記録の違い

### 比較表

| 項目 | 作業記録（work-logs/） | 改善記録（improvements/） |
|------|----------------------|------------------------|
| **目的** | タスク実行の履歴を記録 | 継続的改善の記録 |
| **作成タイミング** | タスク実行中（開始時に作成） | タスク完了後（フィードバックループ時） |
| **記録内容** | 実施した作業、問題と解決策、成果物 | 問題点の分析、改善点の特定、改善結果 |
| **対象タスク** | すべてのタスク（必須） | 改善が必要なタスク（任意） |
| **視点** | 「何をしたか」（What） | 「なぜ問題が起きたか、どう改善するか」（Why & How） |
| **粒度** | 作業の詳細記録 | 問題の根本原因分析と改善策 |
| **頻度** | タスクごとに1つ | 必要に応じて複数回 |

### ワークフローフローチャート

```
┌─────────────────┐
│ タスク開始      │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────┐
│ 【作業記録作成】            │
│ work-log-[日時].md を作成   │
│ - 作業概要を記入            │
│ - 実施内容を随時更新        │
│ - 問題と解決策を記録        │
└────────┬────────────────────┘
         │
         ▼
┌─────────────────┐
│ タスク実行      │
│ （作業記録更新）│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ タスク完了      │
│ - 成果物記録    │
│ - 申し送り記入  │
└────────┬────────┘
         │
         ▼
    ┌────────┐
    │ 問題や  │
    │ 改善点  │ ───YES──┐
    │ あり？  │         │
    └────┬───┘         │
         │              │
         NO             ▼
         │    ┌──────────────────────────────┐
         │    │ 【フィードバックループ】      │
         │    │ 1. 実行結果の分析            │
         │    │ 2. 問題点の洗い出し          │
         │    │ 3. 改善点の特定              │
         │    │ 4. 改善の実施                │
         │    │ 5. 改善結果の検証            │
         │    └────────┬─────────────────────┘
         │             │
         │             ▼
         │    ┌──────────────────────────────┐
         │    │ 【改善記録作成】              │
         │    │ task-[番号]-improvement-     │
         │    │ [連番]-[日時].md を作成      │
         │    │ - 問題点の詳細分析           │
         │    │ - 改善策の記録               │
         │    │ - 影響範囲の文書化           │
         │    └────────┬─────────────────────┘
         │             │
         └─────────────┘
                       │
                       ▼
              ┌────────────────┐
              │ 次のタスクへ   │
              └────────────────┘
```

### 具体的な記録例

#### 例1: 問題なくタスクが完了した場合

**作業記録のみ作成:**

```
work-logs/work-log-20260207-143025.md
├─ 作業概要: Lambda関数の実装
├─ 実施内容: collector関数を実装
├─ 発生した問題: なし
├─ 成果物: src/lambda/collector/handler.ts
└─ 次回への申し送り: テストの追加が必要

→ 改善記録は作成しない（問題がないため）
```

#### 例2: 問題が発生し、改善が必要な場合

**作業記録 + 改善記録を作成:**

```
work-logs/work-log-20260207-143025.md
├─ 作業概要: Lambda関数の実装
├─ 実施内容: collector関数を実装
├─ 発生した問題: エラーハンドリングが不十分
├─ 成果物: src/lambda/collector/handler.ts
└─ 次回への申し送り: エラーハンドリングの改善が必要

↓ フィードバックループ

improvements/task-1.1-improvement-1-20260207-150530.md
├─ 問題点: エラーハンドリングが不十分
│   - 再試行ロジックがない
│   - エラーログが構造化されていない
├─ 改善内容:
│   - retryWithBackoff()関数を実装
│   - 構造化ログを導入
│   - error-handling-patterns.mdを更新
├─ 影響範囲:
│   - steering: error-handling-patterns.md更新
│   - コード: src/utils/error-handling.ts追加
└─ 検証結果: テストカバレッジ95%達成
```

#### 例3: 複数回の改善が必要な場合

**作業記録 + 複数の改善記録:**

```
work-logs/work-log-20260207-143025.md
└─ 初回実装

↓ 1回目の改善

improvements/task-1.1-improvement-1-20260207-150530.md
└─ エラーハンドリングの改善

↓ 2回目の改善（パフォーマンス問題発見）

improvements/task-1.1-improvement-2-20260207-163045.md
└─ パフォーマンス最適化
    - メモリ使用量削減
    - 実行時間短縮
```

### いつ改善記録を作成すべきか

#### 改善記録を作成する場合 ✅

| 状況 | 説明 |
|------|------|
| **問題が発見された** | バグ、エラー、非効率なコード |
| **設計の改善が必要** | アーキテクチャの見直し、リファクタリング |
| **要件の不明確さ** | 要件定義書の更新が必要 |
| **テストの不足** | テストカバレッジ不足、エッジケース未対応 |
| **ドキュメントの不整合** | steeringファイルと実装の乖離 |
| **パフォーマンス問題** | 実行時間、メモリ使用量、コスト |
| **セキュリティ懸念** | 脆弱性、権限設定の問題 |

#### 改善記録を作成しない場合 ❌

| 状況 | 説明 |
|------|------|
| **問題なく完了** | 計画通りに実装が完了 |
| **軽微な修正のみ** | タイポ修正、コメント追加など |
| **単純な作業** | ファイルコピー、設定変更など |

### 判断フローチャート

```
タスク完了
    ↓
┌──────────────────┐
│ 以下のいずれかに │
│ 該当するか？     │
│                  │
│ □ バグ発見       │
│ □ 設計改善必要   │
│ □ 要件不明確     │
│ □ テスト不足     │
│ □ ドキュメント   │
│   不整合         │
│ □ パフォーマンス │
│   問題           │
│ □ セキュリティ   │
│   懸念           │
└────┬─────────────┘
     │
     ├─YES→ 改善記録を作成
     │       improvements/task-X.X-improvement-N-[日時].md
     │
     └─NO──→ 作業記録のみで完了
             work-logs/work-log-[日時].md
```

### 関係性の詳細

**作業記録 → 改善記録の流れ:**

1. **作業記録で問題を発見**
   ```markdown
   ## 発生した問題と解決策
   
   ### 問題1: エラーハンドリングが不十分
   
   **状況:** Lambda関数でネットワークエラーが発生すると即座に失敗する
   **原因:** 再試行ロジックが実装されていない
   **解決策:** 一時的に手動で再実行（根本的な解決ではない）
   ```

2. **フィードバックループで根本原因を分析**
   - なぜこの問題が発生したのか？
   - 他にも同様の問題はないか？
   - どのように改善すべきか？

3. **改善記録で改善策を文書化**
   ```markdown
   ## 問題点
   
   - エラーハンドリングが不十分（再試行ロジックなし）
   - 他のLambda関数も同様の問題を抱えている可能性
   
   ## 改善内容
   
   - 汎用的な再試行ユーティリティを実装
   - error-handling-patterns.mdに再試行戦略を追加
   - すべてのLambda関数に適用
   
   ## 影響範囲
   
   - steering: error-handling-patterns.md更新
   - コード: src/utils/error-handling.ts追加
   - コード: すべてのLambda関数を更新
   ```

**重要:** 作業記録は「その場の対処」、改善記録は「根本的な解決」を記録します。

## 作業記録テンプレート

新しい作業記録を作成する際は、以下のテンプレートを使用してください：

```markdown
# 作業記録 - [作業タイトル]

**作成日時**: 2026-02-07 14:30:25 JST
**作業者**: Kiro AI Assistant
**関連タスク**: タスク1.1 - Lambda関数の実装

## 作業概要

Lambda関数のエラーハンドリングを改善し、再試行ロジックを実装する。

## 実施内容

### 1. エラーハンドリングユーティリティの作成

- `src/utils/error-handling.ts` を作成
- `RetryableError` クラスを実装
- `retryWithBackoff()` 関数を実装

**変更ファイル:**
- `src/utils/error-handling.ts` (新規作成)

**実行コマンド:**
```bash
npm run test -- error-handling.test.ts
```

### 2. Lambda関数への適用

- `src/lambda/collector/handler.ts` を更新
- エラーハンドリングユーティリティを適用
- ログ出力を構造化

**変更ファイル:**
- `src/lambda/collector/handler.ts` (更新)

## 発生した問題と解決策

### 問題1: TypeScriptの型エラー

**状況:**
`retryWithBackoff()` 関数の型定義でジェネリクスのエラーが発生。

**原因:**
Promise型の推論が正しく行われていなかった。

**解決策:**
明示的に `Promise<T>` を返すように型定義を修正。

```typescript
async function retryWithBackoff<T>(
    fn: () => Promise<T>,
    options?: RetryOptions
): Promise<T> {
    // ...
}
```

## 成果物

- `src/utils/error-handling.ts` - エラーハンドリングユーティリティ
- `src/utils/error-handling.test.ts` - ユニットテスト
- `src/lambda/collector/handler.ts` - 更新されたLambda関数

**テスト結果:**
- ユニットテスト: 15/15 passed
- カバレッジ: 95%

## 次回への申し送り

- 他のLambda関数にも同じエラーハンドリングを適用する
- サーキットブレーカーパターンの実装を検討
- エラーログの集約とアラート設定を追加

## 参考情報

- `error-handling-patterns.md` - エラーハンドリングのベストプラクティス
- AWS Lambda エラーハンドリング: https://docs.aws.amazon.com/lambda/latest/dg/nodejs-exceptions.html
```

## 関連ドキュメント

- **タスク実行ルール**: `.kiro/steering/core/tdnet-data-collector.md` - タスク実行とフィードバックループの詳細
- **改善記録**: `.kiro/specs/tdnet-data-collector/improvements/README.md` - 改善記録の作成方法と使い分け
- **実装ルール**: `.kiro/steering/core/tdnet-implementation-rules.md` - 基本的な実装原則

**重要:** 作業記録と改善記録の使い分けについては、上記の「作業記録と改善記録の違い」セクションと、改善記録のREADME.mdを参照してください。

## 変更履歴

- 2026-02-07: 初版作成
- 2026-02-07: 作業記録と改善記録の違いセクションを強化（フローチャート、具体例、判断基準を追加）
