# 作業記録: OpenAPI仕様の分離

**作成日時:** 2026-02-07 17:11:03

## タスク概要

### 目的
`.kiro/steering/api/api-design-guidelines.md`から長大なOpenAPI仕様（約600行）を分離し、保守性とトークン効率を向上させる。

### 背景
- `api-design-guidelines.md`が非常に長大（約1000行）
- OpenAPI仕様が約600行を占めている
- トークン消費が大きく、ファイルの可読性が低下
- OpenAPI仕様は独立したファイルとして管理すべき

### 目標
1. OpenAPI仕様セクションを`api-design-guidelines.md`から抽出
2. `docs/openapi.yaml`として新規作成（docsフォルダも作成）
3. `api-design-guidelines.md`に参照リンクを追加
4. 作業記録を作成し、Gitにコミット

## 実施内容

### 1. 現在のファイル構造の確認

- `.kiro/steering/api/api-design-guidelines.md`を読み込み（1375行）
- OpenAPI仕様セクションを特定（437-1355行、約918行）
- ファイルが非常に長大で、トークン消費が大きいことを確認

### 2. OpenAPI仕様の抽出と新規ファイル作成

**作成ファイル:** `docs/openapi.yaml`

- OpenAPI 3.0仕様を完全に抽出
- YAML形式で保存（約870行）
- 以下の内容を含む：
  - サーバー定義（Production, Development）
  - 認証方式（APIキー認証）
  - 8つのエンドポイント定義
    - GET /disclosures（一覧取得）
    - GET /disclosures/{id}（詳細取得）
    - GET /disclosures/{id}/pdf（PDF URL取得）
    - POST /collect（データ収集開始）
    - GET /collect/{execution_id}（収集状態取得）
    - POST /exports（エクスポート開始）
    - GET /exports/{export_id}（エクスポート状態取得）
    - GET /health（ヘルスチェック）
    - GET /stats（統計情報取得）
  - 14のスキーマ定義
    - Disclosure, DisclosureDetail, PaginationMeta
    - DisclosureListResponse, DisclosureDetailResponse, PDFUrlResponse
    - CollectionRequest, CollectionResponse, CollectionStatusResponse
    - ExportRequest, ExportResponse, ExportStatusResponse
    - HealthResponse, StatsResponse, ErrorResponse
  - 5つのエラーレスポンス定義
    - BadRequest, Unauthorized, NotFound, TooManyRequests, InternalError

### 3. api-design-guidelines.mdの更新

**変更内容:**
- OpenAPI仕様セクション（約918行）を削除
- 新しい参照セクションに置き換え（約30行）
- 以下の情報を追加：
  - ファイルパス（`../../docs/openapi.yaml`）
  - 含まれる内容の概要
  - 使用方法（Swagger UI、バリデーション、コード生成）

**削減効果:**
- 約888行を削減（918行 → 30行）
- トークン消費を大幅に削減
- ファイルの可読性が向上

### 4. 問題と解決策

**問題:** なし

**解決策:** なし


## 成果物

### 作成したファイル

1. **docs/openapi.yaml** (新規作成)
   - OpenAPI 3.0仕様の完全定義
   - 約870行のYAML形式
   - すべてのエンドポイント、スキーマ、エラーレスポンスを含む

### 変更したファイル

1. **.kiro/steering/api/api-design-guidelines.md**
   - OpenAPI仕様セクション（約918行）を削除
   - 新しい参照セクション（約30行）に置き換え
   - 使用方法（Swagger UI、バリデーション、コード生成）を追加
   - 約888行を削減

### 効果

- **トークン削減**: api-design-guidelines.mdのサイズを約64%削減（1375行 → 487行）
- **保守性向上**: OpenAPI仕様が独立したファイルとして管理可能
- **可読性向上**: api-design-guidelines.mdがより簡潔で読みやすくなった
- **再利用性向上**: openapi.yamlを他のツール（Swagger UI、コード生成）で直接利用可能

## 次回への申し送り

### 完了事項

- ✅ OpenAPI仕様を`docs/openapi.yaml`に分離
- ✅ `api-design-guidelines.md`を更新して参照リンクを追加
- ✅ 作業記録を作成

### 未完了事項

なし（すべて完了）

### 注意点

- `docs/openapi.yaml`は今後、API仕様の変更時に更新が必要
- `api-design-guidelines.md`の参照リンクは相対パス（`../../docs/openapi.yaml`）を使用
- OpenAPI仕様の検証には`@apidevtools/swagger-cli`の使用を推奨

### 推奨される次のステップ

1. OpenAPI仕様の検証を実行
   ```bash
   npx @apidevtools/swagger-cli validate docs/openapi.yaml
   ```

2. Swagger UIでの表示確認
   ```bash
   npx swagger-ui-watcher docs/openapi.yaml
   ```

3. 必要に応じてTypeScriptクライアントコードを生成
   ```bash
   npx openapi-generator-cli generate -i docs/openapi.yaml -g typescript-axios -o src/generated/api-client
   ```
