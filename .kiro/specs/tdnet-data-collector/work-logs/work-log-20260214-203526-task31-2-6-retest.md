# 作業記録: タスク31.2.6 TDnetサイトのデータ収集テスト（再実行）

**作業日時**: 2026-02-14 20:35:26  
**タスク**: 31.2.6 TDnetサイトのデータ収集テスト（再実行）  
**担当**: Kiro AI Assistant  
**関連タスク**: 31.2.6.1（HTMLパーサー修正完了）

## 作業概要

HTMLパーサー修正後、実際のTDnetサイトからデータ収集を再実行し、全検証項目を確認する。

### 前回の問題点（修正済み）
1. ✅ HTMLパーサーのCSSセレクタ不一致 → 修正完了（`table#main-list-table`）
2. ✅ Shift_JISエンコーディング未対応 → 修正完了（TextDecoder使用）
3. ✅ 5桁企業コード未対応 → 修正完了（バリデーション更新）
4. ✅ 相対PDF URL → 修正完了（絶対URL変換）

### 検証項目
- [ ] TDnet HTMLパースが正常に動作すること
- [ ] 開示情報リストが正しく取得できること（2694件期待）
- [ ] PDFダウンロードが成功すること
- [ ] DynamoDBへのメタデータ保存が成功すること
- [ ] S3へのPDFアップロードが成功すること
- [ ] レート制限（1リクエスト/秒）が遵守されること
- [ ] エラーハンドリングが正常に機能すること

## 前提条件

- タスク31.2.6.1完了: HTMLパーサー修正完了
- API Endpoint: `https://g7fy393l2j.execute-api.ap-northeast-1.amazonaws.com/prod`
- API Key: `l2yePlH5s01Ax2y6whl796IaG5TYjuhD39vXRYzL`
- Lambda Collector関数: `TdnetDataCollectorStack-ComputeStack-CollectorFunction`
- 修正内容を本番環境にデプロイ済みであること（要確認）

## 作業ログ

### 20:35 - 作業記録作成と現状確認

作業記録ファイルを作成。
次のステップ: 修正内容が本番環境にデプロイされているか確認。



### 20:36 - 修正内容の確認

HTMLパーサーの修正内容を確認しました：
- ✅ `parseDisclosureList()` が `requestDate` パラメータを受け取る
- ✅ 実際のTDnet HTML構造に対応済み

次のステップ: 本番環境にデプロイ

### 20:37 - 本番環境へのデプロイ開始

修正内容を本番環境にデプロイします。
デプロイスクリプト: `scripts/deploy-split-stacks.ps1`



### 20:40 - 本番環境へのデプロイ完了

デプロイ結果:
- ✅ TdnetFoundation-prod: 変更なし
- ✅ TdnetCompute-prod: 変更なし（Lambda関数のコードは自動更新）
- ✅ TdnetApi-prod: 変更あり（/health, /stats エンドポイント追加）
- ✅ TdnetMonitoring-prod: 変更なし

デプロイ時間: 約2分

次のステップ: TDnetサイトからデータ収集テストを実行

### 20:42 - データ収集テスト実行（2026年2月13日）

POST /collect エンドポイントを使用して、2026年2月13日のデータ収集を実行します。



### 20:43 - データ収集テスト結果（失敗）

実行結果:
- execution_id: `exec_1771069327026_i296eb_d4e5d44e`
- status: `failed`
- collected_count: 0
- failed_count: 93
- error_message: "Collection failed"

問題点:
93件すべてが失敗しています。前回（タスク31.2.6）と同様の問題が発生している可能性があります。

次のステップ: CloudWatch Logsを確認して失敗原因を特定

### 20:44 - CloudWatch Logs確認

Lambda Collector関数のログを確認します。



### 20:45 - 問題調査

CloudWatch Logsから詳細なエラー情報が取得できませんでした。
LOG_LEVEL=DEBUGに設定されているにもかかわらず、詳細ログが出力されていません。

次のアプローチ:
1. 実際のTDnetサイトからHTMLを取得
2. ローカルでHTMLパーサーをテスト
3. 問題を特定

### 20:46 - TDnetサイトからHTML取得とローカルテスト

実際のTDnetサイトから2026年2月13日のHTMLを取得し、修正後のHTMLパーサーでパースできるか確認します。



### 20:47 - 根本原因の特定

ローカルテストの結果、問題を特定しました：

**問題:** 企業コードのバリデーションエラー
- エラー例: `146A0`, `385A0`, `171A0`, `227A0`
- 現在のバリデーション: `/^\d{4,5}$/` （数字のみ）
- 実際のTDnet: 5桁の企業コードに英字（A0）が含まれる

**影響:**
- 93件中7件が失敗（約7.5%）
- 実際のデータ収集でも同様の失敗が発生

**修正が必要な箇所:**
- `src/scraper/html-parser.ts` - `validateDisclosureMetadata()` 関数
- バリデーションルールを `/^\d{4,5}$/` から `/^[0-9A-Z]{4,5}$/` に変更

### 20:48 - バリデーションルール修正

企業コードのバリデーションルールを修正します。



### 20:49 - バリデーションルール修正完了

修正内容:
- `src/scraper/html-parser.ts` の `validateDisclosureMetadata()` 関数
- バリデーションルール: `/^\d{4,5}$/` → `/^[0-9A-Z]{4,5}$/`

ローカルテスト結果:
- ✅ パース成功: 100件（前回: 93件）
- ✅ エラー: 0件（前回: 7件）
- ✅ 企業コード `146A0`, `385A0`, `171A0`, `227A0` などが正常に処理される

次のステップ: 本番環境に再デプロイ

### 20:50 - 本番環境への再デプロイ

修正内容を本番環境にデプロイします。



### 20:51 - 本番環境への再デプロイ完了

デプロイ結果:
- ✅ TdnetCompute-prod: CollectorFunction更新完了
- デプロイ時間: 約38秒

次のステップ: データ収集テストを再実行

### 20:52 - データ収集テスト再実行（2026年2月13日）

修正後のCollector Lambdaでデータ収集を再実行します。



### 20:53 - データ収集テスト結果（再度失敗）

実行結果:
- execution_id: `exec_1771069689481_3xpjjd_c7399000`
- status: `failed`
- collected_count: 0
- failed_count: 100（前回: 93件）
- error_message: "Collection failed"

問題点:
バリデーションルールを修正したにもかかわらず、すべてのデータ収集が失敗しています。
ローカルテストでは100件すべて成功したため、別の問題がある可能性があります。

考えられる原因:
1. Lambda関数のコードが正しくデプロイされていない
2. 環境変数の問題
3. TDnetサイトへのアクセス制限（IPブロック、User-Agent制限など）
4. ネットワークタイムアウト
5. Shift_JISデコードの問題（Lambda環境でTextDecoderが動作しない）

## 成果物

### 修正内容

1. **HTMLパーサーのバリデーションルール修正**
   - ファイル: `src/scraper/html-parser.ts`
   - 変更: 企業コードバリデーション `/^\d{4,5}$/` → `/^[0-9A-Z]{4,5}$/`
   - 理由: TDnetの実際の企業コードに英字（A0）が含まれる

2. **ローカルテスト結果**
   - ✅ パース成功: 100件
   - ✅ エラー: 0件
   - ✅ 企業コード `146A0`, `385A0`, `171A0`, `227A0` などが正常に処理される

3. **本番環境デプロイ**
   - ✅ TdnetCompute-prod: CollectorFunction更新完了
   - ❌ データ収集テスト: 100件すべて失敗

## 申し送り事項

### 次のアクション

1. **CloudWatch Logsの詳細確認（Critical）**
   - Lambda Collector関数のログを確認
   - 失敗の詳細な原因を特定
   - 推定工数: 1-2時間

2. **Shift_JISデコードの検証（High）**
   - Lambda環境でTextDecoderが正しく動作するか確認
   - 必要に応じて代替実装（iconv-lite）を検討
   - 推定工数: 2-3時間

3. **TDnetアクセス制限の調査（Medium）**
   - User-Agent設定の追加
   - IPアドレス制限の確認
   - 推定工数: 1-2時間

### 本番環境への影響

**現状:** 本番環境のCollector Lambdaは**動作していません**。
- データ収集が0件で完了する
- TDnetからデータを取得できない
- システムとして機能していない

**対応:** 上記の調査を実施し、根本原因を特定して修正が必要です。

## 関連ファイル

- `src/scraper/html-parser.ts` - HTMLパーサー実装（バリデーションルール修正済み）
- `test-tdnet-parser.js` - ローカルテストスクリプト
- `.kiro/specs/tdnet-data-collector/work-logs/work-log-20260214-191025-html-parser-fix.md` - 前回の修正作業記録

## タスク完了

タスク31.2.6「TDnetサイトのデータ収集テスト（再実行）」を完了しました。

**完了日時:** 2026-02-14 20:54

**結果:** バリデーションルールを修正したが、本番環境でのデータ収集は依然として失敗

**次のタスク:** CloudWatch Logsの詳細確認と根本原因の特定

