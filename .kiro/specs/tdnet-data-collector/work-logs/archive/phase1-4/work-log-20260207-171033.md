# 作業記録: CloudWatch監視の最適化（カスタムメトリクス削減）

**作成日時:** 2026-02-07 17:10:33  
**タスク:** Issue 7 - CloudWatch監視の最適化（カスタムメトリクス削減）

---

## タスク概要

### 目的
カスタムメトリクスを削減し、Lambda標準メトリクスを活用することで、CloudWatch監視コストを70%削減する。

### 背景
- 現在10個のカスタムメトリクスが定義されており、月額$3.00のコストが発生
- 個人利用のプロジェクトでは、このコストは不要
- Lambda標準メトリクスで十分な情報が取得可能

### 目標
- カスタムメトリクスを3個以下に削減
- Lambda標準メトリクスの活用を明記
- コスト削減効果を記載（$3.00/月 → $0.90/月）

---

## 実施計画

1. design.mdの現状確認
2. カスタムメトリクスセクションの修正
   - 削減後のカスタムメトリクス（3個）を定義
   - Lambda標準メトリクスの活用を明記
   - 削除するメトリクスのリストを記載
3. コスト削減効果の記載
4. 作業記録の完成とコミット

---

## 実施内容

### 1. design.mdの確認

**確認結果:**
- 現在のカスタムメトリクス（4個）:
  - `CollectedDisclosuresCount`: 収集件数
  - `FailedDisclosuresCount`: 失敗件数
  - `ScrapingDuration`: スクレイピング時間
  - `PDFDownloadDuration`: PDFダウンロード時間

**問題点:**
- metrics-and-kpi.mdには10個のカスタムメトリクスが定義されている
- design.mdには4個のみ記載されているが、実際の実装では10個使用される可能性がある
- コスト試算: 10個 × $0.30/月 = $3.00/月

### 2. カスタムメトリクスの削減方針

**削減後のカスタムメトリクス（3個）:**
1. `DisclosuresCollected`: 日次収集件数（ビジネスメトリクス）
2. `DisclosuresFailed`: 失敗件数（ビジネスメトリクス）
3. `CollectionSuccessRate`: 成功率（ビジネスメトリクス）

**Lambda標準メトリクスで代替:**
- `Invocations`: Lambda実行回数
- `Errors`: エラー回数
- `Duration`: 実行時間（ScrapingDuration、PDFDownloadDurationの代替）
- `Throttles`: スロットリング

**削除するカスタムメトリクス（7個）:**
- `ScrapingDuration` → Lambda `Duration`で代替
- `PDFDownloadDuration` → Lambda `Duration`で代替
- `DynamoDBWriteUnits` → DynamoDB標準メトリクスで代替
- `S3PutRequests` → S3標準メトリクスで代替
- `DuplicateDetectionCount` → ログで記録（メトリクス不要）
- `DataIntegrityErrors` → ログで記録（メトリクス不要）
- `Throughput` → Lambda `Invocations`で代替

**コスト削減効果:**
- 削減前: 10個 × $0.30/月 = $3.00/月
- 削減後: 3個 × $0.30/月 = $0.90/月
- **削減額: $2.10/月（70%削減）**

### 3. design.mdの修正

**修正箇所1: CloudWatch Logs & Metricsセクション**
- カスタムメトリクスを3個に削減
- Lambda標準メトリクスの活用を明記
- DynamoDB標準メトリクスの活用を明記
- S3標準メトリクスの活用を明記
- コスト削減効果を記載

**修正箇所2: publishBusinessMetrics関数**
- 実装例にコメントを追加
- Lambda標準メトリクスの活用方法を明記
- DynamoDB標準メトリクスの活用方法を明記
- S3標準メトリクスの活用方法を明記

---

## 成果物

### 修正ファイル
1. `.kiro/specs/tdnet-data-collector/docs/design.md`
   - CloudWatch Logs & Metricsセクションを更新
   - publishBusinessMetrics関数の実装例を更新

### 削減効果
- **カスタムメトリクス数**: 10個 → 3個（70%削減）
- **月額コスト**: $3.00/月 → $0.90/月（$2.10削減）
- **年間コスト削減**: $25.20/年

### 削減後のカスタムメトリクス
1. `DisclosuresCollected`: 日次収集件数
2. `DisclosuresFailed`: 失敗件数
3. `CollectionSuccessRate`: 成功率（%）

### Lambda標準メトリクスで代替
- `Invocations`: Lambda実行回数
- `Errors`: エラー回数
- `Duration`: 実行時間（ScrapingDuration、PDFDownloadDurationの代替）
- `Throttles`: スロットリング
- `ConcurrentExecutions`: 同時実行数

### DynamoDB標準メトリクスで代替
- `ConsumedReadCapacityUnits`: 読み取りキャパシティ消費
- `ConsumedWriteCapacityUnits`: 書き込みキャパシティ消費
- `UserErrors`: ユーザーエラー
- `SystemErrors`: システムエラー

### S3標準メトリクスで代替
- `AllRequests`: すべてのリクエスト
- `PutRequests`: PUT/POST/COPYリクエスト
- `GetRequests`: GETリクエスト
- `BytesUploaded`: アップロードバイト数
- `BytesDownloaded`: ダウンロードバイト数

---

## 次回への申し送り

### 完了事項
- ✅ design.mdのCloudWatch監視設定を最適化
- ✅ カスタムメトリクスを3個に削減
- ✅ Lambda標準メトリクスの活用を明記
- ✅ コスト削減効果を記載（70%削減）

### 注意事項
- 実装時は、Lambda標準メトリクスを優先的に活用すること
- カスタムメトリクスは、ビジネスメトリクス（収集件数、失敗件数、成功率）のみに限定
- DynamoDB、S3の標準メトリクスも活用し、カスタムメトリクスの追加を避けること

### 今後の課題
- metrics-and-kpi.mdも同様に更新する必要がある（別タスク）
- monitoring-alerts.mdのアラーム設定も見直す必要がある（別タスク）
