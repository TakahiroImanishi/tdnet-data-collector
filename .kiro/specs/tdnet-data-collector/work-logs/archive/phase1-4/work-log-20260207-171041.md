# 作業記録: Lambda関数のタイムアウト設定の最適化

**作成日時:** 2026-02-07 17:10:41  
**タスク:** Issue 9 - Lambda関数のタイムアウト設定の最適化

---

## タスク概要

### 目的
Lambda関数のタイムアウト設定を、各関数の実際の処理時間に応じて最適化する。

### 背景
- 現在、すべてのLambda関数のタイムアウトが15分に設定されている
- Query/Export関数は数秒～数分で完了するはずなのに、15分のタイムアウトは過剰
- タイムアウトが長すぎると、エラー検出が遅れ、コストも増加する可能性がある

### 目標
- Collector関数: 15分（変更なし） - データ収集処理は長時間かかる
- Query関数: 30秒に短縮 - DynamoDBクエリは通常数秒で完了
- Export関数: 5分に短縮 - 大量データのエクスポートでも5分で十分

---

## 実施内容

### 1. 現在の設計ドキュメントの確認
- `.kiro/specs/tdnet-data-collector/docs/design.md` を確認
- 現在のタイムアウト設定を把握
- すべてのLambda関数が同じタイムアウト（15分）を使用していることを確認

### 2. タイムアウト設定の修正
- `getConfig()` メソッドを更新:
  - `lambdaTimeout` を関数別に分割
  - `collectorTimeout`: 15分（本番）、5分（開発）
  - `queryTimeout`: 30秒（本番・開発共通）
  - `exportTimeout`: 5分（本番・開発共通）

- Lambda関数定義を更新:
  - Collector関数: `config.collectorTimeout` を使用
  - Query関数: `config.queryTimeout` を使用（新規追加）
  - Export関数: `config.exportTimeout` を使用（新規追加）

### 3. タイムアウト設定の根拠を追加
- Lambda関数のタイムアウト設定の根拠を説明する表を追加
- 各関数のタイムアウトの理由を明記
- タイムアウト設定のベストプラクティスを追加

### 4. 変更内容の検証
- 設定値が適切かどうかを確認
- ドキュメントの整合性を確認
- 各関数の処理時間に応じた適切なタイムアウトが設定されていることを確認

---

## 問題と解決策

**問題なし**: 設計ドキュメントの更新は順調に完了しました。

---

## 成果物

### 修正されたファイル
- `.kiro/specs/tdnet-data-collector/docs/design.md`
  - `getConfig()` メソッドを更新（関数別タイムアウト設定）
  - Lambda関数定義を更新（Collector、Query、Export）
  - タイムアウト設定の根拠を説明する表を追加

### 変更内容の詳細

**1. タイムアウト設定の最適化:**

| Lambda関数 | 変更前 | 変更後（本番） | 変更後（開発） | 理由 |
|-----------|--------|--------------|--------------|------|
| Collector | 15分 | 15分（変更なし） | 5分 | データ収集処理は長時間かかる |
| Query | 15分 | **30秒** | **30秒** | DynamoDBクエリは数秒で完了 |
| Export | 15分 | **5分** | **5分** | 大量データでも5分で十分 |

**2. 追加された説明:**
- Lambda関数のタイムアウト設定の根拠を説明する表
- タイムアウト設定のベストプラクティス
- 各関数の処理時間に応じた適切な設定の理由

---

## 次回への申し送り

### 完了事項
- ✅ design.mdのタイムアウト設定を最適化
- ✅ 関数ごとに適切なタイムアウトを設定
- ✅ タイムアウト設定の根拠を文書化

### 今後の対応
- 実際のCDKスタック実装時に、この設計を反映すること
- Lambda関数の実装時に、タイムアウト内で処理が完了することを確認すること
- パフォーマンステストで実際の処理時間を測定し、必要に応じてタイムアウトを調整すること

### 注意事項
- Query関数のタイムアウトを30秒に短縮したため、複雑なクエリでタイムアウトが発生しないか注意
- Export関数のタイムアウトを5分に短縮したため、大量データ（10,000件以上）のエクスポートで問題がないか確認
