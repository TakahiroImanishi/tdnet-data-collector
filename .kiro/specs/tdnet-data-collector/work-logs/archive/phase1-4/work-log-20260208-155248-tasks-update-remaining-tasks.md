# 作業記録: 残タスクの追加（15.21の前）

**作成日時**: 2026-02-08 15:52:48  
**作業概要**: 設計書レビューで発見された問題を残タスクとして15.21の前に追加

---

## タスク概要

### 目的
設計書レビュー（work-log-20260208-154432-design-document-review.md）で発見された問題を、Phase 2の残タスクとして15.21の前に追加する。

### 背景
- 設計書レビューで7つの差分を発見（うち5つは重大）
- セキュリティリスク（Critical）、未実装エンドポイント（High）、設計書更新（High）などの問題がある
- これらをPhase 2完了前に対応する必要がある

### 目標
- [x] 設計書レビューの発見事項を確認
- [x] 残タスクを15.14-15.20として追加
- [x] 15.21を最終確認タスクとして更新
- [x] tasks.mdをコミット

---

## 実施内容

### 追加した残タスク

#### 15.14 Query Lambdaのエラーレスポンス形式修正（Phase 2 High）
- 現状: `{ error_code, message, request_id }`
- 期待: `{ status: "error", error: { code, message, details }, request_id }`
- API設計ガイドラインに準拠

#### 15.15 環境分離の実装（Phase 2 High）
- 開発環境（dev）と本番環境（prod）の分離
- 環境ごとの設定（タイムアウト、メモリ、ログレベル）

#### 15.16 セキュリティリスクの修正（Phase 2 Critical）
- exportStatusFunctionとpdfDownloadFunctionのAPI Key環境変数設定を修正
- `unsafeUnwrap()`の使用を避け、Secrets Manager経由で取得

#### 15.17 アーキテクチャ設計書の更新（Phase 2 High）
- Lambda関数リストを7個に更新
- date_partitionの形式を`YYYY-MM`に統一
- DynamoDB GSI名を`GSI_DatePartition`に修正

#### 15.18 未実装エンドポイントの実装（Phase 2 High）
- GET /disclosures/{id}
- GET /health
- GET /stats

#### 15.19 認証方式の統一（Phase 2 High）
- POST /collect と GET /collect/{execution_id} にAPIキー認証を追加
- すべてのハンドラーでSecrets Manager経由の認証に統一

#### 15.20 ページネーション方式の統一（Phase 2 Medium）
- カーソルベース（`next_token`）とオフセットベース（`offset`）のどちらを採用するか決定

#### 15.21 Phase 2完了確認（最終）
- セキュリティリスクが修正されていることを確認（追加）
- その他の既存確認項目

### 既存タスクの番号変更

元の15.16-15.20を新しい番号に変更：
- 旧15.16 → 新15.22（日付バリデーションのエラーハンドリング改善）
- 旧15.17 → 新15.23（Branchesカバレッジの改善）
- 旧15.18 → 新15.24（Property 14の実装）
- 旧15.19 → 新15.25（CloudFront OAIの実装）
- 旧15.20 → 新15.26（CORS設定の環境別制限）

---

## 成果物

### 更新したファイル
- `.kiro/specs/tdnet-data-collector/tasks.md` - 残タスクを追加

### 追加したタスク数
- 7個の新規タスク（15.14-15.20）
- 1個の更新タスク（15.21）

---

## 次回への申し送り

### 優先度別の対応順序

**🔴 Critical（即座に対応）:**
1. タスク15.16: セキュリティリスクの修正

**🟠 High（Phase 2完了前に対応）:**
2. タスク15.14: Query Lambdaのエラーレスポンス形式修正
3. タスク15.15: 環境分離の実装
4. タスク15.17: アーキテクチャ設計書の更新
5. タスク15.18: 未実装エンドポイントの実装
6. タスク15.19: 認証方式の統一

**🟡 Medium（Phase 3で対応可能）:**
7. タスク15.20: ページネーション方式の統一
8. タスク15.22-15.26: その他の改善タスク

### 注意点
- タスク15.16（セキュリティリスク）は最優先で対応すること
- タスク15.21（Phase 2完了確認）は、すべての残タスク完了後に実施
- Phase 3移行前に、Critical/Highタスクをすべて完了させること

---

**作業完了日時**: 2026-02-08 15:52:48
