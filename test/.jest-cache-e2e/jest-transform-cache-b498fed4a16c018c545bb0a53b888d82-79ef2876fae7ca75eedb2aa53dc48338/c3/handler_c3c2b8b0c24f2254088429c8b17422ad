5c1a5da9e5b403c564f57e05419a8268
"use strict";
/**
 * Lambda Collect Status Handler
 *
 * GET /collect/{execution_id} エンドポイントのハンドラー。
 * 実行状態をDynamoDBから取得して返却します。
 *
 * Requirements: タスク13.2
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const util_dynamodb_1 = require("@aws-sdk/util-dynamodb");
const logger_1 = require("../../utils/logger");
const cloudwatch_metrics_1 = require("../../utils/cloudwatch-metrics");
const errors_1 = require("../../errors");
// DynamoDB クライアントはグローバルスコープで初期化（再利用される）
const dynamoClient = new client_dynamodb_1.DynamoDBClient({ region: process.env.AWS_REGION || 'ap-northeast-1' });
// 環境変数
const EXECUTIONS_TABLE_NAME = process.env.DYNAMODB_EXECUTIONS_TABLE || 'tdnet_executions';
/**
 * Lambda Collect Status ハンドラー
 *
 * @param event API Gateway Proxy Event
 * @param context Lambda Context
 * @returns API Gateway Proxy Result
 */
async function handler(event, context) {
    try {
        logger_1.logger.info('GET /collect/{execution_id} invoked', {
            requestId: context.awsRequestId,
            functionName: context.functionName,
            pathParameters: event.pathParameters,
        });
        // パスパラメータの取得
        const execution_id = event.pathParameters?.execution_id;
        // バリデーション
        if (!execution_id) {
            throw new errors_1.ValidationError('execution_id is required');
        }
        // 実行状態を取得
        const executionStatus = await getExecutionStatus(execution_id);
        // レスポンス
        const response = {
            status: 'success',
            data: executionStatus,
        };
        logger_1.logger.info('GET /collect/{execution_id} completed', {
            requestId: context.awsRequestId,
            execution_id,
            status: executionStatus.status,
        });
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify(response),
        };
    }
    catch (error) {
        logger_1.logger.error('GET /collect/{execution_id} failed', (0, logger_1.createErrorContext)(error, {
            requestId: context.awsRequestId,
            event,
        }));
        // エラーメトリクス送信
        await (0, cloudwatch_metrics_1.sendErrorMetric)(error instanceof Error ? error.constructor.name : 'Unknown', 'CollectStatus', {});
        return toErrorResponse(error, event.requestContext.requestId);
    }
}
/**
 * 実行状態を取得
 *
 * @param execution_id 実行ID
 * @returns 実行状態
 * @throws NotFoundError 実行状態が存在しない場合
 */
async function getExecutionStatus(execution_id) {
    try {
        logger_1.logger.info('Getting execution status from DynamoDB', {
            execution_id,
            tableName: EXECUTIONS_TABLE_NAME,
        });
        const command = new client_dynamodb_1.GetItemCommand({
            TableName: EXECUTIONS_TABLE_NAME,
            Key: {
                execution_id: { S: execution_id },
            },
        });
        const result = await dynamoClient.send(command);
        if (!result.Item) {
            throw new errors_1.NotFoundError(`Execution not found: ${execution_id}`);
        }
        const item = (0, util_dynamodb_1.unmarshall)(result.Item);
        logger_1.logger.info('Execution status retrieved successfully', {
            execution_id,
            status: item.status,
            progress: item.progress,
        });
        return item;
    }
    catch (error) {
        if (error instanceof errors_1.NotFoundError) {
            throw error;
        }
        logger_1.logger.error('Failed to get execution status from DynamoDB', (0, logger_1.createErrorContext)(error, {
            execution_id,
            tableName: EXECUTIONS_TABLE_NAME,
        }));
        throw new Error('Failed to retrieve execution status');
    }
}
/**
 * エラーレスポンスを生成
 *
 * @param error Error
 * @param requestId リクエストID
 * @returns API Gateway Proxy Result
 */
function toErrorResponse(error, requestId) {
    const errorCodeMap = {
        ValidationError: { statusCode: 400, code: 'VALIDATION_ERROR' },
        UnauthorizedError: { statusCode: 401, code: 'UNAUTHORIZED' },
        ForbiddenError: { statusCode: 403, code: 'FORBIDDEN' },
        NotFoundError: { statusCode: 404, code: 'NOT_FOUND' },
        ConflictError: { statusCode: 409, code: 'CONFLICT' },
        RateLimitError: { statusCode: 429, code: 'RATE_LIMIT_EXCEEDED' },
        InternalError: { statusCode: 500, code: 'INTERNAL_ERROR' },
        ServiceUnavailableError: { statusCode: 503, code: 'SERVICE_UNAVAILABLE' },
        GatewayTimeoutError: { statusCode: 504, code: 'GATEWAY_TIMEOUT' },
    };
    const mapping = errorCodeMap[error.name] || {
        statusCode: 500,
        code: 'INTERNAL_ERROR',
    };
    return {
        statusCode: mapping.statusCode,
        headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
        },
        body: JSON.stringify({
            status: 'error',
            error: {
                code: mapping.code,
                message: error.message,
                details: error.details || {},
            },
            request_id: requestId,
        }),
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGNvbGxlY3Qtc3RhdHVzXFxoYW5kbGVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7OztHQU9HOztBQWlFSCwwQkE0REM7QUExSEQsOERBQTBFO0FBQzFFLDBEQUFvRDtBQUNwRCwrQ0FBZ0U7QUFDaEUsdUVBQWlFO0FBQ2pFLHlDQUE4RDtBQUU5RCx3Q0FBd0M7QUFDeEMsTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLGdCQUFnQixFQUFFLENBQUMsQ0FBQztBQUVoRyxPQUFPO0FBQ1AsTUFBTSxxQkFBcUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixJQUFJLGtCQUFrQixDQUFDO0FBNkMxRjs7Ozs7O0dBTUc7QUFDSSxLQUFLLFVBQVUsT0FBTyxDQUMzQixLQUEyQixFQUMzQixPQUFnQjtJQUVoQixJQUFJLENBQUM7UUFDSCxlQUFNLENBQUMsSUFBSSxDQUFDLHFDQUFxQyxFQUFFO1lBQ2pELFNBQVMsRUFBRSxPQUFPLENBQUMsWUFBWTtZQUMvQixZQUFZLEVBQUUsT0FBTyxDQUFDLFlBQVk7WUFDbEMsY0FBYyxFQUFFLEtBQUssQ0FBQyxjQUFjO1NBQ3JDLENBQUMsQ0FBQztRQUVILGFBQWE7UUFDYixNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsY0FBYyxFQUFFLFlBQVksQ0FBQztRQUV4RCxVQUFVO1FBQ1YsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ2xCLE1BQU0sSUFBSSx3QkFBZSxDQUFDLDBCQUEwQixDQUFDLENBQUM7UUFDeEQsQ0FBQztRQUVELFVBQVU7UUFDVixNQUFNLGVBQWUsR0FBRyxNQUFNLGtCQUFrQixDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRS9ELFFBQVE7UUFDUixNQUFNLFFBQVEsR0FBMEI7WUFDdEMsTUFBTSxFQUFFLFNBQVM7WUFDakIsSUFB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U0FBUztTQUN0QixDQUFDO0tBQ0gsQ0FBQztBQUNKLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGNvbGxlY3Qtc3RhdHVzXFxoYW5kbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBMYW1iZGEgQ29sbGVjdCBTdGF0dXMgSGFuZGxlclxyXG4gKlxyXG4gKiBHRVQgL2NvbGxlY3Qve2V4ZWN1dGlvbl9pZH0g44Ko44Oz44OJ44Od44Kk44Oz44OI44Gu44OP44Oz44OJ44Op44O844CCXHJcbiAqIOWun+ihjOeKtuaFi+OCkkR5bmFtb0RC44GL44KJ5Y+W5b6X44GX44Gm6L+U5Y2044GX44G+44GZ44CCXHJcbiAqXHJcbiAqIFJlcXVpcmVtZW50czog44K/44K544KvMTMuMlxyXG4gKi9cclxuXHJcbmltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQsIENvbnRleHQgfSBmcm9tICdhd3MtbGFtYmRhJztcclxuaW1wb3J0IHsgRHluYW1vREJDbGllbnQsIEdldEl0ZW1Db21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcclxuaW1wb3J0IHsgdW5tYXJzaGFsbCB9IGZyb20gJ0Bhd3Mtc2RrL3V0aWwtZHluYW1vZGInO1xyXG5pbXBvcnQgeyBsb2dnZXIsIGNyZWF0ZUVycm9yQ29udGV4dCB9IGZyb20gJy4uLy4uL3V0aWxzL2xvZ2dlcic7XHJcbmltcG9ydCB7IHNlbmRFcnJvck1ldHJpYyB9IGZyb20gJy4uLy4uL3V0aWxzL2Nsb3Vkd2F0Y2gtbWV0cmljcyc7XHJcbmltcG9ydCB7IFZhbGlkYXRpb25FcnJvciwgTm90Rm91bmRFcnJvciB9IGZyb20gJy4uLy4uL2Vycm9ycyc7XHJcblxyXG4vLyBEeW5hbW9EQiDjgq/jg6njgqTjgqLjg7Pjg4jjga/jgrDjg63jg7zjg5Djg6vjgrnjgrPjg7zjg5fjgafliJ3mnJ/ljJbvvIjlho3liKnnlKjjgZXjgozjgovvvIlcclxuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICdhcC1ub3J0aGVhc3QtMScgfSk7XHJcblxyXG4vLyDnkrDlooPlpInmlbBcclxuY29uc3QgRVhFQ1VUSU9OU19UQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuRFlOQU1PREJfRVhFQ1VUSU9OU19UQUJMRSB8fCAndGRuZXRfZXhlY3V0aW9ucyc7XHJcblxyXG4vKipcclxuICog5a6f6KGM54q25oWLXHJcbiAqL1xyXG5pbnRlcmZhY2UgRXhlY3V0aW9uU3RhdHVzIHtcclxuICAvKiog5a6f6KGMSUQgKi9cclxuICBleGVjdXRpb25faWQ6IHN0cmluZztcclxuXHJcbiAgLyoqIOOCueODhuODvOOCv+OCuSAqL1xyXG4gIHN0YXR1czogJ3BlbmRpbmcnIHwgJ3J1bm5pbmcnIHwgJ2NvbXBsZXRlZCcgfCAnZmFpbGVkJztcclxuXHJcbiAgLyoqIOmAsuaNl+eOh++8iDAtMTAw77yJICovXHJcbiAgcHJvZ3Jlc3M6IG51bWJlcjtcclxuXHJcbiAgLyoqIOWPjumbhuaIkOWKn+S7tuaVsCAqL1xyXG4gIGNvbGxlY3RlZF9jb3VudDogbnVtYmVyO1xyXG5cclxuICAvKiog5Y+O6ZuG5aSx5pWX5Lu25pWwICovXHJcbiAgZmFpbGVkX2NvdW50OiBudW1iZXI7XHJcblxyXG4gIC8qKiDplovlp4vml6XmmYLvvIhJU08gODYwMeW9ouW8j++8iSAqL1xyXG4gIHN0YXJ0ZWRfYXQ6IHN0cmluZztcclxuXHJcbiAgLyoqIOabtOaWsOaXpeaZgu+8iElTTyA4NjAx5b2i5byP77yJICovXHJcbiAgdXBkYXRlZF9hdDogc3RyaW5nO1xyXG5cclxuICAvKiog5a6M5LqG5pel5pmC77yISVNPIDg2MDHlvaLlvI/jgIFjb21wbGV0ZWQvZmFpbGVk44Gu5aC05ZCI44Gu44G/77yJICovXHJcbiAgY29tcGxldGVkX2F0Pzogc3RyaW5nO1xyXG5cclxuICAvKiog44Ko44Op44O844Oh44OD44K744O844K477yIZmFpbGVk44Gu5aC05ZCI44Gu44G/77yJICovXHJcbiAgZXJyb3JfbWVzc2FnZT86IHN0cmluZztcclxufVxyXG5cclxuLyoqXHJcbiAqIEdFVCAvY29sbGVjdC97ZXhlY3V0aW9uX2lkfSDjg6zjgrnjg53jg7PjgrlcclxuICovXHJcbmludGVyZmFjZSBDb2xsZWN0U3RhdHVzUmVzcG9uc2Uge1xyXG4gIC8qKiDjgrnjg4bjg7zjgr/jgrkgKi9cclxuICBzdGF0dXM6ICdzdWNjZXNzJztcclxuXHJcbiAgLyoqIOODh+ODvOOCvyAqL1xyXG4gIGRhdGE6IEV4ZWN1dGlvblN0YXR1cztcclxufVxyXG5cclxuLyoqXHJcbiAqIExhbWJkYSBDb2xsZWN0IFN0YXR1cyDjg4/jg7Pjg4njg6njg7xcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEFQSSBHYXRld2F5IFByb3h5IEV2ZW50XHJcbiAqIEBwYXJhbSBjb250ZXh0IExhbWJkYSBDb250ZXh0XHJcbiAqIEByZXR1cm5zIEFQSSBHYXRld2F5IFByb3h5IFJlc3VsdFxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhhbmRsZXIoXHJcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50LFxyXG4gIGNvbnRleHQ6IENvbnRleHRcclxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcclxuICB0cnkge1xyXG4gICAgbG9nZ2VyLmluZm8oJ0dFVCAvY29sbGVjdC97ZXhlY3V0aW9uX2lkfSBpbnZva2VkJywge1xyXG4gICAgICByZXF1ZXN0SWQ6IGNvbnRleHQuYXdzUmVxdWVzdElkLFxyXG4gICAgICBmdW5jdGlvbk5hbWU6IGNvbnRleHQuZnVuY3Rpb25OYW1lLFxyXG4gICAgICBwYXRoUGFyYW1ldGVyczogZXZlbnQucGF0aFBhcmFtZXRlcnMsXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyDjg5Hjgrnjg5Hjg6njg6Hjg7zjgr/jga7lj5blvpdcclxuICAgIGNvbnN0IGV4ZWN1dGlvbl9pZCA9IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5leGVjdXRpb25faWQ7XHJcblxyXG4gICAgLy8g44OQ44Oq44OH44O844K344On44OzXHJcbiAgICBpZiAoIWV4ZWN1dGlvbl9pZCkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdleGVjdXRpb25faWQgaXMgcmVxdWlyZWQnKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDlrp/ooYznirbmhYvjgpLlj5blvpdcclxuICAgIGNvbnN0IGV4ZWN1dGlvblN0YXR1cyA9IGF3YWl0IGdldEV4ZWN1dGlvblN0YXR1cyhleGVjdXRpb25faWQpO1xyXG5cclxuICAgIC8vIOODrOOCueODneODs+OCuVxyXG4gICAgY29uc3QgcmVzcG9uc2U6IENvbGxlY3RTdGF0dXNSZXNwb25zZSA9IHtcclxuICAgICAgc3RhdHVzOiAnc3VjY2VzcycsXHJcbiAgICAgIGRhdGE6IGV4ZWN1dGlvblN0YXR1cyxcclxuICAgIH07XHJcblxyXG4gICAgbG9nZ2VyLmluZm8oJ0dFVCAvY29sbGVjdC97ZXhlY3V0aW9uX2lkfSBjb21wbGV0ZWQnLCB7XHJcbiAgICAgIHJlcXVlc3RJZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXHJcbiAgICAgIGV4ZWN1dGlvbl9pZCxcclxuICAgICAgc3RhdHVzOiBleGVjdXRpb25TdGF0dXMuc3RhdHVzLFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc3RhdHVzQ29kZTogMjAwLFxyXG4gICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxyXG4gICAgICB9LFxyXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShyZXNwb25zZSksXHJcbiAgICB9O1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBsb2dnZXIuZXJyb3IoXHJcbiAgICAgICdHRVQgL2NvbGxlY3Qve2V4ZWN1dGlvbl9pZH0gZmFpbGVkJyxcclxuICAgICAgY3JlYXRlRXJyb3JDb250ZXh0KGVycm9yIGFzIEVycm9yLCB7XHJcbiAgICAgICAgcmVxdWVzdElkOiBjb250ZXh0LmF3c1JlcXVlc3RJZCxcclxuICAgICAgICBldmVudCxcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gICAgLy8g44Ko44Op44O844Oh44OI44Oq44Kv44K56YCB5L+hXHJcbiAgICBhd2FpdCBzZW5kRXJyb3JNZXRyaWMoXHJcbiAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5jb25zdHJ1Y3Rvci5uYW1lIDogJ1Vua25vd24nLFxyXG4gICAgICAnQ29sbGVjdFN0YXR1cycsXHJcbiAgICAgIHt9XHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiB0b0Vycm9yUmVzcG9uc2UoZXJyb3IgYXMgRXJyb3IsIGV2ZW50LnJlcXVlc3RDb250ZXh0LnJlcXVlc3RJZCk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog5a6f6KGM54q25oWL44KS5Y+W5b6XXHJcbiAqXHJcbiAqIEBwYXJhbSBleGVjdXRpb25faWQg5a6f6KGMSURcclxuICogQHJldHVybnMg5a6f6KGM54q25oWLXHJcbiAqIEB0aHJvd3MgTm90Rm91bmRFcnJvciDlrp/ooYznirbmhYvjgYzlrZjlnKjjgZfjgarjgYTloLTlkIhcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIGdldEV4ZWN1dGlvblN0YXR1cyhleGVjdXRpb25faWQ6IHN0cmluZyk6IFByb21pc2U8RXhlY3V0aW9uU3RhdHVzPiB7XHJcbiAgdHJ5IHtcclxuICAgIGxvZ2dlci5pbmZvKCdHZXR0aW5nIGV4ZWN1dGlvbiBzdGF0dXMgZnJvbSBEeW5hbW9EQicsIHtcclxuICAgICAgZXhlY3V0aW9uX2lkLFxyXG4gICAgICB0YWJsZU5hbWU6IEVYRUNVVElPTlNfVEFCTEVfTkFNRSxcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0SXRlbUNvbW1hbmQoe1xyXG4gICAgICBUYWJsZU5hbWU6IEVYRUNVVElPTlNfVEFCTEVfTkFNRSxcclxuICAgICAgS2V5OiB7XHJcbiAgICAgICAgZXhlY3V0aW9uX2lkOiB7IFM6IGV4ZWN1dGlvbl9pZCB9LFxyXG4gICAgICB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZHluYW1vQ2xpZW50LnNlbmQoY29tbWFuZCk7XHJcblxyXG4gICAgaWYgKCFyZXN1bHQuSXRlbSkge1xyXG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFcnJvcihgRXhlY3V0aW9uIG5vdCBmb3VuZDogJHtleGVjdXRpb25faWR9YCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgaXRlbSA9IHVubWFyc2hhbGwocmVzdWx0Lkl0ZW0pIGFzIEV4ZWN1dGlvblN0YXR1cztcclxuXHJcbiAgICBsb2dnZXIuaW5mbygnRXhlY3V0aW9uIHN0YXR1cyByZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5Jywge1xyXG4gICAgICBleGVjdXRpb25faWQsXHJcbiAgICAgIHN0YXR1czogaXRlbS5zdGF0dXMsXHJcbiAgICAgIHByb2dyZXNzOiBpdGVtLnByb2dyZXNzLFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGl0ZW07XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIE5vdEZvdW5kRXJyb3IpIHtcclxuICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9XHJcblxyXG4gICAgbG9nZ2VyLmVycm9yKFxyXG4gICAgICAnRmFpbGVkIHRvIGdldCBleGVjdXRpb24gc3RhdHVzIGZyb20gRHluYW1vREInLFxyXG4gICAgICBjcmVhdGVFcnJvckNvbnRleHQoZXJyb3IgYXMgRXJyb3IsIHtcclxuICAgICAgICBleGVjdXRpb25faWQsXHJcbiAgICAgICAgdGFibGVOYW1lOiBFWEVDVVRJT05TX1RBQkxFX05BTUUsXHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIGV4ZWN1dGlvbiBzdGF0dXMnKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgqjjg6njg7zjg6zjgrnjg53jg7PjgrnjgpLnlJ/miJBcclxuICpcclxuICogQHBhcmFtIGVycm9yIEVycm9yXHJcbiAqIEBwYXJhbSByZXF1ZXN0SWQg44Oq44Kv44Ko44K544OISURcclxuICogQHJldHVybnMgQVBJIEdhdGV3YXkgUHJveHkgUmVzdWx0XHJcbiAqL1xyXG5mdW5jdGlvbiB0b0Vycm9yUmVzcG9uc2UoZXJyb3I6IEVycm9yLCByZXF1ZXN0SWQ6IHN0cmluZyk6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCB7XHJcbiAgY29uc3QgZXJyb3JDb2RlTWFwOiBSZWNvcmQ8c3RyaW5nLCB7IHN0YXR1c0NvZGU6IG51bWJlcjsgY29kZTogc3RyaW5nIH0+ID0ge1xyXG4gICAgVmFsaWRhdGlvbkVycm9yOiB7IHN0YXR1c0NvZGU6IDQwMCwgY29kZTogJ1ZBTElEQVRJT05fRVJST1InIH0sXHJcbiAgICBVbmF1dGhvcml6ZWRFcnJvcjogeyBzdGF0dXNDb2RlOiA0MDEsIGNvZGU6ICdVTkFVVEhPUklaRUQnIH0sXHJcbiAgICBGb3JiaWRkZW5FcnJvcjogeyBzdGF0dXNDb2RlOiA0MDMsIGNvZGU6ICdGT1JCSURERU4nIH0sXHJcbiAgICBOb3RGb3VuZEVycm9yOiB7IHN0YXR1c0NvZGU6IDQwNCwgY29kZTogJ05PVF9GT1VORCcgfSxcclxuICAgIENvbmZsaWN0RXJyb3I6IHsgc3RhdHVzQ29kZTogNDA5LCBjb2RlOiAnQ09ORkxJQ1QnIH0sXHJcbiAgICBSYXRlTGltaXRFcnJvcjogeyBzdGF0dXNDb2RlOiA0MjksIGNvZGU6ICdSQVRFX0xJTUlUX0VYQ0VFREVEJyB9LFxyXG4gICAgSW50ZXJuYWxFcnJvcjogeyBzdGF0dXNDb2RlOiA1MDAsIGNvZGU6ICdJTlRFUk5BTF9FUlJPUicgfSxcclxuICAgIFNlcnZpY2VVbmF2YWlsYWJsZUVycm9yOiB7IHN0YXR1c0NvZGU6IDUwMywgY29kZTogJ1NFUlZJQ0VfVU5BVkFJTEFCTEUnIH0sXHJcbiAgICBHYXRld2F5VGltZW91dEVycm9yOiB7IHN0YXR1c0NvZGU6IDUwNCwgY29kZTogJ0dBVEVXQVlfVElNRU9VVCcgfSxcclxuICB9O1xyXG5cclxuICBjb25zdCBtYXBwaW5nID0gZXJyb3JDb2RlTWFwW2Vycm9yLm5hbWVdIHx8IHtcclxuICAgIHN0YXR1c0NvZGU6IDUwMCxcclxuICAgIGNvZGU6ICdJTlRFUk5BTF9FUlJPUicsXHJcbiAgfTtcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIHN0YXR1c0NvZGU6IG1hcHBpbmcuc3RhdHVzQ29kZSxcclxuICAgIGhlYWRlcnM6IHtcclxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgIH0sXHJcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgIHN0YXR1czogJ2Vycm9yJyxcclxuICAgICAgZXJyb3I6IHtcclxuICAgICAgICBjb2RlOiBtYXBwaW5nLmNvZGUsXHJcbiAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcclxuICAgICAgICBkZXRhaWxzOiAoZXJyb3IgYXMgYW55KS5kZXRhaWxzIHx8IHt9LFxyXG4gICAgICB9LFxyXG4gICAgICByZXF1ZXN0X2lkOiByZXF1ZXN0SWQsXHJcbiAgICB9KSxcclxuICB9O1xyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==