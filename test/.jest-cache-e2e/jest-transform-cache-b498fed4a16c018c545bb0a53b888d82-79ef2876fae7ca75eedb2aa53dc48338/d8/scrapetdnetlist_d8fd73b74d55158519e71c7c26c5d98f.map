{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\scrape-tdnet-list.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\scrape-tdnet-list.ts"],"sourcesContent":["/**\r\n * TDnet List Scraper\r\n *\r\n * 指定日のTDnet開示情報リストを取得し、メタデータを抽出します。\r\n * レート制限と再試行ロジックを適用して、TDnetサーバーへの負荷を最小化します。\r\n *\r\n * Requirements: 要件1.1, 9.1\r\n */\r\n\r\nimport axios, { AxiosError } from 'axios';\r\nimport * as iconv from 'iconv-lite';\r\nimport { parseDisclosureList, DisclosureMetadata } from '../../scraper/html-parser';\r\nimport { RateLimiter } from '../../utils/rate-limiter';\r\nimport { retryWithBackoff } from '../../utils/retry';\r\nimport { logger, createErrorContext } from '../../utils/logger';\r\nimport { sendErrorMetric, sendSuccessMetric } from '../../utils/cloudwatch-metrics';\r\nimport { RetryableError, ValidationError } from '../../errors';\r\n\r\n/**\r\n * レート制限設定（2秒間隔）\r\n * TDnetサーバーへの過度な負荷を防ぐため\r\n */\r\nconst rateLimiter = new RateLimiter({ minDelayMs: 2000 });\r\n\r\n/**\r\n * HTTPタイムアウト設定（30秒）\r\n */\r\nconst HTTP_TIMEOUT_MS = 30000;\r\n\r\n/**\r\n * User-Agent設定\r\n */\r\nconst USER_AGENT = 'TDnet-Data-Collector/1.0 (https://github.com/your-org/tdnet-data-collector)';\r\n\r\n/**\r\n * 指定日のTDnet開示情報リストを取得（全ページ）\r\n *\r\n * @param date 日付（YYYY-MM-DD形式）\r\n * @returns 開示情報メタデータの配列\r\n * @throws ValidationError 日付フォーマットが不正な場合\r\n * @throws RetryableError ネットワークエラーまたはHTTPエラー\r\n *\r\n * @example\r\n * ```typescript\r\n * const disclosures = await scrapeTdnetList('2024-01-15');\r\n * console.log(`Found ${disclosures.length} disclosures`);\r\n * ```\r\n */\r\nexport async function scrapeTdnetList(date: string): Promise<DisclosureMetadata[]> {\r\n  // 日付フォーマットのバリデーション\r\n  validateDateFormat(date);\r\n\r\n  try {\r\n    logger.info('Scraping TDnet list', { date });\r\n\r\n    const allDisclosures: DisclosureMetadata[] = [];\r\n    let pageNumber = 1;\r\n    let hasMorePages = true;\r\n\r\n    // すべてのページを取得\r\n    while (hasMorePages) {\r\n      // レート制限を適用\r\n      await rateLimiter.waitIfNeeded();\r\n\r\n      try {\r\n        // TDnetからHTMLを取得（再試行あり）\r\n        const html = await fetchTdnetHtml(date, pageNumber);\r\n\r\n        // HTMLをパース（日付を渡す）\r\n        const disclosures = parseDisclosureList(html, date);\r\n\r\n        if (disclosures.length === 0) {\r\n          // 開示情報がない場合は終了\r\n          hasMorePages = false;\r\n        } else {\r\n          allDisclosures.push(...disclosures);\r\n          logger.info('TDnet page scraped', {\r\n            date,\r\n            page: pageNumber,\r\n            count: disclosures.length,\r\n            total: allDisclosures.length,\r\n          });\r\n\r\n          // 100件未満の場合は最終ページ\r\n          if (disclosures.length < 100) {\r\n            hasMorePages = false;\r\n          } else {\r\n            pageNumber++;\r\n          }\r\n        }\r\n      } catch (error) {\r\n        // 404エラー（ページが存在しない）の場合\r\n        if (error instanceof ValidationError && error.message.includes('not found')) {\r\n          // 最初のページで404エラーが発生した場合は、エラーをスロー\r\n          if (pageNumber === 1) {\r\n            throw error;\r\n          }\r\n          \r\n          // 2ページ目以降で404エラーが発生した場合は、これ以上ページがないと判断\r\n          logger.info('TDnet page not found, stopping pagination', {\r\n            date,\r\n            page: pageNumber,\r\n            total: allDisclosures.length,\r\n          });\r\n          hasMorePages = false;\r\n        } else {\r\n          // その他のエラーは再スロー\r\n          throw error;\r\n        }\r\n      }\r\n    }\r\n\r\n    logger.info('TDnet list scraped successfully', {\r\n      date,\r\n      total_pages: pageNumber,\r\n      total_count: allDisclosures.length,\r\n    });\r\n\r\n    // 成功メトリクス送信\r\n    await sendSuccessMetric(allDisclosures.length, 'ScrapeTdnetList', {\r\n      Date: date,\r\n    });\r\n\r\n    return allDisclosures;\r\n  } catch (error) {\r\n    logger.error(\r\n      'Failed to scrape TDnet list',\r\n      createErrorContext(error as Error, { date })\r\n    );\r\n\r\n    // エラーメトリクス送信\r\n    await sendErrorMetric(\r\n      error instanceof Error ? error.constructor.name : 'Unknown',\r\n      'ScrapeTdnetList',\r\n      { Date: date }\r\n    );\r\n\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * 日付フォーマットのバリデーション\r\n *\r\n * @param date 日付（YYYY-MM-DD形式）\r\n * @throws ValidationError 日付フォーマットが不正な場合\r\n *\r\n * @remarks\r\n * 以下のバリデーションを実施：\r\n * 1. フォーマット検証（YYYY-MM-DD形式）\r\n * 2. 存在する日付の検証（2024-02-30などを拒否）\r\n * 3. 範囲検証（1970-01-01以降、現在+1日以内）\r\n */\r\nfunction validateDateFormat(date: string): void {\r\n  // 1. フォーマット検証\r\n  const dateRegex = /^\\d{4}-\\d{2}-\\d{2}$/;\r\n  if (!dateRegex.test(date)) {\r\n    throw new ValidationError(\r\n      `Invalid date format: ${date}. Expected YYYY-MM-DD format.`\r\n    );\r\n  }\r\n\r\n  // 2. 存在する日付の検証\r\n  const dateObj = new Date(date);\r\n  if (isNaN(dateObj.getTime())) {\r\n    throw new ValidationError(\r\n      `Invalid date: ${date}. Date does not exist.`\r\n    );\r\n  }\r\n\r\n  // 日付の各部分を抽出して検証\r\n  const [year, month, day] = date.split('-').map(Number);\r\n  const reconstructedDate = new Date(year, month - 1, day);\r\n  \r\n  // 日付が正規化されていないか確認（例: 2024-02-30 → 2024-03-02）\r\n  if (\r\n    reconstructedDate.getFullYear() !== year ||\r\n    reconstructedDate.getMonth() !== month - 1 ||\r\n    reconstructedDate.getDate() !== day\r\n  ) {\r\n    throw new ValidationError(\r\n      `Invalid date: ${date}. Date does not exist (e.g., February 30th).`\r\n    );\r\n  }\r\n\r\n  // 3. 範囲検証（1970-01-01以降、現在+1日以内）\r\n  const minDate = new Date('1970-01-01T00:00:00Z');\r\n  const maxDate = new Date(Date.now() + 24 * 60 * 60 * 1000); // 現在時刻+1日\r\n  \r\n  if (dateObj < minDate) {\r\n    throw new ValidationError(\r\n      `Date out of range: ${date}. Must be on or after 1970-01-01.`\r\n    );\r\n  }\r\n  \r\n  if (dateObj > maxDate) {\r\n    throw new ValidationError(\r\n      `Date out of range: ${date}. Must be within 1 day of current date.`\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * TDnetからHTMLを取得（再試行あり）\r\n *\r\n * @param date 日付（YYYY-MM-DD形式）\r\n * @param pageNumber ページ番号（デフォルト: 1）\r\n * @returns HTMLコンテンツ（UTF-8にデコード済み）\r\n * @throws RetryableError ネットワークエラーまたはHTTPエラー\r\n */\r\nasync function fetchTdnetHtml(date: string, pageNumber: number = 1): Promise<string> {\r\n  const url = buildTdnetUrl(date, pageNumber);\r\n\r\n  return await retryWithBackoff(\r\n    async () => {\r\n      try {\r\n        logger.debug('Fetching TDnet HTML', { url, date });\r\n\r\n        const response = await axios.get(url, {\r\n          timeout: HTTP_TIMEOUT_MS,\r\n          headers: {\r\n            'User-Agent': USER_AGENT,\r\n            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',\r\n            'Accept-Language': 'ja,en-US;q=0.9,en;q=0.8',\r\n            'Accept-Encoding': 'gzip, deflate',\r\n            'Connection': 'keep-alive',\r\n          },\r\n          // Shift_JISエンコーディング対応\r\n          responseType: 'arraybuffer',\r\n          validateStatus: (status) => status >= 200 && status < 300,\r\n        });\r\n\r\n        // Shift_JISからUTF-8にデコード\r\n        const html = decodeShiftJIS(response.data);\r\n\r\n        logger.debug('TDnet HTML fetched successfully', {\r\n          url,\r\n          date,\r\n          status: response.status,\r\n          content_length: html.length,\r\n        });\r\n\r\n        return html;\r\n      } catch (error) {\r\n        // AxiosErrorを適切なエラーに変換\r\n        throw convertAxiosError(error as AxiosError, url);\r\n      }\r\n    },\r\n    {\r\n      maxRetries: 3,\r\n      initialDelay: 2000,\r\n      backoffMultiplier: 2,\r\n      jitter: true,\r\n      shouldRetry: (error) => {\r\n        // RetryableErrorのみ再試行\r\n        return error instanceof RetryableError;\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n/**\r\n * Shift_JISバイト配列をUTF-8文字列にデコード\r\n *\r\n * @param buffer Shift_JISエンコードされたバイト配列またはUTF-8文字列\r\n * @returns UTF-8文字列\r\n */\r\nfunction decodeShiftJIS(buffer: ArrayBuffer | string): string {\r\n  // 既に文字列の場合はそのまま返す（テスト互換性のため）\r\n  if (typeof buffer === 'string') {\r\n    return buffer;\r\n  }\r\n\r\n  try {\r\n    // iconv-liteを使用してShift_JISをデコード\r\n    // ArrayBufferをBufferに変換\r\n    const uint8Array = new Uint8Array(buffer);\r\n    const nodeBuffer = Buffer.from(uint8Array);\r\n    \r\n    // Shift_JISからUTF-8にデコード\r\n    const decoded = iconv.decode(nodeBuffer, 'shift_jis');\r\n    \r\n    logger.debug('Shift_JIS decoded successfully', {\r\n      buffer_size: nodeBuffer.length,\r\n      decoded_length: decoded.length,\r\n    });\r\n    \r\n    return decoded;\r\n  } catch (error) {\r\n    logger.error('Failed to decode Shift_JIS', {\r\n      error_type: error instanceof Error ? error.constructor.name : 'Unknown',\r\n      error_message: error instanceof Error ? error.message : String(error),\r\n    });\r\n    \r\n    // フォールバック: UTF-8として解釈\r\n    try {\r\n      const uint8Array = new Uint8Array(buffer);\r\n      const nodeBuffer = Buffer.from(uint8Array);\r\n      return iconv.decode(nodeBuffer, 'utf-8');\r\n    } catch (fallbackError) {\r\n      logger.error('Fallback UTF-8 decode also failed', {\r\n        error_type: fallbackError instanceof Error ? fallbackError.constructor.name : 'Unknown',\r\n        error_message: fallbackError instanceof Error ? fallbackError.message : String(fallbackError),\r\n      });\r\n      // 最終フォールバック: 空文字列を返す\r\n      return '';\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * TDnet URLを構築\r\n *\r\n * @param date 日付（YYYY-MM-DD形式）\r\n * @param pageNumber ページ番号（デフォルト: 1）\r\n * @returns TDnet URL\r\n *\r\n * @remarks\r\n * TDnetの実際のURL形式:\r\n * - 1ページ目: https://www.release.tdnet.info/inbs/I_list_001_YYYYMMDD.html\r\n * - 2ページ目: https://www.release.tdnet.info/inbs/I_list_002_YYYYMMDD.html\r\n * - 3ページ目: https://www.release.tdnet.info/inbs/I_list_003_YYYYMMDD.html\r\n * 日付はハイフンなしの8桁形式（例: 20260214）\r\n */\r\nfunction buildTdnetUrl(date: string, pageNumber: number = 1): string {\r\n  const baseUrl = process.env.TDNET_BASE_URL || 'https://www.release.tdnet.info/inbs';\r\n  // YYYY-MM-DD → YYYYMMDD に変換\r\n  const dateWithoutHyphens = date.replace(/-/g, '');\r\n  // ページ番号を3桁にゼロパディング（例: 1 → 001, 2 → 002）\r\n  const pageNumberPadded = String(pageNumber).padStart(3, '0');\r\n  return `${baseUrl}/I_list_${pageNumberPadded}_${dateWithoutHyphens}.html`;\r\n}\r\n\r\n/**\r\n * AxiosErrorを適切なエラーに変換\r\n *\r\n * @param error AxiosError\r\n * @param url リクエストURL\r\n * @returns 変換されたエラー\r\n */\r\nfunction convertAxiosError(error: AxiosError, url: string): Error {\r\n  // ネットワークエラー\r\n  if (error.code === 'ECONNRESET' || error.code === 'ETIMEDOUT' || error.code === 'ENOTFOUND') {\r\n    return new RetryableError(\r\n      `Network error: ${error.code} - ${error.message}`,\r\n      error\r\n    );\r\n  }\r\n\r\n  // タイムアウトエラー\r\n  if (error.code === 'ECONNABORTED' || error.message?.includes('timeout')) {\r\n    return new RetryableError(\r\n      `Request timeout: ${error.message}`,\r\n      error\r\n    );\r\n  }\r\n\r\n  // HTTPエラー\r\n  if (error.response) {\r\n    const status = error.response.status;\r\n\r\n    // 5xxエラー（サーバーエラー）- 再試行可能\r\n    if (status >= 500) {\r\n      return new RetryableError(\r\n        `Server error: ${status} ${error.response.statusText}`,\r\n        error\r\n      );\r\n    }\r\n\r\n    // 429エラー（レート制限）- 再試行可能\r\n    if (status === 429) {\r\n      return new RetryableError(\r\n        `Rate limit exceeded: ${status} ${error.response.statusText}`,\r\n        error\r\n      );\r\n    }\r\n\r\n    // 404エラー（ページが存在しない）- 再試行不可\r\n    if (status === 404) {\r\n      return new ValidationError(\r\n        `TDnet page not found: ${url}. The specified date may not have any disclosures.`\r\n      );\r\n    }\r\n\r\n    // その他のHTTPエラー - 再試行不可\r\n    return new Error(\r\n      `HTTP error: ${status} ${error.response.statusText}`\r\n    );\r\n  }\r\n\r\n  // その他のエラー\r\n  return new Error(\r\n    `Failed to fetch TDnet HTML: ${error.message}`\r\n  );\r\n}\r\n"],"version":3}