0cc1b61a64ff40fca72c8bdbc0e1c4c3
"use strict";
/**
 * Query Disclosures
 *
 * DynamoDBから開示情報を検索します。
 * GSI（Global Secondary Index）を使用して効率的にクエリします。
 *
 * Requirements: 要件4.1（検索API）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.queryDisclosures = queryDisclosures;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const util_dynamodb_1 = require("@aws-sdk/util-dynamodb");
const logger_1 = require("../../utils/logger");
const retry_1 = require("../../utils/retry");
const date_partition_1 = require("../../utils/date-partition");
// DynamoDBクライアント（グローバルスコープで初期化）
const dynamoClient = new client_dynamodb_1.DynamoDBClient({
    region: process.env.AWS_REGION || 'ap-northeast-1',
    maxAttempts: 3,
    ...(process.env.AWS_ENDPOINT_URL && {
        endpoint: process.env.AWS_ENDPOINT_URL,
    }),
});
const TABLE_NAME = process.env.DYNAMODB_TABLE_NAME || 'tdnet_disclosures';
/**
 * 開示情報を検索
 *
 * @param params クエリパラメータ
 * @returns クエリ結果
 */
async function queryDisclosures(params) {
    logger_1.logger.info('Querying disclosures', { params });
    let disclosures;
    // クエリ戦略の選択
    if (params.month) {
        // 月でクエリ（GSI_DatePartition使用）
        disclosures = await queryByMonth(params);
    }
    else if (params.company_code) {
        // 企業コードでクエリ（GSI_CompanyCode_DiscloseDate使用）
        disclosures = await queryByCompanyCode(params);
    }
    else if (params.start_date && params.end_date) {
        // 日付範囲でクエリ（GSI_DatePartition使用）
        disclosures = await queryByDateRange(params);
    }
    else if (params.start_date) {
        // 開始日のみ指定（GSI_DatePartition使用）
        disclosures = await queryByDateRange({
            ...params,
            end_date: new Date().toISOString().split('T')[0], // 今日まで
        });
    }
    else {
        // フィルタなし（Scan）
        disclosures = await scanDisclosures(params);
    }
    // 開示種類でフィルタリング
    if (params.disclosure_type) {
        disclosures = disclosures.filter((d) => d.disclosure_type === params.disclosure_type);
    }
    // 開示日時で降順ソート
    disclosures.sort((a, b) => {
        return new Date(b.disclosed_at).getTime() - new Date(a.disclosed_at).getTime();
    });
    // ページネーション
    const total = disclosures.length;
    const paginatedDisclosures = disclosures.slice(params.offset, params.offset + params.limit);
    logger_1.logger.info('Query completed', {
        total,
        count: paginatedDisclosures.length,
        offset: params.offset,
        limit: params.limit,
    });
    return {
        disclosures: paginatedDisclosures,
        total,
        count: paginatedDisclosures.length,
        offset: params.offset,
        limit: params.limit,
    };
}
/**
 * 企業コードでクエリ
 *
 * GSI_CompanyCode_DiscloseDate（パーティションキー: company_code、ソートキー: disclosed_at）を使用
 *
 * @param params クエリパラメータ
 * @returns 開示情報リスト
 */
async function queryByCompanyCode(params) {
    logger_1.logger.info('Querying by company code', { company_code: params.company_code });
    const queryInput = {
        TableName: TABLE_NAME,
        IndexName: 'GSI_CompanyCode_DiscloseDate',
        KeyConditionExpression: 'company_code = :company_code',
        ExpressionAttributeValues: {
            ':company_code': { S: params.company_code },
        },
    };
    // 日付範囲フィルタ
    if (params.start_date && params.end_date) {
        queryInput.KeyConditionExpression += ' AND disclosed_at BETWEEN :start_date AND :end_date';
        queryInput.ExpressionAttributeValues[':start_date'] = { S: params.start_date };
        queryInput.ExpressionAttributeValues[':end_date'] = { S: params.end_date };
    }
    else if (params.start_date) {
        queryInput.KeyConditionExpression += ' AND disclosed_at >= :start_date';
        queryInput.ExpressionAttributeValues[':start_date'] = { S: params.start_date };
    }
    else if (params.end_date) {
        queryInput.KeyConditionExpression += ' AND disclosed_at <= :end_date';
        queryInput.ExpressionAttributeValues[':end_date'] = { S: params.end_date };
    }
    return await executeQuery(queryInput);
}
/**
 * 月でクエリ
 *
 * GSI_DatePartition（パーティションキー: date_partition、ソートキー: disclosed_at）を使用
 * 単一の月のデータを効率的に取得
 *
 * @param params クエリパラメータ
 * @returns 開示情報リスト
 */
async function queryByMonth(params) {
    logger_1.logger.info('Querying by month', { month: params.month });
    return await queryByPartition(params.month, params);
}
/**
 * 日付範囲でクエリ
 *
 * GSI_DatePartition（パーティションキー: date_partition、ソートキー: disclosed_at）を使用
 * 複数の月を並行クエリして結果を統合
 *
 * @param params クエリパラメータ
 * @returns 開示情報リスト
 */
async function queryByDateRange(params) {
    logger_1.logger.info('Querying by date range', {
        start_date: params.start_date,
        end_date: params.end_date,
    });
    // 開始月と終了月を生成
    const startPartition = (0, date_partition_1.generateDatePartition)(params.start_date + 'T00:00:00Z');
    const endPartition = (0, date_partition_1.generateDatePartition)(params.end_date + 'T00:00:00Z');
    // 月のリストを生成
    const partitions = generateMonthRange(startPartition, endPartition);
    logger_1.logger.info('Querying multiple partitions', {
        partitions,
        count: partitions.length,
    });
    // 並行クエリ
    const results = await Promise.all(partitions.map((partition) => queryByPartition(partition, params)));
    // 結果を統合
    const allDisclosures = results.flat();
    // 日付範囲でフィルタリング
    return allDisclosures.filter((disclosure) => {
        const disclosedAt = disclosure.disclosed_at.split('T')[0]; // YYYY-MM-DD部分を抽出
        return disclosedAt >= params.start_date && disclosedAt <= params.end_date;
    });
}
/**
 * 単一パーティションでクエリ
 *
 * @param partition date_partition（YYYY-MM形式）
 * @param params クエリパラメータ
 * @returns 開示情報リスト
 */
async function queryByPartition(partition, _params) {
    const queryInput = {
        TableName: TABLE_NAME,
        IndexName: 'GSI_DatePartition',
        KeyConditionExpression: 'date_partition = :partition',
        ExpressionAttributeValues: {
            ':partition': { S: partition },
        },
    };
    return await executeQuery(queryInput);
}
/**
 * Scanでクエリ（フィルタなし）
 *
 * @param params クエリパラメータ
 * @returns 開示情報リスト
 */
async function scanDisclosures(params) {
    logger_1.logger.warn('Scanning table without filters (inefficient)', { params });
    const scanInput = {
        TableName: TABLE_NAME,
        Limit: params.limit + params.offset, // オフセット分も取得
    };
    return await executeScan(scanInput);
}
/**
 * DynamoDBクエリを実行
 *
 * @param input QueryCommandInput
 * @returns 開示情報リスト
 */
async function executeQuery(input) {
    const disclosures = [];
    let lastEvaluatedKey;
    do {
        const command = new client_dynamodb_1.QueryCommand({
            ...input,
            ExclusiveStartKey: lastEvaluatedKey,
        });
        const response = await (0, retry_1.retryWithBackoff)(async () => await dynamoClient.send(command), {
            maxRetries: 3,
            initialDelay: 1000,
            backoffMultiplier: 2,
            jitter: true,
            shouldRetry: (error) => {
                return (error.name === 'ProvisionedThroughputExceededException' ||
                    error.name === 'ThrottlingException');
            },
        });
        if (response.Items) {
            for (const item of response.Items) {
                disclosures.push((0, util_dynamodb_1.unmarshall)(item));
            }
        }
        lastEvaluatedKey = response.LastEvaluatedKey;
    } while (lastEvaluatedKey);
    return disclosures;
}
/**
 * DynamoDB Scanを実行
 *
 * @param input ScanCommandInput
 * @returns 開示情報リスト
 */
async function executeScan(input) {
    const disclosures = [];
    let lastEvaluatedKey;
    do {
        const command = new client_dynamodb_1.ScanCommand({
            ...input,
            ExclusiveStartKey: lastEvaluatedKey,
        });
        const response = await (0, retry_1.retryWithBackoff)(async () => await dynamoClient.send(command), {
            maxRetries: 3,
            initialDelay: 1000,
            backoffMultiplier: 2,
            jitter: true,
            shouldRetry: (error) => {
                return (error.name === 'ProvisionedThroughputExceededException' ||
                    error.name === 'ThrottlingException');
            },
        });
        if (response.Items) {
            for (const item of response.Items) {
                disclosures.push((0, util_dynamodb_1.unmarshall)(item));
            }
        }
        lastEvaluatedKey = response.LastEvaluatedKey;
    } while (lastEvaluatedKey);
    return disclosures;
}
/**
 * 月範囲を生成
 *
 * @param start 開始月（YYYY-MM）
 * @param end 終了月（YYYY-MM）
 * @returns 月のリスト（YYYY-MM形式）
 */
function generateMonthRange(start, end) {
    const months = [];
    const [startYear, startMonth] = start.split('-').map(Number);
    const [endYear, endMonth] = end.split('-').map(Number);
    let year = startYear;
    let month = startMonth;
    while (year < endYear || (year === endYear && month <= endMonth)) {
        months.push(`${year}-${String(month).padStart(2, '0')}`);
        month++;
        if (month > 12) {
            month = 1;
            year++;
        }
    }
    return months;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXHF1ZXJ5XFxxdWVyeS1kaXNjbG9zdXJlcy50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7R0FPRzs7QUF5REgsNENBMkRDO0FBbEhELDhEQU1rQztBQUNsQywwREFBb0Q7QUFDcEQsK0NBQTRDO0FBQzVDLDZDQUFxRDtBQUVyRCwrREFBbUU7QUFFbkUsZ0NBQWdDO0FBQ2hDLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQztJQUN0QyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksZ0JBQWdCO0lBQ2xELFdBQVcsRUFBRSxDQUFDO0lBQ2QsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLElBQUk7UUFDbEMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCO0tBQ3ZDLENBQUM7Q0FDSCxDQUFDLENBQUM7QUFFSCxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLG1CQUFtQixDQUFDO0FBMkIxRTs7Ozs7R0FLRztBQUNJLEtBQUssVUFBVSxnQkFBZ0IsQ0FBQyxNQUFtQjtJQUN4RCxlQUFNLENBQUMsSUFBSSxDQUFDLHNCQUFzQixFQUFFLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUVoRCxJQUFJLFdBQXlCLENBQUM7SUFFOUIsV0FBVztJQUNYLElBQUksTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2pCLDZCQUE2QjtRQUM3QixXQUFXLEdBQUcsTUFBTSxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDM0MsQ0FBQztTQUFNLElBQUksTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQy9CLDRDQUE0QztRQUM1QyxXQUFXLEdBQUcsTUFBTSxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNqRCxDQUFDO1NBQU0sSUFBSSxNQUFNLENBQUMsVUFBVSxJQUFJLE1BQU0s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b3BvXFxzcmNcXGxhbWJkYVxccXVlcnlcXHF1ZXJ5LWRpc2Nsb3N1cmVzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBRdWVyeSBEaXNjbG9zdXJlc1xyXG4gKlxyXG4gKiBEeW5hbW9EQuOBi+OCiemWi+ekuuaDheWgseOCkuaknOe0ouOBl+OBvuOBmeOAglxyXG4gKiBHU0nvvIhHbG9iYWwgU2Vjb25kYXJ5IEluZGV477yJ44KS5L2/55So44GX44Gm5Yq5546H55qE44Gr44Kv44Ko44Oq44GX44G+44GZ44CCXHJcbiAqXHJcbiAqIFJlcXVpcmVtZW50czog6KaB5Lu2NC4x77yI5qSc57SiQVBJ77yJXHJcbiAqL1xyXG5cclxuaW1wb3J0IHtcclxuICBEeW5hbW9EQkNsaWVudCxcclxuICBRdWVyeUNvbW1hbmQsXHJcbiAgU2NhbkNvbW1hbmQsXHJcbiAgUXVlcnlDb21tYW5kSW5wdXQsXHJcbiAgU2NhbkNvbW1hbmRJbnB1dCxcclxufSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xyXG5pbXBvcnQgeyB1bm1hcnNoYWxsIH0gZnJvbSAnQGF3cy1zZGsvdXRpbC1keW5hbW9kYic7XHJcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uLy4uL3V0aWxzL2xvZ2dlcic7XHJcbmltcG9ydCB7IHJldHJ5V2l0aEJhY2tvZmYgfSBmcm9tICcuLi8uLi91dGlscy9yZXRyeSc7XHJcbmltcG9ydCB7IERpc2Nsb3N1cmUgfSBmcm9tICcuLi8uLi90eXBlcyc7XHJcbmltcG9ydCB7IGdlbmVyYXRlRGF0ZVBhcnRpdGlvbiB9IGZyb20gJy4uLy4uL3V0aWxzL2RhdGUtcGFydGl0aW9uJztcclxuXHJcbi8vIER5bmFtb0RC44Kv44Op44Kk44Ki44Oz44OI77yI44Kw44Ot44O844OQ44Or44K544Kz44O844OX44Gn5Yid5pyf5YyW77yJXHJcbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7XHJcbiAgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICdhcC1ub3J0aGVhc3QtMScsXHJcbiAgbWF4QXR0ZW1wdHM6IDMsXHJcbiAgLi4uKHByb2Nlc3MuZW52LkFXU19FTkRQT0lOVF9VUkwgJiYge1xyXG4gICAgZW5kcG9pbnQ6IHByb2Nlc3MuZW52LkFXU19FTkRQT0lOVF9VUkwsXHJcbiAgfSksXHJcbn0pO1xyXG5cclxuY29uc3QgVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LkRZTkFNT0RCX1RBQkxFX05BTUUgfHwgJ3RkbmV0X2Rpc2Nsb3N1cmVzJztcclxuXHJcbi8qKlxyXG4gKiDjgq/jgqjjg6rjg5Hjg6njg6Hjg7zjgr9cclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgUXVlcnlQYXJhbXMge1xyXG4gIGNvbXBhbnlfY29kZT86IHN0cmluZztcclxuICBzdGFydF9kYXRlPzogc3RyaW5nO1xyXG4gIGVuZF9kYXRlPzogc3RyaW5nO1xyXG4gIG1vbnRoPzogc3RyaW5nO1xyXG4gIGRpc2Nsb3N1cmVfdHlwZT86IHN0cmluZztcclxuICBmb3JtYXQ6ICdqc29uJyB8ICdjc3YnO1xyXG4gIGxpbWl0OiBudW1iZXI7XHJcbiAgb2Zmc2V0OiBudW1iZXI7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgq/jgqjjg6rntZDmnpxcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgUXVlcnlSZXN1bHQge1xyXG4gIGRpc2Nsb3N1cmVzOiBEaXNjbG9zdXJlW107XHJcbiAgdG90YWw6IG51bWJlcjtcclxuICBjb3VudDogbnVtYmVyO1xyXG4gIG9mZnNldDogbnVtYmVyO1xyXG4gIGxpbWl0OiBudW1iZXI7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDplovnpLrmg4XloLHjgpLmpJzntKJcclxuICpcclxuICogQHBhcmFtIHBhcmFtcyDjgq/jgqjjg6rjg5Hjg6njg6Hjg7zjgr9cclxuICogQHJldHVybnMg44Kv44Ko44Oq57WQ5p6cXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcXVlcnlEaXNjbG9zdXJlcyhwYXJhbXM6IFF1ZXJ5UGFyYW1zKTogUHJvbWlzZTxRdWVyeVJlc3VsdD4ge1xyXG4gIGxvZ2dlci5pbmZvKCdRdWVyeWluZyBkaXNjbG9zdXJlcycsIHsgcGFyYW1zIH0pO1xyXG5cclxuICBsZXQgZGlzY2xvc3VyZXM6IERpc2Nsb3N1cmVbXTtcclxuXHJcbiAgLy8g44Kv44Ko44Oq5oim55Wl44Gu6YG45oqeXHJcbiAgaWYgKHBhcmFtcy5tb250aCkge1xyXG4gICAgLy8g5pyI44Gn44Kv44Ko44Oq77yIR1NJX0RhdGVQYXJ0aXRpb27kvb/nlKjvvIlcclxuICAgIGRpc2Nsb3N1cmVzID0gYXdhaXQgcXVlcnlCeU1vbnRoKHBhcmFtcyk7XHJcbiAgfSBlbHNlIGlmIChwYXJhbXMuY29tcGFueV9jb2RlKSB7XHJcbiAgICAvLyDkvIHmpa3jgrPjg7zjg4njgafjgq/jgqjjg6rvvIhHU0lfQ29tcGFueUNvZGVfRGlzY2xvc2VEYXRl5L2/55So77yJXHJcbiAgICBkaXNjbG9zdXJlcyA9IGF3YWl0IHF1ZXJ5QnlDb21wYW55Q29kZShwYXJhbXMpO1xyXG4gIH0gZWxzZSBpZiAocGFyYW1zLnN0YXJ0X2RhdGUgJiYgcGFyYW1zLmVuZF9kYXRlKSB7XHJcbiAgICAvLyDml6Xku5jnr4Tlm7Ljgafjgq/jgqjjg6rvvIhHU0lfRGF0ZVBhcnRpdGlvbuS9v+eUqO+8iVxyXG4gICAgZGlzY2xvc3VyZXMgPSBhd2FpdCBxdWVyeUJ5RGF0ZVJhbmdlKHBhcmFtcyk7XHJcbiAgfSBlbHNlIGlmIChwYXJhbXMuc3RhcnRfZGF0ZSkge1xyXG4gICAgLy8g6ZaL5aeL5pel44Gu44G/5oyH5a6a77yIR1NJX0RhdGVQYXJ0aXRpb27kvb/nlKjvvIlcclxuICAgIGRpc2Nsb3N1cmVzID0gYXdhaXQgcXVlcnlCeURhdGVSYW5nZSh7XHJcbiAgICAgIC4uLnBhcmFtcyxcclxuICAgICAgZW5kX2RhdGU6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zcGxpdCgnVCcpWzBdLCAvLyDku4rml6Xjgb7jgadcclxuICAgIH0pO1xyXG4gIH0gZWxzZSB7XHJcbiAgICAvLyDjg5XjgqPjg6vjgr/jgarjgZfvvIhTY2Fu77yJXHJcbiAgICBkaXNjbG9zdXJlcyA9IGF3YWl0IHNjYW5EaXNjbG9zdXJlcyhwYXJhbXMpO1xyXG4gIH1cclxuXHJcbiAgLy8g6ZaL56S656iu6aGe44Gn44OV44Kj44Or44K/44Oq44Oz44KwXHJcbiAgaWYgKHBhcmFtcy5kaXNjbG9zdXJlX3R5cGUpIHtcclxuICAgIGRpc2Nsb3N1cmVzID0gZGlzY2xvc3VyZXMuZmlsdGVyKFxyXG4gICAgICAoZCkgPT4gZC5kaXNjbG9zdXJlX3R5cGUgPT09IHBhcmFtcy5kaXNjbG9zdXJlX3R5cGVcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvLyDplovnpLrml6XmmYLjgafpmY3poIbjgr3jg7zjg4hcclxuICBkaXNjbG9zdXJlcy5zb3J0KChhLCBiKSA9PiB7XHJcbiAgICByZXR1cm4gbmV3IERhdGUoYi5kaXNjbG9zZWRfYXQpLmdldFRpbWUoKSAtIG5ldyBEYXRlKGEuZGlzY2xvc2VkX2F0KS5nZXRUaW1lKCk7XHJcbiAgfSk7XHJcblxyXG4gIC8vIOODmuODvOOCuOODjeODvOOCt+ODp+ODs1xyXG4gIGNvbnN0IHRvdGFsID0gZGlzY2xvc3VyZXMubGVuZ3RoO1xyXG4gIGNvbnN0IHBhZ2luYXRlZERpc2Nsb3N1cmVzID0gZGlzY2xvc3VyZXMuc2xpY2UoXHJcbiAgICBwYXJhbXMub2Zmc2V0LFxyXG4gICAgcGFyYW1zLm9mZnNldCArIHBhcmFtcy5saW1pdFxyXG4gICk7XHJcblxyXG4gIGxvZ2dlci5pbmZvKCdRdWVyeSBjb21wbGV0ZWQnLCB7XHJcbiAgICB0b3RhbCxcclxuICAgIGNvdW50OiBwYWdpbmF0ZWREaXNjbG9zdXJlcy5sZW5ndGgsXHJcbiAgICBvZmZzZXQ6IHBhcmFtcy5vZmZzZXQsXHJcbiAgICBsaW1pdDogcGFyYW1zLmxpbWl0LFxyXG4gIH0pO1xyXG5cclxuICByZXR1cm4ge1xyXG4gICAgZGlzY2xvc3VyZXM6IHBhZ2luYXRlZERpc2Nsb3N1cmVzLFxyXG4gICAgdG90YWwsXHJcbiAgICBjb3VudDogcGFnaW5hdGVkRGlzY2xvc3VyZXMubGVuZ3RoLFxyXG4gICAgb2Zmc2V0OiBwYXJhbXMub2Zmc2V0LFxyXG4gICAgbGltaXQ6IHBhcmFtcy5saW1pdCxcclxuICB9O1xyXG59XHJcblxyXG4vKipcclxuICog5LyB5qWt44Kz44O844OJ44Gn44Kv44Ko44OqXHJcbiAqXHJcbiAqIEdTSV9Db21wYW55Q29kZV9EaXNjbG9zZURhdGXvvIjjg5Hjg7zjg4bjgqPjgrfjg6fjg7Pjgq3jg7w6IGNvbXBhbnlfY29kZeOAgeOCveODvOODiOOCreODvDogZGlzY2xvc2VkX2F077yJ44KS5L2/55SoXHJcbiAqXHJcbiAqIEBwYXJhbSBwYXJhbXMg44Kv44Ko44Oq44OR44Op44Oh44O844K/XHJcbiAqIEByZXR1cm5zIOmWi+ekuuaDheWgseODquOCueODiFxyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gcXVlcnlCeUNvbXBhbnlDb2RlKHBhcmFtczogUXVlcnlQYXJhbXMpOiBQcm9taXNlPERpc2Nsb3N1cmVbXT4ge1xyXG4gIGxvZ2dlci5pbmZvKCdRdWVyeWluZyBieSBjb21wYW55IGNvZGUnLCB7IGNvbXBhbnlfY29kZTogcGFyYW1zLmNvbXBhbnlfY29kZSB9KTtcclxuXHJcbiAgY29uc3QgcXVlcnlJbnB1dDogUXVlcnlDb21tYW5kSW5wdXQgPSB7XHJcbiAgICBUYWJsZU5hbWU6IFRBQkxFX05BTUUsXHJcbiAgICBJbmRleE5hbWU6ICdHU0lfQ29tcGFueUNvZGVfRGlzY2xvc2VEYXRlJyxcclxuICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdjb21wYW55X2NvZGUgPSA6Y29tcGFueV9jb2RlJyxcclxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcclxuICAgICAgJzpjb21wYW55X2NvZGUnOiB7IFM6IHBhcmFtcy5jb21wYW55X2NvZGUhIH0sXHJcbiAgICB9LFxyXG4gIH07XHJcblxyXG4gIC8vIOaXpeS7mOevhOWbsuODleOCo+ODq+OCv1xyXG4gIGlmIChwYXJhbXMuc3RhcnRfZGF0ZSAmJiBwYXJhbXMuZW5kX2RhdGUpIHtcclxuICAgIHF1ZXJ5SW5wdXQuS2V5Q29uZGl0aW9uRXhwcmVzc2lvbiArPSAnIEFORCBkaXNjbG9zZWRfYXQgQkVUV0VFTiA6c3RhcnRfZGF0ZSBBTkQgOmVuZF9kYXRlJztcclxuICAgIHF1ZXJ5SW5wdXQuRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyFbJzpzdGFydF9kYXRlJ10gPSB7IFM6IHBhcmFtcy5zdGFydF9kYXRlIH07XHJcbiAgICBxdWVyeUlucHV0LkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMhWyc6ZW5kX2RhdGUnXSA9IHsgUzogcGFyYW1zLmVuZF9kYXRlIH07XHJcbiAgfSBlbHNlIGlmIChwYXJhbXMuc3RhcnRfZGF0ZSkge1xyXG4gICAgcXVlcnlJbnB1dC5LZXlDb25kaXRpb25FeHByZXNzaW9uICs9ICcgQU5EIGRpc2Nsb3NlZF9hdCA+PSA6c3RhcnRfZGF0ZSc7XHJcbiAgICBxdWVyeUlucHV0LkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMhWyc6c3RhcnRfZGF0ZSddID0geyBTOiBwYXJhbXMuc3RhcnRfZGF0ZSB9O1xyXG4gIH0gZWxzZSBpZiAocGFyYW1zLmVuZF9kYXRlKSB7XHJcbiAgICBxdWVyeUlucHV0LktleUNvbmRpdGlvbkV4cHJlc3Npb24gKz0gJyBBTkQgZGlzY2xvc2VkX2F0IDw9IDplbmRfZGF0ZSc7XHJcbiAgICBxdWVyeUlucHV0LkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMhWyc6ZW5kX2RhdGUnXSA9IHsgUzogcGFyYW1zLmVuZF9kYXRlIH07XHJcbiAgfVxyXG5cclxuICByZXR1cm4gYXdhaXQgZXhlY3V0ZVF1ZXJ5KHF1ZXJ5SW5wdXQpO1xyXG59XHJcblxyXG4vKipcclxuICog5pyI44Gn44Kv44Ko44OqXHJcbiAqXHJcbiAqIEdTSV9EYXRlUGFydGl0aW9u77yI44OR44O844OG44Kj44K344On44Oz44Kt44O8OiBkYXRlX3BhcnRpdGlvbuOAgeOCveODvOODiOOCreODvDogZGlzY2xvc2VkX2F077yJ44KS5L2/55SoXHJcbiAqIOWNmOS4gOOBruaciOOBruODh+ODvOOCv+OCkuWKueeOh+eahOOBq+WPluW+l1xyXG4gKlxyXG4gKiBAcGFyYW0gcGFyYW1zIOOCr+OCqOODquODkeODqeODoeODvOOCv1xyXG4gKiBAcmV0dXJucyDplovnpLrmg4XloLHjg6rjgrnjg4hcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIHF1ZXJ5QnlNb250aChwYXJhbXM6IFF1ZXJ5UGFyYW1zKTogUHJvbWlzZTxEaXNjbG9zdXJlW10+IHtcclxuICBsb2dnZXIuaW5mbygnUXVlcnlpbmcgYnkgbW9udGgnLCB7IG1vbnRoOiBwYXJhbXMubW9udGggfSk7XHJcblxyXG4gIHJldHVybiBhd2FpdCBxdWVyeUJ5UGFydGl0aW9uKHBhcmFtcy5tb250aCEsIHBhcmFtcyk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDml6Xku5jnr4Tlm7Ljgafjgq/jgqjjg6pcclxuICpcclxuICogR1NJX0RhdGVQYXJ0aXRpb27vvIjjg5Hjg7zjg4bjgqPjgrfjg6fjg7Pjgq3jg7w6IGRhdGVfcGFydGl0aW9u44CB44K944O844OI44Kt44O8OiBkaXNjbG9zZWRfYXTvvInjgpLkvb/nlKhcclxuICog6KSH5pWw44Gu5pyI44KS5Lim6KGM44Kv44Ko44Oq44GX44Gm57WQ5p6c44KS57Wx5ZCIXHJcbiAqXHJcbiAqIEBwYXJhbSBwYXJhbXMg44Kv44Ko44Oq44OR44Op44Oh44O844K/XHJcbiAqIEByZXR1cm5zIOmWi+ekuuaDheWgseODquOCueODiFxyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gcXVlcnlCeURhdGVSYW5nZShwYXJhbXM6IFF1ZXJ5UGFyYW1zKTogUHJvbWlzZTxEaXNjbG9zdXJlW10+IHtcclxuICBsb2dnZXIuaW5mbygnUXVlcnlpbmcgYnkgZGF0ZSByYW5nZScsIHtcclxuICAgIHN0YXJ0X2RhdGU6IHBhcmFtcy5zdGFydF9kYXRlLFxyXG4gICAgZW5kX2RhdGU6IHBhcmFtcy5lbmRfZGF0ZSxcclxuICB9KTtcclxuXHJcbiAgLy8g6ZaL5aeL5pyI44Go57WC5LqG5pyI44KS55Sf5oiQXHJcbiAgY29uc3Qgc3RhcnRQYXJ0aXRpb24gPSBnZW5lcmF0ZURhdGVQYXJ0aXRpb24ocGFyYW1zLnN0YXJ0X2RhdGUhICsgJ1QwMDowMDowMFonKTtcclxuICBjb25zdCBlbmRQYXJ0aXRpb24gPSBnZW5lcmF0ZURhdGVQYXJ0aXRpb24ocGFyYW1zLmVuZF9kYXRlISArICdUMDA6MDA6MDBaJyk7XHJcblxyXG4gIC8vIOaciOOBruODquOCueODiOOCkueUn+aIkFxyXG4gIGNvbnN0IHBhcnRpdGlvbnMgPSBnZW5lcmF0ZU1vbnRoUmFuZ2Uoc3RhcnRQYXJ0aXRpb24sIGVuZFBhcnRpdGlvbik7XHJcblxyXG4gIGxvZ2dlci5pbmZvKCdRdWVyeWluZyBtdWx0aXBsZSBwYXJ0aXRpb25zJywge1xyXG4gICAgcGFydGl0aW9ucyxcclxuICAgIGNvdW50OiBwYXJ0aXRpb25zLmxlbmd0aCxcclxuICB9KTtcclxuXHJcbiAgLy8g5Lim6KGM44Kv44Ko44OqXHJcbiAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IFByb21pc2UuYWxsKFxyXG4gICAgcGFydGl0aW9ucy5tYXAoKHBhcnRpdGlvbikgPT4gcXVlcnlCeVBhcnRpdGlvbihwYXJ0aXRpb24sIHBhcmFtcykpXHJcbiAgKTtcclxuXHJcbiAgLy8g57WQ5p6c44KS57Wx5ZCIXHJcbiAgY29uc3QgYWxsRGlzY2xvc3VyZXMgPSByZXN1bHRzLmZsYXQoKTtcclxuXHJcbiAgLy8g5pel5LuY56+E5Zuy44Gn44OV44Kj44Or44K/44Oq44Oz44KwXHJcbiAgcmV0dXJuIGFsbERpc2Nsb3N1cmVzLmZpbHRlcigoZGlzY2xvc3VyZSkgPT4ge1xyXG4gICAgY29uc3QgZGlzY2xvc2VkQXQgPSBkaXNjbG9zdXJlLmRpc2Nsb3NlZF9hdC5zcGxpdCgnVCcpWzBdOyAvLyBZWVlZLU1NLURE6YOo5YiG44KS5oq95Ye6XHJcbiAgICByZXR1cm4gZGlzY2xvc2VkQXQgPj0gcGFyYW1zLnN0YXJ0X2RhdGUhICYmIGRpc2Nsb3NlZEF0IDw9IHBhcmFtcy5lbmRfZGF0ZSE7XHJcbiAgfSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDljZjkuIDjg5Hjg7zjg4bjgqPjgrfjg6fjg7Pjgafjgq/jgqjjg6pcclxuICpcclxuICogQHBhcmFtIHBhcnRpdGlvbiBkYXRlX3BhcnRpdGlvbu+8iFlZWVktTU3lvaLlvI/vvIlcclxuICogQHBhcmFtIHBhcmFtcyDjgq/jgqjjg6rjg5Hjg6njg6Hjg7zjgr9cclxuICogQHJldHVybnMg6ZaL56S65oOF5aCx44Oq44K544OIXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBxdWVyeUJ5UGFydGl0aW9uKFxyXG4gIHBhcnRpdGlvbjogc3RyaW5nLFxyXG4gIF9wYXJhbXM6IFF1ZXJ5UGFyYW1zXHJcbik6IFByb21pc2U8RGlzY2xvc3VyZVtdPiB7XHJcbiAgY29uc3QgcXVlcnlJbnB1dDogUXVlcnlDb21tYW5kSW5wdXQgPSB7XHJcbiAgICBUYWJsZU5hbWU6IFRBQkxFX05BTUUsXHJcbiAgICBJbmRleE5hbWU6ICdHU0lfRGF0ZVBhcnRpdGlvbicsXHJcbiAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnZGF0ZV9wYXJ0aXRpb24gPSA6cGFydGl0aW9uJyxcclxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcclxuICAgICAgJzpwYXJ0aXRpb24nOiB7IFM6IHBhcnRpdGlvbiB9LFxyXG4gICAgfSxcclxuICB9O1xyXG5cclxuICByZXR1cm4gYXdhaXQgZXhlY3V0ZVF1ZXJ5KHF1ZXJ5SW5wdXQpO1xyXG59XHJcblxyXG4vKipcclxuICogU2NhbuOBp+OCr+OCqOODqu+8iOODleOCo+ODq+OCv+OBquOBl++8iVxyXG4gKlxyXG4gKiBAcGFyYW0gcGFyYW1zIOOCr+OCqOODquODkeODqeODoeODvOOCv1xyXG4gKiBAcmV0dXJucyDplovnpLrmg4XloLHjg6rjgrnjg4hcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIHNjYW5EaXNjbG9zdXJlcyhwYXJhbXM6IFF1ZXJ5UGFyYW1zKTogUHJvbWlzZTxEaXNjbG9zdXJlW10+IHtcclxuICBsb2dnZXIud2FybignU2Nhbm5pbmcgdGFibGUgd2l0aG91dCBmaWx0ZXJzIChpbmVmZmljaWVudCknLCB7IHBhcmFtcyB9KTtcclxuXHJcbiAgY29uc3Qgc2NhbklucHV0OiBTY2FuQ29tbWFuZElucHV0ID0ge1xyXG4gICAgVGFibGVOYW1lOiBUQUJMRV9OQU1FLFxyXG4gICAgTGltaXQ6IHBhcmFtcy5saW1pdCArIHBhcmFtcy5vZmZzZXQsIC8vIOOCquODleOCu+ODg+ODiOWIhuOCguWPluW+l1xyXG4gIH07XHJcblxyXG4gIHJldHVybiBhd2FpdCBleGVjdXRlU2NhbihzY2FuSW5wdXQpO1xyXG59XHJcblxyXG4vKipcclxuICogRHluYW1vRELjgq/jgqjjg6rjgpLlrp/ooYxcclxuICpcclxuICogQHBhcmFtIGlucHV0IFF1ZXJ5Q29tbWFuZElucHV0XHJcbiAqIEByZXR1cm5zIOmWi+ekuuaDheWgseODquOCueODiFxyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gZXhlY3V0ZVF1ZXJ5KGlucHV0OiBRdWVyeUNvbW1hbmRJbnB1dCk6IFByb21pc2U8RGlzY2xvc3VyZVtdPiB7XHJcbiAgY29uc3QgZGlzY2xvc3VyZXM6IERpc2Nsb3N1cmVbXSA9IFtdO1xyXG4gIGxldCBsYXN0RXZhbHVhdGVkS2V5OiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgdW5kZWZpbmVkO1xyXG5cclxuICBkbyB7XHJcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFF1ZXJ5Q29tbWFuZCh7XHJcbiAgICAgIC4uLmlucHV0LFxyXG4gICAgICBFeGNsdXNpdmVTdGFydEtleTogbGFzdEV2YWx1YXRlZEtleSxcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmV0cnlXaXRoQmFja29mZihcclxuICAgICAgYXN5bmMgKCkgPT4gYXdhaXQgZHluYW1vQ2xpZW50LnNlbmQoY29tbWFuZCksXHJcbiAgICAgIHtcclxuICAgICAgICBtYXhSZXRyaWVzOiAzLFxyXG4gICAgICAgIGluaXRpYWxEZWxheTogMTAwMCxcclxuICAgICAgICBiYWNrb2ZmTXVsdGlwbGllcjogMixcclxuICAgICAgICBqaXR0ZXI6IHRydWUsXHJcbiAgICAgICAgc2hvdWxkUmV0cnk6IChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgZXJyb3IubmFtZSA9PT0gJ1Byb3Zpc2lvbmVkVGhyb3VnaHB1dEV4Y2VlZGVkRXhjZXB0aW9uJyB8fFxyXG4gICAgICAgICAgICBlcnJvci5uYW1lID09PSAnVGhyb3R0bGluZ0V4Y2VwdGlvbidcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfSxcclxuICAgICAgfVxyXG4gICAgKTtcclxuXHJcbiAgICBpZiAocmVzcG9uc2UuSXRlbXMpIHtcclxuICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHJlc3BvbnNlLkl0ZW1zKSB7XHJcbiAgICAgICAgZGlzY2xvc3VyZXMucHVzaCh1bm1hcnNoYWxsKGl0ZW0pIGFzIERpc2Nsb3N1cmUpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbGFzdEV2YWx1YXRlZEtleSA9IHJlc3BvbnNlLkxhc3RFdmFsdWF0ZWRLZXk7XHJcbiAgfSB3aGlsZSAobGFzdEV2YWx1YXRlZEtleSk7XHJcblxyXG4gIHJldHVybiBkaXNjbG9zdXJlcztcclxufVxyXG5cclxuLyoqXHJcbiAqIER5bmFtb0RCIFNjYW7jgpLlrp/ooYxcclxuICpcclxuICogQHBhcmFtIGlucHV0IFNjYW5Db21tYW5kSW5wdXRcclxuICogQHJldHVybnMg6ZaL56S65oOF5aCx44Oq44K544OIXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBleGVjdXRlU2NhbihpbnB1dDogU2NhbkNvbW1hbmRJbnB1dCk6IFByb21pc2U8RGlzY2xvc3VyZVtdPiB7XHJcbiAgY29uc3QgZGlzY2xvc3VyZXM6IERpc2Nsb3N1cmVbXSA9IFtdO1xyXG4gIGxldCBsYXN0RXZhbHVhdGVkS2V5OiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgdW5kZWZpbmVkO1xyXG5cclxuICBkbyB7XHJcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFNjYW5Db21tYW5kKHtcclxuICAgICAgLi4uaW5wdXQsXHJcbiAgICAgIEV4Y2x1c2l2ZVN0YXJ0S2V5OiBsYXN0RXZhbHVhdGVkS2V5LFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXRyeVdpdGhCYWNrb2ZmKFxyXG4gICAgICBhc3luYyAoKSA9PiBhd2FpdCBkeW5hbW9DbGllbnQuc2VuZChjb21tYW5kKSxcclxuICAgICAge1xyXG4gICAgICAgIG1heFJldHJpZXM6IDMsXHJcbiAgICAgICAgaW5pdGlhbERlbGF5OiAxMDAwLFxyXG4gICAgICAgIGJhY2tvZmZNdWx0aXBsaWVyOiAyLFxyXG4gICAgICAgIGppdHRlcjogdHJ1ZSxcclxuICAgICAgICBzaG91bGRSZXRyeTogKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICBlcnJvci5uYW1lID09PSAnUHJvdmlzaW9uZWRUaHJvdWdocHV0RXhjZWVkZWRFeGNlcHRpb24nIHx8XHJcbiAgICAgICAgICAgIGVycm9yLm5hbWUgPT09ICdUaHJvdHRsaW5nRXhjZXB0aW9uJ1xyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9LFxyXG4gICAgICB9XHJcbiAgICApO1xyXG5cclxuICAgIGlmIChyZXNwb25zZS5JdGVtcykge1xyXG4gICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgcmVzcG9uc2UuSXRlbXMpIHtcclxuICAgICAgICBkaXNjbG9zdXJlcy5wdXNoKHVubWFyc2hhbGwoaXRlbSkgYXMgRGlzY2xvc3VyZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBsYXN0RXZhbHVhdGVkS2V5ID0gcmVzcG9uc2UuTGFzdEV2YWx1YXRlZEtleTtcclxuICB9IHdoaWxlIChsYXN0RXZhbHVhdGVkS2V5KTtcclxuXHJcbiAgcmV0dXJuIGRpc2Nsb3N1cmVzO1xyXG59XHJcblxyXG4vKipcclxuICog5pyI56+E5Zuy44KS55Sf5oiQXHJcbiAqXHJcbiAqIEBwYXJhbSBzdGFydCDplovlp4vmnIjvvIhZWVlZLU1N77yJXHJcbiAqIEBwYXJhbSBlbmQg57WC5LqG5pyI77yIWVlZWS1NTe+8iVxyXG4gKiBAcmV0dXJucyDmnIjjga7jg6rjgrnjg4jvvIhZWVlZLU1N5b2i5byP77yJXHJcbiAqL1xyXG5mdW5jdGlvbiBnZW5lcmF0ZU1vbnRoUmFuZ2Uoc3RhcnQ6IHN0cmluZywgZW5kOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgY29uc3QgbW9udGhzOiBzdHJpbmdbXSA9IFtdO1xyXG4gIGNvbnN0IFtzdGFydFllYXIsIHN0YXJ0TW9udGhdID0gc3RhcnQuc3BsaXQoJy0nKS5tYXAoTnVtYmVyKTtcclxuICBjb25zdCBbZW5kWWVhciwgZW5kTW9udGhdID0gZW5kLnNwbGl0KCctJykubWFwKE51bWJlcik7XHJcblxyXG4gIGxldCB5ZWFyID0gc3RhcnRZZWFyO1xyXG4gIGxldCBtb250aCA9IHN0YXJ0TW9udGg7XHJcblxyXG4gIHdoaWxlICh5ZWFyIDwgZW5kWWVhciB8fCAoeWVhciA9PT0gZW5kWWVhciAmJiBtb250aCA8PSBlbmRNb250aCkpIHtcclxuICAgIG1vbnRocy5wdXNoKGAke3llYXJ9LSR7U3RyaW5nKG1vbnRoKS5wYWRTdGFydCgyLCAnMCcpfWApO1xyXG4gICAgbW9udGgrKztcclxuICAgIGlmIChtb250aCA+IDEyKSB7XHJcbiAgICAgIG1vbnRoID0gMTtcclxuICAgICAgeWVhcisrO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIG1vbnRocztcclxufVxyXG4iXSwidmVyc2lvbiI6M30=