{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\__tests__\\handler.e2e.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collector\\__tests__\\handler.e2e.test.ts"],"sourcesContent":["/**\r\n * Lambda Collector Handler E2E Tests\r\n *\r\n * LocalStack環境でのエンドツーエンドテスト。\r\n * 実際のDynamoDB/S3との統合を検証します。\r\n *\r\n * Requirements: タスク35\r\n */\r\n\r\nimport { Context } from 'aws-lambda';\r\nimport { DynamoDBClient, GetItemCommand, ScanCommand } from '@aws-sdk/client-dynamodb';\r\nimport { S3Client, ListObjectsV2Command } from '@aws-sdk/client-s3';\r\nimport { unmarshall } from '@aws-sdk/util-dynamodb';\r\nimport { handler, CollectorEvent, CollectorResponse } from '../handler';\r\n\r\n// LocalStack用のクライアント設定\r\nconst dynamoClient = new DynamoDBClient({\r\n  region: process.env.AWS_REGION || 'ap-northeast-1',\r\n  endpoint: process.env.AWS_ENDPOINT || 'http://localhost:4566',\r\n});\r\n\r\nconst s3Client = new S3Client({\r\n  region: process.env.AWS_REGION || 'ap-northeast-1',\r\n  endpoint: process.env.AWS_ENDPOINT || 'http://localhost:4566',\r\n  forcePathStyle: true,\r\n});\r\n\r\n// テスト用のモックコンテキスト\r\nconst mockContext: Context = {\r\n  awsRequestId: 'test-request-id-e2e',\r\n  functionName: 'tdnet-collector-e2e',\r\n  functionVersion: '1',\r\n  invokedFunctionArn: 'arn:aws:lambda:ap-northeast-1:123456789012:function:tdnet-collector-e2e',\r\n  memoryLimitInMB: '512',\r\n  logGroupName: '/aws/lambda/tdnet-collector-e2e',\r\n  logStreamName: '2024/01/15/[$LATEST]e2e-test',\r\n  getRemainingTimeInMillis: () => 300000, // 5分\r\n  callbackWaitsForEmptyEventLoop: false,\r\n  done: jest.fn(),\r\n  fail: jest.fn(),\r\n  succeed: jest.fn(),\r\n};\r\n\r\ndescribe('Lambda Collector Handler E2E Tests', () => {\r\n  // テスト前にテーブルをクリーンアップ\r\n  beforeEach(async () => {\r\n    // DynamoDBテーブルのクリーンアップは省略（LocalStackは各テスト実行時にリセット）\r\n  });\r\n\r\n  describe('バッチモード', () => {\r\n    it('前日のデータを収集してDynamoDB/S3に保存する', async () => {\r\n      // Arrange\r\n      const event: CollectorEvent = {\r\n        mode: 'batch',\r\n      };\r\n\r\n      // Act\r\n      const response: CollectorResponse = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      expect(response).toBeDefined();\r\n      expect(response.execution_id).toBeDefined();\r\n      expect(response.status).toMatch(/^(success|partial_success|failed)$/);\r\n      expect(response.collected_count).toBeGreaterThanOrEqual(0);\r\n      expect(response.failed_count).toBeGreaterThanOrEqual(0);\r\n\r\n      // 実行状態がDynamoDBに保存されていることを確認\r\n      const executionStatus = await getExecutionStatus(response.execution_id);\r\n      expect(executionStatus).toBeDefined();\r\n      expect(executionStatus.execution_id).toBe(response.execution_id);\r\n      expect(executionStatus.status).toMatch(/^(pending|running|completed|failed)$/);\r\n    }, 60000); // 60秒タイムアウト\r\n  });\r\n\r\n  describe('オンデマンドモード', () => {\r\n    it('指定期間のデータを収集してDynamoDB/S3に保存する', async () => {\r\n      // Arrange\r\n      const yesterday = new Date();\r\n      yesterday.setDate(yesterday.getDate() - 1);\r\n      const dateStr = formatDate(yesterday);\r\n\r\n      const event: CollectorEvent = {\r\n        mode: 'on-demand',\r\n        start_date: dateStr,\r\n        end_date: dateStr,\r\n      };\r\n\r\n      // Act\r\n      const response: CollectorResponse = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      expect(response).toBeDefined();\r\n      expect(response.execution_id).toBeDefined();\r\n      expect(response.status).toMatch(/^(success|partial_success|failed)$/);\r\n      expect(response.collected_count).toBeGreaterThanOrEqual(0);\r\n      expect(response.failed_count).toBeGreaterThanOrEqual(0);\r\n\r\n      // 実行状態がDynamoDBに保存されていることを確認\r\n      const executionStatus = await getExecutionStatus(response.execution_id);\r\n      expect(executionStatus).toBeDefined();\r\n      expect(executionStatus.execution_id).toBe(response.execution_id);\r\n    }, 60000);\r\n\r\n    it('複数日の期間を指定してデータを収集する', async () => {\r\n      // Arrange\r\n      const endDate = new Date();\r\n      endDate.setDate(endDate.getDate() - 1);\r\n      const startDate = new Date(endDate);\r\n      startDate.setDate(startDate.getDate() - 2); // 3日間\r\n\r\n      const event: CollectorEvent = {\r\n        mode: 'on-demand',\r\n        start_date: formatDate(startDate),\r\n        end_date: formatDate(endDate),\r\n      };\r\n\r\n      // Act\r\n      const response: CollectorResponse = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      expect(response).toBeDefined();\r\n      expect(response.execution_id).toBeDefined();\r\n      expect(response.status).toMatch(/^(success|partial_success|failed)$/);\r\n\r\n      // 実行状態の進捗が100%になっていることを確認\r\n      const executionStatus = await getExecutionStatus(response.execution_id);\r\n      expect(executionStatus).toBeDefined();\r\n      expect(executionStatus.progress).toBe(100);\r\n    }, 120000); // 2分タイムアウト\r\n  });\r\n\r\n  describe('バリデーション', () => {\r\n    it('不正なモードでバリデーションエラー', async () => {\r\n      // Arrange\r\n      const event = {\r\n        mode: 'invalid-mode',\r\n      } as any;\r\n\r\n      // Act\r\n      const response: CollectorResponse = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      expect(response.status).toBe('failed');\r\n      expect(response.message).toContain('Invalid mode');\r\n    });\r\n\r\n    it('on-demandモードで日付が未指定の場合はバリデーションエラー', async () => {\r\n      // Arrange\r\n      const event: CollectorEvent = {\r\n        mode: 'on-demand',\r\n      };\r\n\r\n      // Act\r\n      const response: CollectorResponse = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      expect(response.status).toBe('failed');\r\n      expect(response.message).toContain('start_date and end_date are required');\r\n    });\r\n\r\n    it('不正な日付形式でバリデーションエラー', async () => {\r\n      // Arrange\r\n      const event: CollectorEvent = {\r\n        mode: 'on-demand',\r\n        start_date: '2024/01/15', // 不正な形式\r\n        end_date: '2024-01-15',\r\n      };\r\n\r\n      // Act\r\n      const response: CollectorResponse = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      expect(response.status).toBe('failed');\r\n      expect(response.message).toContain('Invalid start_date format');\r\n    });\r\n\r\n    it('開始日が終了日より後の場合はバリデーションエラー', async () => {\r\n      // Arrange\r\n      const event: CollectorEvent = {\r\n        mode: 'on-demand',\r\n        start_date: '2024-01-20',\r\n        end_date: '2024-01-15',\r\n      };\r\n\r\n      // Act\r\n      const response: CollectorResponse = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      expect(response.status).toBe('failed');\r\n      expect(response.message).toContain('must be before or equal to');\r\n    });\r\n  });\r\n\r\n  describe('DynamoDB統合', () => {\r\n    it('収集したデータがDynamoDBに保存される', async () => {\r\n      // Arrange\r\n      const yesterday = new Date();\r\n      yesterday.setDate(yesterday.getDate() - 1);\r\n      const dateStr = formatDate(yesterday);\r\n\r\n      const event: CollectorEvent = {\r\n        mode: 'on-demand',\r\n        start_date: dateStr,\r\n        end_date: dateStr,\r\n      };\r\n\r\n      // Act\r\n      const response: CollectorResponse = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      if (response.collected_count > 0) {\r\n        // DynamoDBから開示情報を取得\r\n        const disclosures = await scanDisclosures();\r\n        expect(disclosures.length).toBeGreaterThan(0);\r\n\r\n        // 最初の開示情報を検証\r\n        const disclosure = disclosures[0];\r\n        expect(disclosure.disclosure_id).toBeDefined();\r\n        expect(disclosure.company_code).toBeDefined();\r\n        expect(disclosure.company_name).toBeDefined();\r\n        expect(disclosure.disclosed_at).toBeDefined();\r\n        expect(disclosure.pdf_s3_key).toBeDefined();\r\n        expect(disclosure.date_partition).toMatch(/^\\d{4}-\\d{2}$/);\r\n      }\r\n    }, 60000);\r\n  });\r\n\r\n  describe('S3統合', () => {\r\n    it('収集したPDFがS3に保存される', async () => {\r\n      // Arrange\r\n      const yesterday = new Date();\r\n      yesterday.setDate(yesterday.getDate() - 1);\r\n      const dateStr = formatDate(yesterday);\r\n\r\n      const event: CollectorEvent = {\r\n        mode: 'on-demand',\r\n        start_date: dateStr,\r\n        end_date: dateStr,\r\n      };\r\n\r\n      // Act\r\n      const response: CollectorResponse = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      if (response.collected_count > 0) {\r\n        // S3からオブジェクトリストを取得\r\n        const objects = await listS3Objects();\r\n        expect(objects.length).toBeGreaterThan(0);\r\n\r\n        // オブジェクトキーの形式を検証\r\n        const objectKey = objects[0];\r\n        expect(objectKey).toMatch(/^\\d{4}\\/\\d{2}\\/\\d{2}\\/.+\\.pdf$/);\r\n      }\r\n    }, 60000);\r\n  });\r\n});\r\n\r\n/**\r\n * 実行状態を取得\r\n */\r\nasync function getExecutionStatus(execution_id: string): Promise<any> {\r\n  const command = new GetItemCommand({\r\n    TableName: process.env.DYNAMODB_EXECUTIONS_TABLE || 'tdnet_executions',\r\n    Key: {\r\n      execution_id: { S: execution_id },\r\n    },\r\n  });\r\n\r\n  const result = await dynamoClient.send(command);\r\n  return result.Item ? unmarshall(result.Item) : null;\r\n}\r\n\r\n/**\r\n * 開示情報をスキャン\r\n */\r\nasync function scanDisclosures(): Promise<any[]> {\r\n  const command = new ScanCommand({\r\n    TableName: process.env.DYNAMODB_TABLE_NAME || 'tdnet_disclosures',\r\n    Limit: 10,\r\n  });\r\n\r\n  const result = await dynamoClient.send(command);\r\n  return result.Items ? result.Items.map(item => unmarshall(item)) : [];\r\n}\r\n\r\n/**\r\n * S3オブジェクトをリスト\r\n */\r\nasync function listS3Objects(): Promise<string[]> {\r\n  const command = new ListObjectsV2Command({\r\n    Bucket: process.env.S3_BUCKET_NAME || 'tdnet-data-collector-pdfs-local',\r\n    MaxKeys: 10,\r\n  });\r\n\r\n  const result = await s3Client.send(command);\r\n  return result.Contents ? result.Contents.map(obj => obj.Key || '') : [];\r\n}\r\n\r\n/**\r\n * DateオブジェクトをYYYY-MM-DD形式にフォーマット\r\n */\r\nfunction formatDate(date: Date): string {\r\n  const year = date.getFullYear();\r\n  const month = String(date.getMonth() + 1).padStart(2, '0');\r\n  const day = String(date.getDate()).padStart(2, '0');\r\n  return `${year}-${month}-${day}`;\r\n}\r\n"],"version":3}