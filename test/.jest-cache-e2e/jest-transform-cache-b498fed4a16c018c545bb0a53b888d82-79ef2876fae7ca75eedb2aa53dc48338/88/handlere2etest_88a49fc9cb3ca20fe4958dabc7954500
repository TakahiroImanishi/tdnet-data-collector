d8a4b507eb8b417cee29d1c4ffd77209
"use strict";
/**
 * Lambda Collector Handler E2E Tests
 *
 * LocalStack環境でのエンドツーエンドテスト。
 * 実際のDynamoDB/S3との統合を検証します。
 *
 * Requirements: タスク35
 */
Object.defineProperty(exports, "__esModule", { value: true });
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const client_s3_1 = require("@aws-sdk/client-s3");
const util_dynamodb_1 = require("@aws-sdk/util-dynamodb");
const handler_1 = require("../handler");
// LocalStack用のクライアント設定
const dynamoClient = new client_dynamodb_1.DynamoDBClient({
    region: process.env.AWS_REGION || 'ap-northeast-1',
    endpoint: process.env.AWS_ENDPOINT || 'http://localhost:4566',
});
const s3Client = new client_s3_1.S3Client({
    region: process.env.AWS_REGION || 'ap-northeast-1',
    endpoint: process.env.AWS_ENDPOINT || 'http://localhost:4566',
    forcePathStyle: true,
});
// テスト用のモックコンテキスト
const mockContext = {
    awsRequestId: 'test-request-id-e2e',
    functionName: 'tdnet-collector-e2e',
    functionVersion: '1',
    invokedFunctionArn: 'arn:aws:lambda:ap-northeast-1:123456789012:function:tdnet-collector-e2e',
    memoryLimitInMB: '512',
    logGroupName: '/aws/lambda/tdnet-collector-e2e',
    logStreamName: '2024/01/15/[$LATEST]e2e-test',
    getRemainingTimeInMillis: () => 300000, // 5分
    callbackWaitsForEmptyEventLoop: false,
    done: jest.fn(),
    fail: jest.fn(),
    succeed: jest.fn(),
};
describe('Lambda Collector Handler E2E Tests', () => {
    // テスト前にテーブルをクリーンアップ
    beforeEach(async () => {
        // DynamoDBテーブルのクリーンアップは省略（LocalStackは各テスト実行時にリセット）
    });
    describe('バッチモード', () => {
        it('前日のデータを収集してDynamoDB/S3に保存する', async () => {
            // Arrange
            const event = {
                mode: 'batch',
            };
            // Act
            const response = await (0, handler_1.handler)(event, mockContext);
            // Assert
            expect(response).toBeDefined();
            expect(response.execution_id).toBeDefined();
            expect(response.status).toMatch(/^(success|partial_success|failed)$/);
            expect(response.collected_count).toBeGreaterThanOrEqual(0);
            expect(response.failed_count).toBeGreaterThanOrEqual(0);
            // 実行状態がDynamoDBに保存されていることを確認
            const executionStatus = await getExecutionStatus(response.execution_id);
            expect(executionStatus).toBeDefined();
            expect(executionStatus.execution_id).toBe(response.execution_id);
            expect(executionStatus.status).toMatch(/^(pending|running|completed|failed)$/);
        }, 60000); // 60秒タイムアウト
    });
    describe('オンデマンドモード', () => {
        it('指定期間のデータを収集してDynamoDB/S3に保存する', async () => {
            // Arrange
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = formatDate(yesterday);
            const event = {
                mode: 'on-demand',
                start_date: dateStr,
                end_date: dateStr,
            };
            // Act
            const response = await (0, handler_1.handler)(event, mockContext);
            // Assert
            expect(response).toBeDefined();
            expect(response.execution_id).toBeDefined();
            expect(response.status).toMatch(/^(success|partial_success|failed)$/);
            expect(response.collected_count).toBeGreaterThanOrEqual(0);
            expect(response.failed_count).toBeGreaterThanOrEqual(0);
            // 実行状態がDynamoDBに保存されていることを確認
            const executionStatus = await getExecutionStatus(response.execution_id);
            expect(executionStatus).toBeDefined();
            expect(executionStatus.execution_id).toBe(response.execution_id);
        }, 60000);
        it('複数日の期間を指定してデータを収集する', async () => {
            // Arrange
            const endDate = new Date();
            endDate.setDate(endDate.getDate() - 1);
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 2); // 3日間
            const event = {
                mode: 'on-demand',
                start_date: formatDate(startDate),
                end_date: formatDate(endDate),
            };
            // Act
            const response = await (0, handler_1.handler)(event, mockContext);
            // Assert
            expect(response).toBeDefined();
            expect(response.execution_id).toBeDefined();
            expect(response.status).toMatch(/^(success|partial_success|failed)$/);
            // 実行状態の進捗が100%になっていることを確認
            const executionStatus = await getExecutionStatus(response.execution_id);
            expect(executionStatus).toBeDefined();
            expect(executionStatus.progress).toBe(100);
        }, 120000); // 2分タイムアウト
    });
    describe('バリデーション', () => {
        it('不正なモードでバリデーションエラー', async () => {
            // Arrange
            const event = {
                mode: 'invalid-mode',
            };
            // Act
            const response = await (0, handler_1.handler)(event, mockContext);
            // Assert
            expect(response.status).toBe('failed');
            expect(response.message).toContain('Invalid mode');
        });
        it('on-demandモードで日付が未指定の場合はバリデーションエラー', async () => {
            // Arrange
            const event = {
                mode: 'on-demand',
            };
            // Act
            const response = await (0, handler_1.handler)(event, mockContext);
            // Assert
            expect(response.status).toBe('failed');
            expect(response.message).toContain('start_date and end_date are required');
        });
        it('不正な日付形式でバリデーションエラー', async () => {
            // Arrange
            const event = {
                mode: 'on-demand',
                start_date: '2024/01/15', // 不正な形式
                end_date: '2024-01-15',
            };
            // Act
            const response = await (0, handler_1.handler)(event, mockContext);
            // Assert
            expect(response.status).toBe('failed');
            expect(response.message).toContain('Invalid start_date format');
        });
        it('開始日が終了日より後の場合はバリデーションエラー', async () => {
            // Arrange
            const event = {
                mode: 'on-demand',
                start_date: '2024-01-20',
                end_date: '2024-01-15',
            };
            // Act
            const response = await (0, handler_1.handler)(event, mockContext);
            // Assert
            expect(response.status).toBe('failed');
            expect(response.message).toContain('must be before or equal to');
        });
    });
    describe('DynamoDB統合', () => {
        it('収集したデータがDynamoDBに保存される', async () => {
            // Arrange
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = formatDate(yesterday);
            const event = {
                mode: 'on-demand',
                start_date: dateStr,
                end_date: dateStr,
            };
            // Act
            const response = await (0, handler_1.handler)(event, mockContext);
            // Assert
            if (response.collected_count > 0) {
                // DynamoDBから開示情報を取得
                const disclosures = await scanDisclosures();
                expect(disclosures.length).toBeGreaterThan(0);
                // 最初の開示情報を検証
                const disclosure = disclosures[0];
                expect(disclosure.disclosure_id).toBeDefined();
                expect(disclosure.company_code).toBeDefined();
                expect(disclosure.company_name).toBeDefined();
                expect(disclosure.disclosed_at).toBeDefined();
                expect(disclosure.pdf_s3_key).toBeDefined();
                expect(disclosure.date_partition).toMatch(/^\d{4}-\d{2}$/);
            }
        }, 60000);
    });
    describe('S3統合', () => {
        it('収集したPDFがS3に保存される', async () => {
            // Arrange
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = formatDate(yesterday);
            const event = {
                mode: 'on-demand',
                start_date: dateStr,
                end_date: dateStr,
            };
            // Act
            const response = await (0, handler_1.handler)(event, mockContext);
            // Assert
            if (response.collected_count > 0) {
                // S3からオブジェクトリストを取得
                const objects = await listS3Objects();
                expect(objects.length).toBeGreaterThan(0);
                // オブジェクトキーの形式を検証
                const objectKey = objects[0];
                expect(objectKey).toMatch(/^\d{4}\/\d{2}\/\d{2}\/.+\.pdf$/);
            }
        }, 60000);
    });
});
/**
 * 実行状態を取得
 */
async function getExecutionStatus(execution_id) {
    const command = new client_dynamodb_1.GetItemCommand({
        TableName: process.env.DYNAMODB_EXECUTIONS_TABLE || 'tdnet_executions',
        Key: {
            execution_id: { S: execution_id },
        },
    });
    const result = await dynamoClient.send(command);
    return result.Item ? (0, util_dynamodb_1.unmarshall)(result.Item) : null;
}
/**
 * 開示情報をスキャン
 */
async function scanDisclosures() {
    const command = new client_dynamodb_1.ScanCommand({
        TableName: process.env.DYNAMODB_TABLE_NAME || 'tdnet_disclosures',
        Limit: 10,
    });
    const result = await dynamoClient.send(command);
    return result.Items ? result.Items.map(item => (0, util_dynamodb_1.unmarshall)(item)) : [];
}
/**
 * S3オブジェクトをリスト
 */
async function listS3Objects() {
    const command = new client_s3_1.ListObjectsV2Command({
        Bucket: process.env.S3_BUCKET_NAME || 'tdnet-data-collector-pdfs-local',
        MaxKeys: 10,
    });
    const result = await s3Client.send(command);
    return result.Contents ? result.Contents.map(obj => obj.Key || '') : [];
}
/**
 * DateオブジェクトをYYYY-MM-DD形式にフォーマット
 */
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXGNvbGxlY3RvclxcX190ZXN0c19fXFxoYW5kbGVyLmUyZS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7OztHQU9HOztBQUdILDhEQUF1RjtBQUN2RixrREFBb0U7QUFDcEUsMERBQW9EO0FBQ3BELHdDQUF3RTtBQUV4RSx1QkFBdUI7QUFDdkIsTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDO0lBQ3RDLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxnQkFBZ0I7SUFDbEQsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLHVCQUF1QjtDQUM5RCxDQUFDLENBQUM7QUFFSCxNQUFNLFFBQVEsR0FBRyxJQUFJLG9CQUFRLENBQUM7SUFDNUIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLGdCQUFnQjtJQUNsRCxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLElBQUksdUJBQXVCO0lBQzdELGNBQWMsRUFBRSxJQUFJO0NBQ3JCLENBQUMsQ0FBQztBQUVILGlCQUFpQjtBQUNqQixNQUFNLFdBQVcsR0FBWTtJQUMzQixZQUFZLEVBQUUscUJBQXFCO0lBQ25DLFlBQVksRUFBRSxxQkFBcUI7SUFDbkMsZUFBZSxFQUFFLEdBQUc7SUFDcEIsa0JBQWtCLEVBQUUseUVBQXlFO0lBQzdGLGVBQWUsRUFBRSxLQUFLO0lBQ3RCLFlBQVksRUFBRSxpQ0FBaUM7SUFDL0MsYUFBYSxFQUFFLDhCQUE4QjtJQUM3Qyx3QkFBd0IsRUFBRSxHQUFHLEVBQUUsQ0FBQyxNQUFNLEVBQUUsS0FBSztJQUM3Qyw4QkFBOEIsRUFBRSxLQUFLO0lBQ3JDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0lBQ2YsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7SUFDZixPQUFPLEVBQUUsSUFBSSxDQUFD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QUNaLENBQUMsQ0FBQztJQUVILE1BQU0sTUFBTSxHQUFHLE1BQU0sUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM1QyxPQUFPLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0FBQzFFLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsVUFBVSxDQUFDLElBQVU7SUFDNUIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2hDLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMzRCxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNwRCxPQUFPLEdBQUcsSUFBSSxJQUFJLEtBQUssSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUNuQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcdGkxOThcXGludmVzdG1lbnRfYW5hbHlzaXNfb3BvcG9cXHNyY1xcbGFtYmRhXFxjb2xsZWN0b3JcXF9fdGVzdHNfX1xcaGFuZGxlci5lMmUudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogTGFtYmRhIENvbGxlY3RvciBIYW5kbGVyIEUyRSBUZXN0c1xyXG4gKlxyXG4gKiBMb2NhbFN0YWNr55Kw5aKD44Gn44Gu44Ko44Oz44OJ44OE44O844Ko44Oz44OJ44OG44K544OI44CCXHJcbiAqIOWun+mam+OBrkR5bmFtb0RCL1Mz44Go44Gu57Wx5ZCI44KS5qSc6Ki844GX44G+44GZ44CCXHJcbiAqXHJcbiAqIFJlcXVpcmVtZW50czog44K/44K544KvMzVcclxuICovXHJcblxyXG5pbXBvcnQgeyBDb250ZXh0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XHJcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50LCBHZXRJdGVtQ29tbWFuZCwgU2NhbkNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xyXG5pbXBvcnQgeyBTM0NsaWVudCwgTGlzdE9iamVjdHNWMkNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xyXG5pbXBvcnQgeyB1bm1hcnNoYWxsIH0gZnJvbSAnQGF3cy1zZGsvdXRpbC1keW5hbW9kYic7XHJcbmltcG9ydCB7IGhhbmRsZXIsIENvbGxlY3RvckV2ZW50LCBDb2xsZWN0b3JSZXNwb25zZSB9IGZyb20gJy4uL2hhbmRsZXInO1xyXG5cclxuLy8gTG9jYWxTdGFja+eUqOOBruOCr+ODqeOCpOOCouODs+ODiOioreWumlxyXG5jb25zdCBkeW5hbW9DbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe1xyXG4gIHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB8fCAnYXAtbm9ydGhlYXN0LTEnLFxyXG4gIGVuZHBvaW50OiBwcm9jZXNzLmVudi5BV1NfRU5EUE9JTlQgfHwgJ2h0dHA6Ly9sb2NhbGhvc3Q6NDU2NicsXHJcbn0pO1xyXG5cclxuY29uc3QgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoe1xyXG4gIHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB8fCAnYXAtbm9ydGhlYXN0LTEnLFxyXG4gIGVuZHBvaW50OiBwcm9jZXNzLmVudi5BV1NfRU5EUE9JTlQgfHwgJ2h0dHA6Ly9sb2NhbGhvc3Q6NDU2NicsXHJcbiAgZm9yY2VQYXRoU3R5bGU6IHRydWUsXHJcbn0pO1xyXG5cclxuLy8g44OG44K544OI55So44Gu44Oi44OD44Kv44Kz44Oz44OG44Kt44K544OIXHJcbmNvbnN0IG1vY2tDb250ZXh0OiBDb250ZXh0ID0ge1xyXG4gIGF3c1JlcXVlc3RJZDogJ3Rlc3QtcmVxdWVzdC1pZC1lMmUnLFxyXG4gIGZ1bmN0aW9uTmFtZTogJ3RkbmV0LWNvbGxlY3Rvci1lMmUnLFxyXG4gIGZ1bmN0aW9uVmVyc2lvbjogJzEnLFxyXG4gIGludm9rZWRGdW5jdGlvbkFybjogJ2Fybjphd3M6bGFtYmRhOmFwLW5vcnRoZWFzdC0xOjEyMzQ1Njc4OTAxMjpmdW5jdGlvbjp0ZG5ldC1jb2xsZWN0b3ItZTJlJyxcclxuICBtZW1vcnlMaW1pdEluTUI6ICc1MTInLFxyXG4gIGxvZ0dyb3VwTmFtZTogJy9hd3MvbGFtYmRhL3RkbmV0LWNvbGxlY3Rvci1lMmUnLFxyXG4gIGxvZ1N0cmVhbU5hbWU6ICcyMDI0LzAxLzE1L1skTEFURVNUXWUyZS10ZXN0JyxcclxuICBnZXRSZW1haW5pbmdUaW1lSW5NaWxsaXM6ICgpID0+IDMwMDAwMCwgLy8gNeWIhlxyXG4gIGNhbGxiYWNrV2FpdHNGb3JFbXB0eUV2ZW50TG9vcDogZmFsc2UsXHJcbiAgZG9uZTogamVzdC5mbigpLFxyXG4gIGZhaWw6IGplc3QuZm4oKSxcclxuICBzdWNjZWVkOiBqZXN0LmZuKCksXHJcbn07XHJcblxyXG5kZXNjcmliZSgnTGFtYmRhIENvbGxlY3RvciBIYW5kbGVyIEUyRSBUZXN0cycsICgpID0+IHtcclxuICAvLyDjg4bjgrnjg4jliY3jgavjg4bjg7zjg5bjg6vjgpLjgq/jg6rjg7zjg7PjgqLjg4Pjg5dcclxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcclxuICAgIC8vIER5bmFtb0RC44OG44O844OW44Or44Gu44Kv44Oq44O844Oz44Ki44OD44OX44Gv55yB55Wl77yITG9jYWxTdGFja+OBr+WQhOODhuOCueODiOWun+ihjOaZguOBq+ODquOCu+ODg+ODiO+8iVxyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgn44OQ44OD44OB44Oi44O844OJJywgKCkgPT4ge1xyXG4gICAgaXQoJ+WJjeaXpeOBruODh+ODvOOCv+OCkuWPjumbhuOBl+OBpkR5bmFtb0RCL1Mz44Gr5L+d5a2Y44GZ44KLJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAvLyBBcnJhbmdlXHJcbiAgICAgIGNvbnN0IGV2ZW50OiBDb2xsZWN0b3JFdmVudCA9IHtcclxuICAgICAgICBtb2RlOiAnYmF0Y2gnLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgLy8gQWN0XHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlOiBDb2xsZWN0b3JSZXNwb25zZSA9IGF3YWl0IGhhbmRsZXIoZXZlbnQsIG1vY2tDb250ZXh0KTtcclxuXHJcbiAgICAgIC8vIEFzc2VydFxyXG4gICAgICBleHBlY3QocmVzcG9uc2UpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgIGV4cGVjdChyZXNwb25zZS5leGVjdXRpb25faWQpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvTWF0Y2goL14oc3VjY2Vzc3xwYXJ0aWFsX3N1Y2Nlc3N8ZmFpbGVkKSQvKTtcclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmNvbGxlY3RlZF9jb3VudCkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgwKTtcclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmZhaWxlZF9jb3VudCkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgwKTtcclxuXHJcbiAgICAgIC8vIOWun+ihjOeKtuaFi+OBjER5bmFtb0RC44Gr5L+d5a2Y44GV44KM44Gm44GE44KL44GT44Go44KS56K66KqNXHJcbiAgICAgIGNvbnN0IGV4ZWN1dGlvblN0YXR1cyA9IGF3YWl0IGdldEV4ZWN1dGlvblN0YXR1cyhyZXNwb25zZS5leGVjdXRpb25faWQpO1xyXG4gICAgICBleHBlY3QoZXhlY3V0aW9uU3RhdHVzKS50b0JlRGVmaW5lZCgpO1xyXG4gICAgICBleHBlY3QoZXhlY3V0aW9uU3RhdHVzLmV4ZWN1dGlvbl9pZCkudG9CZShyZXNwb25zZS5leGVjdXRpb25faWQpO1xyXG4gICAgICBleHBlY3QoZXhlY3V0aW9uU3RhdHVzLnN0YXR1cykudG9NYXRjaCgvXihwZW5kaW5nfHJ1bm5pbmd8Y29tcGxldGVkfGZhaWxlZCkkLyk7XHJcbiAgICB9LCA2MDAwMCk7IC8vIDYw56eS44K/44Kk44Og44Ki44Km44OIXHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCfjgqrjg7Pjg4fjg57jg7Pjg4njg6Ljg7zjg4knLCAoKSA9PiB7XHJcbiAgICBpdCgn5oyH5a6a5pyf6ZaT44Gu44OH44O844K/44KS5Y+O6ZuG44GX44GmRHluYW1vREIvUzPjgavkv53lrZjjgZnjgosnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgY29uc3QgeWVzdGVyZGF5ID0gbmV3IERhdGUoKTtcclxuICAgICAgeWVzdGVyZGF5LnNldERhdGUoeWVzdGVyZGF5LmdldERhdGUoKSAtIDEpO1xyXG4gICAgICBjb25zdCBkYXRlU3RyID0gZm9ybWF0RGF0ZSh5ZXN0ZXJkYXkpO1xyXG5cclxuICAgICAgY29uc3QgZXZlbnQ6IENvbGxlY3RvckV2ZW50ID0ge1xyXG4gICAgICAgIG1vZGU6ICdvbi1kZW1hbmQnLFxyXG4gICAgICAgIHN0YXJ0X2RhdGU6IGRhdGVTdHIsXHJcbiAgICAgICAgZW5kX2RhdGU6IGRhdGVTdHIsXHJcbiAgICAgIH07XHJcblxyXG4gICAgICAvLyBBY3RcclxuICAgICAgY29uc3QgcmVzcG9uc2U6IENvbGxlY3RvclJlc3BvbnNlID0gYXdhaXQgaGFuZGxlcihldmVudCwgbW9ja0NvbnRleHQpO1xyXG5cclxuICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgIGV4cGVjdChyZXNwb25zZSkudG9CZURlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmV4ZWN1dGlvbl9pZCkudG9CZURlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9NYXRjaCgvXihzdWNjZXNzfHBhcnRpYWxfc3VjY2Vzc3xmYWlsZWQpJC8pO1xyXG4gICAgICBleHBlY3QocmVzcG9uc2UuY29sbGVjdGVkX2NvdW50KS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDApO1xyXG4gICAgICBleHBlY3QocmVzcG9uc2UuZmFpbGVkX2NvdW50KS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDApO1xyXG5cclxuICAgICAgLy8g5a6f6KGM54q25oWL44GMRHluYW1vRELjgavkv53lrZjjgZXjgozjgabjgYTjgovjgZPjgajjgpLnorroqo1cclxuICAgICAgY29uc3QgZXhlY3V0aW9uU3RhdHVzID0gYXdhaXQgZ2V0RXhlY3V0aW9uU3RhdHVzKHJlc3BvbnNlLmV4ZWN1dGlvbl9pZCk7XHJcbiAgICAgIGV4cGVjdChleGVjdXRpb25TdGF0dXMpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgIGV4cGVjdChleGVjdXRpb25TdGF0dXMuZXhlY3V0aW9uX2lkKS50b0JlKHJlc3BvbnNlLmV4ZWN1dGlvbl9pZCk7XHJcbiAgICB9LCA2MDAwMCk7XHJcblxyXG4gICAgaXQoJ+ikh+aVsOaXpeOBruacn+mWk+OCkuaMh+WumuOBl+OBpuODh+ODvOOCv+OCkuWPjumbhuOBmeOCiycsIGFzeW5jICgpID0+IHtcclxuICAgICAgLy8gQXJyYW5nZVxyXG4gICAgICBjb25zdCBlbmREYXRlID0gbmV3IERhdGUoKTtcclxuICAgICAgZW5kRGF0ZS5zZXREYXRlKGVuZERhdGUuZ2V0RGF0ZSgpIC0gMSk7XHJcbiAgICAgIGNvbnN0IHN0YXJ0RGF0ZSA9IG5ldyBEYXRlKGVuZERhdGUpO1xyXG4gICAgICBzdGFydERhdGUuc2V0RGF0ZShzdGFydERhdGUuZ2V0RGF0ZSgpIC0gMik7IC8vIDPml6XplpNcclxuXHJcbiAgICAgIGNvbnN0IGV2ZW50OiBDb2xsZWN0b3JFdmVudCA9IHtcclxuICAgICAgICBtb2RlOiAnb24tZGVtYW5kJyxcclxuICAgICAgICBzdGFydF9kYXRlOiBmb3JtYXREYXRlKHN0YXJ0RGF0ZSksXHJcbiAgICAgICAgZW5kX2RhdGU6IGZvcm1hdERhdGUoZW5kRGF0ZSksXHJcbiAgICAgIH07XHJcblxyXG4gICAgICAvLyBBY3RcclxuICAgICAgY29uc3QgcmVzcG9uc2U6IENvbGxlY3RvclJlc3BvbnNlID0gYXdhaXQgaGFuZGxlcihldmVudCwgbW9ja0NvbnRleHQpO1xyXG5cclxuICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgIGV4cGVjdChyZXNwb25zZSkudG9CZURlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmV4ZWN1dGlvbl9pZCkudG9CZURlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9NYXRjaCgvXihzdWNjZXNzfHBhcnRpYWxfc3VjY2Vzc3xmYWlsZWQpJC8pO1xyXG5cclxuICAgICAgLy8g5a6f6KGM54q25oWL44Gu6YCy5o2X44GMMTAwJeOBq+OBquOBo+OBpuOBhOOCi+OBk+OBqOOCkueiuuiqjVxyXG4gICAgICBjb25zdCBleGVjdXRpb25TdGF0dXMgPSBhd2FpdCBnZXRFeGVjdXRpb25TdGF0dXMocmVzcG9uc2UuZXhlY3V0aW9uX2lkKTtcclxuICAgICAgZXhwZWN0KGV4ZWN1dGlvblN0YXR1cykudG9CZURlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KGV4ZWN1dGlvblN0YXR1cy5wcm9ncmVzcykudG9CZSgxMDApO1xyXG4gICAgfSwgMTIwMDAwKTsgLy8gMuWIhuOCv+OCpOODoOOCouOCpuODiFxyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgn44OQ44Oq44OH44O844K344On44OzJywgKCkgPT4ge1xyXG4gICAgaXQoJ+S4jeato+OBquODouODvOODieOBp+ODkOODquODh+ODvOOCt+ODp+ODs+OCqOODqeODvCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgLy8gQXJyYW5nZVxyXG4gICAgICBjb25zdCBldmVudCA9IHtcclxuICAgICAgICBtb2RlOiAnaW52YWxpZC1tb2RlJyxcclxuICAgICAgfSBhcyBhbnk7XHJcblxyXG4gICAgICAvLyBBY3RcclxuICAgICAgY29uc3QgcmVzcG9uc2U6IENvbGxlY3RvclJlc3BvbnNlID0gYXdhaXQgaGFuZGxlcihldmVudCwgbW9ja0NvbnRleHQpO1xyXG5cclxuICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoJ2ZhaWxlZCcpO1xyXG4gICAgICBleHBlY3QocmVzcG9uc2UubWVzc2FnZSkudG9Db250YWluKCdJbnZhbGlkIG1vZGUnKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdvbi1kZW1hbmTjg6Ljg7zjg4njgafml6Xku5jjgYzmnKrmjIflrprjga7loLTlkIjjga/jg5Djg6rjg4fjg7zjgrfjg6fjg7Pjgqjjg6njg7wnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgY29uc3QgZXZlbnQ6IENvbGxlY3RvckV2ZW50ID0ge1xyXG4gICAgICAgIG1vZGU6ICdvbi1kZW1hbmQnLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgLy8gQWN0XHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlOiBDb2xsZWN0b3JSZXNwb25zZSA9IGF3YWl0IGhhbmRsZXIoZXZlbnQsIG1vY2tDb250ZXh0KTtcclxuXHJcbiAgICAgIC8vIEFzc2VydFxyXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKCdmYWlsZWQnKTtcclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLm1lc3NhZ2UpLnRvQ29udGFpbignc3RhcnRfZGF0ZSBhbmQgZW5kX2RhdGUgYXJlIHJlcXVpcmVkJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgn5LiN5q2j44Gq5pel5LuY5b2i5byP44Gn44OQ44Oq44OH44O844K344On44Oz44Ko44Op44O8JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAvLyBBcnJhbmdlXHJcbiAgICAgIGNvbnN0IGV2ZW50OiBDb2xsZWN0b3JFdmVudCA9IHtcclxuICAgICAgICBtb2RlOiAnb24tZGVtYW5kJyxcclxuICAgICAgICBzdGFydF9kYXRlOiAnMjAyNC8wMS8xNScsIC8vIOS4jeato+OBquW9ouW8j1xyXG4gICAgICAgIGVuZF9kYXRlOiAnMjAyNC0wMS0xNScsXHJcbiAgICAgIH07XHJcblxyXG4gICAgICAvLyBBY3RcclxuICAgICAgY29uc3QgcmVzcG9uc2U6IENvbGxlY3RvclJlc3BvbnNlID0gYXdhaXQgaGFuZGxlcihldmVudCwgbW9ja0NvbnRleHQpO1xyXG5cclxuICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoJ2ZhaWxlZCcpO1xyXG4gICAgICBleHBlY3QocmVzcG9uc2UubWVzc2FnZSkudG9Db250YWluKCdJbnZhbGlkIHN0YXJ0X2RhdGUgZm9ybWF0Jyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgn6ZaL5aeL5pel44GM57WC5LqG5pel44KI44KK5b6M44Gu5aC05ZCI44Gv44OQ44Oq44OH44O844K344On44Oz44Ko44Op44O8JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAvLyBBcnJhbmdlXHJcbiAgICAgIGNvbnN0IGV2ZW50OiBDb2xsZWN0b3JFdmVudCA9IHtcclxuICAgICAgICBtb2RlOiAnb24tZGVtYW5kJyxcclxuICAgICAgICBzdGFydF9kYXRlOiAnMjAyNC0wMS0yMCcsXHJcbiAgICAgICAgZW5kX2RhdGU6ICcyMDI0LTAxLTE1JyxcclxuICAgICAgfTtcclxuXHJcbiAgICAgIC8vIEFjdFxyXG4gICAgICBjb25zdCByZXNwb25zZTogQ29sbGVjdG9yUmVzcG9uc2UgPSBhd2FpdCBoYW5kbGVyKGV2ZW50LCBtb2NrQ29udGV4dCk7XHJcblxyXG4gICAgICAvLyBBc3NlcnRcclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSgnZmFpbGVkJyk7XHJcbiAgICAgIGV4cGVjdChyZXNwb25zZS5tZXNzYWdlKS50b0NvbnRhaW4oJ211c3QgYmUgYmVmb3JlIG9yIGVxdWFsIHRvJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0R5bmFtb0RC57Wx5ZCIJywgKCkgPT4ge1xyXG4gICAgaXQoJ+WPjumbhuOBl+OBn+ODh+ODvOOCv+OBjER5bmFtb0RC44Gr5L+d5a2Y44GV44KM44KLJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAvLyBBcnJhbmdlXHJcbiAgICAgIGNvbnN0IHllc3RlcmRheSA9IG5ldyBEYXRlKCk7XHJcbiAgICAgIHllc3RlcmRheS5zZXREYXRlKHllc3RlcmRheS5nZXREYXRlKCkgLSAxKTtcclxuICAgICAgY29uc3QgZGF0ZVN0ciA9IGZvcm1hdERhdGUoeWVzdGVyZGF5KTtcclxuXHJcbiAgICAgIGNvbnN0IGV2ZW50OiBDb2xsZWN0b3JFdmVudCA9IHtcclxuICAgICAgICBtb2RlOiAnb24tZGVtYW5kJyxcclxuICAgICAgICBzdGFydF9kYXRlOiBkYXRlU3RyLFxyXG4gICAgICAgIGVuZF9kYXRlOiBkYXRlU3RyLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgLy8gQWN0XHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlOiBDb2xsZWN0b3JSZXNwb25zZSA9IGF3YWl0IGhhbmRsZXIoZXZlbnQsIG1vY2tDb250ZXh0KTtcclxuXHJcbiAgICAgIC8vIEFzc2VydFxyXG4gICAgICBpZiAocmVzcG9uc2UuY29sbGVjdGVkX2NvdW50ID4gMCkge1xyXG4gICAgICAgIC8vIER5bmFtb0RC44GL44KJ6ZaL56S65oOF5aCx44KS5Y+W5b6XXHJcbiAgICAgICAgY29uc3QgZGlzY2xvc3VyZXMgPSBhd2FpdCBzY2FuRGlzY2xvc3VyZXMoKTtcclxuICAgICAgICBleHBlY3QoZGlzY2xvc3VyZXMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XHJcblxyXG4gICAgICAgIC8vIOacgOWIneOBrumWi+ekuuaDheWgseOCkuaknOiovFxyXG4gICAgICAgIGNvbnN0IGRpc2Nsb3N1cmUgPSBkaXNjbG9zdXJlc1swXTtcclxuICAgICAgICBleHBlY3QoZGlzY2xvc3VyZS5kaXNjbG9zdXJlX2lkKS50b0JlRGVmaW5lZCgpO1xyXG4gICAgICAgIGV4cGVjdChkaXNjbG9zdXJlLmNvbXBhbnlfY29kZSkudG9CZURlZmluZWQoKTtcclxuICAgICAgICBleHBlY3QoZGlzY2xvc3VyZS5jb21wYW55X25hbWUpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgICAgZXhwZWN0KGRpc2Nsb3N1cmUuZGlzY2xvc2VkX2F0KS50b0JlRGVmaW5lZCgpO1xyXG4gICAgICAgIGV4cGVjdChkaXNjbG9zdXJlLnBkZl9zM19rZXkpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgICAgZXhwZWN0KGRpc2Nsb3N1cmUuZGF0ZV9wYXJ0aXRpb24pLnRvTWF0Y2goL15cXGR7NH0tXFxkezJ9JC8pO1xyXG4gICAgICB9XHJcbiAgICB9LCA2MDAwMCk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdTM+e1seWQiCcsICgpID0+IHtcclxuICAgIGl0KCflj47pm4bjgZfjgZ9QREbjgYxTM+OBq+S/neWtmOOBleOCjOOCiycsIGFzeW5jICgpID0+IHtcclxuICAgICAgLy8gQXJyYW5nZVxyXG4gICAgICBjb25zdCB5ZXN0ZXJkYXkgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICB5ZXN0ZXJkYXkuc2V0RGF0ZSh5ZXN0ZXJkYXkuZ2V0RGF0ZSgpIC0gMSk7XHJcbiAgICAgIGNvbnN0IGRhdGVTdHIgPSBmb3JtYXREYXRlKHllc3RlcmRheSk7XHJcblxyXG4gICAgICBjb25zdCBldmVudDogQ29sbGVjdG9yRXZlbnQgPSB7XHJcbiAgICAgICAgbW9kZTogJ29uLWRlbWFuZCcsXHJcbiAgICAgICAgc3RhcnRfZGF0ZTogZGF0ZVN0cixcclxuICAgICAgICBlbmRfZGF0ZTogZGF0ZVN0cixcclxuICAgICAgfTtcclxuXHJcbiAgICAgIC8vIEFjdFxyXG4gICAgICBjb25zdCByZXNwb25zZTogQ29sbGVjdG9yUmVzcG9uc2UgPSBhd2FpdCBoYW5kbGVyKGV2ZW50LCBtb2NrQ29udGV4dCk7XHJcblxyXG4gICAgICAvLyBBc3NlcnRcclxuICAgICAgaWYgKHJlc3BvbnNlLmNvbGxlY3RlZF9jb3VudCA+IDApIHtcclxuICAgICAgICAvLyBTM+OBi+OCieOCquODluOCuOOCp+OCr+ODiOODquOCueODiOOCkuWPluW+l1xyXG4gICAgICAgIGNvbnN0IG9iamVjdHMgPSBhd2FpdCBsaXN0UzNPYmplY3RzKCk7XHJcbiAgICAgICAgZXhwZWN0KG9iamVjdHMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XHJcblxyXG4gICAgICAgIC8vIOOCquODluOCuOOCp+OCr+ODiOOCreODvOOBruW9ouW8j+OCkuaknOiovFxyXG4gICAgICAgIGNvbnN0IG9iamVjdEtleSA9IG9iamVjdHNbMF07XHJcbiAgICAgICAgZXhwZWN0KG9iamVjdEtleSkudG9NYXRjaCgvXlxcZHs0fVxcL1xcZHsyfVxcL1xcZHsyfVxcLy4rXFwucGRmJC8pO1xyXG4gICAgICB9XHJcbiAgICB9LCA2MDAwMCk7XHJcbiAgfSk7XHJcbn0pO1xyXG5cclxuLyoqXHJcbiAqIOWun+ihjOeKtuaFi+OCkuWPluW+l1xyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gZ2V0RXhlY3V0aW9uU3RhdHVzKGV4ZWN1dGlvbl9pZDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcclxuICBjb25zdCBjb21tYW5kID0gbmV3IEdldEl0ZW1Db21tYW5kKHtcclxuICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuRFlOQU1PREJfRVhFQ1VUSU9OU19UQUJMRSB8fCAndGRuZXRfZXhlY3V0aW9ucycsXHJcbiAgICBLZXk6IHtcclxuICAgICAgZXhlY3V0aW9uX2lkOiB7IFM6IGV4ZWN1dGlvbl9pZCB9LFxyXG4gICAgfSxcclxuICB9KTtcclxuXHJcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZHluYW1vQ2xpZW50LnNlbmQoY29tbWFuZCk7XHJcbiAgcmV0dXJuIHJlc3VsdC5JdGVtID8gdW5tYXJzaGFsbChyZXN1bHQuSXRlbSkgOiBudWxsO1xyXG59XHJcblxyXG4vKipcclxuICog6ZaL56S65oOF5aCx44KS44K544Kt44Oj44OzXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBzY2FuRGlzY2xvc3VyZXMoKTogUHJvbWlzZTxhbnlbXT4ge1xyXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgU2NhbkNvbW1hbmQoe1xyXG4gICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5EWU5BTU9EQl9UQUJMRV9OQU1FIHx8ICd0ZG5ldF9kaXNjbG9zdXJlcycsXHJcbiAgICBMaW1pdDogMTAsXHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGR5bmFtb0NsaWVudC5zZW5kKGNvbW1hbmQpO1xyXG4gIHJldHVybiByZXN1bHQuSXRlbXMgPyByZXN1bHQuSXRlbXMubWFwKGl0ZW0gPT4gdW5tYXJzaGFsbChpdGVtKSkgOiBbXTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFMz44Kq44OW44K444Kn44Kv44OI44KS44Oq44K544OIXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBsaXN0UzNPYmplY3RzKCk6IFByb21pc2U8c3RyaW5nW10+IHtcclxuICBjb25zdCBjb21tYW5kID0gbmV3IExpc3RPYmplY3RzVjJDb21tYW5kKHtcclxuICAgIEJ1Y2tldDogcHJvY2Vzcy5lbnYuUzNfQlVDS0VUX05BTUUgfHwgJ3RkbmV0LWRhdGEtY29sbGVjdG9yLXBkZnMtbG9jYWwnLFxyXG4gICAgTWF4S2V5czogMTAsXHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHMzQ2xpZW50LnNlbmQoY29tbWFuZCk7XHJcbiAgcmV0dXJuIHJlc3VsdC5Db250ZW50cyA/IHJlc3VsdC5Db250ZW50cy5tYXAob2JqID0+IG9iai5LZXkgfHwgJycpIDogW107XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBEYXRl44Kq44OW44K444Kn44Kv44OI44KSWVlZWS1NTS1EROW9ouW8j+OBq+ODleOCqeODvOODnuODg+ODiFxyXG4gKi9cclxuZnVuY3Rpb24gZm9ybWF0RGF0ZShkYXRlOiBEYXRlKTogc3RyaW5nIHtcclxuICBjb25zdCB5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpO1xyXG4gIGNvbnN0IG1vbnRoID0gU3RyaW5nKGRhdGUuZ2V0TW9udGgoKSArIDEpLnBhZFN0YXJ0KDIsICcwJyk7XHJcbiAgY29uc3QgZGF5ID0gU3RyaW5nKGRhdGUuZ2V0RGF0ZSgpKS5wYWRTdGFydCgyLCAnMCcpO1xyXG4gIHJldHVybiBgJHt5ZWFyfS0ke21vbnRofS0ke2RheX1gO1xyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==