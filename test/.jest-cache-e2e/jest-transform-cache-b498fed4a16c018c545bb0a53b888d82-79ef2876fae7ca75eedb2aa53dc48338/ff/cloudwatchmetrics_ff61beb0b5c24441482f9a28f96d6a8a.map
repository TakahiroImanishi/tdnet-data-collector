{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\utils\\cloudwatch-metrics.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\utils\\cloudwatch-metrics.ts"],"sourcesContent":["/**\r\n * CloudWatch Metrics送信ユーティリティ\r\n *\r\n * Lambda関数からCloudWatchにカスタムメトリクスを送信します。\r\n * エラー発生時の監視とアラート設定に使用します。\r\n *\r\n * Requirements: 要件7.1（監視とアラート）\r\n */\r\n\r\nimport { CloudWatchClient, PutMetricDataCommand } from '@aws-sdk/client-cloudwatch';\r\nimport { logger } from './logger';\r\n\r\n// CloudWatchクライアントはグローバルスコープで初期化（再利用される）\r\nconst cloudwatchClient = new CloudWatchClient({});\r\n\r\n/**\r\n * メトリクス名前空間\r\n */\r\nconst NAMESPACE = 'TDnet';\r\n\r\n/**\r\n * メトリクスディメンション\r\n */\r\nexport interface MetricDimensions {\r\n  [key: string]: string;\r\n}\r\n\r\n/**\r\n * CloudWatchにメトリクスを送信\r\n *\r\n * @param metricName メトリクス名\r\n * @param value メトリクス値\r\n * @param unit メトリクス単位（デフォルト: Count）\r\n * @param dimensions ディメンション（オプション）\r\n *\r\n * @example\r\n * ```typescript\r\n * // エラーカウント\r\n * await sendMetric('LambdaError', 1, 'Count', {\r\n *   ErrorType: 'NetworkError',\r\n *   FunctionName: 'Collector',\r\n * });\r\n *\r\n * // 処理時間\r\n * await sendMetric('ProcessingTime', 1234, 'Milliseconds', {\r\n *   FunctionName: 'Collector',\r\n * });\r\n *\r\n * // 成功カウント\r\n * await sendMetric('DisclosuresCollected', 10, 'Count', {\r\n *   Date: '2024-01-15',\r\n * });\r\n * ```\r\n */\r\nexport async function sendMetric(\r\n  metricName: string,\r\n  value: number,\r\n  unit: 'Count' | 'Milliseconds' | 'Bytes' | 'Percent' = 'Count',\r\n  dimensions?: MetricDimensions\r\n): Promise<void> {\r\n  try {\r\n    const metricData = {\r\n      MetricName: metricName,\r\n      Value: value,\r\n      Unit: unit,\r\n      Timestamp: new Date(),\r\n      Dimensions: dimensions\r\n        ? Object.entries(dimensions).map(([Name, Value]) => ({ Name, Value }))\r\n        : undefined,\r\n    };\r\n\r\n    await cloudwatchClient.send(\r\n      new PutMetricDataCommand({\r\n        Namespace: NAMESPACE,\r\n        MetricData: [metricData],\r\n      })\r\n    );\r\n\r\n    logger.debug('Metric sent to CloudWatch', {\r\n      namespace: NAMESPACE,\r\n      metric_name: metricName,\r\n      value,\r\n      unit,\r\n      dimensions,\r\n    });\r\n  } catch (error) {\r\n    // メトリクス送信失敗はログに記録するが、エラーをスローしない\r\n    // メトリクス送信失敗でメイン処理を中断しないため\r\n    logger.warn('Failed to send metric to CloudWatch', {\r\n      metric_name: metricName,\r\n      value,\r\n      error_type: error instanceof Error ? error.constructor.name : 'Unknown',\r\n      error_message: error instanceof Error ? error.message : String(error),\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * 複数のメトリクスを一括送信\r\n *\r\n * @param metrics メトリクスの配列\r\n *\r\n * @example\r\n * ```typescript\r\n * await sendMetrics([\r\n *   { name: 'DisclosuresCollected', value: 10, unit: 'Count' },\r\n *   { name: 'DisclosuresFailed', value: 2, unit: 'Count' },\r\n *   { name: 'ProcessingTime', value: 5000, unit: 'Milliseconds' },\r\n * ]);\r\n * ```\r\n */\r\nexport async function sendMetrics(\r\n  metrics: Array<{\r\n    name: string;\r\n    value: number;\r\n    unit?: 'Count' | 'Milliseconds' | 'Bytes' | 'Percent';\r\n    dimensions?: MetricDimensions;\r\n  }>\r\n): Promise<void> {\r\n  try {\r\n    const metricData = metrics.map((metric) => ({\r\n      MetricName: metric.name,\r\n      Value: metric.value,\r\n      Unit: metric.unit || 'Count',\r\n      Timestamp: new Date(),\r\n      Dimensions: metric.dimensions\r\n        ? Object.entries(metric.dimensions).map(([Name, Value]) => ({ Name, Value }))\r\n        : undefined,\r\n    }));\r\n\r\n    await cloudwatchClient.send(\r\n      new PutMetricDataCommand({\r\n        Namespace: NAMESPACE,\r\n        MetricData: metricData,\r\n      })\r\n    );\r\n\r\n    logger.debug('Metrics sent to CloudWatch', {\r\n      namespace: NAMESPACE,\r\n      count: metrics.length,\r\n    });\r\n  } catch (error) {\r\n    logger.warn('Failed to send metrics to CloudWatch', {\r\n      count: metrics.length,\r\n      error_type: error instanceof Error ? error.constructor.name : 'Unknown',\r\n      error_message: error instanceof Error ? error.message : String(error),\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * エラーメトリクスを送信\r\n *\r\n * @param errorType エラータイプ\r\n * @param functionName 関数名\r\n * @param additionalDimensions 追加ディメンション（オプション）\r\n *\r\n * @example\r\n * ```typescript\r\n * try {\r\n *   await operation();\r\n * } catch (error) {\r\n *   await sendErrorMetric(\r\n *     error.constructor.name,\r\n *     'Collector',\r\n *     { Date: '2024-01-15' }\r\n *   );\r\n *   throw error;\r\n * }\r\n * ```\r\n */\r\nexport async function sendErrorMetric(\r\n  errorType: string,\r\n  functionName: string,\r\n  additionalDimensions?: MetricDimensions\r\n): Promise<void> {\r\n  await sendMetric('LambdaError', 1, 'Count', {\r\n    ErrorType: errorType,\r\n    FunctionName: functionName,\r\n    ...additionalDimensions,\r\n  });\r\n}\r\n\r\n/**\r\n * 成功メトリクスを送信\r\n *\r\n * @param count 成功件数\r\n * @param functionName 関数名\r\n * @param additionalDimensions 追加ディメンション（オプション）\r\n *\r\n * @example\r\n * ```typescript\r\n * await sendSuccessMetric(10, 'Collector', { Date: '2024-01-15' });\r\n * ```\r\n */\r\nexport async function sendSuccessMetric(\r\n  count: number,\r\n  functionName: string,\r\n  additionalDimensions?: MetricDimensions\r\n): Promise<void> {\r\n  await sendMetric('OperationSuccess', count, 'Count', {\r\n    FunctionName: functionName,\r\n    ...additionalDimensions,\r\n  });\r\n}\r\n"],"version":3}