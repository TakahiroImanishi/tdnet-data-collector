{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\scraper\\html-parser.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\scraper\\html-parser.ts"],"sourcesContent":["/**\r\n * TDnet HTMLパーサー\r\n *\r\n * TDnet開示情報リストページのHTMLをパースし、メタデータを抽出します。\r\n *\r\n * Requirements: 要件1.1, 1.2（データ収集、メタデータ抽出）\r\n * \r\n * @example\r\n * ```typescript\r\n * import { RateLimiter } from '../utils/rate-limiter';\r\n * import { parseDisclosureList } from './html-parser';\r\n * import axios from 'axios';\r\n * \r\n * // RateLimiterを使用してTDnetからHTMLを取得\r\n * const rateLimiter = new RateLimiter({ minDelayMs: 2000 });\r\n * \r\n * async function fetchAndParseDisclosures(date: string) {\r\n *   await rateLimiter.waitIfNeeded();\r\n *   const response = await axios.get(`https://www.release.tdnet.info/inbs/I_list_001_${date}.html`);\r\n *   return parseDisclosureList(response.data);\r\n * }\r\n * ```\r\n */\r\n\r\nimport * as cheerio from 'cheerio';\r\nimport { logger } from '../utils/logger';\r\nimport { ValidationError } from '../errors';\r\n\r\n/**\r\n * 開示情報メタデータ\r\n */\r\nexport interface DisclosureMetadata {\r\n  company_code: string;\r\n  company_name: string;\r\n  disclosure_type: string;\r\n  title: string;\r\n  disclosed_at: string; // ISO 8601形式（UTC）\r\n  pdf_url: string;\r\n}\r\n\r\n/**\r\n * TDnet開示情報リストページのHTMLをパース\r\n *\r\n * @param html HTMLコンテンツ\r\n * @param requestDate リクエスト日付（YYYY-MM-DD形式）- disclosed_at生成に使用\r\n * @returns 開示情報メタデータの配列\r\n * @throws ValidationError HTMLが不正な場合\r\n */\r\nexport function parseDisclosureList(html: string, requestDate: string): DisclosureMetadata[] {\r\n  try {\r\n    // HTMLの基本検証\r\n    if (!html || html.trim().length === 0) {\r\n      throw new ValidationError('HTML content is empty');\r\n    }\r\n\r\n    // cheerioでHTMLをロード\r\n    const $ = cheerio.load(html);\r\n    const disclosures: DisclosureMetadata[] = [];\r\n\r\n    // HTML構造の検証（テーブルが存在するか）\r\n    const tables = $('table#main-list-table');\r\n    if (tables.length === 0) {\r\n      // HTMLプレビューをBase64エンコードしてログ出力（エンコーディングエラー回避）\r\n      const htmlPreview = html.substring(0, 200);\r\n      const htmlPreviewBase64 = Buffer.from(htmlPreview, 'utf-8').toString('base64');\r\n      \r\n      logger.warn('No disclosure table found in HTML', {\r\n        html_length: html.length,\r\n        html_preview_base64: htmlPreviewBase64,\r\n        decode_instruction: 'Use Buffer.from(html_preview_base64, \"base64\").toString(\"utf-8\") to decode',\r\n      });\r\n      // HTML構造が変更された可能性を検知\r\n      detectHtmlStructureChange($);\r\n      return [];\r\n    }\r\n\r\n    // ページヘッダーから日付を抽出（フォールバック用）\r\n    const pageDate = extractPageDate($) || requestDate;\r\n\r\n    // TDnetのテーブル構造に基づいてパース\r\n    // 実際のHTML構造: table#main-list-table > tr > td (7セル)\r\n    $('table#main-list-table tr').each((index, element) => {\r\n      const $row = $(element);\r\n      const cells = $row.find('td');\r\n\r\n      // 7セル未満の行はスキップ（ヘッダーまたは不正な行）\r\n      if (cells.length < 7) {\r\n        if (cells.length > 0) {\r\n          logger.debug('Skipping row with insufficient cells', { \r\n            index, \r\n            cellCount: cells.length \r\n          });\r\n        }\r\n        return;\r\n      }\r\n\r\n      try {\r\n        // Cell 0: kjTime - 時刻（HH:MM形式）\r\n        const time = $(cells[0]).text().trim();\r\n        \r\n        // Cell 1: kjCode - 企業コード（5桁）\r\n        const companyCode = $(cells[1]).text().trim();\r\n        \r\n        // Cell 2: kjName - 企業名\r\n        const companyName = $(cells[2]).text().trim();\r\n        \r\n        // Cell 3: kjTitle - タイトル（PDFリンク付き）\r\n        const $titleCell = $(cells[3]);\r\n        const title = $titleCell.text().trim();\r\n        const pdfUrl = $titleCell.find('a').attr('href') || '';\r\n        \r\n        // Cell 4: kjXbrl - XBRL（オプション、スキップ）\r\n        // Cell 5: kjPlace - 取引所（オプション、スキップ）\r\n        // Cell 6: kjHistroy - 履歴（オプション、スキップ）\r\n\r\n        const disclosure: DisclosureMetadata = {\r\n          company_code: companyCode,\r\n          company_name: companyName,\r\n          disclosure_type: extractDisclosureType(title),\r\n          title: title,\r\n          disclosed_at: parseDisclosedAt(pageDate, time),\r\n          pdf_url: buildAbsolutePdfUrl(pdfUrl),\r\n        };\r\n\r\n        // バリデーション\r\n        validateDisclosureMetadata(disclosure);\r\n\r\n        disclosures.push(disclosure);\r\n      } catch (error) {\r\n        logger.error('Failed to parse disclosure row', {\r\n          error_type: error instanceof Error ? error.constructor.name : 'Unknown',\r\n          error_message: error instanceof Error ? error.message : String(error),\r\n          row_index: index,\r\n        });\r\n      }\r\n    });\r\n\r\n    logger.info('HTML parsing completed', {\r\n      total_rows: $('table#main-list-table tr').length,\r\n      parsed_disclosures: disclosures.length,\r\n      page_date: pageDate,\r\n    });\r\n\r\n    return disclosures;\r\n  } catch (error) {\r\n    logger.error('Failed to parse HTML', {\r\n      error_type: error instanceof Error ? error.constructor.name : 'Unknown',\r\n      error_message: error instanceof Error ? error.message : String(error),\r\n      html_length: html?.length || 0,\r\n    });\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * ページヘッダーから日付を抽出\r\n *\r\n * @param $ cheerioインスタンス\r\n * @returns 日付文字列（YYYY-MM-DD形式）、抽出失敗時はnull\r\n *\r\n * @example\r\n * HTML: <div id=\"kaiji-date-1\">2026年02月13日</div>\r\n * Result: \"2026-02-13\"\r\n */\r\nfunction extractPageDate($: cheerio.CheerioAPI): string | null {\r\n  try {\r\n    const dateText = $('#kaiji-date-1').text().trim();\r\n    // \"2026年02月13日\" → \"2026-02-13\"\r\n    const match = dateText.match(/(\\d{4})年(\\d{2})月(\\d{2})日/);\r\n    if (match) {\r\n      const [, year, month, day] = match;\r\n      return `${year}-${month}-${day}`;\r\n    }\r\n    return null;\r\n  } catch (error) {\r\n    logger.warn('Failed to extract page date', {\r\n      error_message: error instanceof Error ? error.message : String(error),\r\n    });\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * タイトルから開示種類を抽出\r\n *\r\n * @param title タイトル文字列\r\n * @returns 開示種類\r\n *\r\n * @remarks\r\n * タイトルから開示種類を推測する簡易実装。\r\n * より正確な分類が必要な場合は、TDnetのカテゴリ情報を使用する。\r\n */\r\nfunction extractDisclosureType(title: string): string {\r\n  // 決算関連\r\n  if (title.includes('決算') || title.includes('業績')) {\r\n    return '決算短信';\r\n  }\r\n  // 適時開示\r\n  if (title.includes('適時開示')) {\r\n    return '適時開示';\r\n  }\r\n  // IR資料\r\n  if (title.includes('説明資料') || title.includes('プレゼンテーション')) {\r\n    return 'IR資料';\r\n  }\r\n  // その他\r\n  return 'その他';\r\n}\r\n\r\n/**\r\n * 相対PDFURLを絶対URLに変換\r\n *\r\n * @param relativePath 相対パス（例: \"140120260213562187.pdf\"）\r\n * @returns 絶対URL\r\n */\r\nfunction buildAbsolutePdfUrl(relativePath: string): string {\r\n  if (!relativePath) {\r\n    return '';\r\n  }\r\n  \r\n  // 既に絶対URLの場合はそのまま返す\r\n  if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {\r\n    return relativePath;\r\n  }\r\n  \r\n  // TDnetのベースURL\r\n  const baseUrl = 'https://www.release.tdnet.info/inbs';\r\n  \r\n  // 相対パスを絶対URLに変換\r\n  return `${baseUrl}/${relativePath}`;\r\n}\r\n\r\n/**\r\n * 開示日時をISO 8601形式（UTC）に変換\r\n *\r\n * @param date 日付文字列（YYYY-MM-DD形式）\r\n * @param time 時刻文字列（HH:MM形式）\r\n * @returns ISO 8601形式の日時文字列\r\n */\r\nfunction parseDisclosedAt(date: string, time: string): string {\r\n  // 日付と時刻を結合してJST日時を作成\r\n  // 例: \"2026-02-13\" + \"22:00\" → \"2026-02-13T22:00:00+09:00\"\r\n  const jstDate = new Date(`${date}T${time}:00+09:00`);\r\n  \r\n  if (isNaN(jstDate.getTime())) {\r\n    throw new ValidationError(`Invalid date/time: ${date} ${time}`);\r\n  }\r\n  \r\n  return jstDate.toISOString();\r\n}\r\n\r\n/**\r\n * 開示情報メタデータのバリデーション\r\n *\r\n * @param disclosure 開示情報メタデータ\r\n * @throws ValidationError バリデーションエラー\r\n */\r\nfunction validateDisclosureMetadata(disclosure: DisclosureMetadata): void {\r\n  // 企業コードは4桁または5桁の英数字（数字とA-Z）\r\n  if (!disclosure.company_code || !/^[0-9A-Z]{4,5}$/.test(disclosure.company_code)) {\r\n    throw new ValidationError(`Invalid company_code: ${disclosure.company_code}`);\r\n  }\r\n\r\n  if (!disclosure.company_name) {\r\n    throw new ValidationError('company_name is required');\r\n  }\r\n\r\n  if (!disclosure.disclosure_type) {\r\n    throw new ValidationError('disclosure_type is required');\r\n  }\r\n\r\n  if (!disclosure.title) {\r\n    throw new ValidationError('title is required');\r\n  }\r\n\r\n  if (!disclosure.disclosed_at) {\r\n    throw new ValidationError('disclosed_at is required');\r\n  }\r\n\r\n  if (!disclosure.pdf_url || !disclosure.pdf_url.startsWith('http')) {\r\n    throw new ValidationError(`Invalid pdf_url: ${disclosure.pdf_url}`);\r\n  }\r\n}\r\n\r\n/**\r\n * HTML構造の変更を検知\r\n *\r\n * TDnetのHTML構造が変更された場合を検知し、ログに記録する。\r\n * steeringファイル（development/tdnet-scraping-patterns.md）の要件に準拠。\r\n *\r\n * @param $ cheerioインスタンス\r\n * @returns HTML構造が変更されている場合はtrue\r\n */\r\nfunction detectHtmlStructureChange($: cheerio.CheerioAPI): boolean {\r\n  const expectedSelectors = [\r\n    'table#main-list-table',\r\n    'table#main-list-table tr',\r\n    'table#main-list-table td',\r\n    'div#kaiji-date-1',\r\n  ];\r\n\r\n  let structureChanged = false;\r\n\r\n  for (const selector of expectedSelectors) {\r\n    if ($(selector).length === 0) {\r\n      logger.error('HTML structure changed: selector not found', {\r\n        selector,\r\n        error_type: 'HtmlStructureChangeDetected',\r\n      });\r\n      structureChanged = true;\r\n    }\r\n  }\r\n\r\n  if (structureChanged) {\r\n    logger.error('TDnet HTML structure has changed', {\r\n      error_type: 'HtmlStructureChangeDetected',\r\n      message: 'Expected HTML selectors not found. TDnet may have updated their website structure.',\r\n      action_required: 'Update html-parser.ts to match new HTML structure',\r\n    });\r\n  }\r\n\r\n  return structureChanged;\r\n}\r\n"],"version":3}