{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\utils\\date-partition.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\utils\\date-partition.ts"],"sourcesContent":["/**\n * date_partition生成ユーティリティ\n *\n * disclosed_atからdate_partition（YYYY-MM形式、JST基準）を生成します。\n * DynamoDBのGSIパーティションキーとして使用され、月単位のクエリを高速化します。\n *\n * Requirements: 要件2.1（date_partition）\n */\n\nimport { ValidationError } from '../errors';\n\n/**\n * disclosed_atのバリデーション\n *\n * @param disclosedAt - ISO 8601形式の日時文字列（UTC推奨）\n * @throws {ValidationError} フォーマットまたは範囲が不正な場合\n */\nexport function validateDisclosedAt(disclosedAt: string): void {\n  // ISO 8601形式チェック\n  const iso8601Regex = /^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{3})?([Z]|[+-]\\d{2}:\\d{2})$/;\n  if (!iso8601Regex.test(disclosedAt)) {\n    throw new ValidationError(\n      `Invalid disclosed_at format: ${disclosedAt}. Expected ISO 8601 format (e.g., \"2024-01-15T10:30:00Z\")`,\n      { disclosed_at: disclosedAt }\n    );\n  }\n\n  // 有効な日付チェック\n  const date = new Date(disclosedAt);\n  if (isNaN(date.getTime())) {\n    throw new ValidationError(`Invalid date: ${disclosedAt}. Date does not exist.`, {\n      disclosed_at: disclosedAt,\n    });\n  }\n\n  // 日付の正規化チェック（例: 2024-02-30 → 2024-03-01 のような変換を検出）\n  // ISO8601文字列から年月日を抽出して、Dateオブジェクトと比較\n  const match = disclosedAt.match(/^(\\d{4})-(\\d{2})-(\\d{2})/);\n  if (match) {\n    const [, yearStr, monthStr, dayStr] = match;\n    const inputYear = parseInt(yearStr, 10);\n    const inputMonth = parseInt(monthStr, 10);\n    const inputDay = parseInt(dayStr, 10);\n\n    // Dateオブジェクトの年月日と比較（UTCで比較）\n    if (\n      date.getUTCFullYear() !== inputYear ||\n      date.getUTCMonth() + 1 !== inputMonth ||\n      date.getUTCDate() !== inputDay\n    ) {\n      throw new ValidationError(`Invalid date: ${disclosedAt}. Date does not exist.`, {\n        disclosed_at: disclosedAt,\n        parsed_date: date.toISOString(),\n      });\n    }\n  }\n\n  // 範囲チェック（1970-01-01 以降、現在時刻+1日以内）\n  const minDate = new Date('1970-01-01T00:00:00Z');\n  const maxDate = new Date(Date.now() + 24 * 60 * 60 * 1000); // 現在時刻+1日\n  if (date < minDate || date > maxDate) {\n    throw new ValidationError(\n      `Date out of range: ${disclosedAt}. Must be between 1970-01-01 and ${maxDate.toISOString()}`,\n      {\n        disclosed_at: disclosedAt,\n        min_date: minDate.toISOString(),\n        max_date: maxDate.toISOString(),\n      }\n    );\n  }\n}\n\n/**\n * disclosed_atからdate_partitionを生成（JST基準）\n *\n * TDnetは日本の開示情報サービスであり、開示時刻は日本時間（JST, UTC+9）で管理されます。\n * そのため、date_partitionはJST基準で生成します。\n *\n * 例：\n * - UTC: 2024-01-31T15:30:00Z → JST: 2024-02-01T00:30:00 → \"2024-02\"\n * - UTC: 2024-02-01T14:59:59Z → JST: 2024-01-31T23:59:59 → \"2024-01\"\n *\n * @param disclosedAt - ISO 8601形式の日時文字列（UTC推奨）\n * @returns YYYY-MM形式のdate_partition\n * @throws {ValidationError} 不正なフォーマットまたは日付の場合\n */\nexport function generateDatePartition(disclosedAt: string): string {\n  // バリデーション\n  validateDisclosedAt(disclosedAt);\n\n  // UTCからJSTに変換（UTC+9時間）\n  const utcDate = new Date(disclosedAt);\n  const jstDate = new Date(utcDate.getTime() + 9 * 60 * 60 * 1000);\n\n  // YYYY-MM形式で返却\n  const year = jstDate.getUTCFullYear();\n  const month = String(jstDate.getUTCMonth() + 1).padStart(2, '0');\n\n  return `${year}-${month}`;\n}\n\n/**\n * 月範囲を生成するヘルパー関数\n *\n * 開始月から終了月までの月のリストを生成します。\n * 日付範囲クエリで複数月を並行クエリする際に使用します。\n *\n * 例：\n * - generateMonthRange(\"2024-01\", \"2024-03\") → [\"2024-01\", \"2024-02\", \"2024-03\"]\n *\n * @param start - 開始月（YYYY-MM形式）\n * @param end - 終了月（YYYY-MM形式）\n * @returns 月のリスト（YYYY-MM形式）\n * @throws {ValidationError} フォーマットまたは範囲が不正な場合\n */\nexport function generateMonthRange(start: string, end: string): string[] {\n  // フォーマット検証\n  const monthRegex = /^\\d{4}-\\d{2}$/;\n  if (!monthRegex.test(start) || !monthRegex.test(end)) {\n    throw new ValidationError(\n      `Invalid month format. Expected YYYY-MM format. Got: start=${start}, end=${end}`,\n      { start, end }\n    );\n  }\n\n  const [startYear, startMonth] = start.split('-').map(Number);\n  const [endYear, endMonth] = end.split('-').map(Number);\n\n  // 範囲チェック（開始月 <= 終了月）\n  if (startYear > endYear || (startYear === endYear && startMonth > endMonth)) {\n    throw new ValidationError(\n      `Invalid month range: start (${start}) must be before or equal to end (${end})`,\n      { start, end }\n    );\n  }\n\n  const months: string[] = [];\n  let year = startYear;\n  let month = startMonth;\n\n  while (year < endYear || (year === endYear && month <= endMonth)) {\n    months.push(`${year}-${String(month).padStart(2, '0')}`);\n    month++;\n    if (month > 12) {\n      month = 1;\n      year++;\n    }\n  }\n\n  return months;\n}\n\n/**\n * yearMonthフォーマットのバリデーション\n *\n * @param yearMonth - YYYY-MM形式の文字列\n * @throws {ValidationError} フォーマットが不正な場合\n */\nexport function validateYearMonth(yearMonth: string): void {\n  const monthRegex = /^\\d{4}-\\d{2}$/;\n  if (!monthRegex.test(yearMonth)) {\n    throw new ValidationError(`Invalid yearMonth format: ${yearMonth}. Expected YYYY-MM format.`, {\n      year_month: yearMonth,\n    });\n  }\n\n  // 月の範囲チェック（01〜12）\n  const [, monthStr] = yearMonth.split('-');\n  const month = Number(monthStr);\n  if (month < 1 || month > 12) {\n    throw new ValidationError(`Invalid month: ${month}. Month must be between 01 and 12.`, {\n      year_month: yearMonth,\n      month,\n    });\n  }\n}\n"],"version":3}