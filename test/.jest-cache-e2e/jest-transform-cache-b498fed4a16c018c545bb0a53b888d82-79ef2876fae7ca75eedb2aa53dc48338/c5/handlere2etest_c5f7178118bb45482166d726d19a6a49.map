{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collect-status\\__tests__\\handler.e2e.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\lambda\\collect-status\\__tests__\\handler.e2e.test.ts"],"sourcesContent":["/**\r\n * Lambda Collect Status Handler E2E Tests\r\n *\r\n * LocalStack環境でのエンドツーエンドテスト。\r\n * 実際のDynamoDBとの統合を検証します。\r\n *\r\n * Requirements: タスク35\r\n */\r\n\r\nimport { APIGatewayProxyEvent, Context } from 'aws-lambda';\r\nimport { DynamoDBClient, PutItemCommand } from '@aws-sdk/client-dynamodb';\r\nimport { marshall } from '@aws-sdk/util-dynamodb';\r\nimport { handler } from '../handler';\r\n\r\n// LocalStack用のクライアント設定\r\nconst dynamoClient = new DynamoDBClient({\r\n  region: process.env.AWS_REGION || 'ap-northeast-1',\r\n  endpoint: process.env.AWS_ENDPOINT || 'http://localhost:4566',\r\n});\r\n\r\n// テスト用のモックコンテキスト\r\nconst mockContext: Context = {\r\n  awsRequestId: 'test-request-id-e2e',\r\n  functionName: 'tdnet-collect-status-e2e',\r\n  functionVersion: '1',\r\n  invokedFunctionArn: 'arn:aws:lambda:ap-northeast-1:123456789012:function:tdnet-collect-status-e2e',\r\n  memoryLimitInMB: '256',\r\n  logGroupName: '/aws/lambda/tdnet-collect-status-e2e',\r\n  logStreamName: '2024/01/15/[$LATEST]e2e-test',\r\n  getRemainingTimeInMillis: () => 30000,\r\n  callbackWaitsForEmptyEventLoop: false,\r\n  done: jest.fn(),\r\n  fail: jest.fn(),\r\n  succeed: jest.fn(),\r\n};\r\n\r\ndescribe('Lambda Collect Status Handler E2E Tests', () => {\r\n  describe('実行状態取得', () => {\r\n    it('存在する実行IDの状態を取得できる', async () => {\r\n      // Arrange\r\n      const execution_id = `test_exec_${Date.now()}`;\r\n      const executionStatus = {\r\n        execution_id,\r\n        status: 'running',\r\n        progress: 50,\r\n        collected_count: 10,\r\n        failed_count: 2,\r\n        started_at: new Date().toISOString(),\r\n        updated_at: new Date().toISOString(),\r\n      };\r\n\r\n      // DynamoDBにテストデータを挿入\r\n      await putExecutionStatus(executionStatus);\r\n\r\n      const event: APIGatewayProxyEvent = createMockEvent(execution_id);\r\n\r\n      // Act\r\n      const response = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      expect(response.statusCode).toBe(200);\r\n      expect(response.headers).toHaveProperty('Content-Type', 'application/json');\r\n      expect(response.headers).toHaveProperty('Access-Control-Allow-Origin', '*');\r\n\r\n      const body = JSON.parse(response.body);\r\n      expect(body.status).toBe('success');\r\n      expect(body.data).toBeDefined();\r\n      expect(body.data.execution_id).toBe(execution_id);\r\n      expect(body.data.status).toBe('running');\r\n      expect(body.data.progress).toBe(50);\r\n      expect(body.data.collected_count).toBe(10);\r\n      expect(body.data.failed_count).toBe(2);\r\n    });\r\n\r\n    it('完了状態の実行IDを取得できる', async () => {\r\n      // Arrange\r\n      const execution_id = `test_exec_completed_${Date.now()}`;\r\n      const executionStatus = {\r\n        execution_id,\r\n        status: 'completed',\r\n        progress: 100,\r\n        collected_count: 50,\r\n        failed_count: 0,\r\n        started_at: new Date(Date.now() - 60000).toISOString(),\r\n        updated_at: new Date(Date.now() - 30000).toISOString(),\r\n        completed_at: new Date(Date.now() - 30000).toISOString(),\r\n      };\r\n\r\n      await putExecutionStatus(executionStatus);\r\n\r\n      const event: APIGatewayProxyEvent = createMockEvent(execution_id);\r\n\r\n      // Act\r\n      const response = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      expect(response.statusCode).toBe(200);\r\n\r\n      const body = JSON.parse(response.body);\r\n      expect(body.data.status).toBe('completed');\r\n      expect(body.data.progress).toBe(100);\r\n      expect(body.data.completed_at).toBeDefined();\r\n    });\r\n\r\n    it('失敗状態の実行IDを取得できる', async () => {\r\n      // Arrange\r\n      const execution_id = `test_exec_failed_${Date.now()}`;\r\n      const executionStatus = {\r\n        execution_id,\r\n        status: 'failed',\r\n        progress: 30,\r\n        collected_count: 5,\r\n        failed_count: 10,\r\n        started_at: new Date(Date.now() - 60000).toISOString(),\r\n        updated_at: new Date(Date.now() - 30000).toISOString(),\r\n        completed_at: new Date(Date.now() - 30000).toISOString(),\r\n        error_message: 'Network error occurred',\r\n      };\r\n\r\n      await putExecutionStatus(executionStatus);\r\n\r\n      const event: APIGatewayProxyEvent = createMockEvent(execution_id);\r\n\r\n      // Act\r\n      const response = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      expect(response.statusCode).toBe(200);\r\n\r\n      const body = JSON.parse(response.body);\r\n      expect(body.data.status).toBe('failed');\r\n      expect(body.data.error_message).toBe('Network error occurred');\r\n    });\r\n  });\r\n\r\n  describe('エラーハンドリング', () => {\r\n    it('存在しない実行IDの場合は404エラー', async () => {\r\n      // Arrange\r\n      const execution_id = 'non_existent_execution_id';\r\n      const event: APIGatewayProxyEvent = createMockEvent(execution_id);\r\n\r\n      // Act\r\n      const response = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      expect(response.statusCode).toBe(404);\r\n      expect(response.headers).toHaveProperty('Content-Type', 'application/json');\r\n      expect(response.headers).toHaveProperty('Access-Control-Allow-Origin', '*');\r\n\r\n      const body = JSON.parse(response.body);\r\n      expect(body.status).toBe('error');\r\n      expect(body.error.code).toBe('NOT_FOUND');\r\n      expect(body.error.message).toContain('Execution not found');\r\n    });\r\n\r\n    it('execution_idが未指定の場合は400エラー', async () => {\r\n      // Arrange\r\n      const event: APIGatewayProxyEvent = createMockEvent(null);\r\n\r\n      // Act\r\n      const response = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      expect(response.statusCode).toBe(400);\r\n\r\n      const body = JSON.parse(response.body);\r\n      expect(body.status).toBe('error');\r\n      expect(body.error.code).toBe('VALIDATION_ERROR');\r\n      expect(body.error.message).toContain('execution_id is required');\r\n    });\r\n  });\r\n\r\n  describe('CORS対応', () => {\r\n    it('すべてのレスポンスにCORSヘッダーが含まれる', async () => {\r\n      // Arrange\r\n      const execution_id = `test_exec_cors_${Date.now()}`;\r\n      const executionStatus = {\r\n        execution_id,\r\n        status: 'running',\r\n        progress: 25,\r\n        collected_count: 5,\r\n        failed_count: 0,\r\n        started_at: new Date().toISOString(),\r\n        updated_at: new Date().toISOString(),\r\n      };\r\n\r\n      await putExecutionStatus(executionStatus);\r\n\r\n      const event: APIGatewayProxyEvent = createMockEvent(execution_id);\r\n\r\n      // Act\r\n      const response = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      expect(response.headers).toHaveProperty('Access-Control-Allow-Origin', '*');\r\n    });\r\n\r\n    it('エラーレスポンスにもCORSヘッダーが含まれる', async () => {\r\n      // Arrange\r\n      const event: APIGatewayProxyEvent = createMockEvent('non_existent');\r\n\r\n      // Act\r\n      const response = await handler(event, mockContext);\r\n\r\n      // Assert\r\n      expect(response.statusCode).toBe(404);\r\n      expect(response.headers).toHaveProperty('Access-Control-Allow-Origin', '*');\r\n    });\r\n  });\r\n});\r\n\r\n/**\r\n * DynamoDBに実行状態を挿入\r\n */\r\nasync function putExecutionStatus(executionStatus: any): Promise<void> {\r\n  const command = new PutItemCommand({\r\n    TableName: process.env.DYNAMODB_EXECUTIONS_TABLE || 'tdnet_executions',\r\n    Item: marshall(executionStatus),\r\n  });\r\n\r\n  await dynamoClient.send(command);\r\n}\r\n\r\n/**\r\n * モックイベントを作成\r\n */\r\nfunction createMockEvent(execution_id: string | null): APIGatewayProxyEvent {\r\n  return {\r\n    body: null,\r\n    headers: {},\r\n    multiValueHeaders: {},\r\n    httpMethod: 'GET',\r\n    isBase64Encoded: false,\r\n    path: `/collect/${execution_id}`,\r\n    pathParameters: execution_id ? { execution_id } : null,\r\n    queryStringParameters: null,\r\n    multiValueQueryStringParameters: null,\r\n    stageVariables: null,\r\n    requestContext: {\r\n      accountId: '123456789012',\r\n      apiId: 'test-api-id',\r\n      protocol: 'HTTP/1.1',\r\n      httpMethod: 'GET',\r\n      path: `/collect/${execution_id}`,\r\n      stage: 'prod',\r\n      requestId: 'test-request-id',\r\n      requestTime: '15/Jan/2024:10:30:00 +0000',\r\n      requestTimeEpoch: 1705315800000,\r\n      identity: {\r\n        accessKey: null,\r\n        accountId: null,\r\n        apiKey: null,\r\n        apiKeyId: null,\r\n        caller: null,\r\n        clientCert: null,\r\n        cognitoAuthenticationProvider: null,\r\n        cognitoAuthenticationType: null,\r\n        cognitoIdentityId: null,\r\n        cognitoIdentityPoolId: null,\r\n        principalOrgId: null,\r\n        sourceIp: '192.168.1.1',\r\n        user: null,\r\n        userAgent: 'Mozilla/5.0',\r\n        userArn: null,\r\n      },\r\n      authorizer: null,\r\n      domainName: 'api.example.com',\r\n      domainPrefix: 'api',\r\n      resourceId: 'test-resource-id',\r\n      resourcePath: '/collect/{execution_id}',\r\n    },\r\n    resource: '/collect/{execution_id}',\r\n  };\r\n}\r\n"],"version":3}