{"file":"C:\\Users\\ti198\\investment_analysis_opopo\\src\\utils\\logger.ts","mappings":"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","names":[],"sources":["C:\\Users\\ti198\\investment_analysis_opopo\\src\\utils\\logger.ts"],"sourcesContent":["/**\r\n * 構造化ロガー\r\n *\r\n * Winstonを使用した構造化ロギングを提供します。\r\n * CloudWatch Logs形式のJSON出力をサポートし、ログレベルに応じた適切なログ記録を行います。\r\n *\r\n * Requirements: 要件6.3（構造化ログ）\r\n */\r\n\r\nimport winston from 'winston';\r\n\r\n/**\r\n * ログレベル\r\n */\r\nexport enum LogLevel {\r\n  DEBUG = 'debug',\r\n  INFO = 'info',\r\n  WARN = 'warn',\r\n  ERROR = 'error',\r\n}\r\n\r\n/**\r\n * ログコンテキスト\r\n */\r\nexport interface LogContext {\r\n  [key: string]: unknown;\r\n}\r\n\r\n/**\r\n * ロガーインターフェース\r\n */\r\nexport interface Logger {\r\n  debug(message: string, context?: LogContext): void;\r\n  info(message: string, context?: LogContext): void;\r\n  warn(message: string, context?: LogContext): void;\r\n  error(message: string, context?: LogContext): void;\r\n}\r\n\r\n/**\r\n * Winston ロガーの設定\r\n */\r\nconst isLambdaEnvironment = !!process.env.AWS_LAMBDA_FUNCTION_NAME;\r\n\r\n// Lambda環境では、Winstonの代わりにconsole.logを使用\r\n// これにより、CloudWatch Logsに確実にログが出力される\r\nconst winstonLogger = isLambdaEnvironment\r\n  ? null\r\n  : winston.createLogger({\r\n      level: process.env.LOG_LEVEL || LogLevel.INFO,\r\n      format: winston.format.combine(\r\n        winston.format.timestamp({\r\n          format: 'YYYY-MM-DDTHH:mm:ss.SSSZ',\r\n        }),\r\n        winston.format.errors({ stack: true }),\r\n        winston.format.json()\r\n      ),\r\n      defaultMeta: {\r\n        service: 'tdnet-data-collector',\r\n        environment: process.env.NODE_ENV || 'development',\r\n      },\r\n      transports: [\r\n        new winston.transports.Console({\r\n          format: winston.format.combine(\r\n            winston.format.colorize(),\r\n            winston.format.printf(({ timestamp, level, message, ...meta }) => {\r\n              const metaStr = Object.keys(meta).length > 0 ? JSON.stringify(meta, null, 2) : '';\r\n              return `${timestamp} [${level}]: ${message} ${metaStr}`;\r\n            })\r\n          ),\r\n        }),\r\n      ],\r\n    });\r\n\r\n/**\r\n * 構造化ロガー実装\r\n */\r\nclass StructuredLogger implements Logger {\r\n  /**\r\n   * DEBUGレベルのログを記録\r\n   *\r\n   * @param message ログメッセージ\r\n   * @param context ログコンテキスト（オプション）\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * logger.debug('Processing disclosure', {\r\n   *   disclosure_id: 'TD20240115001',\r\n   *   company_code: '1234',\r\n   * });\r\n   * ```\r\n   */\r\n  debug(message: string, context?: LogContext): void {\r\n    if (isLambdaEnvironment) {\r\n      console.log(JSON.stringify({ level: 'debug', message, ...context }));\r\n    } else {\r\n      winstonLogger!.debug(message, context);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * INFOレベルのログを記録\r\n   *\r\n   * @param message ログメッセージ\r\n   * @param context ログコンテキスト（オプション）\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * logger.info('Disclosure saved successfully', {\r\n   *   disclosure_id: 'TD20240115001',\r\n   *   date_partition: '2024-01',\r\n   * });\r\n   * ```\r\n   */\r\n  info(message: string, context?: LogContext): void {\r\n    if (isLambdaEnvironment) {\r\n      console.log(JSON.stringify({ level: 'info', message, ...context }));\r\n    } else {\r\n      winstonLogger!.info(message, context);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * WARNレベルのログを記録\r\n   *\r\n   * @param message ログメッセージ\r\n   * @param context ログコンテキスト（オプション）\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * logger.warn('Duplicate item detected', {\r\n   *   disclosure_id: 'TD20240115001',\r\n   * });\r\n   * ```\r\n   */\r\n  warn(message: string, context?: LogContext): void {\r\n    if (isLambdaEnvironment) {\r\n      console.warn(JSON.stringify({ level: 'warn', message, ...context }));\r\n    } else {\r\n      winstonLogger!.warn(message, context);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ERRORレベルのログを記録\r\n   *\r\n   * @param message ログメッセージ\r\n   * @param context ログコンテキスト（オプション）\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * logger.error('Failed to save disclosure', {\r\n   *   error_type: 'ValidationError',\r\n   *   error_message: error.message,\r\n   *   context: {\r\n   *     disclosure_id: 'TD20240115001',\r\n   *   },\r\n   *   stack_trace: error.stack,\r\n   * });\r\n   * ```\r\n   */\r\n  error(message: string, context?: LogContext): void {\r\n    if (isLambdaEnvironment) {\r\n      console.error(JSON.stringify({ level: 'error', message, ...context }));\r\n    } else {\r\n      winstonLogger!.error(message, context);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * グローバルロガーインスタンス\r\n *\r\n * プロジェクト全体で共有されるロガーインスタンスです。\r\n *\r\n * @example\r\n * ```typescript\r\n * import { logger } from './utils/logger';\r\n *\r\n * logger.info('Application started');\r\n * logger.error('Operation failed', {\r\n *   error_type: 'NetworkError',\r\n *   error_message: error.message,\r\n * });\r\n * ```\r\n */\r\nexport const logger: Logger = new StructuredLogger();\r\n\r\n/**\r\n * ログレベルを設定\r\n *\r\n * @param level ログレベル\r\n *\r\n * @example\r\n * ```typescript\r\n * import { setLogLevel, LogLevel } from './utils/logger';\r\n *\r\n * setLogLevel(LogLevel.DEBUG);\r\n * ```\r\n */\r\nexport function setLogLevel(level: LogLevel): void {\r\n  if (winstonLogger) {\r\n    winstonLogger.level = level;\r\n  }\r\n  // Lambda環境では、LOG_LEVEL環境変数で制御されるため、何もしない\r\n}\r\n\r\n/**\r\n * エラーオブジェクトから構造化ログコンテキストを生成\r\n *\r\n * Steering準拠の標準フォーマット: { error_type, error_message, context, stack_trace }\r\n *\r\n * @param error エラーオブジェクト\r\n * @param additionalContext 追加のコンテキスト（オプション）\r\n * @returns ログコンテキスト\r\n *\r\n * @example\r\n * ```typescript\r\n * try {\r\n *   await operation();\r\n * } catch (error) {\r\n *   logger.error('Operation failed', createErrorContext(error, {\r\n *     disclosure_id: 'TD20240115001',\r\n *   }));\r\n * }\r\n * ```\r\n */\r\nexport function createErrorContext(\r\n  error: Error,\r\n  additionalContext?: LogContext\r\n): LogContext {\r\n  return {\r\n    error_type: error.constructor.name,\r\n    error_message: error.message,\r\n    context: additionalContext || {},\r\n    stack_trace: error.stack,\r\n  };\r\n}\r\n\r\n/**\r\n * Lambda実行コンテキストを含むエラーログを記録\r\n *\r\n * Lambda実装チェックリストに準拠した標準エラーログフォーマット。\r\n * CloudWatch Logsに構造化ログとして記録されます。\r\n *\r\n * @param message エラーメッセージ\r\n * @param error エラーオブジェクト\r\n * @param lambdaContext Lambda実行コンテキスト（オプション）\r\n * @param additionalContext 追加のコンテキスト（オプション）\r\n *\r\n * @example\r\n * ```typescript\r\n * export async function handler(event: any, context: any) {\r\n *   try {\r\n *     await operation();\r\n *   } catch (error) {\r\n *     logLambdaError('Lambda execution failed', error, context, {\r\n *       disclosure_id: 'TD20240115001',\r\n *     });\r\n *     throw error;\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport function logLambdaError(\r\n  message: string,\r\n  error: Error,\r\n  lambdaContext?: { requestId?: string; functionName?: string },\r\n  additionalContext?: LogContext\r\n): void {\r\n  logger.error(message, {\r\n    error_type: error.constructor.name,\r\n    error_message: error.message,\r\n    context: {\r\n      request_id: lambdaContext?.requestId,\r\n      function_name: lambdaContext?.functionName,\r\n      ...additionalContext,\r\n    },\r\n    stack_trace: error.stack,\r\n  });\r\n}\r\n"],"version":3}