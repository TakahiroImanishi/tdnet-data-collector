b7c70c32e2af48f96a729014fc8a53d8
"use strict";
/**
 * 再試行ロジック（指数バックオフ）
 *
 * 一時的なエラーに対して、指数バックオフアルゴリズムを使用した再試行を実行します。
 * ジッター（ランダム遅延）を追加することで、複数のクライアントが同時に再試行する際の
 * サンダリングハード問題を回避します。
 *
 * Requirements: 要件6.2（再試行ロジック）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.retryWithBackoff = retryWithBackoff;
exports.isRetryableError = isRetryableError;
const errors_1 = require("../errors");
/**
 * デフォルトの再試行オプション
 */
const DEFAULT_RETRY_OPTIONS = {
    maxRetries: 3,
    initialDelay: 2000,
    backoffMultiplier: 2,
    jitter: true,
};
/**
 * デフォルトの再試行判定関数
 * RetryableErrorのみ再試行します。
 */
function defaultShouldRetry(error) {
    return error instanceof errors_1.RetryableError;
}
/**
 * 指数バックオフを使用した再試行ロジック
 *
 * @param operation 実行する非同期処理
 * @param options 再試行オプション
 * @returns 処理の結果
 * @throws 最大再試行回数に達した場合、または再試行不可能なエラーの場合
 *
 * @example
 * ```typescript
 * // 基本的な使用例
 * const result = await retryWithBackoff(
 *   async () => await fetchData(),
 *   {
 *     maxRetries: 3,
 *     initialDelay: 2000,
 *     backoffMultiplier: 2,
 *     jitter: true,
 *   }
 * );
 *
 * // カスタム再試行判定
 * const result = await retryWithBackoff(
 *   async () => await fetchData(),
 *   {
 *     maxRetries: 3,
 *     initialDelay: 1000,
 *     backoffMultiplier: 2,
 *     jitter: true,
 *     shouldRetry: (error) => {
 *       // ネットワークエラーのみ再試行
 *       return error.message.includes('ECONNRESET');
 *     },
 *   }
 * );
 * ```
 */
async function retryWithBackoff(operation, options = {}) {
    const opts = { ...DEFAULT_RETRY_OPTIONS, ...options };
    const shouldRetry = opts.shouldRetry || defaultShouldRetry;
    let lastError;
    let attempt = 0;
    while (attempt <= opts.maxRetries) {
        try {
            return await operation();
        }
        catch (error) {
            lastError = error instanceof Error ? error : new Error(String(error));
            // 最大再試行回数に達した場合は、エラーをスロー
            if (attempt >= opts.maxRetries) {
                throw lastError;
            }
            // 再試行不可能なエラーの場合は、即座にスロー
            if (!shouldRetry(lastError)) {
                throw lastError;
            }
            // 遅延時間を計算（指数バックオフ）
            const delay = calculateDelay(attempt, opts);
            // 遅延後に再試行
            await sleep(delay);
            attempt++;
        }
    }
    // この行には到達しないはずだが、TypeScriptの型チェックのために必要
    throw lastError || new Error('Unexpected error in retryWithBackoff');
}
/**
 * 遅延時間を計算（指数バックオフ + ジッター）
 *
 * @param attempt 現在の試行回数（0から始まる）
 * @param options 再試行オプション
 * @returns 遅延時間（ミリ秒）
 */
function calculateDelay(attempt, options) {
    // 指数バックオフ: initialDelay * (backoffMultiplier ^ attempt)
    const exponentialDelay = options.initialDelay * Math.pow(options.backoffMultiplier, attempt);
    // ジッターを追加（0〜exponentialDelayのランダム値）
    if (options.jitter) {
        return Math.random() * exponentialDelay;
    }
    return exponentialDelay;
}
/**
 * 指定時間スリープ
 *
 * @param ms スリープ時間（ミリ秒）
 */
function sleep(ms) {
    return new Promise((resolve) => setTimeout(resolve, ms));
}
/**
 * 再試行可能なエラーかどうかを判定するヘルパー関数
 *
 * @param error エラーオブジェクト
 * @returns 再試行可能な場合はtrue
 *
 * @example
 * ```typescript
 * try {
 *   await operation();
 * } catch (error) {
 *   if (isRetryableError(error)) {
 *     // 再試行ロジック
 *   } else {
 *     // 即座に失敗
 *   }
 * }
 * ```
 */
function isRetryableError(error) {
    if (!(error instanceof Error)) {
        return false;
    }
    // RetryableErrorまたはそのサブクラス
    if (error instanceof errors_1.RetryableError) {
        return true;
    }
    // ネットワークエラー
    const networkErrors = ['ECONNRESET', 'ETIMEDOUT', 'ENOTFOUND', 'ECONNREFUSED'];
    if (networkErrors.some((code) => error.message.includes(code))) {
        return true;
    }
    // HTTPタイムアウト
    if (error.message.includes('timeout')) {
        return true;
    }
    // HTTP 5xxエラー（サーバーエラー）
    const http5xxErrors = ['500', '502', '503', '504'];
    if (http5xxErrors.some((code) => error.message.includes(code))) {
        return true;
    }
    // HTTP 429エラー（Too Many Requests）
    if (error.message.includes('429') || error.message.includes('Too Many Requests')) {
        return true;
    }
    // AWS一時的エラー
    const awsErrors = ['ThrottlingException', 'ServiceUnavailable', 'RequestTimeout'];
    if (awsErrors.some((code) => error.message.includes(code))) {
        return true;
    }
    return false;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFx1dGlsc1xccmV0cnkudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7OztHQVFHOztBQTJGSCw0Q0FxQ0M7QUFrREQsNENBdUNDO0FBdk5ELHNDQUEyQztBQWtDM0M7O0dBRUc7QUFDSCxNQUFNLHFCQUFxQixHQUFpQjtJQUMxQyxVQUFVLEVBQUUsQ0FBQztJQUNiLFlBQVksRUFBRSxJQUFJO0lBQ2xCLGlCQUFpQixFQUFFLENBQUM7SUFDcEIsTUFBTSxFQUFFLElBQUk7Q0FDYixDQUFDO0FBRUY7OztHQUdHO0FBQ0gsU0FBUyxrQkFBa0IsQ0FBQyxLQUFZO0lBQ3RDLE9BQU8sS0FBSyxZQUFZLHVCQUFjLENBQUM7QUFDekMsQ0FBQztBQUVEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FvQ0c7QUFDSSxLQUFLLFVBQVUsZ0JBQWdCLENBQ3BDLFNBQTJCLEVBQzNCLFVBQWlDLEVBQUU7SUFFbkMsTUFBTSxJQUFJLEdBQWlCLEVBQUUsR0FBRyxxQkFBcUIsRUFBRSxHQUFHLE9BQU8sRUFBRSxDQUFDO0lBQ3BFLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxXQUFXLElBQUksa0JBQWtCLENBQUM7SUFFM0QsSUFBSSxTQUE0QixDQUFDO0lBQ2pDLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQztJQUVoQixPQUFPLE9BQU8sSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDbEMsSUFBSSxDQUFDO1lBQ0gsT0FBTyxNQUFNLFNBQVMsRUFBRSxDQUFDO1FBQzNCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsU0FBUyxHQUFHLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFFdEUseUJBQXlCO1lBQ3pCLElBQUksT0FBTyxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztnQkFDL0IsTUFBTSxTQUFTLENBQUM7WUFDbEIsQ0FBQztZQUVELHdCQUF3QjtZQUN4QixJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7Z0JBQzVCLE1BQU0sU0FBUyxDQUFDO1lBQ2xCLENBQUM7WUFFRCxtQkFBbUI7WUFDbkIsTUFBTSxLQUFLLEdBQUcsY0FBYyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztZQUU1QyxVQUFVO1lBQ1YsTUFBTSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbkIsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDO0lBQ0gsQ0FBQztJQUVELHdDQUF3QztJQUN4QyxNQUFNLFNBQVMsSUFBSSxJQUFJLEtBQUssQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDO0FBQ3ZFLENBQUM7QUFFRDs7Ozs7O0dBTUc7QUFDSCxTQUFTLGNBQWMsQ0FBQyxPQUFlLEVBQUUsT0FBcUI7SUFDNUQsd0RBQXdEO0lBQ3hELE1BQU0sZ0JBQWdCLEdBQ3BCLE9BQU8sQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFFdEUsb0NBQW9DO0lBQ3BDLElBQUksT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ25CLE9BQU8sSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLGdCQUFnQixDQUFDO0lBQzFDLENBQUM7SUFFRCxPQUFPLGdCQUFnQixDQUFDO0FBQzFCLENBQUM7QUFFRDs7OztHQUlHO0FBQ0gsU0FBUyxLQUFLLENBQUMsRUFBVTtJQUN2QixPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDM0QsQ0FBQztBQUVEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FrQkc7QUFDSCxTQUFnQixnQkFBZ0IsQ0FBQyxLQUFjO0lBQzdDLElBQUksQ0FBQyxDQUFDLEtBQUssWUFBWSxLQUFLLENBQUMsRUFBRSxDQUFDO1FBQzlCLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELDJCQUEyQjtJQUMzQixJQUFJLEtBQUssWUFBWSx1QkFBYyxFQUFFLENBQUM7UUFDcEMsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsWUFBWTtJQUNaLE1BQU0sYUFBYSxHQUFHLENBQUMsWUFBWSxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFDL0UsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDL0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsYUFBYTtJQUNiLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztRQUN0QyxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCx1QkFBdUI7SUFDdkIsTUFBTSxhQUFhLEdBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNuRCxJQUFJLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUMvRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxpQ0FBaUM7SUFDakMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLENBQUM7UUFDakYsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsWUFBWTtJQUNaLE1BQU0sU0FBUyxHQUFHLENBQUMscUJBQXFCLEVBQUUsb0JBQW9CLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztJQUNsRixJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUMzRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFx1dGlsc1xccmV0cnkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIOWGjeippuihjOODreOCuOODg+OCr++8iOaMh+aVsOODkOODg+OCr+OCquODle+8iVxyXG4gKlxyXG4gKiDkuIDmmYLnmoTjgarjgqjjg6njg7zjgavlr77jgZfjgabjgIHmjIfmlbDjg5Djg4Pjgq/jgqrjg5XjgqLjg6vjgrTjg6rjgrrjg6DjgpLkvb/nlKjjgZfjgZ/lho3oqabooYzjgpLlrp/ooYzjgZfjgb7jgZnjgIJcclxuICog44K444OD44K/44O877yI44Op44Oz44OA44Og6YGF5bu277yJ44KS6L+95Yqg44GZ44KL44GT44Go44Gn44CB6KSH5pWw44Gu44Kv44Op44Kk44Ki44Oz44OI44GM5ZCM5pmC44Gr5YaN6Kmm6KGM44GZ44KL6Zqb44GuXHJcbiAqIOOCteODs+ODgOODquODs+OCsOODj+ODvOODieWVj+mhjOOCkuWbnumBv+OBl+OBvuOBmeOAglxyXG4gKlxyXG4gKiBSZXF1aXJlbWVudHM6IOimgeS7tjYuMu+8iOWGjeippuihjOODreOCuOODg+OCr++8iVxyXG4gKi9cclxuXHJcbmltcG9ydCB7IFJldHJ5YWJsZUVycm9yIH0gZnJvbSAnLi4vZXJyb3JzJztcclxuXHJcbi8qKlxyXG4gKiDlho3oqabooYzjgqrjg5fjgrfjg6fjg7NcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgUmV0cnlPcHRpb25zIHtcclxuICAvKipcclxuICAgKiDmnIDlpKflho3oqabooYzlm57mlbDvvIjjg4fjg5Xjgqnjg6vjg4g6IDPvvIlcclxuICAgKi9cclxuICBtYXhSZXRyaWVzOiBudW1iZXI7XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIneacn+mBheW7tuaZgumWk++8iOODn+ODquenkuOAgeODh+ODleOCqeODq+ODiDogMjAwMO+8iVxyXG4gICAqL1xyXG4gIGluaXRpYWxEZWxheTogbnVtYmVyO1xyXG5cclxuICAvKipcclxuICAgKiDjg5Djg4Pjgq/jgqrjg5XlgI3njofvvIjjg4fjg5Xjgqnjg6vjg4g6IDLvvIlcclxuICAgKi9cclxuICBiYWNrb2ZmTXVsdGlwbGllcjogbnVtYmVyO1xyXG5cclxuICAvKipcclxuICAgKiDjgrjjg4Pjgr/jg7zvvIjjg6njg7Pjg4Djg6DpgYXlu7bvvInjgpLov73liqDjgZnjgovjgYvvvIjjg4fjg5Xjgqnjg6vjg4g6IHRydWXvvIlcclxuICAgKi9cclxuICBqaXR0ZXI6IGJvb2xlYW47XHJcblxyXG4gIC8qKlxyXG4gICAqIOOCq+OCueOCv+ODoOWGjeippuihjOWIpOWumumWouaVsO+8iOOCquODl+OCt+ODp+ODs++8iVxyXG4gICAqIOOCqOODqeODvOOBjOWGjeippuihjOWPr+iDveOBi+OBqeOBhuOBi+OCkuWIpOWumuOBl+OBvuOBmeOAglxyXG4gICAqIOaMh+WumuOBl+OBquOBhOWgtOWQiOOBr+OAgVJldHJ5YWJsZUVycm9y44Gu44G/5YaN6Kmm6KGM44GX44G+44GZ44CCXHJcbiAgICovXHJcbiAgc2hvdWxkUmV0cnk/OiAoZXJyb3I6IEVycm9yKSA9PiBib29sZWFuO1xyXG59XHJcblxyXG4vKipcclxuICog44OH44OV44Kp44Or44OI44Gu5YaN6Kmm6KGM44Kq44OX44K344On44OzXHJcbiAqL1xyXG5jb25zdCBERUZBVUxUX1JFVFJZX09QVElPTlM6IFJldHJ5T3B0aW9ucyA9IHtcclxuICBtYXhSZXRyaWVzOiAzLFxyXG4gIGluaXRpYWxEZWxheTogMjAwMCxcclxuICBiYWNrb2ZmTXVsdGlwbGllcjogMixcclxuICBqaXR0ZXI6IHRydWUsXHJcbn07XHJcblxyXG4vKipcclxuICog44OH44OV44Kp44Or44OI44Gu5YaN6Kmm6KGM5Yik5a6a6Zai5pWwXHJcbiAqIFJldHJ5YWJsZUVycm9y44Gu44G/5YaN6Kmm6KGM44GX44G+44GZ44CCXHJcbiAqL1xyXG5mdW5jdGlvbiBkZWZhdWx0U2hvdWxkUmV0cnkoZXJyb3I6IEVycm9yKTogYm9vbGVhbiB7XHJcbiAgcmV0dXJuIGVycm9yIGluc3RhbmNlb2YgUmV0cnlhYmxlRXJyb3I7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDmjIfmlbDjg5Djg4Pjgq/jgqrjg5XjgpLkvb/nlKjjgZfjgZ/lho3oqabooYzjg63jgrjjg4Pjgq9cclxuICpcclxuICogQHBhcmFtIG9wZXJhdGlvbiDlrp/ooYzjgZnjgovpnZ7lkIzmnJ/lh6bnkIZcclxuICogQHBhcmFtIG9wdGlvbnMg5YaN6Kmm6KGM44Kq44OX44K344On44OzXHJcbiAqIEByZXR1cm5zIOWHpueQhuOBrue1kOaenFxyXG4gKiBAdGhyb3dzIOacgOWkp+WGjeippuihjOWbnuaVsOOBq+mBlOOBl+OBn+WgtOWQiOOAgeOBvuOBn+OBr+WGjeippuihjOS4jeWPr+iDveOBquOCqOODqeODvOOBruWgtOWQiFxyXG4gKlxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGB0eXBlc2NyaXB0XHJcbiAqIC8vIOWfuuacrOeahOOBquS9v+eUqOS+i1xyXG4gKiBjb25zdCByZXN1bHQgPSBhd2FpdCByZXRyeVdpdGhCYWNrb2ZmKFxyXG4gKiAgIGFzeW5jICgpID0+IGF3YWl0IGZldGNoRGF0YSgpLFxyXG4gKiAgIHtcclxuICogICAgIG1heFJldHJpZXM6IDMsXHJcbiAqICAgICBpbml0aWFsRGVsYXk6IDIwMDAsXHJcbiAqICAgICBiYWNrb2ZmTXVsdGlwbGllcjogMixcclxuICogICAgIGppdHRlcjogdHJ1ZSxcclxuICogICB9XHJcbiAqICk7XHJcbiAqXHJcbiAqIC8vIOOCq+OCueOCv+ODoOWGjeippuihjOWIpOWumlxyXG4gKiBjb25zdCByZXN1bHQgPSBhd2FpdCByZXRyeVdpdGhCYWNrb2ZmKFxyXG4gKiAgIGFzeW5jICgpID0+IGF3YWl0IGZldGNoRGF0YSgpLFxyXG4gKiAgIHtcclxuICogICAgIG1heFJldHJpZXM6IDMsXHJcbiAqICAgICBpbml0aWFsRGVsYXk6IDEwMDAsXHJcbiAqICAgICBiYWNrb2ZmTXVsdGlwbGllcjogMixcclxuICogICAgIGppdHRlcjogdHJ1ZSxcclxuICogICAgIHNob3VsZFJldHJ5OiAoZXJyb3IpID0+IHtcclxuICogICAgICAgLy8g44ON44OD44OI44Ov44O844Kv44Ko44Op44O844Gu44G/5YaN6Kmm6KGMXHJcbiAqICAgICAgIHJldHVybiBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdFQ09OTlJFU0VUJyk7XHJcbiAqICAgICB9LFxyXG4gKiAgIH1cclxuICogKTtcclxuICogYGBgXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmV0cnlXaXRoQmFja29mZjxUPihcclxuICBvcGVyYXRpb246ICgpID0+IFByb21pc2U8VD4sXHJcbiAgb3B0aW9uczogUGFydGlhbDxSZXRyeU9wdGlvbnM+ID0ge31cclxuKTogUHJvbWlzZTxUPiB7XHJcbiAgY29uc3Qgb3B0czogUmV0cnlPcHRpb25zID0geyAuLi5ERUZBVUxUX1JFVFJZX09QVElPTlMsIC4uLm9wdGlvbnMgfTtcclxuICBjb25zdCBzaG91bGRSZXRyeSA9IG9wdHMuc2hvdWxkUmV0cnkgfHwgZGVmYXVsdFNob3VsZFJldHJ5O1xyXG5cclxuICBsZXQgbGFzdEVycm9yOiBFcnJvciB8IHVuZGVmaW5lZDtcclxuICBsZXQgYXR0ZW1wdCA9IDA7XHJcblxyXG4gIHdoaWxlIChhdHRlbXB0IDw9IG9wdHMubWF4UmV0cmllcykge1xyXG4gICAgdHJ5IHtcclxuICAgICAgcmV0dXJuIGF3YWl0IG9wZXJhdGlvbigpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgbGFzdEVycm9yID0gZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIDogbmV3IEVycm9yKFN0cmluZyhlcnJvcikpO1xyXG5cclxuICAgICAgLy8g5pyA5aSn5YaN6Kmm6KGM5Zue5pWw44Gr6YGU44GX44Gf5aC05ZCI44Gv44CB44Ko44Op44O844KS44K544Ot44O8XHJcbiAgICAgIGlmIChhdHRlbXB0ID49IG9wdHMubWF4UmV0cmllcykge1xyXG4gICAgICAgIHRocm93IGxhc3RFcnJvcjtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8g5YaN6Kmm6KGM5LiN5Y+v6IO944Gq44Ko44Op44O844Gu5aC05ZCI44Gv44CB5Y2z5bqn44Gr44K544Ot44O8XHJcbiAgICAgIGlmICghc2hvdWxkUmV0cnkobGFzdEVycm9yKSkge1xyXG4gICAgICAgIHRocm93IGxhc3RFcnJvcjtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8g6YGF5bu25pmC6ZaT44KS6KiI566X77yI5oyH5pWw44OQ44OD44Kv44Kq44OV77yJXHJcbiAgICAgIGNvbnN0IGRlbGF5ID0gY2FsY3VsYXRlRGVsYXkoYXR0ZW1wdCwgb3B0cyk7XHJcblxyXG4gICAgICAvLyDpgYXlu7blvozjgavlho3oqabooYxcclxuICAgICAgYXdhaXQgc2xlZXAoZGVsYXkpO1xyXG4gICAgICBhdHRlbXB0Kys7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDjgZPjga7ooYzjgavjga/liLDpgZTjgZfjgarjgYTjga/jgZrjgaDjgYzjgIFUeXBlU2NyaXB044Gu5Z6L44OB44Kn44OD44Kv44Gu44Gf44KB44Gr5b+F6KaBXHJcbiAgdGhyb3cgbGFzdEVycm9yIHx8IG5ldyBFcnJvcignVW5leHBlY3RlZCBlcnJvciBpbiByZXRyeVdpdGhCYWNrb2ZmJyk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDpgYXlu7bmmYLplpPjgpLoqIjnrpfvvIjmjIfmlbDjg5Djg4Pjgq/jgqrjg5UgKyDjgrjjg4Pjgr/jg7zvvIlcclxuICpcclxuICogQHBhcmFtIGF0dGVtcHQg54++5Zyo44Gu6Kmm6KGM5Zue5pWw77yIMOOBi+OCieWni+OBvuOCi++8iVxyXG4gKiBAcGFyYW0gb3B0aW9ucyDlho3oqabooYzjgqrjg5fjgrfjg6fjg7NcclxuICogQHJldHVybnMg6YGF5bu25pmC6ZaT77yI44Of44Oq56eS77yJXHJcbiAqL1xyXG5mdW5jdGlvbiBjYWxjdWxhdGVEZWxheShhdHRlbXB0OiBudW1iZXIsIG9wdGlvbnM6IFJldHJ5T3B0aW9ucyk6IG51bWJlciB7XHJcbiAgLy8g5oyH5pWw44OQ44OD44Kv44Kq44OVOiBpbml0aWFsRGVsYXkgKiAoYmFja29mZk11bHRpcGxpZXIgXiBhdHRlbXB0KVxyXG4gIGNvbnN0IGV4cG9uZW50aWFsRGVsYXkgPVxyXG4gICAgb3B0aW9ucy5pbml0aWFsRGVsYXkgKiBNYXRoLnBvdyhvcHRpb25zLmJhY2tvZmZNdWx0aXBsaWVyLCBhdHRlbXB0KTtcclxuXHJcbiAgLy8g44K444OD44K/44O844KS6L+95Yqg77yIMOOAnGV4cG9uZW50aWFsRGVsYXnjga7jg6njg7Pjg4Djg6DlgKTvvIlcclxuICBpZiAob3B0aW9ucy5qaXR0ZXIpIHtcclxuICAgIHJldHVybiBNYXRoLnJhbmRvbSgpICogZXhwb25lbnRpYWxEZWxheTtcclxuICB9XHJcblxyXG4gIHJldHVybiBleHBvbmVudGlhbERlbGF5O1xyXG59XHJcblxyXG4vKipcclxuICog5oyH5a6a5pmC6ZaT44K544Oq44O844OXXHJcbiAqXHJcbiAqIEBwYXJhbSBtcyDjgrnjg6rjg7zjg5fmmYLplpPvvIjjg5/jg6rnp5LvvIlcclxuICovXHJcbmZ1bmN0aW9uIHNsZWVwKG1zOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcclxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIOWGjeippuihjOWPr+iDveOBquOCqOODqeODvOOBi+OBqeOBhuOBi+OCkuWIpOWumuOBmeOCi+ODmOODq+ODkeODvOmWouaVsFxyXG4gKlxyXG4gKiBAcGFyYW0gZXJyb3Ig44Ko44Op44O844Kq44OW44K444Kn44Kv44OIXHJcbiAqIEByZXR1cm5zIOWGjeippuihjOWPr+iDveOBquWgtOWQiOOBr3RydWVcclxuICpcclxuICogQGV4YW1wbGVcclxuICogYGBgdHlwZXNjcmlwdFxyXG4gKiB0cnkge1xyXG4gKiAgIGF3YWl0IG9wZXJhdGlvbigpO1xyXG4gKiB9IGNhdGNoIChlcnJvcikge1xyXG4gKiAgIGlmIChpc1JldHJ5YWJsZUVycm9yKGVycm9yKSkge1xyXG4gKiAgICAgLy8g5YaN6Kmm6KGM44Ot44K444OD44KvXHJcbiAqICAgfSBlbHNlIHtcclxuICogICAgIC8vIOWNs+W6p+OBq+WkseaVl1xyXG4gKiAgIH1cclxuICogfVxyXG4gKiBgYGBcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBpc1JldHJ5YWJsZUVycm9yKGVycm9yOiB1bmtub3duKTogYm9vbGVhbiB7XHJcbiAgaWYgKCEoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcikpIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIC8vIFJldHJ5YWJsZUVycm9y44G+44Gf44Gv44Gd44Gu44K144OW44Kv44Op44K5XHJcbiAgaWYgKGVycm9yIGluc3RhbmNlb2YgUmV0cnlhYmxlRXJyb3IpIHtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLy8g44ON44OD44OI44Ov44O844Kv44Ko44Op44O8XHJcbiAgY29uc3QgbmV0d29ya0Vycm9ycyA9IFsnRUNPTk5SRVNFVCcsICdFVElNRURPVVQnLCAnRU5PVEZPVU5EJywgJ0VDT05OUkVGVVNFRCddO1xyXG4gIGlmIChuZXR3b3JrRXJyb3JzLnNvbWUoKGNvZGUpID0+IGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoY29kZSkpKSB7XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIC8vIEhUVFDjgr/jgqTjg6DjgqLjgqbjg4hcclxuICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygndGltZW91dCcpKSB7XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIC8vIEhUVFAgNXh444Ko44Op44O877yI44K144O844OQ44O844Ko44Op44O877yJXHJcbiAgY29uc3QgaHR0cDV4eEVycm9ycyA9IFsnNTAwJywgJzUwMicsICc1MDMnLCAnNTA0J107XHJcbiAgaWYgKGh0dHA1eHhFcnJvcnMuc29tZSgoY29kZSkgPT4gZXJyb3IubWVzc2FnZS5pbmNsdWRlcyhjb2RlKSkpIHtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLy8gSFRUUCA0Mjnjgqjjg6njg7zvvIhUb28gTWFueSBSZXF1ZXN0c++8iVxyXG4gIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCc0MjknKSB8fCBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdUb28gTWFueSBSZXF1ZXN0cycpKSB7XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIC8vIEFXU+S4gOaZgueahOOCqOODqeODvFxyXG4gIGNvbnN0IGF3c0Vycm9ycyA9IFsnVGhyb3R0bGluZ0V4Y2VwdGlvbicsICdTZXJ2aWNlVW5hdmFpbGFibGUnLCAnUmVxdWVzdFRpbWVvdXQnXTtcclxuICBpZiAoYXdzRXJyb3JzLnNvbWUoKGNvZGUpID0+IGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoY29kZSkpKSB7XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIHJldHVybiBmYWxzZTtcclxufVxyXG4iXSwidmVyc2lvbiI6M30=