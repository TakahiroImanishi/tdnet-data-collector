8450618a77f00c55631d9151c9ec425b
"use strict";
/**
 * Lambda Query Handler
 *
 * TDnet開示情報を検索するLambda関数のメインハンドラー。
 * API Gateway統合により、RESTful APIとして公開されます。
 *
 * Requirements: 要件4.1, 4.3, 4.4, 5.2, 11.1（検索API、認証、PDFダウンロード、CSV形式）
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const logger_1 = require("../../utils/logger");
const cloudwatch_metrics_1 = require("../../utils/cloudwatch-metrics");
const errors_1 = require("../../errors");
const query_disclosures_1 = require("./query-disclosures");
const format_csv_1 = require("./format-csv");
/**
 * Lambda Queryハンドラー
 *
 * @param event API Gateway Proxy Event
 * @param context Lambda Context
 * @returns API Gateway Proxy Result
 *
 * @example
 * ```typescript
 * // 企業コードで検索
 * GET /disclosures?company_code=7203
 *
 * // 日付範囲で検索
 * GET /disclosures?start_date=2024-01-15&end_date=2024-01-20
 *
 * // CSV形式で取得
 * GET /disclosures?format=csv&start_date=2024-01-15&end_date=2024-01-20
 * ```
 */
async function handler(event, context) {
    const startTime = Date.now();
    try {
        logger_1.logger.info('Lambda Query started', {
            queryStringParameters: event.queryStringParameters,
            request_id: context.awsRequestId,
            function_name: context.functionName,
        });
        // クエリパラメータのパース
        const params = parseQueryParameters(event);
        // 開示情報を検索
        const result = await (0, query_disclosures_1.queryDisclosures)(params);
        const duration = Date.now() - startTime;
        logger_1.logger.info('Lambda Query completed', {
            request_id: context.awsRequestId,
            count: result.count,
            duration_ms: duration,
        });
        // 成功メトリクス送信
        await (0, cloudwatch_metrics_1.sendMetrics)([
            {
                name: 'LambdaExecutionTime',
                value: duration,
                unit: 'Milliseconds',
                dimensions: { FunctionName: 'Query' },
            },
            {
                name: 'QueryResultCount',
                value: result.count,
                unit: 'Count',
                dimensions: { Format: params.format },
            },
        ]);
        // フォーマット別レスポンス
        if (params.format === 'csv') {
            const csv = (0, format_csv_1.formatAsCsv)(result.disclosures);
            return {
                statusCode: 200,
                headers: {
                    'Content-Type': 'text/csv',
                    'Content-Disposition': `attachment; filename="disclosures-${Date.now()}.csv"`,
                    'Access-Control-Allow-Origin': '*',
                },
                body: csv,
            };
        }
        // JSON形式（デフォルト）
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify(result),
        };
    }
    catch (error) {
        const duration = Date.now() - startTime;
        logger_1.logger.error('Lambda Query failed', (0, logger_1.createErrorContext)(error, {
            request_id: context.awsRequestId,
            duration_ms: duration,
        }));
        // エラーメトリクス送信
        await (0, cloudwatch_metrics_1.sendErrorMetric)(error instanceof Error ? error.constructor.name : 'Unknown', 'Query');
        return handleError(error, event.requestContext.requestId);
    }
}
/**
 * クエリパラメータのパース
 *
 * @param event API Gateway Proxy Event
 * @returns パース済みクエリパラメータ
 * @throws ValidationError バリデーションエラー
 */
function parseQueryParameters(event) {
    const params = event.queryStringParameters || {};
    // フォーマットのバリデーション
    const format = (params.format || 'json');
    if (!['json', 'csv'].includes(format)) {
        throw new errors_1.ValidationError(`Invalid format: ${format}. Expected 'json' or 'csv'.`);
    }
    // リミットのバリデーション（デフォルト: 100、最大: 1000）
    let limit = 100;
    if (params.limit) {
        limit = parseInt(params.limit, 10);
        if (isNaN(limit) || limit < 1 || limit > 1000) {
            throw new errors_1.ValidationError(`Invalid limit: ${params.limit}. Expected a number between 1 and 1000.`);
        }
    }
    // オフセットのバリデーション（デフォルト: 0）
    let offset = 0;
    if (params.offset) {
        offset = parseInt(params.offset, 10);
        if (isNaN(offset) || offset < 0) {
            throw new errors_1.ValidationError(`Invalid offset: ${params.offset}. Expected a non-negative number.`);
        }
    }
    // monthパラメータのバリデーション
    if (params.month) {
        validateMonthFormat(params.month);
    }
    // monthが指定された場合、start_dateとend_dateは無視
    if (params.month) {
        logger_1.logger.info('month parameter specified, ignoring start_date and end_date', {
            month: params.month,
            start_date: params.start_date,
            end_date: params.end_date,
        });
    }
    else {
        // 日付フォーマットのバリデーション
        if (params.start_date) {
            validateDateFormat(params.start_date, 'start_date');
        }
        if (params.end_date) {
            validateDateFormat(params.end_date, 'end_date');
        }
        // 日付範囲の順序性チェック（Property 8）
        if (params.start_date && params.end_date) {
            const startDate = new Date(params.start_date);
            const endDate = new Date(params.end_date);
            if (startDate > endDate) {
                throw new errors_1.ValidationError(`start_date (${params.start_date}) must be before or equal to end_date (${params.end_date})`);
            }
        }
    }
    // 企業コードのバリデーション（4桁の数字）
    if (params.company_code) {
        const companyCodeRegex = /^\d{4}$/;
        if (!companyCodeRegex.test(params.company_code)) {
            throw new errors_1.ValidationError(`Invalid company_code: ${params.company_code}. Expected 4-digit number.`);
        }
    }
    return {
        company_code: params.company_code,
        start_date: params.month ? undefined : params.start_date,
        end_date: params.month ? undefined : params.end_date,
        month: params.month,
        disclosure_type: params.disclosure_type,
        format,
        limit,
        offset,
    };
}
/**
 * 日付フォーマットのバリデーション
 *
 * @param date 日付文字列（YYYY-MM-DD）
 * @param fieldName フィールド名
 * @throws ValidationError バリデーションエラー
 */
function validateDateFormat(date, fieldName) {
    // YYYY-MM-DD形式のチェック
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateRegex.test(date)) {
        throw new errors_1.ValidationError(`Invalid ${fieldName} format: ${date}. Expected YYYY-MM-DD format.`);
    }
    // 有効な日付かチェック
    const parsedDate = new Date(date);
    if (isNaN(parsedDate.getTime())) {
        throw new errors_1.ValidationError(`Invalid ${fieldName}: ${date}. Date does not exist.`);
    }
    // 日付の整合性チェック（例: 2023-02-29は2023-03-01に変換されるため検出）
    const [year, month, day] = date.split('-').map(Number);
    if (parsedDate.getFullYear() !== year ||
        parsedDate.getMonth() + 1 !== month ||
        parsedDate.getDate() !== day) {
        throw new errors_1.ValidationError(`Invalid ${fieldName}: ${date}. Date does not exist.`);
    }
}
/**
 * 月フォーマットのバリデーション
 *
 * @param month 月文字列（YYYY-MM）
 * @throws ValidationError バリデーションエラー
 */
function validateMonthFormat(month) {
    // YYYY-MM形式のチェック
    const monthRegex = /^\d{4}-\d{2}$/;
    if (!monthRegex.test(month)) {
        throw new errors_1.ValidationError(`Invalid month format: ${month}. Expected YYYY-MM format.`);
    }
    // 有効な月かチェック
    const [year, monthNum] = month.split('-').map(Number);
    if (monthNum < 1 || monthNum > 12) {
        throw new errors_1.ValidationError(`Invalid month: ${month}. Month must be between 01 and 12.`);
    }
    // 年の妥当性チェック（1900-2100）
    if (year < 1900 || year > 2100) {
        throw new errors_1.ValidationError(`Invalid month: ${month}. Year must be between 1900 and 2100.`);
    }
}
/**
 * エラーハンドリング
 *
 * カスタムエラーを適切なHTTPステータスコードとエラーコードに変換します。
 * API設計ガイドラインに準拠した形式でエラーレスポンスを返します。
 *
 * @param error エラーオブジェクト
 * @param requestId API GatewayリクエストID
 * @returns API Gateway Proxy Result
 */
function handleError(error, requestId) {
    // エラー種別に応じたステータスコードとエラーコード
    let statusCode = 500;
    let errorCode = 'INTERNAL_ERROR';
    let details = {};
    if (error instanceof errors_1.ValidationError) {
        statusCode = 400;
        errorCode = 'VALIDATION_ERROR';
        // ValidationErrorの詳細情報を含める
        if (error.details) {
            details = error.details;
        }
    }
    else if (error instanceof errors_1.NotFoundError) {
        statusCode = 404;
        errorCode = 'NOT_FOUND';
    }
    // API設計ガイドラインに準拠したエラーレスポンス形式
    const errorResponse = {
        status: 'error',
        error: {
            code: errorCode,
            message: error.message,
            details,
        },
        request_id: requestId,
    };
    // 本番環境ではスタックトレースを含めない
    if (process.env.NODE_ENV !== 'production') {
        errorResponse.error.stack = error.stack;
    }
    return {
        statusCode,
        headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
        },
        body: JSON.stringify(errorResponse),
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXHF1ZXJ5XFxoYW5kbGVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7OztHQU9HOztBQWlFSCwwQkFxRkM7QUFuSkQsK0NBQWdFO0FBQ2hFLHVFQUE4RTtBQUM5RSx5Q0FBOEQ7QUFDOUQsMkRBQXVEO0FBQ3ZELDZDQUEyQztBQXVDM0M7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWtCRztBQUNJLEtBQUssVUFBVSxPQUFPLENBQzNCLEtBQWlCLEVBQ2pCLE9BQWdCO0lBRWhCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUU3QixJQUFJLENBQUM7UUFDSCxlQUFNLENBQUMsSUFBSSxDQUFDLHNCQUFzQixFQUFFO1lBQ2xDLHFCQUFxQixFQUFFLEtBQUssQ0FBQyxxQkFBcUI7WUFDbEQsVUFBVSxFQUFFLE9BQU8sQ0FBQyxZQUFZO1lBQ2hDLGFBQWEsRUFBRSxPQUFPLENBQUMsWUFBWTtTQUNwQyxDQUFDLENBQUM7UUFFSCxlQUFlO1FBQ2YsTUFBTSxNQUFNLEdBQUcsb0JBQW9CLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFM0MsVUFBVTtRQUNWLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBQSxvQ0FBZ0IsRUFBQyxNQUFNLENBQUMsQ0FBQztRQUU5QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsU0FBUyxDQUFDO1FBRXhDLGVBQU0sQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUU7WUFDcEMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxZQUFZO1lBQ2hDLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSztZQUNuQixXQUFXLEVBQUUsUUFBUTtTQUN0QixDQUFDLENBQUM7UUFFSCxZQUFZO1FBQ1osTUFBTSxJQUFBLGdDQUFXLEVBQUM7WUFDaEI7Z0JBQ0UsSUFBSSxFQUFFLHFCQUFxQjtnQkFDM0IsS0FBSyxFQUFFLFFBQVE7Z0JBQ2YsSUFBSSxFQUFF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QUN0QixPQUFPO1NBQ1I7UUFDRCxVQUFVLEVBQUUsU0FBUztLQUN0QixDQUFDO0lBRUYsc0JBQXNCO0lBQ3RCLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssWUFBWSxFQUFFLENBQUM7UUFDekMsYUFBYSxDQUFDLEtBQWEsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztJQUNuRCxDQUFDO0lBRUQsT0FBTztRQUNMLFVBQVU7UUFDVixPQUFPLEVBQUU7WUFDUCxjQUFjLEVBQUUsa0JBQWtCO1lBQ2xDLDZCQUE2QixFQUFFLEdBQUc7U0FDbkM7UUFDRCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUM7S0FDcEMsQ0FBQztBQUNKLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFx0aTE5OFxcaW52ZXN0bWVudF9hbmFseXNpc19vcG9wb1xcc3JjXFxsYW1iZGFcXHF1ZXJ5XFxoYW5kbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBMYW1iZGEgUXVlcnkgSGFuZGxlclxyXG4gKlxyXG4gKiBURG5ldOmWi+ekuuaDheWgseOCkuaknOe0ouOBmeOCi0xhbWJkYemWouaVsOOBruODoeOCpOODs+ODj+ODs+ODieODqeODvOOAglxyXG4gKiBBUEkgR2F0ZXdheee1seWQiOOBq+OCiOOCiuOAgVJFU1RmdWwgQVBJ44Go44GX44Gm5YWs6ZaL44GV44KM44G+44GZ44CCXHJcbiAqXHJcbiAqIFJlcXVpcmVtZW50czog6KaB5Lu2NC4xLCA0LjMsIDQuNCwgNS4yLCAxMS4x77yI5qSc57SiQVBJ44CB6KqN6Ki844CBUERG44OA44Km44Oz44Ot44O844OJ44CBQ1NW5b2i5byP77yJXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCwgQ29udGV4dCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xyXG5pbXBvcnQgeyBsb2dnZXIsIGNyZWF0ZUVycm9yQ29udGV4dCB9IGZyb20gJy4uLy4uL3V0aWxzL2xvZ2dlcic7XHJcbmltcG9ydCB7IHNlbmRFcnJvck1ldHJpYywgc2VuZE1ldHJpY3MgfSBmcm9tICcuLi8uLi91dGlscy9jbG91ZHdhdGNoLW1ldHJpY3MnO1xyXG5pbXBvcnQgeyBWYWxpZGF0aW9uRXJyb3IsIE5vdEZvdW5kRXJyb3IgfSBmcm9tICcuLi8uLi9lcnJvcnMnO1xyXG5pbXBvcnQgeyBxdWVyeURpc2Nsb3N1cmVzIH0gZnJvbSAnLi9xdWVyeS1kaXNjbG9zdXJlcyc7XHJcbmltcG9ydCB7IGZvcm1hdEFzQ3N2IH0gZnJvbSAnLi9mb3JtYXQtY3N2JztcclxuaW1wb3J0IHsgRGlzY2xvc3VyZSB9IGZyb20gJy4uLy4uL3R5cGVzJztcclxuXHJcbi8qKlxyXG4gKiBMYW1iZGEgUXVlcnnjgqTjg5njg7Pjg4jvvIhBUEkgR2F0ZXdheee1seWQiO+8iVxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBRdWVyeUV2ZW50IGV4dGVuZHMgQVBJR2F0ZXdheVByb3h5RXZlbnQge1xyXG4gIHF1ZXJ5U3RyaW5nUGFyYW1ldGVyczoge1xyXG4gICAgY29tcGFueV9jb2RlPzogc3RyaW5nO1xyXG4gICAgc3RhcnRfZGF0ZT86IHN0cmluZztcclxuICAgIGVuZF9kYXRlPzogc3RyaW5nO1xyXG4gICAgbW9udGg/OiBzdHJpbmc7XHJcbiAgICBkaXNjbG9zdXJlX3R5cGU/OiBzdHJpbmc7XHJcbiAgICBmb3JtYXQ/OiAnanNvbicgfCAnY3N2JztcclxuICAgIGxpbWl0Pzogc3RyaW5nO1xyXG4gICAgb2Zmc2V0Pzogc3RyaW5nO1xyXG4gIH0gfCBudWxsO1xyXG59XHJcblxyXG4vKipcclxuICog44Kv44Ko44Oq44Os44K544Od44Oz44K5XHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIFF1ZXJ5UmVzcG9uc2Uge1xyXG4gIC8qKiDmpJzntKLntZDmnpwgKi9cclxuICBkaXNjbG9zdXJlczogRGlzY2xvc3VyZVtdO1xyXG5cclxuICAvKiog57eP5Lu25pWwICovXHJcbiAgdG90YWw6IG51bWJlcjtcclxuXHJcbiAgLyoqIOWPluW+l+S7tuaVsCAqL1xyXG4gIGNvdW50OiBudW1iZXI7XHJcblxyXG4gIC8qKiDjgqrjg5Xjgrvjg4Pjg4ggKi9cclxuICBvZmZzZXQ6IG51bWJlcjtcclxuXHJcbiAgLyoqIOODquODn+ODg+ODiCAqL1xyXG4gIGxpbWl0OiBudW1iZXI7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBMYW1iZGEgUXVlcnnjg4/jg7Pjg4njg6njg7xcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEFQSSBHYXRld2F5IFByb3h5IEV2ZW50XHJcbiAqIEBwYXJhbSBjb250ZXh0IExhbWJkYSBDb250ZXh0XHJcbiAqIEByZXR1cm5zIEFQSSBHYXRld2F5IFByb3h5IFJlc3VsdFxyXG4gKlxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGB0eXBlc2NyaXB0XHJcbiAqIC8vIOS8gealreOCs+ODvOODieOBp+aknOe0olxyXG4gKiBHRVQgL2Rpc2Nsb3N1cmVzP2NvbXBhbnlfY29kZT03MjAzXHJcbiAqXHJcbiAqIC8vIOaXpeS7mOevhOWbsuOBp+aknOe0olxyXG4gKiBHRVQgL2Rpc2Nsb3N1cmVzP3N0YXJ0X2RhdGU9MjAyNC0wMS0xNSZlbmRfZGF0ZT0yMDI0LTAxLTIwXHJcbiAqXHJcbiAqIC8vIENTVuW9ouW8j+OBp+WPluW+l1xyXG4gKiBHRVQgL2Rpc2Nsb3N1cmVzP2Zvcm1hdD1jc3Ymc3RhcnRfZGF0ZT0yMDI0LTAxLTE1JmVuZF9kYXRlPTIwMjQtMDEtMjBcclxuICogYGBgXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaGFuZGxlcihcclxuICBldmVudDogUXVlcnlFdmVudCxcclxuICBjb250ZXh0OiBDb250ZXh0XHJcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XHJcbiAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcclxuXHJcbiAgdHJ5IHtcclxuICAgIGxvZ2dlci5pbmZvKCdMYW1iZGEgUXVlcnkgc3RhcnRlZCcsIHtcclxuICAgICAgcXVlcnlTdHJpbmdQYXJhbWV0ZXJzOiBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMsXHJcbiAgICAgIHJlcXVlc3RfaWQ6IGNvbnRleHQuYXdzUmVxdWVzdElkLFxyXG4gICAgICBmdW5jdGlvbl9uYW1lOiBjb250ZXh0LmZ1bmN0aW9uTmFtZSxcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOOCr+OCqOODquODkeODqeODoeODvOOCv+OBruODkeODvOOCuVxyXG4gICAgY29uc3QgcGFyYW1zID0gcGFyc2VRdWVyeVBhcmFtZXRlcnMoZXZlbnQpO1xyXG5cclxuICAgIC8vIOmWi+ekuuaDheWgseOCkuaknOe0olxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcXVlcnlEaXNjbG9zdXJlcyhwYXJhbXMpO1xyXG5cclxuICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcclxuXHJcbiAgICBsb2dnZXIuaW5mbygnTGFtYmRhIFF1ZXJ5IGNvbXBsZXRlZCcsIHtcclxuICAgICAgcmVxdWVzdF9pZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXHJcbiAgICAgIGNvdW50OiByZXN1bHQuY291bnQsXHJcbiAgICAgIGR1cmF0aW9uX21zOiBkdXJhdGlvbixcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOaIkOWKn+ODoeODiOODquOCr+OCuemAgeS/oVxyXG4gICAgYXdhaXQgc2VuZE1ldHJpY3MoW1xyXG4gICAgICB7XHJcbiAgICAgICAgbmFtZTogJ0xhbWJkYUV4ZWN1dGlvblRpbWUnLFxyXG4gICAgICAgIHZhbHVlOiBkdXJhdGlvbixcclxuICAgICAgICB1bml0OiAnTWlsbGlzZWNvbmRzJyxcclxuICAgICAgICBkaW1lbnNpb25zOiB7IEZ1bmN0aW9uTmFtZTogJ1F1ZXJ5JyB9LFxyXG4gICAgICB9LFxyXG4gICAgICB7XHJcbiAgICAgICAgbmFtZTogJ1F1ZXJ5UmVzdWx0Q291bnQnLFxyXG4gICAgICAgIHZhbHVlOiByZXN1bHQuY291bnQsXHJcbiAgICAgICAgdW5pdDogJ0NvdW50JyxcclxuICAgICAgICBkaW1lbnNpb25zOiB7IEZvcm1hdDogcGFyYW1zLmZvcm1hdCB9LFxyXG4gICAgICB9LFxyXG4gICAgXSk7XHJcblxyXG4gICAgLy8g44OV44Kp44O844Oe44OD44OI5Yil44Os44K544Od44Oz44K5XHJcbiAgICBpZiAocGFyYW1zLmZvcm1hdCA9PT0gJ2NzdicpIHtcclxuICAgICAgY29uc3QgY3N2ID0gZm9ybWF0QXNDc3YocmVzdWx0LmRpc2Nsb3N1cmVzKTtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdGF0dXNDb2RlOiAyMDAsXHJcbiAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICd0ZXh0L2NzdicsXHJcbiAgICAgICAgICAnQ29udGVudC1EaXNwb3NpdGlvbic6IGBhdHRhY2htZW50OyBmaWxlbmFtZT1cImRpc2Nsb3N1cmVzLSR7RGF0ZS5ub3coKX0uY3N2XCJgLFxyXG4gICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGJvZHk6IGNzdixcclxuICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBKU09O5b2i5byP77yI44OH44OV44Kp44Or44OI77yJXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXHJcbiAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXHJcbiAgICAgIH0sXHJcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHJlc3VsdCksXHJcbiAgICB9O1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XHJcblxyXG4gICAgbG9nZ2VyLmVycm9yKFxyXG4gICAgICAnTGFtYmRhIFF1ZXJ5IGZhaWxlZCcsXHJcbiAgICAgIGNyZWF0ZUVycm9yQ29udGV4dChlcnJvciBhcyBFcnJvciwge1xyXG4gICAgICAgIHJlcXVlc3RfaWQ6IGNvbnRleHQuYXdzUmVxdWVzdElkLFxyXG4gICAgICAgIGR1cmF0aW9uX21zOiBkdXJhdGlvbixcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gICAgLy8g44Ko44Op44O844Oh44OI44Oq44Kv44K56YCB5L+hXHJcbiAgICBhd2FpdCBzZW5kRXJyb3JNZXRyaWMoXHJcbiAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5jb25zdHJ1Y3Rvci5uYW1lIDogJ1Vua25vd24nLFxyXG4gICAgICAnUXVlcnknXHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiBoYW5kbGVFcnJvcihlcnJvciBhcyBFcnJvciwgZXZlbnQucmVxdWVzdENvbnRleHQucmVxdWVzdElkKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgq/jgqjjg6rjg5Hjg6njg6Hjg7zjgr/jga7jg5Hjg7zjgrlcclxuICpcclxuICogQHBhcmFtIGV2ZW50IEFQSSBHYXRld2F5IFByb3h5IEV2ZW50XHJcbiAqIEByZXR1cm5zIOODkeODvOOCuea4iOOBv+OCr+OCqOODquODkeODqeODoeODvOOCv1xyXG4gKiBAdGhyb3dzIFZhbGlkYXRpb25FcnJvciDjg5Djg6rjg4fjg7zjgrfjg6fjg7Pjgqjjg6njg7xcclxuICovXHJcbmZ1bmN0aW9uIHBhcnNlUXVlcnlQYXJhbWV0ZXJzKGV2ZW50OiBRdWVyeUV2ZW50KToge1xyXG4gIGNvbXBhbnlfY29kZT86IHN0cmluZztcclxuICBzdGFydF9kYXRlPzogc3RyaW5nO1xyXG4gIGVuZF9kYXRlPzogc3RyaW5nO1xyXG4gIG1vbnRoPzogc3RyaW5nO1xyXG4gIGRpc2Nsb3N1cmVfdHlwZT86IHN0cmluZztcclxuICBmb3JtYXQ6ICdqc29uJyB8ICdjc3YnO1xyXG4gIGxpbWl0OiBudW1iZXI7XHJcbiAgb2Zmc2V0OiBudW1iZXI7XHJcbn0ge1xyXG4gIGNvbnN0IHBhcmFtcyA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyB8fCB7fTtcclxuXHJcbiAgLy8g44OV44Kp44O844Oe44OD44OI44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAgY29uc3QgZm9ybWF0ID0gKHBhcmFtcy5mb3JtYXQgfHwgJ2pzb24nKSBhcyAnanNvbicgfCAnY3N2JztcclxuICBpZiAoIVsnanNvbicsICdjc3YnXS5pbmNsdWRlcyhmb3JtYXQpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCBmb3JtYXQ6ICR7Zm9ybWF0fS4gRXhwZWN0ZWQgJ2pzb24nIG9yICdjc3YnLmBcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvLyDjg6rjg5/jg4Pjg4jjga7jg5Djg6rjg4fjg7zjgrfjg6fjg7PvvIjjg4fjg5Xjgqnjg6vjg4g6IDEwMOOAgeacgOWkpzogMTAwMO+8iVxyXG4gIGxldCBsaW1pdCA9IDEwMDtcclxuICBpZiAocGFyYW1zLmxpbWl0KSB7XHJcbiAgICBsaW1pdCA9IHBhcnNlSW50KHBhcmFtcy5saW1pdCwgMTApO1xyXG4gICAgaWYgKGlzTmFOKGxpbWl0KSB8fCBsaW1pdCA8IDEgfHwgbGltaXQgPiAxMDAwKSB7XHJcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgICAgYEludmFsaWQgbGltaXQ6ICR7cGFyYW1zLmxpbWl0fS4gRXhwZWN0ZWQgYSBudW1iZXIgYmV0d2VlbiAxIGFuZCAxMDAwLmBcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOOCquODleOCu+ODg+ODiOOBruODkOODquODh+ODvOOCt+ODp+ODs++8iOODh+ODleOCqeODq+ODiDogMO+8iVxyXG4gIGxldCBvZmZzZXQgPSAwO1xyXG4gIGlmIChwYXJhbXMub2Zmc2V0KSB7XHJcbiAgICBvZmZzZXQgPSBwYXJzZUludChwYXJhbXMub2Zmc2V0LCAxMCk7XHJcbiAgICBpZiAoaXNOYU4ob2Zmc2V0KSB8fCBvZmZzZXQgPCAwKSB7XHJcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgICAgYEludmFsaWQgb2Zmc2V0OiAke3BhcmFtcy5vZmZzZXR9LiBFeHBlY3RlZCBhIG5vbi1uZWdhdGl2ZSBudW1iZXIuYFxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gbW9udGjjg5Hjg6njg6Hjg7zjgr/jga7jg5Djg6rjg4fjg7zjgrfjg6fjg7NcclxuICBpZiAocGFyYW1zLm1vbnRoKSB7XHJcbiAgICB2YWxpZGF0ZU1vbnRoRm9ybWF0KHBhcmFtcy5tb250aCk7XHJcbiAgfVxyXG5cclxuICAvLyBtb250aOOBjOaMh+WumuOBleOCjOOBn+WgtOWQiOOAgXN0YXJ0X2RhdGXjgahlbmRfZGF0ZeOBr+eEoeimllxyXG4gIGlmIChwYXJhbXMubW9udGgpIHtcclxuICAgIGxvZ2dlci5pbmZvKCdtb250aCBwYXJhbWV0ZXIgc3BlY2lmaWVkLCBpZ25vcmluZyBzdGFydF9kYXRlIGFuZCBlbmRfZGF0ZScsIHtcclxuICAgICAgbW9udGg6IHBhcmFtcy5tb250aCxcclxuICAgICAgc3RhcnRfZGF0ZTogcGFyYW1zLnN0YXJ0X2RhdGUsXHJcbiAgICAgIGVuZF9kYXRlOiBwYXJhbXMuZW5kX2RhdGUsXHJcbiAgICB9KTtcclxuICB9IGVsc2Uge1xyXG4gICAgLy8g5pel5LuY44OV44Kp44O844Oe44OD44OI44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAgICBpZiAocGFyYW1zLnN0YXJ0X2RhdGUpIHtcclxuICAgICAgdmFsaWRhdGVEYXRlRm9ybWF0KHBhcmFtcy5zdGFydF9kYXRlLCAnc3RhcnRfZGF0ZScpO1xyXG4gICAgfVxyXG4gICAgaWYgKHBhcmFtcy5lbmRfZGF0ZSkge1xyXG4gICAgICB2YWxpZGF0ZURhdGVGb3JtYXQocGFyYW1zLmVuZF9kYXRlLCAnZW5kX2RhdGUnKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDml6Xku5jnr4Tlm7Ljga7poIbluo/mgKfjg4Hjgqfjg4Pjgq/vvIhQcm9wZXJ0eSA477yJXHJcbiAgICBpZiAocGFyYW1zLnN0YXJ0X2RhdGUgJiYgcGFyYW1zLmVuZF9kYXRlKSB7XHJcbiAgICAgIGNvbnN0IHN0YXJ0RGF0ZSA9IG5ldyBEYXRlKHBhcmFtcy5zdGFydF9kYXRlKTtcclxuICAgICAgY29uc3QgZW5kRGF0ZSA9IG5ldyBEYXRlKHBhcmFtcy5lbmRfZGF0ZSk7XHJcblxyXG4gICAgICBpZiAoc3RhcnREYXRlID4gZW5kRGF0ZSkge1xyXG4gICAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgICAgICBgc3RhcnRfZGF0ZSAoJHtwYXJhbXMuc3RhcnRfZGF0ZX0pIG11c3QgYmUgYmVmb3JlIG9yIGVxdWFsIHRvIGVuZF9kYXRlICgke3BhcmFtcy5lbmRfZGF0ZX0pYFxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOS8gealreOCs+ODvOODieOBruODkOODquODh+ODvOOCt+ODp+ODs++8iDTmoYHjga7mlbDlrZfvvIlcclxuICBpZiAocGFyYW1zLmNvbXBhbnlfY29kZSkge1xyXG4gICAgY29uc3QgY29tcGFueUNvZGVSZWdleCA9IC9eXFxkezR9JC87XHJcbiAgICBpZiAoIWNvbXBhbnlDb2RlUmVnZXgudGVzdChwYXJhbXMuY29tcGFueV9jb2RlKSkge1xyXG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICAgIGBJbnZhbGlkIGNvbXBhbnlfY29kZTogJHtwYXJhbXMuY29tcGFueV9jb2RlfS4gRXhwZWN0ZWQgNC1kaWdpdCBudW1iZXIuYFxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIGNvbXBhbnlfY29kZTogcGFyYW1zLmNvbXBhbnlfY29kZSxcclxuICAgIHN0YXJ0X2RhdGU6IHBhcmFtcy5tb250aCA/IHVuZGVmaW5lZCA6IHBhcmFtcy5zdGFydF9kYXRlLFxyXG4gICAgZW5kX2RhdGU6IHBhcmFtcy5tb250aCA/IHVuZGVmaW5lZCA6IHBhcmFtcy5lbmRfZGF0ZSxcclxuICAgIG1vbnRoOiBwYXJhbXMubW9udGgsXHJcbiAgICBkaXNjbG9zdXJlX3R5cGU6IHBhcmFtcy5kaXNjbG9zdXJlX3R5cGUsXHJcbiAgICBmb3JtYXQsXHJcbiAgICBsaW1pdCxcclxuICAgIG9mZnNldCxcclxuICB9O1xyXG59XHJcblxyXG4vKipcclxuICog5pel5LuY44OV44Kp44O844Oe44OD44OI44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAqXHJcbiAqIEBwYXJhbSBkYXRlIOaXpeS7mOaWh+Wtl+WIl++8iFlZWVktTU0tRETvvIlcclxuICogQHBhcmFtIGZpZWxkTmFtZSDjg5XjgqPjg7zjg6vjg4nlkI1cclxuICogQHRocm93cyBWYWxpZGF0aW9uRXJyb3Ig44OQ44Oq44OH44O844K344On44Oz44Ko44Op44O8XHJcbiAqL1xyXG5mdW5jdGlvbiB2YWxpZGF0ZURhdGVGb3JtYXQoZGF0ZTogc3RyaW5nLCBmaWVsZE5hbWU6IHN0cmluZyk6IHZvaWQge1xyXG4gIC8vIFlZWVktTU0tRETlvaLlvI/jga7jg4Hjgqfjg4Pjgq9cclxuICBjb25zdCBkYXRlUmVnZXggPSAvXlxcZHs0fS1cXGR7Mn0tXFxkezJ9JC87XHJcbiAgaWYgKCFkYXRlUmVnZXgudGVzdChkYXRlKSkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEludmFsaWQgJHtmaWVsZE5hbWV9IGZvcm1hdDogJHtkYXRlfS4gRXhwZWN0ZWQgWVlZWS1NTS1ERCBmb3JtYXQuYFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIOacieWKueOBquaXpeS7mOOBi+ODgeOCp+ODg+OCr1xyXG4gIGNvbnN0IHBhcnNlZERhdGUgPSBuZXcgRGF0ZShkYXRlKTtcclxuICBpZiAoaXNOYU4ocGFyc2VkRGF0ZS5nZXRUaW1lKCkpKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCAke2ZpZWxkTmFtZX06ICR7ZGF0ZX0uIERhdGUgZG9lcyBub3QgZXhpc3QuYFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIOaXpeS7mOOBruaVtOWQiOaAp+ODgeOCp+ODg+OCr++8iOS+izogMjAyMy0wMi0yOeOBrzIwMjMtMDMtMDHjgavlpInmj5vjgZXjgozjgovjgZ/jgoHmpJzlh7rvvIlcclxuICBjb25zdCBbeWVhciwgbW9udGgsIGRheV0gPSBkYXRlLnNwbGl0KCctJykubWFwKE51bWJlcik7XHJcbiAgaWYgKFxyXG4gICAgcGFyc2VkRGF0ZS5nZXRGdWxsWWVhcigpICE9PSB5ZWFyIHx8XHJcbiAgICBwYXJzZWREYXRlLmdldE1vbnRoKCkgKyAxICE9PSBtb250aCB8fFxyXG4gICAgcGFyc2VkRGF0ZS5nZXREYXRlKCkgIT09IGRheVxyXG4gICkge1xyXG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihcclxuICAgICAgYEludmFsaWQgJHtmaWVsZE5hbWV9OiAke2RhdGV9LiBEYXRlIGRvZXMgbm90IGV4aXN0LmBcclxuICAgICk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog5pyI44OV44Kp44O844Oe44OD44OI44Gu44OQ44Oq44OH44O844K344On44OzXHJcbiAqXHJcbiAqIEBwYXJhbSBtb250aCDmnIjmloflrZfliJfvvIhZWVlZLU1N77yJXHJcbiAqIEB0aHJvd3MgVmFsaWRhdGlvbkVycm9yIOODkOODquODh+ODvOOCt+ODp+ODs+OCqOODqeODvFxyXG4gKi9cclxuZnVuY3Rpb24gdmFsaWRhdGVNb250aEZvcm1hdChtb250aDogc3RyaW5nKTogdm9pZCB7XHJcbiAgLy8gWVlZWS1NTeW9ouW8j+OBruODgeOCp+ODg+OCr1xyXG4gIGNvbnN0IG1vbnRoUmVnZXggPSAvXlxcZHs0fS1cXGR7Mn0kLztcclxuICBpZiAoIW1vbnRoUmVnZXgudGVzdChtb250aCkpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgIGBJbnZhbGlkIG1vbnRoIGZvcm1hdDogJHttb250aH0uIEV4cGVjdGVkIFlZWVktTU0gZm9ybWF0LmBcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvLyDmnInlirnjgarmnIjjgYvjg4Hjgqfjg4Pjgq9cclxuICBjb25zdCBbeWVhciwgbW9udGhOdW1dID0gbW9udGguc3BsaXQoJy0nKS5tYXAoTnVtYmVyKTtcclxuICBpZiAobW9udGhOdW0gPCAxIHx8IG1vbnRoTnVtID4gMTIpIHtcclxuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgIGBJbnZhbGlkIG1vbnRoOiAke21vbnRofS4gTW9udGggbXVzdCBiZSBiZXR3ZWVuIDAxIGFuZCAxMi5gXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8g5bm044Gu5aal5b2T5oCn44OB44Kn44OD44Kv77yIMTkwMC0yMTAw77yJXHJcbiAgaWYgKHllYXIgPCAxOTAwIHx8IHllYXIgPiAyMTAwKSB7XHJcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKFxyXG4gICAgICBgSW52YWxpZCBtb250aDogJHttb250aH0uIFllYXIgbXVzdCBiZSBiZXR3ZWVuIDE5MDAgYW5kIDIxMDAuYFxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDjgqjjg6njg7zjg4/jg7Pjg4njg6rjg7PjgrBcclxuICpcclxuICog44Kr44K544K/44Og44Ko44Op44O844KS6YGp5YiH44GqSFRUUOOCueODhuODvOOCv+OCueOCs+ODvOODieOBqOOCqOODqeODvOOCs+ODvOODieOBq+WkieaPm+OBl+OBvuOBmeOAglxyXG4gKiBBUEnoqK3oqIjjgqzjgqTjg4njg6njgqTjg7Pjgavmupbmi6DjgZfjgZ/lvaLlvI/jgafjgqjjg6njg7zjg6zjgrnjg53jg7PjgrnjgpLov5TjgZfjgb7jgZnjgIJcclxuICpcclxuICogQHBhcmFtIGVycm9yIOOCqOODqeODvOOCquODluOCuOOCp+OCr+ODiFxyXG4gKiBAcGFyYW0gcmVxdWVzdElkIEFQSSBHYXRld2F544Oq44Kv44Ko44K544OISURcclxuICogQHJldHVybnMgQVBJIEdhdGV3YXkgUHJveHkgUmVzdWx0XHJcbiAqL1xyXG5mdW5jdGlvbiBoYW5kbGVFcnJvcihlcnJvcjogRXJyb3IsIHJlcXVlc3RJZDogc3RyaW5nKTogQVBJR2F0ZXdheVByb3h5UmVzdWx0IHtcclxuICAvLyDjgqjjg6njg7znqK7liKXjgavlv5zjgZjjgZ/jgrnjg4bjg7zjgr/jgrnjgrPjg7zjg4njgajjgqjjg6njg7zjgrPjg7zjg4lcclxuICBsZXQgc3RhdHVzQ29kZSA9IDUwMDtcclxuICBsZXQgZXJyb3JDb2RlID0gJ0lOVEVSTkFMX0VSUk9SJztcclxuICBsZXQgZGV0YWlsczogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xyXG5cclxuICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBWYWxpZGF0aW9uRXJyb3IpIHtcclxuICAgIHN0YXR1c0NvZGUgPSA0MDA7XHJcbiAgICBlcnJvckNvZGUgPSAnVkFMSURBVElPTl9FUlJPUic7XHJcbiAgICAvLyBWYWxpZGF0aW9uRXJyb3Ljga7oqbPntLDmg4XloLHjgpLlkKvjgoHjgotcclxuICAgIGlmICgoZXJyb3IgYXMgYW55KS5kZXRhaWxzKSB7XHJcbiAgICAgIGRldGFpbHMgPSAoZXJyb3IgYXMgYW55KS5kZXRhaWxzO1xyXG4gICAgfVxyXG4gIH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEVycm9yKSB7XHJcbiAgICBzdGF0dXNDb2RlID0gNDA0O1xyXG4gICAgZXJyb3JDb2RlID0gJ05PVF9GT1VORCc7XHJcbiAgfVxyXG5cclxuICAvLyBBUEnoqK3oqIjjgqzjgqTjg4njg6njgqTjg7Pjgavmupbmi6DjgZfjgZ/jgqjjg6njg7zjg6zjgrnjg53jg7PjgrnlvaLlvI9cclxuICBjb25zdCBlcnJvclJlc3BvbnNlID0ge1xyXG4gICAgc3RhdHVzOiAnZXJyb3InLFxyXG4gICAgZXJyb3I6IHtcclxuICAgICAgY29kZTogZXJyb3JDb2RlLFxyXG4gICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxyXG4gICAgICBkZXRhaWxzLFxyXG4gICAgfSxcclxuICAgIHJlcXVlc3RfaWQ6IHJlcXVlc3RJZCxcclxuICB9O1xyXG5cclxuICAvLyDmnKznlarnkrDlooPjgafjga/jgrnjgr/jg4Pjgq/jg4jjg6zjg7zjgrnjgpLlkKvjgoHjgarjgYRcclxuICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykge1xyXG4gICAgKGVycm9yUmVzcG9uc2UuZXJyb3IgYXMgYW55KS5zdGFjayA9IGVycm9yLnN0YWNrO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIHN0YXR1c0NvZGUsXHJcbiAgICBoZWFkZXJzOiB7XHJcbiAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXHJcbiAgICB9LFxyXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoZXJyb3JSZXNwb25zZSksXHJcbiAgfTtcclxufVxyXG4iXSwidmVyc2lvbiI6M30=